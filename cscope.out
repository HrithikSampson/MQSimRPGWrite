cscope 15 $HOME/Desktop/MQSim-master (4th copy) -q 0000002867 0000782628
	@src/exec/Device_Parameter_Set.cpp

1 
	~"Deviû_P¬am‘”_S‘.h
"

2 
	~<®gÜ™hm
>

6 
	gDeviû_P¬am‘”_S‘
::
S“d
 = 123;

7 
boŞ
 
	gDeviû_P¬am‘”_S‘
::
EÇbËd_P»cÚd™iÚšg
 = 
Œue
;

8 
	gNVM
::
NVM_Ty³
 
Deviû_P¬am‘”_S‘
::
MemÜy_Ty³
 = 
NVM
::NVM_Ty³::
FLASH
;

9 
Ho¡IÁ”çû_Ty³s
 
	gDeviû_P¬am‘”_S‘
::
Ho¡IÁ”çû_Ty³
 = Ho¡IÁ”çû_Ty³s::
NVME
;

10 
ušt16_t
 
	gDeviû_P¬am‘”_S‘
::
IO_Queue_D•th
 = 1024;

11 
ušt16_t
 
	gDeviû_P¬am‘”_S‘
::
Queue_F‘ch_Size
 = 512;

12 
	gSSD_CompÚ’ts
::
Cachšg_Mechªism
 
Deviû_P¬am‘”_S‘
::Cachšg_Mechªism = 
SSD_CompÚ’ts
::Cachšg_Mechªism::
ADVANCED
;

13 
	gSSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
 
Deviû_P¬am‘”_S‘
::
D©a_Cache_Sh¬šg_Mode
 = 
SSD_CompÚ’ts
::Cache_Sh¬šg_Mode::
SHARED
;

14 
	gDeviû_P¬am‘”_S‘
::
D©a_Cache_C­ac™y
 = 1024 * 1024 * 512;

15 
	gDeviû_P¬am‘”_S‘
::
D©a_Cache_DRAM_Row_Size
 = 8192;

16 
	gDeviû_P¬am‘”_S‘
::
D©a_Cache_DRAM_D©a_R©e
 = 800;

17 
	gDeviû_P¬am‘”_S‘
::
D©a_Cache_DRAM_D©a_Bu¤t_Size
 = 4;

18 
sim_time_ty³
 
	gDeviû_P¬am‘”_S‘
::
D©a_Cache_DRAM_tRCD
 = 13;

19 
sim_time_ty³
 
	gDeviû_P¬am‘”_S‘
::
D©a_Cache_DRAM_tCL
 = 13;

20 
sim_time_ty³
 
	gDeviû_P¬am‘”_S‘
::
D©a_Cache_DRAM_tRP
 = 13;

21 
	gSSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
 
Deviû_P¬am‘”_S‘
::
Add»ss_M­pšg
 = 
SSD_CompÚ’ts
::FÏsh_Add»ss_M­pšg_Ty³::
PAGE_LEVEL
;

22 
boŞ
 
	gDeviû_P¬am‘”_S‘
::
Id—l_M­pšg_TabË
 = 
çl£
;

23 
	gDeviû_P¬am‘”_S‘
::
CMT_C­ac™y
 = 2 * 1024 * 1024;

24 
	gSSD_CompÚ’ts
::
CMT_Sh¬šg_Mode
 
Deviû_P¬am‘”_S‘
::CMT_Sh¬šg_Modğ
SSD_CompÚ’ts
::CMT_Sh¬šg_Mode::
SHARED
;

25 
	gSSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
 
Deviû_P¬am‘”_S‘
::
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³::
CWDP
;

26 
	gSSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
 
Deviû_P¬am‘”_S‘
::
T¿n§ùiÚ_Schedulšg_PŞicy
 = 
SSD_CompÚ’ts
::FÏsh_Schedulšg_Ty³::
OUT_OF_ORDER
;

27 
	gDeviû_P¬am‘”_S‘
::
Ov”´ovisiÚšg_R©io
 = 0.07;

28 
	gDeviû_P¬am‘”_S‘
::
GC_Exec_Th»shŞd
 = 0.05;

29 
	gSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
 
Deviû_P¬am‘”_S‘
::
GC_Block_S–eùiÚ_PŞicy
 = 
SSD_CompÚ’ts
::GC_Block_S–eùiÚ_PŞicy_Ty³::
RGA
;

30 
boŞ
 
	gDeviû_P¬am‘”_S‘
::
U£_Cİyback_fÜ_GC
 = 
çl£
;

31 
boŞ
 
	gDeviû_P¬am‘”_S‘
::
P»em±ibË_GC_EÇbËd
 = 
Œue
;

32 
	gDeviû_P¬am‘”_S‘
::
GC_H¬d_Th»shŞd
 = 0.005;

33 
boŞ
 
	gDeviû_P¬am‘”_S‘
::
DyÇmic_W—¾ev–šg_EÇbËd
 = 
Œue
;

34 
boŞ
 
	gDeviû_P¬am‘”_S‘
::
Stic_W—¾ev–šg_EÇbËd
 = 
Œue
;

35 
	gDeviû_P¬am‘”_S‘
::
Stic_W—¾ev–šg_Th»shŞd
 = 100;

36 
sim_time_ty³
 
	gDeviû_P¬am‘”_S‘
::
P»ã¼ed_su¥’d_”a£_time_fÜ_»ad
 = 700000;

37 
sim_time_ty³
 
	gDeviû_P¬am‘”_S‘
::
P»ã¼ed_su¥’d_”a£_time_fÜ_wr™e
 = 700000;

38 
sim_time_ty³
 
	gDeviû_P¬am‘”_S‘
::
P»ã¼ed_su¥’d_wr™e_time_fÜ_»ad
 = 100000;

39 
	gDeviû_P¬am‘”_S‘
::
FÏsh_ChªÃl_CouÁ
 = 8;

40 
	gDeviû_P¬am‘”_S‘
::
FÏsh_ChªÃl_Width
 = 1;

41 
	gDeviû_P¬am‘”_S‘
::
ChªÃl_T¿nsãr_R©e
 = 300;

42 
	gDeviû_P¬am‘”_S‘
::
Ch_No_P”_ChªÃl
 = 4;

43 
	gSSD_CompÚ’ts
::
ONFI_PrÙocŞ
 
Deviû_P¬am‘”_S‘
::
FÏsh_Comm_PrÙocŞ
 = 
SSD_CompÚ’ts
::ONFI_PrÙocŞ::
NVDDR2
;

44 
FÏsh_P¬am‘”_S‘
 
	gDeviû_P¬am‘”_S‘
::
FÏsh_P¬am‘”s
;

46 
	gDeviû_P¬am‘”_S‘
::
	$XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
)

48 
¡d
::
¡ršg
 
tmp
;

49 
tmp
 = "Device_Parameter_Set";

50 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

52 
¡d
::
¡ršg
 
©Œ
 = "Seed";

53 
¡d
::
¡ršg
 
v®
 = std::
	`to_¡ršg
(
S“d
);

54 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

56 
©Œ
 = "Enabled_Preconditioning";

57 
v®
 = (
EÇbËd_P»cÚd™iÚšg
 ? "true" : "false");

58 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

60 
©Œ
 = "Memory_Type";

61 
v®
;

62 
MemÜy_Ty³
) {

63 
NVM
::
NVM_Ty³
::
FLASH
:

64 
v®
 = "FLASH";

69 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

71 
©Œ
 = "HostInterface_Type";

72 
v®
;

73 
Ho¡IÁ”çû_Ty³
) {

74 
Ho¡IÁ”çû_Ty³s
::
NVME
:

75 
v®
 = "NVME";

77 
Ho¡IÁ”çû_Ty³s
::
SATA
:

78 
v®
 = "SATA";

83 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

85 
©Œ
 = "IO_Queue_Depth";

86 
v®
 = 
¡d
::
	`to_¡ršg
(
IO_Queue_D•th
);

87 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

89 
©Œ
 = "Queue_Fetch_Size";

90 
v®
 = 
¡d
::
	`to_¡ršg
(
Queue_F‘ch_Size
);

91 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

94 
©Œ
 = "Caching_Mechanism";

95 
Cachšg_Mechªism
) {

96 
SSD_CompÚ’ts
::
Cachšg_Mechªism
::
SIMPLE
:

97 
v®
 = "SIMPLE";

99 
SSD_CompÚ’ts
::
Cachšg_Mechªism
::
ADVANCED
:

100 
v®
 = "ADVANCED";

105 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

107 
©Œ
 = "Data_Cache_Sharing_Mode";

108 
D©a_Cache_Sh¬šg_Mode
) {

109 
SSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
SHARED
:

110 
v®
 = "SHARED";

112 
SSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
EQUAL_PARTITIONING
:

113 
v®
 = "EQUAL_PARTITIONING";

118 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

120 
©Œ
 = "Data_Cache_Capacity";

121 
v®
 = 
¡d
::
	`to_¡ršg
(
D©a_Cache_C­ac™y
);

122 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

124 
©Œ
 = "Data_Cache_DRAM_Row_Size";

125 
v®
 = 
¡d
::
	`to_¡ršg
(
D©a_Cache_DRAM_Row_Size
);

126 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

128 
©Œ
 = "Data_Cache_DRAM_Data_Rate";

129 
v®
 = 
¡d
::
	`to_¡ršg
(
D©a_Cache_DRAM_D©a_R©e
);

130 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

132 
©Œ
 = "Data_Cache_DRAM_Data_Busrt_Size";

133 
v®
 = 
¡d
::
	`to_¡ršg
(
D©a_Cache_DRAM_D©a_Bu¤t_Size
);

134 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

136 
©Œ
 = "Data_Cache_DRAM_tRCD";

137 
v®
 = 
¡d
::
	`to_¡ršg
(
D©a_Cache_DRAM_tRCD
);

138 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

140 
©Œ
 = "Data_Cache_DRAM_tCL";

141 
v®
 = 
¡d
::
	`to_¡ršg
(
D©a_Cache_DRAM_tCL
);

142 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

144 
©Œ
 = "Data_Cache_DRAM_tRP";

145 
v®
 = 
¡d
::
	`to_¡ršg
(
D©a_Cache_DRAM_tRP
);

146 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

148 
©Œ
 = "Address_Mapping";

149 
Add»ss_M­pšg
) {

150 
SSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
::
PAGE_LEVEL
:

151 
v®
 = "PAGE_LEVEL";

153 
SSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
::
HYBRID
:

154 
v®
 = "HYBRID";

159 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

161 
©Œ
 = "Ideal_Mapping_Table";

162 
v®
 = (
U£_Cİyback_fÜ_GC
 ? "true" : "false");

163 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

165 
©Œ
 = "CMT_Capacity";

166 
v®
 = 
¡d
::
	`to_¡ršg
(
CMT_C­ac™y
);

167 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

169 
©Œ
 = "CMT_Sharing_Mode";

170 
CMT_Sh¬šg_Mode
) {

171 
SSD_CompÚ’ts
::
CMT_Sh¬šg_Mode
::
SHARED
:

172 
v®
 = "SHARED";

174 
SSD_CompÚ’ts
::
CMT_Sh¬šg_Mode
::
EQUAL_SIZE_PARTITIONING
:

175 
v®
 = "EQUAL_SIZE_PARTITIONING";

180 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

182 
©Œ
 = "Plane_Allocation_Scheme";

183 
PÏÃ_AÎoÿtiÚ_Scheme
) {

184 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDPW
:

185 
v®
 = "CDPW";

187 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDWP
:

188 
v®
 = "CDWP";

190 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPDW
:

191 
v®
 = "CPDW";

193 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPWD
:

194 
v®
 = "CPWD";

196 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWDP
:

197 
v®
 = "CWDP";

199 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWPD
:

200 
v®
 = "CWPD";

202 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCPW
:

203 
v®
 = "DCPW";

205 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCWP
:

206 
v®
 = "DCWP";

208 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPCW
:

209 
v®
 = "DPCW";

211 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPWC
:

212 
v®
 = "DPWC";

214 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWCP
:

215 
v®
 = "DWCP";

217 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWPC
:

218 
v®
 = "DWPC";

220 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCDW
:

221 
v®
 = "PCDW";

223 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCWD
:

224 
v®
 = "PCWD";

226 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDCW
:

227 
v®
 = "PDCW";

229 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDWC
:

230 
v®
 = "PDWC";

232 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWCD
:

233 
v®
 = "PWCD";

235 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWDC
:

236 
v®
 = "PWDC";

238 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCDP
:

239 
v®
 = "WCDP";

241 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCPD
:

242 
v®
 = "WCPD";

244 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDCP
:

245 
v®
 = "WDCP";

247 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDPC
:

248 
v®
 = "WDPC";

250 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPCD
:

251 
v®
 = "WPCD";

253 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPDC
:

254 
v®
 = "WPDC";

259 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

261 
©Œ
 = "Transaction_Scheduling_Policy";

262 
T¿n§ùiÚ_Schedulšg_PŞicy
) {

263 
SSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
::
OUT_OF_ORDER
:

264 
v®
 = "OUT_OF_ORDER";

266 
SSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
::
FLIN
:

267 
v®
 = "FLIN";

272 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

274 
©Œ
 = "Overprovisioning_Ratio";

275 
v®
 = 
¡d
::
	`to_¡ršg
(
Ov”´ovisiÚšg_R©io
);

276 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

278 
©Œ
 = "GC_Exec_Threshold";

279 
v®
 = 
¡d
::
	`to_¡ršg
(
GC_Exec_Th»shŞd
);

280 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

282 
©Œ
 = "GC_Block_Selection_Policy";

283 
GC_Block_S–eùiÚ_PŞicy
) {

284 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
GREEDY
:

285 
v®
 = "GREEDY";

287 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RGA
:

288 
v®
 = "RGA";

290 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM
:

291 
v®
 = "RANDOM";

293 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_P
:

294 
v®
 = "RANDOM_P";

296 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_PP
:

297 
v®
 = "RANDOM_PP";

299 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
FIFO
:

300 
v®
 = "FIFO";

305 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

307 
©Œ
 = "Use_Copyback_for_GC";

308 
v®
 = (
U£_Cİyback_fÜ_GC
 ? "true" : "false");

309 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

311 
©Œ
 = "Preemptible_GC_Enabled";

312 
v®
 = (
P»em±ibË_GC_EÇbËd
 ? "true" : "false");

313 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

315 
©Œ
 = "GC_Hard_Threshold";

316 
v®
 = 
¡d
::
	`to_¡ršg
(
GC_H¬d_Th»shŞd
);

317 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

319 
©Œ
 = "Dynamic_Wearleveling_Enabled";

320 
v®
 = (
DyÇmic_W—¾ev–šg_EÇbËd
 ? "true" : "false");

321 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

323 
©Œ
 = "Static_Wearleveling_Enabled";

324 
v®
 = (
Stic_W—¾ev–šg_EÇbËd
 ? "true" : "false");

325 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

327 
©Œ
 = "Static_Wearleveling_Threshold";

328 
v®
 = 
¡d
::
	`to_¡ršg
(
Stic_W—¾ev–šg_Th»shŞd
);

329 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

331 
©Œ
 = "Preferred_suspend_erase_time_for_read";

332 
v®
 = 
¡d
::
	`to_¡ršg
(
P»ã¼ed_su¥’d_”a£_time_fÜ_»ad
);

333 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

335 
©Œ
 = "Preferred_suspend_erase_time_for_write";

336 
v®
 = 
¡d
::
	`to_¡ršg
(
P»ã¼ed_su¥’d_”a£_time_fÜ_wr™e
);

337 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

339 
©Œ
 = "Preferred_suspend_write_time_for_read";

340 
v®
 = 
¡d
::
	`to_¡ršg
(
P»ã¼ed_su¥’d_wr™e_time_fÜ_»ad
);

341 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

343 
©Œ
 = "Flash_Channel_Count";

344 
v®
 = 
¡d
::
	`to_¡ršg
(
FÏsh_ChªÃl_CouÁ
);

345 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

347 
©Œ
 = "Flash_Channel_Width";

348 
v®
 = 
¡d
::
	`to_¡ršg
(
FÏsh_ChªÃl_Width
);

349 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

351 
©Œ
 = "Channel_Transfer_Rate";

352 
v®
 = 
¡d
::
	`to_¡ršg
(
ChªÃl_T¿nsãr_R©e
);

353 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

355 
©Œ
 = "Chip_No_Per_Channel";

356 
v®
 = 
¡d
::
	`to_¡ršg
(
Ch_No_P”_ChªÃl
);

357 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

359 
©Œ
 = "Flash_Comm_Protocol";

360 
FÏsh_Comm_PrÙocŞ
) {

361 
SSD_CompÚ’ts
::
ONFI_PrÙocŞ
::
NVDDR2
:

362 
v®
 = "NVDDR2";

367 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

369 
FÏsh_P¬am‘”s
.
	`XML_£rŸlize
(
xmlwr™”
);

371 
xmlwr™”
.
	`Wr™e_şo£_g
();

372 
	}
}

374 
	gDeviû_P¬am‘”_S‘
::
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
)

376 
Œy


378 autØ
·¿m
 = 
node
->
fœ¡_node
(); 
	g·¿m
;…¬am =…¬am->
Ãxt_siblšg
()) {

379 ià(
¡rcmp
(
·¿m
->
Çme
(), "Seed") == 0) {

380 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

381 
	gS“d
 = 
¡d
::
¡oi
(
v®
);

382 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Enabled_Preconditioning") == 0) {

383 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

384 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

385 
	gEÇbËd_P»cÚd™iÚšg
 = (
v®
.
com·»
("FALSE"è=ğ0 ? 
çl£
 : 
Œue
);

386 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Memory_Type") == 0) {

387 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

388 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

389 ià(
¡rcmp
(
v®
.
c_¡r
(), "FLASH") == 0)

390 
MemÜy_Ty³
 = 
NVM
::
NVM_Ty³
::
FLASH
;

391 
PRINT_ERROR
("Unknown NVMype specified inhe SSD configuration file")

392 } ià(
¡rcmp
(
·¿m
->
Çme
(), "HostInterface_Type") == 0) {

393 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

394 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

395 ià(
¡rcmp
(
v®
.
c_¡r
(), "NVME") == 0) {

396 
Ho¡IÁ”çû_Ty³
 = 
Ho¡IÁ”çû_Ty³s
::
NVME
;

397 } ià(
¡rcmp
(
v®
.
c_¡r
(), "SATA") == 0) {

398 
Ho¡IÁ”çû_Ty³
 = 
Ho¡IÁ”çû_Ty³s
::
SATA
;

400 
PRINT_ERROR
("Unknown host interfaceype specified inhe SSD configuration file")

402 } ià(
¡rcmp
(
·¿m
->
Çme
(), "IO_Queue_Depth") == 0) {

403 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

404 
	gIO_Queue_D•th
 = (
ušt16_t
è
¡d
::
¡ouÎ
(
v®
);

405 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Queue_Fetch_Size") == 0) {

406 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

407 
	gQueue_F‘ch_Size
 = (
ušt16_t
è
¡d
::
¡ouÎ
(
v®
);

408 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Caching_Mechanism") == 0) {

409 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

410 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

411 ià(
¡rcmp
(
v®
.
c_¡r
(), "SIMPLE") == 0) {

412 
Cachšg_Mechªism
 = 
SSD_CompÚ’ts
::Cachšg_Mechªism::
SIMPLE
;

413 } ià(
¡rcmp
(
v®
.
c_¡r
(), "ADVANCED") == 0) {

414 
Cachšg_Mechªism
 = 
SSD_CompÚ’ts
::Cachšg_Mechªism::
ADVANCED
;

416 
PRINT_ERROR
("Unknown data caching mechanism specified inhe SSD configuration file")

418 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_Sharing_Mode") == 0) {

419 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

420 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

421 ià(
¡rcmp
(
v®
.
c_¡r
(), "SHARED") == 0) {

422 
D©a_Cache_Sh¬šg_Mode
 = 
SSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
SHARED
;

423 } ià(
¡rcmp
(
v®
.
c_¡r
(), "EQUAL_PARTITIONING") == 0) {

424 
D©a_Cache_Sh¬šg_Mode
 = 
SSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
EQUAL_PARTITIONING
;

426 
PRINT_ERROR
("Unknown data cache sharing mode specified inhe SSD configuration file")

428 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_Capacity") == 0) {

429 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

430 
	gD©a_Cache_C­ac™y
 = 
¡d
::
¡oul
(
v®
);

431 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_DRAM_Row_Size") == 0) {

432 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

433 
	gD©a_Cache_DRAM_Row_Size
 = 
¡d
::
¡oul
(
v®
);

434 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_DRAM_Data_Rate") == 0) {

435 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

436 
	gD©a_Cache_DRAM_D©a_R©e
 = 
¡d
::
¡oul
(
v®
);

437 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_DRAM_Data_Busrt_Size") == 0) {

438 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

439 
	gD©a_Cache_DRAM_D©a_Bu¤t_Size
 = 
¡d
::
¡oul
(
v®
);

440 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_DRAM_tRCD") == 0) {

441 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

442 
	gD©a_Cache_DRAM_tRCD
 = 
¡d
::
¡oul
(
v®
);

443 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_DRAM_tCL") == 0) {

444 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

445 
	gD©a_Cache_DRAM_tCL
 = 
¡d
::
¡oul
(
v®
);

446 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Data_Cache_DRAM_tRP") == 0) {

447 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

448 
	gD©a_Cache_DRAM_tRP
 = 
¡d
::
¡oul
(
v®
);

449 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Address_Mapping") == 0) {

450 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

451 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

452 ià(
¡rcmp
(
v®
.
c_¡r
(), "PAGE_LEVEL") == 0) {

453 
Add»ss_M­pšg
 = 
SSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
::
PAGE_LEVEL
;

454 } ià(
¡rcmp
(
v®
.
c_¡r
(), "HYBRID") == 0) {

455 
Add»ss_M­pšg
 = 
SSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
::
HYBRID
;

457 
PRINT_ERROR
("Unknown‡ddress mappingype specified inhe SSD configuration file")

460 ià(
¡rcmp
(
·¿m
->
Çme
(), "Ideal_Mapping_Table") == 0) {

461 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

462 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

463 
	gId—l_M­pšg_TabË
 = (
v®
.
com·»
("FALSE"è=ğ0 ? 
çl£
 : 
Œue
);

464 } ià(
¡rcmp
(
·¿m
->
Çme
(), "CMT_Capacity") == 0) {

465 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

466 
	gCMT_C­ac™y
 = 
¡d
::
¡oul
(
v®
);

467 } ià(
¡rcmp
(
·¿m
->
Çme
(), "CMT_Sharing_Mode") == 0) {

468 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

469 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

470 ià(
¡rcmp
(
v®
.
c_¡r
(), "SHARED") == 0) {

471 
CMT_Sh¬šg_Mode
 = 
SSD_CompÚ’ts
::CMT_Sh¬šg_Mode::
SHARED
;

472 } ià(
¡rcmp
(
v®
.
c_¡r
(), "EQUAL_PARTITIONING") == 0) {

473 
CMT_Sh¬šg_Mode
 = 
SSD_CompÚ’ts
::CMT_Sh¬šg_Mode::
EQUAL_SIZE_PARTITIONING
;

475 
PRINT_ERROR
("Unknown CMT sharing mode specified inhe SSD configuration file")

477 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Plane_Allocation_Scheme") == 0) {

478 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

479 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

480 ià(
¡rcmp
(
v®
.
c_¡r
(), "CDPW") == 0) {

481 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDPW
;

482 } ià(
¡rcmp
(
v®
.
c_¡r
(), "CDWP") == 0) {

483 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDWP
;

484 } ià(
¡rcmp
(
v®
.
c_¡r
(), "CPDW") == 0) {

485 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPDW
;

486 } ià(
¡rcmp
(
v®
.
c_¡r
(), "CPWD") == 0) {

487 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPWD
;

488 } ià(
¡rcmp
(
v®
.
c_¡r
(), "CWDP") == 0) {

489 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWDP
;

490 } ià(
¡rcmp
(
v®
.
c_¡r
(), "CWPD") == 0) {

491 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWPD
;

492 } ià(
¡rcmp
(
v®
.
c_¡r
(), "DCPW") == 0) {

493 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCPW
;

494 } ià(
¡rcmp
(
v®
.
c_¡r
(), "DCWP") == 0) {

495 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCWP
;

496 } ià(
¡rcmp
(
v®
.
c_¡r
(), "DPCW") == 0) {

497 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPCW
;

498 } ià(
¡rcmp
(
v®
.
c_¡r
(), "DPWC") == 0) {

499 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPWC
;

500 } ià(
¡rcmp
(
v®
.
c_¡r
(), "DWCP") == 0) {

501 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWCP
;

502 } ià(
¡rcmp
(
v®
.
c_¡r
(), "DWPC") == 0) {

503 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWPC
;

504 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PCDW") == 0) {

505 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCDW
;

506 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PCWD") == 0) {

507 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCWD
;

508 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PDCW") == 0) {

509 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDCW
;

510 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PDWC") == 0) {

511 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDWC
;

512 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PWCD") == 0) {

513 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWCD
;

514 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PWDC") == 0) {

515 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWDC
;

516 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WCDP") == 0) {

517 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCDP
;

518 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WCPD") == 0) {

519 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCPD
;

520 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WDCP") == 0) {

521 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDCP
;

522 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WDPC") == 0) {

523 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDPC
;

524 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WPCD") == 0) {

525 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPCD
;

526 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WPDC") == 0) {

527 
PÏÃ_AÎoÿtiÚ_Scheme
 = 
SSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPDC
;

529 
PRINT_ERROR
("Unknown…lane‡llocation schemeype specified inhe SSD configuration file")

531 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Transaction_Scheduling_Policy") == 0) {

532 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

533 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

534 ià(
¡rcmp
(
v®
.
c_¡r
(), "OUT_OF_ORDER") == 0) {

535 
T¿n§ùiÚ_Schedulšg_PŞicy
 = 
SSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
::
OUT_OF_ORDER
;

536 } ià(
¡rcmp
(
v®
.
c_¡r
(), "FLIN") == 0) {

537 
T¿n§ùiÚ_Schedulšg_PŞicy
 = 
SSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
::
FLIN
;

539 
PRINT_ERROR
("Unknownransaction schedulingype specified inhe SSD configuration file")

541 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Overprovisioning_Ratio") == 0) {

542 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

543 
	gOv”´ovisiÚšg_R©io
 = 
¡d
::
¡od
(
v®
);

544 if(
	gOv”´ovisiÚšg_R©io
 < 0.05) {

545 
PRINT_MESSAGE
("The specified overprovisioning„atio isoo small. The simluation may‚ot„un correctly.")

547 } ià(
¡rcmp
(
·¿m
->
Çme
(), "GC_Exec_Threshold") == 0) {

548 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

549 
	gGC_Exec_Th»shŞd
 = 
¡d
::
¡od
(
v®
);

550 } ià(
¡rcmp
(
·¿m
->
Çme
(), "GC_Block_Selection_Policy") == 0) {

551 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

552 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

553 ià(
¡rcmp
(
v®
.
c_¡r
(), "GREEDY") == 0) {

554 
GC_Block_S–eùiÚ_PŞicy
 = 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
GREEDY
;

555 } ià(
¡rcmp
(
v®
.
c_¡r
(), "RGA") == 0) {

556 
GC_Block_S–eùiÚ_PŞicy
 = 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RGA
;

557 } ià(
¡rcmp
(
v®
.
c_¡r
(), "RANDOM") == 0) {

558 
GC_Block_S–eùiÚ_PŞicy
 = 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM
;

559 } ià(
¡rcmp
(
v®
.
c_¡r
(), "RANDOM_P") == 0) {

560 
GC_Block_S–eùiÚ_PŞicy
 = 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_P
;

561 } ià(
¡rcmp
(
v®
.
c_¡r
(), "RANDOM_PP") == 0) {

562 
GC_Block_S–eùiÚ_PŞicy
 = 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_PP
;

563 } ià(
¡rcmp
(
v®
.
c_¡r
(), "FIFO") == 0) {

564 
GC_Block_S–eùiÚ_PŞicy
 = 
SSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
FIFO
;

566 
PRINT_ERROR
("Unknown GC block selection…olicy specified inhe SSD configuration file")

568 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Use_Copyback_for_GC") == 0) {

569 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

570 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

571 
	gU£_Cİyback_fÜ_GC
 = (
v®
.
com·»
("FALSE"è=ğ0 ? 
çl£
 : 
Œue
);

572 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Preemptible_GC_Enabled") == 0) {

573 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

574 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

575 
	gP»em±ibË_GC_EÇbËd
 = (
v®
.
com·»
("FALSE"è=ğ0? 
çl£
 : 
Œue
);

576 } ià(
¡rcmp
(
·¿m
->
Çme
(), "GC_Hard_Threshold") == 0) {

577 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

578 
	gGC_H¬d_Th»shŞd
 = 
¡d
::
¡od
(
v®
);

579 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Dynamic_Wearleveling_Enabled") == 0) {

580 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

581 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

582 
	gDyÇmic_W—¾ev–šg_EÇbËd
 = (
v®
.
com·»
("FALSE"è=ğ0 ? 
çl£
 : 
Œue
);

583 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Static_Wearleveling_Enabled") == 0) {

584 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

585 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

586 
	gStic_W—¾ev–šg_EÇbËd
 = (
v®
.
com·»
("FALSE"è=ğ0 ? 
çl£
 : 
Œue
);

587 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Static_Wearleveling_Threshold") == 0) {

588 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

589 
	gStic_W—¾ev–šg_Th»shŞd
 = 
¡d
::
¡oul
(
v®
);

590 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Prefered_suspend_erase_time_for_read") == 0) {

591 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

592 
	gP»ã¼ed_su¥’d_”a£_time_fÜ_»ad
 = 
¡d
::
¡ouÎ
(
v®
);

593 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Preferred_suspend_erase_time_for_write") == 0) {

594 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

595 
	gP»ã¼ed_su¥’d_”a£_time_fÜ_wr™e
 = 
¡d
::
¡ouÎ
(
v®
);

596 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Preferred_suspend_write_time_for_read") == 0) {

597 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

598 
	gP»ã¼ed_su¥’d_wr™e_time_fÜ_»ad
 = 
¡d
::
¡ouÎ
(
v®
);

599 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Flash_Channel_Count") == 0) {

600 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

601 
	gFÏsh_ChªÃl_CouÁ
 = 
¡d
::
¡oul
(
v®
);

602 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Flash_Channel_Width") == 0) {

603 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

604 
	gFÏsh_ChªÃl_Width
 = 
¡d
::
¡oul
(
v®
);

605 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Channel_Transfer_Rate") == 0) {

606 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

607 
	gChªÃl_T¿nsãr_R©e
 = 
¡d
::
¡oul
(
v®
);

608 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Chip_No_Per_Channel") == 0) {

609 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

610 
	gCh_No_P”_ChªÃl
 = 
¡d
::
¡oul
(
v®
);

611 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Flash_Comm_Protocol") == 0) {

612 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

613 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

614 ià(
¡rcmp
(
v®
.
c_¡r
(), "NVDDR2") == 0) {

615 
FÏsh_Comm_PrÙocŞ
 = 
SSD_CompÚ’ts
::
ONFI_PrÙocŞ
::
NVDDR2
;

617 
PRINT_ERROR
("Unknown flash communication…rotocolype specified inhe SSD configuration file")

620 ià(
¡rcmp
(
·¿m
->
Çme
(), "Flash_Parameter_Set") == 0)

622 
FÏsh_P¬am‘”s
.
XML_de£rŸlize
(
·¿m
);

626 
ÿtch
 (...)

628 
PRINT_ERROR
("Error in Device_Parameter_Set!")

	@src/exec/Device_Parameter_Set.h

1 #iâdeà
DEVICE_PARAMETER_SET_H


2 
	#DEVICE_PARAMETER_SET_H


	)

4 
	~"../ssd/SSD_Defs.h
"

5 
	~"../ssd/Ho¡_IÁ”çû_Defs.h
"

6 
	~"../ssd/Ho¡_IÁ”çû_Ba£.h
"

7 
	~"../ssd/D©a_Cache_Mªag”_Ba£.h
"

8 
	~"../ssd/Add»ss_M­pšg_Un™_Ba£.h
"

9 
	~"../ssd/TSU_Ba£.h
"

10 
	~"../ssd/ONFI_ChªÃl_Ba£.h
"

11 
	~"../ssd/GC_ªd_WL_Un™_Page_Lev–.h
"

12 
	~"../nvm_ch/NVM_Ty³s.h
"

13 
	~"P¬am‘”_S‘_Ba£.h
"

14 
	~"FÏsh_P¬am‘”_S‘.h
"

16 şas 
	cDeviû_P¬am‘”_S‘
 : 
public
 
P¬am‘”_S‘_Ba£


18 
public
:

19 
S“d
;

20 
boŞ
 
	mEÇbËd_P»cÚd™iÚšg
;

21 
	mNVM
::
NVM_Ty³
 
MemÜy_Ty³
;

22 
Ho¡IÁ”çû_Ty³s
 
	mHo¡IÁ”çû_Ty³
;

23 
ušt16_t
 
	mIO_Queue_D•th
;

24 
ušt16_t
 
	mQueue_F‘ch_Size
;

25 
	mSSD_CompÚ’ts
::
Cachšg_Mechªism
 Caching_Mechanism;

26 
	mSSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
 
D©a_Cache_Sh¬šg_Mode
;

27 
	mD©a_Cache_C­ac™y
;

28 
	mD©a_Cache_DRAM_Row_Size
;

29 
	mD©a_Cache_DRAM_D©a_R©e
;

30 
	mD©a_Cache_DRAM_D©a_Bu¤t_Size
;

31 
sim_time_ty³
 
	mD©a_Cache_DRAM_tRCD
;

32 
sim_time_ty³
 
	mD©a_Cache_DRAM_tCL
;

33 
sim_time_ty³
 
	mD©a_Cache_DRAM_tRP
;

34 
	mSSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
 
Add»ss_M­pšg
;

35 
boŞ
 
	mId—l_M­pšg_TabË
;

36 
	mCMT_C­ac™y
;

37 
	mSSD_CompÚ’ts
::
CMT_Sh¬šg_Mode
 CMT_Sharing_Mode;

38 
	mSSD_CompÚ’ts
::
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
 
PÏÃ_AÎoÿtiÚ_Scheme
;

39 
	mSSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
 
T¿n§ùiÚ_Schedulšg_PŞicy
;

40 
	mOv”´ovisiÚšg_R©io
;

41 
	mGC_Exec_Th»shŞd
;

42 
	mSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
 
GC_Block_S–eùiÚ_PŞicy
;

43 
boŞ
 
	mU£_Cİyback_fÜ_GC
;

44 
boŞ
 
	mP»em±ibË_GC_EÇbËd
;

45 
	mGC_H¬d_Th»shŞd
;

46 
boŞ
 
	mDyÇmic_W—¾ev–šg_EÇbËd
;

47 
boŞ
 
	mStic_W—¾ev–šg_EÇbËd
;

48 
	mStic_W—¾ev–šg_Th»shŞd
;

49 
sim_time_ty³
 
	mP»ã¼ed_su¥’d_”a£_time_fÜ_»ad
;

50 
sim_time_ty³
 
	mP»ã¼ed_su¥’d_”a£_time_fÜ_wr™e
;

51 
sim_time_ty³
 
	mP»ã¼ed_su¥’d_wr™e_time_fÜ_»ad
;

52 
	mFÏsh_ChªÃl_CouÁ
;

53 
	mFÏsh_ChªÃl_Width
;

54 
	mChªÃl_T¿nsãr_R©e
;

55 
	mCh_No_P”_ChªÃl
;

56 
	mSSD_CompÚ’ts
::
ONFI_PrÙocŞ
 
FÏsh_Comm_PrÙocŞ
;

57 
FÏsh_P¬am‘”_S‘
 
	mFÏsh_P¬am‘”s
;

58 
XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
);

59 
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
);

	@src/exec/Execution_Parameter_Set.cpp

1 
	~"ExecutiÚ_P¬am‘”_S‘.h
"

4 
Ho¡_P¬am‘”_S‘
 
	gExecutiÚ_P¬am‘”_S‘
::
Ho¡_CÚfigu¿tiÚ
;

5 
Deviû_P¬am‘”_S‘
 
	gExecutiÚ_P¬am‘”_S‘
::
SSD_Deviû_CÚfigu¿tiÚ
;

8 
	gExecutiÚ_P¬am‘”_S‘
::
	$XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
)

10 
¡d
::
¡ršg
 
tmp
;

11 
tmp
 = "Execution_Parameter_Set";

12 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

14 
Ho¡_CÚfigu¿tiÚ
.
	`XML_£rŸlize
(
xmlwr™”
);

15 
SSD_Deviû_CÚfigu¿tiÚ
.
	`XML_£rŸlize
(
xmlwr™”
);

17 
xmlwr™”
.
	`Wr™e_şo£_g
();

18 
	}
}

20 
	gExecutiÚ_P¬am‘”_S‘
::
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
)

22 
Œy
 {

23 autØ
·¿m
 = 
node
->
fœ¡_node
(); 
	g·¿m
;…¬am =…¬am->
Ãxt_siblšg
()) {

24 ià(
¡rcmp
(
·¿m
->
Çme
(), "Host_Parameter_Set") == 0) {

25 
Ho¡_CÚfigu¿tiÚ
.
XML_de£rŸlize
(
·¿m
);

26 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Device_Parameter_Set") == 0) {

27 
SSD_Deviû_CÚfigu¿tiÚ
.
XML_de£rŸlize
(
·¿m
);

30 } 
ÿtch
 (...) {

31 
PRINT_ERROR
("Error inhe Execution_Parameter_Set!")

	@src/exec/Execution_Parameter_Set.h

1 #iâdeà
EXECUTION_PARAMETER_SET_H


2 
	#EXECUTION_PARAMETER_SET_H


	)

4 
	~<veùÜ
>

5 
	~"P¬am‘”_S‘_Ba£.h
"

6 
	~"Deviû_P¬am‘”_S‘.h
"

7 
	~"IO_Flow_P¬am‘”_S‘.h
"

8 
	~"Ho¡_P¬am‘”_S‘.h
"

10 şas 
	cExecutiÚ_P¬am‘”_S‘
 : 
public
 
P¬am‘”_S‘_Ba£


12 
public
:

13 
Ho¡_P¬am‘”_S‘
 
Ho¡_CÚfigu¿tiÚ
;

14 
Deviû_P¬am‘”_S‘
 
	mSSD_Deviû_CÚfigu¿tiÚ
;

16 
XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
);

17 
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
);

	@src/exec/Flash_Parameter_Set.cpp

1 
	~<®gÜ™hm
>

2 
	~<¡ršg.h
>

3 
	~"../sim/Engše.h
"

4 
	~"FÏsh_P¬am‘”_S‘.h
"

6 
FÏsh_TechnŞogy_Ty³
 
	gFÏsh_P¬am‘”_S‘
::
FÏsh_TechnŞogy
 = FÏsh_TechnŞogy_Ty³::
MLC
;

7 
	gNVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
 
FÏsh_P¬am‘”_S‘
::
CMD_Su¥’siÚ_SuµÜt
 = 
NVM
::FÏshMemÜy::Commªd_Su¥’siÚ_Mode::
ERASE
;

8 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Page_R—d_L©’cy_LSB
 = 75000;

9 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Page_R—d_L©’cy_CSB
 = 75000;

10 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Page_R—d_L©’cy_MSB
 = 75000;

11 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Page_Prog¿m_L©’cy_LSB
 = 750000;

12 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Page_Prog¿m_L©’cy_CSB
 = 750000;

13 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Page_Prog¿m_L©’cy_MSB
 = 750000;

14 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Block_E¿£_L©’cy
 = 3800000;

15 
	gFÏsh_P¬am‘”_S‘
::
Block_PE_Cyşes_Lim™
 = 10000;

16 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Su¥’d_E¿£_Time
 = 700000;

17 
sim_time_ty³
 
	gFÏsh_P¬am‘”_S‘
::
Su¥’d_Prog¿m_Time
 = 100000;

18 
	gFÏsh_P¬am‘”_S‘
::
D›_No_P”_Ch
 = 2;

19 
	gFÏsh_P¬am‘”_S‘
::
PÏÃ_No_P”_D›
 = 2;

20 
	gFÏsh_P¬am‘”_S‘
::
Block_No_P”_PÏÃ
 = 2048;

21 
	gFÏsh_P¬am‘”_S‘
::
Page_No_P”_Block
 = 256;

22 
	gFÏsh_P¬am‘”_S‘
::
Page_C­ac™y
 = 8192;

23 
	gFÏsh_P¬am‘”_S‘
::
Page_M‘ad©_C­ac™y
 = 1872;

25 
	gFÏsh_P¬am‘”_S‘
::
	$XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
)

27 
¡d
::
¡ršg
 
tmp
;

28 
tmp
 = "Flash_Parameter_Set";

29 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

31 
¡d
::
¡ršg
 
©Œ
 = "Flash_Technology";

32 
¡d
::
¡ršg
 
v®
;

33 
FÏsh_TechnŞogy
) {

34 
FÏsh_TechnŞogy_Ty³
::
SLC
:

35 
v®
 = "SLC";

37 
FÏsh_TechnŞogy_Ty³
::
MLC
:

38 
v®
 = "MLC";

40 
FÏsh_TechnŞogy_Ty³
::
TLC
:

41 
v®
 = "TLC";

46 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

48 
©Œ
 = "CMD_Suspension_Support";

49 
CMD_Su¥’siÚ_SuµÜt
) {

50 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
NONE
:

51 
v®
 = "NONE";

53 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
ERASE
:

54 
v®
 = "ERASE";

56 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
PROGRAM
:

57 
v®
 = "PROGRAM";

59 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
PROGRAM_ERASE
:

60 
v®
 = "PROGRAM_ERASE";

65 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

67 
©Œ
 = "Page_Read_Latency_LSB";

68 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_R—d_L©’cy_LSB
);

69 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

71 
©Œ
 = "Page_Read_Latency_CSB";

72 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_R—d_L©’cy_CSB
);

73 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

75 
©Œ
 = "Page_Read_Latency_MSB";

76 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_R—d_L©’cy_MSB
);

77 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

79 
©Œ
 = "Page_Program_Latency_LSB";

80 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_Prog¿m_L©’cy_LSB
);

81 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

83 
©Œ
 = "Page_Program_Latency_CSB";

84 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_Prog¿m_L©’cy_CSB
);

85 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

87 
©Œ
 = "Page_Program_Latency_MSB";

88 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_Prog¿m_L©’cy_MSB
);

89 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

91 
©Œ
 = "Block_Erase_Latency";

92 
v®
 = 
¡d
::
	`to_¡ršg
(
Block_E¿£_L©’cy
);

93 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

95 
©Œ
 = "Block_PE_Cycles_Limit";

96 
v®
 = 
¡d
::
	`to_¡ršg
(
Block_PE_Cyşes_Lim™
);

97 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

99 
©Œ
 = "Suspend_Erase_Time";

100 
v®
 = 
¡d
::
	`to_¡ršg
(
Su¥’d_E¿£_Time
);

101 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

103 
©Œ
 = "Suspend_Program_Time";

104 
v®
 = 
¡d
::
	`to_¡ršg
(
Su¥’d_Prog¿m_Time
);

105 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

107 
©Œ
 = "Die_No_Per_Chip";

108 
v®
 = 
¡d
::
	`to_¡ršg
(
D›_No_P”_Ch
);

109 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

111 
©Œ
 = "Plane_No_Per_Die";

112 
v®
 = 
¡d
::
	`to_¡ršg
(
PÏÃ_No_P”_D›
);

113 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

115 
©Œ
 = "Block_No_Per_Plane";

116 
v®
 = 
¡d
::
	`to_¡ršg
(
Block_No_P”_PÏÃ
);

117 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

119 
©Œ
 = "Page_No_Per_Block";

120 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_No_P”_Block
);

121 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

123 
©Œ
 = "Page_Capacity";

124 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_C­ac™y
);

125 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

127 
©Œ
 = "Page_Metadat_Capacity";

128 
v®
 = 
¡d
::
	`to_¡ršg
(
Page_M‘ad©_C­ac™y
);

129 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

131 
xmlwr™”
.
	`Wr™e_şo£_g
();

132 
	}
}

134 
	gFÏsh_P¬am‘”_S‘
::
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
)

136 
Œy
 {

137 autØ
·¿m
 = 
node
->
fœ¡_node
(); 
	g·¿m
;…¬am =…¬am->
Ãxt_siblšg
()) {

138 ià(
¡rcmp
(
·¿m
->
Çme
(), "Flash_Technology") == 0) {

139 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

140 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

141 ià(
¡rcmp
(
v®
.
c_¡r
(), "SLC") == 0)

142 
FÏsh_TechnŞogy
 = 
FÏsh_TechnŞogy_Ty³
::
SLC
;

143 ià(
¡rcmp
(
v®
.
c_¡r
(), "MLC") == 0)

144 
FÏsh_TechnŞogy
 = 
FÏsh_TechnŞogy_Ty³
::
MLC
;

145 ià(
¡rcmp
(
v®
.
c_¡r
(), "TLC") == 0)

146 
FÏsh_TechnŞogy
 = 
FÏsh_TechnŞogy_Ty³
::
TLC
;

147 
PRINT_ERROR
("Unknown flashechnologyype specified inhe input file")

148 } ià(
¡rcmp
(
·¿m
->
Çme
(), "CMD_Suspension_Support") == 0) {

149 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

150 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

151 ià(
¡rcmp
(
v®
.
c_¡r
(), "NONE") == 0) {

152 
CMD_Su¥’siÚ_SuµÜt
 = 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
NONE
;

153 } ià(
¡rcmp
(
v®
.
c_¡r
(), "ERASE") == 0) {

154 
CMD_Su¥’siÚ_SuµÜt
 = 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
ERASE
;

155 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PROGRAM") == 0) {

156 
CMD_Su¥’siÚ_SuµÜt
 = 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
PROGRAM
;

157 } ià(
¡rcmp
(
v®
.
c_¡r
(), "PROGRAM_ERASE") == 0) {

158 
CMD_Su¥’siÚ_SuµÜt
 = 
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
PROGRAM_ERASE
;

160 
PRINT_ERROR
("Unknown command suspensionype specified inhe input file")

162 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Read_Latency_LSB") == 0) {

163 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

164 
	gPage_R—d_L©’cy_LSB
 = 
¡d
::
¡ouÎ
(
v®
);

165 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Read_Latency_CSB") == 0) {

166 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

167 
	gPage_R—d_L©’cy_CSB
 = 
¡d
::
¡ouÎ
(
v®
);

168 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Read_Latency_MSB") == 0) {

169 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

170 
	gPage_R—d_L©’cy_MSB
 = 
¡d
::
¡ouÎ
(
v®
);

171 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Program_Latency_LSB") == 0) {

172 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

173 
	gPage_Prog¿m_L©’cy_LSB
 = 
¡d
::
¡ouÎ
(
v®
);

174 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Program_Latency_CSB") == 0) {

175 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

176 
	gPage_Prog¿m_L©’cy_CSB
 = 
¡d
::
¡ouÎ
(
v®
);

177 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Program_Latency_MSB") == 0) {

178 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

179 
	gPage_Prog¿m_L©’cy_MSB
 = 
¡d
::
¡ouÎ
(
v®
);

180 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Block_Erase_Latency") == 0) {

181 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

182 
	gBlock_E¿£_L©’cy
 = 
¡d
::
¡ouÎ
(
v®
);

183 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Block_PE_Cycles_Limit") == 0) {

184 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

185 
	gBlock_PE_Cyşes_Lim™
 = 
¡d
::
¡oul
(
v®
);

186 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Suspend_Erase_Time") == 0) {

187 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

188 
	gSu¥’d_E¿£_Time
 = 
¡d
::
¡ouÎ
(
v®
);

189 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Suspend_Program_Time") == 0) {

190 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

191 
	gSu¥’d_Prog¿m_Time
 = 
¡d
::
¡ouÎ
(
v®
);

192 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Die_No_Per_Chip") == 0) {

193 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

194 
	gD›_No_P”_Ch
 = 
¡d
::
¡oul
(
v®
);

195 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Plane_No_Per_Die") == 0) {

196 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

197 
	gPÏÃ_No_P”_D›
 = 
¡d
::
¡oul
(
v®
);

198 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Block_No_Per_Plane") == 0) {

199 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

200 
	gBlock_No_P”_PÏÃ
 = 
¡d
::
¡oul
(
v®
);

201 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_No_Per_Block") == 0) {

202 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

203 
	gPage_No_P”_Block
 = 
¡d
::
¡oul
(
v®
);

204 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Capacity") == 0) {

205 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

206 
	gPage_C­ac™y
 = 
¡d
::
¡oul
(
v®
);

207 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Page_Metadat_Capacity") == 0) {

208 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

209 
	gPage_M‘ad©_C­ac™y
 = 
¡d
::
¡oul
(
v®
);

212 } 
ÿtch
 (...) {

213 
PRINT_ERROR
("Error inhe Flash_Parameter_Set!")

	@src/exec/Flash_Parameter_Set.h

1 #iâdeà
FLASH_PARAMETER_SET_H


2 
	#FLASH_PARAMETER_SET_H


	)

4 
	~"../sim/Sim_Defs.h
"

5 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

6 
	~"P¬am‘”_S‘_Ba£.h
"

8 şas 
	cFÏsh_P¬am‘”_S‘
 : 
P¬am‘”_S‘_Ba£


10 
public
:

11 
FÏsh_TechnŞogy_Ty³
 
FÏsh_TechnŞogy
;

12 
	mNVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
 
CMD_Su¥’siÚ_SuµÜt
;

13 
sim_time_ty³
 
	mPage_R—d_L©’cy_LSB
;

14 
sim_time_ty³
 
	mPage_R—d_L©’cy_CSB
;

15 
sim_time_ty³
 
	mPage_R—d_L©’cy_MSB
;

16 
sim_time_ty³
 
	mPage_Prog¿m_L©’cy_LSB
;

17 
sim_time_ty³
 
	mPage_Prog¿m_L©’cy_CSB
;

18 
sim_time_ty³
 
	mPage_Prog¿m_L©’cy_MSB
;

19 
sim_time_ty³
 
	mBlock_E¿£_L©’cy
;

20 
	mBlock_PE_Cyşes_Lim™
;

21 
sim_time_ty³
 
	mSu¥’d_E¿£_Time
;

22 
sim_time_ty³
 
	mSu¥’d_Prog¿m_Time
;

23 
	mD›_No_P”_Ch
;

24 
	mPÏÃ_No_P”_D›
;

25 
	mBlock_No_P”_PÏÃ
;

26 
	mPage_No_P”_Block
;

27 
	mPage_C­ac™y
;

28 
	mPage_M‘ad©_C­ac™y
;

29 
XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
);

30 
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
);

	@src/exec/Host_Parameter_Set.cpp

1 
	~<®gÜ™hm
>

2 
	~"Ho¡_P¬am‘”_S‘.h
"

5 
	gHo¡_P¬am‘”_S‘
::
PCIe_Lªe_Bªdwidth
 = 0.4;

6 
	gHo¡_P¬am‘”_S‘
::
PCIe_Lªe_CouÁ
 = 4;

7 
sim_time_ty³
 
	gHo¡_P¬am‘”_S‘
::
SATA_Proûssšg_D–ay
;

8 
boŞ
 
	gHo¡_P¬am‘”_S‘
::
EÇbË_Re¥Ú£Time_Loggšg
 = 
çl£
;

9 
sim_time_ty³
 
	gHo¡_P¬am‘”_S‘
::
Re¥Ú£Time_Loggšg_P”iod_L’gth
 = 400000;

10 
	g¡d
::
¡ršg
 
Ho¡_P¬am‘”_S‘
::
IÅut_fe_·th
;

11 
	g¡d
::
veùÜ
<
IO_Flow_P¬am‘”_S‘
*> 
Ho¡_P¬am‘”_S‘
::
IO_Flow_Defš™iÚs
;

13 
	gHo¡_P¬am‘”_S‘
::
	$XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
)

15 
¡d
::
¡ršg
 
tmp
;

16 
tmp
 = "Host_Parameter_Set";

17 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

19 
¡d
::
¡ršg
 
©Œ
 = "PCIe_Lane_Bandwidth";

20 
¡d
::
¡ršg
 
v®
 = std::
	`to_¡ršg
(
PCIe_Lªe_Bªdwidth
);

21 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

23 
©Œ
 = "PCIe_Lane_Count";

24 
v®
 = 
¡d
::
	`to_¡ršg
(
PCIe_Lªe_CouÁ
);

25 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

27 
©Œ
 = "SATA_Processing_Delay";

28 
v®
 = 
¡d
::
	`to_¡ršg
(
SATA_Proûssšg_D–ay
);

29 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

31 
©Œ
 = "Enable_ResponseTime_Logging";

32 
v®
 = (
EÇbË_Re¥Ú£Time_Loggšg
 ? "true" : "false");

33 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

35 
©Œ
 = "ResponseTime_Logging_Period_Length";

36 
v®
 = 
¡d
::
	`to_¡ršg
(
Re¥Ú£Time_Loggšg_P”iod_L’gth
);

37 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

39 
xmlwr™”
.
	`Wr™e_şo£_g
();

40 
	}
}

42 
	gHo¡_P¬am‘”_S‘
::
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
)

44 
Œy
 {

45 autØ
·¿m
 = 
node
->
fœ¡_node
(); 
	g·¿m
;…¬am =…¬am->
Ãxt_siblšg
()) {

46 ià(
¡rcmp
(
·¿m
->
Çme
(), "PCIe_Lane_Bandwidth") == 0) {

47 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

48 
	gPCIe_Lªe_Bªdwidth
 = 
¡d
::
¡od
(
v®
);

49 } ià(
¡rcmp
(
·¿m
->
Çme
(), "PCIe_Lane_Count") == 0) {

50 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

51 
	gPCIe_Lªe_CouÁ
 = 
¡d
::
¡oul
(
v®
);

52 } ià(
¡rcmp
(
·¿m
->
Çme
(), "SATA_Processing_Delay") == 0) {

53 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

54 
	gSATA_Proûssšg_D–ay
 = 
¡d
::
¡oul
(
v®
);

55 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Enable_ResponseTime_Logging") == 0) {

56 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

57 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

58 
	gEÇbË_Re¥Ú£Time_Loggšg
 = (
v®
.
com·»
("FALSE"è=ğ0 ? 
çl£
 : 
Œue
);

59 } ià(
¡rcmp
(
·¿m
->
Çme
(), "ResponseTime_Logging_Period_Length") == 0) {

60 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

61 
	gRe¥Ú£Time_Loggšg_P”iod_L’gth
 = 
¡d
::
¡oul
(
v®
);

64 } 
ÿtch
 (...) {

65 
PRINT_ERROR
("Error inhe Host_Parameter_Set!")

	@src/exec/Host_Parameter_Set.h

1 #iâdeà
HOST_PARAMETER_SEt_H


2 
	#HOST_PARAMETER_SEt_H


	)

4 
	~<veùÜ
>

5 
	~"P¬am‘”_S‘_Ba£.h
"

6 
	~"IO_Flow_P¬am‘”_S‘.h
"

8 şas 
	cHo¡_P¬am‘”_S‘
 : 
public
 
P¬am‘”_S‘_Ba£


10 
public
:

11 
PCIe_Lªe_Bªdwidth
;

12 
	mPCIe_Lªe_CouÁ
;

13 
sim_time_ty³
 
	mSATA_Proûssšg_D–ay
;

14 
boŞ
 
	mEÇbË_Re¥Ú£Time_Loggšg
;

15 
sim_time_ty³
 
	mRe¥Ú£Time_Loggšg_P”iod_L’gth
;

16 
	m¡d
::
veùÜ
<
IO_Flow_P¬am‘”_S‘
*> 
IO_Flow_Defš™iÚs
;

17 
	m¡d
::
¡ršg
 
IÅut_fe_·th
;

19 
XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
);

20 
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
);

	@src/exec/Host_System.cpp

1 
	~"../sim/Engše.h
"

2 
	~"Ho¡_Sy¡em.h
"

3 
	~"../ssd/Ho¡_IÁ”çû_Ba£.h
"

4 
	~"../ssd/Ho¡_IÁ”çû_NVMe.h
"

5 
	~"../ho¡/PCIe_RoÙ_Com¶ex.h
"

6 
	~"../ho¡/IO_Flow_SyÁh‘ic.h
"

7 
	~"../ho¡/IO_Flow_T¿û_Ba£d.h
"

8 
	~"../uts/SŒšgToŞs.h
"

9 
	~"../uts/Logiÿl_Add»ss_P¬t™iÚšg_Un™.h
"

11 
	gHo¡_Sy¡em
::
	$Ho¡_Sy¡em
(
Ho¡_P¬am‘”_S‘
* 
·¿m‘”s
, 
boŞ
 
´ecÚd™iÚšg_»quœed
, 
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
* 
ssd_ho¡_š‹rçû
):

12 
MQSimEngše
::
	`Sim_Objeù
("Ho¡"), 
	$´ecÚd™iÚšg_»quœed
(
´ecÚd™iÚšg_»quœed
)

14 
SimuÏtÜ
->
	`AddObjeù
(
this
);

17 ià(((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_NVMe
*)
ssd_ho¡_š‹rçû
)->
	`G‘Ty³
(è=ğ
Ho¡IÁ”çû_Ty³s
::
SATA
) {

18 
this
->
SATA_hba
 = 
Ãw
 
Ho¡_CompÚ’ts
::
	`SATA_HBA
(
	`ID
(è+ ".SATA_HBA", ((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_SATA
*)
ssd_ho¡_š‹rçû
)->
	`G‘_ncq_d•th
(), 
·¿m‘”s
->
SATA_Proûssšg_D–ay
, 
NULL
, NULL);

20 
this
->
SATA_hba
 = 
NULL
;

22 
this
->
Lšk
 = 
Ãw
 
Ho¡_CompÚ’ts
::
	`PCIe_Lšk
Ñhis->
	`ID
(è+ ".PCIeLšk", 
NULL
, NULL, 
·¿m‘”s
->
PCIe_Lªe_Bªdwidth
,…¬am‘”s->
PCIe_Lªe_CouÁ
);

23 
this
->
PCIe_roÙ_com¶ex
 = 
Ãw
 
Ho¡_CompÚ’ts
::
	`PCIe_RoÙ_Com¶ex
Ñhis->
Lšk
, 
ssd_ho¡_š‹rçû
->
	`G‘Ty³
(),his->
SATA_hba
, 
NULL
);

24 
this
->
Lšk
->
	`S‘_roÙ_com¶ex
Ñhis->
PCIe_roÙ_com¶ex
);

25 
this
->
PCIe_sw™ch
 = 
Ãw
 
Ho¡_CompÚ’ts
::
	`PCIe_Sw™ch
Ñhis->
Lšk
, 
ssd_ho¡_š‹rçû
);

26 
this
->
Lšk
->
	`S‘_pc›_sw™ch
Ñhis->
PCIe_sw™ch
);

27 
SimuÏtÜ
->
	`AddObjeù
(
this
->
Lšk
);

30 
LHA_ty³
 
add»ss_¿nge_³r_æow
 = 
ssd_ho¡_š‹rçû
->
	`G‘_max_logiÿl_£ùÜ_add»ss
(è/ 
·¿m‘”s
->
IO_Flow_Defš™iÚs
.
	`size
();

31 
ušt16_t
 
æow_id
 = 0; flow_id < 
·¿m‘”s
->
IO_Flow_Defš™iÚs
.
	`size
(); flow_id++) {

32 
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
* 
io_æow
 = 
NULL
;

35 
ušt16_t
 
nvme_sq_size
 = 0, 
nvme_cq_size
 = 0;

36 ((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_NVMe
*)
ssd_ho¡_š‹rçû
)->
	`G‘Ty³
()) {

37 
Ho¡IÁ”çû_Ty³s
::
NVME
:

38 
nvme_sq_size
 = ((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_NVMe
*)
ssd_ho¡_š‹rçû
)->
	`G‘_submissiÚ_queue_d•th
();

39 
nvme_cq_size
 = ((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_NVMe
*)
ssd_ho¡_š‹rçû
)->
	`G‘_com¶‘iÚ_queue_d•th
();

45 
·¿m‘”s
->
IO_Flow_Defš™iÚs
[
æow_id
]->
Ty³
) {

46 
Flow_Ty³
::
SYNTHETIC
: {

47 
IO_Flow_P¬am‘”_S‘_SyÁh‘ic
* 
æow_·¿m
 = (IO_Flow_P¬am‘”_S‘_SyÁh‘ic*)
·¿m‘”s
->
IO_Flow_Defš™iÚs
[
æow_id
];

48 ià(
æow_·¿m
->
WÜkšg_S‘_P”ûÁage
 > 100 || flow_param->Working_Set_Percentage < 1) {

49 
æow_·¿m
->
WÜkšg_S‘_P”ûÁage
 = 100;

51 
io_æow
 = 
Ãw
 
Ho¡_CompÚ’ts
::
	`IO_Flow_SyÁh‘ic
(
this
->
	`ID
(è+ ".IO_Flow.SyÁh.No_" + 
¡d
::
	`to_¡ršg
(
æow_id
), flow_id,

52 
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
	`S¹_lha_avaabË_to_æow
(
æow_id
),

53 
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
	`End_lha_avaabË_to_æow
(
æow_id
),

54 (()
æow_·¿m
->
WÜkšg_S‘_P”ûÁage
 / 100.0), 
	`FLOW_ID_TO_Q_ID
(
æow_id
), 
nvme_sq_size
, 
nvme_cq_size
,

55 
æow_·¿m
->
PriÜ™y_CÏss
, flow_·¿m->
R—d_P”ûÁage
 / (100.0), flow_·¿m->
Add»ss_Di¡ributiÚ
, flow_·¿m->
P”ûÁage_of_HÙ_RegiÚ
 / (100.0),

56 
æow_·¿m
->
Reque¡_Size_Di¡ributiÚ
, flow_·¿m->
Av”age_Reque¡_Size
, flow_·¿m->
V¬Ÿnû_Reque¡_Size
,

57 
æow_·¿m
->
SyÁh‘ic_G’”©Ü_Ty³
, (æow_·¿m->
Bªdwidth
 =ğ0? 0 :
NªoSecÚdCÛff
 / ((æow_·¿m->Bªdwidth / 
SECTOR_SIZE_IN_BYTE
è/ flow_·¿m->
Av”age_Reque¡_Size
)),

58 
æow_·¿m
->
Av”age_No_of_Reqs_š_Queue
, flow_·¿m->
G’”©ed_AligÃd_Add»s£s
, flow_·¿m->
Add»ss_Alignm’t_Un™
,

59 
æow_·¿m
->
S“d
, flow_·¿m->
Stİ_Time
, flow_·¿m->
In™Ÿl_Occu·ncy_P”ûÁage
 / (100.0), flow_·¿m->
TÙ®_Reque¡s_To_G’”©e
, 
ssd_ho¡_š‹rçû
->
	`G‘Ty³
(), 
this
->
PCIe_roÙ_com¶ex
,his->
SATA_hba
,

60 
·¿m‘”s
->
EÇbË_Re¥Ú£Time_Loggšg
,…¬am‘”s->
Re¥Ú£Time_Loggšg_P”iod_L’gth
,…¬am‘”s->
IÅut_fe_·th
 + ".IO_Flow.No_" + 
¡d
::
	`to_¡ršg
(
æow_id
) + ".log");

61 
this
->
IO_æows
.
	`push_back
(
io_æow
);

64 
Flow_Ty³
::
TRACE
: {

65 
IO_Flow_P¬am‘”_S‘_T¿û_Ba£d
 * 
æow_·¿m
 = (IO_Flow_P¬am‘”_S‘_T¿û_Ba£d*)
·¿m‘”s
->
IO_Flow_Defš™iÚs
[
æow_id
];

66 
io_æow
 = 
Ãw
 
Ho¡_CompÚ’ts
::
	`IO_Flow_T¿û_Ba£d
(
this
->
	`ID
(è+ ".IO_Flow.T¿û." + 
æow_·¿m
->
Fe_P©h
, 
æow_id
,

67 
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
	`S¹_lha_avaabË_to_æow
(
æow_id
), Uts::Logiÿl_Add»ss_P¬t™iÚšg_Un™::
	`End_lha_avaabË_to_æow
(flow_id),

68 
	`FLOW_ID_TO_Q_ID
(
æow_id
), 
nvme_sq_size
, 
nvme_cq_size
,

69 
æow_·¿m
->
PriÜ™y_CÏss
, flow_·¿m->
In™Ÿl_Occu·ncy_P”ûÁage
 / (100.0),

70 
æow_·¿m
->
Fe_P©h
, flow_·¿m->
Time_Un™
, flow_·¿m->
R–ay_CouÁ
, flow_·¿m->
P”ûÁage_To_Be_Execu‹d
,

71 
ssd_ho¡_š‹rçû
->
	`G‘Ty³
(), 
this
->
PCIe_roÙ_com¶ex
,his->
SATA_hba
,

72 
·¿m‘”s
->
EÇbË_Re¥Ú£Time_Loggšg
,…¬am‘”s->
Re¥Ú£Time_Loggšg_P”iod_L’gth
,…¬am‘”s->
IÅut_fe_·th
 + ".IO_Flow.No_" + 
¡d
::
	`to_¡ršg
(
æow_id
) + ".log");

74 
this
->
IO_æows
.
	`push_back
(
io_æow
);

78 
throw
 "The specified IO flowype is‚ot supported.\n";

80 
SimuÏtÜ
->
	`AddObjeù
(
io_æow
);

82 
this
->
PCIe_roÙ_com¶ex
->
	`S‘_io_æows
(&this->
IO_æows
);

83 ià(((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_NVMe
*)
ssd_ho¡_š‹rçû
)->
	`G‘Ty³
(è=ğ
Ho¡IÁ”çû_Ty³s
::
SATA
) {

84 
this
->
SATA_hba
->
	`S‘_io_æows
(&this->
IO_æows
);

85 
this
->
SATA_hba
->
	`S‘_roÙ_com¶ex
Ñhis->
PCIe_roÙ_com¶ex
);

87 
	}
}

89 
	gHo¡_Sy¡em
::~
	$Ho¡_Sy¡em
()

91 
d–‘e
 
this
->
Lšk
;

92 
d–‘e
 
this
->
PCIe_roÙ_com¶ex
;

93 
d–‘e
 
this
->
PCIe_sw™ch
;

94 ià(
ssd_deviû
->
Ho¡_š‹rçû
->
	`G‘Ty³
(è=ğ
Ho¡IÁ”çû_Ty³s
::
SATA
) {

95 
d–‘e
 
this
->
SATA_hba
;

97 
ušt16_t
 
æow_id
 = 0; flow_id < 
this
->
IO_æows
.
	`size
(); flow_id++) {

98 
d–‘e
 
this
->
IO_æows
[
æow_id
];

100 
	}
}

102 
	gHo¡_Sy¡em
::
	$A‰ach_ssd_deviû
(
SSD_Deviû
* 
ssd_deviû
)

104 
ssd_deviû
->
	`A‰ach_to_ho¡
(
this
->
PCIe_sw™ch
);

105 
this
->
PCIe_sw™ch
->
	`A‰ach_ssd_deviû
(
ssd_deviû
->
Ho¡_š‹rçû
);

106 
this
->
ssd_deviû
 = ssd_device;

107 
	}
}

109 cÚ¡ 
	g¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*> 
Ho¡_Sy¡em
::
	$G‘_io_æows
()

111  
IO_æows
;

112 
	}
}

114 
	gHo¡_Sy¡em
::
	$S¹_simuÏtiÚ
()

116 
ssd_deviû
->
Ho¡_š‹rçû
->
	`G‘Ty³
()) {

117 
Ho¡IÁ”çû_Ty³s
::
NVME
:

118 
ušt16_t
 
æow_úŒ
 = 0; flow_úŒ < 
IO_æows
.
	`size
(); flow_cntr++) {

119 ((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_NVMe
*è
ssd_deviû
->
Ho¡_š‹rçû
)->
	`C»©e_Ãw_¡»am
(

120 
IO_æows
[
æow_úŒ
]->
	`PriÜ™y_şass
(),

121 
IO_æows
[
æow_úŒ
]->
	`G‘_¡¬t_l§_Ú_deviû
(), IO_æows[æow_úŒ]->
	`G‘_’d_l§_add»ss_Ú_deviû
(),

122 
IO_æows
[
æow_úŒ
]->
	`G‘_nvme_queue_·œ_šfo
()->
SubmissiÚ_queue_memÜy_ba£_add»ss
, IO_æows[æow_úŒ]->G‘_nvme_queue_·œ_šfo()->
Com¶‘iÚ_queue_memÜy_ba£_add»ss
);

125 
Ho¡IÁ”çû_Ty³s
::
SATA
:

126 ((
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_SATA
*è
ssd_deviû
->
Ho¡_š‹rçû
)->
	`S‘_ncq_add»ss
(

127 
SATA_hba
->
	`G‘_§_ncq_šfo
()->
SubmissiÚ_queue_memÜy_ba£_add»ss
, SATA_hba->G‘_§_ncq_šfo()->
Com¶‘iÚ_queue_memÜy_ba£_add»ss
);

132 ià(
´ecÚd™iÚšg_»quœed
) {

133 
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
 = 
	`g‘_wÜklßds_¡©i¡ics
();

134 
ssd_deviû
->
	`P”fÜm_´ecÚd™iÚšg
(
wÜklßd_¡©s
);

135 autØ&
¡©
 : 
wÜklßd_¡©s
) {

136 
d–‘e
 
¡©
;

139 
	}
}

141 
	gHo¡_Sy¡em
::
	$V®id©e_simuÏtiÚ_cÚfig
()

143 ià(
this
->
IO_æows
.
	`size
() == 0) {

144 
	`PRINT_ERROR
("No IO flow is set for host system")

146 ià(
this
->
PCIe_roÙ_com¶ex
 =ğ
NULL
) {

147 
	`PRINT_ERROR
("PCIe Root Complex is‚ot set for host system");

149 ià(
this
->
Lšk
 =ğ
NULL
) {

150 
	`PRINT_ERROR
("PCIe Link is‚ot set for host system");

152 ià(
this
->
PCIe_sw™ch
 =ğ
NULL
) {

153 
	`PRINT_ERROR
("PCIe Switch is‚ot set for host system")

155 ià(!
this
->
PCIe_sw™ch
->
	`Is_ssd_cÚÃùed
()) {

156 
	`PRINT_ERROR
("No SSD is connectedohe host system")

158 
	}
}

160 
	gHo¡_Sy¡em
::
	$Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

162 
	}
}

164 
Ho¡_Sy¡em
::
	$R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

166 
¡d
::
¡ršg
 
tmp
;

167 
tmp
 = 
	`ID
();

168 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

170 autØ&
æow
 : 
IO_æows
) {

171 
æow
->
	`R•Üt_»suÉs_š_XML
("Ho¡", 
xmlwr™”
);

174 
xmlwr™”
.
	`Wr™e_şo£_g
();

175 
	}
}

177 
	g¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
Ho¡_Sy¡em
::
	$g‘_wÜklßds_¡©i¡ics
()

179 
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
¡©s
;

181 autØ&
wÜklßd
 : 
IO_æows
) {

182 
Uts
::
WÜklßd_Sti¡ics
* 
s
 = 
Ãw
 Utils::Workload_Statistics;

183 
wÜklßd
->
	`G‘_¡©i¡ics
(*
s
, 
ssd_deviû
->
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
, ssd_deviû->
Fšd_NVM_subun™_acûss_b™m­
);

184 
¡©s
.
	`push_back
(
s
);

187  
¡©s
;

188 
	}
}

	@src/exec/Host_System.h

1 #iâdeà
HOST_SYSTEM_H


2 
	#HOST_SYSTEM_H


	)

4 
	~<veùÜ
>

5 
	~"../sim/Sim_Objeù.h
"

6 
	~"../sim/Sim_R•Ü‹r.h
"

7 
	~"../ho¡/PCIe_RoÙ_Com¶ex.h
"

8 
	~"../ho¡/PCIe_Lšk.h
"

9 
	~"../ho¡/PCIe_Sw™ch.h
"

10 
	~"../ho¡/PCIe_Mes§ge.h
"

11 
	~"../ho¡/IO_Flow_Ba£.h
"

12 
	~"../ho¡/Ho¡_IO_Reque¡.h
"

13 
	~"../ssd/Ho¡_IÁ”çû_Ba£.h
"

14 
	~"Ho¡_P¬am‘”_S‘.h
"

15 
	~"SSD_Deviû.h
"

16 
	~"../uts/WÜklßd_Sti¡ics.h
"

18 
şass
 
	gHo¡_Sy¡em
 : 
public
 
MQSimEngše
::
Sim_Objeù
,…ubliø
	gMQSimEngše
::
Sim_R•Ü‹r


20 
public
:

21 
Ho¡_Sy¡em
(
Ho¡_P¬am‘”_S‘
* 
·¿m‘”s
, 
boŞ
 
´ecÚd™iÚšg_»quœed
, 
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
* 
ssd_ho¡_š‹rçû
);

22 ~
Ho¡_Sy¡em
();

23 
S¹_simuÏtiÚ
();

24 
V®id©e_simuÏtiÚ_cÚfig
();

25 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
);

26 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

28 
A‰ach_ssd_deviû
(
SSD_Deviû
* 
ssd_deviû
);

29 cÚ¡ 
	g¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*> 
G‘_io_æows
();

30 
	g´iv©e
:

31 
Ho¡_CompÚ’ts
::
PCIe_RoÙ_Com¶ex
* 
PCIe_roÙ_com¶ex
;

32 
	gHo¡_CompÚ’ts
::
PCIe_Lšk
* 
Lšk
;

33 
	gHo¡_CompÚ’ts
::
PCIe_Sw™ch
* 
PCIe_sw™ch
;

34 
	gHo¡_CompÚ’ts
::
SATA_HBA
* 
SATA_hba
;

35 
	g¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*> 
IO_æows
;

36 
SSD_Deviû
* 
	gssd_deviû
;

37 
	g¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
g‘_wÜklßds_¡©i¡ics
();

38 
boŞ
 
	g´ecÚd™iÚšg_»quœed
;

	@src/exec/IO_Flow_Parameter_Set.cpp

1 
	~"IO_Flow_P¬am‘”_S‘.h
"

2 
	~<¡ršg
>

3 
	~<£t
>

4 
	~<c¡ršg
>

5 
	~<®gÜ™hm
>

8 
	gIO_Flow_P¬am‘”_S‘
::
	$XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
)

10 
¡d
::
¡ršg
 
©Œ
 = "Priority_Class";

11 
¡d
::
¡ršg
 
v®
;

12 
PriÜ™y_CÏss
) {

13 
IO_Flow_PriÜ™y_CÏss
::
URGENT
:

14 
v®
 = "URGENT";

16 
IO_Flow_PriÜ™y_CÏss
::
HIGH
:

17 
v®
 = "HIGH";

19 
IO_Flow_PriÜ™y_CÏss
::
MEDIUM
:

20 
v®
 = "MEDIUM";

22 
IO_Flow_PriÜ™y_CÏss
::
LOW
:

23 
v®
 = "LOW";

28 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

31 
©Œ
 = "Device_Level_Data_Caching_Mode";

32 
Deviû_Lev–_D©a_Cachšg_Mode
) {

33 
SSD_CompÚ’ts
::
Cachšg_Mode
::
TURNED_OFF
:

34 
v®
 = "TURNED_OFF";

36 
SSD_CompÚ’ts
::
Cachšg_Mode
::
READ_CACHE
:

37 
v®
 = "READ_CACHE";

39 
SSD_CompÚ’ts
::
Cachšg_Mode
::
WRITE_CACHE
:

40 
v®
 = "WRITE_CACHE";

42 
SSD_CompÚ’ts
::
Cachšg_Mode
::
WRITE_READ_CACHE
:

43 
v®
 = "WRITE_READ_CACHE";

46 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

48 
©Œ
 = "Channel_IDs";

49 
v®
 = "";

50 
i
 = 0; i < 
ChªÃl_No
; i++) {

51 ià(
i
 > 0) {

52 
v®
 += ",";

54 
v®
 +ğ
¡d
::
	`to_¡ršg
(
ChªÃl_IDs
[
i
]);

56 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

58 
©Œ
 = "Chip_IDs";

59 
v®
 = "";

60 
i
 = 0; i < 
Ch_No
; i++) {

61 ià(
i
 > 0) {

62 
v®
 += ",";

64 
v®
 +ğ
¡d
::
	`to_¡ršg
(
Ch_IDs
[
i
]);

66 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

68 
©Œ
 = "Die_IDs";

69 
v®
 = "";

70 
i
 = 0; i < 
D›_No
; i++) {

71 ià(
i
 > 0) {

72 
v®
 += ",";

74 
v®
 +ğ
¡d
::
	`to_¡ršg
(
D›_IDs
[
i
]);

76 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

78 
©Œ
 = "Plane_IDs";

79 
v®
 = "";

80 
i
 = 0; i < 
PÏÃ_No
; i++) {

81 ià(
i
 > 0) {

82 
v®
 += ",";

84 
v®
 +ğ
¡d
::
	`to_¡ršg
(
PÏÃ_IDs
[
i
]);

86 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

88 
©Œ
 = "Initial_Occupancy_Percentage";

89 
v®
 = 
¡d
::
	`to_¡ršg
(
In™Ÿl_Occu·ncy_P”ûÁage
);

90 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

91 
	}
}

93 
	gIO_Flow_P¬am‘”_S‘
::
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
)

95 
Œy
 {

96 autØ
·¿m
 = 
node
->
fœ¡_node
(); 
	g·¿m
;…¬am =…¬am->
Ãxt_siblšg
()) {

97 ià(
¡rcmp
(
·¿m
->
Çme
(), "Device_Level_Data_Caching_Mode") == 0) {

98 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

99 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

100 ià(
¡rcmp
(
v®
.
c_¡r
(), "TURNED_OFF") == 0) {

101 
Deviû_Lev–_D©a_Cachšg_Mode
 = 
SSD_CompÚ’ts
::
Cachšg_Mode
::
TURNED_OFF
;

102 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WRITE_CACHE") == 0) {

103 
Deviû_Lev–_D©a_Cachšg_Mode
 = 
SSD_CompÚ’ts
::
Cachšg_Mode
::
WRITE_CACHE
;

104 } ià(
¡rcmp
(
v®
.
c_¡r
(), "READ_CACHE") == 0) {

105 
Deviû_Lev–_D©a_Cachšg_Mode
 = 
SSD_CompÚ’ts
::
Cachšg_Mode
::
READ_CACHE
;

106 } ià(
¡rcmp
(
v®
.
c_¡r
(), "WRITE_READ_CACHE") == 0) {

107 
Deviû_Lev–_D©a_Cachšg_Mode
 = 
SSD_CompÚ’ts
::
Cachšg_Mode
::
WRITE_READ_CACHE
;

109 
PRINT_ERROR
("Wrong caching mode definition for input flow")

112 ià(
¡rcmp
(
·¿m
->
Çme
(), "Priority_Class") == 0)

114 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

115 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

116 ià(
¡rcmp
(
v®
.
c_¡r
(), "URGENT") == 0) {

117 
PriÜ™y_CÏss
 = 
IO_Flow_PriÜ™y_CÏss
::
URGENT
;

118 } ià(
¡rcmp
(
v®
.
c_¡r
(), "HIGH") == 0) {

119 
PriÜ™y_CÏss
 = 
IO_Flow_PriÜ™y_CÏss
::
HIGH
;

120 } ià(
¡rcmp
(
v®
.
c_¡r
(), "MEDIUM") == 0) {

121 
PriÜ™y_CÏss
 = 
IO_Flow_PriÜ™y_CÏss
::
MEDIUM
;

122 } ià(
¡rcmp
(
v®
.
c_¡r
(), "LOW") == 0) {

123 
PriÜ™y_CÏss
 = 
IO_Flow_PriÜ™y_CÏss
::
LOW
;

125 
PRINT_ERROR
("Wrong…riority class definition for input flow")

127 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Channel_IDs") == 0) {

128 
¡d
::
£t
<> 
ids
;

129 
	gtmp
[1000], *
	gtmp2
;

130 
¡ºıy
(
tmp
, 
·¿m
->
v®ue
(), 1000);

131 
	g¡d
::
¡ršg
 
id
 = 
¡¹ok
(
tmp
, ",");

133 
	g¡d
::
¡ršg
::
size_ty³
 
sz
;

134 
	gids
.
š£¹
(
¡d
::
¡oi
(
id
, &
sz
));

135 
	gtmp2
 = 
¡¹ok
(
NULL
, ",");

136 ià(
	gtmp2
 =ğ
NULL
) {

139 
	gid
 = 
tmp2
;

142 
	gChªÃl_No
 = ()
ids
.
size
();

143 
	gChªÃl_IDs
 = 
Ãw
 
æash_block_ID_ty³
[
ChªÃl_No
];

144 
	gi
 = 0;

145 autØ
	g™
 = 
ids
.
begš
(); iˆ!ğids.
’d
(); it++) {

146 
	gChªÃl_IDs
[
i
++] = *
™
;

148 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Chip_IDs") == 0) {

149 
¡d
::
£t
<> 
ids
;

150 
	gtmp
[1000], *
	gtmp2
;

151 
¡ºıy
(
tmp
, 
·¿m
->
v®ue
(), 1000);

152 
	g¡d
::
¡ršg
 
id
 = 
¡¹ok
(
tmp
, ",");

154 
	g¡d
::
¡ršg
::
size_ty³
 
sz
;

155 
	gids
.
š£¹
(
¡d
::
¡oi
(
id
, &
sz
));

156 
	gtmp2
 = 
¡¹ok
(
NULL
, ",");

157 ià(
	gtmp2
 =ğ
NULL
) {

160 
	gid
 = 
tmp2
;

163 
	gCh_No
 = ()
ids
.
size
();

164 
	gCh_IDs
 = 
Ãw
 
æash_block_ID_ty³
[
Ch_No
];

165 
	gi
 = 0;

166 autØ
	g™
 = 
ids
.
begš
(); iˆ!ğids.
’d
(); it++) {

167 
	gCh_IDs
[
i
++] = *
™
;

169 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Die_IDs") == 0) {

170 
¡d
::
£t
<> 
ids
;

171 
	gtmp
[1000], *
	gtmp2
;

172 
¡ºıy
(
tmp
, 
·¿m
->
v®ue
(), 1000);

173 
	g¡d
::
¡ršg
 
id
 = 
¡¹ok
(
tmp
, ",");

175 
	g¡d
::
¡ršg
::
size_ty³
 
sz
;

176 
	gids
.
š£¹
(
¡d
::
¡oi
(
id
, &
sz
));

177 
	gtmp2
 = 
¡¹ok
(
NULL
, ",");

178 ià(
	gtmp2
 =ğ
NULL
) {

181 
	gid
 = 
tmp2
;

184 
	gD›_No
 = ()
ids
.
size
();

185 
	gD›_IDs
 = 
Ãw
 
æash_block_ID_ty³
[
D›_No
];

186 
	gi
 = 0;

187 autØ
	g™
 = 
ids
.
begš
(); iˆ!ğids.
’d
(); it++) {

188 
	gD›_IDs
[
i
++] = *
™
;

190 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Plane_IDs") == 0) {

191 
¡d
::
£t
<> 
ids
;

192 
	gtmp
[1000], *
	gtmp2
;

193 
¡ºıy
(
tmp
, 
·¿m
->
v®ue
(), 1000);

194 
	g¡d
::
¡ršg
 
id
 = 
¡¹ok
(
tmp
, ",");

196 
	g¡d
::
¡ršg
::
size_ty³
 
sz
;

197 
	gids
.
š£¹
(
¡d
::
¡oi
(
id
, &
sz
));

198 
	gtmp2
 = 
¡¹ok
(
NULL
, ",");

199 ià(
	gtmp2
 =ğ
NULL
) {

202 
	gid
 = 
tmp2
;

205 
	gPÏÃ_No
 = ()
ids
.
size
();

206 
	gPÏÃ_IDs
 = 
Ãw
 
æash_block_ID_ty³
[
PÏÃ_No
];

207 
	gi
 = 0;

208 autØ
	g™
 = 
ids
.
begš
(); iˆ!ğids.
’d
(); it++) {

209 
	gPÏÃ_IDs
[
i
++] = *
™
;

211 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Initial_Occupancy_Percentage") == 0) {

212 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

213 
	gIn™Ÿl_Occu·ncy_P”ûÁage
 = 
¡d
::
¡oul
(
v®
);

216 } 
ÿtch
 (...) {

217 
PRINT_ERROR
("Error in IO_Flow_Parameter_Set!")

221 
	gIO_Flow_P¬am‘”_S‘_SyÁh‘ic
::
	$XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
)

223 
¡d
::
¡ršg
 
tmp
;

224 
tmp
 = "IO_Flow_Parameter_Set_Synthetic";

225 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

226 
IO_Flow_P¬am‘”_S‘
::
	`XML_£rŸlize
(
xmlwr™”
);

228 
¡d
::
¡ršg
 
©Œ
 = "Working_Set_Percentage";

229 
¡d
::
¡ršg
 
v®
 = std::
	`to_¡ršg
(
WÜkšg_S‘_P”ûÁage
);

230 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

232 
©Œ
 = "Synthetic_Generator_Type";

233 
SyÁh‘ic_G’”©Ü_Ty³
) {

234 
Uts
::
Reque¡_G’”©Ü_Ty³
::
BANDWIDTH
:

235 
v®
 = "BANDWIDTH";

237 
Uts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
:

238 
v®
 = "QUEUE_DEPTH";

241 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

243 
©Œ
 = "Read_Percentage";

244 
v®
 = 
¡d
::
	`to_¡ršg
(
R—d_P”ûÁage
);

245 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

248 
©Œ
 = "Address_Distribution";

249 
Add»ss_Di¡ributiÚ
) {

250 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

251 
v®
 = "STREAMING";

253 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

254 
v®
 = "RANDOM_HOTCOLD";

256 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

257 
v®
 = "RANDOM_UNIFORM";

260 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

263 
©Œ
 = "Percentage_of_Hot_Region";

264 
v®
 = 
¡d
::
	`to_¡ršg
(
P”ûÁage_of_HÙ_RegiÚ
);

265 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

267 
©Œ
 = "Generated_Aligned_Addresses";

268 
v®
 = (
G’”©ed_AligÃd_Add»s£s
 ? "true" : "false");

269 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

271 
©Œ
 = "Address_Alignment_Unit";

272 
v®
 = 
¡d
::
	`to_¡ršg
(
Add»ss_Alignm’t_Un™
);

273 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

275 
©Œ
 = "Request_Size_Distribution";

276 
Reque¡_Size_Di¡ributiÚ
) {

277 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
FIXED
:

278 
v®
 = "FIXED";

280 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
NORMAL
:

281 
v®
 = "NORMAL";

284 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

286 
©Œ
 = "Average_Request_Size";

287 
v®
 = 
¡d
::
	`to_¡ršg
(
Av”age_Reque¡_Size
);

288 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

291 
©Œ
 = "Variance_Request_Size";

292 
v®
 = 
¡d
::
	`to_¡ršg
(
V¬Ÿnû_Reque¡_Size
);

293 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

296 
©Œ
 = "Seed";

297 
v®
 = 
¡d
::
	`to_¡ršg
(
S“d
);

298 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

301 
©Œ
 = "Average_No_of_Reqs_in_Queue";

302 
v®
 = 
¡d
::
	`to_¡ršg
(
Av”age_No_of_Reqs_š_Queue
);

303 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

306 
©Œ
 = "Bandwidth";

307 
v®
 = 
¡d
::
	`to_¡ršg
(
Bªdwidth
);

308 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

311 
©Œ
 = "Stop_Time";

312 
v®
 = 
¡d
::
	`to_¡ršg
(
Stİ_Time
);

313 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

316 
©Œ
 = "Total_Requests_To_Generate";

317 
v®
 = 
¡d
::
	`to_¡ršg
(
TÙ®_Reque¡s_To_G’”©e
);

318 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

320 
xmlwr™”
.
	`Wr™e_şo£_g
();

321 
	}
}

323 
	gIO_Flow_P¬am‘”_S‘_SyÁh‘ic
::
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
)

325 
IO_Flow_P¬am‘”_S‘
::
XML_de£rŸlize
(
node
);

326 
	gŒy
 {

327 autØ
	g·¿m
 = 
node
->
fœ¡_node
();…¬am;…¬am = 
·¿m
->
Ãxt_siblšg
()) {

328 ià(
¡rcmp
(
·¿m
->
Çme
(), "Working_Set_Percentage") == 0) {

329 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

330 
	gWÜkšg_S‘_P”ûÁage
 = 
¡d
::
¡oi
(
v®
);

331 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Synthetic_Generator_Type") == 0) {

332 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

333 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

334 ià(
¡rcmp
(
v®
.
c_¡r
(), "BANDWIDTH") == 0) {

335 
SyÁh‘ic_G’”©Ü_Ty³
 = 
Uts
::
Reque¡_G’”©Ü_Ty³
::
BANDWIDTH
;

336 } ià(
¡rcmp
(
v®
.
c_¡r
(), "QUEUE_DEPTH") == 0) {

337 
SyÁh‘ic_G’”©Ü_Ty³
 = 
Uts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
;

339 
PRINT_ERROR
("Unknown synthetic generatorype specified inhe input file")

341 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Read_Percentage") == 0) {

342 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

343 
	gR—d_P”ûÁage
 = 
¡d
::
¡oi
(
v®
);

344 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Address_Distribution") == 0) {

345 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

346 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

347 ià(
¡rcmp
(
v®
.
c_¡r
(), "STREAMING") == 0) {

348 
Add»ss_Di¡ributiÚ
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
;

349 } ià(
¡rcmp
(
v®
.
c_¡r
(), "RANDOM_HOTCOLD") == 0) {

350 
Add»ss_Di¡ributiÚ
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
;

351 } ià(
¡rcmp
(
v®
.
c_¡r
(), "RANDOM_UNIFORM") == 0) {

352 
Add»ss_Di¡ributiÚ
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
;

354 
PRINT_ERROR
("Wrong‡ddress distributionype for input synthetic flow")

356 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Percentage_of_Hot_Region") == 0) {

357 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

358 
	gP”ûÁage_of_HÙ_RegiÚ
 = 
¡d
::
¡oi
(
v®
);

359 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Generated_Aligned_Addresses") == 0) {

360 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

361 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

362 
	gG’”©ed_AligÃd_Add»s£s
 = (
v®
.
com·»
("FALSE"è=ğ0 ? 
çl£
 : 
Œue
);

363 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Address_Alignment_Unit") == 0) {

364 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

365 
	gAdd»ss_Alignm’t_Un™
 = 
¡d
::
¡oi
(
v®
);

366 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Request_Size_Distribution") == 0) {

367 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

368 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

369 ià(
¡rcmp
(
v®
.
c_¡r
(), "FIXED") == 0) {

370 
Reque¡_Size_Di¡ributiÚ
 = 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
FIXED
;

371 } ià(
¡rcmp
(
v®
.
c_¡r
(), "NORMAL") == 0) {

372 
Reque¡_Size_Di¡ributiÚ
 = 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
NORMAL
;

374 
PRINT_ERROR
("Wrong„equest size distributionype for input synthetic flow")

376 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Average_Request_Size") == 0) {

377 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

378 
	gAv”age_Reque¡_Size
 = 
¡d
::
¡oi
(
v®
);

379 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Variance_Request_Size") == 0) {

380 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

381 
	gV¬Ÿnû_Reque¡_Size
 = 
¡d
::
¡oi
(
v®
);

382 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Seed") == 0) {

383 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

384 
	gS“d
 = 
¡d
::
¡oi
(
v®
);

385 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Average_No_of_Reqs_in_Queue") == 0) {

386 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

387 
	gAv”age_No_of_Reqs_š_Queue
 = 
¡d
::
¡oi
(
v®
);

388 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Bandwidth") == 0) {

389 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

390 
	gBªdwidth
 = 
¡d
::
¡oi
(
v®
);

391 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Stop_Time") == 0) {

392 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

393 
	gStİ_Time
 = 
¡d
::
¡Şl
(
v®
);

394 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Total_Requests_To_Generate") == 0) {

395 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

396 
	gTÙ®_Reque¡s_To_G’”©e
 = 
¡d
::
¡oi
(
v®
);

399 } 
ÿtch
 (...) {

400 
PRINT_ERROR
("Error in IO_Flow_Parameter_Set_Synthetic!")

404 
	gIO_Flow_P¬am‘”_S‘_T¿û_Ba£d
::
	$XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
)

407 
¡d
::
¡ršg
 
tmp
 = "IO_Flow_Parameter_Set_Trace_Based";

408 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

409 
IO_Flow_P¬am‘”_S‘
::
	`XML_£rŸlize
(
xmlwr™”
);

411 
¡d
::
¡ršg
 
©Œ
 = "File_Path";

412 
¡d
::
¡ršg
 
v®
 = 
Fe_P©h
;

413 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

415 
©Œ
 = "Percentage_To_Be_Executed";

416 
v®
 = 
¡d
::
	`to_¡ršg
(
P”ûÁage_To_Be_Execu‹d
);

417 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

419 
©Œ
 = "Relay_Count";

420 
v®
 = 
¡d
::
	`to_¡ršg
(
R–ay_CouÁ
);

421 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

423 
©Œ
 = "Time_Unit";

424 
Time_Un™
) {

425 
T¿û_Time_Un™
::
PICOSECOND
:

426 
v®
 = "PICOSECOND";

428 
T¿û_Time_Un™
::
NANOSECOND
:

429 
v®
 = "NANOSECOND";

431 
T¿û_Time_Un™
::
MICROSECOND
:

432 
v®
 = "MICROSECOND";

435 
xmlwr™”
.
	`Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

437 
xmlwr™”
.
	`Wr™e_şo£_g
();

438 
	}
}

440 
	gIO_Flow_P¬am‘”_S‘_T¿û_Ba£d
::
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
)

442 
IO_Flow_P¬am‘”_S‘
::
XML_de£rŸlize
(
node
);

444 
	gŒy
 {

445 autØ
	g·¿m
 = 
node
->
fœ¡_node
();…¬am;…¬am = 
·¿m
->
Ãxt_siblšg
()) {

446 ià(
¡rcmp
(
·¿m
->
Çme
(), "Relay_Count") == 0) {

447 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

448 
	gR–ay_CouÁ
 = 
¡d
::
¡oi
(
v®
);

449 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Percentage_To_Be_Executed") == 0) {

450 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

451 
	gP”ûÁage_To_Be_Execu‹d
 = 
¡d
::
¡oi
(
v®
);

452 } ià(
¡rcmp
(
·¿m
->
Çme
(), "File_Path") == 0) {

453 
Fe_P©h
 = 
·¿m
->
v®ue
();

454 } ià(
¡rcmp
(
·¿m
->
Çme
(), "Time_Unit") == 0) {

455 
¡d
::
¡ršg
 
v®
 = 
·¿m
->
v®ue
();

456 
	g¡d
::
ŒªsfÜm
(
v®
.
begš
(), v®.
’d
(), v®.begš(), ::
touµ”
);

457 ià(
¡rcmp
(
v®
.
c_¡r
(), "PICOSECOND") == 0) {

458 
Time_Un™
 = 
T¿û_Time_Un™
::
PICOSECOND
;

459 } ià(
¡rcmp
(
v®
.
c_¡r
(), "NANOSECOND") == 0) {

460 
Time_Un™
 = 
T¿û_Time_Un™
::
NANOSECOND
;

461 } ià(
¡rcmp
(
v®
.
c_¡r
(), "MICROSECOND") == 0) {

462 
Time_Un™
 = 
T¿û_Time_Un™
::
MICROSECOND
;

464 
PRINT_ERROR
("Wrongime unit specified forherace based flow")

469 } 
ÿtch
 (...) {

470 
PRINT_ERROR
("Error in IO_Flow_Parameter_Set_Trace_Based!")

	@src/exec/IO_Flow_Parameter_Set.h

1 #iâdeà
IO_FLOW_PARAMETER_SET_H


2 
	#IO_FLOW_PARAMETER_SET_H


	)

4 
	~<¡ršg
>

5 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

6 
	~"../ssd/Ho¡_IÁ”çû_Defs.h
"

7 
	~"../ho¡/IO_Flow_SyÁh‘ic.h
"

8 
	~"../ho¡/IO_Flow_T¿û_Ba£d.h
"

9 
	~"../uts/WÜklßd_Sti¡ics.h
"

10 
	~"../uts/Di¡ributiÚTy³s.h
"

11 
	~"P¬am‘”_S‘_Ba£.h
"

13 şas 
	cFlow_Ty³
 { 
	mSYNTHETIC
, 
	mTRACE
 };

14 şas 
	cIO_Flow_P¬am‘”_S‘
 : 
public
 
P¬am‘”_S‘_Ba£


16 
public
:

17 
SSD_CompÚ’ts
::
Cachšg_Mode
 
Deviû_Lev–_D©a_Cachšg_Mode
;

18 
Flow_Ty³
 
	mTy³
;

19 
IO_Flow_PriÜ™y_CÏss
 
	mPriÜ™y_CÏss
;

20 
æash_chªÃl_ID_ty³
* 
	mChªÃl_IDs
;

21 
æash_ch_ID_ty³
* 
	mCh_IDs
;

22 
æash_d›_ID_ty³
* 
	mD›_IDs
;

23 
æash_¶ªe_ID_ty³
* 
	mPÏÃ_IDs
;

24 
	mIn™Ÿl_Occu·ncy_P”ûÁage
;

25 
	mChªÃl_No
, 
	mCh_No
, 
	mD›_No
, 
	mPÏÃ_No
;

26 
XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™e
);

27 
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
);

28 
	m´iv©e
:

31 şas 
	cIO_Flow_P¬am‘”_S‘_SyÁh‘ic
 : 
public
 
IO_Flow_P¬am‘”_S‘


33 
public
:

34 
	$IO_Flow_P¬am‘”_S‘_SyÁh‘ic
(è{ 
this
->
Ty³
 = 
Flow_Ty³
::
SYNTHETIC
; }

35 
WÜkšg_S‘_P”ûÁage
;

36 
Uts
::
Reque¡_G’”©Ü_Ty³
 
SyÁh‘ic_G’”©Ü_Ty³
;

37 
R—d_P”ûÁage
;

38 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
 
Add»ss_Di¡ributiÚ
;

39 
P”ûÁage_of_HÙ_RegiÚ
;

40 
boŞ
 
G’”©ed_AligÃd_Add»s£s
;

41 
Add»ss_Alignm’t_Un™
;

42 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
 
Reque¡_Size_Di¡ributiÚ
;

43 
Av”age_Reque¡_Size
;

44 
V¬Ÿnû_Reque¡_Size
;

46 
S“d
;

47 
Av”age_No_of_Reqs_š_Queue
;

48 
Bªdwidth
;

50 
sim_time_ty³
 
Stİ_Time
;

51 
TÙ®_Reque¡s_To_G’”©e
;

53 
	`XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
);

54 
	`XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
);

55 
	}
};

57 şas 
	cIO_Flow_P¬am‘”_S‘_T¿û_Ba£d
 : 
public
 
IO_Flow_P¬am‘”_S‘


59 
public
:

60 
	$IO_Flow_P¬am‘”_S‘_T¿û_Ba£d
(è{ 
this
->
Ty³
 = 
Flow_Ty³
::
TRACE
; }

61 
¡d
::
¡ršg
 
Fe_P©h
;

62 
P”ûÁage_To_Be_Execu‹d
;

63 
R–ay_CouÁ
;

64 
T¿û_Time_Un™
 
Time_Un™
;

66 
	`XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
);

67 
	`XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
);

68 
	}
};

	@src/exec/Parameter_Set_Base.h

1 #iâdeà
PARAMETER_SET_BASE_H


2 
	#PARAMETER_SET_BASE_H


	)

4 
	~"../uts/¿pidxml/¿pidxml.hµ
"

5 
	~"../uts/XMLWr™”.h
"

7 şas 
	cP¬am‘”_S‘_Ba£


9 
	mpublic
:

10 
vœtu®
 
XML_£rŸlize
(
Uts
::
XmlWr™”
& 
xmlwr™”
) = 0;

11 
vœtu®
 
XML_de£rŸlize
(
¿pidxml
::
xml_node
<> *
node
) = 0;

	@src/exec/SSD_Device.cpp

1 
	~<veùÜ
>

2 
	~<¡dexû±
>

3 
	~<ùime
>

4 
	~"SSD_Deviû.h
"

5 
	~"../ssd/ONFI_ChªÃl_Ba£.h
"

6 
	~"../ssd/FÏsh_Block_Mªag”.h
"

7 
	~"../ssd/D©a_Cache_Mªag”_FÏsh_Advªûd.h
"

8 
	~"../ssd/D©a_Cache_Mªag”_FÏsh_Sim¶e.h
"

9 
	~"../ssd/Add»ss_M­pšg_Un™_Ba£.h
"

10 
	~"../ssd/Add»ss_M­pšg_Un™_Page_Lev–.h
"

11 
	~"../ssd/Add»ss_M­pšg_Un™_Hybrid.h
"

12 
	~"../ssd/GC_ªd_WL_Un™_Page_Lev–.h
"

13 
	~"../ssd/TSU_OutofOrd”.h
"

14 
	~"../ssd/TSU_FLIN.h
"

15 
	~"../ssd/ONFI_ChªÃl_NVDDR2.h
"

16 
	~"../ssd/NVM_PHY_ONFI_NVDDR2.h
"

17 
	~"../uts/Logiÿl_Add»ss_P¬t™iÚšg_Un™.h
"

19 
SSD_Deviû
 * 
	gSSD_Deviû
::
my_š¡ªû
;

21 
	gSSD_Deviû
::
SSD_Deviû
(
Deviû_P¬am‘”_S‘
* 
·¿m‘”s
, 
¡d
::
veùÜ
<
IO_Flow_P¬am‘”_S‘
*>* 
io_æows
) :

22 
MQSimEngše
::
Sim_Objeù
("SSDDevice")

24 
SSD_Deviû
* 
deviû
 = 
this
;

25 
	gmy_š¡ªû
 = 
deviû
;

26 
	gSimuÏtÜ
->
AddObjeù
(
deviû
);

28 
	gdeviû
->
	gP»cÚd™iÚšg_»quœed
 = 
·¿m‘”s
->
EÇbËd_P»cÚd™iÚšg
;

29 
	gdeviû
->
	gMemÜy_Ty³
 = 
·¿m‘”s
->
MemÜy_Ty³
;

31 
	gMemÜy_Ty³
) {

32 
	gNVM
::
NVM_Ty³
::
FLASH
: {

33 
sim_time_ty³
 * 
»ad_Ï‹nc›s
, *
	gwr™e_Ï‹nc›s
;

34 
sim_time_ty³
 
	gav”age_æash_»ad_Ï‹ncy
 = 0, 
	gav”age_æash_wr™e_Ï‹ncy
 = 0;

37 
	g·¿m‘”s
->
	gFÏsh_P¬am‘”s
.
	gFÏsh_TechnŞogy
) {

38 
	gFÏsh_TechnŞogy_Ty³
::
SLC
:

39 
»ad_Ï‹nc›s
 = 
Ãw
 
sim_time_ty³
[1];

40 
	g»ad_Ï‹nc›s
[0] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_R—d_L©’cy_LSB
;

41 
	gwr™e_Ï‹nc›s
 = 
Ãw
 
sim_time_ty³
[1];

42 
	gwr™e_Ï‹nc›s
[0] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_Prog¿m_L©’cy_LSB
;

43 
	gav”age_æash_»ad_Ï‹ncy
 = 
»ad_Ï‹nc›s
[0];

44 
	gav”age_æash_wr™e_Ï‹ncy
 = 
wr™e_Ï‹nc›s
[0];

46 
	gFÏsh_TechnŞogy_Ty³
::
MLC
:

47 
»ad_Ï‹nc›s
 = 
Ãw
 
sim_time_ty³
[2];

48 
	g»ad_Ï‹nc›s
[0] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_R—d_L©’cy_LSB
;

49 
	g»ad_Ï‹nc›s
[1] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_R—d_L©’cy_MSB
;

50 
	gwr™e_Ï‹nc›s
 = 
Ãw
 
sim_time_ty³
[2];

51 
	gwr™e_Ï‹nc›s
[0] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_Prog¿m_L©’cy_LSB
;

52 
	gwr™e_Ï‹nc›s
[1] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_Prog¿m_L©’cy_MSB
;

53 
	gav”age_æash_»ad_Ï‹ncy
 = (
»ad_Ï‹nc›s
[0] +„ead_latencies[1]) / 2;

54 
	gav”age_æash_wr™e_Ï‹ncy
 = (
wr™e_Ï‹nc›s
[0] + write_latencies[1]) / 2;

56 
	gFÏsh_TechnŞogy_Ty³
::
TLC
:

57 
»ad_Ï‹nc›s
 = 
Ãw
 
sim_time_ty³
[3];

58 
	g»ad_Ï‹nc›s
[0] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_R—d_L©’cy_LSB
;

59 
	g»ad_Ï‹nc›s
[1] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_R—d_L©’cy_CSB
;

60 
	g»ad_Ï‹nc›s
[2] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_R—d_L©’cy_MSB
;

61 
	gwr™e_Ï‹nc›s
 = 
Ãw
 
sim_time_ty³
[3];

62 
	gwr™e_Ï‹nc›s
[0] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_Prog¿m_L©’cy_LSB
;

63 
	gwr™e_Ï‹nc›s
[1] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_Prog¿m_L©’cy_CSB
;

64 
	gwr™e_Ï‹nc›s
[2] = 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_Prog¿m_L©’cy_MSB
;

65 
	gav”age_æash_»ad_Ï‹ncy
 = (
»ad_Ï‹nc›s
[0] +„ead_latencies[1] +„ead_latencies[2]) / 3;

66 
	gav”age_æash_wr™e_Ï‹ncy
 = (
wr™e_Ï‹nc›s
[0] + write_latencies[1] + write_latencies[2]) / 3;

69 
throw
 
¡d
::
šv®id_¬gum’t
("The specified flashechnologies is‚ot supported");

73 
	gthis
->
	gChªÃl_couÁ
 = 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
;

74 
	gthis
->
	gCh_no_³r_chªÃl
 = 
·¿m‘”s
->
Ch_No_P”_ChªÃl
;

75 
	g·¿m‘”s
->
	gFÏsh_Comm_PrÙocŞ
) {

76 
	gSSD_CompÚ’ts
::
ONFI_PrÙocŞ
::
NVDDR2
: {

77 
SSD_CompÚ’ts
::
ONFI_ChªÃl_NVDDR2
** 
chªÃls
 = 
Ãw
 SSD_CompÚ’ts::ONFI_ChªÃl_NVDDR2*[
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
];

78 
	gchªÃl_úŒ
 = 0; chªÃl_úŒ < 
	g·¿m‘”s
->
	gFÏsh_ChªÃl_CouÁ
; channel_cntr++) {

79 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
** 
chs
 = 
Ãw
 
NVM
::FÏshMemÜy::FÏsh_Ch*[
·¿m‘”s
->
Ch_No_P”_ChªÃl
];

80 
	gch_úŒ
 = 0; ch_úŒ < 
	g·¿m‘”s
->
	gCh_No_P”_ChªÃl
; chip_cntr++) {

81 
	gchs
[
ch_úŒ
] = 
Ãw
 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
(
deviû
->
ID
(è+ ".ChªÃl." + 
¡d
::
to_¡ršg
(
chªÃl_úŒ
) + ".Chip." + std::to_string(chip_cntr),

82 
chªÃl_úŒ
, 
ch_úŒ
, 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
FÏsh_TechnŞogy
,…¬am‘”s->FÏsh_P¬am‘”s.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,

83 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_No_P”_PÏÃ
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_No_P”_Block
,

84 
»ad_Ï‹nc›s
, 
wr™e_Ï‹nc›s
, 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_E¿£_L©’cy
,

85 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Su¥’d_Prog¿m_Time
,…¬am‘”s->FÏsh_P¬am‘”s.
Su¥’d_E¿£_Time
);

86 
	gSimuÏtÜ
->
AddObjeù
(
chs
[
ch_úŒ
]);

88 
	gchªÃls
[
chªÃl_úŒ
] = 
Ãw
 
SSD_CompÚ’ts
::
ONFI_ChªÃl_NVDDR2
(chªÃl_úŒ, 
·¿m‘”s
->
Ch_No_P”_ChªÃl
,

89 
chs
, 
·¿m‘”s
->
FÏsh_ChªÃl_Width
,

90 (
sim_time_ty³
)(()1000 / 
·¿m‘”s
->
ChªÃl_T¿nsãr_R©e
) * 2, (sim_time_type)(()1000 /…arameters->Channel_Transfer_Rate) * 2);

91 
	gdeviû
->
	gChªÃls
.
push_back
(
chªÃls
[
chªÃl_úŒ
]);

95 
	gdeviû
->
	gPHY
 = 
Ãw
 
SSD_CompÚ’ts
::
NVM_PHY_ONFI_NVDDR2
(
deviû
->
ID
(è+ ".PHY", 
chªÃls
, 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,

96 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
);

97 
	gSimuÏtÜ
->
AddObjeù
(
deviû
->
PHY
);

101 
throw
 
¡d
::
šv®id_¬gum’t
("No implementation is‡vailable forhe specified flash communication…rotocol");

103 
	gd–‘e
[] 
	g»ad_Ï‹nc›s
;

104 
	gd–‘e
[] 
	gwr™e_Ï‹nc›s
;

107 
	gSSD_CompÚ’ts
::
FTL
* 
ál
 = 
Ãw
 
SSD_CompÚ’ts
::FTL(
deviû
->
ID
(è+ ".FTL", 
NULL
, 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,

108 
·¿m‘”s
->
Ch_No_P”_ChªÃl
,…¬am‘”s->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,

109 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_No_P”_PÏÃ
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_No_P”_Block
,

110 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
, 
av”age_æash_»ad_Ï‹ncy
, 
av”age_æash_wr™e_Ï‹ncy
,…¬am‘”s->
Ov”´ovisiÚšg_R©io
,

111 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_PE_Cyşes_Lim™
,…¬am‘”s->
S“d
++);

112 
	gál
->
	gPHY
 = (
SSD_CompÚ’ts
::
NVM_PHY_ONFI
*)
PHY
;

113 
	gSimuÏtÜ
->
AddObjeù
(
ál
);

114 
	gdeviû
->
	gFœmw¬e
 = 
ál
;

115 ((
	gSSD_CompÚ’ts
::
NVM_PHY_ONFI_NVDDR2
*)(
deviû
->
PHY
))->
ál
=ftl;

117 
	gSSD_CompÚ’ts
::
TSU_Ba£
* 
tsu
;

118 
boŞ
 
	g”a£_su¥’siÚ
 = 
çl£
, 
	g´og¿m_su¥’siÚ
 = false;

119 ià(
	g·¿m‘”s
->
	gFÏsh_P¬am‘”s
.
	gCMD_Su¥’siÚ_SuµÜt
 =ğ
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
PROGRAM
) {

120 
´og¿m_su¥’siÚ
 = 
Œue
;

122 ià(
	g·¿m‘”s
->
	gFÏsh_P¬am‘”s
.
	gCMD_Su¥’siÚ_SuµÜt
 =ğ
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
ERASE
) {

123 
”a£_su¥’siÚ
 = 
Œue
;

125 ià(
	g·¿m‘”s
->
	gFÏsh_P¬am‘”s
.
	gCMD_Su¥’siÚ_SuµÜt
 =ğ
NVM
::
FÏshMemÜy
::
Commªd_Su¥’siÚ_Mode
::
PROGRAM_ERASE
) {

126 
´og¿m_su¥’siÚ
 = 
Œue
;

127 
	g”a£_su¥’siÚ
 = 
Œue
;

129 
	g·¿m‘”s
->
	gT¿n§ùiÚ_Schedulšg_PŞicy
) {

130 
	gSSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
::
OUT_OF_ORDER
:

131 
tsu
 = 
Ãw
 
SSD_CompÚ’ts
::
TSU_OutOfOrd”
(
ál
->
ID
(è+ ".TSU", f, 
¡©ic_ÿ¡
<SSD_CompÚ’ts::
NVM_PHY_ONFI_NVDDR2
*>(
deviû
->
PHY
),

132 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,

133 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,

134 
·¿m‘”s
->
P»ã¼ed_su¥’d_wr™e_time_fÜ_»ad
,…¬am‘”s->
P»ã¼ed_su¥’d_”a£_time_fÜ_»ad
,…¬am‘”s->
P»ã¼ed_su¥’d_”a£_time_fÜ_wr™e
,

135 
”a£_su¥’siÚ
, 
´og¿m_su¥’siÚ
);

137 
	gSSD_CompÚ’ts
::
FÏsh_Schedulšg_Ty³
::
FLIN
:

139 * 
¡»am_couÁ_³r_´iÜ™y_şass
 = 
Ãw
 [4];

140 
	gi
 = 0; i < 4; i++)

141 
	g¡»am_couÁ_³r_´iÜ™y_şass
[
i
] = 0;

142 autØ&
	gæow
 : (*
io_æows
))

143 
¡»am_couÁ_³r_´iÜ™y_şass
[()
æow
->
PriÜ™y_CÏss
]++;

144 
¡»am_id_ty³
** 
	g¡»am_ids_³r_´iÜ™y_şass
 = 
Ãw
 stream_id_type*[4];

145 
	gi
 = 0; i < 4; i++)

146 
	g¡»am_ids_³r_´iÜ™y_şass
[
i
] = 
Ãw
 
¡»am_id_ty³
[
¡»am_couÁ_³r_´iÜ™y_şass
[i]];

148 
	gtsu
 = 
Ãw
 
SSD_CompÚ’ts
::
TSU_FLIN
(
ál
->
ID
(è+ ".TSU", f, 
¡©ic_ÿ¡
<SSD_CompÚ’ts::
NVM_PHY_ONFI_NVDDR2
*>(
deviû
->
PHY
),

149 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,

150 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_C­ac™y
,

151 10000000, 33554432, 262144, 4, ()
io_æows
->
size
(), 
¡»am_couÁ_³r_´iÜ™y_şass
, 
¡»am_ids_³r_´iÜ™y_şass
,

153 
·¿m‘”s
->
P»ã¼ed_su¥’d_wr™e_time_fÜ_»ad
,…¬am‘”s->
P»ã¼ed_su¥’d_”a£_time_fÜ_»ad
,…¬am‘”s->
P»ã¼ed_su¥’d_”a£_time_fÜ_wr™e
,

154 
”a£_su¥’siÚ
, 
´og¿m_su¥’siÚ
);

158 
throw
 
¡d
::
šv®id_¬gum’t
("No implementation is‡vailable forhe specifiedransaction scheduling‡lgorithm");

160 
	gSimuÏtÜ
->
AddObjeù
(
tsu
);

161 
	gál
->
	gTSU
 = 
tsu
;

164 
	gSSD_CompÚ’ts
::
FÏsh_Block_Mªag”_Ba£
* 
fbm
;

165 
	gfbm
 = 
Ãw
 
SSD_CompÚ’ts
::
FÏsh_Block_Mªag”
(
NULL
, 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_PE_Cyşes_Lim™
,

166 ()
io_æows
->
size
(), 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,

167 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,

168 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_No_P”_PÏÃ
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_No_P”_Block
);

169 
	gál
->
	gBlockMªag”
 = 
fbm
;

172 
	gSSD_CompÚ’ts
::
Add»ss_M­pšg_Un™_Ba£
* 
amu
;

173 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_chªÃl_ID_ty³
>> 
æow_chªÃl_id_assignm’ts
;

174 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_ch_ID_ty³
>> 
æow_ch_id_assignm’ts
;

175 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_d›_ID_ty³
>> 
æow_d›_id_assignm’ts
;

176 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_¶ªe_ID_ty³
>> 
æow_¶ªe_id_assignm’ts
;

177 
	g¡»am_couÁ
 = 0;

178 
	gi
 = 0; i < 
	gio_æows
->
size
(); i++) {

179 
	g·¿m‘”s
->
	gHo¡IÁ”çû_Ty³
) {

180 
	gHo¡IÁ”çû_Ty³s
::
SATA
: {

181 
¡»am_couÁ
 = 1;

182 
	g¡d
::
veùÜ
<
æash_chªÃl_ID_ty³
> 
chªÃl_ids
;

183 
	gæow_chªÃl_id_assignm’ts
.
push_back
(
chªÃl_ids
);

184 
	gj
 = 0; j < 
	g·¿m‘”s
->
	gFÏsh_ChªÃl_CouÁ
; j++) {

185 
	gæow_chªÃl_id_assignm’ts
[
i
].
push_back
(
j
);

187 
	g¡d
::
veùÜ
<
æash_ch_ID_ty³
> 
ch_ids
;

188 
	gæow_ch_id_assignm’ts
.
push_back
(
ch_ids
);

189 
	gj
 = 0; j < 
	g·¿m‘”s
->
	gCh_No_P”_ChªÃl
; j++) {

190 
	gæow_ch_id_assignm’ts
[
i
].
push_back
(
j
);

192 
	g¡d
::
veùÜ
<
æash_d›_ID_ty³
> 
d›_ids
;

193 
	gæow_d›_id_assignm’ts
.
push_back
(
d›_ids
);

194 
	gj
 = 0; j < 
	g·¿m‘”s
->
	gFÏsh_P¬am‘”s
.
	gD›_No_P”_Ch
; j++) {

195 
	gæow_d›_id_assignm’ts
[
i
].
push_back
(
j
);

197 
	g¡d
::
veùÜ
<
æash_¶ªe_ID_ty³
> 
¶ªe_ids
;

198 
	gæow_¶ªe_id_assignm’ts
.
push_back
(
¶ªe_ids
);

199 
	gj
 = 0; j < 
	g·¿m‘”s
->
	gFÏsh_P¬am‘”s
.
	gPÏÃ_No_P”_D›
; j++) {

200 
	gæow_¶ªe_id_assignm’ts
[
i
].
push_back
(
j
);

204 
	gHo¡IÁ”çû_Ty³s
::
NVME
: {

205 
¡»am_couÁ
 = ()
io_æows
->
size
();

206 
	g¡d
::
veùÜ
<
æash_chªÃl_ID_ty³
> 
chªÃl_ids
;

207 
	gæow_chªÃl_id_assignm’ts
.
push_back
(
chªÃl_ids
);

208 
	gj
 = 0; j < (*
	gio_æows
)[
i
]->
	gChªÃl_No
; j++) {

209 
	gæow_chªÃl_id_assignm’ts
[
i
].
push_back
((*
io_æows
)[i]->
ChªÃl_IDs
[
j
]);

211 
	g¡d
::
veùÜ
<
æash_ch_ID_ty³
> 
ch_ids
;

212 
	gæow_ch_id_assignm’ts
.
push_back
(
ch_ids
);

213 
	gj
 = 0; j < (*
	gio_æows
)[
i
]->
	gCh_No
; j++) {

214 
	gæow_ch_id_assignm’ts
[
i
].
push_back
((*
io_æows
)[i]->
Ch_IDs
[
j
]);

216 
	g¡d
::
veùÜ
<
æash_d›_ID_ty³
> 
d›_ids
;

217 
	gæow_d›_id_assignm’ts
.
push_back
(
d›_ids
);

218 
	gj
 = 0; j < (*
	gio_æows
)[
i
]->
	gD›_No
; j++) {

219 
	gæow_d›_id_assignm’ts
[
i
].
push_back
((*
io_æows
)[i]->
D›_IDs
[
j
]);

221 
	g¡d
::
veùÜ
<
æash_¶ªe_ID_ty³
> 
¶ªe_ids
;

222 
	gæow_¶ªe_id_assignm’ts
.
push_back
(
¶ªe_ids
);

223 
	gj
 = 0; j < (*
	gio_æows
)[
i
]->
	gPÏÃ_No
; j++) {

224 
	gæow_¶ªe_id_assignm’ts
[
i
].
push_back
((*
io_æows
)[i]->
PÏÃ_IDs
[
j
]);

233 
	gUts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
AÎoÿ‹_logiÿl_add»ss_fÜ_æows
(
·¿m‘”s
->
Ho¡IÁ”çû_Ty³
, ()
io_æows
->
size
(),

234 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,…¬am‘”s->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,

235 
æow_chªÃl_id_assignm’ts
, 
æow_ch_id_assignm’ts
, 
æow_d›_id_assignm’ts
, 
æow_¶ªe_id_assignm’ts
,

236 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_No_P”_PÏÃ
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_No_P”_Block
,

237 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
,…¬am‘”s->
Ov”´ovisiÚšg_R©io
);

238 
	g·¿m‘”s
->
	gAdd»ss_M­pšg
) {

239 
	gSSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
::
PAGE_LEVEL
:

240 
amu
 = 
Ãw
 
SSD_CompÚ’ts
::
Add»ss_M­pšg_Un™_Page_Lev–
(
ál
->
ID
(è+ ".Add»ssM­pšgUn™", f, (SSD_CompÚ’ts::
NVM_PHY_ONFI
*è
deviû
->
PHY
,

241 
fbm
, 
·¿m‘”s
->
Id—l_M­pšg_TabË
,…¬am‘”s->
CMT_C­ac™y
,…¬am‘”s->
PÏÃ_AÎoÿtiÚ_Scheme
, 
¡»am_couÁ
,

242 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,…¬am‘”s->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,

243 
æow_chªÃl_id_assignm’ts
, 
æow_ch_id_assignm’ts
, 
æow_d›_id_assignm’ts
, 
æow_¶ªe_id_assignm’ts
,

244 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_No_P”_PÏÃ
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_No_P”_Block
,

245 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
,…¬am‘”s->FÏsh_P¬am‘”s.Page_C­ac™y,…¬am‘”s->
Ov”´ovisiÚšg_R©io
,

246 
·¿m‘”s
->
CMT_Sh¬šg_Mode
);

248 
	gSSD_CompÚ’ts
::
FÏsh_Add»ss_M­pšg_Ty³
::
HYBRID
:

249 
amu
 = 
Ãw
 
SSD_CompÚ’ts
::
Add»ss_M­pšg_Un™_Hybrid
(
ál
->
ID
(è+ ".Add»ssM­pšgUn™", f, (SSD_CompÚ’ts::
NVM_PHY_ONFI
*è
deviû
->
PHY
,

250 
fbm
, 
·¿m‘”s
->
Id—l_M­pšg_TabË
, 
¡»am_couÁ
,

251 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,…¬am‘”s->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,

252 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
PÏÃ_No_P”_D›
,…¬am‘”s->FÏsh_P¬am‘”s.
Block_No_P”_PÏÃ
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_No_P”_Block
,

253 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
,…¬am‘”s->FÏsh_P¬am‘”s.Page_C­ac™y,…¬am‘”s->
Ov”´ovisiÚšg_R©io
);

256 
throw
 
¡d
::
šv®id_¬gum’t
("No implementation is‡vailable fohe secified‡ddress mapping strategy");

258 
	gSimuÏtÜ
->
AddObjeù
(
amu
);

259 
	gál
->
	gAdd»ss_M­pšg_Un™
 = 
amu
;

260 
	gamu
->
	gál
=
ál
;

262 
	gmax_rho
 = 0;

263 
	gi
 = 0; i < 
	gio_æows
->
size
(); i++) {

264 ià((*
	gio_æows
)[
i
]->
	gIn™Ÿl_Occu·ncy_P”ûÁage
 > 
	gmax_rho
) {

265 
	gmax_rho
 = (*
io_æows
)[
i
]->
In™Ÿl_Occu·ncy_P”ûÁage
;

268 
	gmax_rho
 /= 100;

269 
	gSSD_CompÚ’ts
::
GC_ªd_WL_Un™_Ba£
* 
gcwl
;

270 
	ggcwl
 = 
Ãw
 
SSD_CompÚ’ts
::
GC_ªd_WL_Un™_Page_Lev–
(
ál
->
ID
(è+ ".GCªdWLUn™", 
amu
, 
fbm
, 
tsu
, (SSD_CompÚ’ts::
NVM_PHY_ONFI
*)
deviû
->
PHY
,

271 
·¿m‘”s
->
GC_Block_S–eùiÚ_PŞicy
,…¬am‘”s->
GC_Exec_Th»shŞd
,…¬am‘”s->
P»em±ibË_GC_EÇbËd
,…¬am‘”s->
GC_H¬d_Th»shŞd
,

272 
·¿m‘”s
->
FÏsh_ChªÃl_CouÁ
,…¬am‘”s->
Ch_No_P”_ChªÃl
,

273 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
D›_No_P”_Ch
,…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
,

274 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Block_No_P”_PÏÃ
,…¬am‘”s->FÏsh_P¬am‘”s.
Page_No_P”_Block
,

275 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
,…¬am‘”s->
U£_Cİyback_fÜ_GC
, 
max_rho
, 10,

276 
·¿m‘”s
->
S“d
++);

277 
	gSimuÏtÜ
->
AddObjeù
(
gcwl
);

278 
	gfbm
->
S‘_GC_ªd_WL_Un™
(
gcwl
);

279 
	gál
->
	gGC_ªd_WL_Un™
 = 
gcwl
;

282 
	gSSD_CompÚ’ts
::
D©a_Cache_Mªag”_Ba£
* 
dcm
;

283 
	gSSD_CompÚ’ts
::
Cachšg_Mode
* 
ÿchšg_modes
 = 
Ãw
 
SSD_CompÚ’ts
::Cachšg_Mode[
io_æows
->
size
()];

284 
	gi
 = 0; i < 
	gio_æows
->
size
(); i++) {

285 
	gÿchšg_modes
[
i
] = (*
io_æows
)[i]->
Deviû_Lev–_D©a_Cachšg_Mode
;

288 
	g·¿m‘”s
->
	gCachšg_Mechªism
) {

289 
	gSSD_CompÚ’ts
::
Cachšg_Mechªism
::
SIMPLE
:

290 
dcm
 = 
Ãw
 
SSD_CompÚ’ts
::
D©a_Cache_Mªag”_FÏsh_Sim¶e
(
deviû
->
ID
(è+ ".D©aCache", 
NULL
, 
ál
, (SSD_CompÚ’ts::
NVM_PHY_ONFI
*èdeviû->
PHY
,

291 
·¿m‘”s
->
D©a_Cache_C­ac™y
,…¬am‘”s->
D©a_Cache_DRAM_Row_Size
,…¬am‘”s->
D©a_Cache_DRAM_D©a_R©e
,

292 
·¿m‘”s
->
D©a_Cache_DRAM_D©a_Bu¤t_Size
,…¬am‘”s->
D©a_Cache_DRAM_tRCD
,…¬am‘”s->
D©a_Cache_DRAM_tCL
,…¬am‘”s->
D©a_Cache_DRAM_tRP
,

293 
ÿchšg_modes
, ()
io_æows
->
size
(),

294 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
,…¬am‘”s->
FÏsh_ChªÃl_CouÁ
 *…¬am‘”s->
Ch_No_P”_ChªÃl
 *…¬am‘”s->FÏsh_P¬am‘”s.
D›_No_P”_Ch
 *…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
 *…arameters->Flash_Parameters.Page_Capacity / SECTOR_SIZE_IN_BYTE);

297 
	gSSD_CompÚ’ts
::
Cachšg_Mechªism
::
ADVANCED
:

298 
dcm
 = 
Ãw
 
SSD_CompÚ’ts
::
D©a_Cache_Mªag”_FÏsh_Advªûd
(
deviû
->
ID
(è+ ".D©aCache", 
NULL
, 
ál
, (SSD_CompÚ’ts::
NVM_PHY_ONFI
*èdeviû->
PHY
,

299 
·¿m‘”s
->
D©a_Cache_C­ac™y
,…¬am‘”s->
D©a_Cache_DRAM_Row_Size
,…¬am‘”s->
D©a_Cache_DRAM_D©a_R©e
,

300 
·¿m‘”s
->
D©a_Cache_DRAM_D©a_Bu¤t_Size
,…¬am‘”s->
D©a_Cache_DRAM_tRCD
,…¬am‘”s->
D©a_Cache_DRAM_tCL
,…¬am‘”s->
D©a_Cache_DRAM_tRP
,

301 
ÿchšg_modes
, 
·¿m‘”s
->
D©a_Cache_Sh¬šg_Mode
, ()
io_æows
->
size
(),

302 
·¿m‘”s
->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
,…¬am‘”s->
FÏsh_ChªÃl_CouÁ
 *…¬am‘”s->
Ch_No_P”_ChªÃl
 *…¬am‘”s->FÏsh_P¬am‘”s.
D›_No_P”_Ch
 *…¬am‘”s->FÏsh_P¬am‘”s.
PÏÃ_No_P”_D›
 *…arameters->Flash_Parameters.Page_Capacity / SECTOR_SIZE_IN_BYTE);

306 
PRINT_ERROR
("Unknown data caching mechanism!")

309 
SimuÏtÜ
->
AddObjeù
(
dcm
);

310 
	gál
->
	gD©a_ÿche_mªag”
 = 
dcm
;

311 
	gdeviû
->
	gCache_mªag”
 = 
dcm
;

314 
	g·¿m‘”s
->
	gHo¡IÁ”çû_Ty³
) {

315 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

316 
deviû
->
Ho¡_š‹rçû
 = 
Ãw
 
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_NVMe
(deviû->
ID
() + ".HostInterface",

317 
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
G‘_tÙ®_deviû_lha_couÁ
(), 
·¿m‘”s
->
IO_Queue_D•th
,…arameters->IO_Queue_Depth,

318 ()
io_æows
->
size
(), 
·¿m‘”s
->
Queue_F‘ch_Size
,…¬am‘”s->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
, 
dcm
);

320 
	gHo¡IÁ”çû_Ty³s
::
SATA
:

321 
deviû
->
Ho¡_š‹rçû
 = 
Ãw
 
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_SATA
(deviû->
ID
() + ".HostInterface",

322 
·¿m‘”s
->
IO_Queue_D•th
, 
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
G‘_tÙ®_deviû_lha_couÁ
(),…¬am‘”s->
FÏsh_P¬am‘”s
.
Page_C­ac™y
 / 
SECTOR_SIZE_IN_BYTE
, 
dcm
);

328 
	gSimuÏtÜ
->
AddObjeù
(
deviû
->
Ho¡_š‹rçû
);

329 
	gdcm
->
S‘_ho¡_š‹rçû
(
deviû
->
Ho¡_š‹rçû
);

333 
throw
 
¡d
::
šv®id_¬gum’t
("Undefined NVMype specified ");

337 
	gSSD_Deviû
::~
	$SSD_Deviû
()

339 
chªÃl_úŒ
 = 0; chªÃl_úŒ < 
ChªÃl_couÁ
; channel_cntr++) {

340 
ch_úŒ
 = 0; ch_úŒ < 
Ch_no_³r_chªÃl
; chip_cntr++) {

341 
	`d–‘e
 ((
SSD_CompÚ’ts
::
ONFI_ChªÃl_NVDDR2
*)
this
->
ChªÃls
[
chªÃl_úŒ
])->
Chs
[
ch_úŒ
];

343 
d–‘e
 
this
->
ChªÃls
[
chªÃl_úŒ
];

345 ((
SSD_CompÚ’ts
::
FTL
*)
this
->
Fœmw¬e
)->
	`g‘_amu
();

346 
d–‘e
 
this
->
PHY
;

347 
	`d–‘e
 ((
SSD_CompÚ’ts
::
FTL
*)
this
->
Fœmw¬e
)->
TSU
;

348 
	`d–‘e
 ((
SSD_CompÚ’ts
::
FTL
*)
this
->
Fœmw¬e
)->
BlockMªag”
;

349 
	`d–‘e
 ((
SSD_CompÚ’ts
::
FTL
*)
this
->
Fœmw¬e
)->
Add»ss_M­pšg_Un™
;

350 
	`d–‘e
 ((
SSD_CompÚ’ts
::
FTL
*)
this
->
Fœmw¬e
)->
GC_ªd_WL_Un™
;

351 
d–‘e
 
this
->
Fœmw¬e
;

352 
d–‘e
 
this
->
Cache_mªag”
;

353 
d–‘e
 
this
->
Ho¡_š‹rçû
;

354 
	}
}

356 
	gSSD_Deviû
::
	$A‰ach_to_ho¡
(
Ho¡_CompÚ’ts
::
PCIe_Sw™ch
* 
pc›_sw™ch
)

358 
this
->
Ho¡_š‹rçû
->
	`A‰ach_to_deviû
(
pc›_sw™ch
);

359 
	}
}

361 
	gSSD_Deviû
::
P”fÜm_´ecÚd™iÚšg
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
)

363 ià(
P»cÚd™iÚšg_»quœed
) {

364 
time_t
 
¡¬t_time
 = 
time
(0);

365 
PRINT_MESSAGE
("SSD Device…reconditioning started .........");

366 
	gthis
->
	gFœmw¬e
->
P”fÜm_´ecÚd™iÚ
(
wÜklßd_¡©s
);

367 
	gthis
->
	gCache_mªag”
->
Do_w¬mup
(
wÜklßd_¡©s
);

368 
time_t
 
	g’d_time
 = 
time
(0);

369 
ušt64_t
 
	gdu¿tiÚ
 = (ušt64_t)
difáime
(
’d_time
, 
¡¬t_time
);

370 
PRINT_MESSAGE
("Fšished…»cÚd™iÚšg. Du¿tiÚ oà´ecÚd™iÚšg: " << 
du¿tiÚ
 / 3600 << ":" << (duration % 3600) / 60 << ":" << ((duration % 3600) % 60));

374 
	gSSD_Deviû
::
	$S¹_simuÏtiÚ
()

376 
	}
}

378 
SSD_Deviû
::
	$V®id©e_simuÏtiÚ_cÚfig
() {

379 
	}
}

381 
SSD_Deviû
::
	$Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

383 
	}
}

385 
SSD_Deviû
::
	$R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

387 
¡d
::
¡ršg
 
tmp
;

388 
tmp
 = 
	`ID
();

389 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

391 
this
->
Ho¡_š‹rçû
->
	`R•Üt_»suÉs_š_XML
(
	`ID
(), 
xmlwr™”
);

392 ià(
MemÜy_Ty³
 =ğ
NVM
::
NVM_Ty³
::
FLASH
) {

393 ((
SSD_CompÚ’ts
::
FTL
*)
this
->
Fœmw¬e
)->
	`R•Üt_»suÉs_š_XML
(
	`ID
(), 
xmlwr™”
);

394 ((
SSD_CompÚ’ts
::
FTL
*)
this
->
Fœmw¬e
)->
TSU
->
	`R•Üt_»suÉs_š_XML
(
	`ID
(), 
xmlwr™”
);

396 
chªÃl_úŒ
 = 0; chªÃl_úŒ < 
ChªÃl_couÁ
; channel_cntr++) {

397 
ch_úŒ
 = 0; ch_úŒ < 
Ch_no_³r_chªÃl
; chip_cntr++) {

398 ((
SSD_CompÚ’ts
::
ONFI_ChªÃl_NVDDR2
*)
ChªÃls
[
chªÃl_úŒ
])->
Chs
[
ch_úŒ
]->
	`R•Üt_»suÉs_š_XML
(
	`ID
(), 
xmlwr™”
);

402 
xmlwr™”
.
	`Wr™e_şo£_g
();

403 
	}
}

405 
	gSSD_Deviû
::
	$G‘_no_of_LHAs_š_ª_NVM_wr™e_un™
()

407  
Ho¡_š‹rçû
->
	`G‘_no_of_LHAs_š_ª_NVM_wr™e_un™
();

408 
	}
}

410 
LPA_ty³
 
	gSSD_Deviû
::
	$CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
LHA_ty³
 
lha
)

412  
my_š¡ªû
->
Fœmw¬e
->
	`CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
lha
);

413 
	}
}

415 
·ge_¡©us_ty³
 
	gSSD_Deviû
::
	$Fšd_NVM_subun™_acûss_b™m­
(
LHA_ty³
 
lha
)

417  
my_š¡ªû
->
Fœmw¬e
->
	`Fšd_NVM_subun™_acûss_b™m­
(
lha
);

418 
	}
}

	@src/exec/SSD_Device.h

1 #iâdeà
SSD_DEVICE_H


2 
	#SSD_DEVICE_H


	)

4 
	~<veùÜ
>

5 
	~"../sim/Sim_Objeù.h
"

6 
	~"../sim/Sim_R•Ü‹r.h
"

7 
	~"../ssd/SSD_Defs.h
"

8 
	~"../ssd/Ho¡_IÁ”çû_Ba£.h
"

9 
	~"../ssd/Ho¡_IÁ”çû_SATA.h
"

10 
	~"../ssd/Ho¡_IÁ”çû_NVMe.h
"

11 
	~"../ssd/D©a_Cache_Mªag”_Ba£.h
"

12 
	~"../ssd/D©a_Cache_FÏsh.h
"

13 
	~"../ssd/NVM_Fœmw¬e.h
"

14 
	~"../ssd/NVM_PHY_Ba£.h
"

15 
	~"../ssd/NVM_ChªÃl_Ba£.h
"

16 
	~"../ho¡/PCIe_Sw™ch.h
"

17 
	~"../nvm_ch/NVM_Ty³s.h
"

18 
	~"Deviû_P¬am‘”_S‘.h
"

19 
	~"IO_Flow_P¬am‘”_S‘.h
"

20 
	~"../uts/WÜklßd_Sti¡ics.h
"

29 
şass
 
	gSSD_Deviû
 : 
public
 
MQSimEngše
::
Sim_Objeù
,…ubliø
	gMQSimEngše
::
Sim_R•Ü‹r


31 
public
:

32 
SSD_Deviû
(
Deviû_P¬am‘”_S‘
* 
·¿m‘”s
, 
¡d
::
veùÜ
<
IO_Flow_P¬am‘”_S‘
*>* 
io_æows
);

33 ~
SSD_Deviû
();

34 
boŞ
 
	gP»cÚd™iÚšg_»quœed
;

35 
	gNVM
::
NVM_Ty³
 
MemÜy_Ty³
;

36 
	gSSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
 *
Ho¡_š‹rçû
;

37 
	gSSD_CompÚ’ts
::
D©a_Cache_Mªag”_Ba£
 *
Cache_mªag”
;

38 
	gSSD_CompÚ’ts
::
NVM_Fœmw¬e
* 
Fœmw¬e
;

39 
	gSSD_CompÚ’ts
::
NVM_PHY_Ba£
* 
PHY
;

40 
	g¡d
::
veùÜ
<
SSD_CompÚ’ts
::
NVM_ChªÃl_Ba£
*> 
ChªÃls
;

41 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

42 
G‘_no_of_LHAs_š_ª_NVM_wr™e_un™
();

44 
A‰ach_to_ho¡
(
Ho¡_CompÚ’ts
::
PCIe_Sw™ch
* 
pc›_sw™ch
);

45 
P”fÜm_´ecÚd™iÚšg
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
);

46 
S¹_simuÏtiÚ
();

47 
V®id©e_simuÏtiÚ_cÚfig
();

48 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
);

49 
LPA_ty³
 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
LHA_ty³
 
lha
);

50 
·ge_¡©us_ty³
 
Fšd_NVM_subun™_acûss_b™m­
(
LHA_ty³
 
lha
);

52 
	gChªÃl_couÁ
;

53 
	gCh_no_³r_chªÃl
;

54 
	gSSD_CompÚ’ts
::
Add»ss_M­pšg_Un™_Ba£
* 
amu
;

55 
	g´iv©e
:

56 
SSD_Deviû
 * 
my_š¡ªû
;

	@src/host/ASCII_Trace_Definition.h

1 #iâdeà
ASCII_TRACE_DEFINITION_H


2 
	#ASCII_TRACE_DEFINITION_H


	)

4 şas 
	cT¿û_Time_Un™
 { 
	mPICOSECOND
, 
	mNANOSECOND
, 
	mMICROSECOND
};

5 
	#PicoSecÚdCÛff
 1000000000000

6 
	#NªoSecÚdCÛff
 1000000000

7 
	#MiüoSecÚdCÛff
 1000000

8 
	#ASCIIT¿ûTimeCŞumn
 0

	)

9 
	#ASCIIT¿ûDeviûCŞumn
 1

	)

10 
	#ASCIIT¿ûAdd»ssCŞumn
 2

	)

11 
	#ASCIIT¿ûSizeCŞumn
 3

	)

12 
	#ASCIIT¿ûTy³CŞumn
 4

	)

13 
	#ASCIIT¿ûWr™eCode
 "0"

	)

14 
	#ASCIIT¿ûR—dCode
 "1"

	)

15 
	#ASCIIT¿ûWr™eCodeIÁeg”
 0

	)

16 
	#ASCIIT¿ûR—dCodeIÁeg”
 1

	)

17 
	#ASCIILšeD–im™”
 ' '

	)

18 
	#ASCIII‹msP”Lše
 5

	)

	@src/host/Host_Defs.h

1 #iâdeà
HOST_DEFS_H


2 
	#HOST_DEFS_H


	)

5 
	#QUEUE_ID_TO_FLOW_ID
(
Q
èQ - 1

	)

6 
	#FLOW_ID_TO_Q_ID
(
F
èF + 1

	)

7 
	#NVME_COMP_Q_MEMORY_REGION
 40

	)

8 
	#DATA_MEMORY_REGION
 0xFF0000000000

	)

10 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_0
 = 0x000000000000;

11 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_0
 = 0x00F000000000;

12 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_1
 = 0x010000000000;

13 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_1
 = 0x01F000000000;

14 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_2
 = 0x020000000000;

15 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_2
 = 0x02F000000000;

16 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_3
 = 0x030000000000;

17 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_3
 = 0x03F000000000;

18 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_4
 = 0x040000000000;

19 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_4
 = 0x04F000000000;

20 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_5
 = 0x050000000000;

21 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_5
 = 0x05F000000000;

22 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_6
 = 0x060000000000;

23 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_6
 = 0x06F000000000;

24 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_7
 = 0x070000000000;

25 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_7
 = 0x07F000000000;

26 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_MEMORY_8
 = 0x080000000000;

27 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_MEMORY_8
 = 0x08F000000000;

	@src/host/Host_IO_Request.h

1 #iâdeà
HOST_IO_REQUEST_H


2 
	#HOST_IO_REQUEST_H


	)

4 
	~"../ssd/SSD_Defs.h
"

6 
Çme¥aû
 
	gHo¡_CompÚ’ts


8 şas 
	cHo¡_IO_Reque¡_Ty³
 { 
	gREAD
, 
	gWRITE
 };

9 şas 
	cHo¡_IO_Reque¡


11 
	gpublic
:

12 
sim_time_ty³
 
A¼iv®_time
;

13 
sim_time_ty³
 
	gEnqueue_time
;

14 
LHA_ty³
 
	gS¹_LBA
;

15 
	gLBA_couÁ
;

16 
Ho¡_IO_Reque¡_Ty³
 
	gTy³
;

17 
ušt16_t
 
	gIO_queue_šfo
;

18 
ušt16_t
 
	gSourû_æow_id
;

	@src/host/IO_Flow_Base.cpp

1 
	~"IO_Flow_Ba£.h
"

2 
	~"../ssd/Ho¡_IÁ”çû_Defs.h
"

3 
	~"../sim/Engše.h
"

5 
Çme¥aû
 
	gHo¡_CompÚ’ts


8 
	gIO_Flow_Ba£
::
IO_Flow_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
Çme
, 
ušt16_t
 
æow_id
, 
LHA_ty³
 
¡¬t_l§_Ú_deviû
, LHA_ty³ 
’d_l§_Ú_deviû
, ušt16_ˆ
io_queue_id
,

9 
ušt16_t
 
nvme_submissiÚ_queue_size
, ušt16_ˆ
nvme_com¶‘iÚ_queue_size
,

10 
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
sim_time_ty³
 
¡İ_time
, 
š™Ÿl_occu·ncy_¿tio
, 
tÙ®_»qu‘s_to_be_g’”©ed
,

11 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
SATA_HBA
* 
§_hba
,

12 
boŞ
 
’abËd_loggšg
, 
sim_time_ty³
 
loggšg_³riod
, 
¡d
::
¡ršg
 
loggšg_fe_·th
) :

13 
MQSimEngše
::
Sim_Objeù
(
Çme
), 
æow_id
(æow_id), 
¡¬t_l§_Ú_deviû
(¡¬t_l§_Ú_deviû), 
’d_l§_Ú_deviû
Ónd_l§_Ú_deviû), 
io_queue_id
(io_queue_id),

14 
´iÜ™y_şass
ÕriÜ™y_şass), 
¡İ_time
(¡İ_time), 
š™Ÿl_occu·ncy_¿tio
(š™Ÿl_occu·ncy_¿tio), 
tÙ®_»que¡s_to_be_g’”©ed
(
tÙ®_»qu‘s_to_be_g’”©ed
), 
SSD_deviû_ty³
(SSD_deviû_ty³), 
pc›_roÙ_com¶ex
Õc›_roÙ_com¶ex), 
§_hba
(sata_hba),

15 
STAT_g’”©ed_»que¡_couÁ
(0), 
STAT_g’”©ed_»ad_»que¡_couÁ
(0), 
STAT_g’”©ed_wr™e_»que¡_couÁ
(0),

16 
STAT_ignÜed_»que¡_couÁ
(0),

17 
STAT_£rviûd_»que¡_couÁ
(0), 
STAT_£rviûd_»ad_»que¡_couÁ
(0), 
STAT_£rviûd_wr™e_»que¡_couÁ
(0),

18 
STAT_sum_deviû_»¥Ú£_time
(0), 
STAT_sum_deviû_»¥Ú£_time_»ad
(0), 
STAT_sum_deviû_»¥Ú£_time_wr™e
(0),

19 
STAT_mš_deviû_»¥Ú£_time
(
MAXIMUM_TIME
), 
STAT_mš_deviû_»¥Ú£_time_»ad
(MAXIMUM_TIME), 
STAT_mš_deviû_»¥Ú£_time_wr™e
(MAXIMUM_TIME),

20 
STAT_max_deviû_»¥Ú£_time
(0), 
STAT_max_deviû_»¥Ú£_time_»ad
(0), 
STAT_max_deviû_»¥Ú£_time_wr™e
(0),

21 
STAT_sum_»que¡_d–ay
(0), 
STAT_sum_»que¡_d–ay_»ad
(0), 
STAT_sum_»que¡_d–ay_wr™e
(0),

22 
STAT_mš_»que¡_d–ay
(
MAXIMUM_TIME
), 
STAT_mš_»que¡_d–ay_»ad
(MAXIMUM_TIME), 
STAT_mš_»que¡_d–ay_wr™e
(MAXIMUM_TIME),

23 
STAT_max_»que¡_d–ay
(0), 
STAT_max_»que¡_d–ay_»ad
(0), 
STAT_max_»que¡_d–ay_wr™e
(0),

24 
STAT_Œªsã¼ed_by‹s_tÙ®
(0), 
STAT_Œªsã¼ed_by‹s_»ad
(0), 
STAT_Œªsã¼ed_by‹s_wr™e
(0), 
´og»ss
(0), 
Ãxt_´og»ss_¡•
(0),

25 
’abËd_loggšg
ÓÇbËd_loggšg), 
loggšg_³riod
Öoggšg_³riod), 
loggšg_fe_·th
(logging_file_path)

27 
Ho¡_IO_Reque¡
* 
	gt
ğ
NULL
;

29 
	gSSD_deviû_ty³
) {

30 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

31 
ušt16_t
 
cmdid
 = 0; 
	gcmdid
 < (
	gušt16_t
)(0xffffffff); cmdid++) {

32 
	gavaabË_commªd_ids
.
š£¹
(
cmdid
);

34 
ušt16_t
 
	gcmdid
 = 0; cmdid < 
	gnvme_submissiÚ_queue_size
; cmdid++) {

35 
	g»que¡_queue_š_memÜy
.
push_back
(
t
);

37 
	gnvme_queue_·œ
.
	gSubmissiÚ_queue_size
 = 
nvme_submissiÚ_queue_size
;

38 
	gnvme_queue_·œ
.
	gSubmissiÚ_queue_h—d
 = 0;

39 
	gnvme_queue_·œ
.
	gSubmissiÚ_queue_
 = 0;

40 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_size
 = 
nvme_com¶‘iÚ_queue_size
;

41 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_h—d
 = 0;

42 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_
 = 0;

45 
	gio_queue_id
) {

47 
throw
 
¡d
::
logic_”rÜ
("I/O queue id 0 is„eserved for NVMe‡dmin queues‡nd should‚ot be used for I/O flows");

52 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_REGISTER_0
;

55 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_1
;

56 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_1
;

57 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_1
;

58 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_1
;

61 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_2
;

62 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_2
;

63 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_2
;

64 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_2
;

67 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_3
;

68 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_3
;

69 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_3
;

70 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_3
;

73 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_4
;

74 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_4
;

75 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_4
;

76 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_4
;

79 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_5
;

80 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_5
;

81 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_5
;

82 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_5
;

85 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_6
;

86 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_6
;

87 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_6
;

88 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_6
;

91 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_7
;

92 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_7
;

93 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_7
;

94 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_7
;

97 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_8
;

98 
	gnvme_queue_·œ
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
SUBMISSION_QUEUE_REGISTER_8
;

99 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_8
;

100 
	gnvme_queue_·œ
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
COMPLETION_QUEUE_REGISTER_8
;

111 
	gIO_Flow_Ba£
::~
IO_Flow_Ba£
()

113 
log_fe
.
şo£
();

114 autØ&
	g»q
 : 
wa™šg_»que¡s
) {

115 ià(
»q
) {

116 
d–‘e
 
»q
;

120 
	gSSD_deviû_ty³
) {

121 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

122 autØ&
»q
 : 
nvme_soáw¬e_»que¡_queue
) {

123 ià(
»q
.
£cÚd
) {

124 
d–‘e
 
»q
.
£cÚd
;

128 
	gHo¡IÁ”çû_Ty³s
::
SATA
:

131 
PRINT_ERROR
("Unsupported host interfaceype in IO_Flow_Base!")

136 
IO_Flow_Ba£
::
S¹_simuÏtiÚ
()

138 
Ãxt_loggšg_me¡Úe
 = 
loggšg_³riod
;

139 ià(
	g’abËd_loggšg
) {

140 
	glog_fe
.
İ’
(
loggšg_fe_·th
, 
¡d
::
of¡»am
::
out
);

142 
	glog_fe
 << "SimuÏtiÚTime(us)\t" << "R•Ú£Time(us)\t" << "EndToEndD–ay(us)"<< 
	g¡d
::
’dl
;

143 
	gSTAT_sum_deviû_»¥Ú£_time_shÜt_‹rm
 = 0;

144 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
 = 0;

147 
	gIO_Flow_Ba£
::
SATA_cÚsume_io_»que¡
(
Ho¡_IO_Reque¡
* 
»que¡
)

149 
sim_time_ty³
 
deviû_»¥Ú£_time
 = 
SimuÏtÜ
->
Time
(è- 
»que¡
->
Enqueue_time
;

150 
sim_time_ty³
 
	g»que¡_d–ay
 = 
SimuÏtÜ
->
Time
(è- 
»que¡
->
A¼iv®_time
;

152 
	gSTAT_£rviûd_»que¡_couÁ
++;

153 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
++;

154 
	gSTAT_sum_deviû_»¥Ú£_time
 +ğ
deviû_»¥Ú£_time
;

155 
	gSTAT_sum_deviû_»¥Ú£_time_shÜt_‹rm
 +ğ
deviû_»¥Ú£_time
;

156 
	gSTAT_sum_»que¡_d–ay
 +ğ
»que¡_d–ay
;

157 
	gSTAT_sum_»que¡_d–ay_shÜt_‹rm
 +ğ
»que¡_d–ay
;

158 ià(
	gdeviû_»¥Ú£_time
 > 
	gSTAT_max_deviû_»¥Ú£_time
) {

159 
	gSTAT_max_deviû_»¥Ú£_time
 = 
deviû_»¥Ú£_time
;

161 ià(
	gdeviû_»¥Ú£_time
 < 
	gSTAT_mš_deviû_»¥Ú£_time
) {

162 
	gSTAT_mš_deviû_»¥Ú£_time
 = 
deviû_»¥Ú£_time
;

164 ià(
	g»que¡_d–ay
 > 
	gSTAT_max_»que¡_d–ay
) {

165 
	gSTAT_max_»que¡_d–ay
 = 
»que¡_d–ay
;

167 ià(
	g»que¡_d–ay
 < 
	gSTAT_mš_»que¡_d–ay
) {

168 
	gSTAT_mš_»que¡_d–ay
 = 
»que¡_d–ay
;

170 
	gSTAT_Œªsã¼ed_by‹s_tÙ®
 +ğ
»que¡
->
LBA_couÁ
 * 
SECTOR_SIZE_IN_BYTE
;

172 ià(
	g»que¡
->
	gTy³
 =ğ
Ho¡_IO_Reque¡_Ty³
::
READ
) {

173 
STAT_£rviûd_»ad_»que¡_couÁ
++;

174 
	gSTAT_sum_deviû_»¥Ú£_time_»ad
 +ğ
deviû_»¥Ú£_time
;

175 
	gSTAT_sum_»que¡_d–ay_»ad
 +ğ
»que¡_d–ay
;

176 ià(
	gdeviû_»¥Ú£_time
 > 
	gSTAT_max_deviû_»¥Ú£_time_»ad
) {

177 
	gSTAT_max_deviû_»¥Ú£_time_»ad
 = 
deviû_»¥Ú£_time
;

179 ià(
	gdeviû_»¥Ú£_time
 < 
	gSTAT_mš_deviû_»¥Ú£_time_»ad
) {

180 
	gSTAT_mš_deviû_»¥Ú£_time_»ad
 = 
deviû_»¥Ú£_time
;

182 ià(
	g»que¡_d–ay
 > 
	gSTAT_max_»que¡_d–ay_»ad
) {

183 
	gSTAT_max_»que¡_d–ay_»ad
 = 
»que¡_d–ay
;

185 ià(
	g»que¡_d–ay
 < 
	gSTAT_mš_»que¡_d–ay_»ad
) {

186 
	gSTAT_mš_»que¡_d–ay_»ad
 = 
»que¡_d–ay
;

188 
	gSTAT_Œªsã¼ed_by‹s_»ad
 +ğ
»que¡
->
LBA_couÁ
 * 
SECTOR_SIZE_IN_BYTE
;

190 
	gSTAT_£rviûd_wr™e_»que¡_couÁ
++;

191 
	gSTAT_sum_deviû_»¥Ú£_time_wr™e
 +ğ
deviû_»¥Ú£_time
;

192 
	gSTAT_sum_»que¡_d–ay_wr™e
 +ğ
»que¡_d–ay
;

193 ià(
	gdeviû_»¥Ú£_time
 > 
	gSTAT_max_deviû_»¥Ú£_time_wr™e
) {

194 
	gSTAT_max_deviû_»¥Ú£_time_wr™e
 = 
deviû_»¥Ú£_time
;

196 ià(
	gdeviû_»¥Ú£_time
 < 
	gSTAT_mš_deviû_»¥Ú£_time_wr™e
) {

197 
	gSTAT_mš_deviû_»¥Ú£_time_wr™e
 = 
deviû_»¥Ú£_time
;

199 ià(
	g»que¡_d–ay
 > 
	gSTAT_max_»que¡_d–ay_wr™e
) {

200 
	gSTAT_max_»que¡_d–ay_wr™e
 = 
»que¡_d–ay
;

202 ià(
	g»que¡_d–ay
 < 
	gSTAT_mš_»que¡_d–ay_wr™e
) {

203 
	gSTAT_mš_»que¡_d–ay_wr™e
 = 
»que¡_d–ay
;

205 
	gSTAT_Œªsã¼ed_by‹s_wr™e
 +ğ
»que¡
->
LBA_couÁ
 * 
SECTOR_SIZE_IN_BYTE
;

208 
d–‘e
 
	g»que¡
;

211 ià(
	g¡İ_time
 > 0) {

212 
	g´og»ss
 = (
SimuÏtÜ
->
Time
(è/ ()
¡İ_time
 * 100);

214 
	g´og»ss
 = (
STAT_£rviûd_»que¡_couÁ
 / ()
tÙ®_»que¡s_to_be_g’”©ed
 * 100);

216 ià(
	g´og»ss
 >ğ
Ãxt_´og»ss_¡•
) {

217 
¡d
::
¡ršg
 
´og»ss_b¬
;

218 
	gb¬Width
 = 100;

219 
	g´og»ss_b¬
 += "[";

220 
	gpos
 = 
´og»ss
;

221 
	gi
 = 0; i < 
	gb¬Width
; i += 5) {

222 ià(
i
 < 
pos
) {

223 
´og»ss_b¬
 += "=";

224 } ià(
	gi
 =ğ
pos
) {

225 
´og»ss_b¬
 += ">";

227 
	g´og»ss_b¬
 += " ";

230 
	g´og»ss_b¬
 += "] ";

231 
PRINT_MESSAGE
(
´og»ss_b¬
 << " " << 
´og»ss
 << "%…rog»s š " << 
ID
(è<< 
¡d
::
’dl
)

232 
Ãxt_´og»ss_¡•
 += 5;

235 ià(
	gSimuÏtÜ
->
Time
(è> 
	gÃxt_loggšg_me¡Úe
) {

236 
	glog_fe
 << 
	gSimuÏtÜ
->
Time
(è/ 
	gSIM_TIME_TO_MICROSECONDS_COEFF
 << "\t" << 
G‘_deviû_»¥Ú£_time_shÜt_‹rm
(è<< "\t" << 
G‘_’d_to_’d_»que¡_d–ay_shÜt_‹rm
(è<< 
	g¡d
::
’dl
;

237 
	gSTAT_sum_deviû_»¥Ú£_time_shÜt_‹rm
 = 0;

238 
	gSTAT_sum_»que¡_d–ay_shÜt_‹rm
 = 0;

239 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
 = 0;

240 
	gÃxt_loggšg_me¡Úe
 = 
SimuÏtÜ
->
Time
(è+ 
loggšg_³riod
;

244 
	gIO_Flow_Ba£
::
NVMe_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
* 
cqe
)

247 
Ho¡_IO_Reque¡
* 
»que¡
 = 
nvme_soáw¬e_»que¡_queue
[
cqe
->
Commªd_Id’tif›r
];

248 
	gnvme_soáw¬e_»que¡_queue
.
”a£
(
cqe
->
Commªd_Id’tif›r
);

249 
	gavaabË_commªd_ids
.
š£¹
(
cqe
->
Commªd_Id’tif›r
);

250 
sim_time_ty³
 
	gdeviû_»¥Ú£_time
 = 
SimuÏtÜ
->
Time
(è- 
»que¡
->
Enqueue_time
;

251 
sim_time_ty³
 
	g»que¡_d–ay
 = 
SimuÏtÜ
->
Time
(è- 
»que¡
->
A¼iv®_time
;

252 
	gSTAT_£rviûd_»que¡_couÁ
++;

253 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
++;

255 
	gSTAT_sum_deviû_»¥Ú£_time
 +ğ
deviû_»¥Ú£_time
;

256 
	gSTAT_sum_deviû_»¥Ú£_time_shÜt_‹rm
 +ğ
deviû_»¥Ú£_time
;

257 
	gSTAT_sum_»que¡_d–ay
 +ğ
»que¡_d–ay
;

258 
	gSTAT_sum_»que¡_d–ay_shÜt_‹rm
 +ğ
»que¡_d–ay
;

259 ià(
	gdeviû_»¥Ú£_time
 > 
	gSTAT_max_deviû_»¥Ú£_time
) {

260 
	gSTAT_max_deviû_»¥Ú£_time
 = 
deviû_»¥Ú£_time
;

262 ià(
	gdeviû_»¥Ú£_time
 < 
	gSTAT_mš_deviû_»¥Ú£_time
) {

263 
	gSTAT_mš_deviû_»¥Ú£_time
 = 
deviû_»¥Ú£_time
;

265 ià(
	g»que¡_d–ay
 > 
	gSTAT_max_»que¡_d–ay
) {

266 
	gSTAT_max_»que¡_d–ay
 = 
»que¡_d–ay
;

268 ià(
	g»que¡_d–ay
 < 
	gSTAT_mš_»que¡_d–ay
) {

269 
	gSTAT_mš_»que¡_d–ay
 = 
»que¡_d–ay
;

271 
	gSTAT_Œªsã¼ed_by‹s_tÙ®
 +ğ
»que¡
->
LBA_couÁ
 * 
SECTOR_SIZE_IN_BYTE
;

273 ià(
	g»que¡
->
	gTy³
 =ğ
Ho¡_IO_Reque¡_Ty³
::
READ
) {

274 
STAT_£rviûd_»ad_»que¡_couÁ
++;

275 
	gSTAT_sum_deviû_»¥Ú£_time_»ad
 +ğ
deviû_»¥Ú£_time
;

276 
	gSTAT_sum_»que¡_d–ay_»ad
 +ğ
»que¡_d–ay
;

277 ià(
	gdeviû_»¥Ú£_time
 > 
	gSTAT_max_deviû_»¥Ú£_time_»ad
) {

278 
	gSTAT_max_deviû_»¥Ú£_time_»ad
 = 
deviû_»¥Ú£_time
;

280 ià(
	gdeviû_»¥Ú£_time
 < 
	gSTAT_mš_deviû_»¥Ú£_time_»ad
) {

281 
	gSTAT_mš_deviû_»¥Ú£_time_»ad
 = 
deviû_»¥Ú£_time
;

283 ià(
	g»que¡_d–ay
 > 
	gSTAT_max_»que¡_d–ay_»ad
) {

284 
	gSTAT_max_»que¡_d–ay_»ad
 = 
»que¡_d–ay
;

286 ià(
	g»que¡_d–ay
 < 
	gSTAT_mš_»que¡_d–ay_»ad
) {

287 
	gSTAT_mš_»que¡_d–ay_»ad
 = 
»que¡_d–ay
;

289 
	gSTAT_Œªsã¼ed_by‹s_»ad
 +ğ
»que¡
->
LBA_couÁ
 * 
SECTOR_SIZE_IN_BYTE
;

291 
	gSTAT_£rviûd_wr™e_»que¡_couÁ
++;

292 
	gSTAT_sum_deviû_»¥Ú£_time_wr™e
 +ğ
deviû_»¥Ú£_time
;

293 
	gSTAT_sum_»que¡_d–ay_wr™e
 +ğ
»que¡_d–ay
;

294 ià(
	gdeviû_»¥Ú£_time
 > 
	gSTAT_max_deviû_»¥Ú£_time_wr™e
) {

295 
	gSTAT_max_deviû_»¥Ú£_time_wr™e
 = 
deviû_»¥Ú£_time
;

297 ià(
	gdeviû_»¥Ú£_time
 < 
	gSTAT_mš_deviû_»¥Ú£_time_wr™e
) {

298 
	gSTAT_mš_deviû_»¥Ú£_time_wr™e
 = 
deviû_»¥Ú£_time
;

300 ià(
	g»que¡_d–ay
 > 
	gSTAT_max_»que¡_d–ay_wr™e
) {

301 
	gSTAT_max_»que¡_d–ay_wr™e
 = 
»que¡_d–ay
;

303 ià(
	g»que¡_d–ay
 < 
	gSTAT_mš_»que¡_d–ay_wr™e
) {

304 
	gSTAT_mš_»que¡_d–ay_wr™e
 = 
»que¡_d–ay
;

306 
	gSTAT_Œªsã¼ed_by‹s_wr™e
 +ğ
»que¡
->
LBA_couÁ
 * 
SECTOR_SIZE_IN_BYTE
;

309 
d–‘e
 
	g»que¡
;

311 
	gnvme_queue_·œ
.
	gSubmissiÚ_queue_h—d
 = 
cqe
->
SQ_H—d
;

316 
	gwa™šg_»que¡s
.
size
() > 0) {

317 ià(!
NVME_SQ_FULL
(
nvme_queue_·œ
è&& 
	gavaabË_commªd_ids
.
size
() > 0) {

318 
Ho¡_IO_Reque¡
* 
	gÃw_»q
 = 
wa™šg_»que¡s
.
äÚt
();

319 
	gwa™šg_»que¡s
.
pİ_äÚt
();

320 ià(
	gnvme_soáw¬e_»que¡_queue
[*
avaabË_commªd_ids
.
begš
()] !ğ
NULL
) {

321 
PRINT_ERROR
("Unexpteced situation in IO_Flow_Base! Overwriting‡ waiting I/O„equest inhe queue!")

323 
Ãw_»q
->
IO_queue_šfo
 = *
avaabË_commªd_ids
.
begš
();

324 
	gnvme_soáw¬e_»que¡_queue
[*
avaabË_commªd_ids
.
begš
()] = 
Ãw_»q
;

325 
	gavaabË_commªd_ids
.
”a£
(
avaabË_commªd_ids
.
begš
());

326 
	g»que¡_queue_š_memÜy
[
nvme_queue_·œ
.
SubmissiÚ_queue_
] = 
Ãw_»q
;

327 
NVME_UPDATE_SQ_TAIL
(
nvme_queue_·œ
);

329 
	gÃw_»q
->
	gEnqueue_time
 = 
SimuÏtÜ
->
Time
();

330 
	gpc›_roÙ_com¶ex
->
Wr™e_to_deviû
(
nvme_queue_·œ
.
SubmissiÚ__»gi¡”_add»ss_Ú_deviû
,‚vme_queue_·œ.
SubmissiÚ_queue_
);

336 
d–‘e
 
	gcqe
;

339 ià(
	g¡İ_time
 > 0) {

340 
	g´og»ss
 = (
SimuÏtÜ
->
Time
(è/ ()
¡İ_time
 * 100);

342 
	g´og»ss
 = (
STAT_£rviûd_»que¡_couÁ
 / ()
tÙ®_»que¡s_to_be_g’”©ed
 * 100);

345 ià(
	g´og»ss
 >ğ
Ãxt_´og»ss_¡•
) {

346 
¡d
::
¡ršg
 
´og»ss_b¬
;

347 
	gb¬Width
 = 100;

348 
	g´og»ss_b¬
 += "[";

349 
	gpos
 = 
´og»ss
;

350 
	gi
 = 0; i < 
	gb¬Width
; i += 5) {

351 ià(
i
 < 
pos
) {

352 
´og»ss_b¬
 += "=";

353 } ià(
	gi
 =ğ
pos
) {

354 
´og»ss_b¬
 += ">";

356 
	g´og»ss_b¬
 += " ";

359 
	g´og»ss_b¬
 += "] ";

360 
PRINT_MESSAGE
(
´og»ss_b¬
 << " " << 
´og»ss
 << "%…rog»s š " << 
ID
(è<< 
¡d
::
’dl
)

361 
Ãxt_´og»ss_¡•
 += 5;

364 ià(
	gSimuÏtÜ
->
Time
(è> 
	gÃxt_loggšg_me¡Úe
) {

365 
	glog_fe
 << 
	gSimuÏtÜ
->
Time
(è/ 
	gSIM_TIME_TO_MICROSECONDS_COEFF
 << "\t" << 
G‘_deviû_»¥Ú£_time_shÜt_‹rm
(è<< "\t" << 
G‘_’d_to_’d_»que¡_d–ay_shÜt_‹rm
(è<< 
	g¡d
::
’dl
;

366 
	gSTAT_sum_deviû_»¥Ú£_time_shÜt_‹rm
 = 0;

367 
	gSTAT_sum_»que¡_d–ay_shÜt_‹rm
 = 0;

368 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
 = 0;

369 
	gÃxt_loggšg_me¡Úe
 = 
SimuÏtÜ
->
Time
(è+ 
loggšg_³riod
;

373 
SubmissiÚ_Queue_EÁry
* 
	gIO_Flow_Ba£
::
NVMe_»ad_sqe
(
ušt64_t
 
add»ss
)

375 
SubmissiÚ_Queue_EÁry
* 
sqe
 = 
Ãw
 Submission_Queue_Entry;

376 
Ho¡_IO_Reque¡
* 
	g»que¡
 = 
»que¡_queue_š_memÜy
[(
ušt16_t
)((
add»ss
 - 
nvme_queue_·œ
.
SubmissiÚ_queue_memÜy_ba£_add»ss
è/ (
SubmissiÚ_Queue_EÁry
))];

378 ià(
	g»que¡
 =ğ
NULL
) {

379 
throw
 
¡d
::
šv®id_¬gum’t
(
this
->
ID
() + ": Requesto‡ccess‡ submission queueƒntryhat does‚otƒxist.");

382 
	gsqe
->
	gCommªd_Id’tif›r
 = 
»que¡
->
IO_queue_šfo
;

383 ià(
	g»que¡
->
	gTy³
 =ğ
Ho¡_IO_Reque¡_Ty³
::
READ
) {

384 
sqe
->
Opcode
 = 
NVME_READ_OPCODE
;

385 
	gsqe
->
	gCommªd_¥ecific
[0] = (
ušt32_t
è
»que¡
->
S¹_LBA
;

386 
	gsqe
->
	gCommªd_¥ecific
[1] = (
ušt32_t
)(
»que¡
->
S¹_LBA
 >> 32);

387 
	gsqe
->
	gCommªd_¥ecific
[2] = ((
ušt32_t
)((
ušt16_t
)
»que¡
->
LBA_couÁ
)) & (uint32_t)(0x0000ffff);

388 
	gsqe
->
	gPRP_’Œy_1
 = (
DATA_MEMORY_REGION
);

389 
	gsqe
->
	gPRP_’Œy_2
 = (
DATA_MEMORY_REGION
 + 0x1000);

391 
	gsqe
->
	gOpcode
 = 
NVME_WRITE_OPCODE
;

392 
	gsqe
->
	gCommªd_¥ecific
[0] = (
ušt32_t
)
»que¡
->
S¹_LBA
;

393 
	gsqe
->
	gCommªd_¥ecific
[1] = (
ušt32_t
)(
»que¡
->
S¹_LBA
 >> 32);

394 
	gsqe
->
	gCommªd_¥ecific
[2] = ((
ušt32_t
)((
ušt16_t
)
»que¡
->
LBA_couÁ
)) & (uint32_t)(0x0000ffff);

395 
	gsqe
->
	gPRP_’Œy_1
 = (
DATA_MEMORY_REGION
);

396 
	gsqe
->
	gPRP_’Œy_2
 = (
DATA_MEMORY_REGION
 + 0x1000);

399  
	gsqe
;

402 
	gIO_Flow_Ba£
::
Subm™_io_»que¡
(
Ho¡_IO_Reque¡
* 
»que¡
)

404 
SSD_deviû_ty³
) {

405 
Ho¡IÁ”çû_Ty³s
::
NVME
:

407 ià(
NVME_SQ_FULL
(
nvme_queue_·œ
è|| 
avaabË_commªd_ids
.
size
() == 0) {

408 
wa™šg_»que¡s
.
push_back
(
»que¡
);

410 ià(
	gnvme_soáw¬e_»que¡_queue
[*
avaabË_commªd_ids
.
begš
()] !ğ
NULL
) {

411 
PRINT_ERROR
("Unexpteced situation in IO_Flow_Base! Overwriting‡n unhandled I/O„equest inhe queue!")

413 
»que¡
->
IO_queue_šfo
 = *
avaabË_commªd_ids
.
begš
();

414 
	gnvme_soáw¬e_»que¡_queue
[*
avaabË_commªd_ids
.
begš
()] = 
»que¡
;

415 
	gavaabË_commªd_ids
.
”a£
(
avaabË_commªd_ids
.
begš
());

416 
	g»que¡_queue_š_memÜy
[
nvme_queue_·œ
.
SubmissiÚ_queue_
] = 
»que¡
;

417 
NVME_UPDATE_SQ_TAIL
(
nvme_queue_·œ
);

419 
	g»que¡
->
	gEnqueue_time
 = 
SimuÏtÜ
->
Time
();

420 
	gpc›_roÙ_com¶ex
->
Wr™e_to_deviû
(
nvme_queue_·œ
.
SubmissiÚ__»gi¡”_add»ss_Ú_deviû
,‚vme_queue_·œ.
SubmissiÚ_queue_
);

423 
	gHo¡IÁ”çû_Ty³s
::
SATA
:

424 
»que¡
->
Sourû_æow_id
 = 
æow_id
;

425 
	g§_hba
->
Subm™_io_»que¡
(
»que¡
);

430 
	gIO_Flow_Ba£
::
NVMe_upd©e_ªd_subm™_com¶‘iÚ_queue_
()

432 
nvme_queue_·œ
.
Com¶‘iÚ_queue_h—d
++;

433 ià(
	gnvme_queue_·œ
.
	gCom¶‘iÚ_queue_h—d
 =ğ
nvme_queue_·œ
.
Com¶‘iÚ_queue_size
) {

434 
nvme_queue_·œ
.
Com¶‘iÚ_queue_h—d
 = 0;

436 
	gpc›_roÙ_com¶ex
->
Wr™e_to_deviû
(
nvme_queue_·œ
.
Com¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
,‚vme_queue_·œ.
Com¶‘iÚ_queue_h—d
);

439 cÚ¡ 
NVMe_Queue_Paœ
* 
	gIO_Flow_Ba£
::
G‘_nvme_queue_·œ_šfo
()

441  &
nvme_queue_·œ
;

444 
LHA_ty³
 
	gIO_Flow_Ba£
::
G‘_¡¬t_l§_Ú_deviû
()

446  
¡¬t_l§_Ú_deviû
;

449 
LHA_ty³
 
	gIO_Flow_Ba£
::
G‘_’d_l§_add»ss_Ú_deviû
()

451  
’d_l§_Ú_deviû
;

454 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_g’”©ed_»que¡_couÁ
()

456  
STAT_g’”©ed_»que¡_couÁ
;

459 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_£rviûd_»que¡_couÁ
()

461  
STAT_£rviûd_»que¡_couÁ
;

464 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_deviû_»¥Ú£_time
()

466 ià(
STAT_£rviûd_»que¡_couÁ
 == 0) {

470  (
	gušt32_t
)(
	gSTAT_sum_deviû_»¥Ú£_time
 / 
	gSTAT_£rviûd_»que¡_couÁ
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

473 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_mš_deviû_»¥Ú£_time
()

475  (
ušt32_t
)(
STAT_mš_deviû_»¥Ú£_time
 / 
SIM_TIME_TO_MICROSECONDS_COEFF
);

478 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_max_deviû_»¥Ú£_time
()

480  (
ušt32_t
)(
STAT_max_deviû_»¥Ú£_time
 / 
SIM_TIME_TO_MICROSECONDS_COEFF
);

483 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_’d_to_’d_»que¡_d–ay
()

485 ià(
STAT_£rviûd_»que¡_couÁ
 == 0) {

489  (
	gušt32_t
)(
	gSTAT_sum_»que¡_d–ay
 / 
	gSTAT_£rviûd_»que¡_couÁ
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

492 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_mš_’d_to_’d_»que¡_d–ay
()

494  (
ušt32_t
)(
STAT_mš_»que¡_d–ay
 / 
SIM_TIME_TO_MICROSECONDS_COEFF
);

497 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_max_’d_to_’d_»que¡_d–ay
()

499  (
ušt32_t
)(
STAT_max_»que¡_d–ay
 / 
SIM_TIME_TO_MICROSECONDS_COEFF
);

502 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_deviû_»¥Ú£_time_shÜt_‹rm
()

504 ià(
STAT_£rviûd_»que¡_couÁ_shÜt_‹rm
 == 0) {

508  (
	gušt32_t
)(
	gSTAT_sum_deviû_»¥Ú£_time_shÜt_‹rm
 / 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

511 
ušt32_t
 
	gIO_Flow_Ba£
::
G‘_’d_to_’d_»que¡_d–ay_shÜt_‹rm
()

513 ià(
STAT_£rviûd_»que¡_couÁ
 == 0) {

517  (
	gušt32_t
)(
	gSTAT_sum_»que¡_d–ay_shÜt_‹rm
 / 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

520 
	gIO_Flow_Ba£
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

522 
¡d
::
¡ršg
 
tmp
 = 
Çme_´efix
 + ".IO_Flow";

523 
	gxmlwr™”
.
Wr™e_İ’_g
(
tmp
);

526 
	g¡d
::
¡ršg
 
©Œ
 = "Name";

527 
	g¡d
::
¡ršg
 
v®
 = 
ID
();

528 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

530 
	g©Œ
 = "Request_Count";

531 
	gv®
 = 
¡d
::
to_¡ršg
(
STAT_g’”©ed_»que¡_couÁ
);

532 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

534 
	g©Œ
 = "Read_Request_Count";

535 
	gv®
 = 
¡d
::
to_¡ršg
(
STAT_g’”©ed_»ad_»que¡_couÁ
);

536 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

538 
	g©Œ
 = "Write_Request_Count";

539 
	gv®
 = 
¡d
::
to_¡ršg
(
STAT_g’”©ed_wr™e_»que¡_couÁ
);

540 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

542 
	g©Œ
 = "IOPS";

543 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_g’”©ed_»que¡_couÁ
 / (
SimuÏtÜ
->
Time
(è/ 
SIM_TIME_TO_SECONDS_COEFF
));

544 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

546 
	g©Œ
 = "IOPS_Read";

547 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_g’”©ed_»ad_»que¡_couÁ
 / (
SimuÏtÜ
->
Time
(è/ 
SIM_TIME_TO_SECONDS_COEFF
));

548 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

550 
	g©Œ
 = "IOPS_Write";

551 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_g’”©ed_wr™e_»que¡_couÁ
 / (
SimuÏtÜ
->
Time
(è/ 
SIM_TIME_TO_SECONDS_COEFF
));

552 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

554 
	g©Œ
 = "Bytes_Transferred";

555 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_Œªsã¼ed_by‹s_tÙ®
);

556 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

558 
	g©Œ
 = "Bytes_Transferred_Read";

559 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_Œªsã¼ed_by‹s_»ad
);

560 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

562 
	g©Œ
 = "Bytes_Transferred_Write";

563 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_Œªsã¼ed_by‹s_wr™e
);

564 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

566 
	g©Œ
 = "Bandwidth";

567 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_Œªsã¼ed_by‹s_tÙ®
 / (
SimuÏtÜ
->
Time
(è/ 
SIM_TIME_TO_SECONDS_COEFF
));

568 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

570 
	g©Œ
 = "Bandwidth_Read";

571 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_Œªsã¼ed_by‹s_»ad
 / (
SimuÏtÜ
->
Time
(è/ 
SIM_TIME_TO_SECONDS_COEFF
));

572 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

574 
	g©Œ
 = "Bandwidth_Write";

575 
	gv®
 = 
¡d
::
to_¡ršg
(()
STAT_Œªsã¼ed_by‹s_wr™e
 / (
SimuÏtÜ
->
Time
(è/ 
SIM_TIME_TO_SECONDS_COEFF
));

576 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

579 
	g©Œ
 = "Device_Response_Time";

580 
	gv®
 = 
¡d
::
to_¡ršg
(
G‘_deviû_»¥Ú£_time
());

581 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

583 
	g©Œ
 = "Min_Device_Response_Time";

584 
	gv®
 = 
¡d
::
to_¡ršg
(
G‘_mš_deviû_»¥Ú£_time
());

585 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

587 
	g©Œ
 = "Max_Device_Response_Time";

588 
	gv®
 = 
¡d
::
to_¡ršg
(
G‘_max_deviû_»¥Ú£_time
());

589 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

591 
	g©Œ
 = "End_to_End_Request_Delay";

592 
	gv®
 = 
¡d
::
to_¡ršg
(
G‘_’d_to_’d_»que¡_d–ay
());

593 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

595 
	g©Œ
 = "Min_End_to_End_Request_Delay";

596 
	gv®
 = 
¡d
::
to_¡ršg
(
G‘_mš_’d_to_’d_»que¡_d–ay
());

597 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

599 
	g©Œ
 = "Max_End_to_End_Request_Delay";

600 
	gv®
 = 
¡d
::
to_¡ršg
(
G‘_max_’d_to_’d_»que¡_d–ay
());

601 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

603 
	gxmlwr™”
.
Wr™e_şo£_g
();

	@src/host/IO_Flow_Base.h

1 #iâdeà
IO_FLOW_BASE_H


2 
	#IO_FLOW_BASE_H


	)

4 
	~<¡ršg
>

5 
	~<io¡»am
>

6 
	~<unÜd”ed_m­
>

7 
	~<£t
>

8 
	~<li¡
>

9 
	~<veùÜ
>

10 
	~"../sim/Sim_Defs.h
"

11 
	~"../sim/Sim_Objeù.h
"

12 
	~"../sim/Sim_R•Ü‹r.h
"

13 
	~"../ssd/SSD_Defs.h
"

14 
	~"../ssd/Ho¡_IÁ”çû_Defs.h
"

15 
	~"Ho¡_IO_Reque¡.h
"

16 
	~"PCIe_RoÙ_Com¶ex.h
"

17 
	~"SATA_HBA.h
"

18 
	~"../uts/WÜklßd_Sti¡ics.h
"

20 
Çme¥aû
 
	gHo¡_CompÚ’ts


22 
	sNVMe_Queue_Paœ


24 
ušt16_t
 
	gSubmissiÚ_queue_h—d
;

25 
ušt16_t
 
	gSubmissiÚ_queue_
;

26 
ušt16_t
 
	gSubmissiÚ_queue_size
;

27 
ušt64_t
 
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
;

28 
ušt64_t
 
	gSubmissiÚ_queue_memÜy_ba£_add»ss
;

29 
ušt16_t
 
	gCom¶‘iÚ_queue_h—d
;

30 
ušt16_t
 
	gCom¶‘iÚ_queue_
;

31 
ušt16_t
 
	gCom¶‘iÚ_queue_size
;

32 
ušt64_t
 
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
;

33 
ušt64_t
 
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
;

36 
	#NVME_SQ_FULL
(
Q
è(Q.
SubmissiÚ_queue_
 < Q.
SubmissiÚ_queue_size
 - 1 ? Q.SubmissiÚ_queue_ + 1 =ğQ.
SubmissiÚ_queue_h—d
 : Q.SubmissiÚ_queue_h—d =ğ0)

	)

37 
	#NVME_UPDATE_SQ_TAIL
(
Q
èQ.
SubmissiÚ_queue_
++;\

38 ià(
Q
.
SubmissiÚ_queue_
 =ğQ.
SubmissiÚ_queue_size
)\

39 
nvme_queue_·œ
.
SubmissiÚ_queue_
 = 0;

	)

41 
şass
 
	gPCIe_RoÙ_Com¶ex
;

42 
şass
 
	gIO_Flow_Ba£
 : 
public
 
MQSimEngše
::
Sim_Objeù
,…ubliø
	gMQSimEngše
::
Sim_R•Ü‹r


44 
public
:

45 
IO_Flow_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
Çme
, 
ušt16_t
 
æow_id
, 
LHA_ty³
 
¡¬t_l§_Ú_deviû
, LHA_ty³ 
’d_l§_add»ss_Ú_deviû
, ušt16_ˆ
io_queue_id
,

46 
ušt16_t
 
nvme_submissiÚ_queue_size
, ušt16_ˆ
nvme_com¶‘iÚ_queue_size
, 
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
,

47 
sim_time_ty³
 
¡İ_time
, 
š™Ÿl_occu·ncy_¿tio
, 
tÙ®_»qu‘s_to_be_g’”©ed
,

48 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
SATA_HBA
* 
§_hba
,

49 
boŞ
 
’abËd_loggšg
, 
sim_time_ty³
 
loggšg_³riod
, 
¡d
::
¡ršg
 
loggšg_fe_·th
);

50 ~
IO_Flow_Ba£
();

51 
S¹_simuÏtiÚ
();

52 
IO_Flow_PriÜ™y_CÏss
 
PriÜ™y_şass
(è{  
	g´iÜ™y_şass
; }

53 
vœtu®
 
Ho¡_IO_Reque¡
* 
G’”©e_Ãxt_»que¡
() = 0;

54 
vœtu®
 
NVMe_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
*);

55 
SubmissiÚ_Queue_EÁry
* 
NVMe_»ad_sqe
(
ušt64_t
 
add»ss
);

56 cÚ¡ 
NVMe_Queue_Paœ
* 
G‘_nvme_queue_·œ_šfo
();

57 
vœtu®
 
SATA_cÚsume_io_»que¡
(
Ho¡_IO_Reque¡
* 
»que¡
);

58 
LHA_ty³
 
G‘_¡¬t_l§_Ú_deviû
();

59 
LHA_ty³
 
G‘_’d_l§_add»ss_Ú_deviû
();

60 
ušt32_t
 
G‘_g’”©ed_»que¡_couÁ
();

61 
ušt32_t
 
G‘_£rviûd_»que¡_couÁ
();

62 
ušt32_t
 
G‘_deviû_»¥Ú£_time
();

63 
ušt32_t
 
G‘_mš_deviû_»¥Ú£_time
();

64 
ušt32_t
 
G‘_max_deviû_»¥Ú£_time
();

65 
ušt32_t
 
G‘_’d_to_’d_»que¡_d–ay
();

66 
ušt32_t
 
G‘_mš_’d_to_’d_»que¡_d–ay
();

67 
ušt32_t
 
G‘_max_’d_to_’d_»que¡_d–ay
();

68 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

69 
vœtu®
 
G‘_¡©i¡ics
(
Uts
::
WÜklßd_Sti¡ics
& 
¡©s
, 
LPA_ty³
(*
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
)(
LHA_ty³
 
lha
),

70 
·ge_¡©us_ty³
(*
Fšd_NVM_subun™_acûss_b™m­
)(
LHA_ty³
 
lha
)) = 0;

71 
	g´Ùeùed
:

72 
ušt16_t
 
æow_id
;

73 
	gš™Ÿl_occu·ncy_¿tio
;

74 
sim_time_ty³
 
	g¡İ_time
;

75 
	gtÙ®_»que¡s_to_be_g’”©ed
;

76 
Ho¡IÁ”çû_Ty³s
 
	gSSD_deviû_ty³
;

77 
PCIe_RoÙ_Com¶ex
* 
	gpc›_roÙ_com¶ex
;

78 
SATA_HBA
* 
	g§_hba
;

79 
LHA_ty³
 
	g¡¬t_l§_Ú_deviû
, 
	g’d_l§_Ú_deviû
;

81 
Subm™_io_»que¡
(
Ho¡_IO_Reque¡
*);

84 
IO_Flow_PriÜ™y_CÏss
 
	g´iÜ™y_şass
;

85 
NVMe_Queue_Paœ
 
	gnvme_queue_·œ
;

86 
ušt16_t
 
	gio_queue_id
;

87 
ušt16_t
 
	gnvme_submissiÚ_queue_size
;

88 
ušt16_t
 
	gnvme_com¶‘iÚ_queue_size
;

89 
	g¡d
::
£t
<
ušt16_t
> 
avaabË_commªd_ids
;

90 
	g¡d
::
veùÜ
<
Ho¡_IO_Reque¡
*> 
»que¡_queue_š_memÜy
;

91 
	g¡d
::
li¡
<
Ho¡_IO_Reque¡
*> 
wa™šg_»que¡s
;

92 
	g¡d
::
unÜd”ed_m­
<
sim_time_ty³
, 
	gHo¡_IO_Reque¡
*> 
	gnvme_soáw¬e_»que¡_queue
;

93 
NVMe_upd©e_ªd_subm™_com¶‘iÚ_queue_
();

96 
	gSTAT_g’”©ed_»que¡_couÁ
, 
	gSTAT_g’”©ed_»ad_»que¡_couÁ
, 
	gSTAT_g’”©ed_wr™e_»que¡_couÁ
;

97 
	gSTAT_ignÜed_»que¡_couÁ
;

98 
	gSTAT_£rviûd_»que¡_couÁ
, 
	gSTAT_£rviûd_»ad_»que¡_couÁ
, 
	gSTAT_£rviûd_wr™e_»que¡_couÁ
;

99 
sim_time_ty³
 
	gSTAT_sum_deviû_»¥Ú£_time
, 
	gSTAT_sum_deviû_»¥Ú£_time_»ad
, 
	gSTAT_sum_deviû_»¥Ú£_time_wr™e
;

100 
sim_time_ty³
 
	gSTAT_mš_deviû_»¥Ú£_time
, 
	gSTAT_mš_deviû_»¥Ú£_time_»ad
, 
	gSTAT_mš_deviû_»¥Ú£_time_wr™e
;

101 
sim_time_ty³
 
	gSTAT_max_deviû_»¥Ú£_time
, 
	gSTAT_max_deviû_»¥Ú£_time_»ad
, 
	gSTAT_max_deviû_»¥Ú£_time_wr™e
;

102 
sim_time_ty³
 
	gSTAT_sum_»que¡_d–ay
, 
	gSTAT_sum_»que¡_d–ay_»ad
, 
	gSTAT_sum_»que¡_d–ay_wr™e
;

103 
sim_time_ty³
 
	gSTAT_mš_»que¡_d–ay
, 
	gSTAT_mš_»que¡_d–ay_»ad
, 
	gSTAT_mš_»que¡_d–ay_wr™e
;

104 
sim_time_ty³
 
	gSTAT_max_»que¡_d–ay
, 
	gSTAT_max_»que¡_d–ay_»ad
, 
	gSTAT_max_»que¡_d–ay_wr™e
;

105 
sim_time_ty³
 
	gSTAT_Œªsã¼ed_by‹s_tÙ®
, 
	gSTAT_Œªsã¼ed_by‹s_»ad
, 
	gSTAT_Œªsã¼ed_by‹s_wr™e
;

106 
	g´og»ss
;

107 
	gÃxt_´og»ss_¡•
 = 0;

110 
boŞ
 
	g’abËd_loggšg
;

111 
sim_time_ty³
 
	gloggšg_³riod
;

112 
sim_time_ty³
 
	gÃxt_loggšg_me¡Úe
;

113 
	g¡d
::
¡ršg
 
loggšg_fe_·th
;

114 
	g¡d
::
of¡»am
 
log_fe
;

115 
ušt32_t
 
G‘_deviû_»¥Ú£_time_shÜt_‹rm
();

116 
ušt32_t
 
G‘_’d_to_’d_»que¡_d–ay_shÜt_‹rm
();

117 
sim_time_ty³
 
	gSTAT_sum_deviû_»¥Ú£_time_shÜt_‹rm
, 
	gSTAT_sum_»que¡_d–ay_shÜt_‹rm
;

118 
	gSTAT_£rviûd_»que¡_couÁ_shÜt_‹rm
;

	@src/host/IO_Flow_Synthetic.cpp

1 
	~<m©h.h
>

2 
	~<¡dexû±
>

3 
	~"../sim/Engše.h
"

4 
	~"IO_Flow_SyÁh‘ic.h
"

6 
Çme¥aû
 
	gHo¡_CompÚ’ts


8 
	gIO_Flow_SyÁh‘ic
::
IO_Flow_SyÁh‘ic
(cÚ¡ 
sim_objeù_id_ty³
& 
Çme
, 
ušt16_t
 
æow_id
,

9 
LHA_ty³
 
¡¬t_l§_Ú_deviû
, LHA_ty³ 
’d_l§_Ú_deviû
, 
wÜkšg_£t_¿tio
, 
ušt16_t
 
io_queue_id
,

10 
ušt16_t
 
nvme_submissiÚ_queue_size
, ušt16_ˆ
nvme_com¶‘iÚ_queue_size
, 
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
,

11 
»ad_¿tio
, 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
 
add»ss_di¡ributiÚ
, 
hÙ_»giÚ_¿tio
,

12 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
 
»que¡_size_di¡ributiÚ
, 
av”age_»que¡_size
, 
v¬Ÿnû_»que¡_size
,

13 
Uts
::
Reque¡_G’”©Ü_Ty³
 
g’”©Ü_ty³
, 
sim_time_ty³
 
Av”age_š‹r_¬riv®_time_Çno_£c
, 
av”age_numb”_of_’queued_»que¡s
,

14 
boŞ
 
g’”©e_®igÃd_add»s£s
, 
®ignm’t_v®ue
,

15 
£ed
, 
sim_time_ty³
 
¡İ_time
, 
š™Ÿl_occu·ncy_¿tio
, 
tÙ®_»q_couÁ
, 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
SATA_HBA
* 
§_hba
,

16 
boŞ
 
’abËd_loggšg
, 
sim_time_ty³
 
loggšg_³riod
, 
¡d
::
¡ršg
 
loggšg_fe_·th
) :

17 
IO_Flow_Ba£
(
Çme
, 
æow_id
, 
¡¬t_l§_Ú_deviû
, 
LHA_ty³
(¡¬t_l§_Ú_deviû + (
’d_l§_Ú_deviû
 - s¹_l§_Ú_deviûè* 
wÜkšg_£t_¿tio
), 
io_queue_id
, 
nvme_submissiÚ_queue_size
, 
nvme_com¶‘iÚ_queue_size
, 
´iÜ™y_şass
, 
¡İ_time
, 
š™Ÿl_occu·ncy_¿tio
, 
tÙ®_»q_couÁ
, 
SSD_deviû_ty³
, 
pc›_roÙ_com¶ex
, 
§_hba
, 
’abËd_loggšg
, 
loggšg_³riod
, 
loggšg_fe_·th
),

18 
»ad_¿tio
Ô—d_¿tio), 
add»ss_di¡ributiÚ
(address_distribution),

19 
wÜkšg_£t_¿tio
(wÜkšg_£t_¿tio), 
hÙ_»giÚ_¿tio
(hot_region_ratio),

20 
»que¡_size_di¡ributiÚ
Ôeque¡_size_di¡ributiÚ), 
av”age_»que¡_size
×v”age_»que¡_size), 
v¬Ÿnû_»que¡_size
(variance_request_size),

21 
g’”©Ü_ty³
(g’”©Ü_ty³), 
Av”age_š‹r_¬riv®_time_Çno_£c
(Av”age_š‹r_¬riv®_time_Çno_£c), 
av”age_numb”_of_’queued_»que¡s
(average_number_of_enqueued_requests),

22 
£ed
(£ed), 
g’”©e_®igÃd_add»s£s
(g’”©e_®igÃd_add»s£s), 
®ignm’t_v®ue
(alignment_value)

25 ià(
	g»ad_¿tio
 == 0.0) {

26 
»ad_¿tio
 = -1.0;

28 
	g¿ndom_»que¡_ty³_g’”©Ü_£ed
 = 
£ed
++;

29 
	g¿ndom_»que¡_ty³_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¿ndom_»que¡_ty³_g’”©Ü_£ed
);

30 
	g¿ndom_add»ss_g’”©Ü_£ed
 = 
£ed
++;

31 
	g¿ndom_add»ss_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¿ndom_add»ss_g’”©Ü_£ed
);

32 ià(
	gthis
->
	g¡¬t_l§_Ú_deviû
 >his->
	g’d_l§_Ú_deviû
) {

33 
throw
 
	g¡d
::
logic_”rÜ
("Problem in IO Flow Synthetic,he start LBA‡ddress is greaterhanheƒnd LBA‡ddress");

36 ià(
	gadd»ss_di¡ributiÚ
 =ğ
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
) {

37 
¿ndom_hÙ_add»ss_g’”©Ü_£ed
 = 
£ed
++;

38 
	g¿ndom_hÙ_add»ss_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¿ndom_hÙ_add»ss_g’”©Ü_£ed
);

39 
	g¿ndom_hÙ_cŞd_g’”©Ü_£ed
 = 
£ed
++;

40 
	g¿ndom_hÙ_cŞd_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¿ndom_hÙ_cŞd_g’”©Ü_£ed
);

41 
	ghÙ_»giÚ_’d_l§
 = 
this
->
¡¬t_l§_Ú_deviû
 + (
LHA_ty³
)(()Ñhis->
’d_l§_Ú_deviû
 -his->¡¬t_l§_Ú_deviûè* 
hÙ_»giÚ_¿tio
);

44 ià(
	g»que¡_size_di¡ributiÚ
 =ğ
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
NORMAL
) {

45 
¿ndom_»que¡_size_g’”©Ü_£ed
 = 
£ed
++;

46 
	g¿ndom_»que¡_size_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¿ndom_»que¡_size_g’”©Ü_£ed
);

49 ià(
	gg’”©Ü_ty³
 =ğ
Uts
::
Reque¡_G’”©Ü_Ty³
::
BANDWIDTH
) {

50 
¿ndom_time_š‹rv®_g’”©Ü_£ed
 = 
£ed
++;

51 
	g¿ndom_time_š‹rv®_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¿ndom_time_š‹rv®_g’”©Ü_£ed
);

54 ià(
	gthis
->
	gwÜkšg_£t_¿tio
 == 0) {

55 
PRINT_ERROR
("ThwÜkšg s‘„©iØi £ˆtØz”ØfÜ wÜklßd " << 
Çme
)

59 
	gIO_Flow_SyÁh‘ic
::~
IO_Flow_SyÁh‘ic
()

61 
d–‘e
 
¿ndom_»que¡_ty³_g’”©Ü
;

62 
d–‘e
 
	g¿ndom_add»ss_g’”©Ü
;

63 
d–‘e
 
	g¿ndom_hÙ_cŞd_g’”©Ü
;

64 
d–‘e
 
	g¿ndom_hÙ_add»ss_g’”©Ü
;

65 
d–‘e
 
	g¿ndom_»que¡_size_g’”©Ü
;

66 
d–‘e
 
	g¿ndom_time_š‹rv®_g’”©Ü
;

69 
Ho¡_IO_Reque¡
* 
	gIO_Flow_SyÁh‘ic
::
G’”©e_Ãxt_»que¡
()

71 ià(
¡İ_time
 > 0) {

72 ià(
SimuÏtÜ
->
Time
(è> 
¡İ_time
) {

73  
NULL
;

75 } ià(
	gSTAT_g’”©ed_»que¡_couÁ
 >ğ
tÙ®_»que¡s_to_be_g’”©ed
) {

76  
NULL
;

79 
Ho¡_IO_Reque¡
* 
	g»que¡
 = 
Ãw
 Host_IO_Request;

80 ià(
	g¿ndom_»que¡_ty³_g’”©Ü
->
UnifÜm
(0, 1è<ğ
»ad_¿tio
) {

81 
»que¡
->
Ty³
 = 
Ho¡_IO_Reque¡_Ty³
::
READ
;

82 
	gSTAT_g’”©ed_»ad_»que¡_couÁ
++;

84 
	g»que¡
->
	gTy³
 = 
Ho¡_IO_Reque¡_Ty³
::
WRITE
;

85 
	gSTAT_g’”©ed_wr™e_»que¡_couÁ
++;

88 
	g»que¡_size_di¡ributiÚ
) {

89 
	gUts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
FIXED
:

90 
»que¡
->
LBA_couÁ
 = 
av”age_»que¡_size
;

92 
	gUts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
NORMAL
:

94 
‹mp_»que¡_size
 = 
¿ndom_»que¡_size_g’”©Ü
->
NÜm®
(
av”age_»que¡_size
, 
v¬Ÿnû_»que¡_size
);

95 
	g»que¡
->
	gLBA_couÁ
 = ()(
û
(
‹mp_»que¡_size
));

96 ià(
	g»que¡
->
	gLBA_couÁ
 <= 0) {

97 
»que¡
->
LBA_couÁ
 = 1;

102 
throw
 
¡d
::
šv®id_¬gum’t
("Uknown distributionype for„equset size.");

105 
	gadd»ss_di¡ributiÚ
) {

106 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

107 
»que¡
->
S¹_LBA
 = 
¡»amšg_Ãxt_add»ss
;

108 ià(
	g»que¡
->
	gS¹_LBA
 +„eque¡->
	gLBA_couÁ
 > 
	g’d_l§_Ú_deviû
) {

109 
	g»que¡
->
	gS¹_LBA
 = 
¡¬t_l§_Ú_deviû
;

111 
	g¡»amšg_Ãxt_add»ss
 +ğ
»que¡
->
LBA_couÁ
;

112 ià(
	g¡»amšg_Ãxt_add»ss
 > 
	g’d_l§_Ú_deviû
) {

113 
	g¡»amšg_Ãxt_add»ss
 = 
¡¬t_l§_Ú_deviû
;

115 ià(
	gg’”©e_®igÃd_add»s£s
) {

116 if(
	g¡»amšg_Ãxt_add»ss
 % 
	g®ignm’t_v®ue
 != 0) {

117 
¡»amšg_Ãxt_add»ss
 +ğ
®ignm’t_v®ue
 - (streaming_next_address %‡lignment_value);

120 if(
	g¡»amšg_Ãxt_add»ss
 =ğ
»que¡
->
S¹_LBA
) {

121 
PRINT_MESSAGE
("Synthetic Message Generator: The same‡ddress is‡lways„epeated dueo configuration…arameters!")

124 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

126 ià(
¿ndom_hÙ_cŞd_g’”©Ü
->
UnifÜm
(0, 1è< 
	ghÙ_»giÚ_¿tio
) {

127 
	g»que¡
->
	gS¹_LBA
 = 
¿ndom_hÙ_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
hÙ_»giÚ_’d_l§
 + 1, 
’d_l§_Ú_deviû
);

128 ià(
	g»que¡
->
	gS¹_LBA
 < 
	ghÙ_»giÚ_’d_l§
 + 1 ||„eque¡->S¹_LBA > 
	g’d_l§_Ú_deviû
) {

129 
PRINT_ERROR
("Out of„ange‡ddress is generated in IO_Flow_Synthetic!\n")

130 ià(
	g»que¡
->
	gS¹_LBA
 +„eque¡->
	gLBA_couÁ
 > 
	g’d_l§_Ú_deviû
) {

131 
	g»que¡
->
	gS¹_LBA
 = 
hÙ_»giÚ_’d_l§
 + 1;

135 
	g»que¡
->
	gS¹_LBA
 = 
¿ndom_hÙ_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
¡¬t_l§_Ú_deviû
, 
hÙ_»giÚ_’d_l§
);

136 ià(
	g»que¡
->
	gS¹_LBA
 < 
	g¡¬t_l§_Ú_deviû
 ||„eque¡->S¹_LBA > 
	ghÙ_»giÚ_’d_l§
) {

137 
PRINT_ERROR
("Out of„ange‡ddress is generated in IO_Flow_Synthetic!\n")

141 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

142 
»que¡
->
S¹_LBA
 = 
¿ndom_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
¡¬t_l§_Ú_deviû
, 
’d_l§_Ú_deviû
);

143 ià(
	g»que¡
->
	gS¹_LBA
 < 
	g¡¬t_l§_Ú_deviû
 ||„eque¡->S¹_LBA > 
	g’d_l§_Ú_deviû
) {

144 
PRINT_ERROR
("Out of„ange‡ddress is generated in IO_Flow_Synthetic!\n")

146 ià(
	g»que¡
->
	gS¹_LBA
 +„eque¡->
	gLBA_couÁ
 > 
	g’d_l§_Ú_deviû
) {

147 
	g»que¡
->
	gS¹_LBA
 = 
¡¬t_l§_Ú_deviû
;

151 
PRINT_ERROR
("Unknown‡ddress distributionype!\n")

154 ià(
g’”©e_®igÃd_add»s£s
) {

155 
»que¡
->
S¹_LBA
 -ğ»que¡->S¹_LBA % 
®ignm’t_v®ue
;

157 
	gSTAT_g’”©ed_»que¡_couÁ
++;

158 
	g»que¡
->
	gA¼iv®_time
 = 
SimuÏtÜ
->
Time
();

159 
DEBUG
("* Ho¡: Reque¡ g’”©ed - " << (
»que¡
->
Ty³
 =ğ
Ho¡_IO_Reque¡_Ty³
::
READ
 ? "R—d, " : "Wr™e, "è<< "LBA:" <<„eque¡->
S¹_LBA
 << ", Size_š_by‹s:" <<„eque¡->
LBA_couÁ
 << "")

161  
»que¡
;

164 
	gIO_Flow_SyÁh‘ic
::
NVMe_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
* 
io_»que¡
)

166 
IO_Flow_Ba£
::
NVMe_cÚsume_io_»que¡
(
io_»que¡
);

167 
	gIO_Flow_Ba£
::
NVMe_upd©e_ªd_subm™_com¶‘iÚ_queue_
();

168 ià(
	gg’”©Ü_ty³
 =ğ
Uts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
) {

169 
Ho¡_IO_Reque¡
* 
»que¡
 = 
G’”©e_Ãxt_»que¡
();

173 ià(
	g»que¡
 !ğ
NULL
) {

174 
Subm™_io_»que¡
(
»que¡
);

179 
	gIO_Flow_SyÁh‘ic
::
SATA_cÚsume_io_»que¡
(
Ho¡_IO_Reque¡
* 
io_»que¡
)

181 
IO_Flow_Ba£
::
SATA_cÚsume_io_»que¡
(
io_»que¡
);

182 ià(
	gg’”©Ü_ty³
 =ğ
Uts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
) {

183 
Ho¡_IO_Reque¡
* 
»que¡
 = 
G’”©e_Ãxt_»que¡
();

186 ià(
	g»que¡
 !ğ
NULL
) {

187 
Subm™_io_»que¡
(
»que¡
);

192 
	gIO_Flow_SyÁh‘ic
::
S¹_simuÏtiÚ
()

194 
IO_Flow_Ba£
::
S¹_simuÏtiÚ
();

196 ià(
	gadd»ss_di¡ributiÚ
 =ğ
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
) {

197 
¡»amšg_Ãxt_add»ss
 = 
¿ndom_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
¡¬t_l§_Ú_deviû
, 
’d_l§_Ú_deviû
);

198 ià(
	gg’”©e_®igÃd_add»s£s
) {

199 
	g¡»amšg_Ãxt_add»ss
 -ğ
¡»amšg_Ãxt_add»ss
 % 
®ignm’t_v®ue
;

203 ià(
	gg’”©Ü_ty³
 =ğ
Uts
::
Reque¡_G’”©Ü_Ty³
::
BANDWIDTH
) {

204 
SimuÏtÜ
->
Regi¡”_sim_ev’t
((
sim_time_ty³
)
¿ndom_time_š‹rv®_g’”©Ü
->
ExpÚ’tŸl
(()
Av”age_š‹r_¬riv®_time_Çno_£c
), 
this
, 0, 0);

206 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
((
sim_time_ty³
)1, 
this
, 0, 0);

210 
	gIO_Flow_SyÁh‘ic
::
V®id©e_simuÏtiÚ_cÚfig
()

214 
IO_Flow_SyÁh‘ic
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

216 ià(
g’”©Ü_ty³
 =ğ
Uts
::
Reque¡_G’”©Ü_Ty³
::
BANDWIDTH
) {

217 
Ho¡_IO_Reque¡
* 
»q
 = 
G’”©e_Ãxt_»que¡
();

218 ià(
	g»q
 !ğ
NULL
) {

219 
Subm™_io_»que¡
(
»q
);

220 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ (
sim_time_ty³
)
¿ndom_time_š‹rv®_g’”©Ü
->
ExpÚ’tŸl
(()
Av”age_š‹r_¬riv®_time_Çno_£c
), 
this
, 0, 0);

223 
	gi
 = 0; i < 
	gav”age_numb”_of_’queued_»que¡s
; i++) {

224 
Subm™_io_»que¡
(
G’”©e_Ãxt_»que¡
());

229 
	gIO_Flow_SyÁh‘ic
::
G‘_¡©i¡ics
(
Uts
::
WÜklßd_Sti¡ics
& 
¡©s
, 
LPA_ty³
(*
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
)(
LHA_ty³
 
lha
),

230 
·ge_¡©us_ty³
(*
Fšd_NVM_subun™_acûss_b™m­
)(
LHA_ty³
 
lha
))

232 
	g¡©s
.
	gTy³
 = 
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
;

233 
	g¡©s
.
	gg’”©Ü_ty³
 = 
g’”©Ü_ty³
;

234 
	g¡©s
.
	gSŒ—m_id
 = 
io_queue_id
 - 1;

235 
	g¡©s
.
	gIn™Ÿl_occu·ncy_¿tio
 = 
š™Ÿl_occu·ncy_¿tio
;

236 
	g¡©s
.
	gWÜkšg_£t_¿tio
 = 
wÜkšg_£t_¿tio
;

237 
	g¡©s
.
	gR—d_¿tio
 = 
»ad_¿tio
;

238 
	g¡©s
.
	g¿ndom_»que¡_ty³_g’”©Ü_£ed
 = 
¿ndom_»que¡_ty³_g’”©Ü_£ed
;

239 
	g¡©s
.
	gAdd»ss_di¡ributiÚ_ty³
 = 
add»ss_di¡ributiÚ
;

240 
	g¡©s
.
	gR©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
 = 
hÙ_»giÚ_¿tio
;

241 
	g¡©s
.
	gR©io_of_Œaffic_acûssšg_hÙ_»giÚ
 = 1 - 
hÙ_»giÚ_¿tio
;

242 
	g¡©s
.
	g¿ndom_add»ss_g’”©Ü_£ed
 = 
¿ndom_add»ss_g’”©Ü_£ed
;

243 
	g¡©s
.
	g¿ndom_hÙ_add»ss_g’”©Ü_£ed
 = 
¿ndom_hÙ_add»ss_g’”©Ü_£ed
;

244 
	g¡©s
.
	g¿ndom_hÙ_cŞd_g’”©Ü_£ed
 = 
¿ndom_hÙ_cŞd_g’”©Ü_£ed
;

245 
	g¡©s
.
	gg’”©e_®igÃd_add»s£s
 = 
g’”©e_®igÃd_add»s£s
;

246 
	g¡©s
.
	g®ignm’t_v®ue
 = 
®ignm’t_v®ue
;

247 
	g¡©s
.
	gReque¡_size_di¡ributiÚ_ty³
 = 
»que¡_size_di¡ributiÚ
;

248 
	g¡©s
.
	gAv”age_»que¡_size_£ùÜ
 = 
av”age_»que¡_size
;

249 
	g¡©s
.
	gSTDEV_»uqe¡_size
 = 
v¬Ÿnû_»que¡_size
;

250 
	g¡©s
.
	g¿ndom_»que¡_size_g’”©Ü_£ed
 = 
¿ndom_»que¡_size_g’”©Ü_£ed
;

251 
	g¡©s
.
	gReque¡_queue_d•th
 = 
av”age_numb”_of_’queued_»que¡s
;

252 
	g¡©s
.
	g¿ndom_time_š‹rv®_g’”©Ü_£ed
 = 
¿ndom_time_š‹rv®_g’”©Ü_£ed
;

253 
	g¡©s
.
	gAv”age_š‹r_¬riv®_time_Çno_£c
 = 
Av”age_š‹r_¬riv®_time_Çno_£c
;

254 
	g¡©s
.
	gMš_LHA
 = 
¡¬t_l§_Ú_deviû
;

255 
	g¡©s
.
	gMax_LHA
 = 
’d_l§_Ú_deviû
;

	@src/host/IO_Flow_Synthetic.h

1 #iâdeà
IO_FLOW_SYNTHETIC_H


2 
	#IO_FLOW_SYNTHETIC_H


	)

4 
	~<¡ršg
>

5 
	~"IO_Flow_Ba£.h
"

6 
	~"../uts/RªdomG’”©Ü.h
"

7 
	~"../uts/Di¡ributiÚTy³s.h
"

9 
Çme¥aû
 
	gHo¡_CompÚ’ts


11 şas 
	cIO_Flow_SyÁh‘ic
 : 
public
 
IO_Flow_Ba£


13 
public
:

14 
IO_Flow_SyÁh‘ic
(cÚ¡ 
sim_objeù_id_ty³
& 
Çme
, 
ušt16_t
 
æow_id
, 
LHA_ty³
 
¡¬t_l§_Ú_deviû
, LHA_ty³ 
’d_l§_Ú_deviû
, 
wÜkšg_£t_¿tio
, ušt16_ˆ
io_queue_id
,

15 
ušt16_t
 
nvme_submissiÚ_queue_size
, ušt16_ˆ
nvme_com¶‘iÚ_queue_size
, 
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
,

16 
»ad_¿tio
, 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
 
add»ss_di¡ributiÚ
, 
hÙ_add»ss_¿tio
,

17 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
 
»que¡_size_di¡ributiÚ
, 
av”age_»que¡_size
, 
v¬Ÿnû_»que¡_size
,

18 
Uts
::
Reque¡_G’”©Ü_Ty³
 
g’”©Ü_ty³
, 
sim_time_ty³
 
Av”age_š‹r_¬riv®_time_Çno_£c
, 
av”age_numb”_of_’queued_»que¡s
,

19 
boŞ
 
g’”©e_®igÃd_add»s£s
, 
®ignm’t_v®ue
,

20 
£ed
, 
sim_time_ty³
 
¡İ_time
, 
š™Ÿl_occu·ncy_¿tio
, 
tÙ®_»q_couÁ
, 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
SATA_HBA
* 
§_hba
,

21 
boŞ
 
’abËd_loggšg
, 
sim_time_ty³
 
loggšg_³riod
, 
¡d
::
¡ršg
 
loggšg_fe_·th
);

22 ~
IO_Flow_SyÁh‘ic
();

23 
Ho¡_IO_Reque¡
* 
G’”©e_Ãxt_»que¡
();

24 
NVMe_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
*);

25 
SATA_cÚsume_io_»que¡
(
Ho¡_IO_Reque¡
*);

26 
S¹_simuÏtiÚ
();

27 
V®id©e_simuÏtiÚ_cÚfig
();

28 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

29 
G‘_¡©i¡ics
(
Uts
::
WÜklßd_Sti¡ics
& 
¡©s
, 
LPA_ty³
(*
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
)(
LHA_ty³
 
lha
),

30 
·ge_¡©us_ty³
(*
Fšd_NVM_subun™_acûss_b™m­
)(
LHA_ty³
 
lha
));

31 
	g´iv©e
:

32 
»ad_¿tio
;

33 
	gwÜkšg_£t_¿tio
;

34 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_»que¡_ty³_g’”©Ü
;

35 
	g¿ndom_»que¡_ty³_g’”©Ü_£ed
;

36 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
 
add»ss_di¡ributiÚ
;

37 
	ghÙ_»giÚ_¿tio
;

38 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_add»ss_g’”©Ü
;

39 
	g¿ndom_add»ss_g’”©Ü_£ed
;

40 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_hÙ_cŞd_g’”©Ü
;

41 
	g¿ndom_hÙ_cŞd_g’”©Ü_£ed
;

42 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_hÙ_add»ss_g’”©Ü
;

43 
	g¿ndom_hÙ_add»ss_g’”©Ü_£ed
;

44 
LHA_ty³
 
	ghÙ_»giÚ_’d_l§
;

45 
LHA_ty³
 
	g¡»amšg_Ãxt_add»ss
;

46 
	gUts
::
Reque¡_Size_Di¡ributiÚ_Ty³
 
»que¡_size_di¡ributiÚ
;

47 
	gav”age_»que¡_size
;

48 
	gv¬Ÿnû_»que¡_size
;

49 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_»que¡_size_g’”©Ü
;

50 
	g¿ndom_»que¡_size_g’”©Ü_£ed
;

51 
	gUts
::
Reque¡_G’”©Ü_Ty³
 
g’”©Ü_ty³
;

52 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_time_š‹rv®_g’”©Ü
;

53 
	g¿ndom_time_š‹rv®_g’”©Ü_£ed
;

54 
sim_time_ty³
 
	gAv”age_š‹r_¬riv®_time_Çno_£c
;

55 
	gav”age_numb”_of_’queued_»que¡s
;

56 
boŞ
 
	gg’”©e_®igÃd_add»s£s
;

57 
	g®ignm’t_v®ue
;

58 
	g£ed
;

	@src/host/IO_Flow_Trace_Based.cpp

1 
	~"IO_Flow_T¿û_Ba£d.h
"

2 
	~"../uts/SŒšgToŞs.h
"

3 
	~"ASCII_T¿û_Defš™iÚ.h
"

4 
	~"../uts/Di¡ributiÚTy³s.h
"

6 
Çme¥aû
 
	gHo¡_CompÚ’ts


8 
	gIO_Flow_T¿û_Ba£d
::
IO_Flow_T¿û_Ba£d
(cÚ¡ 
sim_objeù_id_ty³
& 
Çme
, 
ušt16_t
 
æow_id
, 
LHA_ty³
 
¡¬t_l§_Ú_deviû
, LHA_ty³ 
’d_l§_Ú_deviû
, ušt16_ˆ
io_queue_id
,

9 
ušt16_t
 
nvme_submissiÚ_queue_size
, ušt16_ˆ
nvme_com¶‘iÚ_queue_size
, 
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
š™Ÿl_occu·ncy_¿tio
,

10 
¡d
::
¡ršg
 
Œaû_fe_·th
, 
T¿û_Time_Un™
 
time_un™
, 
tÙ®_»¶ay_couÁ
, 
³rûÁage_to_be_simuÏ‹d
,

11 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
SATA_HBA
* 
§_hba
,

12 
boŞ
 
’abËd_loggšg
, 
sim_time_ty³
 
loggšg_³riod
, 
¡d
::
¡ršg
 
loggšg_fe_·th
) :

13 
IO_Flow_Ba£
(
Çme
, 
æow_id
, 
¡¬t_l§_Ú_deviû
, 
’d_l§_Ú_deviû
, 
io_queue_id
, 
nvme_submissiÚ_queue_size
, 
nvme_com¶‘iÚ_queue_size
, 
´iÜ™y_şass
, 0, 
š™Ÿl_occu·ncy_¿tio
, 0, 
SSD_deviû_ty³
, 
pc›_roÙ_com¶ex
, 
§_hba
, 
’abËd_loggšg
, 
loggšg_³riod
, 
loggšg_fe_·th
),

14 
Œaû_fe_·th
Ñ¿û_fe_·th), 
time_un™
Ñime_un™), 
tÙ®_»¶ay_no
(
tÙ®_»¶ay_couÁ
), 
³rûÁage_to_be_simuÏ‹d
(percentage_to_be_simulated),

15 
tÙ®_»que¡s_š_fe
(0), 
time_off£t
(0)

17 ià(
	g³rûÁage_to_be_simuÏ‹d
 > 100) {

18 
	g³rûÁage_to_be_simuÏ‹d
 = 100;

19 
PRINT_MESSAGE
("Bad value for…ercentage ofrace file! It is seto 100 % ");

23 
	gIO_Flow_T¿û_Ba£d
::~
IO_Flow_T¿û_Ba£d
()

27 
Ho¡_IO_Reque¡
* 
IO_Flow_T¿û_Ba£d
::
G’”©e_Ãxt_»que¡
()

29 ià(
cu¼’t_Œaû_lše
.
size
(è=ğ0 || 
STAT_g’”©ed_»que¡_couÁ
 >ğ
tÙ®_»que¡s_to_be_g’”©ed
) {

30  
NULL
;

33 
Ho¡_IO_Reque¡
* 
	g»que¡
 = 
Ãw
 Host_IO_Request;

34 ià(
	gcu¼’t_Œaû_lše
[
ASCIIT¿ûTy³CŞumn
].
com·»
(
ASCIIT¿ûWr™eCode
) == 0) {

35 
»que¡
->
Ty³
 = 
Ho¡_IO_Reque¡_Ty³
::
WRITE
;

36 
	gSTAT_g’”©ed_wr™e_»que¡_couÁ
++;

38 
	g»que¡
->
	gTy³
 = 
Ho¡_IO_Reque¡_Ty³
::
READ
;

39 
	gSTAT_g’”©ed_»ad_»que¡_couÁ
++;

42 * 
	gpEnd
;

43 
	g»que¡
->
	gLBA_couÁ
 = 
¡d
::
¡¹oul
(
cu¼’t_Œaû_lše
[
ASCIIT¿ûSizeCŞumn
].
c_¡r
(), &
pEnd
, 0);

45 
	g»que¡
->
	gS¹_LBA
 = 
¡d
::
¡¹ouÎ
(
cu¼’t_Œaû_lše
[
ASCIIT¿ûAdd»ssCŞumn
].
c_¡r
(), &
pEnd
, 0);

46 ià(
	g»que¡
->
	gS¹_LBA
 <ğ(
’d_l§_Ú_deviû
 - 
¡¬t_l§_Ú_deviû
)) {

47 
»que¡
->
S¹_LBA
 +ğ
¡¬t_l§_Ú_deviû
;

49 
	g»que¡
->
	gS¹_LBA
 = 
¡¬t_l§_Ú_deviû
 + 
»que¡
->
S¹_LBA
 % (
’d_l§_Ú_deviû
 - start_lsa_on_device);

52 
	g»que¡
->
	gA¼iv®_time
 = 
time_off£t
 + 
SimuÏtÜ
->
Time
();

53 
	gSTAT_g’”©ed_»que¡_couÁ
++;

55  
	g»que¡
;

58 
	gIO_Flow_T¿û_Ba£d
::
NVMe_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
* 
io_»que¡
)

60 
IO_Flow_Ba£
::
NVMe_cÚsume_io_»que¡
(
io_»que¡
);

61 
	gIO_Flow_Ba£
::
NVMe_upd©e_ªd_subm™_com¶‘iÚ_queue_
();

64 
	gIO_Flow_T¿û_Ba£d
::
SATA_cÚsume_io_»que¡
(
Ho¡_IO_Reque¡
* 
io_»que¡
)

66 
IO_Flow_Ba£
::
SATA_cÚsume_io_»que¡
(
io_»que¡
);

69 
	gIO_Flow_T¿û_Ba£d
::
S¹_simuÏtiÚ
()

71 
IO_Flow_Ba£
::
S¹_simuÏtiÚ
();

72 
	g¡d
::
¡ršg
 
Œaû_lše
;

73 * 
	gpEnd
;

75 
	gŒaû_fe
.
İ’
(
Œaû_fe_·th
, 
¡d
::
ios
::
š
);

76 ià(!
	gŒaû_fe
.
is_İ’
()) {

77 
PRINT_ERROR
("E¼Ü whİ’šg iÅuˆŒaû fe: " << 
Œaû_fe_·th
)

79 
PRINT_MESSAGE
("Inve¡ig©šg iÅuˆŒaû fe: " << 
Œaû_fe_·th
);

81 
sim_time_ty³
 
	gÏ¡_»que¡_¬riv®_time
 = 0;

82 
	g¡d
::
g‘lše
(
Œaû_fe
, 
Œaû_lše
)) {

83 
	gUts
::
H–³r_FunùiÚs
::
Remove_ü
(
Œaû_lše
);

84 
	gcu¼’t_Œaû_lše
.
ş—r
();

85 
	gUts
::
H–³r_FunùiÚs
::
Tok’ize
(
Œaû_lše
, 
ASCIILšeD–im™”
, 
cu¼’t_Œaû_lše
);

86 ià(
	gcu¼’t_Œaû_lše
.
size
(è!ğ
ASCIII‹msP”Lše
) {

89 
	gtÙ®_»que¡s_š_fe
++;

90 
sim_time_ty³
 
	g´ev_time
 = 
Ï¡_»que¡_¬riv®_time
;

91 
	gÏ¡_»que¡_¬riv®_time
 = 
¡d
::
¡¹Şl
(
cu¼’t_Œaû_lše
[
ASCIIT¿ûTimeCŞumn
].
c_¡r
(), &
pEnd
, 10);

92 ià(
	gÏ¡_»que¡_¬riv®_time
 < 
	g´ev_time
) {

93 
PRINT_ERROR
("UÃx³ùed„eque¡‡¼iv®ime: " << 
Ï¡_»que¡_¬riv®_time
 << "\nMQSimƒxpects„equest‡rrivalimeso be monotonically increasing inhe inputrace!")

97 
	gŒaû_fe
.
şo£
();

98 
PRINT_MESSAGE
("T¿û fe: " << 
Œaû_fe_·th
 << " seems healthy");

100 ià(
	gtÙ®_»¶ay_no
 == 1) {

101 
tÙ®_»que¡s_to_be_g’”©ed
 = ()((()
³rûÁage_to_be_simuÏ‹d
 / 100è* 
tÙ®_»que¡s_š_fe
);

104 
	gtÙ®_»que¡s_to_be_g’”©ed
 = 
tÙ®_»que¡s_š_fe
 * 
tÙ®_»¶ay_no
;

107 
	gŒaû_fe
.
İ’
(
Œaû_fe_·th
);

108 
	gcu¼’t_Œaû_lše
.
ş—r
();

109 
	g¡d
::
g‘lše
(
Œaû_fe
, 
Œaû_lše
);

110 
	gUts
::
H–³r_FunùiÚs
::
Remove_ü
(
Œaû_lše
);

111 
	gUts
::
H–³r_FunùiÚs
::
Tok’ize
(
Œaû_lše
, 
ASCIILšeD–im™”
, 
cu¼’t_Œaû_lše
);

112 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
¡d
::
¡¹Şl
(
cu¼’t_Œaû_lše
[
ASCIIT¿ûTimeCŞumn
].
c_¡r
(), &
pEnd
, 10), 
this
);

115 
	gIO_Flow_T¿û_Ba£d
::
V®id©e_simuÏtiÚ_cÚfig
()

119 
IO_Flow_T¿û_Ba£d
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*)

121 
Ho¡_IO_Reque¡
* 
»que¡
 = 
G’”©e_Ãxt_»que¡
();

122 ià(
	g»que¡
 !ğ
NULL
) {

123 
Subm™_io_»que¡
(
»que¡
);

126 ià(
	gSTAT_g’”©ed_»que¡_couÁ
 < 
	gtÙ®_»que¡s_to_be_g’”©ed
) {

127 
	g¡d
::
¡ršg
 
Œaû_lše
;

128 ià(
	g¡d
::
g‘lše
(
Œaû_fe
, 
Œaû_lše
)) {

129 
	gUts
::
H–³r_FunùiÚs
::
Remove_ü
(
Œaû_lše
);

130 
	gcu¼’t_Œaû_lše
.
ş—r
();

131 
	gUts
::
H–³r_FunùiÚs
::
Tok’ize
(
Œaû_lše
, 
ASCIILšeD–im™”
, 
cu¼’t_Œaû_lše
);

134 
	gŒaû_fe
.
şo£
();

135 
	gŒaû_fe
.
İ’
(
Œaû_fe_·th
);

136 
	g»¶ay_couÁ”
++;

137 
	gtime_off£t
 = 
SimuÏtÜ
->
Time
();

138 
	g¡d
::
g‘lše
(
Œaû_fe
, 
Œaû_lše
);

139 
	gUts
::
H–³r_FunùiÚs
::
Remove_ü
(
Œaû_lše
);

140 
	gcu¼’t_Œaû_lše
.
ş—r
();

141 
	gUts
::
H–³r_FunùiÚs
::
Tok’ize
(
Œaû_lše
, 
ASCIILšeD–im™”
, 
cu¼’t_Œaû_lše
);

142 
PRINT_MESSAGE
("* R•Ïy„ound "<< 
»¶ay_couÁ”
 << "oà"<< 
tÙ®_»¶ay_no
 << " s¹ed fÜ" << 
ID
())

144 * 
	gpEnd
;

145 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
time_off£t
 + 
¡d
::
¡¹Şl
(
cu¼’t_Œaû_lše
[
ASCIIT¿ûTimeCŞumn
].
c_¡r
(), &
pEnd
, 10), 
this
);

149 
	gIO_Flow_T¿û_Ba£d
::
G‘_¡©i¡ics
(
Uts
::
WÜklßd_Sti¡ics
& 
¡©s
, 
LPA_ty³
(*
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
)(
LHA_ty³
 
lha
),

150 
·ge_¡©us_ty³
(*
Fšd_NVM_subun™_acûss_b™m­
)(
LHA_ty³
 
lha
))

152 
	g¡©s
.
	gTy³
 = 
Uts
::
WÜklßd_Ty³
::
TRACE_BASED
;

153 
	g¡©s
.
	gSŒ—m_id
 = 
io_queue_id
 - 1;

154 
	g¡©s
.
	gMš_LHA
 = 
¡¬t_l§_Ú_deviû
;

155 
	g¡©s
.
	gMax_LHA
 = 
’d_l§_Ú_deviû
;

156 
	gi
 = 0; i < 
	gMAX_ARRIVAL_TIME_HISTOGRAM
 + 1; i++) {

157 
	g¡©s
.
	gWr™e_¬riv®_time
.
push_back
(0);

158 
	g¡©s
.
	gR—d_¬riv®_time
.
push_back
(0);

160 
	gi
 = 0; i < 
	gMAX_REQSIZE_HISTOGRAM_ITEMS
 + 1; i++) {

161 
	g¡©s
.
	gWr™e_size_hi¡og¿m
.
push_back
(0);

162 
	g¡©s
.
	gR—d_size_hi¡og¿m
.
push_back
(0);

164 
	g¡©s
.
	gTÙ®_g’”©ed_»qeu¡s
 = 0;

165 
	g¡©s
.
	gTÙ®_acûs£d_lbas
 = 0;

167 
	g¡d
::
if¡»am
 
Œaû_fe_‹mp
;

168 
	gŒaû_fe_‹mp
.
İ’
(
Œaû_fe_·th
, 
¡d
::
ios
::
š
);

169 ià(!
	gŒaû_fe_‹mp
.
is_İ’
()) {

170 
PRINT_ERROR
("Error while openinghe inputrace file!")

173 
	g¡d
::
¡ršg
 
Œaû_lše
;

174 * 
	gpEnd
;

175 
sim_time_ty³
 
	gÏ¡_»que¡_¬riv®_time
 = 0;

176 
sim_time_ty³
 
	gsum_š‹r_¬riv®
 = 0;

177 
ušt64_t
 
	gsum_»que¡_size
 = 0;

178 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
lše_¥l™‹d
;

179 
	g¡d
::
g‘lše
(
Œaû_fe_‹mp
, 
Œaû_lše
)) {

180 
	gUts
::
H–³r_FunùiÚs
::
Remove_ü
(
Œaû_lše
);

181 
	glše_¥l™‹d
.
ş—r
();

182 
	gUts
::
H–³r_FunùiÚs
::
Tok’ize
(
Œaû_lše
, 
ASCIILšeD–im™”
, 
lše_¥l™‹d
);

183 ià(
	glše_¥l™‹d
.
size
(è!ğ
ASCIII‹msP”Lše
) {

186 
sim_time_ty³
 
	g´ev_time
 = 
Ï¡_»que¡_¬riv®_time
;

187 
	gÏ¡_»que¡_¬riv®_time
 = 
¡d
::
¡¹ouÎ
(
lše_¥l™‹d
[
ASCIIT¿ûTimeCŞumn
].
c_¡r
(), &
pEnd
, 10);

188 ià(
	gÏ¡_»que¡_¬riv®_time
 < 
	g´ev_time
) {

189 
PRINT_ERROR
("UÃx³ùed„eque¡‡¼iv®ime: " << 
Ï¡_»que¡_¬riv®_time
 << "\nMQSimƒxpects„equest‡rrivalimeso be monotonic increasing inhe inputrace!")

191 
sim_time_ty³
 
	gdiff
 = (
Ï¡_»que¡_¬riv®_time
 - 
´ev_time
) / 1000;

192 
	gsum_š‹r_¬riv®
 +ğ
Ï¡_»que¡_¬riv®_time
 - 
´ev_time
;

194 
	gLBA_couÁ
 = 
¡d
::
¡¹oul
(
lše_¥l™‹d
[
ASCIIT¿ûSizeCŞumn
].
c_¡r
(), &
pEnd
, 0);

195 
	gsum_»que¡_size
 +ğ
LBA_couÁ
;

196 
LHA_ty³
 
	g¡¬t_LBA
 = 
¡d
::
¡¹ouÎ
(
lše_¥l™‹d
[
ASCIIT¿ûAdd»ssCŞumn
].
c_¡r
(), &
pEnd
, 0);

197 ià(
	g¡¬t_LBA
 <ğ(
’d_l§_Ú_deviû
 - 
¡¬t_l§_Ú_deviû
)) {

198 
¡¬t_LBA
 +ğ
¡¬t_l§_Ú_deviû
;

200 
	g¡¬t_LBA
 = 
¡¬t_l§_Ú_deviû
 + 
¡¬t_LBA
 % (
’d_l§_Ú_deviû
 - start_lsa_on_device);

202 
LHA_ty³
 
	g’d_LBA
 = 
¡¬t_LBA
 + 
LBA_couÁ
 - 1;

203 ià(
	g’d_LBA
 > 
	g’d_l§_Ú_deviû
) {

204 
	g’d_LBA
 = 
¡¬t_l§_Ú_deviû
 + (
’d_LBA
 - 
’d_l§_Ú_deviû
) - 1;

208 
	g¡¬t_LBA
 <ğ
’d_LBA
) {

209 
LPA_ty³
 
deviû_add»ss
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
¡¬t_LBA
);

210 
·ge_¡©us_ty³
 
	gacûss_¡©us_b™m­
 = 
Fšd_NVM_subun™_acûss_b™m­
(
¡¬t_LBA
);

211 ià(
	glše_¥l™‹d
[
ASCIIT¿ûTy³CŞumn
].
com·»
(
ASCIIT¿ûWr™eCode
) == 0) {

212 ià(
¡©s
.
Wr™e_add»ss_acûss_·‰”n
.
fšd
(
deviû_add»ss
è=ğ¡©s.Wr™e_add»ss_acûss_·‰”n.
’d
()) {

213 
Uts
::
Add»ss_Hi¡og¿m_Un™
 
hi¡
;

214 
	ghi¡
.
	gAcûss_couÁ
 = 1;

215 
	ghi¡
.
	gAcûs£d_sub_un™s
 = 
acûss_¡©us_b™m­
;

216 
	g¡©s
.
	gWr™e_add»ss_acûss_·‰”n
[
deviû_add»ss
] = 
hi¡
;

218 
	g¡©s
.
	gWr™e_add»ss_acûss_·‰”n
[
deviû_add»ss
].
	gAcûss_couÁ
 = 
¡©s
.
Wr™e_add»ss_acûss_·‰”n
[deviû_add»ss].
Acûss_couÁ
 + 1;

219 
	g¡©s
.
	gWr™e_add»ss_acûss_·‰”n
[
deviû_add»ss
].
	gAcûs£d_sub_un™s
 = 
¡©s
.
Wr™e_add»ss_acûss_·‰”n
[deviû_add»ss].
Acûs£d_sub_un™s
 | 
acûss_¡©us_b™m­
;

222 ià(
	g¡©s
.
	gR—d_add»ss_acûss_·‰”n
.
fšd
(
deviû_add»ss
è!ğ
¡©s
.
R—d_add»ss_acûss_·‰”n
.
’d
()) {

223 
¡©s
.
Wr™e_»ad_sh¬ed_add»s£s
.
š£¹
(
deviû_add»ss
);

226 ià(
	g¡©s
.
	gR—d_add»ss_acûss_·‰”n
.
fšd
(
deviû_add»ss
è=ğ
¡©s
.
R—d_add»ss_acûss_·‰”n
.
’d
()) {

227 
Uts
::
Add»ss_Hi¡og¿m_Un™
 
hi¡
;

228 
	ghi¡
.
	gAcûss_couÁ
 = 1;

229 
	ghi¡
.
	gAcûs£d_sub_un™s
 = 
acûss_¡©us_b™m­
;

230 
	g¡©s
.
	gR—d_add»ss_acûss_·‰”n
[
deviû_add»ss
] = 
hi¡
;

232 
	g¡©s
.
	gR—d_add»ss_acûss_·‰”n
[
deviû_add»ss
].
	gAcûss_couÁ
 = 
¡©s
.
R—d_add»ss_acûss_·‰”n
[deviû_add»ss].
Acûss_couÁ
 + 1;

233 
	g¡©s
.
	gR—d_add»ss_acûss_·‰”n
[
deviû_add»ss
].
	gAcûs£d_sub_un™s
 = 
¡©s
.
R—d_add»ss_acûss_·‰”n
[deviû_add»ss].
Acûs£d_sub_un™s
 | 
acûss_¡©us_b™m­
;

236 ià(
	g¡©s
.
	gWr™e_add»ss_acûss_·‰”n
.
fšd
(
deviû_add»ss
è!ğ
¡©s
.
Wr™e_add»ss_acûss_·‰”n
.
’d
()) {

237 
¡©s
.
Wr™e_»ad_sh¬ed_add»s£s
.
š£¹
(
deviû_add»ss
);

240 
	g¡©s
.
	gTÙ®_acûs£d_lbas
++;

241 
	g¡¬t_LBA
++;

242 ià(
	g¡¬t_LBA
 > 
	g’d_l§_Ú_deviû
) {

243 
	g¡¬t_LBA
 = 
¡¬t_l§_Ú_deviû
;

248 ià(
	glše_¥l™‹d
[
ASCIIT¿ûTy³CŞumn
].
com·»
(
ASCIIT¿ûWr™eCode
) == 0) {

249 ià(
diff
 < 
MAX_ARRIVAL_TIME_HISTOGRAM
) {

250 
¡©s
.
Wr™e_¬riv®_time
[
diff
]++;

252 
	g¡©s
.
	gWr™e_¬riv®_time
[
MAX_ARRIVAL_TIME_HISTOGRAM
]++;

255 ià(
	gLBA_couÁ
 < 
	gMAX_REQSIZE_HISTOGRAM_ITEMS
) {

256 
	g¡©s
.
	gWr™e_size_hi¡og¿m
[
LBA_couÁ
]++;

258 
	g¡©s
.
	gWr™e_size_hi¡og¿m
[
MAX_REQSIZE_HISTOGRAM_ITEMS
]++;

261 ià(
	gdiff
 < 
	gMAX_ARRIVAL_TIME_HISTOGRAM
) {

262 
	g¡©s
.
	gR—d_¬riv®_time
[
diff
]++;

264 
	g¡©s
.
	gR—d_¬riv®_time
[
MAX_ARRIVAL_TIME_HISTOGRAM
]++;

267 ià(
	gLBA_couÁ
 < 
	gMAX_REQSIZE_HISTOGRAM_ITEMS
) {

268 
	g¡©s
.
	gR—d_size_hi¡og¿m
[
LBA_couÁ
]++;

270 
	g¡©s
.
	gR—d_size_hi¡og¿m
[()
MAX_REQSIZE_HISTOGRAM_ITEMS
]++;

273 
	g¡©s
.
	gTÙ®_g’”©ed_»qeu¡s
++;

275 
	gŒaû_fe_‹mp
.
şo£
();

276 
	g¡©s
.
	gAv”age_»que¡_size_£ùÜ
 = ()(
sum_»que¡_size
 / 
¡©s
.
TÙ®_g’”©ed_»qeu¡s
);

277 
	g¡©s
.
	gAv”age_š‹r_¬riv®_time_Çno_£c
 = 
sum_š‹r_¬riv®
 / 
¡©s
.
TÙ®_g’”©ed_»qeu¡s
;

279 
	g¡©s
.
	gIn™Ÿl_occu·ncy_¿tio
 = 
š™Ÿl_occu·ncy_¿tio
;

280 
	g¡©s
.
	gR•Ïy_no
 = 
tÙ®_»¶ay_no
;

	@src/host/IO_Flow_Trace_Based.h

1 #iâdeà
IO_FLOW_TRACE_BASED_H


2 
	#IO_FLOW_TRACE_BASED_H


	)

4 
	~<¡ršg
>

5 
	~<io¡»am
>

6 
	~<f¡»am
>

7 
	~"IO_Flow_Ba£.h
"

8 
	~"ASCII_T¿û_Defš™iÚ.h
"

10 
Çme¥aû
 
	gHo¡_CompÚ’ts


12 şas 
	cIO_Flow_T¿û_Ba£d
 : 
public
 
IO_Flow_Ba£


14 
public
:

15 
IO_Flow_T¿û_Ba£d
(cÚ¡ 
sim_objeù_id_ty³
& 
Çme
, 
ušt16_t
 
æow_id
, 
LHA_ty³
 
¡¬t_l§_Ú_deviû
, LHA_ty³ 
’d_l§_Ú_deviû
, ušt16_ˆ
io_queue_id
,

16 
ušt16_t
 
nvme_submissiÚ_queue_size
, ušt16_ˆ
nvme_com¶‘iÚ_queue_size
, 
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
š™Ÿl_occu·ncy_¿tio
,

17 
¡d
::
¡ršg
 
Œaû_fe_·th
, 
T¿û_Time_Un™
 
time_un™
, 
tÙ®_»¶ay_couÁ
, 
³rûÁage_to_be_simuÏ‹d
,

18 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
SATA_HBA
* 
§_hba
,

19 
boŞ
 
’abËd_loggšg
, 
sim_time_ty³
 
loggšg_³riod
, 
¡d
::
¡ršg
 
loggšg_fe_·th
);

20 ~
IO_Flow_T¿û_Ba£d
();

21 
Ho¡_IO_Reque¡
* 
G’”©e_Ãxt_»que¡
();

22 
NVMe_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
*);

23 
SATA_cÚsume_io_»que¡
(
Ho¡_IO_Reque¡
*);

24 
S¹_simuÏtiÚ
();

25 
V®id©e_simuÏtiÚ_cÚfig
();

26 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

27 
G‘_¡©i¡ics
(
Uts
::
WÜklßd_Sti¡ics
& 
¡©s
, 
LPA_ty³
(*
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
)(
LHA_ty³
 
lha
),

28 
·ge_¡©us_ty³
(*
Fšd_NVM_subun™_acûss_b™m­
)(
LHA_ty³
 
lha
));

29 
	g´iv©e
:

30 
T¿û_Time_Un™
 
time_un™
;

31 
	g³rûÁage_to_be_simuÏ‹d
;

32 
	g¡d
::
¡ršg
 
Œaû_fe_·th
;

33 
	g¡d
::
if¡»am
 
Œaû_fe
;

34 
	gtÙ®_»¶ay_no
, 
	g»¶ay_couÁ”
;

35 
	gtÙ®_»que¡s_š_fe
;

36 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
cu¼’t_Œaû_lše
;

37 
sim_time_ty³
 
	gtime_off£t
;

	@src/host/PCIe_Link.cpp

1 
	~"../sim/Sim_Defs.h
"

2 
	~"../sim/Engše.h
"

3 
	~"PCIe_Lšk.h
"

4 
	~"PCIe_Mes§ge.h
"

6 
Çme¥aû
 
	gHo¡_CompÚ’ts


8 
	gPCIe_Lšk
::
PCIe_Lšk
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
PCIe_RoÙ_Com¶ex
* 
roÙ_com¶ex
, 
PCIe_Sw™ch
* 
pc›_sw™ch
,

9 
ÏÃ_bªdwidth_GBPs
, 
ÏÃ_couÁ
, 
p_h—d”_size
,

10 
p_max_·ylßd_size
, 
dÎp_oveh»ad
, 
ph_ov”h—d
) :

11 
Sim_Objeù
(
id
), 
roÙ_com¶ex
ÔoÙ_com¶ex), 
pc›_sw™ch
(pcie_switch),

12 
ÏÃ_bªdwidth_GBPs
Öªe_bªdwidth_GBPs), 
ÏÃ_couÁ
(lane_count),

13 
p_h—d”_size
ÑÍ_h—d”_size), 
p_max_·ylßd_size
ÑÍ_max_·ylßd_size), 
dÎp_oveh»ad
(dÎp_oveh»ad), 
ph_ov”h—d
(ph_overhead)

15 
	g·ck‘_ov”h—d
 = 
ph_ov”h—d
 + 
dÎp_oveh»ad
 + 
p_h—d”_size
;

18 
	gPCIe_Lšk
::
S‘_roÙ_com¶ex
(
PCIe_RoÙ_Com¶ex
* 
roÙ_com¶ex
)

20 
this
->
roÙ_com¶ex
 =„oot_complex;

23 
	gPCIe_Lšk
::
S‘_pc›_sw™ch
(
PCIe_Sw™ch
* 
pc›_sw™ch
)

25 
this
->
pc›_sw™ch
 =…cie_switch;

28 
	gPCIe_Lšk
::
D–iv”
(
PCIe_Mes§ge
* 
mes§ge
)

30 
mes§ge
->
De¡š©iÚ
) {

31 
PCIe_De¡š©iÚ_Ty³
::
HOST
:

32 
Mes§ge_bufãr_tow¬d_roÙ_com¶ex
.
push
(
mes§ge
);

33 ià(
	gMes§ge_bufãr_tow¬d_roÙ_com¶ex
.
size
() > 1) {

36 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_Œªsãr_time
(
mes§ge
), 
this
, (*)(
šŒ_t
)
PCIe_De¡š©iÚ_Ty³
::
HOST
, 
¡©ic_ÿ¡
<>(
PCIe_Lšk_Ev’t_Ty³
::
DELIVER
));

38 
	gPCIe_De¡š©iÚ_Ty³
::
DEVICE
:

39 
Mes§ge_bufãr_tow¬d_ssd_deviû
.
push
(
mes§ge
);

40 ià(
	gMes§ge_bufãr_tow¬d_ssd_deviû
.
size
() > 1) {

43 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_Œªsãr_time
(
mes§ge
), 
this
, (*)(
šŒ_t
)
PCIe_De¡š©iÚ_Ty³
::
DEVICE
, 
¡©ic_ÿ¡
<>(
PCIe_Lšk_Ev’t_Ty³
::
DELIVER
));

50 
	gPCIe_Lšk
::
S¹_simuÏtiÚ
() {}

52 
PCIe_Lšk
::
V®id©e_simuÏtiÚ_cÚfig
() {}

54 
PCIe_Lšk
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

56 
PCIe_Mes§ge
* 
mes§ge
 = 
NULL
;

57 
PCIe_De¡š©iÚ_Ty³
 
	gde¡š©iÚ
 = (PCIe_De¡š©iÚ_Ty³)(
šŒ_t
)
ev’t
->
P¬am‘”s
;

58 
	gde¡š©iÚ
) {

59 
	gPCIe_De¡š©iÚ_Ty³
::
HOST
:

60 
mes§ge
 = 
Mes§ge_bufãr_tow¬d_roÙ_com¶ex
.
äÚt
();

61 
	gMes§ge_bufãr_tow¬d_roÙ_com¶ex
.
pİ
();

62 
	groÙ_com¶ex
->
CÚsume_pc›_mes§ge
(
mes§ge
);

63 ià(
	gMes§ge_bufãr_tow¬d_roÙ_com¶ex
.
size
() > 0) {

64 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_Œªsãr_time
(
Mes§ge_bufãr_tow¬d_roÙ_com¶ex
.
äÚt
()),

65 
this
, (*)(
šŒ_t
)
PCIe_De¡š©iÚ_Ty³
::
HOST
, 
¡©ic_ÿ¡
<>(
PCIe_Lšk_Ev’t_Ty³
::
DELIVER
));

68 
	gPCIe_De¡š©iÚ_Ty³
::
DEVICE
:

69 
mes§ge
 = 
Mes§ge_bufãr_tow¬d_ssd_deviû
.
äÚt
();

70 
	gMes§ge_bufãr_tow¬d_ssd_deviû
.
pİ
();

71 
	gpc›_sw™ch
->
D–iv”_to_deviû
(
mes§ge
);

72 ià(
	gMes§ge_bufãr_tow¬d_ssd_deviû
.
size
() > 0) {

73 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_Œªsãr_time
(
Mes§ge_bufãr_tow¬d_ssd_deviû
.
äÚt
()),

74 
this
, (*)(
šŒ_t
)
PCIe_De¡š©iÚ_Ty³
::
DEVICE
, 
¡©ic_ÿ¡
<>(
PCIe_Lšk_Ev’t_Ty³
::
DELIVER
));

	@src/host/PCIe_Link.h

1 #iâdeà
PCIE_LINK_H


2 
	#PCIE_LINK_H


	)

4 
	~"queue
"

5 
	~"../sim/Sim_Defs.h
"

6 
	~"../sim/Sim_Objeù.h
"

7 
	~"../sim/Sim_Ev’t.h
"

8 
	~"PCIe_Mes§ge.h
"

9 
	~"PCIe_RoÙ_Com¶ex.h
"

10 
	~"PCIe_Sw™ch.h
"

12 
Çme¥aû
 
	gHo¡_CompÚ’ts


14 
şass
 
	gPCIe_Sw™ch
;

15 
şass
 
	gPCIe_RoÙ_Com¶ex
;

16 şas 
	cPCIe_Lšk_Ev’t_Ty³
 {
	gDELIVER
};

18 şas 
	cPCIe_Lšk
 : 
public
 
MQSimEngše
::
Sim_Objeù


20 
public
:

21 
PCIe_Lšk
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
PCIe_RoÙ_Com¶ex
* 
roÙ_com¶ex
, 
PCIe_Sw™ch
* 
pc›_sw™ch
,

22 
ÏÃ_bªdwidth_GBPs
 = 1, 
ÏÃ_couÁ
 = 4,

23 
p_h—d”_size
 = 20,

24 
p_max_·ylßd_size
 = 128,

25 
dÎp_oveh»ad
 = 6,

26 
ph_ov”h—d
 = 2);

27 
D–iv”
(
PCIe_Mes§ge
*);

28 
S¹_simuÏtiÚ
();

29 
V®id©e_simuÏtiÚ_cÚfig
();

30 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

31 
S‘_roÙ_com¶ex
(
PCIe_RoÙ_Com¶ex
*);

32 
S‘_pc›_sw™ch
(
PCIe_Sw™ch
*);

33 
	g´iv©e
:

34 
PCIe_RoÙ_Com¶ex
* 
roÙ_com¶ex
;

35 
PCIe_Sw™ch
* 
	gpc›_sw™ch
;

36 
	gÏÃ_bªdwidth_GBPs
;

37 
	gÏÃ_couÁ
;

38 
	gp_h—d”_size
, 
	gp_max_·ylßd_size
;

39 
	gdÎp_oveh»ad
, 
	gph_ov”h—d
;

41 
	g·ck‘_ov”h—d
;

42 
	g¡d
::
queue
<
PCIe_Mes§ge
*> 
Mes§ge_bufãr_tow¬d_ssd_deviû
;

44 
sim_time_ty³
 
e¡im©e_Œªsãr_time
(
PCIe_Mes§ge
* 
mes§ge
)

46 
	gmes§ge
->
	gTy³
) {

47 
	gPCIe_Mes§ge_Ty³
::
READ_COMP
:

48 
PCIe_Mes§ge_Ty³
::
WRITE_REQ
:

50 
tÙ®_Œªsã»d_by‹s
 = (
mes§ge
->
Paylßd_size
 / 
p_max_·ylßd_size
è* (p_max_·ylßd_siz+ 
·ck‘_ov”h—d
)

51 + (
mes§ge
->
Paylßd_size
 % 
p_max_·ylßd_size
 =ğ0 ? 0 : mes§ge->Paylßd_siz%Í_max_·ylßd_siz+ 
·ck‘_ov”h—d
);

52  (
	gsim_time_ty³
)((()((
	gtÙ®_Œªsã»d_by‹s
 / 
	gÏÃ_couÁ
è+ (tÙ®_Œªsã»d_by‹ %†ªe_couÁ =ğ0 ? 0 : 1))è/ 
ÏÃ_bªdwidth_GBPs
);

54 
	gPCIe_Mes§ge_Ty³
::
READ_REQ
:

55  (
sim_time_ty³
)((((
·ck‘_ov”h—d
 + 4è/ 
ÏÃ_couÁ
è+ (Õack‘_ov”h—d + 4è%†ªe_couÁ =ğ0 ? 0 : 1)è/ 
ÏÃ_bªdwidth_GBPs
);

61 
	g¡d
::
queue
<
PCIe_Mes§ge
*> 
Mes§ge_bufãr_tow¬d_roÙ_com¶ex
;

	@src/host/PCIe_Message.h

1 #iâdeà
PCIE_MESSAGE_H


2 
	#PCIE_MESSAGE_H


	)

4 
	~<c¡dšt
>

6 
Çme¥aû
 
	gHo¡_CompÚ’ts


8 şas 
	cPCIe_De¡š©iÚ_Ty³
 {
	gHOST
, 
	gDEVICE
};

9 şas 
	cPCIe_Mes§ge_Ty³
 {
	gREAD_REQ
, 
	gWRITE_REQ
, 
	gREAD_COMP
};

11 şas 
	cPCIe_Mes§ge


13 
	gpublic
:

14 
PCIe_De¡š©iÚ_Ty³
 
De¡š©iÚ
;

15 
PCIe_Mes§ge_Ty³
 
	gTy³
;

16 * 
	gPaylßd
;

17 
	gPaylßd_size
;

18 
ušt64_t
 
	gAdd»ss
;

	@src/host/PCIe_Root_Complex.cpp

1 
	~"PCIe_RoÙ_Com¶ex.h
"

4 
Çme¥aû
 
	gHo¡_CompÚ’ts


6 
	gPCIe_RoÙ_Com¶ex
::
PCIe_RoÙ_Com¶ex
(
PCIe_Lšk
* 
pc›_lšk
, 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
SATA_HBA
* 
§_hba
, 
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
) :

7 
pc›_lšk
Õc›_lšk), 
SSD_deviû_ty³
(SSD_deviû_ty³), 
§_hba
(§_hba), 
IO_æows
(IO_flows) {}

9 
	gPCIe_RoÙ_Com¶ex
::
Wr™e_to_memÜy
(cÚ¡ 
ušt64_t
 
add»ss
, cÚ¡ * 
·ylßd
)

12 ià(
	gadd»ss
 >ğ
DATA_MEMORY_REGION
) {

15 
SSD_deviû_ty³
) {

16 
Ho¡IÁ”çû_Ty³s
::
NVME
:

18 
æow_id
 = 
QUEUE_ID_TO_FLOW_ID
(((
Com¶‘iÚ_Queue_EÁry
*)
·ylßd
)->
SQ_ID
);

19 ((*
	gIO_æows
)[
æow_id
])->
NVMe_cÚsume_io_»que¡
((
Com¶‘iÚ_Queue_EÁry
*)
·ylßd
);

22 
	gHo¡IÁ”çû_Ty³s
::
SATA
:

23 
§_hba
->
SATA_cÚsume_io_»que¡
((
Com¶‘iÚ_Queue_EÁry
*)
·ylßd
);

26 
PRINT_ERROR
("Uknown Host Interfaceype in PCIe_Root_Complex")

31 
PCIe_RoÙ_Com¶ex
::
Wr™e_to_deviû
(
ušt64_t
 
add»ss
, 
ušt16_t
 
wr™e_v®ue
)

33 
PCIe_Mes§ge
* 
	gpc›_mes§ge
 = 
Ãw
 
Ho¡_CompÚ’ts
::PCIe_Message;

34 
	gpc›_mes§ge
->
	gTy³
 = 
PCIe_Mes§ge_Ty³
::
WRITE_REQ
;

35 
	gpc›_mes§ge
->
	gDe¡š©iÚ
 = 
Ho¡_CompÚ’ts
::
PCIe_De¡š©iÚ_Ty³
::
DEVICE
;

36 
	gpc›_mes§ge
->
	gAdd»ss
 = 
add»ss
;

37 
	gpc›_mes§ge
->
	gPaylßd
 = (*)(
šŒ_t
)
wr™e_v®ue
;

38 
	gpc›_mes§ge
->
	gPaylßd_size
 = (
wr™e_v®ue
);

39 
	gpc›_lšk
->
D–iv”
(
pc›_mes§ge
);

42 
	gPCIe_RoÙ_Com¶ex
::
R—d_äom_memÜy
(cÚ¡ 
ušt64_t
 
add»ss
, cÚ¡ 
»ad_size
)

44 
PCIe_Mes§ge
* 
	gÃw_pc›_mes§ge
 = 
Ãw
 
Ho¡_CompÚ’ts
::PCIe_Message;

45 
	gÃw_pc›_mes§ge
->
	gTy³
 = 
PCIe_Mes§ge_Ty³
::
READ_COMP
;

46 
	gÃw_pc›_mes§ge
->
	gDe¡š©iÚ
 = 
Ho¡_CompÚ’ts
::
PCIe_De¡š©iÚ_Ty³
::
DEVICE
;

47 
	gÃw_pc›_mes§ge
->
	gAdd»ss
 = 
add»ss
;

50 ià(
	gadd»ss
 >ğ
DATA_MEMORY_REGION
) {

52 
Ãw_pc›_mes§ge
->
Paylßd_size
 = 
»ad_size
;

53 
	gÃw_pc›_mes§ge
->
	gPaylßd
 = 
NULL
;

55 
	gSSD_deviû_ty³
) {

56 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

58 
ušt16_t
 
æow_id
 = 
QUEUE_ID_TO_FLOW_ID
(ušt16_t(
add»ss
 >> 
NVME_COMP_Q_MEMORY_REGION
));

59 
	gÃw_pc›_mes§ge
->
	gPaylßd
 = (*
IO_æows
)[
æow_id
]->
NVMe_»ad_sqe
(
add»ss
);

60 
	gÃw_pc›_mes§ge
->
	gPaylßd_size
 = (
SubmissiÚ_Queue_EÁry
);

63 
	gHo¡IÁ”çû_Ty³s
::
SATA
:

64 
Ãw_pc›_mes§ge
->
Paylßd
 = 
§_hba
->
R—d_ncq_’Œy
(
add»ss
);

65 
	gÃw_pc›_mes§ge
->
	gPaylßd_size
 = (
SubmissiÚ_Queue_EÁry
);

70 
	gpc›_lšk
->
D–iv”
(
Ãw_pc›_mes§ge
);

73 
	gPCIe_RoÙ_Com¶ex
::
S‘_io_æows
(
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
)

75 
this
->
IO_æows
 = IO_flows;

	@src/host/PCIe_Root_Complex.h

1 #iâdeà
PCIE_ROOT_COMPLEX_H


2 
	#PCIE_ROOT_COMPLEX_H


	)

4 
	~"../ssd/Ho¡_IÁ”çû_Defs.h
"

5 
	~"Ho¡_Defs.h
"

6 
	~"PCIe_Mes§ge.h
"

7 
	~"PCIe_Lšk.h
"

8 
	~"Ho¡_IO_Reque¡.h
"

9 
	~"IO_Flow_Ba£.h
"

10 
	~"SATA_HBA.h
"

13 
Çme¥aû
 
	gHo¡_CompÚ’ts


15 
şass
 
	gPCIe_Lšk
;

16 
şass
 
	gIO_Flow_Ba£
;

17 
şass
 
	gSATA_HBA
;

18 şas 
	cPCIe_RoÙ_Com¶ex


20 
	gpublic
:

21 
PCIe_RoÙ_Com¶ex
(
PCIe_Lšk
* 
pc›_lšk
, 
Ho¡IÁ”çû_Ty³s
 
SSD_deviû_ty³
, 
SATA_HBA
* 
§_hba
, 
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
);

23 
CÚsume_pc›_mes§ge
(
PCIe_Mes§ge
* 
mes§ges
)

25 
	gmes§ges
->
	gTy³
)

27 
	gPCIe_Mes§ge_Ty³
::
READ_REQ
:

28 
R—d_äom_memÜy
(
mes§ges
->
Add»ss
, ()(
šŒ_t
)mes§ges->
Paylßd
);

30 
	gPCIe_Mes§ge_Ty³
::
WRITE_REQ
:

31 
Wr™e_to_memÜy
(
mes§ges
->
Add»ss
, mes§ges->
Paylßd
);

36 
d–‘e
 
	gmes§ges
;

39 
Wr™e_to_deviû
(
ušt64_t
 
add»ss
, 
ušt16_t
 
wr™e_v®ue
);

40 
S‘_io_æows
(
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
);

41 
	g´iv©e
:

42 
PCIe_Lšk
* 
pc›_lšk
;

43 
Ho¡IÁ”çû_Ty³s
 
	gSSD_deviû_ty³
;

44 
SATA_HBA
 * 
	g§_hba
;

45 
	g¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
;

47 
Wr™e_to_memÜy
(cÚ¡ 
ušt64_t
 
add»ss
, cÚ¡ * 
·ylßd
);

48 
R—d_äom_memÜy
(cÚ¡ 
ušt64_t
 
add»ss
, cÚ¡ 
size
);

	@src/host/PCIe_Switch.cpp

1 
	~"PCIe_Sw™ch.h
"

3 
Çme¥aû
 
	gHo¡_CompÚ’ts


5 
	gPCIe_Sw™ch
::
PCIe_Sw™ch
(
PCIe_Lšk
* 
pc›_lšk
, 
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
) :

6 
pc›_lšk
Õc›_lšk), 
ho¡_š‹rçû
(host_interface)

10 
	gPCIe_Sw™ch
::
D–iv”_to_deviû
(
PCIe_Mes§ge
* 
mes§ge
)

12 
ho¡_š‹rçû
->
CÚsume_pc›_mes§ge
(
mes§ge
);

15 
	gPCIe_Sw™ch
::
S’d_to_ho¡
(
PCIe_Mes§ge
* 
mes§ge
)

17 
pc›_lšk
->
D–iv”
(
mes§ge
);

20 
	gPCIe_Sw™ch
::
A‰ach_ssd_deviû
(
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
)

22 
this
->
ho¡_š‹rçû
 = host_interface;

25 
boŞ
 
	gPCIe_Sw™ch
::
Is_ssd_cÚÃùed
()

27  
this
->
ho¡_š‹rçû
 !ğ
NULL
;

	@src/host/PCIe_Switch.h

1 #iâdeà
PCIE_SWITCH_H


2 
	#PCIE_SWITCH_H


	)

4 
	~"PCIe_Mes§ge.h
"

5 
	~"PCIe_Lšk.h
"

6 
	~"../ssd/Ho¡_IÁ”çû_Ba£.h
"

8 
Çme¥aû
 
	gSSD_CompÚ’ts


10 
şass
 
	gHo¡_IÁ”çû_Ba£
;

13 
Çme¥aû
 
	gHo¡_CompÚ’ts


15 
şass
 
	gPCIe_Lšk
;

16 şas 
	cPCIe_Sw™ch


18 
	gpublic
:

19 
PCIe_Sw™ch
(
PCIe_Lšk
* 
pc›_lšk
, 
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
);

20 
D–iv”_to_deviû
(
PCIe_Mes§ge
*);

21 
S’d_to_ho¡
(
PCIe_Mes§ge
*);

22 
A‰ach_ssd_deviû
(
SSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
);

23 
boŞ
 
Is_ssd_cÚÃùed
();

24 
	g´iv©e
:

25 
PCIe_Lšk
* 
pc›_lšk
;

26 
	gSSD_CompÚ’ts
::
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
;

	@src/host/SATA_HBA.cpp

1 
	~"SATA_HBA.h
"

3 
Çme¥aû
 
	gHo¡_CompÚ’ts


5 
	gSATA_HBA
::
SATA_HBA
(
sim_objeù_id_ty³
 
id
, 
ušt16_t
 
ncq_size
, 
sim_time_ty³
 
hba_´oûssšg_d–ay
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
) :

6 
MQSimEngše
::
Sim_Objeù
(
id
), 
ncq_size
Òcq_size), 
hba_´oûssšg_d–ay
(hba_´oûssšg_d–ay), 
pc›_roÙ_com¶ex
Õc›_roÙ_com¶ex), 
IO_æows
(IO_flows)

8 
ušt16_t
 
	gcmdid
 = 0; cmdid < (
	gušt16_t
)(0xffffffff); cmdid++) {

9 
	gavaabË_commªd_ids
.
š£¹
(
cmdid
);

11 
Ho¡_IO_Reque¡
* 
	gt
 = 
NULL
;

12 
ušt16_t
 
	gcmdid
 = 0; cmdid < 
	gncq_size
; cmdid++) {

13 
	g»que¡_queue_š_memÜy
.
push_back
(
t
);

15 
	g§_ncq
.
	gSubmissiÚ_queue_size
 = 
ncq_size
;

16 
	g§_ncq
.
	gSubmissiÚ_queue_h—d
 = 0;

17 
	g§_ncq
.
	gSubmissiÚ_queue_
 = 0;

18 
	g§_ncq
.
	gCom¶‘iÚ_queue_size
 = 
ncq_size
;

19 
	g§_ncq
.
	gCom¶‘iÚ_queue_h—d
 = 0;

20 
	g§_ncq
.
	gCom¶‘iÚ_queue_
 = 0;

21 
	g§_ncq
.
	gSubmissiÚ_queue_memÜy_ba£_add»ss
 = 
SUBMISSION_QUEUE_MEMORY_1
;

22 
	g§_ncq
.
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
 = 
NCQ_SUBMISSION_REGISTER
;

23 
	g§_ncq
.
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
 = 
COMPLETION_QUEUE_MEMORY_1
;

24 
	g§_ncq
.
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
 = 
NCQ_COMPLETION_REGISTER
;

25 
	g¡d
::
cout
<<
NCQ_SUBMISSION_REGISTER
<<
¡d
::
’dl
;

28 
	gSATA_HBA
::~
SATA_HBA
()

30 autØ&
»q
 : 
§_ncq
.
queue
) {

31 ià(
»q
.
£cÚd
) {

32 
d–‘e
 
»q
.
£cÚd
;

35 autØ&
	g»q
 : 
wa™šg_»que¡s_fÜ_submissiÚ
) {

36 ià(
»q
) {

37 
d–‘e
 
»q
;

42 
	gSATA_HBA
::
S¹_simuÏtiÚ
()

46 
SATA_HBA
::
V®id©e_simuÏtiÚ_cÚfig
()

50 
SATA_HBA
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

52 (
HBA_Sim_Ev’ts
)
ev’t
->
Ty³
)

54 
HBA_Sim_Ev’ts
::
CONSUME_IO_REQUEST
:

56 
Com¶‘iÚ_Queue_EÁry
* 
cqe
 = 
cÚsume_»que¡s
.
äÚt
();

57 
	gcÚsume_»que¡s
.
pİ
();

59 
Ho¡_IO_Reque¡
* 
	g»que¡
 = 
§_ncq
.
queue
[
cqe
->
Commªd_Id’tif›r
];

60 
	g§_ncq
.
	gqueue
.
”a£
(
cqe
->
Commªd_Id’tif›r
);

61 
	gavaabË_commªd_ids
.
š£¹
(
cqe
->
Commªd_Id’tif›r
);

62 
	g§_ncq
.
	gSubmissiÚ_queue_h—d
 = 
cqe
->
SQ_H—d
;

64 ((*
	gIO_æows
)[
»que¡
->
Sourû_æow_id
])->
SATA_cÚsume_io_»que¡
(request);

66 
Upd©e_ªd_subm™_ncq_com¶‘iÚ_šfo
();

69 
	gwa™šg_»que¡s_fÜ_submissiÚ
.
size
() > 0) {

70 ià(!
SATA_SQ_FULL
(
§_ncq
è&& 
	gavaabË_commªd_ids
.
size
() > 0)

72 
Ho¡_IO_Reque¡
* 
	gÃw_»q
 = 
wa™šg_»que¡s_fÜ_submissiÚ
.
äÚt
();

73 
	gwa™šg_»que¡s_fÜ_submissiÚ
.
pİ_äÚt
();

74 ià(
	g§_ncq
.
	gqueue
[*
avaabË_commªd_ids
.
begš
()] !ğ
NULL
) {

75 
PRINT_ERROR
("Unexpteced situation in SATA_HBA! Overwriting‡ waiting I/O„equest inhe queue!")

77 
Ãw_»q
->
IO_queue_šfo
 = *
avaabË_commªd_ids
.
begš
();

78 
	g§_ncq
.
	gqueue
[*
avaabË_commªd_ids
.
begš
()] = 
Ãw_»q
;

79 
	gavaabË_commªd_ids
.
”a£
(
avaabË_commªd_ids
.
begš
());

80 
	g»que¡_queue_š_memÜy
[
§_ncq
.
SubmissiÚ_queue_
] = 
Ãw_»q
;

81 
SATA_UPDATE_SQ_TAIL
(
§_ncq
);

83 
	gÃw_»q
->
	gEnqueue_time
 = 
SimuÏtÜ
->
Time
();

84 
	gpc›_roÙ_com¶ex
->
Wr™e_to_deviû
(
§_ncq
.
SubmissiÚ__»gi¡”_add»ss_Ú_deviû
, s©a_ncq.
SubmissiÚ_queue_
);

90 
d–‘e
 
	gcqe
;

92 if(
	gcÚsume_»que¡s
.
size
() > 0) {

93 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
hba_´oûssšg_d–ay
, 
this
, 
NULL
, 
¡©ic_ÿ¡
<>(
HBA_Sim_Ev’ts
::
CONSUME_IO_REQUEST
));

97 
	gHBA_Sim_Ev’ts
::
SUBMIT_IO_REQUEST
:

99 
Ho¡_IO_Reque¡
* 
»que¡
 = 
ho¡_»que¡s
.
äÚt
();

100 
	gho¡_»que¡s
.
pİ
();

103 ià(
SATA_SQ_FULL
(
§_ncq
è|| 
	gavaabË_commªd_ids
.
size
() == 0) {

104 
wa™šg_»que¡s_fÜ_submissiÚ
.
push_back
(
»que¡
);

106 ià(
	g§_ncq
.
	gqueue
[*
avaabË_commªd_ids
.
begš
()] !ğ
NULL
) {

107 
PRINT_ERROR
("Unexpteced situation in IO_Flow_Base! Overwriting‡n unhandled I/O„equest inhe queue!")

109 
»que¡
->
IO_queue_šfo
 = *
avaabË_commªd_ids
.
begš
();

110 
	g§_ncq
.
	gqueue
[*
avaabË_commªd_ids
.
begš
()] = 
»que¡
;

111 
	gavaabË_commªd_ids
.
”a£
(
avaabË_commªd_ids
.
begš
());

112 
	g»que¡_queue_š_memÜy
[
§_ncq
.
SubmissiÚ_queue_
] = 
»que¡
;

113 
SATA_UPDATE_SQ_TAIL
(
§_ncq
);

115 
	g»que¡
->
	gEnqueue_time
 = 
SimuÏtÜ
->
Time
();

116 
	gpc›_roÙ_com¶ex
->
Wr™e_to_deviû
(
§_ncq
.
SubmissiÚ__»gi¡”_add»ss_Ú_deviû
, s©a_ncq.
SubmissiÚ_queue_
);

119 ià(
	gho¡_»que¡s
.
size
() > 0) {

120 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
hba_´oûssšg_d–ay
, 
this
, 
NULL
, 
¡©ic_ÿ¡
<>(
HBA_Sim_Ev’ts
::
SUBMIT_IO_REQUEST
));

128 
	gSATA_HBA
::
Subm™_io_»que¡
(
Ho¡_IO_Reque¡
* 
»que¡
)

130 
ho¡_»que¡s
.
push
(
»que¡
);

131 ià(
	gho¡_»que¡s
.
size
() == 1) {

132 
SimuÏtÜ
->
Regi¡”_sim_ev’t
(SimuÏtÜ->
Time
(è+ 
hba_´oûssšg_d–ay
, 
this
, 
NULL
, 
¡©ic_ÿ¡
<>(
HBA_Sim_Ev’ts
::
SUBMIT_IO_REQUEST
));

136 
	gSATA_HBA
::
SATA_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
* 
cqe
)

138 
cÚsume_»que¡s
.
push
(
cqe
);

139 ià(
	gcÚsume_»que¡s
.
size
() == 1) {

140 
SimuÏtÜ
->
Regi¡”_sim_ev’t
(SimuÏtÜ->
Time
(è+ 
hba_´oûssšg_d–ay
, 
this
, 
NULL
, 
¡©ic_ÿ¡
<>(
HBA_Sim_Ev’ts
::
CONSUME_IO_REQUEST
));

144 
SubmissiÚ_Queue_EÁry
* 
	gSATA_HBA
::
R—d_ncq_’Œy
(
ušt64_t
 
add»ss
)

146 
SubmissiÚ_Queue_EÁry
* 
ncq_’Œy
 = 
Ãw
 Submission_Queue_Entry;

147 
Ho¡_IO_Reque¡
* 
	g»que¡
 = 
»que¡_queue_š_memÜy
[(
ušt16_t
)((
add»ss
 - 
§_ncq
.
SubmissiÚ_queue_memÜy_ba£_add»ss
è/ (
SubmissiÚ_Queue_EÁry
))];

149 ià(
	g»que¡
 =ğ
NULL
) {

150 
throw
 
¡d
::
šv®id_¬gum’t
("SATA HBA: Requesto‡ccess‡n NCQƒntryhat does‚otƒxist.");

153 
	gncq_’Œy
->
	gCommªd_Id’tif›r
 = 
»que¡
->
IO_queue_šfo
;

155 ià(
	g»que¡
->
	gTy³
 =ğ
Ho¡_IO_Reque¡_Ty³
::
READ
) {

156 
ncq_’Œy
->
Opcode
 = 
NVME_READ_OPCODE
;

157 
	gncq_’Œy
->
	gCommªd_¥ecific
[0] = (
ušt32_t
)
»que¡
->
S¹_LBA
;

158 
	gncq_’Œy
->
	gCommªd_¥ecific
[1] = (
ušt32_t
)(
»que¡
->
S¹_LBA
 >> 32);

159 
	gncq_’Œy
->
	gCommªd_¥ecific
[2] = ((
ušt32_t
)((
ušt16_t
)
»que¡
->
LBA_couÁ
)) & (uint32_t)(0x0000ffff);

160 
	gncq_’Œy
->
	gPRP_’Œy_1
 = (
DATA_MEMORY_REGION
);

161 
	gncq_’Œy
->
	gPRP_’Œy_2
 = (
DATA_MEMORY_REGION
 + 0x1000);

163 
	gncq_’Œy
->
	gOpcode
 = 
NVME_WRITE_OPCODE
;

164 
	gncq_’Œy
->
	gCommªd_¥ecific
[0] = (
ušt32_t
)
»que¡
->
S¹_LBA
;

165 
	gncq_’Œy
->
	gCommªd_¥ecific
[1] = (
ušt32_t
)(
»que¡
->
S¹_LBA
 >> 32);

166 
	gncq_’Œy
->
	gCommªd_¥ecific
[2] = ((
ušt32_t
)((
ušt16_t
)
»que¡
->
LBA_couÁ
)) & (uint32_t)(0x0000ffff);

167 
	gncq_’Œy
->
	gPRP_’Œy_1
 = (
DATA_MEMORY_REGION
);

168 
	gncq_’Œy
->
	gPRP_’Œy_2
 = (
DATA_MEMORY_REGION
 + 0x1000);

171  
	gncq_’Œy
;

174 
	gSATA_HBA
::
Upd©e_ªd_subm™_ncq_com¶‘iÚ_šfo
()

176 
§_ncq
.
Com¶‘iÚ_queue_h—d
++;

177 ià(
	g§_ncq
.
	gCom¶‘iÚ_queue_h—d
 =ğ
§_ncq
.
Com¶‘iÚ_queue_size
) {

178 
§_ncq
.
Com¶‘iÚ_queue_h—d
 = 0;

180 
	gpc›_roÙ_com¶ex
->
Wr™e_to_deviû
(
§_ncq
.
Com¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
, s©a_ncq.
Com¶‘iÚ_queue_h—d
);

183 cÚ¡ 
NCQ_CÚŒŞ_SŒuùu»
* 
	gSATA_HBA
::
G‘_§_ncq_šfo
()

185  &
§_ncq
;

188 
	gSATA_HBA
::
S‘_io_æows
(
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
)

190 
this
->
IO_æows
 = IO_flows;

193 
	gSATA_HBA
::
S‘_roÙ_com¶ex
(
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
)

195 
this
->
pc›_roÙ_com¶ex
 =…cie_root_complex;

	@src/host/SATA_HBA.h

1 #iâdeà
SATA_HBA_H


2 
	#SATA_HBA_H


	)

4 
	~<¡dšt.h
>

5 
	~<unÜd”ed_m­
>

6 
	~<£t
>

7 
	~<li¡
>

8 
	~"../sim/Sim_Defs.h
"

9 
	~"../sim/Sim_Objeù.h
"

10 
	~"Ho¡_IO_Reque¡.h
"

11 
	~"IO_Flow_Ba£.h
"

12 
	~"PCIe_RoÙ_Com¶ex.h
"

14 
Çme¥aû
 
	gHo¡_CompÚ’ts


16 
	#SATA_SQ_FULL
(
Q
è(Q.
SubmissiÚ_queue_
 < Q.
SubmissiÚ_queue_size
 - 1 ? Q.SubmissiÚ_queue_ + 1 =ğQ.
SubmissiÚ_queue_h—d
 : Q.SubmissiÚ_queue_h—d =ğ0)

	)

17 
	#SATA_UPDATE_SQ_TAIL
(
Q
èQ.
SubmissiÚ_queue_
++;\

18 ià(
Q
.
SubmissiÚ_queue_
 =ğQ.
SubmissiÚ_queue_size
)\

19 
Q
.
SubmissiÚ_queue_
 = 0;

	)

21 
	sNCQ_CÚŒŞ_SŒuùu»


23 
ušt16_t
 
	gSubmissiÚ_queue_h—d
;

24 
ušt16_t
 
	gSubmissiÚ_queue_
;

25 
ušt16_t
 
	gSubmissiÚ_queue_size
;

26 
ušt64_t
 
	gSubmissiÚ__»gi¡”_add»ss_Ú_deviû
;

27 
ušt64_t
 
	gSubmissiÚ_queue_memÜy_ba£_add»ss
;

28 
ušt16_t
 
	gCom¶‘iÚ_queue_h—d
;

29 
ušt16_t
 
	gCom¶‘iÚ_queue_
;

30 
ušt16_t
 
	gCom¶‘iÚ_queue_size
;

31 
ušt64_t
 
	gCom¶‘iÚ_h—d_»gi¡”_add»ss_Ú_deviû
;

32 
ušt64_t
 
	gCom¶‘iÚ_queue_memÜy_ba£_add»ss
;

33 
	g¡d
::
unÜd”ed_m­
<
sim_time_ty³
, 
	gHo¡_IO_Reque¡
*> 
	gqueue
;

36 şas 
	cHBA_Sim_Ev’ts
 {
	gSUBMIT_IO_REQUEST
, 
	gCONSUME_IO_REQUEST
};

38 
şass
 
	gIO_Flow_Ba£
;

39 
şass
 
	gPCIe_RoÙ_Com¶ex
;

40 şas 
	cSATA_HBA
 : 
MQSimEngše
::
Sim_Objeù


42 
public
:

43 
SATA_HBA
(
sim_objeù_id_ty³
 
id
, 
ušt16_t
 
ncq_size
, 
sim_time_ty³
 
hba_´oûssšg_d–ay
, 
PCIe_RoÙ_Com¶ex
* 
pc›_roÙ_com¶ex
, 
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
);

44 ~
SATA_HBA
();

45 
S¹_simuÏtiÚ
();

46 
V®id©e_simuÏtiÚ_cÚfig
();

47 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

48 
Subm™_io_»que¡
(
Ho¡_IO_Reque¡
* 
»que¡
);

49 
SATA_cÚsume_io_»que¡
(
Com¶‘iÚ_Queue_EÁry
* 
cqe
);

50 
SubmissiÚ_Queue_EÁry
* 
R—d_ncq_’Œy
(
ušt64_t
 
add»ss
);

51 cÚ¡ 
NCQ_CÚŒŞ_SŒuùu»
* 
G‘_§_ncq_šfo
();

52 
S‘_io_æows
(
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
);

53 
S‘_roÙ_com¶ex
(
PCIe_RoÙ_Com¶ex
*);

54 
	g´iv©e
:

55 
ušt16_t
 
ncq_size
;

56 
sim_time_ty³
 
	ghba_´oûssšg_d–ay
;

57 
PCIe_RoÙ_Com¶ex
 * 
	gpc›_roÙ_com¶ex
;

58 
	g¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*>* 
IO_æows
;

59 
NCQ_CÚŒŞ_SŒuùu»
 
	g§_ncq
;

60 
	g¡d
::
£t
<
ušt16_t
> 
avaabË_commªd_ids
;

61 
	g¡d
::
veùÜ
<
Ho¡_IO_Reque¡
*> 
»que¡_queue_š_memÜy
;

62 
	g¡d
::
li¡
<
Ho¡_IO_Reque¡
*> 
wa™šg_»que¡s_fÜ_submissiÚ
;

63 
Upd©e_ªd_subm™_ncq_com¶‘iÚ_šfo
();

64 
	g¡d
::
queue
<
Com¶‘iÚ_Queue_EÁry
*> 
cÚsume_»que¡s
;

65 
	g¡d
::
queue
<
Ho¡_IO_Reque¡
*> 
ho¡_»que¡s
;

	@src/main.cpp

1 
	~<io¡»am
>

2 
	~<f¡»am
>

3 
	~<ùime
>

4 
	~<¡ršg
>

5 
	~<c¡ršg
>

6 
	~"ssd/SSD_Defs.h
"

7 
	~"exec/ExecutiÚ_P¬am‘”_S‘.h
"

8 
	~"exec/SSD_Deviû.h
"

9 
	~"exec/Ho¡_Sy¡em.h
"

10 
	~"uts/¿pidxml/¿pidxml.hµ
"

11 
	~"uts/Di¡ributiÚTy³s.h
"

12 
	~"ssd/FTL.h
"

14 
usšg
 
Çme¥aû
 
	g¡d
;

17 
	$commªd_lše_¬gs
(* 
¬gv
[], 
¡ršg
& 
šput_fe_·th
, sŒšg& 
wÜklßd_fe_·th
)

20 
¬g_úŒ
 = 1;‡rg_cntr < 5;‡rg_cntr++) {

21 
¡ršg
 
¬g
 = 
¬gv
[
¬g_úŒ
];

23 
fe_·th_sw™ch
[] = "-i";

24 ià(
¬g
.
	`com·»
(0, 
	`¡¾’
(
fe_·th_sw™ch
), file_path_switch) == 0) {

25 
šput_fe_·th
.
	`assign
(
¬gv
[++
¬g_úŒ
]);

30 
wÜklßd_·th_sw™ch
[] = "-w";

31 ià(
¬g
.
	`com·»
(0, 
	`¡¾’
(
wÜklßd_·th_sw™ch
), workload_path_switch) == 0) {

32 
wÜklßd_fe_·th
.
	`assign
(
¬gv
[++
¬g_úŒ
]);

37 
	}
}

39 
	$»ad_cÚfigu¿tiÚ_·¿m‘”s
(cÚ¡ 
¡ršg
 
ssd_cÚfig_fe_·th
, 
ExecutiÚ_P¬am‘”_S‘
* 
exec_·¿ms
)

41 
if¡»am
 
ssd_cÚfig_fe
;

42 
ssd_cÚfig_fe
.
	`İ’
(
ssd_cÚfig_fe_·th
.
	`c_¡r
());

44 ià(!
ssd_cÚfig_fe
) {

45 
	`PRINT_MESSAGE
("The specified SSD configuration file does‚otƒxist.")

46 
	`PRINT_MESSAGE
("Using MQSim's default configuration.")

47 
	`PRINT_MESSAGE
("Writinghe default configuration…arametersoheƒxpected configuration file.")

49 
Uts
::
XmlWr™”
 
xmlwr™”
;

50 
¡ršg
 
tmp
;

51 
xmlwr™”
.
	`O³n
(
ssd_cÚfig_fe_·th
.
	`c_¡r
());

52 
exec_·¿ms
->
	`XML_£rŸlize
(
xmlwr™”
);

53 
xmlwr™”
.
	`Clo£
();

54 
	`PRINT_MESSAGE
("[====================] Done!\n")

57 
¡ršg
 
	`lše
((
¡d
::
i¡»ambuf_™”©Ü
<>(
ssd_cÚfig_fe
)),

58 
¡d
::
i¡»ambuf_™”©Ü
<>());

59 
ssd_cÚfig_fe
 >> 
lše
;

60 ià(
lše
.
	`com·»
("USE_INTERNAL_PARAMS") != 0) {

61 
¿pidxml
::
xml_docum’t
<> 
doc
;

62 * 
‹mp_¡ršg
 = 
Ãw
 [
lše
.
	`Ëngth
() + 1];

63 
	`¡rıy
(
‹mp_¡ršg
, 
lše
.
	`c_¡r
());

64 
doc
.
·r£
<0>(
‹mp_¡ršg
);

65 
¿pidxml
::
xml_node
<> *
mqsim_cÚfig
 = 
doc
.
	`fœ¡_node
("Execution_Parameter_Set");

66 ià(
mqsim_cÚfig
 !ğ
NULL
) {

67 
exec_·¿ms
 = 
Ãw
 
ExecutiÚ_P¬am‘”_S‘
;

68 
exec_·¿ms
->
	`XML_de£rŸlize
(
mqsim_cÚfig
);

70 
	`PRINT_MESSAGE
("Error inhe SSD configuration file!")

71 
	`PRINT_MESSAGE
("Using MQSim's default configuration.")

74 
	`PRINT_MESSAGE
("Using MQSim's default configuration.");

75 
	`PRINT_MESSAGE
("Writinghe default configuration…arametersoheƒxpected configuration file.");

77 
Uts
::
XmlWr™”
 
xmlwr™”
;

78 
¡ršg
 
tmp
;

79 
xmlwr™”
.
	`O³n
(
ssd_cÚfig_fe_·th
.
	`c_¡r
());

80 
exec_·¿ms
->
	`XML_£rŸlize
(
xmlwr™”
);

81 
xmlwr™”
.
	`Clo£
();

82 
	`PRINT_MESSAGE
("[====================] Done!\n")

86 
ssd_cÚfig_fe
.
	`şo£
();

87 
	}
}

89 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
IO_Flow_P¬am‘”_S‘
*>*>* 
	$»ad_wÜklßd_defš™iÚs
(cÚ¡ 
¡ršg
 
wÜklßd_defs_fe_·th
)

91 
¡d
::
veùÜ
<¡d::veùÜ<
IO_Flow_P¬am‘”_S‘
*>*>* 
io_sûÇrios
 = 
Ãw
 std::vector<std::vector<IO_Flow_Parameter_Set*>*>;

93 
if¡»am
 
wÜklßd_defs_fe
;

94 
wÜklßd_defs_fe
.
	`İ’
(
wÜklßd_defs_fe_·th
.
	`c_¡r
());

95 
boŞ
 
u£_deçuÉ_wÜklßds
 = 
Œue
;

96 ià(!
wÜklßd_defs_fe
) {

97 
	`PRINT_MESSAGE
("The specified workload definition file does‚otƒxist!");

98 
	`PRINT_MESSAGE
("Using MQSim's default workload definitions.");

99 
	`PRINT_MESSAGE
("Writinghe default workload definitionsoheƒxpected workload definition file.");

100 
	`PRINT_MESSAGE
("[====================] Done!\n");

102 
¡ršg
 
	`lše
((
¡d
::
i¡»ambuf_™”©Ü
<>(
wÜklßd_defs_fe
)), std::istreambuf_iterator<>());

103 ià(
lše
.
	`com·»
("USE_INTERNAL_PARAMS") != 0) {

104 
¿pidxml
::
xml_docum’t
<> 
doc
;

106 * 
‹mp_¡ršg
 = 
Ãw
 [
lše
.
	`Ëngth
() + 1];

107 
	`¡rıy
(
‹mp_¡ršg
, 
lše
.
	`c_¡r
());

108 
doc
.
·r£
<0>(
‹mp_¡ršg
);

109 
¿pidxml
::
xml_node
<> *
mqsim_io_sûÇrios
 = 
doc
.
	`fœ¡_node
("MQSim_IO_Scenarios");

110 ià(
mqsim_io_sûÇrios
 !ğ
NULL
) {

111 autØ
xml_io_sûÇrio
 = 
mqsim_io_sûÇrios
->
	`fœ¡_node
("IO_SûÇrio"); xml_io_sûÇrio; xml_io_sûÇriØğxml_io_sûÇrio->
	`Ãxt_siblšg
("IO_Scenario")) {

112 
¡d
::
veùÜ
<
IO_Flow_P¬am‘”_S‘
*>* 
sûÇrio_defš™iÚ
 = 
Ãw
 std::vector<IO_Flow_Parameter_Set*>;

113 autØ
æow_def
 = 
xml_io_sûÇrio
->
	`fœ¡_node
(); flow_def; flow_deàğæow_def->
	`Ãxt_siblšg
()) {

114 
IO_Flow_P¬am‘”_S‘
* 
æow
;

115 ià(
	`¡rcmp
(
æow_def
->
	`Çme
(), "IO_Flow_Parameter_Set_Synthetic") == 0) {

116 
æow
 = 
Ãw
 
IO_Flow_P¬am‘”_S‘_SyÁh‘ic
;

117 ((
IO_Flow_P¬am‘”_S‘_SyÁh‘ic
*)
æow
)->
	`XML_de£rŸlize
(
æow_def
);

118 } ià(
	`¡rcmp
(
æow_def
->
	`Çme
(), "IO_Flow_Parameter_Set_Trace_Based") == 0) {

119 
æow
 = 
Ãw
 
IO_Flow_P¬am‘”_S‘_T¿û_Ba£d
;

120 ((
IO_Flow_P¬am‘”_S‘_T¿û_Ba£d
*)
æow
)->
	`XML_de£rŸlize
(
æow_def
);

122 
sûÇrio_defš™iÚ
->
	`push_back
(
æow
);

124 
io_sûÇrios
->
	`push_back
(
sûÇrio_defš™iÚ
);

125 
u£_deçuÉ_wÜklßds
 = 
çl£
;

128 
	`PRINT_MESSAGE
("Error inhe workload definition file!");

129 
	`PRINT_MESSAGE
("Using MQSim's default workload definitions.");

130 
	`PRINT_MESSAGE
("Writinghe default workload definitionsoheƒxpected workload definition file.");

131 
	`PRINT_MESSAGE
("[====================] Done!\n");

136 ià(
u£_deçuÉ_wÜklßds
) {

137 
¡d
::
veùÜ
<
IO_Flow_P¬am‘”_S‘
*>* 
sûÇrio_defš™iÚ
 = 
Ãw
 std::vector<IO_Flow_Parameter_Set*>;

138 
IO_Flow_P¬am‘”_S‘_SyÁh‘ic
* 
io_æow_1
 = 
Ãw
 IO_Flow_Parameter_Set_Synthetic;

139 
io_æow_1
->
Deviû_Lev–_D©a_Cachšg_Mode
 = 
SSD_CompÚ’ts
::
Cachšg_Mode
::
WRITE_CACHE
;

140 
io_æow_1
->
Ty³
 = 
Flow_Ty³
::
SYNTHETIC
;

141 
io_æow_1
->
PriÜ™y_CÏss
 = 
IO_Flow_PriÜ™y_CÏss
::
HIGH
;

142 
io_æow_1
->
ChªÃl_No
 = 8;

143 
io_æow_1
->
ChªÃl_IDs
 = 
Ãw
 
æash_chªÃl_ID_ty³
[8];

144 
io_æow_1
->
ChªÃl_IDs
[0] = 0; io_flow_1->Channel_IDs[1] = 1; io_flow_1->Channel_IDs[2] = 2; io_flow_1->Channel_IDs[3] = 3;

145 
io_æow_1
->
ChªÃl_IDs
[4] = 4; io_flow_1->Channel_IDs[5] = 5; io_flow_1->Channel_IDs[6] = 6; io_flow_1->Channel_IDs[7] = 7;

146 
io_æow_1
->
Ch_No
 = 4;

147 
io_æow_1
->
Ch_IDs
 = 
Ãw
 
æash_ch_ID_ty³
[4];

148 
io_æow_1
->
Ch_IDs
[0] = 0; io_flow_1->Chip_IDs[1] = 1; io_flow_1->Chip_IDs[2] = 2; io_flow_1->Chip_IDs[3] = 3;

149 
io_æow_1
->
D›_No
 = 2;

150 
io_æow_1
->
D›_IDs
 = 
Ãw
 
æash_d›_ID_ty³
[2];

151 
io_æow_1
->
D›_IDs
[0] = 0; io_flow_1->Die_IDs[1] = 1;

152 
io_æow_1
->
PÏÃ_No
 = 2;

153 
io_æow_1
->
PÏÃ_IDs
 = 
Ãw
 
æash_¶ªe_ID_ty³
[2];

154 
io_æow_1
->
PÏÃ_IDs
[0] = 0; io_flow_1->Plane_IDs[1] = 1;

155 
io_æow_1
->
In™Ÿl_Occu·ncy_P”ûÁage
 = 50;

156 
io_æow_1
->
WÜkšg_S‘_P”ûÁage
 = 85;

157 
io_æow_1
->
SyÁh‘ic_G’”©Ü_Ty³
 = 
Uts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
;

158 
io_æow_1
->
R—d_P”ûÁage
 = 100;

159 
io_æow_1
->
Add»ss_Di¡ributiÚ
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
;

160 
io_æow_1
->
P”ûÁage_of_HÙ_RegiÚ
 = 0;

161 
io_æow_1
->
G’”©ed_AligÃd_Add»s£s
 = 
Œue
;

162 
io_æow_1
->
Add»ss_Alignm’t_Un™
 = 16;

163 
io_æow_1
->
Reque¡_Size_Di¡ributiÚ
 = 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
FIXED
;

164 
io_æow_1
->
Av”age_Reque¡_Size
 = 8;

165 
io_æow_1
->
V¬Ÿnû_Reque¡_Size
 = 0;

166 
io_æow_1
->
S“d
 = 12344;

167 
io_æow_1
->
Av”age_No_of_Reqs_š_Queue
 = 2;

168 
io_æow_1
->
Bªdwidth
 = 262144;

169 
io_æow_1
->
Stİ_Time
 = 1000000000;

170 
io_æow_1
->
TÙ®_Reque¡s_To_G’”©e
 = 0;

171 
sûÇrio_defš™iÚ
->
	`push_back
(
io_æow_1
);

173 
IO_Flow_P¬am‘”_S‘_SyÁh‘ic
* 
io_æow_2
 = 
Ãw
 IO_Flow_Parameter_Set_Synthetic;

174 
io_æow_2
->
Deviû_Lev–_D©a_Cachšg_Mode
 = 
SSD_CompÚ’ts
::
Cachšg_Mode
::
WRITE_CACHE
;

175 
io_æow_2
->
Ty³
 = 
Flow_Ty³
::
SYNTHETIC
;

176 
io_æow_2
->
PriÜ™y_CÏss
 = 
IO_Flow_PriÜ™y_CÏss
::
HIGH
;

177 
io_æow_2
->
ChªÃl_No
 = 8;

178 
io_æow_2
->
ChªÃl_IDs
 = 
Ãw
 
æash_chªÃl_ID_ty³
[8];

179 
io_æow_2
->
ChªÃl_IDs
[0] = 0; io_flow_2->Channel_IDs[1] = 1; io_flow_2->Channel_IDs[2] = 2; io_flow_2->Channel_IDs[3] = 3;

180 
io_æow_2
->
ChªÃl_IDs
[4] = 4; io_flow_2->Channel_IDs[5] = 5; io_flow_2->Channel_IDs[6] = 6; io_flow_2->Channel_IDs[7] = 7;

181 
io_æow_2
->
Ch_No
 = 4;

182 
io_æow_2
->
Ch_IDs
 = 
Ãw
 
æash_ch_ID_ty³
[4];

183 
io_æow_2
->
Ch_IDs
[0] = 0; io_flow_2->Chip_IDs[1] = 1; io_flow_2->Chip_IDs[2] = 2; io_flow_2->Chip_IDs[3] = 3;

184 
io_æow_2
->
D›_No
 = 2;

185 
io_æow_2
->
D›_IDs
 = 
Ãw
 
æash_d›_ID_ty³
[2];

186 
io_æow_2
->
D›_IDs
[0] = 0; io_flow_2->Die_IDs[1] = 1;

187 
io_æow_2
->
PÏÃ_No
 = 2;

188 
io_æow_2
->
PÏÃ_IDs
 = 
Ãw
 
æash_¶ªe_ID_ty³
[2];

189 
io_æow_2
->
PÏÃ_IDs
[0] = 0; io_flow_2->Plane_IDs[1] = 1;

190 
io_æow_2
->
In™Ÿl_Occu·ncy_P”ûÁage
 = 50;

191 
io_æow_2
->
WÜkšg_S‘_P”ûÁage
 = 85;

192 
io_æow_2
->
SyÁh‘ic_G’”©Ü_Ty³
 = 
Uts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
;

193 
io_æow_2
->
R—d_P”ûÁage
 = 100;

194 
io_æow_2
->
Add»ss_Di¡ributiÚ
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
;

195 
io_æow_2
->
P”ûÁage_of_HÙ_RegiÚ
 = 0;

196 
io_æow_2
->
G’”©ed_AligÃd_Add»s£s
 = 
Œue
;

197 
io_æow_2
->
Add»ss_Alignm’t_Un™
 = 16;

198 
io_æow_2
->
Reque¡_Size_Di¡ributiÚ
 = 
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
FIXED
;

199 
io_æow_2
->
Av”age_Reque¡_Size
 = 8;

200 
io_æow_2
->
V¬Ÿnû_Reque¡_Size
 = 0;

201 
io_æow_2
->
S“d
 = 6533;

202 
io_æow_2
->
Av”age_No_of_Reqs_š_Queue
 = 2;

203 
io_æow_2
->
Bªdwidth
 = 131072;

204 
io_æow_2
->
Stİ_Time
 = 1000000000;

205 
io_æow_2
->
TÙ®_Reque¡s_To_G’”©e
 = 0;

206 
sûÇrio_defš™iÚ
->
	`push_back
(
io_æow_2
);

208 
io_sûÇrios
->
	`push_back
(
sûÇrio_defš™iÚ
);

210 
	`PRINT_MESSAGE
("Writing default workload…arametersoheƒxpected input file.")

212 
Uts
::
XmlWr™”
 
xmlwr™”
;

213 
¡ršg
 
tmp
;

214 
xmlwr™”
.
	`O³n
(
wÜklßd_defs_fe_·th
.
	`c_¡r
());

215 
tmp
 = "MQSim_IO_Scenarios";

216 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

217 
tmp
 = "IO_Scenario";

218 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

220 
io_æow_1
->
	`XML_£rŸlize
(
xmlwr™”
);

221 
io_æow_2
->
	`XML_£rŸlize
(
xmlwr™”
);

223 
xmlwr™”
.
	`Wr™e_şo£_g
();

224 
xmlwr™”
.
	`Wr™e_şo£_g
();

225 
xmlwr™”
.
	`Clo£
();

227 
wÜklßd_defs_fe
.
	`şo£
();

229  
io_sûÇrios
;

230 
	}
}

232 
	$cŞËù_»suÉs
(
SSD_Deviû
& 
ssd
, 
Ho¡_Sy¡em
& 
ho¡
, cÚ¡ * 
ouut_fe_·th
)

234 
Uts
::
XmlWr™”
 
xmlwr™”
;

235 
xmlwr™”
.
	`O³n
(
ouut_fe_·th
);

237 
¡d
::
¡ršg
 
	`tmp
("MQSim_Results");

238 
xmlwr™”
.
	`Wr™e_İ’_g
(
tmp
);

240 
ho¡
.
	`R•Üt_»suÉs_š_XML
("", 
xmlwr™”
);

241 
ssd
.
	`R•Üt_»suÉs_š_XML
("", 
xmlwr™”
);

243 
xmlwr™”
.
	`Wr™e_şo£_g
();

245 
¡d
::
veùÜ
<
Ho¡_CompÚ’ts
::
IO_Flow_Ba£
*> 
IO_æows
 = 
ho¡
.
	`G‘_io_æows
();

246 
¡»am_id
 = 0; sŒ—m_id < 
IO_æows
.
	`size
(); stream_id++) {

247 
cout
 << "Flow " << 
IO_æows
[
¡»am_id
]->
	`ID
(è<< " -Ù®„eque¡ g’”©ed: " << IO_æows[¡»am_id]->
	`G‘_g’”©ed_»que¡_couÁ
()

248 << "Ù®„eque¡ £rviûd:" << 
IO_æows
[
¡»am_id
]->
	`G‘_£rviûd_»que¡_couÁ
(è<< 
’dl
;

249 
cout
 << " - deviû„e¥Ú£ime: " << 
IO_æows
[
¡»am_id
]->
	`G‘_deviû_»¥Ú£_time
() << " (us)"

250 << "ƒnd-to-’d„eque¡ d–ay:" << 
IO_æows
[
¡»am_id
]->
	`G‘_’d_to_’d_»que¡_d–ay
(è<< " (us)" << 
’dl
;

252 
	}
}

254 
	$´št_h–p
()

256 
cout
 << "MQSim - SSD simuÏtÜ w™h bÙh NVMªd SATA ho¡ iÁ”çû behaviÜ, s“ R—dMe.md fÜ d‘as" << 
’dl
 <<

257 "Snd®ÚU§ge:" << 
’dl
 <<

258 "./MQSim [-˜·th/to/cÚfig/fe] [-w…©h/to/wÜklßd/fe]" << 
’dl
;

259 
	}
}

261 
	$maš
(
¬gc
, * 
¬gv
[])

263 
¡ršg
 
ssd_cÚfig_fe_·th
, 
wÜklßd_defs_fe_·th
;

264 ià(
¬gc
 != 5) {

266 
	`´št_h–p
();

270 
	`commªd_lše_¬gs
(
¬gv
, 
ssd_cÚfig_fe_·th
, 
wÜklßd_defs_fe_·th
);

272 
ExecutiÚ_P¬am‘”_S‘
* 
exec_·¿ms
 = 
Ãw
 Execution_Parameter_Set;

273 
	`»ad_cÚfigu¿tiÚ_·¿m‘”s
(
ssd_cÚfig_fe_·th
, 
exec_·¿ms
);

274 
¡d
::
veùÜ
<¡d::veùÜ<
IO_Flow_P¬am‘”_S‘
*>*>* 
io_sûÇrios
 = 
	`»ad_wÜklßd_defš™iÚs
(
wÜklßd_defs_fe_·th
);

276 
úŒ
 = 1;

277 autØ
io_sûn
 = 
io_sûÇrios
->
	`begš
(); io_sûÀ!ğio_sûÇrios->
	`’d
(); io_sûn++, 
úŒ
++) {

278 
	`PRINT_MESSAGE
("HELLO1")

279 
time_t
 
¡¬t_time
 = 
	`time
(0);

280 * 
dt
 = 
	`ùime
(&
¡¬t_time
);

281 
	`PRINT_MESSAGE
("MQSim s¹ed‡ˆ" << 
dt
)

282 
	`PRINT_MESSAGE
("******************************")

283 
	`PRINT_MESSAGE
("Executšg sûÇriØ" << 
úŒ
 << " ouˆoà" << 
io_sûÇrios
->
	`size
() << " .......")

286 
SimuÏtÜ
->
	`Re£t
();

288 
exec_·¿ms
->
Ho¡_CÚfigu¿tiÚ
.
IO_Flow_Defš™iÚs
.
	`ş—r
();

289 autØ
io_æow_def
 = (*
io_sûn
)->
	`begš
(); io_æow_deà!ğ(*io_sûn)->
	`’d
(); io_flow_def++) {

290 
exec_·¿ms
->
Ho¡_CÚfigu¿tiÚ
.
IO_Flow_Defš™iÚs
.
	`push_back
(*
io_æow_def
);

293 
SSD_Deviû
 
	`ssd
(&
exec_·¿ms
->
SSD_Deviû_CÚfigu¿tiÚ
, &exec_·¿ms->
Ho¡_CÚfigu¿tiÚ
.
IO_Flow_Defš™iÚs
);

294 
exec_·¿ms
->
Ho¡_CÚfigu¿tiÚ
.
IÅut_fe_·th
 = 
wÜklßd_defs_fe_·th
.
	`sub¡r
(0, wÜklßd_defs_fe_·th.
	`fšd_Ï¡_of
("."));

295 
Ho¡_Sy¡em
 
	`ho¡
(&
exec_·¿ms
->
Ho¡_CÚfigu¿tiÚ
,ƒxec_·¿ms->
SSD_Deviû_CÚfigu¿tiÚ
.
EÇbËd_P»cÚd™iÚšg
, 
ssd
.
Ho¡_š‹rçû
);

296 
ho¡
.
	`A‰ach_ssd_deviû
(&
ssd
);

298 
SimuÏtÜ
->
	`S¹_simuÏtiÚ
();

300 
time_t
 
’d_time
 = 
	`time
(0);

301 
dt
 = 
	`ùime
(&
’d_time
);

302 
	`PRINT_MESSAGE
("MQSim fšished‡ˆ" << 
dt
)

303 
ušt64_t
 
du¿tiÚ
 = (ušt64_t)
	`difáime
(
’d_time
, 
¡¬t_time
);

304 
	`PRINT_MESSAGE
("TÙ® simuÏtiÚime: " << 
du¿tiÚ
 / 3600 << ":" << (duration % 3600) / 60 << ":" << ((duration % 3600) % 60))

305 
	`PRINT_MESSAGE
("");

307 
	`PRINT_MESSAGE
("Writing„esultso output file .......");

308 
	`cŞËù_»suÉs
(
ssd
, 
ho¡
, (
wÜklßd_defs_fe_·th
.
	`sub¡r
(0, wÜklßd_defs_fe_·th.
	`fšd_Ï¡_of
(".")è+ "_sûÇrio_" + 
¡d
::
	`to_¡ršg
(
úŒ
è+ ".xml").
	`c_¡r
());

311 
cout
 << "SimuÏtiÚ com¶‘e; P»s ªy keyØex™." << 
’dl
;

313 
cš
.
	`g‘
();

316 
	}
}

	@src/nvm_chip/NVM_Chip.h

1 #iâdeà
NVM_CHIP_H


2 
	#NVM_CHIP_H


	)

4 
	~"../sim/Sim_Objeù.h
"

5 
	~"NVM_MemÜy_Add»ss.h
"

7 
Çme¥aû
 
	gNVM


9 şas 
	cNVM_Ch
 : 
public
 
MQSimEngše
::
Sim_Objeù


11 
public
:

12 
NVM_Ch
(cÚ¡ 
sim_objeù_id_ty³
& 
id
è: 
Sim_Objeù
(id) {}

13 
vœtu®
 
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(cÚ¡ 
NVM_MemÜy_Add»ss
* 
add»ss
, cÚ¡ * 
¡©us_šfo
) = 0;

	@src/nvm_chip/NVM_Memory_Address.h

1 #iâdeà
NVM_MEMORY_ADDRESS_H


2 
	#NVM_MEMORY_ADDRESS_H


	)

4 
Çme¥aû
 
	gNVM


6 şas 
	cNVM_MemÜy_Add»ss


	@src/nvm_chip/NVM_Types.h

1 #iâdeà 
NVM_TYPES_H


2 
	#NVM_TYPES_H


	)

4 
	~<c¡dšt
>

6 
Çme¥aû
 
	gNVM


8 şas 
	cNVM_Ty³
 {
	gFLASH
};

9 
ušt64_t
 
	tmemÜy_cÚ‹Á_ty³
;

	@src/nvm_chip/flash_memory/Block.cpp

1 
	~"Block.h
"

3 
Çme¥aû
 
	gNVM


5 
Çme¥aû
 
	gFÏshMemÜy


7 
	gBlock
::
Block
(
PagesNoP”Block
, 
æash_block_ID_ty³
 
BlockID
)

9 
	gID
 = 
BlockID
;

10 
	gPages
 = 
Ãw
 
Page
[
PagesNoP”Block
];

13 
	gBlock
::~
Block
()

15 
d–‘e
[] 
Pages
;

	@src/nvm_chip/flash_memory/Block.h

1 #iâdeà
BLOCK_H


2 
	#BLOCK_H


	)

4 
	~"FÏshTy³s.h
"

5 
	~"Page.h
"

8 
Çme¥aû
 
	gNVM


10 
Çme¥aû
 
	gFÏshMemÜy


12 şas 
	cBlock


14 
	gpublic
:

15 
Block
(
PagesNoP”Block
, 
æash_block_ID_ty³
 
BlockID
);

16 ~
Block
();

17 
Page
* 
	gPages
;

18 
æash_block_ID_ty³
 
	gID
;

	@src/nvm_chip/flash_memory/Die.cpp

1 
	~"D›.h
"

3 
Çme¥aû
 
	gNVM


5 
Çme¥aû
 
	gFÏshMemÜy


7 
	gD›
::
D›
(
PÏÃsNoP”D›
, 
BlocksNoP”PÏÃ
, 
PagesNoP”Block
) :

8 
PÏÃ_no
(
PÏÃsNoP”D›
),

9 
Stus
(
D›Stus
::
IDLE
), 
CommªdFšishEv’t
(
NULL
), 
Ex³ùed_fšish_time
(
INVALID_TIME
), 
RemaššgSu¥’dedExecTime
(INVALID_TIME),

10 
Cu¼’tCMD
(
NULL
), 
Su¥’dedCMD
(NULL), 
Su¥’ded
(
çl£
),

11 
STAT_TÙ®Prog¿mTime
(0), 
STAT_TÙ®R—dTime
(0), 
STAT_TÙ®E¿£Time
(0), 
STAT_TÙ®XãrTime
(0)

13 
	gPÏÃs
 = 
Ãw
 
PÏÃ
*[
PÏÃsNoP”D›
];

14 
	gi
 = 0; i < 
	gPÏÃsNoP”D›
; i++) {

15 
	gPÏÃs
[
i
] = 
Ãw
 
PÏÃ
(
BlocksNoP”PÏÃ
, 
PagesNoP”Block
);

19 
	gD›
::~
D›
()

21 
¶ªeID
 = 0; 
	g¶ªeID
 < 
	gPÏÃ_no
;…laneID++) {

22 
d–‘e
 
	gPÏÃs
[
¶ªeID
];

24 
	gd–‘e
[] 
	gPÏÃs
;

	@src/nvm_chip/flash_memory/Die.h

1 #iâdeà
DIE_H


2 
	#DIE_H


	)

4 
	~"../../sim/Sim_Ev’t.h
"

5 
	~"FÏshTy³s.h
"

6 
	~"PÏÃ.h
"

8 
Çme¥aû
 
	gNVM


10 
Çme¥aû
 
	gFÏshMemÜy


12 şas 
	cD›Stus
 { 
	gBUSY
, 
	gIDLE
 };

13 şas 
	cD›


15 
	gpublic
:

16 
D›
(
PÏÃsNoP”D›
, 
BlocksNoP”PÏÃ
, 
PagesNoP”Block
);

17 ~
D›
();

18 
PÏÃ
** 
	gPÏÃs
;

19 
	gPÏÃ_no
;

20 
D›Stus
 
	gStus
;

21 
	gMQSimEngše
::
Sim_Ev’t
* 
CommªdFšishEv’t
;

22 
sim_time_ty³
 
	gEx³ùed_fšish_time
;

23 
sim_time_ty³
 
	gRemaššgSu¥’dedExecTime
;

24 
FÏsh_Commªd
* 
	gCu¼’tCMD
, *
	gSu¥’dedCMD
;

25 
boŞ
 
	gSu¥’ded
;

27 
sim_time_ty³
 
	gSTAT_TÙ®Prog¿mTime
, 
	gSTAT_TÙ®R—dTime
, 
	gSTAT_TÙ®E¿£Time
, 
	gSTAT_TÙ®XãrTime
;

	@src/nvm_chip/flash_memory/FlashTypes.h

1 #iâdeà
FLASH_TYPES_H


2 
	#FLASH_TYPES_H


	)

4 
	~<c¡dšt
>

5 
	~"../../sim/Sim_Defs.h
"

6 
	~"../NVM_Ty³s.h
"

8 
Çme¥aû
 
	gNVM


10 
Çme¥aû
 
	gFÏshMemÜy


12 şas 
	cCommªd_Su¥’siÚ_Mode
 { 
	gNONE
, 
	gPROGRAM
, 
	gPROGRAM_ERASE
, 
	gERASE
 };

16 
ušt64_t
 
	t·ge_¡©us_ty³
;

17 
	#FULL_PROGRAMMED_PAGE
 0xffffffffffffffffULL

	)

18 
ušt32_t
 
	tæash_chªÃl_ID_ty³
;

19 
ušt32_t
 
	tæash_ch_ID_ty³
;

20 
ušt32_t
 
	tæash_d›_ID_ty³
;

21 
ušt32_t
 
	tæash_¶ªe_ID_ty³
;

22 
ušt32_t
 
	tæash_block_ID_ty³
;

23 
ušt32_t
 
	tæash_·ge_ID_ty³
;

24 
ušt64_t
 
	tLPA_ty³
;

25 
ušt64_t
 
	tPPA_ty³
;

26 
ušt64_t
 
	tcommªd_code_ty³
;

28 şas 
	cFÏsh_TechnŞogy_Ty³
 { 
	mSLC
 = 1, 
	mMLC
 = 2, 
	mTLC
 = 3 };

30 
	#FREE_PAGE
 0x0000000000000000ULL

	)

31 
	#NO_LPA
 0xffffffffffffffffULL

	)

32 
	#NO_STREAM
 0xff

	)

33 
	#UNWRITTEN_LOGICAL_PAGE
 0x0000000000000000ULL

	)

34 
	#NO_PPA
 0xffffffffffffffffULL

	)

35 
	#NO_MPPN
 0xffffffffULL

	)

	@src/nvm_chip/flash_memory/Flash_Chip.cpp

1 
	~"../../sim/Sim_Defs.h
"

2 
	~"../../sim/Engše.h
"

3 
	~"FÏsh_Ch.h
"

6 
Çme¥aû
 
	gNVM


8 
Çme¥aû
 
	gFÏshMemÜy


10 
	gFÏsh_Ch
::
FÏsh_Ch
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
æash_chªÃl_ID_ty³
 
chªÃlID
, 
æash_ch_ID_ty³
 
loÿlChID
,

11 
FÏsh_TechnŞogy_Ty³
 
æash_‹chnŞogy
,

12 
d›No
, 
PÏÃNoP”D›
, 
Block_no_³r_¶ªe
, 
Page_no_³r_block
,

13 
sim_time_ty³
* 
»adL©’cy
, sim_time_ty³* 
´og¿mL©’cy
, sim_time_ty³ 
”a£L©’cy
,

14 
sim_time_ty³
 
su¥’dProg¿mL©’cy
, sim_time_ty³ 
su¥’dE¿£L©’cy
,

15 
sim_time_ty³
 
commPrÙocŞD–ayR—d
, sim_time_ty³ 
commPrÙocŞD–ayWr™e
, sim_time_ty³ 
commPrÙocŞD–ayE¿£
)

16 : 
NVM_Ch
(
id
), 
ChªÃlID
(
chªÃlID
), 
ChID
(
loÿlChID
), 
æash_‹chnŞogy
(flash_technology),

17 
¡©us
(
IÁ”Çl_Stus
::
IDLE
), 
d›_no
(
d›No
), 
¶ªe_no_š_d›
(
PÏÃNoP”D›
), 
block_no_š_¶ªe
(
Block_no_³r_¶ªe
), 
·ge_no_³r_block
(
Page_no_³r_block
),

18 
_RBSigÇlD–ayR—d
(
commPrÙocŞD–ayR—d
), 
_RBSigÇlD–ayWr™e
(
commPrÙocŞD–ayWr™e
), 
_RBSigÇlD–ayE¿£
(
commPrÙocŞD–ayE¿£
),

19 
Ï¡T¿nsãrS¹
(
INVALID_TIME
), 
executiÚS¹Time
(INVALID_TIME), 
ex³ùedFšishTime
(INVALID_TIME),

20 
STAT_»adCouÁ
(0), 
STAT_´ogamCouÁ
(0), 
STAT_”a£CouÁ
(0),

21 
STAT_tÙ®Su¥’siÚCouÁ
(0), 
STAT_tÙ®ResumeCouÁ
(0),

22 
STAT_tÙ®ExecTime
(0), 
STAT_tÙ®XãrTime
(0), 
STAT_tÙ®Ov”ÏµedXãrExecTime
(0)

30 
	gno_of_READ_acûs£s
=
Ãw
 ***[
d›_no
];

31 
	gd›_id
=0;d›_id<
	gd›_no
;die_id++)

33 
	gno_of_READ_acûs£s
[
d›_id
]=
Ãw
 **[
¶ªe_no_š_d›
];

34 
	g¶ªe_id
=0;¶ªe_id<
	g¶ªe_no_š_d›
;plane_id++)

36 
	gno_of_READ_acûs£s
[
d›_id
][
¶ªe_id
]=
Ãw
 *[
block_no_š_¶ªe
];

37 
	gblock_id
=0;block_id<
	gblock_no_š_¶ªe
;block_id++)

39 
	gno_of_READ_acûs£s
[
d›_id
][
¶ªe_id
][
block_id
]=
Ãw
 [
·ge_no_³r_block
];

40 
	g·ge_id
=0;·ge_id<
	g·ge_no_³r_block
;page_id++)

42 
	gno_of_READ_acûs£s
[
d›_id
][
¶ªe_id
][
block_id
][
·ge_id
]=0;

49 
	gno_of_acûs£s
=
Ãw
 ***[
d›_no
];

50 
	gd›_id
=0;d›_id<
	gd›_no
;die_id++)

52 
	gno_of_acûs£s
[
d›_id
]=
Ãw
 **[
¶ªe_no_š_d›
];

53 
	g¶ªe_id
=0;¶ªe_id<
	g¶ªe_no_š_d›
;plane_id++)

55 
	gno_of_acûs£s
[
d›_id
][
¶ªe_id
]=
Ãw
 *[
block_no_š_¶ªe
];

56 
	gblock_id
=0;block_id<
	gblock_no_š_¶ªe
;block_id++)

58 
	gno_of_acûs£s
[
d›_id
][
¶ªe_id
][
block_id
]=
Ãw
 [
·ge_no_³r_block
];

59 
	g·ge_id
=0;·ge_id<
	g·ge_no_³r_block
;page_id++)

61 
	gno_of_acûs£s
[
d›_id
][
¶ªe_id
][
block_id
][
·ge_id
]=0;

67 
	gb™s_³r_ûÎ
 = 
¡©ic_ÿ¡
<>(
æash_‹chnŞogy
);

68 
	g_»adL©’cy
 = 
Ãw
 
sim_time_ty³
[
b™s_³r_ûÎ
];

69 
	g_´og¿mL©’cy
 = 
Ãw
 
sim_time_ty³
[
b™s_³r_ûÎ
];

70 
	gi
 = 0; i < 
	gb™s_³r_ûÎ
; i++) {

71 
	g_»adL©’cy
[
i
] = 
»adL©’cy
[i];

72 
	g_´og¿mL©’cy
[
i
] = 
´og¿mL©’cy
[i];

74 
	g_”a£L©’cy
 = 
”a£L©’cy
;

75 
	g_su¥’dProg¿mL©’cy
 = 
su¥’dProg¿mL©’cy
;

76 
	g_su¥’dE¿£L©’cy
 = 
su¥’dE¿£L©’cy
;

77 
	gidËD›No
 = 
d›No
;

78 
	gD›s
 = 
Ãw
 
D›
*[
d›No
];

79 
	gd›ID
 = 0; d›ID < 
	gd›No
; dieID++) {

80 
	gD›s
[
d›ID
] = 
Ãw
 
D›
(
PÏÃNoP”D›
, 
Block_no_³r_¶ªe
, 
Page_no_³r_block
);

84 
	gFÏsh_Ch
::~
FÏsh_Ch
()

86 
d›ID
 = 0; 
	gd›ID
 < 
	gd›_no
; dieID++) {

87 
d–‘e
 
	gD›s
[
d›ID
];

89 
	gd–‘e
[] 
	gD›s
;

90 
	gd–‘e
[] 
	g_»adL©’cy
;

91 
	gd–‘e
[] 
	g_´og¿mL©’cy
;

94 
	gd›_id
=0;d›_id<
	gd›_no
;die_id++)

97 
	g¶ªe_id
=0;¶ªe_id<
	g¶ªe_no_š_d›
;plane_id++)

100 
	gblock_id
=0;block_id<
	gblock_no_š_¶ªe
;block_id++)

102 
	gd–‘e
[] 
	gno_of_READ_acûs£s
[
d›_id
][
¶ªe_id
][
block_id
];

104 
	gd–‘e
[] 
	gno_of_READ_acûs£s
[
d›_id
][
¶ªe_id
];

106 
	gd–‘e
[] 
	gno_of_READ_acûs£s
[
d›_id
];

108 
	gd–‘e
[] 
	gno_of_READ_acûs£s
;

109 
	gd›_id
=0;d›_id<
	gd›_no
;die_id++)

112 
	g¶ªe_id
=0;¶ªe_id<
	g¶ªe_no_š_d›
;plane_id++)

115 
	gblock_id
=0;block_id<
	gblock_no_š_¶ªe
;block_id++)

117 
	gd–‘e
[] 
	gno_of_acûs£s
[
d›_id
][
¶ªe_id
][
block_id
];

119 
	gd–‘e
[] 
	gno_of_acûs£s
[
d›_id
][
¶ªe_id
];

121 
	gd–‘e
[] 
	gno_of_acûs£s
[
d›_id
];

123 
	gd–‘e
[] 
	gno_of_acûs£s
;

126 
	gFÏsh_Ch
::
CÚÃù_to_ch_»ady_sigÇl
(
ChR—dySigÇlHªdËrTy³
 
funùiÚ
)

128 
cÚÃùedR—dyHªdËrs
.
push_back
(
funùiÚ
);

131 
	gFÏsh_Ch
::
S¹_simuÏtiÚ
()

135 
FÏsh_Ch
::
V®id©e_simuÏtiÚ_cÚfig
()

137 ià(
D›s
 =ğ
NULL
 || 
d›_no
 == 0) {

138 
PRINT_ERROR
("FÏsh ch " << 
ID
() << ": has‚o dies!")

141 
i
 = 0; 
	gi
 < 
	gd›_no
; i++) {

142 ià(
	gD›s
[
i
]->
	gPÏÃs
 =ğ
NULL
) {

143 
PRINT_ERROR
("FÏsh ch" << 
ID
() << ": die (" + ID() + ") has‚o…lanes!")

148 
	gFÏsh_Ch
::
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(cÚ¡ 
NVM_MemÜy_Add»ss
* 
add»ss
, cÚ¡ * 
¡©us_šfo
)

150 
Physiÿl_Page_Add»ss
* 
	gæash_add»ss
 = (Physiÿl_Page_Add»ss*)
add»ss
;

151 
	gD›s
[
æash_add»ss
->
D›ID
]->
	gPÏÃs
[æash_add»ss->
PÏÃID
]->
	gBlocks
[æash_add»ss->
BlockID
]->
	gPages
[æash_add»ss->
PageID
].
	gM‘ad©a
.
	gLPA
 = *(
LPA_ty³
*)
¡©us_šfo
;

154 
	gFÏsh_Ch
::
S‘up_Œigg”s
()

156 
MQSimEngše
::
Sim_Objeù
::
S‘up_Œigg”s
();

159 
	gFÏsh_Ch
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev
)

161 
Ch_Sim_Ev’t_Ty³
 
ev’tTy³
 = (Ch_Sim_Ev’t_Ty³)
ev
->
Ty³
;

162 
FÏsh_Commªd
* 
	gcommªd
 = (FÏsh_Commªd*)
ev
->
P¬am‘”s
;

164 
	gev’tTy³
) {

165 
	gCh_Sim_Ev’t_Ty³
::
COMMAND_FINISHED
:

166 
fšish_commªd_executiÚ
(
commªd
);

171 
LPA_ty³
 
	gFÏsh_Ch
::
G‘_m‘ad©a
(
æash_d›_ID_ty³
 
d›_id
, 
æash_¶ªe_ID_ty³
 
¶ªe_id
, 
æash_block_ID_ty³
 
block_id
, 
æash_·ge_ID_ty³
 
·ge_id
)

173 
Page
* 
	g·ge
 = &(
D›s
[
d›_id
]->
PÏÃs
[
¶ªe_id
]->
Blocks
[
block_id
]->
Pages
[
·ge_id
]);

174  
	gD›s
[
d›_id
]->
	gPÏÃs
[
¶ªe_id
]->
	gBlocks
[
block_id
]->
	gPages
[
·ge_id
].
	gM‘ad©a
.
	gLPA
;

177 
	gFÏsh_Ch
::
¡¬t_commªd_executiÚ
(
FÏsh_Commªd
* 
commªd
)

179 
D›
* 
rg‘D›
 = 
D›s
[
commªd
->
Add»ss
[0].
D›ID
];

182 ià(
	gcommªd
->
	gAdd»ss
.
size
() > 1

183 && (
	gcommªd
->
	gCommªdCode
 =ğ
CMD_READ_PAGE


184 || 
commªd
->
CommªdCode
 =ğ
CMD_PROGRAM_PAGE


185 || 
commªd
->
CommªdCode
 =ğ
CMD_ERASE_BLOCK
)) {

186 
PRINT_ERROR
("FÏsh ch " << 
ID
() << ":ƒxecuting‡ flash operation on‡ busy die!")

189 
rg‘D›
->
Ex³ùed_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
G‘_commªd_executiÚ_Ï‹ncy
(
commªd
->
CommªdCode
, commªd->
Add»ss
[0].
PageID
,command->Address[0]);

190 
	grg‘D›
->
	gCommªdFšishEv’t
 = 
SimuÏtÜ
->
Regi¡”_sim_ev’t
(
rg‘D›
->
Ex³ùed_fšish_time
,

191 
this
, 
commªd
, 
¡©ic_ÿ¡
<>(
Ch_Sim_Ev’t_Ty³
::
COMMAND_FINISHED
));

192 
	grg‘D›
->
	gCu¼’tCMD
 = 
commªd
;

193 
	grg‘D›
->
	gStus
 = 
D›Stus
::
BUSY
;

194 
	gidËD›No
--;

196 ià(
	g¡©us
 =ğ
IÁ”Çl_Stus
::
IDLE
) {

197 
executiÚS¹Time
 = 
SimuÏtÜ
->
Time
();

198 
	gex³ùedFšishTime
 = 
rg‘D›
->
Ex³ùed_fšish_time
;

199 
	g¡©us
 = 
IÁ”Çl_Stus
::
BUSY
;

202 
DEBUG
("CommªdƒxecutiÚ s¹ed oÀchªÃl: " << 
this
->
ChªÃlID
 << " ch: " <<his->
ChID
)

205 
	gFÏsh_Ch
::
fšish_commªd_executiÚ
(
FÏsh_Commªd
* 
commªd
)

207 
D›
* 
rg‘D›
 = 
D›s
[
commªd
->
Add»ss
[0].
D›ID
];

209 
	grg‘D›
->
	gSTAT_TÙ®R—dTime
 +ğ
G‘_commªd_executiÚ_Ï‹ncy
(
commªd
->
CommªdCode
, commªd->
Add»ss
[0].
PageID
,command->Address[0]);

210 
	grg‘D›
->
	gEx³ùed_fšish_time
 = 
INVALID_TIME
;

211 
	grg‘D›
->
	gCommªdFšishEv’t
 = 
NULL
;

212 
	grg‘D›
->
	gCu¼’tCMD
 = 
NULL
;

213 
	grg‘D›
->
	gStus
 = 
D›Stus
::
IDLE
;

214 
	gthis
->
	gidËD›No
++;

215 ià(
	gidËD›No
 =ğ
d›_no
) {

216 
this
->
¡©us
 = 
IÁ”Çl_Stus
::
IDLE
;

217 
	gSTAT_tÙ®ExecTime
 +ğ
SimuÏtÜ
->
Time
(è- 
executiÚS¹Time
;

218 ià(
	gthis
->
	gÏ¡T¿nsãrS¹
 !ğ
INVALID_TIME
) {

219 
STAT_tÙ®Ov”ÏµedXãrExecTime
 +ğ
SimuÏtÜ
->
Time
(è- 
Ï¡T¿nsãrS¹
;

223 
	gcommªd
->
	gCommªdCode
)

225 
	gCMD_READ_PAGE
:

226 
CMD_READ_PAGE_MULTIPLANE
:

227 
CMD_READ_PAGE_COPYBACK
:

228 
CMD_READ_PAGE_COPYBACK_MULTIPLANE
:

229 
DEBUG
("ChªÃÈ" << 
this
->
ChªÃlID
 << " Ch " <<his->
ChID
 << "- Finishedƒxecuting„ead command")

230 
¶ªeCÁr
 = 0; 
	g¶ªeCÁr
 < 
	gcommªd
->
	gAdd»ss
.
size
();…laneCntr++) {

231 
	gSTAT_»adCouÁ
++;

232 
	grg‘D›
->
	gPÏÃs
[
commªd
->
Add»ss
[
¶ªeCÁr
].
	gPÏÃID
]->
	gR—d_couÁ
++;

233 
	grg‘D›
->
	gPÏÃs
[
commªd
->
Add»ss
[
¶ªeCÁr
].
	gPÏÃID
]->
	gBlocks
[commªd->Add»ss[¶ªeCÁr].
	gBlockID
]->
	gPages
[commªd->Add»ss[¶ªeCÁr].
	gPageID
].
R—d_m‘ad©a
(commªd->
M‘a_d©a
[planeCntr]);

236 
	gCMD_PROGRAM_PAGE
:

237 
CMD_PROGRAM_PAGE_MULTIPLANE
:

238 
CMD_PROGRAM_PAGE_COPYBACK
:

239 
CMD_PROGRAM_PAGE_COPYBACK_MULTIPLANE
:

240 
DEBUG
("ChªÃÈ" << 
this
->
ChªÃlID
 << " Ch " <<his->
ChID
 << "- Finishedƒxecuting…rogram command")

241 
¶ªeCÁr
 = 0; 
	g¶ªeCÁr
 < 
	gcommªd
->
	gAdd»ss
.
size
();…laneCntr++) {

242 
	gSTAT_´ogamCouÁ
++;

243 
	grg‘D›
->
	gPÏÃs
[
commªd
->
Add»ss
[
¶ªeCÁr
].
	gPÏÃID
]->
	gProgam_couÁ
++;

244 
	grg‘D›
->
	gPÏÃs
[
commªd
->
Add»ss
[
¶ªeCÁr
].
	gPÏÃID
]->
	gBlocks
[commªd->Add»ss[¶ªeCÁr].
	gBlockID
]->
	gPages
[commªd->Add»ss[¶ªeCÁr].
	gPageID
].
Wr™e_m‘ad©a
(commªd->
M‘a_d©a
[planeCntr]);

247 
	gCMD_ERASE_BLOCK
:

248 
CMD_ERASE_BLOCK_MULTIPLANE
:

250 
¶ªeCÁr
 = 0; 
	g¶ªeCÁr
 < 
	gcommªd
->
	gAdd»ss
.
size
();…laneCntr++) {

251 
	gSTAT_”a£CouÁ
++;

252 
	grg‘D›
->
	gPÏÃs
[
commªd
->
Add»ss
[
¶ªeCÁr
].
	gPÏÃID
]->
	gE¿£_couÁ
++;

253 
Block
* 
	grg‘Block
 = 
rg‘D›
->
PÏÃs
[
commªd
->
Add»ss
[
¶ªeCÁr
].
PÏÃID
]->
Blocks
[commªd->Add»ss[¶ªeCÁr].
BlockID
];

254 
	gi
 = 0; i < 
	g·ge_no_³r_block
; i++) {

257 
	grg‘Block
->
	gPages
[
i
].
	gM‘ad©a
.
	gLPA
 = 
NO_LPA
;

258 
	gno_of_READ_acûs£s
[
commªd
->
Add»ss
[
¶ªeCÁr
].
	gD›ID
][commªd->Add»ss[¶ªeCÁr].
	gPÏÃID
][commªd->Add»ss[¶ªeCÁr].
	gBlockID
][commªd->Add»ss[¶ªeCÁr].
	gPageID
]=0;

264 
PRINT_ERROR
("FÏsh ch " << 
ID
() << ": unhandled flash commandype!")

268 
brßdÿ¡_»ady_sigÇl
(
commªd
);

271 
	gFÏsh_Ch
::
brßdÿ¡_»ady_sigÇl
(
FÏsh_Commªd
* 
commªd
)

273 
¡d
::
veùÜ
<
ChR—dySigÇlHªdËrTy³
>::
™”©Ü
 
™
 = 
cÚÃùedR—dyHªdËrs
.
begš
();

274 
	g™
 !ğ
cÚÃùedR—dyHªdËrs
.
’d
(); it++) {

275 (*
	g™
)(
	gthis
, 
	gcommªd
);

279 
	gFÏsh_Ch
::
Su¥’d
(
æash_d›_ID_ty³
 
d›ID
)

281 
STAT_tÙ®ExecTime
 +ğ
SimuÏtÜ
->
Time
(è- 
executiÚS¹Time
;

283 
D›
* 
	grg‘D›
 = 
D›s
[
d›ID
];

284 ià(
	grg‘D›
->
	gSu¥’ded
) {

285 
PRINT_ERROR
("FÏsh ch" << 
ID
() << ": suspending‡…reviously suspended flash chip! This is illegal.")

291 
	grg‘D›
->
	gRemaššgSu¥’dedExecTime
 = 
rg‘D›
->
Ex³ùed_fšish_time
 - 
SimuÏtÜ
->
Time
();

292 
	gSimuÏtÜ
->
IgnÜe_sim_ev’t
(
rg‘D›
->
CommªdFšishEv’t
);

293 
	grg‘D›
->
	gCommªdFšishEv’t
 = 
NULL
;

295 
	grg‘D›
->
	gSu¥’dedCMD
 = 
rg‘D›
->
Cu¼’tCMD
;

296 
	grg‘D›
->
	gCu¼’tCMD
 = 
NULL
;

297 
	grg‘D›
->
	gSu¥’ded
 = 
Œue
;

298 
	gSTAT_tÙ®Su¥’siÚCouÁ
++;

300 
	grg‘D›
->
	gStus
 = 
D›Stus
::
IDLE
;

301 
	gthis
->
	gidËD›No
++;

302 ià(
	gthis
->
	gidËD›No
 =ğ
d›_no
) {

303 
this
->
¡©us
 = 
IÁ”Çl_Stus
::
IDLE
;

306 
	gexecutiÚS¹Time
 = 
INVALID_TIME
;

307 
	gex³ùedFšishTime
 = 
INVALID_TIME
;

310 
	gFÏsh_Ch
::
Resume
(
æash_d›_ID_ty³
 
d›ID
)

312 
D›
* 
rg‘D›
 = 
D›s
[
d›ID
];

313 ià(!
	grg‘D›
->
	gSu¥’ded
) {

314 
PRINT_ERROR
("FÏsh ch " << 
ID
() << ":„esume flash command is„equested, buthere is‚o suspended flash command!")

317 
	grg‘D›
->
	gCu¼’tCMD
 = 
rg‘D›
->
Su¥’dedCMD
;

318 
	grg‘D›
->
	gSu¥’dedCMD
 = 
NULL
;

319 
	grg‘D›
->
	gSu¥’ded
 = 
çl£
;

320 
	gSTAT_tÙ®ResumeCouÁ
++;

322 
	grg‘D›
->
	gEx³ùed_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
rg‘D›
->
RemaššgSu¥’dedExecTime
;

323 
	grg‘D›
->
	gCommªdFšishEv’t
 = 
SimuÏtÜ
->
Regi¡”_sim_ev’t
(
rg‘D›
->
Ex³ùed_fšish_time
,

324 
this
, 
rg‘D›
->
Cu¼’tCMD
, 
¡©ic_ÿ¡
<>(
Ch_Sim_Ev’t_Ty³
::
COMMAND_FINISHED
));

325 ià(
	grg‘D›
->
	gEx³ùed_fšish_time
 > 
	gthis
->
	gex³ùedFšishTime
) {

326 
	gthis
->
	gex³ùedFšishTime
 = 
rg‘D›
->
Ex³ùed_fšish_time
;

329 
	grg‘D›
->
	gStus
 = 
D›Stus
::
BUSY
;

330 
	gthis
->
	gidËD›No
--;

331 
	gthis
->
	g¡©us
 = 
IÁ”Çl_Stus
::
BUSY
;

332 
	gexecutiÚS¹Time
 = 
SimuÏtÜ
->
Time
();

335 
sim_time_ty³
 
	gFÏsh_Ch
::
G‘Su¥’dProg¿mTime
()

337  
_su¥’dProg¿mL©’cy
;

340 
sim_time_ty³
 
	gFÏsh_Ch
::
G‘Su¥’dE¿£Time
()

342  
_su¥’dE¿£L©’cy
;

345 
	gFÏsh_Ch
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

347 
¡d
::
¡ršg
 
tmp
 = 
Çme_´efix
;

348 
	gxmlwr™”
.
Wr™e_¡¬t_–em’t_g
(
tmp
 + ".FlashChips");

350 
	g¡d
::
¡ršg
 
©Œ
 = "ID";

351 
	g¡d
::
¡ršg
 
v®
 = "@" + 
¡d
::
to_¡ršg
(
ChªÃlID
è+ "@" + std::to_¡ršg(
ChID
);

352 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

354 
	g©Œ
 = "Fraction_of_Time_in_Execution";

355 
	gv®
 = 
¡d
::
to_¡ršg
(
STAT_tÙ®ExecTime
 / (
SimuÏtÜ
->
Time
()));

356 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

358 
	g©Œ
 = "Fraction_of_Time_in_DataXfer";

359 
	gv®
 = 
¡d
::
to_¡ršg
(
STAT_tÙ®XãrTime
 / (
SimuÏtÜ
->
Time
()));

360 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

362 
	g©Œ
 = "Fraction_of_Time_in_DataXfer_and_Execution";

363 
	gv®
 = 
¡d
::
to_¡ršg
(
STAT_tÙ®Ov”ÏµedXãrExecTime
 / (
SimuÏtÜ
->
Time
()));

364 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

366 
	g©Œ
 = "Fraction_of_Time_Idle";

367 
	gv®
 = 
¡d
::
to_¡ršg
((
SimuÏtÜ
->
Time
(è- 
STAT_tÙ®Ov”ÏµedXãrExecTime
 - 
STAT_tÙ®XãrTime
) / (Simulator->Time()));

368 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

370 
	gxmlwr™”
.
Wr™e_’d_–em’t_g
();

	@src/nvm_chip/flash_memory/Flash_Chip.h

1 #iâdeà
FLASH_CHIP_H


2 
	#FLASH_CHIP_H


	)

4 
	~"../../sim/Sim_Defs.h
"

5 
	~"../../sim/Sim_Ev’t.h
"

6 
	~"../../sim/Engše.h
"

7 
	~"../../sim/Sim_R•Ü‹r.h
"

8 
	~"../NVM_Ch.h
"

9 
	~"FÏshTy³s.h
"

10 
	~"D›.h
"

11 
	~"FÏsh_Commªd.h
"

12 
	~<veùÜ
>

13 
	~<¡dexû±
>

14 
	~<cm©h
>

15 
	~<io¡»am
>

16 
	~<c¡dlib
>

17 
	~"../../uts/RªdomG’”©Ü.h
"

18 
Çme¥aû
 
	gNVM


20 
Çme¥aû
 
	gFÏshMemÜy


22 şas 
	cFÏsh_Ch
 : 
public
 
NVM_Ch


40 şas 
	cIÁ”Çl_Stus
 { 
IDLE
, 
	gBUSY
 };

41 şas 
	cCh_Sim_Ev’t_Ty³
 { 
	gCOMMAND_FINISHED
 };

42 
	gpublic
:

43 
FÏsh_Ch
(cÚ¡ 
sim_objeù_id_ty³
&, 
æash_chªÃl_ID_ty³
 
chªÃlID
, 
æash_ch_ID_ty³
 
loÿlChID
,

44 
FÏsh_TechnŞogy_Ty³
 
æash_‹chnŞogy
,

45 
d›No
, 
PÏÃNoP”D›
, 
Block_no_³r_¶ªe
, 
Page_no_³r_block
,

46 
sim_time_ty³
 *
»adL©’cy
, sim_time_ty³ *
´og¿mL©’cy
, sim_time_ty³ 
”a£L©’cy
,

47 
sim_time_ty³
 
su¥’dProg¿mL©’cy
, sim_time_ty³ 
su¥’dE¿£L©’cy
,

48 
sim_time_ty³
 
commPrÙocŞD–ayR—d
 = 20, sim_time_ty³ 
commPrÙocŞD–ayWr™e
 = 0, sim_time_ty³ 
commPrÙocŞD–ayE¿£
 = 0);

49 ~
FÏsh_Ch
();

50 
æash_chªÃl_ID_ty³
 
	gChªÃlID
;

51 
æash_ch_ID_ty³
 
	gChID
;

53 
S¹CMDXãr
()

55 
	gthis
->
	gÏ¡T¿nsãrS¹
 = 
SimuÏtÜ
->
Time
();

57 
S¹CMDD©aInXãr
()

59 
	gthis
->
	gÏ¡T¿nsãrS¹
 = 
SimuÏtÜ
->
Time
();

61 
S¹D©aOutXãr
()

63 
	gthis
->
	gÏ¡T¿nsãrS¹
 = 
SimuÏtÜ
->
Time
();

65 
EndCMDXãr
(
FÏsh_Commªd
* 
commªd
)

67 
	gthis
->
	gSTAT_tÙ®XãrTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
this
->
Ï¡T¿nsãrS¹
);

68 ià(
	gthis
->
	gidËD›No
 !ğ
d›_no
)

69 
STAT_tÙ®Ov”ÏµedXãrExecTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
Ï¡T¿nsãrS¹
);

70 
	gthis
->
	gD›s
[
commªd
->
Add»ss
[0].
	gD›ID
]->
	gSTAT_TÙ®XãrTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
Ï¡T¿nsãrS¹
);

72 
¡¬t_commªd_executiÚ
(
commªd
);

74 
	gthis
->
	gÏ¡T¿nsãrS¹
 = 
INVALID_TIME
;

76 
EndCMDD©aInXãr
(
FÏsh_Commªd
* 
commªd
)

78 
	gthis
->
	gSTAT_tÙ®XãrTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
this
->
Ï¡T¿nsãrS¹
);

79 ià(
	gthis
->
	gidËD›No
 !ğ
d›_no
)

80 
STAT_tÙ®Ov”ÏµedXãrExecTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
Ï¡T¿nsãrS¹
);

81 
	gthis
->
	gD›s
[
commªd
->
Add»ss
[0].
	gD›ID
]->
	gSTAT_TÙ®XãrTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
Ï¡T¿nsãrS¹
);

83 
¡¬t_commªd_executiÚ
(
commªd
);

85 
	gthis
->
	gÏ¡T¿nsãrS¹
 = 
INVALID_TIME
;

87 
EndD©aOutXãr
(
FÏsh_Commªd
* 
commªd
)

89 
	gthis
->
	gSTAT_tÙ®XãrTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
this
->
Ï¡T¿nsãrS¹
);

90 ià(
	gthis
->
	gidËD›No
 !ğ
d›_no
)

91 
STAT_tÙ®Ov”ÏµedXãrExecTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
Ï¡T¿nsãrS¹
);

92 
	gthis
->
	gD›s
[
commªd
->
Add»ss
[0].
	gD›ID
]->
	gSTAT_TÙ®XãrTime
 +ğ(
SimuÏtÜ
->
Time
(è- 
Ï¡T¿nsãrS¹
);

94 
	gthis
->
	gÏ¡T¿nsãrS¹
 = 
INVALID_TIME
;

96 
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(cÚ¡ 
NVM_MemÜy_Add»ss
* 
add»ss
, cÚ¡ * 
¡©us_šfo
);

97 
S¹_simuÏtiÚ
();

98 
V®id©e_simuÏtiÚ_cÚfig
();

99 
S‘up_Œigg”s
();

100 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

101 (*
	gChR—dySigÇlHªdËrTy³
è(
	tFÏsh_Ch
* 
	trg‘Ch
, 
	tFÏsh_Commªd
* 
	tcommªd
);

102 
CÚÃù_to_ch_»ady_sigÇl
(
ChR—dySigÇlHªdËrTy³
);

104 
sim_time_ty³
 
G‘_commªd_executiÚ_Ï‹ncy
(
commªd_code_ty³
 
CMDCode
, 
æash_·ge_ID_ty³
 
·geID
,
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
Add»ss
)

107 
Ï‹ncyTy³
 = 0;

108 ià(
	gæash_‹chnŞogy
 =ğ
FÏsh_TechnŞogy_Ty³
::
MLC
) {

109 
Ï‹ncyTy³
 = 
·geID
 % 2;

110 } ià(
	gæash_‹chnŞogy
 =ğ
FÏsh_TechnŞogy_Ty³
::
TLC
) {

112 
Ï‹ncyTy³
 = (
·geID
 <= 5) ? 0 : ((pageID <= 7) ? 1 : (((pageID - 8) >> 1) % 3));;

116 
	gCMDCode
)

118 
	gCMD_READ_PAGE
:

119 
CMD_READ_PAGE_MULTIPLANE
:

120 
CMD_READ_PAGE_COPYBACK
:

121 
CMD_READ_PAGE_COPYBACK_MULTIPLANE
:

123  
_»adL©’cy
[
Ï‹ncyTy³
]*(1/(1+
no_of_acûs£s
[
Add»ss
.
D›ID
][Add»ss.
PÏÃID
][Add»ss.
BlockID
][Add»ss.
PageID
]*0.1)è+ 
_RBSigÇlD–ayR—d
;

125 
	gCMD_PROGRAM_PAGE
:

126 
CMD_PROGRAM_PAGE_MULTIPLANE
:

127 
CMD_PROGRAM_PAGE_COPYBACK
:

128 
CMD_PROGRAM_PAGE_COPYBACK_MULTIPLANE
:

130  (
sim_time_ty³
)(
_´og¿mL©’cy
[
Ï‹ncyTy³
]*(
no_of_acûs£s
[
Add»ss
.
D›ID
][Add»ss.
PÏÃID
][Add»ss.
BlockID
][Add»ss.
PageID
]+1)*(
¿nd
()%100+1)+ 
_RBSigÇlD–ayWr™e
);

132 
	gno_of_acûs£s
[
Add»ss
.
D›ID
][Add»ss.
PÏÃID
][Add»ss.
BlockID
][Add»ss.
PageID
]++;

134 
	gCMD_ERASE_BLOCK
:

135 
CMD_ERASE_BLOCK_MULTIPLANE
:

138  
_”a£L©’cy
 + 
_RBSigÇlD–ayE¿£
;

140 
throw
 
¡d
::
šv®id_¬gum’t
("Unsupported command for flash chip.");

144 
Su¥’d
(
æash_d›_ID_ty³
 
d›ID
);

145 
Resume
(
æash_d›_ID_ty³
 
d›ID
);

146 
sim_time_ty³
 
G‘Su¥’dProg¿mTime
();

147 
sim_time_ty³
 
G‘Su¥’dE¿£Time
();

148 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

149 
LPA_ty³
 
G‘_m‘ad©a
(
æash_d›_ID_ty³
 
d›_id
, 
æash_¶ªe_ID_ty³
 
¶ªe_id
, 
æash_block_ID_ty³
 
block_id
, 
æash_·ge_ID_ty³
 
·ge_id
);

151 
	g´iv©e
:

153 
FÏsh_TechnŞogy_Ty³
 
æash_‹chnŞogy
;

154 
IÁ”Çl_Stus
 
	g¡©us
;

155 
	gidËD›No
;

156 
D›
** 
	gD›s
;

157 
	gd›_no
;

158 
	g¶ªe_no_š_d›
;

159 
	gblock_no_š_¶ªe
;

160 
	g·ge_no_³r_block
;

161 
sim_time_ty³
 *
	g_»adL©’cy
, *
	g_´og¿mL©’cy
, 
	g_”a£L©’cy
;

162 
sim_time_ty³
 
	g_su¥’dProg¿mL©’cy
, 
	g_su¥’dE¿£L©’cy
;

163 
sim_time_ty³
 
	g_RBSigÇlD–ayR—d
, 
	g_RBSigÇlD–ayWr™e
, 
	g_RBSigÇlD–ayE¿£
;

164 
sim_time_ty³
 
	gÏ¡T¿nsãrS¹
;

165 
sim_time_ty³
 
	gexecutiÚS¹Time
, 
	gex³ùedFšishTime
;

167 **** 
	gno_of_acûs£s
;

168 **** 
	gno_of_READ_acûs£s
;

170 
	gSTAT_»adCouÁ
, 
	gSTAT_´ogamCouÁ
, 
	gSTAT_”a£CouÁ
;

171 
	gSTAT_tÙ®Su¥’siÚCouÁ
, 
	gSTAT_tÙ®ResumeCouÁ
;

172 
sim_time_ty³
 
	gSTAT_tÙ®ExecTime
, 
	gSTAT_tÙ®XãrTime
, 
	gSTAT_tÙ®Ov”ÏµedXãrExecTime
;

174 
¡¬t_commªd_executiÚ
(
FÏsh_Commªd
* 
commªd
);

175 
fšish_commªd_executiÚ
(
FÏsh_Commªd
* 
commªd
);

176 
brßdÿ¡_»ady_sigÇl
(
FÏsh_Commªd
* 
commªd
);

177 
	g¡d
::
veùÜ
<
ChR—dySigÇlHªdËrTy³
> 
cÚÃùedR—dyHªdËrs
;

	@src/nvm_chip/flash_memory/Flash_Command.h

1 #iâdeà
FLASH_COMMAND_H


2 
	#FLASH_COMMAND_H


	)

4 
	~<veùÜ
>

5 
	~"FÏshTy³s.h
"

6 
	~"Physiÿl_Page_Add»ss.h
"

7 
	~"Page.h
"

10 
	#CMD_READ
 0x0030

	)

11 
	#CMD_READ_PAGE
 0x0030

	)

12 
	#CMD_READ_PAGE_CACHE_SEQ
 0x31

	)

13 
	#CMD_READ_PAGE_CACHE_RANDOM
 0x0031

	)

14 
	#CMD_READ_PAGE_MULTIPLANE
 0x0032

	)

15 
	#CMD_READ_PAGE_COPYBACK
 0x0035

	)

16 
	#CMD_READ_PAGE_COPYBACK_MULTIPLANE
 0x00321

17 
	#CMD_PROGRAM
 0x8000

	)

18 
	#CMD_PROGRAM_PAGE
 0x8010

	)

19 
	#CMD_PROGRAM_PAGE_MULTIPLANE
 0x8011

	)

20 
	#CMD_PROGRAM_PAGE_COPYBACK
 0x8510

	)

21 
	#CMD_PROGRAM_PAGE_COPYBACK_MULTIPLANE
 0x85111

24 
	#CMD_ERASE
 0x6000

	)

25 
	#CMD_ERASE_BLOCK
 0x60D0

	)

26 
	#CMD_ERASE_BLOCK_MULTIPLANE
 0x60D1

	)

30 
Çme¥aû
 
	gNVM


32 
Çme¥aû
 
	gFÏshMemÜy


34 şas 
	cFÏsh_Commªd


36 
	gpublic
:

37 
commªd_code_ty³
 
CommªdCode
;

38 
	g¡d
::
veùÜ
<
Physiÿl_Page_Add»ss
> 
Add»ss
;

39 
	g¡d
::
veùÜ
<
PageM‘ad©a
> 
M‘a_d©a
;

	@src/nvm_chip/flash_memory/Page.h

1 #iâdeà
PAGE_H


2 
	#PAGE_H


	)

4 
	~"FÏshTy³s.h
"

6 
Çme¥aû
 
	gNVM


8 
Çme¥aû
 
	gFÏshMemÜy


11 
	sPageM‘ad©a


14 
LPA_ty³
 
	gLPA
;

17 şas 
	cPage
 {

18 
	gpublic
:

19 
Page
()

22 
M‘ad©a
.
LPA
 = 
NO_LPA
;

26 
PageM‘ad©a
 
	gM‘ad©a
;

28 
Wr™e_m‘ad©a
(cÚ¡ 
PageM‘ad©a
& 
m‘ad©a
)

30 
	gthis
->
	gM‘ad©a
.
	gLPA
 = 
m‘ad©a
.
LPA
;

33 
R—d_m‘ad©a
(
PageM‘ad©a
& 
m‘ad©a
)

35 
	gm‘ad©a
.
	gLPA
 = 
this
->
M‘ad©a
.
LPA
;

	@src/nvm_chip/flash_memory/Physical_Page_Address.cpp

1 
	~"Physiÿl_Page_Add»ss.h
"

3 
Çme¥aû
 
	gNVM


5 
Çme¥aû
 
	gFÏshMemÜy


7 
boŞ
 
	gPhysiÿl_Page_Add»ss
::
block_add»ss_cÚ¡¿št_fÜ_muÉÏÃ
 = 
Œue
;

	@src/nvm_chip/flash_memory/Physical_Page_Address.h

1 #iâdeà
PHYSICAL_PAGE_ADDRESS_H


2 
	#PHYSICAL_PAGE_ADDRESS_H


	)

4 
	~"../NVM_MemÜy_Add»ss.h
"

5 
	~"FÏshTy³s.h
"

7 
Çme¥aû
 
	gNVM


9 
Çme¥aû
 
	gFÏshMemÜy


11 şas 
	cPhysiÿl_Page_Add»ss
 : 
public
 
NVM_MemÜy_Add»ss


13 
public
:

14 
æash_chªÃl_ID_ty³
 
chlID
()

16  
ChªÃlID
;

18 
æash_ch_ID_ty³
 
chpID
()

20  
	gChID
;

22 
	g´iv©e
:

23 
boŞ
 
block_add»ss_cÚ¡¿št_fÜ_muÉÏÃ
;

24 
	gpublic
:

25 
æash_chªÃl_ID_ty³
 
ChªÃlID
;

26 
æash_ch_ID_ty³
 
	gChID
;

27 
æash_d›_ID_ty³
 
	gD›ID
;

28 
æash_¶ªe_ID_ty³
 
	gPÏÃID
;

29 
æash_block_ID_ty³
 
	gBlockID
;

30 
æash_·ge_ID_ty³
 
	gPageID
;

32 
Physiÿl_Page_Add»ss
(cÚ¡ 
æash_chªÃl_ID_ty³
 
chªÃl_id
 = 0, cÚ¡ 
æash_ch_ID_ty³
 
ch_id
 = 0, cÚ¡ 
æash_d›_ID_ty³
 
d›_id
 = 0,

33 cÚ¡ 
æash_¶ªe_ID_ty³
 
¶ªe_id
 = 0, cÚ¡ 
æash_block_ID_ty³
 
block_id
 = 0, cÚ¡ 
æash_·ge_ID_ty³
 
·ge_id
 = 0)

35 
ChªÃlID
 = 
chªÃl_id
;

36 
	gChID
 = 
ch_id
;

37 
	gD›ID
 = 
d›_id
;

38 
	gPÏÃID
 = 
¶ªe_id
;

39 
	gBlockID
 = 
block_id
;

40 
	gPageID
 = 
·ge_id
;

43 
Physiÿl_Page_Add»ss
(cÚ¡ Physiÿl_Page_Add»ss& 
add»ssToCİy
)

45 
	gChªÃlID
 = 
add»ssToCİy
.
ChªÃlID
;

46 
	gChID
 = 
add»ssToCİy
.
ChID
;

47 
	gD›ID
 = 
add»ssToCİy
.
D›ID
;

48 
	gPÏÃID
 = 
add»ssToCİy
.
PÏÃID
;

49 
	gBlockID
 = 
add»ssToCİy
.
BlockID
;

50 
	gPageID
 = 
add»ssToCİy
.
PageID
;

53 
S‘BlockAdd»ssCÚ¡¿št
(cÚ¡ 
boŞ
 
BACÚ¡¿št
)

55 
	gblock_add»ss_cÚ¡¿št_fÜ_muÉÏÃ
 = 
BACÚ¡¿št
;

	@src/nvm_chip/flash_memory/Plane.cpp

1 
	~"PÏÃ.h
"

3 
Çme¥aû
 
	gNVM


5 
Çme¥aû
 
	gFÏshMemÜy


7 
	gPÏÃ
::
PÏÃ
(
BlocksNoP”PÏÃ
, 
PagesNoP”Block
) :

8 
R—d_couÁ
(0), 
Progam_couÁ
(0), 
E¿£_couÁ
(0)

10 
	gH—Éhy_block_no
 = 
BlocksNoP”PÏÃ
;

11 
	gBlocks
 = 
Ãw
 
Block
*[
BlocksNoP”PÏÃ
];

12 
	gi
 = 0; i < 
	gBlocksNoP”PÏÃ
; i++) {

13 
	gBlocks
[
i
] = 
Ãw
 
Block
(
PagesNoP”Block
, i);

15 
	gAÎoÿ‹d_¡»ams
 = 
NULL
;

18 
	gPÏÃ
::~
PÏÃ
()

20 
i
 = 0; 
	gi
 < 
	gH—Éhy_block_no
; i++) {

21 
d–‘e
 
	gBlocks
[
i
];

23 
	gd–‘e
[] 
	gBlocks
;

	@src/nvm_chip/flash_memory/Plane.h

1 #iâdeà
PLANE_H


2 
	#PLANE_H


	)

4 
	~"../NVM_Ty³s.h
"

5 
	~"FÏshTy³s.h
"

6 
	~"Block.h
"

7 
	~"FÏsh_Commªd.h
"

9 
Çme¥aû
 
	gNVM


11 
Çme¥aû
 
	gFÏshMemÜy


13 şas 
	cPÏÃ


15 
	gpublic
:

16 
PÏÃ
(
BlocksNoP”PÏÃ
, 
PagesNoP”Block
);

17 ~
PÏÃ
();

18 
Block
** 
	gBlocks
;

19 
	gH—Éhy_block_no
;

20 
	gR—d_couÁ
;

21 
	gProgam_couÁ
;

22 
	gE¿£_couÁ
;

23 
¡»am_id_ty³
* 
	gAÎoÿ‹d_¡»ams
;

	@src/sim/Engine.cpp

1 
	~<¡dexû±
>

2 
	~"Engše.h
"

3 
	~"../uts/Logiÿl_Add»ss_P¬t™iÚšg_Un™.h
"

5 
Çme¥aû
 
	gMQSimEngše


7 
Engše
* 
	gEngše
::
_š¡ªû
 = 
NULL
;

9 
Engše
* 
	gEngše
::
In¡ªû
() {

10 ià(
_š¡ªû
 == 0) {

11 
_š¡ªû
 = 
Ãw
 
Engše
;

13  
	g_š¡ªû
;

16 
	gEngše
::
Re£t
()

18 
_Ev’tLi¡
->
CË¬
();

19 
	g_ObjeùLi¡
.
ş—r
();

20 
	g_sim_time
 = 0;

21 
	g¡İ
 = 
çl£
;

22 
	g¡¬‹d
 = 
çl£
;

23 
	gUts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
Re£t
();

28 
	gEngše
::
AddObjeù
(
Sim_Objeù
* 
obj
)

30 ià(
_ObjeùLi¡
.
fšd
(
obj
->
ID
()è!ğ_ObjeùLi¡.
’d
()) {

31 
throw
 
¡d
::
šv®id_¬gum’t
("Du¶iÿ‹ objeù key: " + 
obj
->
ID
());

33 
	g_ObjeùLi¡
.
š£¹
(
¡d
::
·œ
<
sim_objeù_id_ty³
, 
Sim_Objeù
*>(
obj
->
ID
(), obj));

36 
Sim_Objeù
* 
	gEngše
::
G‘Objeù
(
sim_objeù_id_ty³
 
objeù_id
)

38 autØ
™r
 = 
_ObjeùLi¡
.
fšd
(
objeù_id
);

39 ià(
	g™r
 =ğ
_ObjeùLi¡
.
’d
()) {

40  
NULL
;

43  (*
	g™r
).
	g£cÚd
;

46 
	gEngše
::
RemoveObjeù
(
Sim_Objeù
* 
obj
)

48 
¡d
::
unÜd”ed_m­
<
sim_objeù_id_ty³
, 
	gSim_Objeù
*>::
™”©Ü
 
™
 = 
_ObjeùLi¡
.
fšd
(
obj
->
ID
());

49 ià(
	g™
 =ğ
_ObjeùLi¡
.
’d
()) {

50 
throw
 
¡d
::
šv®id_¬gum’t
("Removing‡n unregistered object.");

52 
	g_ObjeùLi¡
.
”a£
(
™
);

56 
	gEngše
::
S¹_simuÏtiÚ
()

58 
¡¬‹d
 = 
Œue
;

60 
	g¡d
::
unÜd”ed_m­
<
sim_objeù_id_ty³
, 
	gSim_Objeù
*>::
™”©Ü
 
obj
 = 
_ObjeùLi¡
.
begš
();

61 
	gobj
 !ğ
_ObjeùLi¡
.
’d
();

62 ++
	gobj
) {

63 ià(!
	gobj
->
	g£cÚd
->
IsTrigg”sS‘Up
()) {

64 
	gobj
->
	g£cÚd
->
S‘up_Œigg”s
();

68 
	g¡d
::
unÜd”ed_m­
<
sim_objeù_id_ty³
, 
	gSim_Objeù
*>::
™”©Ü
 
obj
 = 
_ObjeùLi¡
.
begš
();

69 
	gobj
 !ğ
_ObjeùLi¡
.
’d
();

70 ++
	gobj
) {

71 
	gobj
->
	g£cÚd
->
V®id©e_simuÏtiÚ_cÚfig
();

74 
	g¡d
::
unÜd”ed_m­
<
sim_objeù_id_ty³
, 
	gSim_Objeù
*>::
™”©Ü
 
obj
 = 
_ObjeùLi¡
.
begš
();

75 
	gobj
 !ğ
_ObjeùLi¡
.
’d
();

76 ++
	gobj
) {

77 
	gobj
->
	g£cÚd
->
S¹_simuÏtiÚ
();

80 
Sim_Ev’t
* 
	gev
 = 
NULL
;

81 
	gŒue
) {

82 ià(
	g_Ev’tLi¡
->
	gCouÁ
 =ğ0 || 
¡İ
) {

86 
Ev’tT»eNode
* 
	gmšNode
 = 
_Ev’tLi¡
->
G‘_mš_node
();

87 
	gev
 = 
mšNode
->
Fœ¡SimEv’t
;

89 
	g_sim_time
 = 
ev
->
Fœe_time
;

91 
	gev
 !ğ
NULL
) {

92 if(!
ev
->
IgnÜe
) {

93 
ev
->
T¬g‘_sim_objeù
->
Execu‹_simuÏtÜ_ev’t
(ev);

95 
Sim_Ev’t
* 
	gcÚsumed_ev’t
 = 
ev
;

96 
	gev
 = 
ev
->
Next_ev’t
;

97 
d–‘e
 
	gcÚsumed_ev’t
;

99 
	g_Ev’tLi¡
->
Remove
(
mšNode
);

103 
	gEngše
::
Stİ_simuÏtiÚ
()

105 
¡İ
 = 
Œue
;

108 
boŞ
 
	gEngše
::
Has_¡¬‹d
()

110  
¡¬‹d
;

113 
sim_time_ty³
 
	gEngše
::
Time
()

115  
_sim_time
;

118 
Sim_Ev’t
* 
	gEngše
::
Regi¡”_sim_ev’t
(
sim_time_ty³
 
fœeTime
, 
Sim_Objeù
* 
rg‘Objeù
, * 
·¿m‘”s
, 
ty³
)

120 
Sim_Ev’t
* 
	gev
 = 
Ãw
 Sim_Ev’t(
fœeTime
, 
rg‘Objeù
, 
·¿m‘”s
, 
ty³
);

121 
DEBUG
("Regi¡”Ev’ˆ" << 
fœeTime
 << " " << 
rg‘Objeù
)

122 
	g_Ev’tLi¡
->
In£¹_sim_ev’t
(
ev
);

123  
	gev
;

126 
	gEngše
::
IgnÜe_sim_ev’t
(
Sim_Ev’t
* 
ev
)

128 
ev
->
IgnÜe
 = 
Œue
;

131 
boŞ
 
	gEngše
::
Is_š‹g¿‹d_executiÚ_mode
()

133  
çl£
;

	@src/sim/Engine.h

1 #iâdeà
ENGINE_H


2 
	#ENGINE_H


	)

4 
	~<io¡»am
>

5 
	~<unÜd”ed_m­
>

6 
	~"Sim_Defs.h
"

7 
	~"Ev’tT»e.h
"

8 
	~"Sim_Objeù.h
"

10 
Çme¥aû
 
	gMQSimEngše
 {

11 şas 
	cEngše


13 
ä›nd
 
şass
 
	gEv’tT»e
;

14 
	gpublic
:

15 
Engše
()

17 
this
->
_Ev’tLi¡
 = 
Ãw
 
Ev’tT»e
;

18 
	g¡¬‹d
 = 
çl£
;

21 ~
Engše
() {

22 
d–‘e
 
	g_Ev’tLi¡
;

25 
Engše
* 
In¡ªû
();

26 
sim_time_ty³
 
Time
();

27 
Sim_Ev’t
* 
Regi¡”_sim_ev’t
(
sim_time_ty³
 
fœeTime
, 
Sim_Objeù
* 
rg‘Objeù
, * 
·¿m‘”s
 = 
NULL
, 
ty³
 = 0);

28 
IgnÜe_sim_ev’t
(
Sim_Ev’t
*);

29 
Re£t
();

30 
AddObjeù
(
Sim_Objeù
* 
obj
);

31 
Sim_Objeù
* 
G‘Objeù
(
sim_objeù_id_ty³
 
objeù_id
);

32 
RemoveObjeù
(
Sim_Objeù
* 
obj
);

33 
S¹_simuÏtiÚ
();

34 
Stİ_simuÏtiÚ
();

35 
boŞ
 
Has_¡¬‹d
();

36 
boŞ
 
Is_š‹g¿‹d_executiÚ_mode
();

37 
	g´iv©e
:

38 
sim_time_ty³
 
_sim_time
;

39 
Ev’tT»e
* 
	g_Ev’tLi¡
;

40 
	g¡d
::
unÜd”ed_m­
<
sim_objeù_id_ty³
, 
	gSim_Objeù
*> 
	g_ObjeùLi¡
;

41 
boŞ
 
	g¡İ
;

42 
boŞ
 
	g¡¬‹d
;

43 
Engše
* 
	g_š¡ªû
;

47 
	#SimuÏtÜ
 
MQSimEngše
::
Engše
::
	`In¡ªû
()

	)

	@src/sim/EventTree.cpp

1 
	~<exû±iÚ
>

2 
	~"Ev’tT»e.h
"

3 
	~"Engše.h
"

5 
Çme¥aû
 
	gMQSimEngše


7 
şass
 
	gEngše
;

9 
Ev’tT»eNode
* 
	gEv’tT»e
::
S’tš–Node
 = 
NULL
;

11 
	gEv’tT»e
::
Ev’tT»e
()

15 
S’tš–Node
 = 
Ãw
 
Ev’tT»eNode
();

16 
	gS’tš–Node
->
	gLeá
 = 
NULL
;

17 
	gS’tš–Node
->
	gRight
 = 
NULL
;

18 
	gS’tš–Node
->
	gP¬’t
 = 
NULL
;

19 
	gS’tš–Node
->
	gCŞÜ
 = 1;

20 
	grbT»e
 = 
S’tš–Node
;

21 
	gÏ¡NodeFound
 = 
S’tš–Node
;

24 
	gEv’tT»e
::~
Ev’tT»e
()

26 ià(
S’tš–Node
 !ğ
NULL
)

27 
d–‘e
 
S’tš–Node
;

36 
	gEv’tT»e
::
Add
(
sim_time_ty³
 
key
, 
Sim_Ev’t
* 
d©a
)

40 
Ev’tT»eNode
* 
	gnode
 = 
Ãw
 EventTreeNode();

42 
Ev’tT»eNode
* 
	g‹mp
 = 
rbT»e
;

44 
	g‹mp
 !ğ
S’tš–Node
) {

46 
node
->
P¬’t
 = 
‹mp
;

48 ià(
	gkey
 > 
	g‹mp
->
	gKey
)

49 
	g‹mp
 = 
‹mp
->
Right
;

51 
	g‹mp
 = 
‹mp
->
Leá
;

55 
	gnode
->
	gKey
 = 
key
;

56 
	gnode
->
	gFœ¡SimEv’t
 = 
d©a
;

57 
	gnode
->
	gLa¡SimEv’t
 = 
d©a
;

58 
	gnode
->
	gLeá
 = 
S’tš–Node
;

59 
	gnode
->
	gRight
 = 
S’tš–Node
;

62 ià(
	gnode
->
	gP¬’t
 !ğ
NULL
) {

63 ià(
node
->
Key
 > (node->
P¬’t
->Key)) {

64 
node
->
P¬’t
->
Right
 =‚ode;

66 
	gnode
->
	gP¬’t
->
	gLeá
 = 
node
;

70 
	grbT»e
 = 
node
;

74 
Re¡ÜeAá”In£¹
(
node
);

75 
	gÏ¡NodeFound
 = 
node
;

76 
	gCouÁ
++;

85 
	gEv’tT»e
::
Re¡ÜeAá”In£¹
(
Ev’tT»eNode
* 
x
)

90 
Ev’tT»eNode
* 
y
;

93 
	gx
 !ğ
rbT»e
 && 
x
->
P¬’t
->
CŞÜ
 == 0) {

97 ià(
x
->
P¬’t
 =ğx->P¬’t->P¬’t->
Leá
) {

99 
y
 = 
x
->
P¬’t
->P¬’t->
Right
;

100 ià(
	gy
 !ğ
NULL
 && 
y
->
CŞÜ
 == 0)

102 
x
->
P¬’t
->
CŞÜ
 = 1;

103 
	gy
->
	gCŞÜ
 = 1;

106 
	gx
->
	gP¬’t
->P¬’t->
	gCŞÜ
 = 0;

107 
	gx
 = 
x
->
P¬’t
->Parent;

110 ià(
	gx
 =ğ
x
->
P¬’t
->
Right
)

113 
x
 = x->
P¬’t
;

114 
RÙ©eLeá
(
x
);

117 
	gx
->
	gP¬’t
->
	gCŞÜ
 = 1;

118 
	gx
->
	gP¬’t
->P¬’t->
	gCŞÜ
 = 0;

119 
RÙ©eRight
(
x
->
P¬’t
->Parent);

124 
	gy
 = 
x
->
P¬’t
->P¬’t->
Leá
;

125 ià(
	gy
 !ğ
NULL
 && 
y
->
CŞÜ
 == 0) {

126 
x
->
P¬’t
->
CŞÜ
 = 1;

127 
	gy
->
	gCŞÜ
 = 1;

128 
	gx
->
	gP¬’t
->P¬’t->
	gCŞÜ
 = 0;

129 
	gx
 = 
x
->
P¬’t
->Parent;

131 ià(
	gx
 =ğ
x
->
P¬’t
->
Leá
) {

132 
x
 = x->
P¬’t
;

133 
RÙ©eRight
(
x
);

135 
	gx
->
	gP¬’t
->
	gCŞÜ
 = 1;

136 
	gx
->
	gP¬’t
->P¬’t->
	gCŞÜ
 = 0;

137 
RÙ©eLeá
(
x
->
P¬’t
->Parent);

143 
	grbT»e
->
	gCŞÜ
 = 1;

150 
	gEv’tT»e
::
RÙ©eLeá
(
Ev’tT»eNode
* 
x
)

156 
Ev’tT»eNode
* 
y
 = 
x
->
Right
;

159 
	gx
->
	gRight
 = 
y
->
Leá
;

162 ià(
	gy
->
	gLeá
 !ğ
S’tš–Node
)

163 
y
->
Leá
->
P¬’t
 = 
x
;

165 ià(
	gy
 !ğ
S’tš–Node
)

166 
y
->
P¬’t
 = 
x
->Parent;

168 ià(
	gx
->
	gP¬’t
 !ğ
NULL
)

170 ià(
x
 =ğx->
P¬’t
->
Leá
)

171 
x
->
P¬’t
->
Leá
 = 
y
;

173 
	gx
->
	gP¬’t
->
	gRight
 = 
y
;

176 
	grbT»e
 = 
y
;

179 
	gy
->
	gLeá
 = 
x
;

180 ià(
	gx
 !ğ
S’tš–Node
)

181 
x
->
P¬’t
 = 
y
;

187 
	gEv’tT»e
::
RÙ©eRight
(
Ev’tT»eNode
* 
x
)

193 
Ev’tT»eNode
* 
y
 = 
x
->
Leá
;

196 
	gx
->
	gLeá
 = 
y
->
Right
;

199 ià(
	gy
->
	gRight
 !ğ
S’tš–Node
)

200 
y
->
Right
->
P¬’t
 = 
x
;

202 ià(
	gy
 !ğ
S’tš–Node
)

203 
y
->
P¬’t
 = 
x
->Parent;

205 ià(
	gx
->
	gP¬’t
 !ğ
NULL
)

207 ià(
x
 =ğx->
P¬’t
->
Right
)

208 
x
->
P¬’t
->
Right
 = 
y
;

210 
	gx
->
	gP¬’t
->
	gLeá
 = 
y
;

213 
	grbT»e
 = 
y
;

216 
	gy
->
	gRight
 = 
x
;

217 ià(
	gx
 !ğ
S’tš–Node
)

218 
x
->
P¬’t
 = 
y
;

224 
Sim_Ev’t
* 
	gEv’tT»e
::
G‘D©a
(
sim_time_ty³
 
key
)

226 
Ev’tT»eNode
* 
Œ“Node
 = 
rbT»e
;

228 
	gŒ“Node
 !ğ
S’tš–Node
)

230 ià(
key
 =ğ
Œ“Node
->
Key
) {

231 
Ï¡NodeFound
 = 
Œ“Node
;

232  
	gŒ“Node
->
	gFœ¡SimEv’t
;

234 ià(
	gkey
 < (
	gŒ“Node
->
	gKey
)) {

235 
	gŒ“Node
 = 
Œ“Node
->
Leá
;

237 
	gŒ“Node
 = 
Œ“Node
->
Right
;

240  
	gNULL
;

243 
	gEv’tT»e
::
In£¹_sim_ev’t
(
Sim_Ev’t
* 
ev’t
)

245 ià(
ev’t
->
Fœe_time
 < 
Engše
::
In¡ªû
()->
Time
()) {

246 
PRINT_ERROR
("Illegal„equesto„egister‡ simulationƒvent before Now!")

249 
sim_time_ty³
 
key
 = 
ev’t
->
Fœe_time
;

250 
Ev’tT»eNode
* 
	gŒ“Node
 = 
rbT»e
;

253 
	gŒ“Node
 !ğ
S’tš–Node
)

255 ià(
key
 =ğ
Œ“Node
->
Key
) {

256 
Œ“Node
->
La¡SimEv’t
->
Next_ev’t
 = 
ev’t
;

257 
	gŒ“Node
->
	gLa¡SimEv’t
 = 
ev’t
;

260 ià(
	gkey
 < (
	gŒ“Node
->
	gKey
)) {

261 
	gŒ“Node
 = 
Œ“Node
->
Leá
;

263 
	gŒ“Node
 = 
Œ“Node
->
Right
;

266 
Add
(
ev’t
->
Fœe_time
,ƒvent);

273 
sim_time_ty³
 
	gEv’tT»e
::
G‘_mš_key
()

275  
G‘_mš_node
()->
Key
;

282 
Sim_Ev’t
* 
	gEv’tT»e
::
G‘_mš_v®ue
()

284  
G‘_mš_node
()->
Fœ¡SimEv’t
;

291 
Ev’tT»eNode
* 
	gEv’tT»e
::
G‘_mš_node
()

293 
Ev’tT»eNode
* 
Œ“Node
 = 
rbT»e
;

296 
	gŒ“Node
->
	gLeá
 !ğ
S’tš–Node
) {

297 
Œ“Node
 =»eNode->
Leá
;

300 
	gÏ¡NodeFound
 = 
Œ“Node
;

302  
	gŒ“Node
;

309 
	gEv’tT»e
::
Remove
(
sim_time_ty³
 
key
)

312 
Ev’tT»eNode
* 
node
;

315 ià(
	gkey
 =ğ
Ï¡NodeFound
->
Key
)

316 
node
 = 
Ï¡NodeFound
;

319 
	gnode
 = 
rbT»e
;

320 
	gnode
 !ğ
S’tš–Node
)

322 ià(
key
 =ğ
Ï¡NodeFound
->
Key
)

324 ià(
	gkey
 < 
	gÏ¡NodeFound
->
	gKey
)

325 
	gnode
 = 
node
->
Leá
;

327 
	gnode
 = 
node
->
Right
;

330 ià(
	gnode
 =ğ
S’tš–Node
)

334 
D–‘e
(
node
);

336 
	gCouÁ
--;

339 
	gEv’tT»e
::
Remove
(
Ev’tT»eNode
* 
node
)

341 
D–‘e
(
node
);

342 
	gCouÁ
--;

349 
	gEv’tT»e
::
D–‘e
(
Ev’tT»eNode
* 
z
)

358 
Ev’tT»eNode
* 
x
;

359 
Ev’tT»eNode
* 
	gy
;

363 ià(
	gz
->
	gLeá
 =ğ
S’tš–Node
 || 
z
->
Right
 == SentinelNode)

364 
y
 = 
z
;

369 
	gy
 = 
z
->
Right
;

370 
	gy
->
	gLeá
 !ğ
S’tš–Node
)

371 
y
 = y->
Leá
;

378 ià(
	gy
->
	gLeá
 !ğ
S’tš–Node
)

379 
x
 = 
y
->
Leá
;

381 
	gx
 = 
y
->
Right
;

386 
	gx
->
	gP¬’t
 = 
y
->
P¬’t
;

387 ià(
	gy
->
	gP¬’t
 !ğ
NULL
)

388 ià(
y
 =ğy->
P¬’t
->
Leá
)

389 
y
->
P¬’t
->
Leá
 = 
x
;

391 
	gy
->
	gP¬’t
->
	gRight
 = 
x
;

393 
	grbT»e
 = 
x
;

397 ià(
	gy
 !ğ
z
)

399 
z
->
Key
 = 
y
->Key;

400 
	gz
->
	gFœ¡SimEv’t
 = 
y
->
Fœ¡SimEv’t
;

401 
	gz
->
	gLa¡SimEv’t
 = 
y
->
La¡SimEv’t
;

404 ià(
	gy
->
	gCŞÜ
 == 1)

405 
Re¡Üe_aá”_d–‘e
(
x
);

407 
	gÏ¡NodeFound
 = 
S’tš–Node
;

408 
d–‘e
 
	gz
;

417 
	gEv’tT»e
::
Re¡Üe_aá”_d–‘e
(
Ev’tT»eNode
* 
x
)

421 
Ev’tT»eNode
* 
y
;

423 
	gx
 !ğ
rbT»e
 && 
x
->
CŞÜ
 == 1)

425 ià(
x
 =ğx->
P¬’t
->
Leá
)

427 
y
 = 
x
->
P¬’t
->
Right
;

428 ià(
	gy
->
	gCŞÜ
 == 0)

430 
y
->
CŞÜ
 = 1;

431 
	gx
->
	gP¬’t
->
	gCŞÜ
 = 0;

432 
RÙ©eLeá
(
x
->
P¬’t
);

433 
	gy
 = 
x
->
P¬’t
->
Right
;

435 ià(
	gy
->
	gLeá
->
	gCŞÜ
 == 1 &&

436 
y
->
Right
->
CŞÜ
 == 1) {

438 
y
->
CŞÜ
 = 0;

439 
	gx
 = 
x
->
P¬’t
;

441 ià(
	gy
->
	gRight
->
	gCŞÜ
 == 1)

443 
y
->
Leá
->
CŞÜ
 = 1;

444 
	gy
->
	gCŞÜ
 = 0;

445 
RÙ©eRight
(
y
);

446 
	gy
 = 
x
->
P¬’t
->
Right
;

448 
	gy
->
	gCŞÜ
 = 
x
->
P¬’t
->
CŞÜ
;

449 
	gx
->
	gP¬’t
->
	gCŞÜ
 = 1;

450 
	gy
->
	gRight
->
	gCŞÜ
 = 1;

451 
RÙ©eLeá
(
x
->
P¬’t
);

452 
	gx
 = 
rbT»e
;

456 
	gy
 = 
x
->
P¬’t
->
Leá
;

457 ià(
	gy
->
	gCŞÜ
 == 0) {

458 
y
->
CŞÜ
 = 1;

459 
	gx
->
	gP¬’t
->
	gCŞÜ
 = 0;

460 
RÙ©eRight
(
x
->
P¬’t
);

461 
	gy
 = 
x
->
P¬’t
->
Leá
;

464 ià(
	gy
->
	gRight
->
	gCŞÜ
 == 1 &&

465 
y
->
Leá
->
CŞÜ
 == 1) {

466 
y
->
CŞÜ
 = 0;

467 
	gx
 = 
x
->
P¬’t
;

469 ià(
	gy
->
	gLeá
->
	gCŞÜ
 == 1) {

470 
y
->
Right
->
CŞÜ
 = 1;

471 
	gy
->
	gCŞÜ
 = 0;

472 
RÙ©eLeá
(
y
);

473 
	gy
 = 
x
->
P¬’t
->
Leá
;

475 
	gy
->
	gCŞÜ
 = 
x
->
P¬’t
->
CŞÜ
;

476 
	gx
->
	gP¬’t
->
	gCŞÜ
 = 1;

477 
	gy
->
	gLeá
->
	gCŞÜ
 = 1;

478 
RÙ©eRight
(
x
->
P¬’t
);

479 
	gx
 = 
rbT»e
;

483 
	gx
->
	gCŞÜ
 = 1;

490 
	gEv’tT»e
::
Remove_mš
()

492 
Remove
(
G‘_mš_key
());

499 
	gEv’tT»e
::
CË¬
()

501 
rbT»e
 = 
S’tš–Node
;

502 
	gCouÁ
 = 0;

	@src/sim/EventTree.h

1 #iâdeà
EVENT_TREE_H


2 
	#EVENT_TREE_H


	)

4 
	~"Sim_Defs.h
"

5 
	~"Sim_Ev’t.h
"

7 
Çme¥aû
 
	gMQSimEngše


9 şas 
	cEv’tT»eNode


11 
	gpublic
:

13 
sim_time_ty³
 
Key
;

15 
Sim_Ev’t
* 
	gFœ¡SimEv’t
;

16 
Sim_Ev’t
* 
	gLa¡SimEv’t
;

19 
	gCŞÜ
;

21 
Ev’tT»eNode
* 
	gLeá
;

23 
Ev’tT»eNode
* 
	gRight
;

25 
Ev’tT»eNode
* 
	gP¬’t
;

27 
Ev’tT»eNode
()

29 
	gCŞÜ
 = 0;

30 
	gLeá
 = 
NULL
;

31 
	gRight
 = 
NULL
;

32 
	gP¬’t
 = 
NULL
;

36 şas 
	cEv’tT»e


38 
	gpublic
:

39 
Ev’tT»e
();

40 ~
Ev’tT»e
();

43 
	gCouÁ
;

45 
Ev’tT»eNode
* 
	gS’tš–Node
;

46 
Add
(
sim_time_ty³
 
key
, 
Sim_Ev’t
* 
d©a
);

47 
RÙ©eLeá
(
Ev’tT»eNode
* 
x
);

48 
RÙ©eRight
(
Ev’tT»eNode
* 
x
);

49 
Sim_Ev’t
* 
G‘D©a
(
sim_time_ty³
 
key
);

50 
In£¹_sim_ev’t
(
Sim_Ev’t
* 
d©a
);

51 
sim_time_ty³
 
G‘_mš_key
();

52 
Sim_Ev’t
* 
G‘_mš_v®ue
();

53 
Ev’tT»eNode
* 
G‘_mš_node
();

54 
Remove
(
sim_time_ty³
 
key
);

55 
Remove
(
Ev’tT»eNode
* 
node
);

56 
Remove_mš
();

57 
CË¬
();

58 
	g´iv©e
:

60 
Ev’tT»eNode
* 
rbT»e
;

62 
Ev’tT»eNode
* 
	gÏ¡NodeFound
;

63 
Re¡ÜeAá”In£¹
(
Ev’tT»eNode
* 
x
);

64 
D–‘e
(
Ev’tT»eNode
* 
z
);

65 
Re¡Üe_aá”_d–‘e
(
Ev’tT»eNode
* 
x
);

	@src/sim/Sim_Defs.h

1 #iâdeà
DEFINITIONS_H


2 
	#DEFINITIONS_H


	)

4 
	~<c¡dšt
>

5 
	~<¡ršg
>

6 
	~<io¡»am
>

8 
ušt64_t
 
	tsim_time_ty³
;

9 
ušt16_t
 
	t¡»am_id_ty³
;

10 
sim_time_ty³
 
	td©a_time¡amp_ty³
;

12 
	#INVALID_TIME
 18446744073709551615ULL

	)

13 
	#PTRT1
 0

	)

14 
	#INVALID_TIME_STAMP
 18446744073709551615ULL

	)

15 
	#MAXIMUM_TIME
 18446744073709551615ULL

	)

16 
	#ONE_SECOND
 1000000000

	)

17 
	#TRANSFER_TIME
 10000

	)

18 
	#READ_TIME
 200000000

	)

19 
	#WRITE_TIME
 400000000

	)

21 
	g¡d
::
	t¡ršg
 
	tsim_objeù_id_ty³
;

23 
	#Cu¼’tTimeSmp
 
SimuÏtÜ
->
	`Time
()

	)

24 
	#PRINT_ERROR
(
MSG
) {\

25 
¡d
::
û¼
 << "ERROR:" ;\

26 
¡d
::
û¼
 << 
MSG
 << std::
’dl
; \

27 
¡d
::
cš
.
	`g‘
();\

28 
	`ex™
(1);\

29 }

	)

30 
	#PRINT_MESSAGE
(
M
è
¡d
::
cout
 << M << std::
’dl
;

	)

31 
	#DEBUG
(
M
)

32 
	#DEBUG2
(
M
)

33 
	#SIM_TIME_TO_MICROSECONDS_COEFF
 1000

	)

34 
	#SIM_TIME_TO_SECONDS_COEFF
 1000000000

	)

	@src/sim/Sim_Event.h

1 #iâdeà
SIMULATOR_EVENT_H


2 
	#SIMULATOR_EVENT_H


	)

4 
	~"Sim_Defs.h
"

5 
	~"Sim_Objeù.h
"

7 
Çme¥aû
 
	gMQSimEngše


9 
şass
 
	gSim_Objeù
;

10 şas 
	cSim_Ev’t


12 
	gpublic
:

13 
Sim_Ev’t
(
sim_time_ty³
 
fœeTime
, 
Sim_Objeù
* 
rg‘Objeù
, * 
·¿m‘”s
 = 
NULL
, 
ty³
 = 0)

14 : 
Fœe_time
(
fœeTime
), 
T¬g‘_sim_objeù
(
rg‘Objeù
), 
P¬am‘”s
(
·¿m‘”s
), 
Ty³
(
ty³
), 
Next_ev’t
(
NULL
), 
IgnÜe
(
çl£
) {}

15 
sim_time_ty³
 
	gFœe_time
;

16 
Sim_Objeù
* 
	gT¬g‘_sim_objeù
;

17 * 
	gP¬am‘”s
 = 
NULL
;

18 
	gTy³
;

19 
Sim_Ev’t
* 
	gNext_ev’t
;

20 
boŞ
 
	gIgnÜe
;

	@src/sim/Sim_Object.h

1 #iâdeà
SIMULATOR_OBJECT_H


2 
	#SIMULATOR_OBJECT_H


	)

4 
	~<¡ršg
>

5 
	~"Sim_Ev’t.h
"

7 
Çme¥aû
 
	gMQSimEngše


9 
şass
 
	gSim_Ev’t
;

10 şas 
	cSim_Objeù


12 
	gpublic
:

13 
Sim_Objeù
(cÚ¡ 
sim_objeù_id_ty³
 &
id
)

15 
_id
 = 
id
;

16 
	g_Œigg”sS‘Up
 = 
çl£
;

19 
sim_objeù_id_ty³
 
ID
()

21  
	gthis
->
	g_id
;

24 
boŞ
 
IsTrigg”sS‘Up
()

26  
	g_Œigg”sS‘Up
;

30 
vœtu®
 
S¹_simuÏtiÚ
() = 0;

33 
vœtu®
 
V®id©e_simuÏtiÚ_cÚfig
() = 0;

36 
vœtu®
 
S‘up_Œigg”s
()

38 
	g_Œigg”sS‘Up
 = 
Œue
;

41 
vœtu®
 
Execu‹_simuÏtÜ_ev’t
(
Sim_Ev’t
*) = 0;

43 
	g´iv©e
:

44 
sim_objeù_id_ty³
 
_id
;

45 
boŞ
 
	g_Œigg”sS‘Up
;

	@src/sim/Sim_Reporter.h

1 #iâdeà
SIM_REPORTER_H


2 
	#SIM_REPORTER_H


	)

4 
	~"../uts/XMLWr™”.h
"

5 
	~<¡ršg
>

7 
Çme¥aû
 
	gMQSimEngše


9 şas 
	cSim_R•Ü‹r


11 
	gpublic
:

12 
vœtu®
 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
) = 0;

	@src/ssd/Address_Mapping_Unit_Base.cpp

1 
	~"FTL.h
"

2 
	~"Add»ss_M­pšg_Un™_Ba£.h
"

3 
	~"NVM_PHY_ONFI_NVDDR2.h
"

4 
	~"FÏsh_Block_Mªag”_Ba£.h
"

6 
Çme¥aû
 
	gSSD_CompÚ’ts


8 
	gAdd»ss_M­pšg_Un™_Ba£
::
Add»ss_M­pšg_Un™_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
,

9 
boŞ
 
id—l_m­pšg_bË
, 
no_of_šput_¡»ams
,

10 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
,

11 
Block_no_³r_¶ªe
, 
Page_no_³r_block
, 
SeùÜsP”Page
, 
PageSizeInBy‹s
,

12 
Ov”´ovisiÚšg_¿tio
, 
CMT_Sh¬šg_Mode
 
sh¬šg_mode
, 
boŞ
 
fŞd_Ïrge_add»s£s
)

13 : 
Sim_Objeù
(
id
), 
ál
(ál), 
æash_cÚŒŞËr
(æash_cÚŒŞËr), 
block_mªag”
(block_manager),

14 
id—l_m­pšg_bË
(id—l_m­pšg_bË), 
no_of_šput_¡»ams
(no_of_input_streams),

15 
chªÃl_couÁ
(
ChªÃlCouÁ
), 
ch_no_³r_chªÃl
(ch_no_³r_chªÃl), 
d›_no_³r_ch
(
D›NoP”Ch
), 
¶ªe_no_³r_d›
(
PÏÃNoP”D›
),

16 
block_no_³r_¶ªe
(
Block_no_³r_¶ªe
), 
·ges_no_³r_block
(
Page_no_³r_block
), 
£ùÜ_no_³r_·ge
(
SeùÜsP”Page
), 
·ge_size_š_by‹
(
PageSizeInBy‹s
),

17 
ov”´ovisiÚšg_¿tio
(
Ov”´ovisiÚšg_¿tio
), 
sh¬šg_mode
(sh¬šg_mode), 
fŞd_Ïrge_add»s£s
(fold_large_addresses),

18 
m­pšg_bË_¡Üed_Ú_æash
(
çl£
)

20 
	g·ge_no_³r_¶ªe
 = 
·ges_no_³r_block
 * 
block_no_³r_¶ªe
;

21 
	g·ge_no_³r_d›
 = 
·ge_no_³r_¶ªe
 * 
¶ªe_no_³r_d›
;

22 
	g·ge_no_³r_ch
 = 
·ge_no_³r_d›
 * 
d›_no_³r_ch
;

23 
	g·ge_no_³r_chªÃl
 = 
·ge_no_³r_ch
 * 
ch_no_³r_chªÃl
;

24 
	gtÙ®_physiÿl_·ges_no
 = 
·ge_no_³r_chªÃl
 * 
ChªÃlCouÁ
;

25 
	gtÙ®_logiÿl_·ges_no
 = ()(()
tÙ®_physiÿl_·ges_no
 * (1 - 
ov”´ovisiÚšg_¿tio
));

26 
	gmax_logiÿl_£ùÜ_add»ss
 = (
LHA_ty³
)(
SeùÜsP”Page
 * 
tÙ®_logiÿl_·ges_no
 - 1);

29 
	gAdd»ss_M­pšg_Un™_Ba£
::~
Add»ss_M­pšg_Un™_Ba£
()

33 
Add»ss_M­pšg_Un™_Ba£
::
G‘_deviû_physiÿl_·ges_couÁ
()

35  
tÙ®_physiÿl_·ges_no
;

38 
boŞ
 
	gAdd»ss_M­pšg_Un™_Ba£
::
Is_id—l_m­pšg_bË
()

40  
id—l_m­pšg_bË
;

43 
CMT_Sh¬šg_Mode
 
	gAdd»ss_M­pšg_Un™_Ba£
::
G‘_CMT_sh¬šg_mode
()

45  
sh¬šg_mode
;

	@src/ssd/Address_Mapping_Unit_Base.h

1 #iâdeà
ADDRESS_MAPPING_UNIT_BASE_H


2 
	#ADDRESS_MAPPING_UNIT_BASE_H


	)

4 
	~"../sim/Sim_Objeù.h
"

5 
	~"../nvm_ch/æash_memÜy/Physiÿl_Page_Add»ss.h
"

6 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

7 
	~"SSD_Defs.h
"

8 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

9 
	~"NVM_PHY_ONFI_NVDDR2.h
"

10 
	~"FTL.h
"

11 
	~"FÏsh_Block_Mªag”_Ba£.h
"

13 
Çme¥aû
 
	gSSD_CompÚ’ts


15 
şass
 
	gFTL
;

16 
şass
 
	gFÏsh_Block_Mªag”_Ba£
;

18 
ušt32_t
 
	tMVPN_ty³
;

19 
ušt32_t
 
	tMPPN_ty³
;

21 şas 
	cFÏsh_Add»ss_M­pšg_Ty³
 {
	gPAGE_LEVEL
, 
	gHYBRID
};

22 şas 
	cFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³


24 
	gCWDP
, 
	gCWPD
, 
	gCDWP
, 
	gCDPW
, 
	gCPWD
, 
	gCPDW
,

25 
	gWCDP
, 
	gWCPD
, 
	gWDCP
, 
	gWDPC
, 
	gWPCD
, 
	gWPDC
,

26 
	gDCWP
, 
	gDCPW
, 
	gDWCP
, 
	gDWPC
, 
	gDPCW
, 
	gDPWC
,

27 
	gPCWD
, 
	gPCDW
, 
	gPWCD
, 
	gPWDC
, 
	gPDCW
, 
	gPDWC


29 şas 
	cCMT_Sh¬šg_Mode
 { 
	gSHARED
, 
	gEQUAL_SIZE_PARTITIONING
 };

31 şas 
	cMovšg_LPA_Stus
 { 
	gGC_IS_READING_PHYSICAL_BLOCK
, 
	gGC_IS_READING_DATA
, 
	gGC_IS_WRITING_DATA
,

32 
	gGC_IS_READING_PHYSICAL_BLOCK_AND_THERE_IS_USER_READ
, 
	gGC_IS_READING_DATA_AND_THERE_IS_USER_READ
,

33 
	gGC_IS_READING_PHYSICAL_BLOCK_AND_PAGE_IS_INVALIDATED
, 
	gGC_IS_READING_DATA_AND_PAGE_IS_INVALIDATED
, 
	gGC_IS_WRITING_DATA_AND_PAGE_IS_INVALIDATED
};

35 şas 
	cAdd»ss_M­pšg_Un™_Ba£
 : 
public
 
MQSimEngše
::
Sim_Objeù


37 
public
:

38 
Add»ss_M­pšg_Un™_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI
* 
FÏshCÚŒŞËr
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
,

39 
boŞ
 
id—l_m­pšg_bË
, 
no_of_šput_¡»ams
,

40 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
,

41 
Block_no_³r_¶ªe
, 
Page_no_³r_block
, 
SeùÜsP”Page
, 
PageSizeInBy‹s
,

42 
Ov”´ovisiÚšg_¿tio
, 
CMT_Sh¬šg_Mode
 
sh¬šg_mode
 = CMT_Sh¬šg_Mode::
SHARED
, 
boŞ
 
fŞd_Ïrge_add»s£s
 = 
Œue
);

43 
	gvœtu®
 ~
Add»ss_M­pšg_Un™_Ba£
();

44 
NVM_PHY_ONFI
* 
	gæash_cÚŒŞËr
;

46 
FTL
* 
	gál
;

48 
vœtu®
 
AÎoÿ‹_add»ss_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
¡d
::
m­
<
LPA_ty³
, 
·ge_¡©us_ty³
>& 
Ía_li¡
, std::
veùÜ
<>& 
¡—dy_¡©e_di¡ributiÚ
) = 0;

49 
vœtu®
 
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
) = 0;

50 
vœtu®
 
StÜe_m­pšg_bË_Ú_æash_©_¡¬t
() = 0;

53 
vœtu®
 
G‘_cmt_ÿ·c™y
() = 0;

54 
vœtu®
 
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡»am_id_ty³
 
¡»am_id
) = 0;

55 
vœtu®
 
LPA_ty³
 
G‘_logiÿl_·ges_couÁ
(
¡»am_id_ty³
 
¡»am_id
) = 0;

56 
G‘_no_of_šput_¡»ams
(è{  
	gno_of_šput_¡»ams
; }

57 
boŞ
 
Is_id—l_m­pšg_bË
();

60 
vœtu®
 
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(cÚ¡ 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>& 
Œª§ùiÚLi¡
) = 0;

61 
vœtu®
 
G‘_d©a_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
, 
PPA_ty³
& 
µa
, 
·ge_¡©us_ty³
& 
·ge_¡©e
) = 0;

62 
vœtu®
 
G‘_Œª¦©iÚ_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
MVPN_ty³
 
mv²
, 
MPPN_ty³
& 
mµa
, 
sim_time_ty³
& 
time¡amp
) = 0;

63 
vœtu®
 
AÎoÿ‹_Ãw_·ge_fÜ_gc
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
, 
boŞ
 
is_Œª¦©iÚ_·ge
) = 0;

64 
G‘_deviû_physiÿl_·ges_couÁ
();

65 
CMT_Sh¬šg_Mode
 
G‘_CMT_sh¬šg_mode
();

66 
vœtu®
 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µa
) = 0;

67 
vœtu®
 
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µa
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) = 0;

68 
vœtu®
 
PPA_ty³
 
CÚv”t_add»ss_to_µa
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·geAdd»ss
) = 0;

78 
vœtu®
 
S‘_b¬r›r_fÜ_acûssšg_physiÿl_block
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
) = 0;

79 
vœtu®
 
S‘_b¬r›r_fÜ_acûssšg_Ía
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
) = 0;

80 
vœtu®
 
S‘_b¬r›r_fÜ_acûssšg_mv²
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
MVPN_ty³
 
mv²
) = 0;

81 
vœtu®
 
Remove_b¬r›r_fÜ_acûssšg_Ía
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
) = 0;

82 
vœtu®
 
Remove_b¬r›r_fÜ_acûssšg_mv²
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
MVPN_ty³
 
mv²
) = 0;

83 
vœtu®
 
S¹_£rvicšg_wr™es_fÜ_ov”fuÎ_¶ªe
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
) = 0;

84 
	g´Ùeùed
:

86 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
;

87 
CMT_Sh¬šg_Mode
 
	gsh¬šg_mode
;

88 
boŞ
 
	gid—l_m­pšg_bË
;

89 
	gno_of_šput_¡»ams
;

90 
LHA_ty³
 
	gmax_logiÿl_£ùÜ_add»ss
;

91 
	gtÙ®_logiÿl_·ges_no
 = 0;

93 
	gchªÃl_couÁ
;

94 
	gch_no_³r_chªÃl
;

95 
	gd›_no_³r_ch
;

96 
	g¶ªe_no_³r_d›
;

97 
	gblock_no_³r_¶ªe
;

98 
	g·ges_no_³r_block
;

99 
	g£ùÜ_no_³r_·ge
;

100 
	g·ge_size_š_by‹
;

101 
	gtÙ®_physiÿl_·ges_no
 = 0;

102 
	g·ge_no_³r_chªÃl
 = 0;

103 
	g·ge_no_³r_ch
 = 0;

104 
	g·ge_no_³r_d›
 = 0;

105 
	g·ge_no_³r_¶ªe
 = 0;

106 
	gov”´ovisiÚšg_¿tio
;

107 
boŞ
 
	gfŞd_Ïrge_add»s£s
;

108 
boŞ
 
	gm­pšg_bË_¡Üed_Ú_æash
;

110 
vœtu®
 
boŞ
 
qu”y_cmt
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
) = 0;

111 
vœtu®
 
PPA_ty³
 
Úlše_ü—‹_’Œy_fÜ_»ads
(
LPA_ty³
 
Ía
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
»ad_add»ss
, 
ušt64_t
 
»ad_£ùÜs_b™m­
,
boŞ
 
RPG_WR
) = 0;

112 
vœtu®
 
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
) = 0;

113 
vœtu®
 
mªage_m­pšg_Œª§ùiÚ_çcšg_b¬r›r
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
, 
boŞ
 
»ad
) = 0;

114 
vœtu®
 
boŞ
 
is_Ía_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
) = 0;

115 
vœtu®
 
boŞ
 
is_mv²_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
) = 0;

	@src/ssd/Address_Mapping_Unit_Hybrid.cpp

1 
	~"Add»ss_M­pšg_Un™_Hybrid.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
	gAdd»ss_M­pšg_Un™_Hybrid
::
Add»ss_M­pšg_Un™_Hybrid
(
sim_objeù_id_ty³
 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
,

6 
boŞ
 
id—l_m­pšg_bË
, 
cÚcu¼’t_¡»ams_no
,

7 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_š_d›
,

8 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
£ùÜs_³r_·ge
, 
·ge_size_š_by‹
,

9 
ov”´ovisiÚšg_¿tio
, 
CMT_Sh¬šg_Mode
 
sh¬šg_mode
, 
boŞ
 
fŞd_out_of_¿nge_add»s£s
) :

10 
Add»ss_M­pšg_Un™_Ba£
(
id
, 
ál
, 
æash_cÚŒŞËr
, 
block_mªag”
, 
id—l_m­pšg_bË
,

11 
cÚcu¼’t_¡»ams_no
, 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_š_d›
,

12 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
£ùÜs_³r_·ge
, 
·ge_size_š_by‹
, 
ov”´ovisiÚšg_¿tio
, 
sh¬šg_mode
, 
fŞd_out_of_¿nge_add»s£s
) {}

13 
	gAdd»ss_M­pšg_Un™_Hybrid
::
S‘up_Œigg”s
() {}

14 
Add»ss_M­pšg_Un™_Hybrid
::
S¹_simuÏtiÚ
() {}

15 
Add»ss_M­pšg_Un™_Hybrid
::
V®id©e_simuÏtiÚ_cÚfig
() {}

16 
Add»ss_M­pšg_Un™_Hybrid
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
) {}

18 
Add»ss_M­pšg_Un™_Hybrid
::
AÎoÿ‹_add»ss_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
¡d
::
m­
<
LPA_ty³
, 
·ge_¡©us_ty³
>& 
Ía_li¡
, std::
veùÜ
<>& 
¡—dy_¡©e_di¡ributiÚ
) {}

19 
Add»ss_M­pšg_Un™_Hybrid
::
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
) {  0; }

20 
	gAdd»ss_M­pšg_Un™_Hybrid
::
G‘_cmt_ÿ·c™y
() {  0; }

21 
	gAdd»ss_M­pšg_Un™_Hybrid
::
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡»am_id_ty³
 
¡»am_id
) {  0; }

22 
	gAdd»ss_M­pšg_Un™_Hybrid
::
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(cÚ¡ 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>& 
Œª§ùiÚ_li¡
) {}

23 
Add»ss_M­pšg_Un™_Hybrid
::
G‘_d©a_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
, 
PPA_ty³
& 
µa
, 
·ge_¡©us_ty³
& 
·ge_¡©e
) {}

24 
	gAdd»ss_M­pšg_Un™_Hybrid
::
G‘_Œª¦©iÚ_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
MVPN_ty³
 
mv²
, 
MPPN_ty³
& 
mµa
, 
sim_time_ty³
& 
time¡amp
) {}

26 
PPA_ty³
 
	gAdd»ss_M­pšg_Un™_Hybrid
::
Úlše_ü—‹_’Œy_fÜ_»ads
(
LPA_ty³
 
Ía
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
»ad_add»ss
, 
ušt64_t
 
»ad_£ùÜs_b™m­
,
boŞ
 
RPG_WR
=
çl£
) {  0; }

28 
boŞ
 
	gAdd»ss_M­pšg_Un™_Hybrid
::
qu”y_cmt
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
è{  
Œue
; }

29 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
Add»ss_M­pšg_Un™_Hybrid
::
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µa
)

31 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
·
;

32  
	g·
;

35 
LPA_ty³
 
	gAdd»ss_M­pšg_Un™_Hybrid
::
G‘_logiÿl_·ges_couÁ
(
¡»am_id_ty³
 
¡»am_id
)

40 
	gAdd»ss_M­pšg_Un™_Hybrid
::
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µa
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) {}

41 
PPA_ty³
 
Add»ss_M­pšg_Un™_Hybrid
::
CÚv”t_add»ss_to_µa
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·geAdd»ss
) {  0; }

42 
	gAdd»ss_M­pšg_Un™_Hybrid
::
StÜe_m­pšg_bË_Ú_æash_©_¡¬t
() {}

43 
Add»ss_M­pšg_Un™_Hybrid
::
AÎoÿ‹_Ãw_·ge_fÜ_gc
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
, 
boŞ
 
is_Œª¦©iÚ_·ge
) {}

44 
	gAdd»ss_M­pšg_Un™_Hybrid
::
S‘_b¬r›r_fÜ_acûssšg_physiÿl_block
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
) {}

45 
Add»ss_M­pšg_Un™_Hybrid
::
S‘_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
) {}

46 
	gAdd»ss_M­pšg_Un™_Hybrid
::
Remove_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
) {}

47 
	gAdd»ss_M­pšg_Un™_Hybrid
::
S‘_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mpvn
) {}

48 
	gAdd»ss_M­pšg_Un™_Hybrid
::
Remove_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mpvn
) {}

49 
boŞ
 
	gAdd»ss_M­pšg_Un™_Hybrid
::
is_Ía_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
è{  
	gçl£
; }

50 
boŞ
 
	gAdd»ss_M­pšg_Un™_Hybrid
::
is_mv²_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
è{  
	gçl£
; }

51 
	gAdd»ss_M­pšg_Un™_Hybrid
::
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
) {}

52 
Add»ss_M­pšg_Un™_Hybrid
::
mªage_m­pšg_Œª§ùiÚ_çcšg_b¬r›r
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
, 
boŞ
 
»ad
) {}

53 
	gAdd»ss_M­pšg_Un™_Hybrid
::
S¹_£rvicšg_wr™es_fÜ_ov”fuÎ_¶ªe
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
) {}

	@src/ssd/Address_Mapping_Unit_Hybrid.h

1 #iâdeà
ADDRESS_MAPPING_UNIT_HYBRID_H


2 
	#ADDRESS_MAPPING_UNIT_HYBRID_H


	)

4 
	~"Add»ss_M­pšg_Un™_Ba£.h
"

6 
Çme¥aû
 
	gSSD_CompÚ’ts


8 şas 
	cAdd»ss_M­pšg_Un™_Hybrid
 : 
public
 
Add»ss_M­pšg_Un™_Ba£


10 
public
:

11 
Add»ss_M­pšg_Un™_Hybrid
(
sim_objeù_id_ty³
 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
,

12 
boŞ
 
id—l_m­pšg_bË
, 
CÚcu¼’tSŒ—mNo
,

13 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
,

14 
Block_no_³r_¶ªe
, 
Page_no_³r_block
, 
SeùÜsP”Page
, 
PageSizeInBy‹s
,

15 
Ov”´ovisiÚšg_¿tio
, 
CMT_Sh¬šg_Mode
 
sh¬šg_mode
 = CMT_Sh¬šg_Mode::
SHARED
, 
boŞ
 
fŞd_Ïrge_add»s£s
 = 
Œue
);

16 
S‘up_Œigg”s
();

17 
S¹_simuÏtiÚ
();

18 
V®id©e_simuÏtiÚ_cÚfig
();

19 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

21 
AÎoÿ‹_add»ss_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
¡d
::
m­
<
LPA_ty³
, 
·ge_¡©us_ty³
>& 
Ía_li¡
, std::
veùÜ
<>& 
¡—dy_¡©e_di¡ributiÚ
);

22 
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

23 
G‘_cmt_ÿ·c™y
();

24 
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡»am_id_ty³
 
¡»am_id
);

25 
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(cÚ¡ 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>& 
Œª§ùiÚLi¡
);

26 
G‘_d©a_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
, 
PPA_ty³
& 
µa
, 
·ge_¡©us_ty³
& 
·ge_¡©e
);

27 
G‘_Œª¦©iÚ_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
MVPN_ty³
 
mv²
, 
MPPN_ty³
& 
mµa
, 
sim_time_ty³
& 
time¡amp
);

28 
AÎoÿ‹_Ãw_·ge_fÜ_gc
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
, 
boŞ
 
is_Œª¦©iÚ_·ge
);

30 
StÜe_m­pšg_bË_Ú_æash_©_¡¬t
();

31 
LPA_ty³
 
G‘_logiÿl_·ges_couÁ
(
¡»am_id_ty³
 
¡»am_id
);

32 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µa
);

33 
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µn
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

34 
PPA_ty³
 
CÚv”t_add»ss_to_µa
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·geAdd»ss
);

36 
S‘_b¬r›r_fÜ_acûssšg_physiÿl_block
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
);

37 
S‘_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

38 
S‘_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mpvn
);

39 
Remove_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

40 
Remove_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mpvn
);

41 
S¹_£rvicšg_wr™es_fÜ_ov”fuÎ_¶ªe
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
);

42 
	g´iv©e
:

43 
boŞ
 
qu”y_cmt
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

44 
PPA_ty³
 
Úlše_ü—‹_’Œy_fÜ_»ads
(
LPA_ty³
 
Ía
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
»ad_add»ss
, 
ušt64_t
 
»ad_£ùÜs_b™m­
,
boŞ
 
RPG_WR
);

45 
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

46 
mªage_m­pšg_Œª§ùiÚ_çcšg_b¬r›r
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
, 
boŞ
 
»ad
);

47 
boŞ
 
is_Ía_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

48 
boŞ
 
is_mv²_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
);

	@src/ssd/Address_Mapping_Unit_Page_Level.cpp

1 
	~<cm©h
>

2 
	~<as£¹.h
>

3 
	~<¡dexû±
>

4 
	~<f¡»am
>

5 
	~"Add»ss_M­pšg_Un™_Page_Lev–.h
"

6 
	~"Sts.h
"

7 
	~"../uts/Logiÿl_Add»ss_P¬t™iÚšg_Un™.h
"

9 
Çme¥aû
 
	gSSD_CompÚ’ts


11 
	gPageRPGCache
::
PageRPGCache
(
¡d
::
veùÜ
<> 
v
,
út
):
vec
(v),
couÁ
(cnt){

14 
	gCached_M­pšg_TabË
::
Cached_M­pšg_TabË
(
ÿ·c™y
) : capacity(capacity)

17 
LPA_ty³
 
Add»ss_M­pšg_Un™_Page_Lev–
::
g‘_couÁ
(LPA_ty³ 
key
,
grou³
){

18 autØ
	g™
=
m­
[
grou³
].
fšd
(
key
);

19 if(
	g™
==
m­
[
grou³
].
’d
()){

22  
	g™
->
	g£cÚd
->
	gfœ¡
->
	gcouÁ
;

24 
PageRPGCache
* 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
£t1
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
,
LPA_ty³
 
Ín
){

26 if(!
	g®loc
){

28 
	g¡d
::
veùÜ
<
¡d
::veùÜ<>>** 
v
;

29 
	gv
=
Ãw
 
¡d
::
veùÜ
<¡d::veùÜ<>>*[
chªÃl_couÁ
];

30 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

32 
	gv
[
chªÃl_id
]=
Ãw
 
¡d
::
veùÜ
<¡d::veùÜ<>>[
ch_no_³r_chªÃl
];

34 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

35 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

37 
š™_v
(
chªÃl_id
,
ch_id
,
v
);

38 
	g¡d
::
veùÜ
<> 
‹mp
:(
v
[
chªÃl_id
][
ch_id
])){

40 
z
[
chªÃl_id
][
ch_id
][
‹mp
[0]]

41 [
‹mp
[1]][temp[2]]++;

43 
	gz
[
chªÃl_id
][
ch_id
][
‹mp
[3]]

44 [
‹mp
[4]][temp[5]]--;

50 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

51 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

52 
	gd
=0;d<(
¶ªe_no_³r_d›
*
block_no_³r_¶ªe
*
	gd›_no_³r_ch
);d++){

53 
	gt
[
chªÃl_id
][
ch_id
][
d
]=
z
[chªÃl_id][ch_id][d/(
¶ªe_no_³r_d›
*
block_no_³r_¶ªe
)][d%(plane_no_per_die*block_no_per_plane)/(block_no_per_plane)][d%block_no_per_plane];

58 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

59 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

60 
	g¡d
::
sÜt
(
t
[
chªÃl_id
][
ch_id
],t[chªÃl_id][ch_id]+
d›_no_³r_ch
*
¶ªe_no_³r_d›
*
block_no_³r_¶ªe
) ;

61 
	gd
=0;d<(
¶ªe_no_³r_d›
*
block_no_³r_¶ªe
*
	gd›_no_³r_ch
);d++){

68 
	gno_of_groups
=4;

69 
	gno_of_–em’ts
[
chªÃl_couÁ
][
ch_no_³r_chªÃl
][
no_of_groups
];

70 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

71 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

72 
	ggr1
=0;gr1<
	ggroup_no
;gr1++){

73 
	gno_of_–em’ts
[
chªÃl_id
][
ch_id
][
gr1
]=0;

77 
	gsize_of_group
=(
chªÃl_couÁ
*
ch_no_³r_chªÃl
*
d›_no_³r_ch
*
¶ªe_no_³r_d›
*
block_no_³r_¶ªe
)/
no_of_groups
;

80 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

81 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

82 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

83 
	g¶ªe_id
 =0;¶ªe_id<
	g¶ªe_no_³r_d›
;plane_id++){

84 
	gblock_id
=0;block_id<
	gblock_no_³r_¶ªe
;block_id++){

85 
	g¡d
::
veùÜ
<> 
vec
;

86 
	gvec
.
push_back
(
chªÃl_id
);

87 
	gvec
.
push_back
(
ch_id
);

88 
	gvec
.
push_back
(
d›_id
);

89 
	gvec
.
push_back
(
¶ªe_id
);

90 
	gvec
.
push_back
(
block_id
);

92 
	ggro
=0;gro<
	ggroup_no
;gro++){

93 if((
	gz
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
][
block_id
]<=
t
[channel_id][chip_id]

94 [(
size_of_group
/(
chªÃl_couÁ
*
ch_no_³r_chªÃl
))*(
gro
+1)-1])){

95 

=0;

97 
	gno_of_–em’ts
[
chªÃl_id
][
ch_id
][

]==
size_of_group
/(
chªÃl_couÁ
*
ch_no_³r_chªÃl
)){

98 

++;

100 
	ggroup
[
chªÃl_id
][
ch_id
].
š£¹
({

,
vec
});

101 
	gno_of_–em’ts
[
chªÃl_id
][
ch_id
][

]++;

112 
	gsz_of_gr
=(
size_of_group
/(
chªÃl_couÁ
*
ch_no_³r_chªÃl
));

114 
	gsize_of_group_–em’t
=(
size_of_group
*5)/100;

116 
	gtİe
=0;tİe<
	ggroup_no
;tope++){

120 
	gg_couÁ
[
group_no
]{0};

121 
PageRPGCache
* 
	gp
=
NULL
;

123 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

124 
	gik
=0;ik<
	ggroup_no
;ik++){

125 
	gg_couÁ
[
ik
]=0;

128 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

129 
	gik
=0;ik<
	ggroup_no
;ik++){

130 
	gg_couÁ
[
ik
]=0;

133 
	gi_id
=0;i_id<
	ggroup_no
;i_id++){

134 autØ
	g™
 = 
group
[
chªÃl_id
][
ch_id
].
equ®_¿nge
(
i_id
);

136 autØ
	g™r
=
™
.
fœ¡
;™r!=™.
£cÚd
 && 
g_couÁ
[
i_id
]<
size_of_group_–em’t
/

137 (
chªÃl_couÁ
*
ch_no_³r_chªÃl
);
	g™r
++){

140 
	gp
=
Ãw
 
PageRPGCache
(
™r
->
£cÚd
,0);

141 
	gp
->
	gcouÁ
=0;

144 
	gg
[
i_id
].
push_back
(
¡d
::
·œ
<
PageRPGCache
*,
LPA_ty³
> (
p
,0));

145 (
	gblock_mªag”
->
	g¶ªe_mªag”
[
p
->
vec
[0]][p->vec[1]][p->vec[2]][p->vec[3]].
	gRPG_Blocks
).
push_back
(&(
block_mªag”
->
¶ªe_mªag”
[p->vec[0]][p->vec[1]][p->vec[2]][p->vec[3]].
Blocks
[p->vec[4]]));

146 
	gg_couÁ
[
i_id
]++;

156 
	g¡d
::
cout
<<"Szz:"<<
g
[0].
size
()<<
¡d
::
’dl
;

157 
	g¡d
::
cout
<<"Szz:"<<
g
[1].
size
()<<
¡d
::
’dl
;

158 
	g¡d
::
cout
<<"Szz:"<<
g
[2].
size
()<<
¡d
::
’dl
;

159 
	g¡d
::
cout
<<"Szz:"<<
g
[3].
size
()<<
¡d
::
’dl
;

162 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

163 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

164 
	gd–‘e
 [] 
	gt
[
chªÃl_id
][
ch_id
];

165 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

166 
	g¶ªe_id
 =0;¶ªe_id<
	g¶ªe_no_³r_d›
;plane_id++){

167 
	gd–‘e
 [] 
	gz
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
];

169 
	gd–‘e
 [] 
	gz
[
chªÃl_id
][
ch_id
][
d›_id
];

171 
	gd–‘e
 [] 
	gz
[
chªÃl_id
][
ch_id
];

173 
	gd–‘e
 [] 
	gz
[
chªÃl_id
];

174 
	gd–‘e
 [] 
	gt
[
chªÃl_id
];

177 
	gd–‘e
 [] 
	gz
;

178 
	gd–‘e
 [] 
	gt
;

179 
	g®loc
=
Œue
;

187 
LPA_ty³
 
	gkey
=
LPN_TO_UNIQUE_KEY
(
¡»amID
,
Ín
);

188 
boŞ
 
	gæag
=
çl£
;

189 
	g¡d
::
li¡
<
¡d
::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>::
™”©Ü
 
i
;

190 
	ggrou³
=0;grou³<
	ggroup_no
;groupe++){

191 autØ
	g™
=
m­
[
grou³
].
fšd
(
key
);

192 cÚ¡‡utØ
	gk™
=
™
->
£cÚd
;

193 if(
	g™
!=
m­
[
grou³
].
’d
()){

194 
k™
->
fœ¡
->
couÁ
++;

196 
	gæag
=
Œue
;

197 
	gi
=
k™
;

199 if(
	g™
->
	g£cÚd
->
	gfœ¡
->
	gcouÁ
==
couÁ_size
 && 
grou³
!= 0) {

200 
i
=
g‘_NthChªûBack
(
grou³
-1);

207 
	gi
=
g‘_NthChªûBack
(
grou³
-1);

208 
	gæag
=
Œue
;

210 
LPA_ty³
 
	gk
=(*
i
).
£cÚd
;

211 (*
	gi
).
	g£cÚd
=((*
™
).
£cÚd
)->second;

212 ((*
	g™
).
	g£cÚd
)->£cÚd=
k
;

213 ((*
	g™
).
	g£cÚd
)->
	gfœ¡
->
	gcouÁ
=0;

214 
	gm­
[
grou³
].
”a£
(
™
);

215 autØ
	g™t
=
m­
[
grou³
-1].
fšd
(
k
);

216 
	gm­
[
grou³
].
”a£
(
™t
);

218 
	gm­
[
grou³
].
š£¹
({
k
,
i
});

219 
	gm­
[
grou³
-1].
š£¹
({
key
,
k™
});

223 if(!
	gæag
){

224 
	gi
=
g‘_NthChªûBack
(3);

225 (*
	gi
).
	g£cÚd
=
key
;

226 (*
	gi
).
	gfœ¡
->
	gcouÁ
=0;

228 
	gm­
[3].
š£¹
({
key
,
i
});

230  
	gi
->
	gfœ¡
;

233 
	g¡d
::
li¡
<
¡d
::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>::
™”©Ü
 
Add»ss_M­pšg_Un™_Page_Lev–
::
g‘_NthChªûBack
(
grou³
){

234 
¡d
::
li¡
<¡d::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>::
™”©Ü
 
mš_™r
=
g
[
grou³
].
begš
();

236 
	gmš
=
couÁ_size
+1;

237 autØ
	g’d
=
g
[
grou³
].
begš
();

238 
	gmš_™r
=
g
[
grou³
].
’d
();

239 autØ
	g™
=
g
[
grou³
].
begš
();™!=g[grou³].
’d
();it++){

242 if(
	g™
->
	gfœ¡
->
	gcouÁ
<=
mš
){

243 
mš
=
™
->
£cÚd
;

244 
	gmš_™r
=
™
;

247 
	g’d
=
™
;

251 
	ggr
=0;gr<
	ggroup_no
;gr++){

255 if(
	gmš_™r
==
g
[
grou³
].
’d
()){

256 
mš_™r
=
’d
;

260 
	gmš_™r
->
	gfœ¡
->
	gcouÁ
!=0){

261 autØ
™
=
g
[
grou³
].
begš
();
	g™
!=g[grou³].
’d
();it++){

262 if(
	g™
->
	gfœ¡
->
	gcouÁ
!=0)

263 --(
™
->
fœ¡
->
couÁ
);

267  
	gmš_™r
;

269 
	gCached_M­pšg_TabË
::~
Cached_M­pšg_TabË
()

271 
¡d
::
unÜd”ed_m­
<
LPA_ty³
, 
	gCMTSlÙTy³
*> 
	gadd»ssM­
;

272 
	g¡d
::
li¡
<
¡d
::
·œ
<
LPA_ty³
, 
	gCMTSlÙTy³
*>> 
	gÌuLi¡
;

274 autØ
	g’Œy
 = 
add»ssM­
.
begš
();

275 
	g’Œy
 !ğ
add»ssM­
.
’d
()) {

276 
d–‘e
 (*
’Œy
).
£cÚd
;

277 
	gadd»ssM­
.
”a£
(
’Œy
++);

281 
šlše
 
boŞ
 
	gCached_M­pšg_TabË
::
Exi¡s
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
)

283 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ía
);

284 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

285 ià(
	g™
 =ğ
add»ssM­
.
’d
()) {

286 
DEBUG
("Add»s m­pšgabË qu”y - SŒ—m ID:" << 
¡»amID
 << ", LPA:" << 
Ía
 << ", MISS")

287  
çl£
;

289 ià(
	g™
->
	g£cÚd
->
	gStus
 !ğ
CMTEÁryStus
::
VALID
) {

290 
DEBUG
("Add»s m­pšgabË qu”y - SŒ—m ID:" << 
¡»amID
 << ", LPA:" << 
Ía
 << ", MISS")

291  
çl£
;

294 
DEBUG
("Add»s m­pšgabË qu”y - SŒ—m ID:" << 
¡»amID
 << ", LPA:" << 
Ía
 << ", HIT")

295  
	gŒue
;

298 
PPA_ty³
 
	gCached_M­pšg_TabË
::
R‘r›ve_µa
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
)

300 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ín
);

301 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

302 
as£¹
(
™
 !ğ
add»ssM­
.
’d
());

303 
as£¹
(
™
->
£cÚd
->
Stus
 =ğ
CMTEÁryStus
::
VALID
);

304 
	gÌuLi¡
.
¥liû
(
ÌuLi¡
.
begš
(),†ruLi¡, 
™
->
£cÚd
->
li¡PŒ
);

306  
	g™
->
	g£cÚd
->
	gPPA
;

309 
·ge_¡©us_ty³
 
	gCached_M­pšg_TabË
::
G‘_b™m­_veùÜ_of_wr™‹n_£ùÜs
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
)

311 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ín
);

312 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

313 
as£¹
(
™
 !ğ
add»ssM­
.
’d
());

314 
as£¹
(
™
->
£cÚd
->
Stus
 =ğ
CMTEÁryStus
::
VALID
);

316  
	g™
->
	g£cÚd
->
	gWr™‹nS‹B™m­
;

319 
	gCached_M­pšg_TabË
::
Upd©e_m­pšg_šfo
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
, cÚ¡ 
PPA_ty³
 
µa
, cÚ¡ 
·ge_¡©us_ty³
 
·geWr™eS‹
)

321 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ía
);

322 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

323 
as£¹
(
™
 !ğ
add»ssM­
.
’d
());

324 
as£¹
(
™
->
£cÚd
->
Stus
 =ğ
CMTEÁryStus
::
VALID
);

325 
	g™
->
	g£cÚd
->
	gPPA
 = 
µa
;

326 
	g™
->
	g£cÚd
->
	gWr™‹nS‹B™m­
 = 
·geWr™eS‹
;

327 
	g™
->
	g£cÚd
->
	gDœty
 = 
Œue
;

328 
	g™
->
	g£cÚd
->
	gSŒ—m_id
 = 
¡»amID
;

329 
DEBUG
("Add»s m­pšgabË upd©’Œy - SŒ—m ID:" << 
¡»amID
 << ", LPA:" << 
Ía
 << ", PPA:" << 
µa
)

332 
	gCached_M­pšg_TabË
::
In£¹_Ãw_m­pšg_šfo
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
, cÚ¡ 
PPA_ty³
 
µa
, cÚ¡ 
·geWr™eS‹
)

334 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ía
);

335 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

336 ià(
	g™
 =ğ
add»ssM­
.
’d
()) {

337 
throw
 
¡d
::
logic_”rÜ
("No slot is„eserved!");

340 
	g™
->
	g£cÚd
->
	gStus
 = 
CMTEÁryStus
::
VALID
;

341 
	g™
->
	g£cÚd
->
	gPPA
 = 
µa
;

342 
	g™
->
	g£cÚd
->
	gWr™‹nS‹B™m­
 = 
·geWr™eS‹
;

343 
	g™
->
	g£cÚd
->
	gDœty
 = 
çl£
;

344 
	g™
->
	g£cÚd
->
	gSŒ—m_id
 = 
¡»amID
;

345 
DEBUG
("Add»s m­pšgabË in£¹ƒÁry - SŒ—m ID:" << 
¡»amID
 << ", LPA:" << 
Ía
 << ", PPA:" << 
µa
)

347 
boŞ
 
	gCached_M­pšg_TabË
::
Is_¦Ù_»£rved_fÜ_Ín_ªd_wa™šg
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
)

349 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ín
);

350 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

351 ià(
	g™
 !ğ
add»ssM­
.
’d
()) {

352 ià(
™
->
£cÚd
->
Stus
 =ğ
CMTEÁryStus
::
WAITING
) {

353  
Œue
;

357  
	gçl£
;

360 
šlše
 
boŞ
 
	gCached_M­pšg_TabË
::
Check_ä“_¦Ù_avaab™y
()

362  
add»ssM­
.
size
(è< 
ÿ·c™y
;

365 
	gCached_M­pšg_TabË
::
Re£rve_¦Ù_fÜ_Ín
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
)

367 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ín
);

369 ià(
	gadd»ssM­
.
fšd
(
key
è!ğ
add»ssM­
.
’d
()) {

370 
throw
 
¡d
::
logic_”rÜ
("Duplicate†pa insertion into CMT!");

372 ià(
	gadd»ssM­
.
size
(è>ğ
ÿ·c™y
) {

373 
throw
 
¡d
::
logic_”rÜ
("CMT overfull!");

376 
CMTSlÙTy³
* 
	gcmtEÁ
 = 
Ãw
 CMTSlotType();

377 
	gcmtEÁ
->
	gDœty
 = 
çl£
;

378 
	gcmtEÁ
->
	gSŒ—m_id
 = 
¡»amID
;

379 
	gÌuLi¡
.
push_äÚt
(
¡d
::
·œ
<
LPA_ty³
, 
CMTSlÙTy³
*>(
key
, 
cmtEÁ
));

380 
	gcmtEÁ
->
	gStus
 = 
CMTEÁryStus
::
WAITING
;

381 
	gcmtEÁ
->
	gli¡PŒ
 = 
ÌuLi¡
.
begš
();

382 
	gadd»ssM­
[
key
] = 
cmtEÁ
;

385 
CMTSlÙTy³
 
	gCached_M­pšg_TabË
::
Eviù_Úe_¦Ù
(
LPA_ty³
& 
Ía
)

387 
as£¹
(
add»ssM­
.
size
() > 0);

388 
	gadd»ssM­
.
”a£
(
ÌuLi¡
.
back
().
fœ¡
);

389 
	gÍa
 = 
UNIQUE_KEY_TO_LPN
(
ÌuLi¡
.
back
().
£cÚd
->
SŒ—m_id
,ÌuLi¡.back().
fœ¡
);

390 
CMTSlÙTy³
 
	geviùedI‹m
 = *
ÌuLi¡
.
back
().
£cÚd
;

391 
d–‘e
 
	gÌuLi¡
.
back
().
	g£cÚd
;

392 
	gÌuLi¡
.
pİ_back
();

394  
	geviùedI‹m
;

397 
boŞ
 
	gCached_M­pšg_TabË
::
Is_dœty
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
)

399 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ía
);

400 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

401 ià(
	g™
 =ğ
add»ssM­
.
’d
())

403 
throw
 
¡d
::
logic_”rÜ
("The„equested slot does‚otƒxist!");

406  
	g™
->
	g£cÚd
->
	gDœty
;

409 
	gCached_M­pšg_TabË
::
Make_ş—n
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
)

411 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»amID
, 
Ín
);

412 autØ
	g™
 = 
add»ssM­
.
fšd
(
key
);

413 ià(
	g™
 =ğ
add»ssM­
.
’d
()) {

414 
throw
 
¡d
::
logic_”rÜ
("The„equested slot does‚otƒxist!");

417 
	g™
->
	g£cÚd
->
	gDœty
 = 
çl£
;

421 
	gAdd»ssM­pšgDomaš
::
Add»ssM­pšgDomaš
(
cmt_ÿ·c™y
, 
cmt_’Œy_size
, 
no_of_Œª¦©iÚ_’Œ›s_³r_·ge
,

422 
Cached_M­pšg_TabË
* 
CMT
,

423 
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
 
PÏÃAÎoÿtiÚScheme
,

424 
æash_chªÃl_ID_ty³
* 
chªÃl_ids
, 
chªÃl_no
, 
æash_ch_ID_ty³
* 
ch_ids
, 
ch_no
,

425 
æash_d›_ID_ty³
* 
d›_ids
, 
d›_no
, 
æash_¶ªe_ID_ty³
* 
¶ªe_ids
, 
¶ªe_no
,

426 
PPA_ty³
 
tÙ®_physiÿl_£ùÜs_no
, 
LHA_ty³
 
tÙ®_logiÿl_£ùÜs_no
, 
£ùÜs_no_³r_·ge
) :

427 
CMT_’Œy_size
(
cmt_’Œy_size
), 
T¿n¦©iÚ_’Œ›s_³r_·ge
(
no_of_Œª¦©iÚ_’Œ›s_³r_·ge
), 
No_of_š£¹ed_’Œ›s_š_´ecÚd™iÚšg
(0),

428 
PÏÃAÎoÿtiÚScheme
(PÏÃAÎoÿtiÚScheme), 
ChªÃl_no
(
chªÃl_no
), 
Ch_no
(
ch_no
), 
D›_no
(
d›_no
), 
PÏÃ_no
(
¶ªe_no
)

430 
	gTÙ®_physiÿl_·ges_no
 = 
tÙ®_physiÿl_£ùÜs_no
 / 
£ùÜs_no_³r_·ge
;

431 
	gmax_logiÿl_£ùÜ_add»ss
 = 
tÙ®_logiÿl_£ùÜs_no
;

432 
	gTÙ®_logiÿl_·ges_no
 = (
max_logiÿl_£ùÜ_add»ss
 / 
£ùÜs_no_³r_·ge
) + (max_logical_sector_address % sectors_no_per_page == 0? 0 : 1);

434 
	gChªÃl_ids
 = 
Ãw
 
æash_chªÃl_ID_ty³
[
chªÃl_no
];

435 
æash_chªÃl_ID_ty³
 
	gcid
 = 0; cid < 
	gchªÃl_no
; cid++) {

436 
	gChªÃl_ids
[
cid
] = 
chªÃl_ids
[cid];

439 
	gCh_ids
 = 
Ãw
 
æash_ch_ID_ty³
[
ch_no
];

440 
æash_ch_ID_ty³
 
	gcid
 = 0; cid < 
	gch_no
; cid++) {

441 
	gCh_ids
[
cid
] = 
ch_ids
[cid];

444 
	gD›_ids
 = 
Ãw
 
æash_d›_ID_ty³
[
d›_no
];

445 
æash_d›_ID_ty³
 
	gdid
 = 0; did < 
	gd›_no
; did++) {

446 
	gD›_ids
[
did
] = 
d›_ids
[did];

449 
	gPÏÃ_ids
 = 
Ãw
 
æash_¶ªe_ID_ty³
[
¶ªe_no
];

450 
æash_¶ªe_ID_ty³
 
	gpid
 = 0;…id < 
	g¶ªe_no
;…id++) {

451 
	gPÏÃ_ids
[
pid
] = 
¶ªe_ids
[pid];

454 
	gGlob®M­pšgTabË
 = 
Ãw
 
GMTEÁryTy³
[
TÙ®_logiÿl_·ges_no
];

455 
	gi
 = 0; i < 
	gTÙ®_logiÿl_·ges_no
; i++) {

456 
	gGlob®M­pšgTabË
[
i
].
	gPPA
 = 
NO_PPA
;

457 
	gGlob®M­pšgTabË
[
i
].
	gWr™‹nS‹B™m­
 = 
UNWRITTEN_LOGICAL_PAGE
;

458 
	gGlob®M­pšgTabË
[
i
].
	gTimeSmp
 = 0;

462 ià(
	gCMT
 =ğ
NULL
) {

464 
this
->
CMT
 = 
Ãw
 
Cached_M­pšg_TabË
(
cmt_ÿ·c™y
);

467 
	gthis
->
	gCMT
 = 
CMT
;

470 
	gTÙ®_Œª¦©iÚ_·ges_no
 = 
MVPN_ty³
(
TÙ®_logiÿl_·ges_no
 / 
T¿n¦©iÚ_’Œ›s_³r_·ge
);

471 
	gGlob®T¿n¦©iÚDœeùÜy
 = 
Ãw
 
GTDEÁryTy³
[
TÙ®_Œª¦©iÚ_·ges_no
 + 1];

472 
MVPN_ty³
 
	gi
 = 0; i <ğ
TÙ®_Œª¦©iÚ_·ges_no
; i++) {

473 
	gGlob®T¿n¦©iÚDœeùÜy
[
i
].
	gMPPN
 = (
MPPN_ty³
)
NO_MPPN
;

474 
	gGlob®T¿n¦©iÚDœeùÜy
[
i
].
	gTimeSmp
 = 
INVALID_TIME_STAMP
;

478 
	gAdd»ssM­pšgDomaš
::~
Add»ssM­pšgDomaš
()

480 
d–‘e
 
CMT
;

481 
	gd–‘e
[] 
	gGlob®M­pšgTabË
;

482 
	gd–‘e
[] 
	gGlob®T¿n¦©iÚDœeùÜy
;

484 autØ
	g»ad_’Œy
 = 
Wa™šg_unm­³d_»ad_Œª§ùiÚs
.
begš
();

485 
	g»ad_’Œy
 !ğ
Wa™šg_unm­³d_»ad_Œª§ùiÚs
.
’d
()) {

486 
d–‘e
 
»ad_’Œy
->
£cÚd
;

487 
	gWa™šg_unm­³d_»ad_Œª§ùiÚs
.
”a£
(
»ad_’Œy
++);

490 autØ
	g’Œy_wr™e
 = 
Wa™šg_unm­³d_´og¿m_Œª§ùiÚs
.
begš
();

491 
	g’Œy_wr™e
 !ğ
Wa™šg_unm­³d_´og¿m_Œª§ùiÚs
.
’d
()) {

492 
d–‘e
 
’Œy_wr™e
->
£cÚd
;

493 
	gWa™šg_unm­³d_´og¿m_Œª§ùiÚs
.
”a£
(
’Œy_wr™e
++);

496 
	gd–‘e
[] 
	gChªÃl_ids
;

497 
	gd–‘e
[] 
	gCh_ids
;

498 
	gd–‘e
[] 
	gD›_ids
;

499 
	gd–‘e
[] 
	gPÏÃ_ids
;

502 
šlše
 
	gAdd»ssM­pšgDomaš
::
Upd©e_m­pšg_šfo
(cÚ¡ 
boŞ
 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
, cÚ¡ 
PPA_ty³
 
µa
, cÚ¡ 
·ge_¡©us_ty³
 
·ge_¡©us_b™m­
)

504 ià(
	gid—l_m­pšg
) {

505 
	gGlob®M­pšgTabË
[
Ía
].
	gPPA
 = 
µa
;

506 
	gGlob®M­pšgTabË
[
Ía
].
	gWr™‹nS‹B™m­
 = 
·ge_¡©us_b™m­
;

507 
	gGlob®M­pšgTabË
[
Ía
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

509 
	gCMT
->
Upd©e_m­pšg_šfo
(
¡»am_id
, 
Ía
, 
µa
, 
·ge_¡©us_b™m­
);

513 
šlše
 
·ge_¡©us_ty³
 
	gAdd»ssM­pšgDomaš
::
G‘_·ge_¡©us
(cÚ¡ 
boŞ
 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
)

515 ià(
	gid—l_m­pšg
) {

516  
	gGlob®M­pšgTabË
[
Ía
].
	gWr™‹nS‹B™m­
;

518  
	gCMT
->
G‘_b™m­_veùÜ_of_wr™‹n_£ùÜs
(
¡»am_id
, 
Ía
);

522 
šlše
 
PPA_ty³
 
	gAdd»ssM­pšgDomaš
::
G‘_µa
(cÚ¡ 
boŞ
 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
)

524 ià(
	gid—l_m­pšg
) {

525  
	gGlob®M­pšgTabË
[
Ía
].
	gPPA
;

527  
	gCMT
->
R‘r›ve_µa
(
¡»am_id
, 
Ía
);

531 
šlše
 
PPA_ty³
 
	gAdd»ssM­pšgDomaš
::
G‘_µa_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
)

533  
	gGlob®M­pšgTabË
[
Ía
].
	gPPA
;

536 
šlše
 
boŞ
 
	gAdd»ssM­pšgDomaš
::
M­pšg_’Œy_acûssibË
(cÚ¡ boŞ 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
)

538 ià(
	gid—l_m­pšg
) {

539  
	gŒue
;

541  
	gCMT
->
Exi¡s
(
¡»am_id
, 
Ía
);

545 
Add»ss_M­pšg_Un™_Page_Lev–
* 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
_my_š¡ªû
 = 
NULL
;

546 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
Add»ss_M­pšg_Un™_Page_Lev–
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
,

547 
boŞ
 
id—l_m­pšg_bË
, 
cmt_ÿ·c™y_š_by‹
, 
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
 
PÏÃAÎoÿtiÚScheme
,

548 
cÚcu¼’t_¡»am_no
,

549 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

550 
¡d
::
veùÜ
<¡d::veùÜ<
æash_chªÃl_ID_ty³
>> 
¡»am_chªÃl_ids
, std::veùÜ<¡d::veùÜ<
æash_ch_ID_ty³
>> 
¡»am_ch_ids
,

551 
¡d
::
veùÜ
<¡d::veùÜ<
æash_d›_ID_ty³
>> 
¡»am_d›_ids
, std::veùÜ<¡d::veùÜ<
æash_¶ªe_ID_ty³
>> 
¡»am_¶ªe_ids
,

552 
block_no_³r_¶ªe
, 
Page_no_³r_block
, 
SeùÜsP”Page
, 
PageSizeInBy‹
,

553 
Ov”´ovisiÚšg_¿tio
, 
CMT_Sh¬šg_Mode
 
sh¬šg_mode
, 
boŞ
 
fŞd_Ïrge_add»s£s
)

554 : 
Add»ss_M­pšg_Un™_Ba£
(
id
, 
ál
, 
æash_cÚŒŞËr
, 
block_mªag”
, 
id—l_m­pšg_bË
,

555 
cÚcu¼’t_¡»am_no
, 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

556 
block_no_³r_¶ªe
, 
Page_no_³r_block
, 
SeùÜsP”Page
, 
PageSizeInBy‹
, 
Ov”´ovisiÚšg_¿tio
, 
sh¬šg_mode
, 
fŞd_Ïrge_add»s£s
)

558 
	g®loc
=
çl£
;

559 
	g_my_š¡ªû
 = 
this
;

560 
	ggroup_no
=4;

561 
	gdomašs
 = 
Ãw
 
Add»ssM­pšgDomaš
*[
no_of_šput_¡»ams
];

562 
	gz
=
Ãw
 ****[
chªÃl_couÁ
];

563 
	gt
=
Ãw
 **[
chªÃl_couÁ
];

565 
	ggroup
=
Ãw
 
¡d
::
muÉim­
<,
	g¡d
::
veùÜ
<>>*[
chªÃl_couÁ
];

566 
	gWr™e_Œª§ùiÚs_fÜ_ov”fuÎ_¶ªes
 = 
Ãw
 
¡d
::
£t
<
NVM_T¿n§ùiÚ_FÏsh_WR
*>***[
chªÃl_couÁ
];

567 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

568 
	gWr™e_Œª§ùiÚs_fÜ_ov”fuÎ_¶ªes
[
chªÃl_id
] = 
Ãw
 
¡d
::
£t
<
NVM_T¿n§ùiÚ_FÏsh_WR
*>**[
ch_no_³r_chªÃl
];

569 
	ggroup
[
chªÃl_id
]=
Ãw
 
¡d
::
muÉim­
<,
	g¡d
::
veùÜ
<>>[
ch_no_³r_chªÃl
];

571 
	gz
[
chªÃl_id
]=
Ãw
 ***[
ch_no_³r_chªÃl
];

572 
	gt
[
chªÃl_id
]=
Ãw
 *[
ch_no_³r_chªÃl
];

574 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

575 
	gt
[
chªÃl_id
][
ch_id
]=
Ãw
 [
d›_no_³r_ch
*
¶ªe_no_³r_d›
*
block_no_³r_¶ªe
];

577 
	gWr™e_Œª§ùiÚs_fÜ_ov”fuÎ_¶ªes
[
chªÃl_id
][
ch_id
] = 
Ãw
 
¡d
::
£t
<
NVM_T¿n§ùiÚ_FÏsh_WR
*>*[
d›_no_³r_ch
];

578 
	gz
[
chªÃl_id
][
ch_id
]=
Ãw
 **[
d›_no_³r_ch
];

579 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

580 
	gWr™e_Œª§ùiÚs_fÜ_ov”fuÎ_¶ªes
[
chªÃl_id
][
ch_id
][
d›_id
] = 
Ãw
 
¡d
::
£t
<
NVM_T¿n§ùiÚ_FÏsh_WR
*>[
¶ªe_no_³r_d›
];

581 
	gz
[
chªÃl_id
][
ch_id
][
d›_id
]=
Ãw
 *[
¶ªe_no_³r_d›
];

582 
	g¶ªe_id
 =0;¶ªe_id<
	g¶ªe_no_³r_d›
;plane_id++){

583 
	gz
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
]=
Ãw
 [
block_no_³r_¶ªe
];

584 
	gblock_id
=0;block_id<
	gblock_no_³r_¶ªe
;block_id++){

585 
	gz
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
][
block_id
]=0;

592 
	g®loc
=
çl£
;

593 
	gg
=
Ãw
 
¡d
::
li¡
<¡d::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>[
group_no
];

597 
	gm­
=
Ãw
 
¡d
::
m­
<
LPA_ty³
,
	g¡d
::
li¡
<¡d::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>::
™”©Ü
>[
group_no
];

598 
æash_chªÃl_ID_ty³
* 
	gchªÃl_ids
 = 
NULL
;

599 
æash_chªÃl_ID_ty³
* 
	gch_ids
 = 
NULL
;

600 
æash_chªÃl_ID_ty³
* 
	gd›_ids
 = 
NULL
;

601 
æash_chªÃl_ID_ty³
* 
	g¶ªe_ids
 = 
NULL
;

602 
	gdomašID
 = 0; domašID < 
	gno_of_šput_¡»ams
; domainID++) {

607 
	gCMT_’Œy_size
 = ()
¡d
::
û
(((2 * std::
log2
(
tÙ®_physiÿl_·ges_no
)è+ 
£ùÜ_no_³r_·ge
) / 8);

609 
	gGTD_’Œy_size
 = ()
¡d
::
û
((¡d::
log2
(
tÙ®_physiÿl_·ges_no
è+ 
£ùÜ_no_³r_·ge
) / 8);

610 
	gno_of_Œª¦©iÚ_’Œ›s_³r_·ge
 = (
SeùÜsP”Page
 * 
SECTOR_SIZE_IN_BYTE
è/ 
GTD_’Œy_size
;

612 
Cached_M­pšg_TabË
* 
	gsh¬edCMT
 = 
NULL
;

613 
	g³r_¡»am_cmt_ÿ·c™y
 = 0;

614 
	gcmt_ÿ·c™y
 = 
cmt_ÿ·c™y_š_by‹
 / 
CMT_’Œy_size
;

615 
	gsh¬šg_mode
) {

616 
	gCMT_Sh¬šg_Mode
::
SHARED
:

617 
³r_¡»am_cmt_ÿ·c™y
 = 
cmt_ÿ·c™y
;

618 
	gsh¬edCMT
 = 
Ãw
 
Cached_M­pšg_TabË
(
cmt_ÿ·c™y
);

620 
	gCMT_Sh¬šg_Mode
::
EQUAL_SIZE_PARTITIONING
:

621 
³r_¡»am_cmt_ÿ·c™y
 = 
cmt_ÿ·c™y
 / 
no_of_šput_¡»ams
;

626 
	gchªÃl_ids
 = 
Ãw
 
æash_chªÃl_ID_ty³
[
¡»am_chªÃl_ids
[
domašID
].
size
()];

627 
	gi
 = 0; i < 
	g¡»am_chªÃl_ids
[
domašID
].
size
(); i++) {

628 ià(
	g¡»am_chªÃl_ids
[
domašID
][
i
] < 
	gchªÃl_couÁ
) {

629 
	gchªÃl_ids
[
i
] = 
¡»am_chªÃl_ids
[
domašID
][i];

631 
PRINT_ERROR
("Inv®id chªÃÈID s³cif›d fÜ I/O flow " << 
domašID
);

635 
	gch_ids
 = 
Ãw
 
æash_chªÃl_ID_ty³
[
¡»am_ch_ids
[
domašID
].
size
()];

636 
	gi
 = 0; i < 
	g¡»am_ch_ids
[
domašID
].
size
(); i++) {

637 ià(
	g¡»am_ch_ids
[
domašID
][
i
] < 
	gch_no_³r_chªÃl
) {

638 
	gch_ids
[
i
] = 
¡»am_ch_ids
[
domašID
][i];

640 
PRINT_ERROR
("Inv®id ch ID s³cif›d fÜ I/O flow " << 
domašID
);

644 
	gd›_ids
 = 
Ãw
 
æash_chªÃl_ID_ty³
[
¡»am_d›_ids
[
domašID
].
size
()];

645 
	gi
 = 0; i < 
	g¡»am_d›_ids
[
domašID
].
size
(); i++) {

646 ià(
	g¡»am_d›_ids
[
domašID
][
i
] < 
	gd›_no_³r_ch
) {

647 
	gd›_ids
[
i
] = 
¡»am_d›_ids
[
domašID
][i];

649 
PRINT_ERROR
("Inv®id d› ID s³cif›d fÜ I/O flow " << 
domašID
);

653 
	g¶ªe_ids
 = 
Ãw
 
æash_chªÃl_ID_ty³
[
¡»am_¶ªe_ids
[
domašID
].
size
()];

654 
	gi
 = 0; i < 
	g¡»am_¶ªe_ids
[
domašID
].
size
(); i++) {

655 ià(
	g¡»am_¶ªe_ids
[
domašID
][
i
] < 
	g¶ªe_no_³r_d›
) {

656 
	g¶ªe_ids
[
i
] = 
¡»am_¶ªe_ids
[
domašID
][i];

658 
PRINT_ERROR
("Inv®id…ÏÃ ID s³cif›d fÜ I/O flow " << 
domašID
);

662 
	gdomašs
[
domašID
] = 
Ãw
 
Add»ssM­pšgDomaš
(
³r_¡»am_cmt_ÿ·c™y
, 
CMT_’Œy_size
, 
no_of_Œª¦©iÚ_’Œ›s_³r_·ge
,

663 
sh¬edCMT
,

664 
PÏÃAÎoÿtiÚScheme
,

665 
chªÃl_ids
, ()(
¡»am_chªÃl_ids
[
domašID
].
size
()), 
ch_ids
, ()(
¡»am_ch_ids
[domašID].size()), 
d›_ids
,

666 ()(
¡»am_d›_ids
[
domašID
].
size
()), 
¶ªe_ids
, ()(
¡»am_¶ªe_ids
[domainID].size()),

667 
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
PDA_couÁ_®loÿ‹_to_æow
(
domašID
), Uts::Logiÿl_Add»ss_P¬t™iÚšg_Un™::
LHA_couÁ_®loÿ‹_to_æow_äom_deviû_v›w
(domainID),

668 
£ùÜ_no_³r_·ge
);

669 
	gd–‘e
[] 
	gchªÃl_ids
;

670 
	gd–‘e
[] 
	gch_ids
;

671 
	gd–‘e
[] 
	gd›_ids
;

672 
	gd–‘e
[] 
	g¶ªe_ids
;

675 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
š™_v
(
chªÃl_id
,

676 
ch_id
,
¡d
::
veùÜ
<¡d::veùÜ<>>** 
v
){

677 
¡d
::
f¡»am
 
m­_d©a
;

678 
	gm­_d©a
.
İ’
("map.dat");

679 
	g
,
	gtb
,
	gvp
,
	gvb
;

680 if(!
	gm­_d©a
)

684 
	gm­_d©a
>>
	g
>>
	gtb
>>
	gvp
>>
	gvb
;

687 
	gd
=0;d<
	gd›_no_³r_ch
;d++){

690 
	g¡d
::
veùÜ
<> 
vec
;

693 
	gvec
.
push_back
(
d
);

694 
	gvec
.
push_back
(

);

695 
	gvec
.
push_back
(
tb
);

696 
	gvec
.
push_back
(
d
);

697 
	gvec
.
push_back
(
vp
);

698 
	gvec
.
push_back
(
vb
);

700 
	gv
[
chªÃl_id
][
ch_id
].
push_back
(
vec
);

706 !
	gm­_d©a
.
eof
()){

707 
	gm­_d©a
>>
	g
>>
	gtb
>>
	gvp
>>
	gvb
;

708 
	gd
=0;d<
	gd›_no_³r_ch
;d++){

709 
	g¡d
::
veùÜ
<> 
vec
;

712 
	gvec
.
push_back
(
d
);

713 
	gvec
.
push_back
(

);

714 
	gvec
.
push_back
(
tb
);

715 
	gvec
.
push_back
(
d
);

716 
	gvec
.
push_back
(
vp
);

717 
	gvec
.
push_back
(
vb
);

719 
	gv
[
chªÃl_id
][
ch_id
].
push_back
(
vec
);

722 
	gm­_d©a
.
şo£
();

724 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::~
Add»ss_M­pšg_Un™_Page_Lev–
()

726 
i
 = 0; 
	gi
 < 
	gno_of_šput_¡»ams
; i++) {

727 
d–‘e
 
	gdomašs
[
i
];

729 
	gd–‘e
[] 
	gdomašs
;

733 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
S‘up_Œigg”s
()

735 
Sim_Objeù
::
S‘up_Œigg”s
();

736 
	gæash_cÚŒŞËr
->
CÚÃùToT¿n§ùiÚS”viûdSigÇl
(
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
);

739 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
S¹_simuÏtiÚ
()

741 
StÜe_m­pšg_bË_Ú_æash_©_¡¬t
();

744 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
V®id©e_simuÏtiÚ_cÚfig
()

748 
Add»ss_M­pšg_Un™_Page_Lev–
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

752 
Add»ss_M­pšg_Un™_Page_Lev–
::
StÜe_m­pšg_bË_Ú_æash_©_¡¬t
()

754 ià(
m­pšg_bË_¡Üed_Ú_æash
) {

759 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	gdummy_Œ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_WR(
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
, 0, 0,

760 
NO_LPA
, 0, 
NULL
, 0, NULL, 0, 0);

762 
	g¡»am_id
 = 0; sŒ—m_id < 
	gno_of_šput_¡»ams
; stream_id++) {

764 
	gdummy_Œ
->
	gSŒ—m_id
 = 
¡»am_id
;

765 
MVPN_ty³
 
	gŒª¦©iÚ_·ge_id
 = 0;¿n¦©iÚ_·ge_id < 
	gdomašs
[
¡»am_id
]->
	gTÙ®_Œª¦©iÚ_·ges_no
;ranslation_page_id++) {

766 
	gdummy_Œ
->
	gLPA
 = (
LPA_ty³
)
Œª¦©iÚ_·ge_id
;

767 
®loÿ‹_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
dummy_Œ
);

768 
®loÿ‹_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
dummy_Œ
, (
MVPN_ty³
)dummy_Œ->
LPA
, 
çl£
);

769 
	gæash_cÚŒŞËr
->
Chªge_æash_·ge_¡©us_fÜ_´ecÚd™iÚšg
(
dummy_Œ
->
Add»ss
, dummy_Œ->
LPA
);

772 
	gm­pšg_bË_¡Üed_Ú_æash
 = 
Œue
;

775 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
)

777 ià(
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
Ía
].
	gPPA
 =ğ
NO_PPA
) {

778 
PRINT_ERROR
("Touching‡n unallocated†ogical‡ddress in…reconditioning!")

781 ià(
domašs
[
¡»am_id
]->
CMT
->
Exi¡s
(¡»am_id, 
Ía
)) {

782  
	gdomašs
[
¡»am_id
]->
	gNo_of_š£¹ed_’Œ›s_š_´ecÚd™iÚšg
;

785 ià(
	gdomašs
[
¡»am_id
]->
	gCMT
->
Check_ä“_¦Ù_avaab™y
()) {

786 
	gdomašs
[
¡»am_id
]->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
(¡»am_id, 
Ía
);

787 
	gdomašs
[
¡»am_id
]->
	gCMT
->
In£¹_Ãw_m­pšg_šfo
(¡»am_id, 
Ía
,

788 
domašs
[
¡»am_id
]->
Glob®M­pšgTabË
[
Ía
].
PPA
, domašs[¡»am_id]->Glob®M­pšgTabË[Ía].
Wr™‹nS‹B™m­
);

790 
LPA_ty³
 
	geviùed_Ía
;

791 
	gdomašs
[
¡»am_id
]->
	gCMT
->
Eviù_Úe_¦Ù
(
eviùed_Ía
);

792 
	gdomašs
[
¡»am_id
]->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
(¡»am_id, 
Ía
);

793 
	gdomašs
[
¡»am_id
]->
	gCMT
->
In£¹_Ãw_m­pšg_šfo
(¡»am_id, 
Ía
,

794 
domašs
[
¡»am_id
]->
Glob®M­pšgTabË
[
Ía
].
PPA
, domašs[¡»am_id]->Glob®M­pšgTabË[Ía].
Wr™‹nS‹B™m­
);

796 
	gdomašs
[
¡»am_id
]->
	gNo_of_š£¹ed_’Œ›s_š_´ecÚd™iÚšg
++;

798  
	gdomašs
[
¡»am_id
]->
	gNo_of_š£¹ed_’Œ›s_š_´ecÚd™iÚšg
;

801 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
G‘_cmt_ÿ·c™y
()

803  
cmt_ÿ·c™y
;

806 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡»am_id_ty³
 
¡»am_id
)

808  
domašs
[
¡»am_id
]->
No_of_š£¹ed_’Œ›s_š_´ecÚd™iÚšg
;

811 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(cÚ¡ 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>& 
Œª§ùiÚLi¡
)

825 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>::
cÚ¡_™”©Ü
 
™
 = 
Œª§ùiÚLi¡
.
begš
();

826 
	g™
 !ğ
Œª§ùiÚLi¡
.
’d
(); ) {

827 if((*
	g™
)->
	gTy³
==
T¿n§ùiÚ_Ty³
::
READ
)

828 (*
™
)->
RPG_WR
=
Œue
;

834 ià(
is_Ía_locked_fÜ_gc
((*
™
)->
SŒ—m_id
, ((
NVM_T¿n§ùiÚ_FÏsh
*)(*™))->
LPA
)) {

836 
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
((
NVM_T¿n§ùiÚ_FÏsh
*)*(
™
++));

838 
qu”y_cmt
((
NVM_T¿n§ùiÚ_FÏsh
*)(*
™
++));

842 ià(
	gŒª§ùiÚLi¡
.
size
() > 0) {

843 
	gál
->
	gTSU
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

844 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>::
cÚ¡_™”©Ü
 
™
 = 
Œª§ùiÚLi¡
.
begš
();

845 
	g™
 !ğ
Œª§ùiÚLi¡
.
’d
(); it++) {

846 ià(((
	gNVM_T¿n§ùiÚ_FÏsh
*)(*
	g™
))->
	gPhysiÿl_add»ss_d‘”mšed
) {

847 
	gál
->
	gTSU
->
Subm™_Œª§ùiÚ
(
¡©ic_ÿ¡
<
NVM_T¿n§ùiÚ_FÏsh
*>(*
™
));

848 ià(((
	gNVM_T¿n§ùiÚ_FÏsh
*)(*
	g™
))->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
WRITE
) {

849 ià(((
NVM_T¿n§ùiÚ_FÏsh_WR
*)(*
™
))->
R–©edR—d
 !ğ
NULL
) {

850 
ál
->
TSU
->
Subm™_Œª§ùiÚ
(((
NVM_T¿n§ùiÚ_FÏsh_WR
*)(*
™
))->
R–©edR—d
);

856 
	gál
->
	gTSU
->
ScheduË
();

860 
boŞ
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
qu”y_cmt
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

862 
¡»am_id_ty³
 
¡»am_id
 = 
Œª§ùiÚ
->
SŒ—m_id
;

863 
	gSts
::
tÙ®_CMT_qu”›s
++;

864 
	gSts
::
tÙ®_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

866 ià(
	gdomašs
[
¡»am_id
]->
M­pšg_’Œy_acûssibË
(
id—l_m­pšg_bË
, sŒ—m_id, 
Œª§ùiÚ
->
LPA
))

868 
	gSts
::
CMT_h™s_³r_¡»am
[
¡»am_id
]++;

869 
	gSts
::
CMT_h™s
++;

870 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
READ
) {

871 
Sts
::
tÙ®_»adTR_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

872 
	gSts
::
tÙ®_»adTR_CMT_qu”›s
++;

873 
	gSts
::
»adTR_CMT_h™s_³r_¡»am
[
¡»am_id
]++;

874 
	gSts
::
»adTR_CMT_h™s
++;

877 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s
++;

878 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

879 
	gSts
::
wr™eTR_CMT_h™s
++;

880 
	gSts
::
wr™eTR_CMT_h™s_³r_¡»am
[
¡»am_id
]++;

883 ià(
Œª¦©e_Ía_to_µa
(
¡»am_id
, 
Œª§ùiÚ
)) {

884  
	gŒue
;

886 
mªge_unsucûssful_Œª¦©iÚ
(
Œª§ùiÚ
);

887  
	gçl£
;

891 ià(
»que¡_m­pšg_’Œy
(
¡»am_id
, 
Œª§ùiÚ
->
LPA
)) {

892 
	gSts
::
CMT_miss
++;

893 
	gSts
::
CMT_miss_³r_¡»am
[
¡»am_id
]++;

894 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
READ
) {

895 
Sts
::
tÙ®_»adTR_CMT_qu”›s
++;

896 
	gSts
::
tÙ®_»adTR_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

897 
	gSts
::
»adTR_CMT_miss
++;

898 
	gSts
::
»adTR_CMT_miss_³r_¡»am
[
¡»am_id
]++;

900 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s
++;

901 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

902 
	gSts
::
wr™eTR_CMT_miss
++;

903 
	gSts
::
wr™eTR_CMT_miss_³r_¡»am
[
¡»am_id
]++;

905 ià(
Œª¦©e_Ía_to_µa
(
¡»am_id
, 
Œª§ùiÚ
)) {

906  
	gŒue
;

908 
mªge_unsucûssful_Œª¦©iÚ
(
Œª§ùiÚ
);

909  
	gçl£
;

912 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
READ
) {

913 
Sts
::
tÙ®_»adTR_CMT_qu”›s
++;

914 
	gSts
::
tÙ®_»adTR_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

915 
	gSts
::
»adTR_CMT_miss
++;

916 
	gSts
::
»adTR_CMT_miss_³r_¡»am
[
¡»am_id
]++;

917 
	gdomašs
[
¡»am_id
]->
	gWa™šg_unm­³d_»ad_Œª§ùiÚs
.
š£¹
(
¡d
::
·œ
<
LPA_ty³
, 
NVM_T¿n§ùiÚ_FÏsh
*>(
Œª§ùiÚ
->
LPA
,ransaction));

919 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s
++;

920 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

921 
	gSts
::
wr™eTR_CMT_miss
++;

922 
	gSts
::
wr™eTR_CMT_miss_³r_¡»am
[
¡»am_id
]++;

923 
	gdomašs
[
¡»am_id
]->
	gWa™šg_unm­³d_´og¿m_Œª§ùiÚs
.
š£¹
(
¡d
::
·œ
<
LPA_ty³
, 
NVM_T¿n§ùiÚ_FÏsh
*>(
Œª§ùiÚ
->
LPA
,ransaction));

927  
	gçl£
;

934 
boŞ
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
Œª¦©e_Ía_to_µa
(
¡»am_id_ty³
 
¡»amID
, 
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

936 
PPA_ty³
 
	gµa
 = 
domašs
[
¡»amID
]->
G‘_µa
(
id—l_m­pšg_bË
, sŒ—mID, 
Œª§ùiÚ
->
LPA
);

938 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
READ
) {

939 ià(
µa
 =ğ
NO_PPA
) {

940 
µa
 = 
Úlše_ü—‹_’Œy_fÜ_»ads
(
Œª§ùiÚ
->
LPA
, 
¡»amID
,¿n§ùiÚ->
Add»ss
, ((
NVM_T¿n§ùiÚ_FÏsh_RD
*é¿n§ùiÚ)->
»ad_£ùÜs_b™m­
,
Œue
);

943 
	gŒª§ùiÚ
->
	gPPA
 = 
µa
;

944 
CÚv”t_µa_to_add»ss
(
Œª§ùiÚ
->
PPA
,¿n§ùiÚ->
Add»ss
);

945 
	gblock_mªag”
->
R—d_Œª§ùiÚ_issued
(
Œª§ùiÚ
->
Add»ss
);

946 
	gŒª§ùiÚ
->
	gPhysiÿl_add»ss_d‘”mšed
 = 
Œue
;

948  
	gŒue
;

950 
®loÿ‹_¶ªe_fÜ_u£r_wr™e
((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
Œª§ùiÚ
);

952 ià(
	gál
->
	gGC_ªd_WL_Un™
->
Stİ_£rvicšg_wr™es
(
Œª§ùiÚ
->
Add»ss
)){

953  
	gçl£
;

955 
®loÿ‹_·ge_š_¶ªe_fÜ_u£r_wr™e
((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
Œª§ùiÚ
, 
çl£
);

956 
	gŒª§ùiÚ
->
	gPhysiÿl_add»ss_d‘”mšed
 = 
Œue
;

958  
	gŒue
;

962 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
AÎoÿ‹_add»ss_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
¡d
::
m­
<
LPA_ty³
, 
·ge_¡©us_ty³
>& 
Ía_li¡
, std::
veùÜ
<>& 
¡—dy_¡©e_di¡ributiÚ
)

966 
idx
 = 0;

967 
	g¡d
::
veùÜ
<
LPA_ty³
>**** 
assigÃd_Ías
 = 
Ãw
 
¡d
::veùÜ<LPA_ty³>***[
chªÃl_couÁ
];

968 
	gchªÃl_úŒ
 = 0; chªÃl_úŒ < 
	gchªÃl_couÁ
; channel_cntr++) {

969 
	gassigÃd_Ías
[
chªÃl_úŒ
] = 
Ãw
 
¡d
::
veùÜ
<
LPA_ty³
>**[
ch_no_³r_chªÃl
];

970 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

971 
	gassigÃd_Ías
[
chªÃl_úŒ
][
ch_úŒ
] = 
Ãw
 
¡d
::
veùÜ
<
LPA_ty³
>*[
d›_no_³r_ch
];

972 
	gd›_úŒ
 = 0; d›_úŒ < 
	gd›_no_³r_ch
; die_cntr++) {

973 
	gassigÃd_Ías
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
] = 
Ãw
 
¡d
::
veùÜ
<
LPA_ty³
>[
¶ªe_no_³r_d›
];

979 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
;

980 autØ
	gÍa
 = 
Ía_li¡
.
begš
();†· !ğÍa_li¡.
’d
();) {

981 ià((*
	gÍa
).
	gfœ¡
 >ğ
domašs
[
¡»am_id
]->
TÙ®_logiÿl_·ges_no
) {

982 
PRINT_ERROR
("Ouˆoà¿ngLPA s³cif›d fÜ…»cÚd™iÚšg! LPA shoud bsm®Ë¸thª " << 
domašs
[
¡»am_id
]->
TÙ®_logiÿl_·ges_no
 << ", buˆ™ i " << (*
Ía
).
fœ¡
)

984 
PPA_ty³
 
µa
 = 
domašs
[
¡»am_id
]->
G‘_µa_fÜ_´ecÚd™iÚšg
(¡»am_id, (*
Ía
).
fœ¡
);

985 ià(
	gµa
 !ğ
NO_LPA
) {

986 
PRINT_ERROR
("Calling‡ddress‡llocation for‡…reviously‡llocated LPA during…reconditioning!")

988 
®loÿ‹_¶ªe_fÜ_´ecÚd™iÚšg
(
¡»am_id
, (*
Ía
).
fœ¡
, 
¶ªe_add»ss
);

989 ià(
LPA_ty³
(
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
G‘_sh¬e_of_physcŸl_·ges_š_¶ªe
(
¶ªe_add»ss
.
ChªÃlID
,…ÏÃ_add»ss.
ChID
,…ÏÃ_add»ss.
D›ID
,…ÏÃ_add»ss.
PÏÃID
è* 
·ge_no_³r_¶ªe
)

990 > 
	gassigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
()) {

991 
	gassigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
push_back
((*
Ía
).
fœ¡
);

992 
	gÍa
++;

994 
	gÍa_li¡
.
”a£
(
Ía
++);

1000 
	gchªÃl_úŒ
 = 0; chªÃl_úŒ < 
	gdomašs
[
¡»am_id
]->
	gChªÃl_no
; channel_cntr++) {

1001 
	gch_úŒ
 = 0; ch_úŒ < 
	gdomašs
[
¡»am_id
]->
	gCh_no
; chip_cntr++) {

1002 
	gd›_úŒ
 = 0; d›_úŒ < 
	gdomašs
[
¡»am_id
]->
	gD›_no
; die_cntr++) {

1003 
	g¶ªe_úŒ
 = 0;…ÏÃ_úŒ < 
	gdomašs
[
¡»am_id
]->
	gPÏÃ_no
;…lane_cntr++) {

1004 
	g¶ªe_add»ss
.
	gChªÃlID
 = 
domašs
[
¡»am_id
]->
ChªÃl_ids
[
chªÃl_úŒ
];

1005 
	g¶ªe_add»ss
.
	gChID
 = 
domašs
[
¡»am_id
]->
Ch_ids
[
ch_úŒ
];

1006 
	g¶ªe_add»ss
.
	gD›ID
 = 
domašs
[
¡»am_id
]->
D›_ids
[
d›_úŒ
];

1007 
	g¶ªe_add»ss
.
	gPÏÃID
 = 
domašs
[
¡»am_id
]->
PÏÃ_ids
[
¶ªe_úŒ
];

1009 
	gphysiÿl_block_cÚsum±iÚ_gßl
 = ()((
block_no_³r_¶ªe
 - 
ál
->
GC_ªd_WL_Un™
->
G‘_mšimum_numb”_of_ä“_·ges_befÜe_GC
() / 2)

1010 * 
Uts
::
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
G‘_sh¬e_of_physcŸl_·ges_š_¶ªe
(
¶ªe_add»ss
.
ChªÃlID
,…ÏÃ_add»ss.
ChID
,…ÏÃ_add»ss.
D›ID
,…ÏÃ_add»ss.
PÏÃID
));

1013 
	gmod–_av”age
 = 0;

1014 
	g¡d
::
veùÜ
<> 
adju¡ed_¡—dy_¡©e_di¡ributiÚ
;

1016 
	gi
 = 0; i <ğ
·ges_no_³r_block
; i++) {

1017 
	gmod–_av”age
 +ğ
¡—dy_¡©e_di¡ributiÚ
[
i
] * (iè/ (
·ges_no_³r_block
);

1018 
	gadju¡ed_¡—dy_¡©e_di¡ributiÚ
.
push_back
(
¡—dy_¡©e_di¡ributiÚ
[
i
]);

1020 
	g»®_av”age
 = (
assigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
()è/ (
physiÿl_block_cÚsum±iÚ_gßl
 * 
·ges_no_³r_block
);

1021 ià(
	g¡d
::
abs
(
mod–_av”age
 - 
»®_av”age
è* 
·ges_no_³r_block
 > 0.9999) {

1022 
di¥Ïûm’t_šdex
 = ((
»®_av”age
 - 
mod–_av”age
è* 
·ges_no_³r_block
);

1023 ià(
	gdi¥Ïûm’t_šdex
 > 0) {

1024 
	gi
 = 0; i < 
	gdi¥Ïûm’t_šdex
; i++) {

1025 
	gadju¡ed_¡—dy_¡©e_di¡ributiÚ
[
i
] = 0;

1027 
	gi
 = 
di¥Ïûm’t_šdex
; i < (
	g·ges_no_³r_block
); i++) {

1028 
	gadju¡ed_¡—dy_¡©e_di¡ributiÚ
[
i
] = 
¡—dy_¡©e_di¡ributiÚ
[˜- 
di¥Ïûm’t_šdex
];

1031 
	gdi¥Ïûm’t_šdex
 *= -1;

1032 
	gi
 = 0; i < (
	g·ges_no_³r_block
è- 
	gdi¥Ïûm’t_šdex
; i++) {

1033 
	gadju¡ed_¡—dy_¡©e_di¡ributiÚ
[
i
] = 
¡—dy_¡©e_di¡ributiÚ
[˜+ 
di¥Ïûm’t_šdex
];

1035 
	gi
 = (
·ges_no_³r_block
è- 
di¥Ïûm’t_šdex
; i < (
	g·ges_no_³r_block
); i++) {

1036 
	gadju¡ed_¡—dy_¡©e_di¡ributiÚ
[
i
] = 0;

1042 
	gtÙ®_v®id_·ges
 = 0;

1043 
	gv®id_·ges_š_block
 = 
·ges_no_³r_block
; valid_pages_in_block >= 0; valid_pages_in_block--) {

1044 
	gtÙ®_v®id_·ges
 +ğ
v®id_·ges_š_block
 * ()(
adju¡ed_¡—dy_¡©e_di¡ributiÚ
[v®id_·ges_š_block] * 
physiÿl_block_cÚsum±iÚ_gßl
);

1046 
	g·ges_Ãed_PPA
 = 0;

1047 ià(
	gtÙ®_v®id_·ges
 < 
	gassigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
()) {

1048 
	g·ges_Ãed_PPA
 = ()(
assigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
()è- 
tÙ®_v®id_·ges
;

1051 
	g»maššg_blocks_to_cÚsume
 = 
physiÿl_block_cÚsum±iÚ_gßl
;

1052 
	gv®id_·ges_š_block
 = 
·ges_no_³r_block
; valid_pages_in_block >= 0; valid_pages_in_block--) {

1053 
	gblock_no_w™h_x_v®id_·ge
 = ()(
adju¡ed_¡—dy_¡©e_di¡ributiÚ
[
v®id_·ges_š_block
] * 
physiÿl_block_cÚsum±iÚ_gßl
);

1054 ià(
	gblock_no_w™h_x_v®id_·ge
 > 0 && 
	g·ges_Ãed_PPA
 > 0) {

1055 
	gblock_no_w™h_x_v®id_·ge
 +ğ(
·ges_Ãed_PPA
 / 
v®id_·ges_š_block
) + (pages_need_PPA % valid_pages_in_block == 0 ? 0 : 1);

1056 
	g·ges_Ãed_PPA
 = 0;

1059 ià(
	gblock_no_w™h_x_v®id_·ge
 <ğ
»maššg_blocks_to_cÚsume
) {

1060 
»maššg_blocks_to_cÚsume
 -ğ
block_no_w™h_x_v®id_·ge
;

1062 
	gblock_no_w™h_x_v®id_·ge
 = 
»maššg_blocks_to_cÚsume
;

1063 
	g»maššg_blocks_to_cÚsume
 = 0;

1066 
	gblock_úŒ
 = 0; block_úŒ < 
	gblock_no_w™h_x_v®id_·ge
; block_cntr++) {

1068 
	g¡d
::
veùÜ
<
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
> 
add»s£s
;

1069 ià(
	gassigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
(è< 
	gv®id_·ges_š_block
) {

1070 
	gv®id_·ges_š_block
 = (
assigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
());

1072 
	g·ge_úŒ
 = 0;…age_úŒ < 
	gv®id_·ges_š_block
;…age_cntr++) {

1073 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
addr
(
¶ªe_add»ss
.
ChªÃlID
,…ÏÃ_add»ss.
ChID
,…ÏÃ_add»ss.
D›ID
,…ÏÃ_add»ss.
PÏÃID
, 0, 0);

1074 
	gadd»s£s
.
push_back
(
addr
);

1076 
	gblock_mªag”
->
AÎoÿ‹_Pages_š_block_ªd_šv®id©e_»maššg_fÜ_´ecÚd™iÚšg
(
¡»am_id
, 
¶ªe_add»ss
, 
add»s£s
);

1079 autØcÚ¡ &
	gadd»ss
 : 
add»s£s
) {

1080 
LPA_ty³
 
Ía
 = 
assigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
back
();

1081 
	gassigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
pİ_back
();

1082 
PPA_ty³
 
	gµa
 = 
CÚv”t_add»ss_to_µa
(
add»ss
);

1083 
	gæash_cÚŒŞËr
->
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(&
add»ss
, &
Ía
);

1084 
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
Ía
].
	gPPA
 = 
µa
;

1085 
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
Ía
].
	gWr™‹nS‹B™m­
 = (*
Ía_li¡
.
fšd
Ö·)).
£cÚd
;

1086 
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
Ía
].
	gTimeSmp
 = 0;

1090 ià(
	gassigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
() > 0) {

1091 
PRINT_ERROR
("Iˆi nÙ…ossibËØassigÀPPAØ®ÈLPA š AÎoÿ‹_add»ss_fÜ_´ecÚd™iÚšg! Iˆi nÙ saãØcÚtšu´ecÚd™iÚšg." << 
assigÃd_Ías
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
size
())

1098 
	gchªÃl_úŒ
 = 0; chªÃl_úŒ < 
	gchªÃl_couÁ
; channel_cntr++) {

1099 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

1100 
	gd›_úŒ
 = 0; d›_úŒ < 
	gd›_no_³r_ch
; die_cntr++) {

1101 
	gd–‘e
[] 
	gassigÃd_Ías
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
];

1103 
	gd–‘e
[] 
	gassigÃd_Ías
[
chªÃl_úŒ
][
ch_úŒ
];

1105 
	gd–‘e
[] 
	gassigÃd_Ías
[
chªÃl_úŒ
];

1107 
	gd–‘e
[] 
	gassigÃd_Ías
;

1110 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
AÎoÿ‹_Ãw_·ge_fÜ_gc
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
, 
boŞ
 
is_Œª¦©iÚ_·ge
)

1112 ià(
	gis_Œª¦©iÚ_·ge
) {

1113 
MPPN_ty³
 
	gmµn
 = 
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
Glob®T¿n¦©iÚDœeùÜy
[Œª§ùiÚ->
LPA
].
MPPN
;

1114 ià(
	gmµn
 =ğ
NO_MPPN
) {

1115 
PRINT_ERROR
("Unexpected situation occured for gc write in Allocate_new_page_for_gc function!")

1118 
®loÿ‹_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
Œª§ùiÚ
, (
MVPN_ty³
é¿n§ùiÚ->
LPA
, 
Œue
);

1119 
	gŒª§ùiÚ
->
	gPhysiÿl_add»ss_d‘”mšed
 = 
Œue
;

1121 ià(!
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
M­pšg_’Œy_acûssibË
(
id—l_m­pšg_bË
,¿n§ùiÚ->SŒ—m_id,¿n§ùiÚ->
LPA
)) {

1122 ià(!
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gCMT
->
Check_ä“_¦Ù_avaab™y
()) {

1123 
LPA_ty³
 
	geviùed_Ía
;

1124 
CMTSlÙTy³
 
	geviùedI‹m
 = 
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
CMT
->
Eviù_Úe_¦Ù
(
eviùed_Ía
);

1125 ià(
	geviùedI‹m
.
	gDœty
) {

1130 
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gPPA
 = 
eviùedI‹m
.
PPA
;

1131 
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gWr™‹nS‹B™m­
 = 
eviùedI‹m
.
Wr™‹nS‹B™m­
;

1132 ià(
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 > 
	gCu¼’tTimeSmp
) {

1133 
throw
 
	g¡d
::
logic_”rÜ
("Unexpected situation occured in handling GMT!");

1135 
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

1136 
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(
Œª§ùiÚ
->
SŒ—m_id
, 
eviùed_Ía
);

1139 
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
Ñ¿n§ùiÚ->SŒ—m_id,¿n§ùiÚ->
LPA
);

1140 
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gCMT
->
In£¹_Ãw_m­pšg_šfo
Ñ¿n§ùiÚ->SŒ—m_id,¿n§ùiÚ->
LPA
, 
CÚv”t_add»ss_to_µa
Ñ¿n§ùiÚ->
Add»ss
),¿n§ùiÚ->
wr™e_£ùÜs_b™m­
);

1143 
®loÿ‹_·ge_š_¶ªe_fÜ_u£r_wr™e
(
Œª§ùiÚ
, 
Œue
);

1144 
	gŒª§ùiÚ
->
	gPhysiÿl_add»ss_d‘”mšed
 = 
Œue
;

1147 
¡»am_id_ty³
 
	g¡»am_id
 = 
Œª§ùiÚ
->
SŒ—m_id
;

1148 
	gSts
::
tÙ®_CMT_qu”›s
++;

1149 
	gSts
::
tÙ®_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

1152 ià(
	gdomašs
[
¡»am_id
]->
M­pšg_’Œy_acûssibË
(
id—l_m­pšg_bË
, sŒ—m_id, 
Œª§ùiÚ
->
LPA
)) {

1153 
	gSts
::
CMT_h™s
++;

1154 
	gSts
::
CMT_h™s_³r_¡»am
[
¡»am_id
]++;

1155 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s
++;

1156 
	gSts
::
tÙ®_wr™eTR_CMT_qu”›s_³r_¡»am
[
¡»am_id
]++;

1157 
	gSts
::
wr™eTR_CMT_h™s
++;

1158 
	gSts
::
wr™eTR_CMT_h™s_³r_¡»am
[
¡»am_id
]++;

1159 
	gdomašs
[
¡»am_id
]->
Upd©e_m­pšg_šfo
(
id—l_m­pšg_bË
, sŒ—m_id, 
Œª§ùiÚ
->
LPA
,¿n§ùiÚ->
PPA
,¿n§ùiÚ->
wr™e_£ùÜs_b™m­
);

1161 ià(!
	gdomašs
[
¡»am_id
]->
	gCMT
->
Check_ä“_¦Ù_avaab™y
()) {

1162 
LPA_ty³
 
	geviùed_Ía
;

1163 
CMTSlÙTy³
 
	geviùedI‹m
 = 
domašs
[
¡»am_id
]->
CMT
->
Eviù_Úe_¦Ù
(
eviùed_Ía
);

1164 ià(
	geviùedI‹m
.
	gDœty
) {

1169 
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gPPA
 = 
eviùedI‹m
.
PPA
;

1170 
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gWr™‹nS‹B™m­
 = 
eviùedI‹m
.
Wr™‹nS‹B™m­
;

1171 ià(
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 > 
	gCu¼’tTimeSmp
)

1172 
throw
 
	g¡d
::
logic_”rÜ
("Unexpected situation occured in handling GMT!");

1173 
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

1174 
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(
¡»am_id
, 
eviùed_Ía
);

1177 
	gdomašs
[
¡»am_id
]->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
(¡»am_id, 
Œª§ùiÚ
->
LPA
);

1178 
	gdomašs
[
¡»am_id
]->
	gCMT
->
In£¹_Ãw_m­pšg_šfo
(¡»am_id, 
Œª§ùiÚ
->
LPA
,¿n§ùiÚ->
PPA
,¿n§ùiÚ->
wr™e_£ùÜs_b™m­
);

1183 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
®loÿ‹_¶ªe_fÜ_´ecÚd™iÚšg
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ín
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
rg‘Add»ss
)

1185 
Add»ssM­pšgDomaš
* 
domaš
 = 
domašs
[
¡»am_id
];

1187 
	gdomaš
->
	gPÏÃAÎoÿtiÚScheme
) {

1188 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWDP
:

1189 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1190 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
Ch_no
)];

1191 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1192 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1194 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWPD
:

1195 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1196 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
Ch_no
)];

1197 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1198 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1200 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDWP
:

1201 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1202 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1203 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
D›_no
)];

1204 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1206 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDPW
:

1207 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1208 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1209 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
D›_no
)];

1210 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1212 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPWD
:

1213 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1214 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1215 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1216 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
PÏÃ_no
)];

1218 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPDW
:

1219 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1220 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1221 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1222 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
PÏÃ_no
)];

1225 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCDP
:

1226 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
ChªÃl_no
)];

1227 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1228 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1229 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1231 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCPD
:

1232 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
ChªÃl_no
)];

1233 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1234 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1235 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1237 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDCP
:

1238 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1239 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1240 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
D›_no
)];

1241 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1243 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDPC
:

1244 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1245 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1246 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
D›_no
)];

1247 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1249 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPCD
:

1250 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1251 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1252 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1253 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
PÏÃ_no
)];

1255 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPDC
:

1256 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1257 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1258 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1259 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
PÏÃ_no
)];

1262 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCWP
:

1263 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
ChªÃl_no
)];

1264 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1265 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1266 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1268 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCPW
:

1269 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
ChªÃl_no
)];

1270 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1271 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1272 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1274 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWCP
:

1275 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1276 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
Ch_no
)];

1277 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1278 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1280 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWPC
:

1281 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1282 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
Ch_no
)];

1283 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1284 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1286 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPCW
:

1287 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1288 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1289 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1290 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
PÏÃ_no
)];

1292 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPWC
:

1293 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1294 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1295 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1296 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
PÏÃ_no
)];

1299 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCWD
:

1300 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
ChªÃl_no
)];

1301 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1302 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1303 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1305 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCDW
:

1306 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
ChªÃl_no
)];

1307 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1308 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1309 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1311 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWCD
:

1312 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1313 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
Ch_no
)];

1314 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1315 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1317 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWDC
:

1318 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1319 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
Ch_no
)];

1320 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1321 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1323 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDCW
:

1324 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1325 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1326 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
D›_no
)];

1327 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1329 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDWC
:

1330 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1331 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1332 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
D›_no
)];

1333 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1336 
PRINT_ERROR
("Unknown…lane‡llocation schemeype!")

1340 
Add»ss_M­pšg_Un™_Page_Lev–
::
®loÿ‹_¶ªe_fÜ_u£r_wr™e
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
)

1342 
LPA_ty³
 
Ín
 = 
Œª§ùiÚ
->
LPA
;

1343 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
rg‘Add»ss
 = 
Œª§ùiÚ
->
Add»ss
;

1345 
Add»ssM­pšgDomaš
* 
	gdomaš
 = 
domašs
[
Œª§ùiÚ
->
SŒ—m_id
];

1347 
	gdomaš
->
	gPÏÃAÎoÿtiÚScheme
) {

1348 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWDP
:

1349 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1350 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
Ch_no
)];

1351 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1352 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1354 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWPD
:

1355 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1356 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
Ch_no
)];

1357 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1358 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1360 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDWP
:

1361 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1362 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1363 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
D›_no
)];

1364 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1366 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDPW
:

1367 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1368 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1369 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
D›_no
)];

1370 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1372 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPWD
:

1373 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1374 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1375 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1376 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
PÏÃ_no
)];

1378 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPDW
:

1379 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ín
 % domaš->
ChªÃl_no
)];

1380 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1381 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1382 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
ChªÃl_no
è% domaš->
PÏÃ_no
)];

1385 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCDP
:

1386 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
ChªÃl_no
)];

1387 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1388 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1389 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1391 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCPD
:

1392 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
ChªÃl_no
)];

1393 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1394 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1395 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1397 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDCP
:

1398 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1399 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1400 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
D›_no
)];

1401 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1403 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDPC
:

1404 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1405 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1406 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
D›_no
)];

1407 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1409 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPCD
:

1410 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1411 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1412 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1413 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
PÏÃ_no
)];

1415 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPDC
:

1416 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1417 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ín
 % domaš->
Ch_no
)];

1418 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1419 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
Ch_no
è% domaš->
PÏÃ_no
)];

1422 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCWP
:

1423 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
ChªÃl_no
)];

1424 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1425 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1426 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1428 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCPW
:

1429 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
ChªÃl_no
)];

1430 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1431 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1432 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1434 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWCP
:

1435 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1436 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
Ch_no
)];

1437 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1438 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1440 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWPC
:

1441 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1442 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
Ch_no
)];

1443 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1444 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1446 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPCW
:

1447 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1448 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1449 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1450 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
PÏÃ_no
)];

1452 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPWC
:

1453 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1454 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1455 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ín
 % domaš->
D›_no
)];

1456 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ín
 / domaš->
D›_no
è% domaš->
PÏÃ_no
)];

1459 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCWD
:

1460 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
ChªÃl_no
)];

1461 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1462 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1463 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1465 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCDW
:

1466 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
ChªÃl_no
)];

1467 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1468 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1469 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1471 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWCD
:

1472 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1473 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
Ch_no
)];

1474 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1475 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1477 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWDC
:

1478 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1479 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
Ch_no
)];

1480 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1481 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1483 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDCW
:

1484 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1485 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1486 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
D›_no
)];

1487 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1489 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDWC
:

1490 
rg‘Add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1491 
	grg‘Add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ín
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1492 
	grg‘Add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ín
 / domaš->
PÏÃ_no
è% domaš->
D›_no
)];

1493 
	grg‘Add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ín
 % domaš->
PÏÃ_no
)];

1496 
PRINT_ERROR
("Unknown…lane‡llocation schemeype!")

1500 
Add»ss_M­pšg_Un™_Page_Lev–
::
®loÿ‹_·ge_š_¶ªe_fÜ_u£r_wr™e
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
, 
boŞ
 
is_fÜ_gc
)

1502 
Add»ssM­pšgDomaš
* 
	gdomaš
 = 
domašs
[
Œª§ùiÚ
->
SŒ—m_id
];

1503 
PPA_ty³
 
	gŞd_µa
 = 
domaš
->
G‘_µa
(
id—l_m­pšg_bË
, 
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
LPA
);

1505 ià(
	gŞd_µa
 =ğ
NO_PPA
)

1507 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
addr
;

1508 
CÚv”t_µa_to_add»ss
(
Şd_µa
, 
addr
);

1509 
	gdomaš
->
	g¡¬t_time
.
š£¹
({
Şd_µa
,
Cu¼’tTimeSmp
});

1510 ià(
	gis_fÜ_gc
) {

1511 
PRINT_ERROR
("Unexpected mappingable status in‡llocate_page_in_plane_for_user_write function for‡ GC/WL write!")

1514 ià(
	gis_fÜ_gc
) {

1515 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
addr
;

1516 
CÚv”t_µa_to_add»ss
(
Şd_µa
, 
addr
);

1517 
	gblock_mªag”
->
Inv®id©e_·ge_š_block
(
Œª§ùiÚ
->
SŒ—m_id
, 
addr
);

1518 
·ge_¡©us_ty³
 
	g·ge_¡©us_š_cmt
 = 
domaš
->
G‘_·ge_¡©us
(
id—l_m­pšg_bË
, 
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
LPA
);

1521 ià(
	g·ge_¡©us_š_cmt
 !ğ
Œª§ùiÚ
->
wr™e_£ùÜs_b™m­
)

1522 
PRINT_ERROR
("Unexpected mappingable status in‡llocate_page_in_plane_for_user_write for‡ GC/WL write!")

1524 
·ge_¡©us_ty³
 
	g´ev_·ge_¡©us
 = 
domaš
->
G‘_·ge_¡©us
(
id—l_m­pšg_bË
, 
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
LPA
);

1525 
·ge_¡©us_ty³
 
	g¡©us_š‹r£ùiÚ
 = 
Œª§ùiÚ
->
wr™e_£ùÜs_b™m­
 & 
´ev_·ge_¡©us
;

1527 ià(
	g¡©us_š‹r£ùiÚ
 =ğ
´ev_·ge_¡©us
) {

1528 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
addr
;

1529 
CÚv”t_µa_to_add»ss
(
Şd_µa
, 
addr
);

1532 
	gblock_mªag”
->
Inv®id©e_·ge_š_block
(
Œª§ùiÚ
->
SŒ—m_id
, 
addr
);

1534 
·ge_¡©us_ty³
 
	g»ad_·ges_b™m­
 = 
¡©us_š‹r£ùiÚ
 ^ 
´ev_·ge_¡©us
;

1535 
NVM_T¿n§ùiÚ_FÏsh_RD
 *
	gupd©e_»ad_Œ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_RD(
Œª§ùiÚ
->
Sourû
,¿n§ùiÚ->
SŒ—m_id
,

1536 
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
»ad_·ges_b™m­
è* 
SECTOR_SIZE_IN_BYTE
, 
Œª§ùiÚ
->
LPA
, 
Şd_µa
,¿n§ùiÚ->
U£rIOReque¡
,

1537 
Œª§ùiÚ
->
CÚ‹Á
,¿n§ùiÚ, 
»ad_·ges_b™m­
, 
domaš
->
Glob®M­pšgTabË
[Œª§ùiÚ->
LPA
].
TimeSmp
);

1538 
CÚv”t_µa_to_add»ss
(
Şd_µa
, 
upd©e_»ad_Œ
->
Add»ss
);

1540 
	gblock_mªag”
->
R—d_Œª§ùiÚ_issued
(
upd©e_»ad_Œ
->
Add»ss
);

1541 
	gblock_mªag”
->
Inv®id©e_·ge_š_block
(
Œª§ùiÚ
->
SŒ—m_id
, 
upd©e_»ad_Œ
->
Add»ss
);

1542 
	gŒª§ùiÚ
->
	gR–©edR—d
 = 
upd©e_»ad_Œ
;

1550 ià(
	gis_fÜ_gc
) {

1551 
	gblock_mªag”
->
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_gc_wr™e
(
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
Add»ss
);

1553 
	gblock_mªag”
->
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_u£r_wr™e
(
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
Add»ss
);

1555 
	gŒª§ùiÚ
->
	gPPA
 = 
CÚv”t_add»ss_to_µa
(
Œª§ùiÚ
->
Add»ss
);

1556 
	gdomaš
->
Upd©e_m­pšg_šfo
(
id—l_m­pšg_bË
, 
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
LPA
,¿n§ùiÚ->
PPA
,

1557 ((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
Œª§ùiÚ
)->
wr™e_£ùÜs_b™m­
 | 
domaš
->
G‘_·ge_¡©us
(
id—l_m­pšg_bË
,¿n§ùiÚ->
SŒ—m_id
,¿n§ùiÚ->
LPA
));

1560 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
®loÿ‹_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

1562 
®loÿ‹_¶ªe_fÜ_u£r_wr™e
((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
Œª§ùiÚ
);

1565 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
®loÿ‹_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
, 
MVPN_ty³
 
mv²
, 
boŞ
 
is_fÜ_gc
)

1567 
Add»ssM­pšgDomaš
* 
	gdomaš
 = 
domašs
[
Œª§ùiÚ
->
SŒ—m_id
];

1569 
MPPN_ty³
 
	gŞd_MPPN
 = 
domaš
->
Glob®T¿n¦©iÚDœeùÜy
[
mv²
].
MPPN
;

1571 ià(
	gŞd_MPPN
 =ğ
NO_MPPN
) {

1572 ià(
is_fÜ_gc
) {

1573 
PRINT_ERROR
("Unexpected mappingable status in‡llocate_page_in_plane_for_translation_write for‡ GC/WL write!")

1576 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
´evAddr
;

1577 
CÚv”t_µa_to_add»ss
(
Şd_MPPN
, 
´evAddr
);

1578 
	gblock_mªag”
->
Inv®id©e_·ge_š_block
(
Œª§ùiÚ
->
SŒ—m_id
, 
´evAddr
);

1581 
	gblock_mªag”
->
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
Add»ss
, 
çl£
);

1582 
	gŒª§ùiÚ
->
	gPPA
 = 
CÚv”t_add»ss_to_µa
(
Œª§ùiÚ
->
Add»ss
);

1583 
	gdomaš
->
	gGlob®T¿n¦©iÚDœeùÜy
[
mv²
].
	gMPPN
 = (
MPPN_ty³
)
Œª§ùiÚ
->
PPA
;

1584 
	gdomaš
->
	gGlob®T¿n¦©iÚDœeùÜy
[
mv²
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

1587 
PPA_ty³
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
Úlše_ü—‹_’Œy_fÜ_»ads
(
LPA_ty³
 
Ía
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
»ad_add»ss
, 
ušt64_t
 
»ad_£ùÜs_b™m­
,
boŞ
 
RPG_WR
=
çl£
)

1590 
Add»ssM­pšgDomaš
* 
domaš
 = 
domašs
[
¡»am_id
];

1591 
	gdomaš
->
	gPÏÃAÎoÿtiÚScheme
) {

1593 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWDP
:

1594 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ía
 % domaš->
ChªÃl_no
)];

1595 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / domaš->
ChªÃl_no
è% domaš->
Ch_no
)];

1596 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1597 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1599 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CWPD
:

1600 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ía
 % domaš->
ChªÃl_no
)];

1601 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / domaš->
ChªÃl_no
è% domaš->
Ch_no
)];

1602 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1603 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1605 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDWP
:

1606 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ía
 % domaš->
ChªÃl_no
)];

1607 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1608 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / domaš->
ChªÃl_no
è% domaš->
D›_no
)];

1609 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1611 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CDPW
:

1612 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ía
 % domaš->
ChªÃl_no
)];

1613 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1614 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / domaš->
ChªÃl_no
è% domaš->
D›_no
)];

1615 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1617 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPWD
:

1618 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ía
 % domaš->
ChªÃl_no
)];

1619 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1620 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1621 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / domaš->
ChªÃl_no
è% domaš->
PÏÃ_no
)];

1623 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
CPDW
:

1624 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()(
Ía
 % domaš->
ChªÃl_no
)];

1625 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1626 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1627 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / domaš->
ChªÃl_no
è% domaš->
PÏÃ_no
)];

1630 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCDP
:

1631 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / domaš->
Ch_no
è% domaš->
ChªÃl_no
)];

1632 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ía
 % domaš->
Ch_no
)];

1633 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1634 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1636 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WCPD
:

1637 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / domaš->
Ch_no
è% domaš->
ChªÃl_no
)];

1638 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ía
 % domaš->
Ch_no
)];

1639 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1640 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1642 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDCP
:

1643 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1644 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ía
 % domaš->
Ch_no
)];

1645 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / domaš->
Ch_no
è% domaš->
D›_no
)];

1646 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1648 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WDPC
:

1649 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1650 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ía
 % domaš->
Ch_no
)];

1651 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / domaš->
Ch_no
è% domaš->
D›_no
)];

1652 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
PÏÃ_no
)];

1654 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPCD
:

1655 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1656 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ía
 % domaš->
Ch_no
)];

1657 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1658 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / domaš->
Ch_no
è% domaš->
PÏÃ_no
)];

1660 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
WPDC
:

1661 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1662 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()(
Ía
 % domaš->
Ch_no
)];

1663 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
D›_no
)];

1664 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / domaš->
Ch_no
è% domaš->
PÏÃ_no
)];

1667 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCWP
:

1668 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / domaš->
D›_no
è% domaš->
ChªÃl_no
)];

1669 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1670 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ía
 % domaš->
D›_no
)];

1671 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1673 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DCPW
:

1674 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / domaš->
D›_no
è% domaš->
ChªÃl_no
)];

1675 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1676 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ía
 % domaš->
D›_no
)];

1677 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1679 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWCP
:

1680 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1681 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / domaš->
D›_no
è% domaš->
Ch_no
)];

1682 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ía
 % domaš->
D›_no
)];

1683 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
PÏÃ_no
)];

1685 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DWPC
:

1686 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
Ch_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1687 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / domaš->
D›_no
è% domaš->
Ch_no
)];

1688 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ía
 % domaš->
D›_no
)];

1689 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
PÏÃ_no
)];

1691 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPCW
:

1692 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
ChªÃl_no
)];

1693 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1694 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ía
 % domaš->
D›_no
)];

1695 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / domaš->
D›_no
è% domaš->
PÏÃ_no
)];

1697 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
DPWC
:

1698 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1699 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
D›_no
 * domaš->
PÏÃ_no
)è% domaš->
Ch_no
)];

1700 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()(
Ía
 % domaš->
D›_no
)];

1701 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()((
Ía
 / domaš->
D›_no
è% domaš->
PÏÃ_no
)];

1704 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCWD
:

1705 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / domaš->
PÏÃ_no
è% domaš->
ChªÃl_no
)];

1706 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1707 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1708 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ía
 % domaš->
PÏÃ_no
)];

1710 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PCDW
:

1711 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / domaš->
PÏÃ_no
è% domaš->
ChªÃl_no
)];

1712 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1713 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1714 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ía
 % domaš->
PÏÃ_no
)];

1716 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWCD
:

1717 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1718 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / domaš->
PÏÃ_no
è% domaš->
Ch_no
)];

1719 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
ChªÃl_no
)è% domaš->
D›_no
)];

1720 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ía
 % domaš->
PÏÃ_no
)];

1722 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PWDC
:

1723 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1724 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / domaš->
PÏÃ_no
è% domaš->
Ch_no
)];

1725 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
Ch_no
)è% domaš->
D›_no
)];

1726 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ía
 % domaš->
PÏÃ_no
)];

1728 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDCW
:

1729 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
ChªÃl_no
)];

1730 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
ChªÃl_no
)è% domaš->
Ch_no
)];

1731 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / domaš->
PÏÃ_no
è% domaš->
D›_no
)];

1732 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ía
 % domaš->
PÏÃ_no
)];

1734 
	gFÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
::
PDWC
:

1735 
»ad_add»ss
.
ChªÃlID
 = 
domaš
->
ChªÃl_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
 * domaš->
Ch_no
)è% domaš->
ChªÃl_no
)];

1736 
	g»ad_add»ss
.
	gChID
 = 
domaš
->
Ch_ids
[()((
Ía
 / (domaš->
PÏÃ_no
 * domaš->
D›_no
)è% domaš->
Ch_no
)];

1737 
	g»ad_add»ss
.
	gD›ID
 = 
domaš
->
D›_ids
[()((
Ía
 / domaš->
PÏÃ_no
è% domaš->
D›_no
)];

1738 
	g»ad_add»ss
.
	gPÏÃID
 = 
domaš
->
PÏÃ_ids
[()(
Ía
 % domaš->
PÏÃ_no
)];

1741 
PRINT_ERROR
("Unknown…lane‡llocation schemeype!")

1743 
boŞ
 
RPG_wr™e
=
çl£
;

1744 
	ggrou³
=0;grou³<
	ggroup_no
;groupe++){

1745 if(
g‘_couÁ
(
LPN_TO_UNIQUE_KEY
(
¡»am_id
,
Ía
),
grou³
)!=-1){

1746 
RPG_wr™e
=
Œue
;

1750 if(
	gRPG_WR
){

1751 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
kİ
;

1752 
PageRPGCache
* 
	gp
=
£t1
(
¡»am_id
,
Ía
);

1753 
	gkİ
.
	gChªÃlID
=
p
->
vec
[0];

1754 
	gkİ
.
	gChID
=
p
->
vec
[1];

1755 
	gkİ
.
	gD›ID
=
p
->
vec
[2];

1756 
	gkİ
.
	gPÏÃID
=
p
->
vec
[3];

1757 
	gkİ
.
	gBlockID
=
p
->
vec
[4];

1758 
	gblock_mªag”
->
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_RPG_wr™e
(
¡»am_id
,
kİ
);

1760 
PPA_ty³
 
	gµa
=
CÚv”t_add»ss_to_µa
(
kİ
);

1761 
	gdomaš
->
Upd©e_m­pšg_šfo
(
id—l_m­pšg_bË
, 
¡»am_id
, 
Ía
, 
µa
, 
»ad_£ùÜs_b™m­
);

1762  
	gµa
;

1764 
PPA_ty³
 
	gµa
 = 
CÚv”t_add»ss_to_µa
(
»ad_add»ss
);

1765 
	gdomaš
->
Upd©e_m­pšg_šfo
(
id—l_m­pšg_bË
, 
¡»am_id
, 
Ía
, 
µa
, 
»ad_£ùÜs_b™m­
);

1767  
	gµa
;

1770 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
G‘_d©a_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
, 
PPA_ty³
& 
µa
, 
·ge_¡©us_ty³
& 
·ge_¡©e
)

1772 ià(
	gdomašs
[
¡»am_id
]->
M­pšg_’Œy_acûssibË
(
id—l_m­pšg_bË
, sŒ—m_id, 
Ía
)) {

1773 
	gµa
 = 
domašs
[
¡»am_id
]->
G‘_µa
(
id—l_m­pšg_bË
, sŒ—m_id, 
Ía
);

1774 
	g·ge_¡©e
 = 
domašs
[
¡»am_id
]->
G‘_·ge_¡©us
(
id—l_m­pšg_bË
, sŒ—m_id, 
Ía
);

1776 
	gµa
 = 
domašs
[
¡»am_id
]->
Glob®M­pšgTabË
[
Ía
].
PPA
;

1777 
	g·ge_¡©e
 = 
domašs
[
¡»am_id
]->
Glob®M­pšgTabË
[
Ía
].
Wr™‹nS‹B™m­
;

1781 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
G‘_Œª¦©iÚ_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
MVPN_ty³
 
mv²
, 
MPPN_ty³
& 
mµa
, 
sim_time_ty³
& 
time¡amp
)

1783 
	gmµa
 = 
domašs
[
¡»am_id
]->
Glob®T¿n¦©iÚDœeùÜy
[
mv²
].
MPPN
;

1784 
	gtime¡amp
 = 
domašs
[
¡»am_id
]->
Glob®T¿n¦©iÚDœeùÜy
[
mv²
].
TimeSmp
;

1787 
šlše
 
MVPN_ty³
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
g‘_MVPN
(cÚ¡ 
LPA_ty³
 
Ín
, 
¡»am_id_ty³
 
¡»am_id
)

1790  (
	gMVPN_ty³
)(
	gÍn
 / 
	gno_of_Œª¦©iÚ_’Œ›s_³r_·ge
);

1793 
šlše
 
LPA_ty³
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
g‘_¡¬t_LPN_š_MVP
(cÚ¡ 
MVPN_ty³
 
mv²
)

1795  (
MVPN_ty³
)(
mv²
 * 
no_of_Œª¦©iÚ_’Œ›s_³r_·ge
);

1798 
šlše
 
LPA_ty³
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
g‘_’d_LPN_š_MVP
(cÚ¡ 
MVPN_ty³
 
mv²
)

1800  (
MVPN_ty³
)(
mv²
 * 
no_of_Œª¦©iÚ_’Œ›s_³r_·ge
 +‚o_of_translation_entries_per_page - 1);

1803 
LPA_ty³
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
G‘_logiÿl_·ges_couÁ
(
¡»am_id_ty³
 
¡»am_id
)

1805  
this
->
domašs
[
¡»am_id
]->
TÙ®_logiÿl_·ges_no
;

1808 
šlše
 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
Add»ss_M­pšg_Un™_Page_Lev–
::
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µa
)

1810 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
rg‘
;

1811 
	grg‘
.
	gChªÃlID
 = (
æash_chªÃl_ID_ty³
)(
µa
 / 
·ge_no_³r_chªÃl
);

1812 
	grg‘
.
	gChID
 = (
æash_ch_ID_ty³
)((
µa
 % 
·ge_no_³r_chªÃl
è/ 
·ge_no_³r_ch
);

1813 
	grg‘
.
	gD›ID
 = (
æash_d›_ID_ty³
)(((
µa
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è/ 
·ge_no_³r_d›
);

1814 
	grg‘
.
	gPÏÃID
 = (
æash_¶ªe_ID_ty³
)((((
µa
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è% 
·ge_no_³r_d›
è/ 
·ge_no_³r_¶ªe
);

1815 
	grg‘
.
	gBlockID
 = (
æash_block_ID_ty³
)(((((
µa
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è% 
·ge_no_³r_d›
è% 
·ge_no_³r_¶ªe
è/ 
·ges_no_³r_block
);

1816 
	grg‘
.
	gPageID
 = (
æash_·ge_ID_ty³
)((((((
µa
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è% 
·ge_no_³r_d›
è% 
·ge_no_³r_¶ªe
è% 
·ges_no_³r_block
) %…ages_no_per_block);

1818  
	grg‘
;

1821 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µn
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
)

1825 
boŞ
 
RPG
=
çl£
;

1826 if(
	gRPG
){

1827 
	gidx
=0;

1828 
	gidx
=(
idx
+1)%(
ch_no_³r_chªÃl
*
chªÃl_couÁ
);

1829 
	ggroup
[
idx
%
chªÃl_couÁ
][idx/channel_count];

1834 
	gadd»ss
.
	gChªÃlID
 = (
æash_chªÃl_ID_ty³
)(
µn
 / 
·ge_no_³r_chªÃl
);

1835 
	gadd»ss
.
	gChID
 = (
æash_ch_ID_ty³
)((
µn
 % 
·ge_no_³r_chªÃl
è/ 
·ge_no_³r_ch
);

1836 
	gadd»ss
.
	gD›ID
 = (
æash_d›_ID_ty³
)(((
µn
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è/ 
·ge_no_³r_d›
);

1837 
	gadd»ss
.
	gPÏÃID
 = (
æash_¶ªe_ID_ty³
)((((
µn
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è% 
·ge_no_³r_d›
è/ 
·ge_no_³r_¶ªe
);

1838 
	gadd»ss
.
	gBlockID
 = (
æash_block_ID_ty³
)(((((
µn
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è% 
·ge_no_³r_d›
è% 
·ge_no_³r_¶ªe
è/ 
·ges_no_³r_block
);

1839 
	gadd»ss
.
	gPageID
 = (
æash_·ge_ID_ty³
)((((((
µn
 % 
·ge_no_³r_chªÃl
è% 
·ge_no_³r_ch
è% 
·ge_no_³r_d›
è% 
·ge_no_³r_¶ªe
è% 
·ges_no_³r_block
) %…ages_no_per_block);

1844 
šlše
 
PPA_ty³
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
CÚv”t_add»ss_to_µa
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·geAdd»ss
)

1846  (
PPA_ty³
)
this
->
·ge_no_³r_ch
 * (PPA_ty³)(
·geAdd»ss
.
ChªÃlID
 *his->
ch_no_³r_chªÃl
 +…ageAdd»ss.
ChID
)

1847 + 
this
->
·ge_no_³r_d›
 * 
·geAdd»ss
.
D›ID
 +his->
·ge_no_³r_¶ªe
 *…ageAdd»ss.
PÏÃID


1848 + 
this
->
·ges_no_³r_block
 * 
·geAdd»ss
.
BlockID
 +…ageAdd»ss.
PageID
;

1851 
boŞ
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
»que¡_m­pšg_’Œy
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
)

1853 
Add»ssM­pšgDomaš
* 
	gdomaš
 = 
domašs
[
¡»am_id
];

1854 
MVPN_ty³
 
	gmv²
 = 
g‘_MVPN
(
Ía
, 
¡»am_id
);

1858 ià(
	gdomaš
->
	gGlob®T¿n¦©iÚDœeùÜy
[
mv²
].
	gMPPN
 =ğ
NO_MPPN
) {

1859 ià(!
domaš
->
CMT
->
Check_ä“_¦Ù_avaab™y
()) {

1860 
LPA_ty³
 
eviùed_Ía
;

1861 
CMTSlÙTy³
 
	geviùedI‹m
 = 
domaš
->
CMT
->
Eviù_Úe_¦Ù
(
eviùed_Ía
);

1862 ià(
	geviùedI‹m
.
	gDœty
) {

1867 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gPPA
 = 
eviùedI‹m
.
PPA
;

1868 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gWr™‹nS‹B™m­
 = 
eviùedI‹m
.
Wr™‹nS‹B™m­
;

1869 ià(
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 > 
	gCu¼’tTimeSmp
)

1870 
throw
 
	g¡d
::
logic_”rÜ
("Unexpected situation occurred in handling GMT!");

1871 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

1872 
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(
¡»am_id
, 
eviùed_Ía
);

1875 
	gdomaš
->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
(
¡»am_id
, 
Ía
);

1876 
	gdomaš
->
	gCMT
->
In£¹_Ãw_m­pšg_šfo
(
¡»am_id
, 
Ía
, 
NO_PPA
, 
UNWRITTEN_LOGICAL_PAGE
);

1878  
	gŒue
;

1887 ià(
	gdomaš
->
	gA¼ivšgM­pšgEÁr›s
.
fšd
(
mv²
è!ğ
domaš
->
A¼ivšgM­pšgEÁr›s
.
’d
())

1889 ià(
domaš
->
CMT
->
Is_¦Ù_»£rved_fÜ_Ín_ªd_wa™šg
(
¡»am_id
, 
Ía
)) {

1890  
çl£
;

1892 ià(!
	gdomaš
->
	gCMT
->
Check_ä“_¦Ù_avaab™y
()) {

1893 
LPA_ty³
 
	geviùed_Ía
;

1894 
CMTSlÙTy³
 
	geviùedI‹m
 = 
domaš
->
CMT
->
Eviù_Úe_¦Ù
(
eviùed_Ía
);

1895 ià(
	geviùedI‹m
.
	gDœty
) {

1900 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gPPA
 = 
eviùedI‹m
.
PPA
;

1901 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gWr™‹nS‹B™m­
 = 
eviùedI‹m
.
Wr™‹nS‹B™m­
;

1902 ià(
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 > 
	gCu¼’tTimeSmp
)

1903 
throw
 
	g¡d
::
logic_”rÜ
("Unexpected situation occured in handling GMT!");

1904 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

1905 
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(
¡»am_id
, 
eviùed_Ía
);

1908 
	gdomaš
->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
(
¡»am_id
, 
Ía
);

1909 
	gdomaš
->
	gA¼ivšgM­pšgEÁr›s
.
š£¹
(
¡d
::
·œ
<
MVPN_ty³
, 
LPA_ty³
>(
mv²
, 
Ía
));

1911  
	gçl£
;

1917 ià(
	gdomaš
->
	gD•¬tšgM­pšgEÁr›s
.
fšd
(
mv²
è!ğ
domaš
->
D•¬tšgM­pšgEÁr›s
.
’d
()) {

1918 ià(!
domaš
->
CMT
->
Check_ä“_¦Ù_avaab™y
()) {

1919 
LPA_ty³
 
eviùed_Ía
;

1920 
CMTSlÙTy³
 
	geviùedI‹m
 = 
domaš
->
CMT
->
Eviù_Úe_¦Ù
(
eviùed_Ía
);

1921 ià(
	geviùedI‹m
.
	gDœty
) {

1926 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gPPA
 = 
eviùedI‹m
.
PPA
;

1927 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gWr™‹nS‹B™m­
 = 
eviùedI‹m
.
Wr™‹nS‹B™m­
;

1928 ià(
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 > 
	gCu¼’tTimeSmp
)

1929 
throw
 
	g¡d
::
logic_”rÜ
("Unexpected situation occured in handling GMT!");

1930 
	gdomaš
->
	gGlob®M­pšgTabË
[
Ía
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

1931 
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(
¡»am_id
, 
eviùed_Ía
);

1934 
	gdomaš
->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
(
¡»am_id
, 
Ía
);

1937 
	gdomaš
->
	gCMT
->
In£¹_Ãw_m­pšg_šfo
(
¡»am_id
, 
Ía
,

1938 
domaš
->
Glob®M­pšgTabË
[
Ía
].
PPA
, domaš->Glob®M­pšgTabË[Ía].
Wr™‹nS‹B™m­
);

1940  
	gŒue
;

1944 ià(!
	gdomaš
->
	gCMT
->
Check_ä“_¦Ù_avaab™y
()) {

1945 
LPA_ty³
 
	geviùed_Ía
;

1946 
CMTSlÙTy³
 
	geviùedI‹m
 = 
domaš
->
CMT
->
Eviù_Úe_¦Ù
(
eviùed_Ía
);

1947 ià(
	geviùedI‹m
.
	gDœty
) {

1952 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gPPA
 = 
eviùedI‹m
.
PPA
;

1953 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gWr™‹nS‹B™m­
 = 
eviùedI‹m
.
Wr™‹nS‹B™m­
;

1954 ià(
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 > 
	gCu¼’tTimeSmp
) {

1955 
throw
 
	g¡d
::
logic_”rÜ
("Unexpected situation occured in handling GMT!");

1957 
	gdomaš
->
	gGlob®M­pšgTabË
[
eviùed_Ía
].
	gTimeSmp
 = 
Cu¼’tTimeSmp
;

1958 
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(
¡»am_id
, 
eviùed_Ía
);

1961 
	gdomaš
->
	gCMT
->
Re£rve_¦Ù_fÜ_Ín
(
¡»am_id
, 
Ía
);

1962 
g’”©e_æash_»ad_»que¡_fÜ_m­pšg_d©a
(
¡»am_id
, 
Ía
);

1964  
	gçl£
;

1967 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
)

1969 
MVPN_ty³
 
	gmv²
 = 
g‘_MVPN
(
Ín
, 
¡»am_id
);

1970 ià(
is_mv²_locked_fÜ_gc
(
¡»am_id
, 
mv²
)) {

1971 
mªage_m­pšg_Œª§ùiÚ_çcšg_b¬r›r
(
¡»am_id
, 
mv²
, 
çl£
);

1972 
	gdomašs
[
¡»am_id
]->
	gD•¬tšgM­pšgEÁr›s
.
š£¹
(
g‘_MVPN
(
Ín
, stream_id));

1974 
	gál
->
	gTSU
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

1977 
	g»ad_size
 = 0;

1978 
·ge_¡©us_ty³
 
	g»adSeùÜsB™m­
 = 0;

1979 
LPA_ty³
 
	g¡¬tLPN
 = 
g‘_¡¬t_LPN_š_MVP
(
mv²
);

1980 
LPA_ty³
 
	g’dLPN
 = 
g‘_’d_LPN_š_MVP
(
mv²
);

1981 
LPA_ty³
 
	gÍn_™r
 = 
¡¬tLPN
;†²_™¸<ğ
’dLPN
;†pn_itr++) {

1982 ià(
	gdomašs
[
¡»am_id
]->
	gCMT
->
Exi¡s
(¡»am_id, 
Ín_™r
)) {

1983 ià(
	gdomašs
[
¡»am_id
]->
	gCMT
->
Is_dœty
(¡»am_id, 
Ín_™r
)) {

1984 
	gdomašs
[
¡»am_id
]->
	gCMT
->
Make_ş—n
(¡»am_id, 
Ín_™r
);

1985 
	gdomašs
[
¡»am_id
]->
	gGlob®M­pšgTabË
[
Ín_™r
].
	gPPA
 = 
domašs
[¡»am_id]->
CMT
->
R‘r›ve_µa
(stream_id,†pn_itr);

1987 
·ge_¡©us_ty³
 
	gb™loÿtiÚ
 = ((Õage_¡©us_ty³)0x1è<< (((
Ín_™r
 - 
¡¬tLPN
è* 
GTD_’Œy_size
è/ 
SECTOR_SIZE_IN_BYTE
));

1988 ià((
	g»adSeùÜsB™m­
 & 
	gb™loÿtiÚ
) == 0) {

1989 
»adSeùÜsB™m­
 |ğ
b™loÿtiÚ
;

1990 
	g»ad_size
 +ğ
SECTOR_SIZE_IN_BYTE
;

1997 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	g»adTR
 = 
NULL
;

1998 
MPPN_ty³
 
	gmµn
 = 
domašs
[
¡»am_id
]->
Glob®T¿n¦©iÚDœeùÜy
[
mv²
].
MPPN
;

1999 ià(
	gmµn
 !ğ
NO_MPPN
) {

2000 
»adTR
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
, 
¡»am_id
, 
»ad_size
,

2001 
mv²
, 
mµn
, 
NULL
, mv², NULL, 
»adSeùÜsB™m­
, 
Cu¼’tTimeSmp
);

2002 
CÚv”t_µa_to_add»ss
(
mµn
, 
»adTR
->
Add»ss
);

2003 
	gblock_mªag”
->
R—d_Œª§ùiÚ_issued
(
»adTR
->
Add»ss
);

2004 
	gdomašs
[
¡»am_id
]->
	gA¼ivšgM­pšgEÁr›s
.
š£¹
(
¡d
::
·œ
<
MVPN_ty³
, 
LPA_ty³
>(
mv²
, 
Ín
));

2005 
	gál
->
	gTSU
->
Subm™_Œª§ùiÚ
(
»adTR
);

2008 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	gwr™eTR
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_WR(
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
, 
¡»am_id
, 
SECTOR_SIZE_IN_BYTE
 * 
£ùÜ_no_³r_·ge
,

2009 
mv²
, 
mµn
, 
NULL
, mv², 
»adTR
, (((
·ge_¡©us_ty³
)0x1è<< 
£ùÜ_no_³r_·ge
è- 1, 
Cu¼’tTimeSmp
);

2010 
®loÿ‹_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
wr™eTR
);

2011 
®loÿ‹_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
wr™eTR
, 
mv²
, 
çl£
);

2012 
	gdomašs
[
¡»am_id
]->
	gD•¬tšgM­pšgEÁr›s
.
š£¹
(
g‘_MVPN
(
Ín
, stream_id));

2013 
	gál
->
	gTSU
->
Subm™_Œª§ùiÚ
(
wr™eTR
);

2015 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg
++;

2016 
	gSts
::
TÙ®_æash_wr™es_fÜ_m­pšg
++;

2017 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg_³r_¡»am
[
¡»am_id
]++;

2018 
	gSts
::
TÙ®_æash_wr™es_fÜ_m­pšg_³r_¡»am
[
¡»am_id
]++;

2020 
	gál
->
	gTSU
->
ScheduË
();

2024 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
g’”©e_æash_»ad_»que¡_fÜ_m­pšg_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
)

2026 
MVPN_ty³
 
	gmv²
 = 
g‘_MVPN
(
Ín
, 
¡»am_id
);

2028 ià(
	gmv²
 >ğ
domašs
[
¡»am_id
]->
TÙ®_Œª¦©iÚ_·ges_no
) {

2029 
PRINT_ERROR
("Out of„ange virtualranslation…age‚umber!")

2032 
domašs
[
¡»am_id
]->
A¼ivšgM­pšgEÁr›s
.
š£¹
(
¡d
::
·œ
<
MVPN_ty³
, 
LPA_ty³
>(
mv²
, 
Ín
));

2034 ià(
is_mv²_locked_fÜ_gc
(
¡»am_id
, 
mv²
)) {

2035 
mªage_m­pšg_Œª§ùiÚ_çcšg_b¬r›r
(
¡»am_id
, 
mv²
, 
Œue
);

2037 
	gál
->
	gTSU
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

2039 
PPA_ty³
 
	gµn
 = 
domašs
[
¡»am_id
]->
Glob®T¿n¦©iÚDœeùÜy
[
mv²
].
MPPN
;

2041 ià(
	gµn
 =ğ
NO_MPPN
){

2042 
PRINT_ERROR
("Reading‡n invalid…hysical flash…age‡ddress in function generate_flash_read_request_for_mapping_data!")

2045 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
»adTR
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_RD(
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
, 
¡»am_id
,

2046 
SECTOR_SIZE_IN_BYTE
, 
NO_LPA
, 
NO_PPA
, 
NULL
, 
mv²
, ((
·ge_¡©us_ty³
)0x1è<< 
£ùÜ_no_³r_·ge
, 
Cu¼’tTimeSmp
);

2047 
CÚv”t_µa_to_add»ss
(
µn
, 
»adTR
->
Add»ss
);

2048 
	gblock_mªag”
->
R—d_Œª§ùiÚ_issued
(
»adTR
->
Add»ss
);

2049 
	g»adTR
->
	gPPA
 = 
µn
;

2050 
	gál
->
	gTSU
->
Subm™_Œª§ùiÚ
(
»adTR
);

2052 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg
++;

2053 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg_³r_¡»am
[
¡»am_id
]++;

2055 
	gál
->
	gTSU
->
ScheduË
();

2059 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

2062 ià(
Œª§ùiÚ
->
Sourû
 !ğ
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
) {

2066 ià(
	g_my_š¡ªû
->
	gid—l_m­pšg_bË
){

2067 
throw
 
	g¡d
::
logic_”rÜ
("There should‚ot be‡ny flash„ead/write when ideal mapping isƒnabled!");

2070 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
WRITE
) {

2071 
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
D•¬tšgM­pšgEÁr›s
.
”a£
((
MVPN_ty³
)((
NVM_T¿n§ùiÚ_FÏsh_WR
*é¿n§ùiÚ)->
CÚ‹Á
);

2075 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gR–©edWr™e
 !ğ
NULL
) {

2076 ((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
->
R–©edR—d
 = 
NULL
;

2079 
	g_my_š¡ªû
->
	gál
->
	gTSU
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

2080 
MVPN_ty³
 
	gmv²
 = (MVPN_ty³)((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
CÚ‹Á
;

2081 
	g¡d
::
muÉim­
<
MVPN_ty³
, 
	gLPA_ty³
>::
™”©Ü
 
™
 = 
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
A¼ivšgM­pšgEÁr›s
.
fšd
(
mv²
);

2082 
	g™
 !ğ
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
A¼ivšgM­pšgEÁr›s
.
’d
()) {

2083 ià((*
™
).
fœ¡
 =ğ
mv²
) {

2084 
LPA_ty³
 
Ía
 = (*
™
).
£cÚd
;

2088 ià(
	g_my_š¡ªû
->
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gCMT
->
Is_¦Ù_»£rved_fÜ_Ín_ªd_wa™šg
Ñ¿n§ùiÚ->SŒ—m_id, 
Ía
)) {

2089 
	g_my_š¡ªû
->
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gCMT
->
In£¹_Ãw_m­pšg_šfo
Ñ¿n§ùiÚ->SŒ—m_id, 
Ía
,

2090 
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
Glob®M­pšgTabË
[
Ía
].
PPA
,

2091 
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
Glob®M­pšgTabË
[
Ía
].
Wr™‹nS‹B™m­
);

2092 autØ
	g™2
 = 
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
Wa™šg_unm­³d_»ad_Œª§ùiÚs
.
fšd
(
Ía
);

2093 
	g™2
 !ğ
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
Wa™šg_unm­³d_»ad_Œª§ùiÚs
.
’d
() &&

2094 (*
™2
).
fœ¡
 =ğ
Ía
) {

2095 ià(
_my_š¡ªû
->
is_Ía_locked_fÜ_gc
(
Œª§ùiÚ
->
SŒ—m_id
, 
Ía
)) {

2096 
_my_š¡ªû
->
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
(
™2
->
£cÚd
);

2098 ià(
	g_my_š¡ªû
->
Œª¦©e_Ía_to_µa
(
Œª§ùiÚ
->
SŒ—m_id
, 
™2
->
£cÚd
)) {

2099 
	g_my_š¡ªû
->
	gál
->
	gTSU
->
Subm™_Œª§ùiÚ
(
™2
->
£cÚd
);

2102 
	g_my_š¡ªû
->
mªge_unsucûssful_Œª¦©iÚ
(
™2
->
£cÚd
);

2105 
	g_my_š¡ªû
->
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gWa™šg_unm­³d_»ad_Œª§ùiÚs
.
”a£
(
™2
++);

2107 
	g™2
 = 
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
Wa™šg_unm­³d_´og¿m_Œª§ùiÚs
.
fšd
(
Ía
);

2108 
	g™2
 !ğ
_my_š¡ªû
->
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
Wa™šg_unm­³d_´og¿m_Œª§ùiÚs
.
’d
() &&

2109 (*
™2
).
fœ¡
 =ğ
Ía
) {

2110 ià(
_my_š¡ªû
->
is_Ía_locked_fÜ_gc
(
Œª§ùiÚ
->
SŒ—m_id
, 
Ía
)) {

2111 
_my_š¡ªû
->
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
(
™2
->
£cÚd
);

2113 ià(
	g_my_š¡ªû
->
Œª¦©e_Ía_to_µa
(
Œª§ùiÚ
->
SŒ—m_id
, 
™2
->
£cÚd
)) {

2114 
	g_my_š¡ªû
->
	gál
->
	gTSU
->
Subm™_Œª§ùiÚ
(
™2
->
£cÚd
);

2115 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_WR
*)
	g™2
->
	g£cÚd
)->
	gR–©edR—d
 !ğ
NULL
) {

2116 
_my_š¡ªû
->
ál
->
TSU
->
Subm™_Œª§ùiÚ
(((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
™2
->
£cÚd
)->
R–©edR—d
);

2119 
	g_my_š¡ªû
->
mªge_unsucûssful_Œª¦©iÚ
(
™2
->
£cÚd
);

2122 
	g_my_š¡ªû
->
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gWa™šg_unm­³d_´og¿m_Œª§ùiÚs
.
”a£
(
™2
++);

2128 
	g_my_š¡ªû
->
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gA¼ivšgM­pšgEÁr›s
.
”a£
(
™
++);

2130 
	g_my_š¡ªû
->
	gál
->
	gTSU
->
ScheduË
();

2134 
šlše
 
boŞ
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
is_Ía_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
)

2136  
	gdomašs
[
¡»am_id
]->
	gLocked_LPAs
.
fšd
(
Ía
è!ğ
domašs
[¡»am_id]->
Locked_LPAs
.
’d
();

2139 
šlše
 
boŞ
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
is_mv²_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
)

2141  
	gdomašs
[
¡»am_id
]->
	gLocked_MVPNs
.
fšd
(
mv²
è!ğ
domašs
[¡»am_id]->
Locked_MVPNs
.
’d
();

2144 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
S‘_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
)

2146 autØ
	g™r
 = 
domašs
[
¡»am_id
]->
Locked_LPAs
.
fšd
(
Ía
);

2147 ià(
	g™r
 !ğ
domašs
[
¡»am_id
]->
Locked_LPAs
.
’d
()) {

2148 
PRINT_ERROR
("Illegal operation: Locking‡n LPAhat has‡lready been†ocked!");

2150 
	gdomašs
[
¡»am_id
]->
	gLocked_LPAs
.
š£¹
(
Ía
);

2153 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
S‘_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
)

2155 autØ
	g™r
 = 
domašs
[
¡»am_id
]->
Locked_MVPNs
.
fšd
(
mv²
);

2156 ià(
	g™r
 !ğ
domašs
[
¡»am_id
]->
Locked_MVPNs
.
’d
()) {

2157 
PRINT_ERROR
("Illegal operation: Locking‡n MVPNhat has‡lready been†ocked!");

2159 
	gdomašs
[
¡»am_id
]->
	gLocked_MVPNs
.
š£¹
(
mv²
);

2162 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
S‘_b¬r›r_fÜ_acûssšg_physiÿl_block
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
)

2165 
Block_PoŞ_SlÙ_Ty³
* 
block
 = &(
block_mªag”
->
¶ªe_mªag”
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
].
Blocks
[block_add»ss.
BlockID
]);

2166 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
addr
(
block_add»ss
);

2167 
æash_·ge_ID_ty³
 
	g·geID
 = 0;…ageID < 
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
;…ageID++) {

2168 ià(
	gblock_mªag”
->
Is_·ge_v®id
(
block
, 
·geID
)) {

2169 
	gaddr
.
	gPageID
 = 
·geID
;

2170 ià(
	gblock
->
	gHŞds_m­pšg_d©a
) {

2171 
MVPN_ty³
 
	gmpvn
 = (MVPN_ty³)
æash_cÚŒŞËr
->
G‘_m‘ad©a
(
addr
.
ChªÃlID
,‡ddr.
ChID
,‡ddr.
D›ID
,‡ddr.
PÏÃID
,‡ddr.
BlockID
,‡ddr.
PageID
);

2172 ià(
	gdomašs
[
block
->
SŒ—m_id
]->
	gGlob®T¿n¦©iÚDœeùÜy
[
mpvn
].
	gMPPN
 !ğ
CÚv”t_add»ss_to_µa
(
addr
)) {

2173 
PRINT_ERROR
("Inconsistency inhe globalranslation directory when†ocking‡n MPVN!")

2174 
S‘_b¬r›r_fÜ_acûssšg_mv²
(
block
->
SŒ—m_id
, 
mpvn
);

2177 
LPA_ty³
 
	gÍa
 = 
æash_cÚŒŞËr
->
G‘_m‘ad©a
(
addr
.
ChªÃlID
,‡ddr.
ChID
,‡ddr.
D›ID
,‡ddr.
PÏÃID
,‡ddr.
BlockID
,‡ddr.
PageID
);

2178 
LPA_ty³
 
	gµa
 = 
domašs
[
block
->
SŒ—m_id
]->
Glob®M­pšgTabË
[
Ía
].
PPA
;

2179 ià(
	gdomašs
[
block
->
SŒ—m_id
]->
	gCMT
->
Exi¡s
(block->SŒ—m_id, 
Ía
)) {

2180 
	gµa
 = 
domašs
[
block
->
SŒ—m_id
]->
CMT
->
R‘r›ve_µa
(block->SŒ—m_id, 
Ía
);

2182 ià(
	gµa
 !ğ
CÚv”t_add»ss_to_µa
(
addr
)) {

2183 
PRINT_ERROR
("Inconsistency inhe global mappingable when†ocking‡n LPA!")

2185 
S‘_b¬r›r_fÜ_acûssšg_Ía
(
block
->
SŒ—m_id
, 
Ía
);

2191 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
Remove_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
)

2193 autØ
	g™r
 = 
domašs
[
¡»am_id
]->
Locked_LPAs
.
fšd
(
Ía
);

2194 ià(
	g™r
 =ğ
domašs
[
¡»am_id
]->
Locked_LPAs
.
’d
()) {

2195 
PRINT_ERROR
("Illegal operation: Unlocking‡n LPAhat has‚ot been†ocked!");

2197 
	gdomašs
[
¡»am_id
]->
	gLocked_LPAs
.
”a£
(
™r
);

2200 autØ
	g»ad_Œ
 = 
domašs
[
¡»am_id
]->
R—d_Œª§ùiÚs_behšd_LPA_b¬r›r
.
fšd
(
Ía
);

2201 
	g»ad_Œ
 !ğ
domašs
[
¡»am_id
]->
R—d_Œª§ùiÚs_behšd_LPA_b¬r›r
.
’d
()) {

2202 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
((*
»ad_Œ
).
£cÚd
);

2203 
d–‘e
 (*
»ad_Œ
).
	g£cÚd
;

2204 
	gdomašs
[
¡»am_id
]->
	gR—d_Œª§ùiÚs_behšd_LPA_b¬r›r
.
”a£
(
»ad_Œ
);

2205 
	g»ad_Œ
 = 
domašs
[
¡»am_id
]->
R—d_Œª§ùiÚs_behšd_LPA_b¬r›r
.
fšd
(
Ía
);

2209 autØ
	gwr™e_Œ
 = 
domašs
[
¡»am_id
]->
Wr™e_Œª§ùiÚs_behšd_LPA_b¬r›r
.
fšd
(
Ía
);

2210 
	gwr™e_Œ
 !ğ
domašs
[
¡»am_id
]->
Wr™e_Œª§ùiÚs_behšd_LPA_b¬r›r
.
’d
()) {

2211 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
((*
wr™e_Œ
).
£cÚd
);

2212 
d–‘e
 (*
wr™e_Œ
).
	g£cÚd
;

2213 
	gdomašs
[
¡»am_id
]->
	gWr™e_Œª§ùiÚs_behšd_LPA_b¬r›r
.
”a£
(
wr™e_Œ
);

2214 
	gwr™e_Œ
 = 
domašs
[
¡»am_id
]->
Wr™e_Œª§ùiÚs_behšd_LPA_b¬r›r
.
fšd
(
Ía
);

2218 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
Remove_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
)

2220 autØ
	g™r
 = 
domašs
[
¡»am_id
]->
Locked_MVPNs
.
fšd
(
mv²
);

2221 ià(
	g™r
 =ğ
domašs
[
¡»am_id
]->
Locked_MVPNs
.
’d
()) {

2222 
PRINT_ERROR
("Illegal operation: Unlocking‡n MVPNhat has‚ot been†ocked!");

2224 
	gdomašs
[
¡»am_id
]->
	gLocked_MVPNs
.
”a£
(
™r
);

2227 ià(
	gdomašs
[
¡»am_id
]->
	gMVPN_»ad_Œª§ùiÚs_wa™šg_behšd_b¬r›r
.
fšd
(
mv²
è!ğ
domašs
[¡»am_id]->
MVPN_»ad_Œª§ùiÚs_wa™šg_behšd_b¬r›r
.
’d
()) {

2228 
domašs
[
¡»am_id
]->
MVPN_»ad_Œª§ùiÚs_wa™šg_behšd_b¬r›r
.
”a£
(
mv²
);

2229 
PPA_ty³
 
	gµn
 = 
domašs
[
¡»am_id
]->
Glob®T¿n¦©iÚDœeùÜy
[
mv²
].
MPPN
;

2230 ià(
	gµn
 =ğ
NO_MPPN
) {

2231 
PRINT_ERROR
("Reading‡n invalid…hysical flash…age‡ddress in function generate_flash_read_request_for_mapping_data!")

2234 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
»adTR
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_RD(
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
, 
¡»am_id
,

2235 
SECTOR_SIZE_IN_BYTE
, 
NO_LPA
, 
NO_PPA
, 
NULL
, 
mv²
, ((
·ge_¡©us_ty³
)0x1è<< 
£ùÜ_no_³r_·ge
, 
Cu¼’tTimeSmp
);

2236 
CÚv”t_µa_to_add»ss
(
µn
, 
»adTR
->
Add»ss
);

2237 
	g»adTR
->
	gPPA
 = 
µn
;

2238 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg
++;

2239 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg_³r_¡»am
[
¡»am_id
]++;

2241 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
»adTR
);

2243 
d–‘e
 
	g»adTR
;

2247 ià(
	gdomašs
[
¡»am_id
]->
	gMVPN_wr™e_Œª§ùiÚ_wa™šg_behšd_b¬r›r
.
fšd
(
mv²
è!ğ
domašs
[¡»am_id]->
MVPN_wr™e_Œª§ùiÚ_wa™šg_behšd_b¬r›r
.
’d
()) {

2248 
domašs
[
¡»am_id
]->
MVPN_wr™e_Œª§ùiÚ_wa™šg_behšd_b¬r›r
.
”a£
(
mv²
);

2250 
	g»ad_size
 = 0;

2251 
·ge_¡©us_ty³
 
	g»adSeùÜsB™m­
 = 0;

2252 
LPA_ty³
 
	g¡¬t_Ín
 = 
g‘_¡¬t_LPN_š_MVP
(
mv²
);

2253 
LPA_ty³
 
	g’d_Ín
 = 
g‘_’d_LPN_š_MVP
(
mv²
);

2254 
LPA_ty³
 
	gÍn_™r
 = 
¡¬t_Ín
;†²_™¸<ğ
’d_Ín
;†pn_itr++) {

2255 ià(
	gdomašs
[
¡»am_id
]->
	gCMT
->
Exi¡s
(¡»am_id, 
Ín_™r
)) {

2256 ià(
	gdomašs
[
¡»am_id
]->
	gCMT
->
Is_dœty
(¡»am_id, 
Ín_™r
)) {

2257 
	gdomašs
[
¡»am_id
]->
	gCMT
->
Make_ş—n
(¡»am_id, 
Ín_™r
);

2259 
·ge_¡©us_ty³
 
	gb™loÿtiÚ
 = ((Õage_¡©us_ty³)0x1è<< (((
Ín_™r
 - 
¡¬t_Ín
è* 
GTD_’Œy_size
è/ 
SECTOR_SIZE_IN_BYTE
));

2260 ià((
	g»adSeùÜsB™m­
 & 
	gb™loÿtiÚ
) == 0) {

2261 
»adSeùÜsB™m­
 |ğ
b™loÿtiÚ
;

2262 
	g»ad_size
 +ğ
SECTOR_SIZE_IN_BYTE
;

2269 
MPPN_ty³
 
	gmµn
 = 
domašs
[
¡»am_id
]->
Glob®T¿n¦©iÚDœeùÜy
[
mv²
].
MPPN
;

2270 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	gwr™eTR
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_WR(
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
, 
¡»am_id
, 
SECTOR_SIZE_IN_BYTE
 * 
£ùÜ_no_³r_·ge
,

2271 
mv²
, 
mµn
, 
NULL
, mv², NULL, (((
·ge_¡©us_ty³
)0x1è<< 
£ùÜ_no_³r_·ge
è- 1, 
Cu¼’tTimeSmp
);

2273 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg
++;

2274 
	gSts
::
TÙ®_æash_wr™es_fÜ_m­pšg
++;

2275 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg_³r_¡»am
[
¡»am_id
]++;

2276 
	gSts
::
TÙ®_æash_wr™es_fÜ_m­pšg_³r_¡»am
[
¡»am_id
]++;

2278 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
wr™eTR
);

2280 
d–‘e
 
	gwr™eTR
;

2284 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

2286 
¡d
::
·œ
<
LPA_ty³
, 
	gNVM_T¿n§ùiÚ_FÏsh
*> 
’Œy
(
Œª§ùiÚ
->
LPA
,ransaction);

2287 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
READ
) {

2288 
domašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
R—d_Œª§ùiÚs_behšd_LPA_b¬r›r
.
š£¹
(
’Œy
);

2290 
	gdomašs
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gWr™e_Œª§ùiÚs_behšd_LPA_b¬r›r
.
š£¹
(
’Œy
);

2294 
šlše
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
mªage_m­pšg_Œª§ùiÚ_çcšg_b¬r›r
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
, 
boŞ
 
»ad
)

2296 ià(
	g»ad
) {

2297 
	gdomašs
[
¡»am_id
]->
	gMVPN_»ad_Œª§ùiÚs_wa™šg_behšd_b¬r›r
.
š£¹
(
mv²
);

2299 
	gdomašs
[
¡»am_id
]->
	gMVPN_wr™e_Œª§ùiÚ_wa™šg_behšd_b¬r›r
.
š£¹
(
mv²
);

2303 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
mªge_unsucûssful_Œª¦©iÚ
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

2306 
Wr™e_Œª§ùiÚs_fÜ_ov”fuÎ_¶ªes
[
Œª§ùiÚ
->
Add»ss
.
ChªÃlID
][Œª§ùiÚ->Add»ss.
ChID
][Œª§ùiÚ->Add»ss.
D›ID
][Œª§ùiÚ->Add»ss.
PÏÃID
].
š£¹
((
NVM_T¿n§ùiÚ_FÏsh_WR
*)transaction);

2309 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
S¹_£rvicšg_wr™es_fÜ_ov”fuÎ_¶ªe
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
)

2311 
¡d
::
£t
<
NVM_T¿n§ùiÚ_FÏsh_WR
*>& 
wa™šg_wr™e_li¡
 = 
Wr™e_Œª§ùiÚs_fÜ_ov”fuÎ_¶ªes
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
];

2313 
	gál
->
	gTSU
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

2314 autØ
	g´og¿m
 = 
wa™šg_wr™e_li¡
.
begš
();

2315 
	g´og¿m
 !ğ
wa™šg_wr™e_li¡
.
’d
()) {

2316 ià(
Œª¦©e_Ía_to_µa
((*
´og¿m
)->
SŒ—m_id
, *program)) {

2317 
ál
->
TSU
->
Subm™_Œª§ùiÚ
(*
´og¿m
);

2318 ià((*
	g´og¿m
)->
	gR–©edR—d
 !ğ
NULL
) {

2319 
ál
->
TSU
->
Subm™_Œª§ùiÚ
((*
´og¿m
)->
R–©edR—d
);

2321 
	gwa™šg_wr™e_li¡
.
”a£
(
´og¿m
++);

2327 
	gál
->
	gTSU
->
ScheduË
();

2329 
	gSSD_CompÚ’ts
::
Add»ss_M­pšg_Un™_Page_Lev–
::
£nd_to_amu
(
sim_time_ty³
 
Œx_time
,
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
Add»ss
,
¡»am_id_ty³
 
SŒ—m_id
)

2331 
PPA_ty³
 
	gµa
=
CÚv”t_add»ss_to_µa
(
Add»ss
);

2333 (
	gdomašs
[
SŒ—m_id
]->
	gpv_aw¬e_time
).
š£¹
({
µa
,
Œx_time
});

2336 
	g¡d
::
m­
<
PPA_ty³
,
	gsim_time_ty³
> 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
pv_upd©e_d©a
()

2339 
¡d
::
m­
<
PPA_ty³
,
	gsim_time_ty³
> 
	g»suÉ
;

2340 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
Add»ss
;

2341 
	g¡d
::
muÉim­
<
PPA_ty³
,
	gsim_time_ty³
>::
™”©Ü
 
™
;

2342 autØ
	g¡»am_id
=0;¡»am_id<(
	gdomašs
)/(domains[0]);stream_id++)

2345 
	g™
=
domašs
[
¡»am_id
]->
pv_aw¬e_time
.
begš
();™!=domašs[¡»am_id]->pv_aw¬e_time.
’d
();it++)

2348 if(
	g»suÉ
.
fšd
((*
™
).
fœ¡
)==
»suÉ
.
’d
())

2350 autØ
eq_·œ
=(
domašs
[
¡»am_id
]->
pv_aw¬e_time
).
equ®_¿nge
(
™
->
fœ¡
);

2351 
ušt64_t
 
	gsum_time
=0;

2352 
	gno
=0;

2353 autØ
	gi
=
eq_·œ
.
fœ¡
;i!óq_·œ.
£cÚd
;i++)

2355 
	gsum_time
+=
i
->
£cÚd
;

2356 
	gno
++;

2359 
	g»suÉ
.
š£¹
({
™
->
fœ¡
,(
sim_time_ty³
)(
sum_time
/
no
)});

2363  
	g»suÉ
;

2367 
	gAdd»ss_M­pšg_Un™_Page_Lev–
::
´št_pv_aw¬e_d©a
(
¡d
::
¡ršg
 
¡r
){

2369 autØ
»suÉ
=
pv_upd©e_d©a
();

2371 autØ
	gi
=
»suÉ
.
begš
();i!ôesuÉ.
’d
();i++)

2373 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
Add»ss
;

2374 
CÚv”t_µa_to_add»ss
(
i
->
fœ¡
,
Add»ss
);

	@src/ssd/Address_Mapping_Unit_Page_Level.h

1 #iâdeà
ADDRESS_MAPPING_UNIT_PAGE_LEVEL


2 
	#ADDRESS_MAPPING_UNIT_PAGE_LEVEL


	)

3 #´agm¨
Úû


4 
	~<unÜd”ed_m­
>

5 
	~<m­
>

6 
	~<queue
>

7 
	~<£t
>

8 
	~<li¡
>

9 
	~<veùÜ
>

10 
	~<®gÜ™hm
>

11 
	~"Add»ss_M­pšg_Un™_Ba£.h
"

12 
	~"FÏsh_Block_Mªag”_Ba£.h
"

13 
	~"SSD_Defs.h
"

14 
	~"NVM_T¿n§ùiÚ_FÏsh_RD.h
"

15 
	~"NVM_T¿n§ùiÚ_FÏsh_WR.h
"

16 
	~<io¡»am
>

17 
	~"../nvm_ch/æash_memÜy/Physiÿl_Page_Add»ss.h
"

18 
	~<™”©Ü
>

19 
	#NEWCODE


	)

20 
	~"../uts/RªdomG’”©Ü.h
"

22 
	#ENDCODE


	)

39 
Çme¥aû
 
	gSSD_CompÚ’ts


41 
	#MAKE_TABLE_INDEX
(
LPN
,
STREAM
)

	)

43 şas 
	cCMTEÁryStus
 {
	gFREE
, 
	gWAITING
, 
	gVALID
};

48 
	sGTDEÁryTy³


52 
MPPN_ty³
 
	gMPPN
;

53 
d©a_time¡amp_ty³
 
	gTimeSmp
;

56 şas 
	cPageRPGCache
{

57 
	gpublic
:

58 
¡d
::
veùÜ
<> 
vec
;

59 
	gcouÁ
;

60 
PageRPGCache
(
¡d
::
veùÜ
<> 
v
,
út
);

62 
	sCMTSlÙTy³


64 
PPA_ty³
 
	gPPA
;

65 
	gWr™‹nS‹B™m­
;

66 
boŞ
 
	gDœty
;

67 
CMTEÁryStus
 
	gStus
;

68 
	g¡d
::
li¡
<
¡d
::
·œ
<
LPA_ty³
, 
	gCMTSlÙTy³
*>>::
™”©Ü
 
li¡PŒ
;

69 
¡»am_id_ty³
 
	gSŒ—m_id
;

72 
	sGMTEÁryTy³


74 
PPA_ty³
 
	gPPA
;

75 
boŞ
 
	gisRPG
=
çl£
;

76 
ušt64_t
 
	gWr™‹nS‹B™m­
;

77 
d©a_time¡amp_ty³
 
	gTimeSmp
;

80 şas 
	cCached_M­pšg_TabË


82 
	gpublic
:

83 
Cached_M­pšg_TabË
(
ÿ·c™y
);

84 ~
Cached_M­pšg_TabË
();

85 
boŞ
 
Exi¡s
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
);

86 
PPA_ty³
 
R‘r›ve_µa
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
);

87 
Upd©e_m­pšg_šfo
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
, cÚ¡ 
PPA_ty³
 
µa
, cÚ¡ 
·ge_¡©us_ty³
 
·geWr™eS‹
);

88 
In£¹_Ãw_m­pšg_šfo
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
, cÚ¡ 
PPA_ty³
 
µa
, cÚ¡ 
·geWr™eS‹
);

89 
·ge_¡©us_ty³
 
G‘_b™m­_veùÜ_of_wr™‹n_£ùÜs
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
);

91 
boŞ
 
Is_¦Ù_»£rved_fÜ_Ín_ªd_wa™šg
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
);

92 
boŞ
 
Check_ä“_¦Ù_avaab™y
();

93 
Re£rve_¦Ù_fÜ_Ín
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
);

94 
CMTSlÙTy³
 
Eviù_Úe_¦Ù
(
LPA_ty³
& 
Ía
);

96 
boŞ
 
Is_dœty
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
);

97 
Make_ş—n
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ía
);

98 
	g´iv©e
:

99 
¡d
::
unÜd”ed_m­
<
LPA_ty³
, 
	gCMTSlÙTy³
*> 
	gadd»ssM­
;

100 
	g¡d
::
li¡
<
¡d
::
·œ
<
LPA_ty³
, 
	gCMTSlÙTy³
*>> 
	gÌuLi¡
;

101 
	gÿ·c™y
;

109 şas 
	cAdd»ssM­pšgDomaš


111 
	gpublic
:

112 
Add»ssM­pšgDomaš
(
cmt_ÿ·c™y
, 
cmt_’Œy_size
, 
no_of_Œª¦©iÚ_’Œ›s_³r_·ge
,

113 
Cached_M­pšg_TabË
* 
CMT
,

114 
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
 
PÏÃAÎoÿtiÚScheme
,

115 
æash_chªÃl_ID_ty³
* 
chªÃl_ids
, 
chªÃl_no
, 
æash_ch_ID_ty³
* 
ch_ids
, 
ch_no
,

116 
æash_d›_ID_ty³
* 
d›_ids
, 
d›_no
, 
æash_¶ªe_ID_ty³
* 
¶ªe_ids
, 
¶ªe_no
,

117 
PPA_ty³
 
tÙ®_physiÿl_£ùÜs_no
, 
LHA_ty³
 
tÙ®_logiÿl_£ùÜs_no
, 
£ùÜs_no_³r_·ge
);

118 ~
Add»ssM­pšgDomaš
();

122 
GTDEÁryTy³
* 
	gGlob®T¿n¦©iÚDœeùÜy
;

126 
	gCMT_’Œy_size
;

127 
	gT¿n¦©iÚ_’Œ›s_³r_·ge
;

128 
Cached_M­pšg_TabË
* 
	gCMT
;

129 
	gNo_of_š£¹ed_’Œ›s_š_´ecÚd™iÚšg
;

133 
GMTEÁryTy³
* 
	gGlob®M­pšgTabË
;

134 
Upd©e_m­pšg_šfo
(cÚ¡ 
boŞ
 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
, cÚ¡ 
PPA_ty³
 
µa
, cÚ¡ 
·ge_¡©us_ty³
 
·ge_¡©us_b™m­
);

135 
·ge_¡©us_ty³
 
G‘_·ge_¡©us
(cÚ¡ 
boŞ
 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
);

136 
PPA_ty³
 
G‘_µa
(cÚ¡ 
boŞ
 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
);

137 
PPA_ty³
 
G‘_µa_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
);

138 
boŞ
 
M­pšg_’Œy_acûssibË
(cÚ¡ boŞ 
id—l_m­pšg
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
);

141 
	g¡d
::
muÉim­
<
LPA_ty³
, 
	gNVM_T¿n§ùiÚ_FÏsh
*> 
	gWa™šg_unm­³d_»ad_Œª§ùiÚs
;

142 
	g¡d
::
muÉim­
<
LPA_ty³
, 
	gNVM_T¿n§ùiÚ_FÏsh
*> 
	gWa™šg_unm­³d_´og¿m_Œª§ùiÚs
;

143 
	g¡d
::
muÉim­
<
MVPN_ty³
, 
	gLPA_ty³
> 
	gA¼ivšgM­pšgEÁr›s
;

144 
	g¡d
::
£t
<
MVPN_ty³
> 
D•¬tšgM­pšgEÁr›s
;

145 
	g¡d
::
£t
<
LPA_ty³
> 
Locked_LPAs
;

146 
	g¡d
::
£t
<
MVPN_ty³
> 
Locked_MVPNs
;

147 
	g¡d
::
muÉim­
<
LPA_ty³
, 
	gNVM_T¿n§ùiÚ_FÏsh
*> 
	gR—d_Œª§ùiÚs_behšd_LPA_b¬r›r
;

148 
	g¡d
::
muÉim­
<
LPA_ty³
, 
	gNVM_T¿n§ùiÚ_FÏsh
*> 
	gWr™e_Œª§ùiÚs_behšd_LPA_b¬r›r
;

149 
	g¡d
::
£t
<
MVPN_ty³
> 
MVPN_»ad_Œª§ùiÚs_wa™šg_behšd_b¬r›r
;

150 
	g¡d
::
£t
<
MVPN_ty³
> 
MVPN_wr™e_Œª§ùiÚ_wa™šg_behšd_b¬r›r
;

152 
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
 
	gPÏÃAÎoÿtiÚScheme
;

153 
æash_chªÃl_ID_ty³
* 
	gChªÃl_ids
;

154 
	gChªÃl_no
;

155 
æash_ch_ID_ty³
* 
	gCh_ids
;

156 
	gCh_no
;

157 
æash_d›_ID_ty³
* 
	gD›_ids
;

158 
	gD›_no
;

159 
æash_¶ªe_ID_ty³
* 
	gPÏÃ_ids
;

160 
	gPÏÃ_no
;

162 
NEWCODE


163 
	g¡d
::
muÉim­
<
PPA_ty³
,
	gsim_time_ty³
> 
	gpv_aw¬e_time
;

164 
	g¡d
::
m­
<
PPA_ty³
,
	gsim_time_ty³
> 
	g¡¬t_time
;

165 
ENDCODE


167 
LHA_ty³
 
	gmax_logiÿl_£ùÜ_add»ss
;

168 
LPA_ty³
 
	gTÙ®_logiÿl_·ges_no
;

169 
PPA_ty³
 
	gTÙ®_physiÿl_·ges_no
;

170 
MVPN_ty³
 
	gTÙ®_Œª¦©iÚ_·ges_no
;

173 şas 
	cAdd»ss_M­pšg_Un™_Page_Lev–
 : 
public
 
Add»ss_M­pšg_Un™_Ba£


175 
ä›nd
 
şass
 
GC_ªd_WL_Un™_Page_Lev–
;

176 
	gpublic
:

177 
Add»ss_M­pšg_Un™_Page_Lev–
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
,

178 
boŞ
 
id—l_m­pšg_bË
, 
cmt_ÿ·c™y_š_by‹
, 
FÏsh_PÏÃ_AÎoÿtiÚ_Scheme_Ty³
 
PÏÃAÎoÿtiÚScheme
,

179 
CÚcu¼’tSŒ—mNo
,

180 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
,

181 
¡d
::
veùÜ
<¡d::veùÜ<
æash_chªÃl_ID_ty³
>> 
¡»am_chªÃl_ids
, std::veùÜ<¡d::veùÜ<
æash_ch_ID_ty³
>> 
¡»am_ch_ids
,

182 
¡d
::
veùÜ
<¡d::veùÜ<
æash_d›_ID_ty³
>> 
¡»am_d›_ids
, std::veùÜ<¡d::veùÜ<
æash_¶ªe_ID_ty³
>> 
¡»am_¶ªe_ids
,

183 
Block_no_³r_¶ªe
, 
Page_no_³r_block
, 
SeùÜsP”Page
, 
PageSizeInBy‹s
,

184 
Ov”´ovisiÚšg_¿tio
, 
CMT_Sh¬šg_Mode
 
sh¬šg_mode
 = CMT_Sh¬šg_Mode::
SHARED
, 
boŞ
 
fŞd_Ïrge_add»s£s
 = 
Œue
);

186 ~
Add»ss_M­pšg_Un™_Page_Lev–
();

188 
S‘up_Œigg”s
();

189 
S¹_simuÏtiÚ
();

190 
V®id©e_simuÏtiÚ_cÚfig
();

191 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

192 
£nd_to_amu
(
sim_time_ty³
 
Œx_time
,
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
Add»ss
,
¡»am_id_ty³
 
SŒ—m_id
);

193 
AÎoÿ‹_add»ss_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
¡d
::
m­
<
LPA_ty³
, 
·ge_¡©us_ty³
>& 
Ía_li¡
, std::
veùÜ
<>& 
¡—dy_¡©e_di¡ributiÚ
);

194 
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

195 
G‘_cmt_ÿ·c™y
();

196 
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡»am_id_ty³
 
¡»am_id
);

197 
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(cÚ¡ 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>& 
Œª§ùiÚLi¡
);

198 
G‘_d©a_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ía
, 
PPA_ty³
& 
µa
, 
·ge_¡©us_ty³
& 
·ge_¡©e
);

199 
G‘_Œª¦©iÚ_m­pšg_šfo_fÜ_gc
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
MVPN_ty³
 
mv²
, 
MPPN_ty³
& 
mµa
, 
sim_time_ty³
& 
time¡amp
);

200 
AÎoÿ‹_Ãw_·ge_fÜ_gc
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
, 
boŞ
 
is_Œª¦©iÚ_·ge
);

201 
g‘_couÁ
(
key
,
group
);

202 
StÜe_m­pšg_bË_Ú_æash_©_¡¬t
();

203 
LPA_ty³
 
G‘_logiÿl_·ges_couÁ
(
¡»am_id_ty³
 
¡»am_id
);

204 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µa
);

205 
CÚv”t_µa_to_add»ss
(cÚ¡ 
PPA_ty³
 
µn
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

206 
PPA_ty³
 
CÚv”t_add»ss_to_µa
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·geAdd»ss
);

208 
S‘_b¬r›r_fÜ_acûssšg_physiÿl_block
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
);

209 
S‘_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

210 
S‘_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mpvn
);

211 
Remove_b¬r›r_fÜ_acûssšg_Ía
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

212 
Remove_b¬r›r_fÜ_acûssšg_mv²
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mpvn
);

213 
S¹_£rvicšg_wr™es_fÜ_ov”fuÎ_¶ªe
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
);

214 
´št_pv_aw¬e_d©a
(
¡d
::
¡ršg
 
¡r
);

216 ***** 
	gz
;

217 *** 
	gt
;

218 
	gsize_of_group_–em’t
;

219 
	ggroup_no
=4;

220 
	gcouÁ_size
=8;

221 
boŞ
 
	g®loc
;

222 
	g¡d
::
muÉim­
<,¡d::
veùÜ
<>>** 
group
;

223 
	g¡d
::
li¡
<
¡d
::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>* 
	gg
;

224 
LPA_ty³
 
g‘_couÁ
(LPA_ty³ 
key
,
group
);

225 
PageRPGCache
* 
£t1
(cÚ¡ 
¡»am_id_ty³
,
LPA_ty³
);

226 
	g¡d
::
li¡
<
¡d
::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>::
™”©Ü
 
g‘_NthChªûBack
();

227 
	g¡d
::
m­
<
LPA_ty³
,¡d::
li¡
<
¡d
::
·œ
<
PageRPGCache
*,
	gLPA_ty³
>>::
™”©Ü
>* map;

229 
	g´iv©e
:

230 
Add»ss_M­pšg_Un™_Page_Lev–
* 
_my_š¡ªû
;

231 
	gcmt_ÿ·c™y
;

232 
Add»ssM­pšgDomaš
** 
	gdomašs
;

233 
š™_v
(
chªÃlID
,
chID
,
¡d
::
veùÜ
<¡d::veùÜ<>>** 
v
);

234 
	gCMT_’Œy_size
, 
	gGTD_’Œy_size
;

235 
®loÿ‹_¶ªe_fÜ_u£r_wr™e
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
);

236 
®loÿ‹_·ge_š_¶ªe_fÜ_u£r_wr™e
(
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œª§ùiÚ
, 
boŞ
 
is_fÜ_gc
);

237 
®loÿ‹_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

238 
®loÿ‹_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
, 
MVPN_ty³
 
mv²
, 
boŞ
 
is_fÜ_gc
);

239 
®loÿ‹_¶ªe_fÜ_´ecÚd™iÚšg
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ín
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
rg‘Add»ss
);

240 
boŞ
 
»que¡_m­pšg_’Œy
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
);

241 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

242 
boŞ
 
Œª¦©e_Ía_to_µa
(
¡»am_id_ty³
 
¡»amID
, 
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

243 
	g¡d
::
£t
<
NVM_T¿n§ùiÚ_FÏsh_WR
*>**** 
Wr™e_Œª§ùiÚs_fÜ_ov”fuÎ_¶ªes
;

245 
	g¡d
::
m­
<
PPA_ty³
,
	gsim_time_ty³
> 
pv_upd©e_d©a
();

247 
g’”©e_æash_»ad_»que¡_fÜ_m­pšg_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
);

248 
g’”©e_æash_wr™eback_»que¡_fÜ_m­pšg_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
);

250 
	gno_of_Œª¦©iÚ_’Œ›s_³r_·ge
;

251 
MVPN_ty³
 
g‘_MVPN
(cÚ¡ 
LPA_ty³
 
Ín
, 
¡»am_id_ty³
 
¡»am_id
);

252 
LPA_ty³
 
g‘_¡¬t_LPN_š_MVP
(cÚ¡ 
MVPN_ty³
);

253 
LPA_ty³
 
g‘_’d_LPN_š_MVP
(cÚ¡ 
MVPN_ty³
);

255 
boŞ
 
qu”y_cmt
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

256 
PPA_ty³
 
Úlše_ü—‹_’Œy_fÜ_»ads
(
LPA_ty³
 
Ía
, cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
»ad_add»ss
, 
ušt64_t
 
»ad_£ùÜs_b™m­
,
boŞ
 
RPG_WR
);

257 
mªge_unsucûssful_Œª¦©iÚ
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

258 
mªage_u£r_Œª§ùiÚ_çcšg_b¬r›r
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

259 
mªage_m­pšg_Œª§ùiÚ_çcšg_b¬r›r
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
, 
boŞ
 
»ad
);

260 
boŞ
 
is_Ía_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
LPA_ty³
 
Ía
);

261 
boŞ
 
is_mv²_locked_fÜ_gc
(
¡»am_id_ty³
 
¡»am_id
, 
MVPN_ty³
 
mv²
);

	@src/ssd/Data_Cache_Flash.cpp

1 
	~"D©a_Cache_FÏsh.h
"

2 
	~<as£¹.h
>

5 
Çme¥aû
 
	gSSD_CompÚ’ts


7 
	gD©a_Cache_FÏsh
::
D©a_Cache_FÏsh
(
ÿ·c™y_š_·ges
) : capacity_in_pages(capacity_in_pages) {}

8 
boŞ
 
D©a_Cache_FÏsh
::
Exi¡s
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
)

10 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»am_id
, 
Ín
);

11 autØ
	g™
 = 
¦Ùs
.
fšd
(
key
);

12 ià(
	g™
 =ğ
¦Ùs
.
’d
()) {

13  
çl£
;

16  
	gŒue
;

19 
	gD©a_Cache_FÏsh
::~
D©a_Cache_FÏsh
()

21 autØ&
¦Ù
 : 
¦Ùs
) {

22 
d–‘e
 
¦Ù
.
£cÚd
;

26 
D©a_Cache_SlÙ_Ty³
 
	gD©a_Cache_FÏsh
::
G‘_¦Ù
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
)

28 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»am_id
, 
Ín
);

29 autØ
	g™
 = 
¦Ùs
.
fšd
(
key
);

30 
as£¹
(
™
 !ğ
¦Ùs
.
’d
());

31 ià(
	gÌu_li¡
.
begš
()->
	gfœ¡
 !ğ
key
) {

32 
Ìu_li¡
.
¥liû
Öru_li¡.
begš
(),†ru_li¡, 
™
->
£cÚd
->
Ìu_li¡_±r
);

35  *(
	g™
->
	g£cÚd
);

38 
boŞ
 
	gD©a_Cache_FÏsh
::
Check_ä“_¦Ù_avaab™y
()

40  
¦Ùs
.
size
(è< 
ÿ·c™y_š_·ges
;

43 
boŞ
 
	gD©a_Cache_FÏsh
::
Check_ä“_¦Ù_avaab™y
(
no_of_¦Ùs
)

45  
¦Ùs
.
size
(è+ 
no_of_¦Ùs
 <ğ
ÿ·c™y_š_·ges
;

48 
boŞ
 
	gD©a_Cache_FÏsh
::
Em±y
()

50  
¦Ùs
.
size
() == 0;

53 
boŞ
 
	gD©a_Cache_FÏsh
::
FuÎ
()

55  
¦Ùs
.
size
(è=ğ
ÿ·c™y_š_·ges
;

58 
D©a_Cache_SlÙ_Ty³
 
	gD©a_Cache_FÏsh
::
Eviù_Úe_dœty_¦Ù
()

60 
as£¹
(
¦Ùs
.
size
() > 0);

61 autØ
	g™r
 = 
Ìu_li¡
.
rbegš
();

62 
	g™r
 !ğ
Ìu_li¡
.
»nd
()) {

63 ià((*
™r
).
£cÚd
->
Stus
 =ğ
Cache_SlÙ_Stus
::
DIRTY_NO_FLASH_WRITEBACK
) {

66 
	g™r
++;

69 
D©a_Cache_SlÙ_Ty³
 
	geviùed_™em
 = *
Ìu_li¡
.
back
().
£cÚd
;

70 ià(
	g™r
 =ğ
Ìu_li¡
.
»nd
()) {

71 
eviùed_™em
.
Stus
 = 
Cache_SlÙ_Stus
::
EMPTY
;

72  
	geviùed_™em
;

75 
	g¦Ùs
.
”a£
(
Ìu_li¡
.
back
().
fœ¡
);

76 
d–‘e
 
	gÌu_li¡
.
back
().
	g£cÚd
;

77 
	gÌu_li¡
.
pİ_back
();

79  
	geviùed_™em
;

82 
D©a_Cache_SlÙ_Ty³
 
	gD©a_Cache_FÏsh
::
Eviù_Úe_¦Ù_Ìu
()

84 
as£¹
(
¦Ùs
.
size
() > 0);

85 
	g¦Ùs
.
”a£
(
Ìu_li¡
.
back
().
fœ¡
);

86 
D©a_Cache_SlÙ_Ty³
 
	geviùed_™em
 = *
Ìu_li¡
.
back
().
£cÚd
;

87 
d–‘e
 
	gÌu_li¡
.
back
().
	g£cÚd
;

88 
	gÌu_li¡
.
pİ_back
();

90  
	geviùed_™em
;

93 
	gD©a_Cache_FÏsh
::
Chªge_¦Ù_¡©us_to_wr™eback
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
)

95 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»am_id
, 
Ín
);

96 autØ
	g™
 = 
¦Ùs
.
fšd
(
key
);

97 
as£¹
(
™
 !ğ
¦Ùs
.
’d
());

98 
	g™
->
	g£cÚd
->
	gStus
 = 
Cache_SlÙ_Stus
::
DIRTY_FLASH_WRITEBACK
;

101 
	gD©a_Cache_FÏsh
::
In£¹_»ad_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
, cÚ¡ 
d©a_ÿche_cÚ‹Á_ty³
 
cÚ‹Á
,

102 cÚ¡ 
d©a_time¡amp_ty³
 
time¡amp
, cÚ¡ 
·ge_¡©us_ty³
 
¡©e_b™m­_of_»ad_£ùÜs
)

104 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»am_id
, 
Ín
);

106 ià(
	g¦Ùs
.
fšd
(
key
è!ğ
¦Ùs
.
’d
()) {

107 
throw
 
¡d
::
logic_”rÜ
("Duplicate†pn insertion into data cache!");

109 ià(
	g¦Ùs
.
size
(è>ğ
ÿ·c™y_š_·ges
) {

110 
throw
 
¡d
::
logic_”rÜ
("Data cache overfull!");

113 
D©a_Cache_SlÙ_Ty³
* 
	gÿche_¦Ù
 = 
Ãw
 Data_Cache_Slot_Type();

114 
	gÿche_¦Ù
->
	gLPA
 = 
Ín
;

115 
	gÿche_¦Ù
->
	gS‹_b™m­_of_exi¡šg_£ùÜs
 = 
¡©e_b™m­_of_»ad_£ùÜs
;

116 
	gÿche_¦Ù
->
	gCÚ‹Á
 = 
cÚ‹Á
;

117 
	gÿche_¦Ù
->
	gTime¡amp
 = 
time¡amp
;

118 
	gÿche_¦Ù
->
	gStus
 = 
Cache_SlÙ_Stus
::
CLEAN
;

119 
	gÌu_li¡
.
push_äÚt
(
¡d
::
·œ
<
LPA_ty³
, 
D©a_Cache_SlÙ_Ty³
*>(
key
, 
ÿche_¦Ù
));

120 
	gÿche_¦Ù
->
	gÌu_li¡_±r
 = 
Ìu_li¡
.
begš
();

121 
	g¦Ùs
[
key
] = 
ÿche_¦Ù
;

124 
	gD©a_Cache_FÏsh
::
In£¹_wr™e_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
, cÚ¡ 
d©a_ÿche_cÚ‹Á_ty³
 
cÚ‹Á
,

125 cÚ¡ 
d©a_time¡amp_ty³
 
time¡amp
, cÚ¡ 
·ge_¡©us_ty³
 
¡©e_b™m­_of_wr™e_£ùÜs
)

127 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»am_id
, 
Ín
);

129 ià(
	g¦Ùs
.
fšd
(
key
è!ğ
¦Ùs
.
’d
()) {

130 
throw
 
¡d
::
logic_”rÜ
("Duplicate†pn insertion into data cache!!");

133 ià(
	g¦Ùs
.
size
(è>ğ
ÿ·c™y_š_·ges
) {

134 
throw
 
¡d
::
logic_”rÜ
("Data cache overfull!");

137 
D©a_Cache_SlÙ_Ty³
* 
	gÿche_¦Ù
 = 
Ãw
 Data_Cache_Slot_Type();

138 
	gÿche_¦Ù
->
	gLPA
 = 
Ín
;

139 
	gÿche_¦Ù
->
	gS‹_b™m­_of_exi¡šg_£ùÜs
 = 
¡©e_b™m­_of_wr™e_£ùÜs
;

140 
	gÿche_¦Ù
->
	gCÚ‹Á
 = 
cÚ‹Á
;

141 
	gÿche_¦Ù
->
	gTime¡amp
 = 
time¡amp
;

142 
	gÿche_¦Ù
->
	gStus
 = 
Cache_SlÙ_Stus
::
DIRTY_NO_FLASH_WRITEBACK
;

143 
	gÌu_li¡
.
push_äÚt
(
¡d
::
·œ
<
LPA_ty³
, 
D©a_Cache_SlÙ_Ty³
*>(
key
, 
ÿche_¦Ù
));

144 
	gÿche_¦Ù
->
	gÌu_li¡_±r
 = 
Ìu_li¡
.
begš
();

145 
	g¦Ùs
[
key
] = 
ÿche_¦Ù
;

148 
	gD©a_Cache_FÏsh
::
Upd©e_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
, cÚ¡ 
d©a_ÿche_cÚ‹Á_ty³
 
cÚ‹Á
,

149 cÚ¡ 
d©a_time¡amp_ty³
 
time¡amp
, cÚ¡ 
·ge_¡©us_ty³
 
¡©e_b™m­_of_wr™e_£ùÜs
)

151 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»am_id
, 
Ín
);

152 autØ
	g™
 = 
¦Ùs
.
fšd
(
key
);

153 
as£¹
(
™
 !ğ
¦Ùs
.
’d
());

155 
	g™
->
	g£cÚd
->
	gLPA
 = 
Ín
;

156 
	g™
->
	g£cÚd
->
	gS‹_b™m­_of_exi¡šg_£ùÜs
 = 
¡©e_b™m­_of_wr™e_£ùÜs
;

157 
	g™
->
	g£cÚd
->
	gCÚ‹Á
 = 
cÚ‹Á
;

158 
	g™
->
	g£cÚd
->
	gTime¡amp
 = 
time¡amp
;

159 
	g™
->
	g£cÚd
->
	gStus
 = 
Cache_SlÙ_Stus
::
DIRTY_NO_FLASH_WRITEBACK
;

160 ià(
	gÌu_li¡
.
begš
()->
	gfœ¡
 !ğ
key
) {

161 
Ìu_li¡
.
¥liû
Öru_li¡.
begš
(),†ru_li¡, 
™
->
£cÚd
->
Ìu_li¡_±r
);

165 
	gD©a_Cache_FÏsh
::
Remove_¦Ù
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
)

167 
LPA_ty³
 
	gkey
 = 
LPN_TO_UNIQUE_KEY
(
¡»am_id
, 
Ín
);

168 autØ
	g™
 = 
¦Ùs
.
fšd
(
key
);

169 
as£¹
(
™
 !ğ
¦Ùs
.
’d
());

170 
	gÌu_li¡
.
”a£
(
™
->
£cÚd
->
Ìu_li¡_±r
);

171 
d–‘e
 
	g™
->
	g£cÚd
;

172 
	g¦Ùs
.
”a£
(
™
);

	@src/ssd/Data_Cache_Flash.h

1 #iâdeà
DATA_CACHE_FLASH_H


2 
	#DATA_CACHE_FLASH_H


	)

4 
	~<li¡
>

5 
	~<queue
>

6 
	~<unÜd”ed_m­
>

7 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

8 
	~"SSD_Defs.h
"

9 
	~"D©a_Cache_Mªag”_Ba£.h
"

10 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

12 
Çme¥aû
 
	gSSD_CompÚ’ts


14 şas 
	cCache_SlÙ_Stus
 { 
	gEMPTY
, 
	gCLEAN
, 
	gDIRTY_NO_FLASH_WRITEBACK
, 
	gDIRTY_FLASH_WRITEBACK
 };

15 
	sD©a_Cache_SlÙ_Ty³


17 
boŞ
 
	gRPG_·ge
;

18 
	g»ad_couÁ”
;

19 
	gS‹_b™m­_of_exi¡šg_£ùÜs
;

20 
LPA_ty³
 
	gLPA
;

21 
d©a_ÿche_cÚ‹Á_ty³
 
	gCÚ‹Á
;

22 
d©a_time¡amp_ty³
 
	gTime¡amp
;

23 
Cache_SlÙ_Stus
 
	gStus
;

24 
	g¡d
::
li¡
<
¡d
::
·œ
<
LPA_ty³
, 
	gD©a_Cache_SlÙ_Ty³
*>>::
™”©Ü
 
Ìu_li¡_±r
;

27 şas 
	cD©a_Cache_SimuÏtiÚ_Ev’t_Ty³
 {

28 
	gMEMORY_READ_FOR_CACHE_EVICTION_FINISHED
,

29 
	gMEMORY_WRITE_FOR_CACHE_FINISHED
,

30 
	gMEMORY_READ_FOR_USERIO_FINISHED
,

31 
	gMEMORY_WRITE_FOR_USERIO_FINISHED


34 
	sMemÜy_T¿nsãr_Info


36 
	gSize_š_by‹s
;

37 * 
	gR–©ed_»que¡
;

38 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
 
	gÃxt_ev’t_ty³
;

39 
¡»am_id_ty³
 
	gSŒ—m_id
;

42 şas 
	cD©a_Cache_FÏsh


44 
	gpublic
:

45 
D©a_Cache_FÏsh
(
ÿ·c™y_š_·ges
 = 0);

46 ~
D©a_Cache_FÏsh
();

47 
boŞ
 
Exi¡s
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
LPA_ty³
 
Ín
);

48 
boŞ
 
Check_ä“_¦Ù_avaab™y
();

49 
boŞ
 
Check_ä“_¦Ù_avaab™y
(
no_of_¦Ùs
);

50 
boŞ
 
Em±y
();

51 
boŞ
 
FuÎ
();

52 
D©a_Cache_SlÙ_Ty³
 
G‘_¦Ù
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
);

53 
D©a_Cache_SlÙ_Ty³
 
Eviù_Úe_dœty_¦Ù
();

54 
D©a_Cache_SlÙ_Ty³
 
Eviù_Úe_¦Ù_Ìu
();

55 
Chªge_¦Ù_¡©us_to_wr™eback
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
);

56 
Remove_¦Ù
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
);

57 
In£¹_»ad_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
, cÚ¡ 
d©a_ÿche_cÚ‹Á_ty³
 
cÚ‹Á
, cÚ¡ 
d©a_time¡amp_ty³
 
time¡amp
, cÚ¡ 
·ge_¡©us_ty³
 
¡©e_b™m­_of_»ad_£ùÜs
);

58 
In£¹_wr™e_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
, cÚ¡ 
d©a_ÿche_cÚ‹Á_ty³
 
cÚ‹Á
, cÚ¡ 
d©a_time¡amp_ty³
 
time¡amp
, cÚ¡ 
·ge_¡©us_ty³
 
¡©e_b™m­_of_wr™e_£ùÜs
);

59 
Upd©e_d©a
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
LPA_ty³
 
Ín
, cÚ¡ 
d©a_ÿche_cÚ‹Á_ty³
 
cÚ‹Á
, cÚ¡ 
d©a_time¡amp_ty³
 
time¡amp
, cÚ¡ 
·ge_¡©us_ty³
 
¡©e_b™m­_of_wr™e_£ùÜs
);

60 
	g´iv©e
:

61 
¡d
::
unÜd”ed_m­
<
LPA_ty³
, 
	gD©a_Cache_SlÙ_Ty³
*> 
	g¦Ùs
;

62 
	g¡d
::
li¡
<
¡d
::
·œ
<
LPA_ty³
, 
	gD©a_Cache_SlÙ_Ty³
*>> 
	gÌu_li¡
;

63 
	gÿ·c™y_š_·ges
;

	@src/ssd/Data_Cache_Manager_Base.cpp

1 
	~"D©a_Cache_Mªag”_Ba£.h
"

2 
	~"FTL.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
D©a_Cache_Mªag”_Ba£
* 
	gD©a_Cache_Mªag”_Ba£
::
_my_š¡ªû
 = 
NULL
;

7 
Cachšg_Mode
* 
	gD©a_Cache_Mªag”_Ba£
::
ÿchšg_mode_³r_šput_¡»am
;

9 
	gD©a_Cache_Mªag”_Ba£
::
D©a_Cache_Mªag”_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
NVM_Fœmw¬e
* 
nvm_fœmw¬e
,

10 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
sim_time_ty³
 
d¿m_tRCD
, sim_time_ty³ 
d¿m_tCL
, sim_time_ty³ 
d¿m_tRP
,

11 
Cachšg_Mode
* 
ÿchšg_mode_³r_šput_¡»am
, 
Cache_Sh¬šg_Mode
 
sh¬šg_mode
, 
¡»am_couÁ
)

12 : 
MQSimEngše
::
Sim_Objeù
(
id
), 
ho¡_š‹rçû
(ho¡_š‹rçû), 
nvm_fœmw¬e
(nvm_firmware),

13 
d¿m_row_size
(d¿m_row_size), 
d¿m_d©a_¿‹
(d¿m_d©a_¿‹), 
d¿m_bu¤t_size
(d¿m_bu¤t_size), 
d¿m_tRCD
(d¿m_tRCD), 
d¿m_tCL
(d¿m_tCL), 
d¿m_tRP
(dram_tRP),

14 
sh¬šg_mode
(sh¬šg_mode), 
¡»am_couÁ
(stream_count)

16 
	g_my_š¡ªû
 = 
this
;

17 
	gd¿m_bur¡_Œªsãr_time_ddr
 = (è
ONE_SECOND
 / (
d¿m_d©a_¿‹
 * 1000 * 1000);

18 
	gthis
->
	gÿchšg_mode_³r_šput_¡»am
 = 
Ãw
 
Cachšg_Mode
[
¡»am_couÁ
];

19 
	gi
 = 0; i < 
	g¡»am_couÁ
; i++) {

20 
	gthis
->
	gÿchšg_mode_³r_šput_¡»am
[
i
] = 
ÿchšg_mode_³r_šput_¡»am
[i];

24 
	gD©a_Cache_Mªag”_Ba£
::~
D©a_Cache_Mªag”_Ba£
() {}

26 
D©a_Cache_Mªag”_Ba£
::
S‘up_Œigg”s
()

28 
Sim_Objeù
::
S‘up_Œigg”s
();

29 
	gho¡_š‹rçû
->
CÚÃù_to_u£r_»que¡_¬rived_sigÇl
(
hªdË_u£r_»que¡_¬rived_sigÇl
);

32 
	gD©a_Cache_Mªag”_Ba£
::
S¹_simuÏtiÚ
() {}

34 
D©a_Cache_Mªag”_Ba£
::
V®id©e_simuÏtiÚ_cÚfig
() {}

36 
D©a_Cache_Mªag”_Ba£
::
CÚÃù_to_u£r_»que¡_£rviûd_sigÇl
(
U£rReque¡S”viûdSigÇlHªd”Ty³
 
funùiÚ
)

38 
cÚÃùed_u£r_»que¡_£rviûd_sigÇl_hªdËrs
.
push_back
(
funùiÚ
);

41 
	gD©a_Cache_Mªag”_Ba£
::
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(
U£r_Reque¡
* 
nvm_Œª§ùiÚ
)

43 
¡d
::
veùÜ
<
U£rReque¡S”viûdSigÇlHªd”Ty³
>::
™”©Ü
 
™
 = 
cÚÃùed_u£r_»que¡_£rviûd_sigÇl_hªdËrs
.
begš
();

44 
	g™
 !ğ
cÚÃùed_u£r_»que¡_£rviûd_sigÇl_hªdËrs
.
’d
(); it++) {

45 (*
	g™
)(
	gnvm_Œª§ùiÚ
);

49 
	gD©a_Cache_Mªag”_Ba£
::
CÚÃù_to_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl
(
MemÜyT¿n§ùiÚS”viûdSigÇlHªd”Ty³
 
funùiÚ
)

51 
cÚÃùed_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl_hªdËrs
.
push_back
(
funùiÚ
);

54 
	gD©a_Cache_Mªag”_Ba£
::
brßdÿ¡_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
)

56 
¡d
::
veùÜ
<
MemÜyT¿n§ùiÚS”viûdSigÇlHªd”Ty³
>::
™”©Ü
 
™
 = 
cÚÃùed_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl_hªdËrs
.
begš
();

57 
	g™
 !ğ
cÚÃùed_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl_hªdËrs
.
’d
(); it++) {

58 (*
	g™
)(
	gŒª§ùiÚ
);

62 
	gD©a_Cache_Mªag”_Ba£
::
hªdË_u£r_»que¡_¬rived_sigÇl
(
U£r_Reque¡
* 
u£r_»que¡
)

64 
_my_š¡ªû
->
´oûss_Ãw_u£r_»que¡
(
u£r_»que¡
);

67 
	gD©a_Cache_Mªag”_Ba£
::
S‘_ho¡_š‹rçû
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
)

69 
this
->
ho¡_š‹rçû
 = host_interface;

	@src/ssd/Data_Cache_Manager_Base.h

1 #iâdeà
DATA_CACHE_MANAGER_BASE_H


2 
	#DATA_CACHE_MANAGER_BASE_H


	)

4 
	~<veùÜ
>

5 
	~"../sim/Sim_Objeù.h
"

6 
	~"Ho¡_IÁ”çû_Ba£.h
"

7 
	~"U£r_Reque¡.h
"

8 
	~"NVM_Fœmw¬e.h
"

9 
	~"NVM_PHY_ONFI.h
"

10 
	~"../uts/WÜklßd_Sti¡ics.h
"

12 
Çme¥aû
 
	gSSD_CompÚ’ts


14 
şass
 
	gNVM_Fœmw¬e
;

15 
şass
 
	gHo¡_IÁ”çû_Ba£
;

16 şas 
	cCachšg_Mode
 {
	gWRITE_CACHE
, 
	gREAD_CACHE
, 
	gWRITE_READ_CACHE
, 
	gTURNED_OFF
};

17 şas 
	cCachšg_Mechªism
 { 
	gSIMPLE
, 
	gADVANCED
 };

19 şas 
	cCache_Sh¬šg_Mode
 { 
	gSHARED
,

20 
	gEQUAL_PARTITIONING
};

21 şas 
	cD©a_Cache_Mªag”_Ba£
: 
public
 
MQSimEngše
::
Sim_Objeù


23 
ä›nd
 
şass
 
D©a_Cache_Mªag”_FÏsh_Advªûd
;

24 
ä›nd
 
şass
 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
;

25 
	gpublic
:

26 
D©a_Cache_Mªag”_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
NVM_Fœmw¬e
* 
nvm_fœmw¬e
,

27 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
sim_time_ty³
 
d¿m_tRCD
, sim_time_ty³ 
d¿m_tCL
, sim_time_ty³ 
d¿m_tRP
,

28 
Cachšg_Mode
* 
ÿchšg_mode_³r_šput_¡»am
, 
Cache_Sh¬šg_Mode
 
sh¬šg_mode
, 
¡»am_couÁ
);

29 
	gvœtu®
 ~
D©a_Cache_Mªag”_Ba£
();

30 
S‘up_Œigg”s
();

31 
S¹_simuÏtiÚ
();

32 
V®id©e_simuÏtiÚ_cÚfig
();

34 (*
	gU£rReque¡S”viûdSigÇlHªd”Ty³
è(
	tU£r_Reque¡
*);

35 
CÚÃù_to_u£r_»que¡_£rviûd_sigÇl
(
U£rReque¡S”viûdSigÇlHªd”Ty³
);

36 (*
	gMemÜyT¿n§ùiÚS”viûdSigÇlHªd”Ty³
è(
	tNVM_T¿n§ùiÚ
*);

37 
CÚÃù_to_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl
(
MemÜyT¿n§ùiÚS”viûdSigÇlHªd”Ty³
);

38 
S‘_ho¡_š‹rçû
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
);

39 
vœtu®
 
Do_w¬mup
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
) = 0;

40 
	g´Ùeùed
:

41 
D©a_Cache_Mªag”_Ba£
* 
_my_š¡ªû
;

42 
Ho¡_IÁ”çû_Ba£
* 
	gho¡_š‹rçû
;

43 
NVM_Fœmw¬e
* 
	gnvm_fœmw¬e
;

44 
	gd¿m_row_size
;

45 
	gd¿m_d©a_¿‹
;

46 
	gd¿m_bu¤t_size
;

47 
	gd¿m_bur¡_Œªsãr_time_ddr
;

48 
sim_time_ty³
 
	gd¿m_tRCD
, 
	gd¿m_tCL
, 
	gd¿m_tRP
;

49 
Cache_Sh¬šg_Mode
 
	gsh¬šg_mode
;

50 
Cachšg_Mode
* 
	gÿchšg_mode_³r_šput_¡»am
;

51 
	g¡»am_couÁ
;

53 
	g¡d
::
veùÜ
<
U£rReque¡S”viûdSigÇlHªd”Ty³
> 
cÚÃùed_u£r_»que¡_£rviûd_sigÇl_hªdËrs
;

54 
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(
U£r_Reque¡
* 
u£r_»que¡
);

56 
	g¡d
::
veùÜ
<
MemÜyT¿n§ùiÚS”viûdSigÇlHªd”Ty³
> 
cÚÃùed_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl_hªdËrs
;

57 
brßdÿ¡_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
);

59 
hªdË_u£r_»que¡_¬rived_sigÇl
(
U£r_Reque¡
* 
u£r_»que¡
);

60 
vœtu®
 
´oûss_Ãw_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
) = 0;

62 
boŞ
 
is_u£r_»que¡_fšished
(cÚ¡ 
U£r_Reque¡
* 
u£r_»que¡
è{  (
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
size
(è=ğ0 && u£r_»que¡->
SeùÜs_£rviûd_äom_ÿche
 == 0); }

66 
šlše
 
sim_time_ty³
 
	$e¡im©e_d¿m_acûss_time
(cÚ¡ 
memÜy_acûss_size_š_by‹
,

67 cÚ¡ 
d¿m_row_size
, cÚ¡ 
d¿m_bur¡_size_š_by‹s
, cÚ¡ 
d¿m_bur¡_Œªsãr_time_ddr
,

68 cÚ¡ 
sim_time_ty³
 
tRCD
, cÚ¡ sim_time_ty³ 
tCL
, cÚ¡ sim_time_ty³ 
tRP
)

70 ià(
memÜy_acûss_size_š_by‹
 <ğ
d¿m_row_size
) {

71  (
sim_time_ty³
)(
tRCD
 + 
tCL
 + 
	`sim_time_ty³
(()(
memÜy_acûss_size_š_by‹
 / 
d¿m_bur¡_size_š_by‹s
 / 2è* 
d¿m_bur¡_Œªsãr_time_ddr
));

74  (
sim_time_ty³
)((
tRCD
 + 
tCL
 + (sim_time_ty³)(()(
d¿m_row_size
 / 
d¿m_bur¡_size_š_by‹s
 / 2 * 
d¿m_bur¡_Œªsãr_time_ddr
è+ 
tRP
è* ()(
memÜy_acûss_size_š_by‹
 / dram_row_size / 2)) +RCD +CL + (sim_time_type)(()(memory_access_size_in_byte % dram_row_size) / (()dram_burst_size_in_bytes * dram_burst_transfer_time_ddr)));

76 
	}
}

	@src/ssd/Data_Cache_Manager_Flash_Advanced.cpp

1 
	~<¡dexû±
>

2 
	~"../nvm_ch/NVM_Ty³s.h
"

3 
	~"D©a_Cache_Mªag”_FÏsh_Advªûd.h
"

4 
	~"NVM_T¿n§ùiÚ_FÏsh_RD.h
"

5 
	~"NVM_T¿n§ùiÚ_FÏsh_WR.h
"

6 
	~"FTL.h
"

8 
Çme¥aû
 
	gSSD_CompÚ’ts


10 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
D©a_Cache_Mªag”_FÏsh_Advªûd
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
NVM_Fœmw¬e
* 
fœmw¬e
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

11 
tÙ®_ÿ·c™y_š_by‹s
,

12 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
sim_time_ty³
 
d¿m_tRCD
, sim_time_ty³ 
d¿m_tCL
, sim_time_ty³ 
d¿m_tRP
,

13 
Cachšg_Mode
* 
ÿchšg_mode_³r_šput_¡»am
, 
Cache_Sh¬šg_Mode
 
sh¬šg_mode
,
¡»am_couÁ
,

14 
£ùÜ_no_³r_·ge
, 
back_´essu»_bufãr_max_d•th
)

15 : 
D©a_Cache_Mªag”_Ba£
(
id
, 
ho¡_š‹rçû
, 
fœmw¬e
, 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
d¿m_tRCD
, 
d¿m_tCL
, 
d¿m_tRP
, 
ÿchšg_mode_³r_šput_¡»am
, 
sh¬šg_mode
, 
¡»am_couÁ
),

16 
æash_cÚŒŞËr
(æash_cÚŒŞËr), 
ÿ·c™y_š_by‹s
(
tÙ®_ÿ·c™y_š_by‹s
), 
£ùÜ_no_³r_·ge
(£ùÜ_no_³r_·ge), 
memÜy_chªÃl_is_busy
(
çl£
),

17 
d¿m_executiÚ_li¡_tuº
(0), 
back_´essu»_bufãr_max_d•th
(back_pressure_buffer_max_depth)

19 
	gÿ·c™y_š_·ges
 = 
ÿ·c™y_š_by‹s
 / (
SECTOR_SIZE_IN_BYTE
 * 
£ùÜ_no_³r_·ge
);

20 
	gsh¬šg_mode
)

22 
	gSSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
SHARED
:

24 
D©a_Cache_FÏsh
* 
sh¬edCache
 = 
Ãw
 D©a_Cache_FÏsh(
ÿ·c™y_š_·ges
);

25 
	g³r_¡»am_ÿche
 = 
Ãw
 
D©a_Cache_FÏsh
*[
¡»am_couÁ
];

26 
	gi
 = 0; i < 
	g¡»am_couÁ
; i++) {

27 
	g³r_¡»am_ÿche
[
i
] = 
sh¬edCache
;

29 
	gd¿m_executiÚ_queue
 = 
Ãw
 
¡d
::
queue
<
MemÜy_T¿nsãr_Info
*>[1];

30 
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
 = 
Ãw
 
¡d
::
li¡
<
U£r_Reque¡
*>[1];

31 
	gthis
->
	gback_´essu»_bufãr_d•th
 = 
Ãw
 [1];

32 
	gthis
->
	gback_´essu»_bufãr_d•th
[0] = 0;

33 
	gsh¬ed_d¿m_»que¡_queue
 = 
Œue
;

36 
	gSSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
EQUAL_PARTITIONING
:

37 
³r_¡»am_ÿche
 = 
Ãw
 
D©a_Cache_FÏsh
*[
¡»am_couÁ
];

38 
	gi
 = 0; i < 
	g¡»am_couÁ
; i++) {

39 
	g³r_¡»am_ÿche
[
i
] = 
Ãw
 
D©a_Cache_FÏsh
(
ÿ·c™y_š_·ges
 / 
¡»am_couÁ
);

41 
	gd¿m_executiÚ_queue
 = 
Ãw
 
¡d
::
queue
<
MemÜy_T¿nsãr_Info
*>[
¡»am_couÁ
];

42 
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
 = 
Ãw
 
¡d
::
li¡
<
U£r_Reque¡
*>[
¡»am_couÁ
];

43 
	gthis
->
	gback_´essu»_bufãr_d•th
 = 
Ãw
 [
¡»am_couÁ
];

44 
	gi
 = 0; i < 
	g¡»am_couÁ
; i++) {

45 
	gthis
->
	gback_´essu»_bufãr_d•th
[
i
] = 0;

47 
	gsh¬ed_d¿m_»que¡_queue
 = 
çl£
;

53 
	gbloom_f‹r
 = 
Ãw
 
¡d
::
£t
<
LPA_ty³
>[
¡»am_couÁ
];

56 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::~
D©a_Cache_Mªag”_FÏsh_Advªûd
()

58 
sh¬šg_mode
)

60 
SSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
SHARED
:

62 
d–‘e
 
³r_¡»am_ÿche
[0];

63 
	gd¿m_executiÚ_queue
[0].
size
()) {

64 
d–‘e
 
	gd¿m_executiÚ_queue
[0].
äÚt
();

65 
	gd¿m_executiÚ_queue
[0].
pİ
();

67 autØ&
	g»q
 : 
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[0]) {

68 
d–‘e
 
»q
;

72 
	gSSD_CompÚ’ts
::
Cache_Sh¬šg_Mode
::
EQUAL_PARTITIONING
:

73 
i
 = 0; 
	gi
 < 
	g¡»am_couÁ
; i++) {

74 
d–‘e
 
	g³r_¡»am_ÿche
[
i
];

75 
	gd¿m_executiÚ_queue
[
i
].
size
()) {

76 
d–‘e
 
	gd¿m_executiÚ_queue
[
i
].
äÚt
();

77 
	gd¿m_executiÚ_queue
[
i
].
pİ
();

79 autØ&
	g»q
 : 
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[
i
]) {

80 
d–‘e
 
»q
;

88 
d–‘e
 
	g³r_¡»am_ÿche
;

89 
	gd–‘e
[] 
	gd¿m_executiÚ_queue
;

90 
	gd–‘e
[] 
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
;

91 
	gd–‘e
[] 
	gbloom_f‹r
;

94 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
S‘up_Œigg”s
()

96 
D©a_Cache_Mªag”_Ba£
::
S‘up_Œigg”s
();

97 
	gæash_cÚŒŞËr
->
CÚÃùToT¿n§ùiÚS”viûdSigÇl
(
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
);

100 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
Do_w¬mup
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
)

102 
tÙ®_wr™e_¬riv®_¿‹
 = 0, 
	gtÙ®_»ad_¬riv®_¿‹
 = 0;

103 
	gsh¬šg_mode
) {

104 
	gCache_Sh¬šg_Mode
::
SHARED
:

107 autØ&
¡©
 : 
wÜklßd_¡©s
) {

108 
ÿchšg_mode_³r_šput_¡»am
[
¡©
->
SŒ—m_id
]) {

109 
Cachšg_Mode
::
TURNED_OFF
:

111 
	gCachšg_Mode
::
READ_CACHE
:

112 ià(
¡©
->
Ty³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
) {

116 
	gCachšg_Mode
::
WRITE_CACHE
:

117 ià(
¡©
->
Ty³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
) {

118 
tÙ®_·ges_acûs£d
 = 1;

119 
	g¡©
->
	gAdd»ss_di¡ributiÚ_ty³
)

121 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

123 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

125 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

131 
	gCachšg_Mode
::
WRITE_READ_CACHE
:

133 ià(
¡©
->
Ty³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
) {

140 
	gCache_Sh¬šg_Mode
::
EQUAL_PARTITIONING
:

141 autØ&
¡©
 : 
wÜklßd_¡©s
) {

142 
ÿchšg_mode_³r_šput_¡»am
[
¡©
->
SŒ—m_id
])

144 
Cachšg_Mode
::
TURNED_OFF
:

146 
	gCachšg_Mode
::
READ_CACHE
:

148 ià(
¡©
->
Ty³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
) {

152 
	gCachšg_Mode
::
WRITE_CACHE
:

157 ià(
¡©
->
Ty³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
) {

159 
tÙ®_·ges_acûs£d
 = 1;

163 
	g¡©
->
	gAdd»ss_di¡ributiÚ_ty³
)

165 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

167 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

169 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

175 
	gCachšg_Mode
::
WRITE_READ_CACHE
:

177 ià(
¡©
->
Ty³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
) {

187 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
´oûss_Ãw_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
)

190 ià(
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
size
() == 0) {

194 ià(
	gu£r_»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

195 
ÿchšg_mode_³r_šput_¡»am
[
u£r_»que¡
->
SŒ—m_id
]) {

196 
Cachšg_Mode
::
TURNED_OFF
:

197 
¡©ic_ÿ¡
<
FTL
*>(
nvm_fœmw¬e
)->
Add»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
u£r_»que¡
->
T¿n§ùiÚ_li¡
);

199 
	gCachšg_Mode
::
WRITE_CACHE
:

200 
Cachšg_Mode
::
READ_CACHE
:

201 
Cachšg_Mode
::
WRITE_READ_CACHE
:

203 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>::
™”©Ü
 
™
 = 
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
begš
();

204 
	g™
 !ğ
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
’d
()) {

205 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
Œ
 = (NVM_T¿n§ùiÚ_FÏsh_RD*)(*
™
);

206 ià(
	g³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
Exi¡s
Ñr->SŒ—m_id,r->
LPA
)) {

207 
	#impÜÁ_to_nÙe


	)

208 
	#š™Ÿiz©iÚ_of_avaabË_£ùÜs_b™m­


	)

209 
·ge_¡©us_ty³
 
impÜÁ_to_nÙe
 
	gavaabË_£ùÜs_b™m­
 = 
³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
G‘_¦Ù
Ñr->SŒ—m_id,r->
LPA
).
	gS‹_b™m­_of_exi¡šg_£ùÜs
 & 
	gŒ
->
	g»ad_£ùÜs_b™m­
;

210 ià(
	gavaabË_£ùÜs_b™m­
 =ğ
Œ
->
»ad_£ùÜs_b™m­
) {

211 
u£r_»que¡
->
SeùÜs_£rviûd_äom_ÿche
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
Œ
->
»ad_£ùÜs_b™m­
);

212 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
”a£
(
™
++);

213 } ià(
	gavaabË_£ùÜs_b™m­
 != 0) {

215 
	#impÜÁ_to_nÙe


	)

216 
	#š™™Ÿliz©iÚ_of_»ad_£ùÜs_b™m­


	)

217 
u£r_»que¡
->
SeùÜs_£rviûd_äom_ÿche
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
avaabË_£ùÜs_b™m­
);

218 
	gŒ
->
	g»ad_£ùÜs_b™m­
 = (
Œ
->
»ad_£ùÜs_b™m­
 & ~
avaabË_£ùÜs_b™m­
);

219 
	gŒ
->
	gD©a_ªd_m‘ad©a_size_š_by‹
 -ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
avaabË_£ùÜs_b™m­
è* 
SECTOR_SIZE_IN_BYTE
;

220 
	g™
++;

222 
	g™
++;

225 
	g™
++;

229 ià(
	gu£r_»que¡
->
	gSeùÜs_£rviûd_äom_ÿche
 > 0) {

230 
MemÜy_T¿nsãr_Info
* 
	gŒªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

231 
	gŒªsãr_šfo
->
	gSize_š_by‹s
 = 
u£r_»que¡
->
SeùÜs_£rviûd_äom_ÿche
 * 
SECTOR_SIZE_IN_BYTE
;

232 
	gŒªsãr_šfo
->
	gR–©ed_»que¡
 = 
u£r_»que¡
;

233 
	gŒªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_USERIO_FINISHED
;

234 
	gŒªsãr_šfo
->
	gSŒ—m_id
 = 
u£r_»que¡
->
SŒ—m_id
;

235 
£rviû_d¿m_acûss_»que¡
(
Œªsãr_šfo
);

237 ià(
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
size
() > 0) {

238 
	g¡©ic_ÿ¡
<
	gFTL
*>(
	gnvm_fœmw¬e
)->
	gAdd»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
u£r_»que¡
->
T¿n§ùiÚ_li¡
);

247 
	gÿchšg_mode_³r_šput_¡»am
[
u£r_»que¡
->
SŒ—m_id
])

249 
	gCachšg_Mode
::
TURNED_OFF
:

250 
Cachšg_Mode
::
READ_CACHE
:

251 
¡©ic_ÿ¡
<
FTL
*>(
nvm_fœmw¬e
)->
Add»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
u£r_»que¡
->
T¿n§ùiÚ_li¡
);

253 
	gCachšg_Mode
::
WRITE_CACHE
:

254 
Cachšg_Mode
::
WRITE_READ_CACHE
:

256 
wr™e_to_de¡age_bufãr
(
u£r_»que¡
);

258 
	gqueue_id
 = 
u£r_»que¡
->
SŒ—m_id
;

259 ià(
	gsh¬ed_d¿m_»que¡_queue
) {

260 
	gqueue_id
 = 0;

262 ià(
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
size
() > 0) {

263 
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[
queue_id
].
push_back
(
u£r_»que¡
);

271 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
wr™e_to_de¡age_bufãr
(
U£r_Reque¡
* 
u£r_»que¡
)

274 
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 = 0;

275 
	gæash_wr™‹n_back_wr™e_size_š_£ùÜs
 = 0;

276 
	gd¿m_wr™e_size_š_£ùÜs
 = 0;

277 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>* 
eviùed_ÿche_¦Ùs
 = 
Ãw
 
¡d
::list<NVM_Transaction*>;

278 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ
*> 
wr™eback_Œª§ùiÚs
;

279 autØ
	g™
 = 
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
begš
();

281 
	gqueue_id
 = 
u£r_»que¡
->
SŒ—m_id
;

282 ià(
	gsh¬ed_d¿m_»que¡_queue
) {

283 
	gqueue_id
 = 0;

286 
	g™
 !ğ
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
’d
()

287 && (
back_´essu»_bufãr_d•th
[
queue_id
] + 
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 + 
æash_wr™‹n_back_wr™e_size_š_£ùÜs
è< 
back_´essu»_bufãr_max_d•th
) {

288 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œ
 = (NVM_T¿n§ùiÚ_FÏsh_WR*)(*
™
);

290 ià(
	g³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
Exi¡s
Ñr->SŒ—m_id,r->
LPA
)) {

293 
D©a_Cache_SlÙ_Ty³
 
	g¦Ù
 = 
³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
G‘_¦Ù
Ñr->SŒ—m_id,r->
LPA
);

294 
sim_time_ty³
 
	gtime¡amp
 = 
¦Ù
.
Time¡amp
;

295 
	gNVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
 = 
¦Ù
.
CÚ‹Á
;

296 ià(
	gŒ
->
	gD©aTimeSmp
 > 
	gtime¡amp
) {

297 
	gtime¡amp
 = 
Œ
->
D©aTimeSmp
;

298 
	gcÚ‹Á
 = 
Œ
->
CÚ‹Á
;

300 
	g³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
Upd©e_d©a
Ñr->SŒ—m_id,r->
LPA
, 
cÚ‹Á
, 
time¡amp
,r->
wr™e_£ùÜs_b™m­
 | 
¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
);

302 ià(!
	g³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
Check_ä“_¦Ù_avaab™y
()) {

303 
D©a_Cache_SlÙ_Ty³
 
	geviùed_¦Ù
 = 
³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
Eviù_Úe_¦Ù_Ìu
();

304 ià(
	geviùed_¦Ù
.
	gStus
 =ğ
Cache_SlÙ_Stus
::
DIRTY_NO_FLASH_WRITEBACK
) {

305 
eviùed_ÿche_¦Ùs
->
push_back
(
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
CACHE
,

306 
Œ
->
SŒ—m_id
, 
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
eviùed_¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
è* 
SECTOR_SIZE_IN_BYTE
,

307 
eviùed_¦Ù
.
LPA
, 
NULL
,ƒviùed_¦Ù.
CÚ‹Á
,ƒviùed_¦Ù.
S‹_b™m­_of_exi¡šg_£ùÜs
,ƒviùed_¦Ù.
Time¡amp
));

308 
	gÿche_eviùiÚ_»ad_size_š_£ùÜs
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
eviùed_¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
);

312 
	g³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
In£¹_wr™e_d©a
Ñr->SŒ—m_id,r->
LPA
,r->
CÚ‹Á
,r->
D©aTimeSmp
,r->
wr™e_£ùÜs_b™m­
);

314 
	gd¿m_wr™e_size_š_£ùÜs
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
Œ
->
wr™e_£ùÜs_b™m­
);

316 ià(
	gbloom_f‹r
[
Œ
->
SŒ—m_id
].
fšd
Ñr->
LPA
è=ğ
bloom_f‹r
[Œ->SŒ—m_id].
’d
()) {

317 
³r_¡»am_ÿche
[
Œ
->
SŒ—m_id
]->
Chªge_¦Ù_¡©us_to_wr™eback
Ñr->SŒ—m_id,r->
LPA
);

318 
	gæash_wr™‹n_back_wr™e_size_š_£ùÜs
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
Œ
->
wr™e_£ùÜs_b™m­
);

319 
	gbloom_f‹r
[
u£r_»que¡
->
SŒ—m_id
].
š£¹
(
Œ
->
LPA
);

320 
	gwr™eback_Œª§ùiÚs
.
push_back
(
Œ
);

322 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
”a£
(
™
++);

325 
	gu£r_»que¡
->
	gSeùÜs_£rviûd_äom_ÿche
 +ğ
d¿m_wr™e_size_š_£ùÜs
;

326 
	gback_´essu»_bufãr_d•th
[
queue_id
] +ğ
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 + 
æash_wr™‹n_back_wr™e_size_š_£ùÜs
;

329 ià(
	geviùed_ÿche_¦Ùs
->
size
() > 0) {

330 
MemÜy_T¿nsãr_Info
* 
	g»ad_Œªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

331 
	g»ad_Œªsãr_šfo
->
	gSize_š_by‹s
 = 
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

332 
	g»ad_Œªsãr_šfo
->
	gR–©ed_»que¡
 = 
eviùed_ÿche_¦Ùs
;

333 
	g»ad_Œªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_CACHE_EVICTION_FINISHED
;

334 
	g»ad_Œªsãr_šfo
->
	gSŒ—m_id
 = 
u£r_»que¡
->
SŒ—m_id
;

335 
£rviû_d¿m_acûss_»que¡
(
»ad_Œªsãr_šfo
);

339 ià(
	gd¿m_wr™e_size_š_£ùÜs
) {

340 
MemÜy_T¿nsãr_Info
* 
	gwr™e_Œªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

341 
	gwr™e_Œªsãr_šfo
->
	gSize_š_by‹s
 = 
d¿m_wr™e_size_š_£ùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

342 
	gwr™e_Œªsãr_šfo
->
	gR–©ed_»que¡
 = 
u£r_»que¡
;

343 
	gwr™e_Œªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_USERIO_FINISHED
;

344 
	gwr™e_Œªsãr_šfo
->
	gSŒ—m_id
 = 
u£r_»que¡
->
SŒ—m_id
;

345 
£rviû_d¿m_acûss_»que¡
(
wr™e_Œªsãr_šfo
);

349 ià(
	gwr™eback_Œª§ùiÚs
.
size
() > 0) {

350 
	g¡©ic_ÿ¡
<
	gFTL
*>(
	gnvm_fœmw¬e
)->
	gAdd»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
wr™eback_Œª§ùiÚs
);

354 ià(
	gSimuÏtÜ
->
Time
(è> 
	gÃxt_bloom_f‹r_»£t_me¡Úe
) {

355 
	gbloom_f‹r
[
u£r_»que¡
->
SŒ—m_id
].
ş—r
();

356 
	gÃxt_bloom_f‹r_»£t_me¡Úe
 = 
SimuÏtÜ
->
Time
(è+ 
bloom_f‹r_»£t_¡•
;

360 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

363 ià(
Œª§ùiÚ
->
Sourû
 !ğ
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
 &&¿n§ùiÚ->Sourû !ğT¿n§ùiÚ_Sourû_Ty³::
CACHE
) {

367 ià(
	gŒª§ùiÚ
->
	gSourû
 =ğ
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
) {

368 
_my_š¡ªû
->
brßdÿ¡_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl
(
Œª§ùiÚ
);

373 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
READ
) {

374 ià(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
 !ğ
NULL
) {

375 ((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
->
R–©edR—d
 = 
NULL
;

379 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
ÿchšg_mode_³r_šput_¡»am
[
Œª§ùiÚ
->
SŒ—m_id
])

381 
Cachšg_Mode
::
TURNED_OFF
:

382 
Cachšg_Mode
::
WRITE_CACHE
:

383 
Œª§ùiÚ
->
U£rIOReque¡
->
T¿n§ùiÚ_li¡
.
»move
(transaction);

384 ià(
	g_my_š¡ªû
->
is_u£r_»que¡_fšished
(
Œª§ùiÚ
->
U£rIOReque¡
)) {

385 
	g_my_š¡ªû
->
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(
Œª§ùiÚ
->
U£rIOReque¡
);

388 
	gCachšg_Mode
::
READ_CACHE
:

389 
Cachšg_Mode
::
WRITE_READ_CACHE
:

391 
MemÜy_T¿nsãr_Info
* 
Œªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

392 
	gŒªsãr_šfo
->
	gSize_š_by‹s
 = 
couÁ_£ùÜ_no_äom_¡©us_b™m­
(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
»ad_£ùÜs_b™m­
è* 
SECTOR_SIZE_IN_BYTE
;

393 
	gŒªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_CACHE_FINISHED
;

394 
	gŒªsãr_šfo
->
	gSŒ—m_id
 = 
Œª§ùiÚ
->
SŒ—m_id
;

395 ((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
£rviû_d¿m_acûss_»que¡
(
Œªsãr_šfo
);

397 ià(((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	g³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
Exi¡s
Ñ¿n§ùiÚ->SŒ—m_id,¿n§ùiÚ->
LPA
)) {

400 
D©a_Cache_SlÙ_Ty³
 
	g¦Ù
 = ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
G‘_¦Ù
Ñ¿n§ùiÚ->SŒ—m_id,¿n§ùiÚ->
LPA
);

401 
sim_time_ty³
 
	gtime¡amp
 = 
¦Ù
.
Time¡amp
;

402 
	gNVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
 = 
¦Ù
.
CÚ‹Á
;

403 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gD©aTimeSmp
 > 
	gtime¡amp
) {

404 
	gtime¡amp
 = ((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
D©aTimeSmp
;

405 
	gcÚ‹Á
 = ((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
CÚ‹Á
;

408 ((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	g³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
Upd©e_d©a
Ñ¿n§ùiÚ->SŒ—m_id,¿n§ùiÚ->
LPA
, 
cÚ‹Á
,

409 
time¡amp
, ((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
»ad_£ùÜs_b™m­
 | 
¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
);

411 ià(!((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	g³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
Check_ä“_¦Ù_avaab™y
()) {

412 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>* 
eviùed_ÿche_¦Ùs
 = 
Ãw
 
¡d
::list<NVM_Transaction*>;

413 
D©a_Cache_SlÙ_Ty³
 
	geviùed_¦Ù
 = ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
Eviù_Úe_¦Ù_Ìu
();

414 ià(
	geviùed_¦Ù
.
	gStus
 =ğ
Cache_SlÙ_Stus
::
DIRTY_NO_FLASH_WRITEBACK
) {

415 
MemÜy_T¿nsãr_Info
* 
Œªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

416 
	gŒªsãr_šfo
->
	gSize_š_by‹s
 = 
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
eviùed_¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
è* 
SECTOR_SIZE_IN_BYTE
;

417 
	geviùed_ÿche_¦Ùs
->
push_back
(
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
,

418 
Œª§ùiÚ
->
SŒ—m_id
, 
Œªsãr_šfo
->
Size_š_by‹s
, 
eviùed_¦Ù
.
LPA
, 
NULL
,ƒviùed_¦Ù.
CÚ‹Á
,

419 
eviùed_¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
,ƒviùed_¦Ù.
Time¡amp
));

420 
	gŒªsãr_šfo
->
	gR–©ed_»que¡
 = 
eviùed_ÿche_¦Ùs
;

421 
	gŒªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_CACHE_EVICTION_FINISHED
;

422 
	gŒªsãr_šfo
->
	gSŒ—m_id
 = 
Œª§ùiÚ
->
SŒ—m_id
;

423 ((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
£rviû_d¿m_acûss_»que¡
(
Œªsãr_šfo
);

426 ((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	g³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
In£¹_wr™e_d©a
Ñ¿n§ùiÚ->SŒ—m_id,¿n§ùiÚ->
LPA
,

427 ((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
CÚ‹Á
, ((NVM_T¿n§ùiÚ_FÏsh_RD*é¿n§ùiÚ)->
D©aTimeSmp
, ((NVM_T¿n§ùiÚ_FÏsh_RD*é¿n§ùiÚ)->
»ad_£ùÜs_b™m­
);

429 
MemÜy_T¿nsãr_Info
* 
	gŒªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

430 
	gŒªsãr_šfo
->
	gSize_š_by‹s
 = 
couÁ_£ùÜ_no_äom_¡©us_b™m­
(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
»ad_£ùÜs_b™m­
è* 
SECTOR_SIZE_IN_BYTE
;

431 
	gŒªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_CACHE_FINISHED
;

432 
	gŒªsãr_šfo
->
	gSŒ—m_id
 = 
Œª§ùiÚ
->
SŒ—m_id
;

433 ((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
£rviû_d¿m_acûss_»que¡
(
Œªsãr_šfo
);

436 
	gŒª§ùiÚ
->
	gU£rIOReque¡
->
	gT¿n§ùiÚ_li¡
.
»move
(
Œª§ùiÚ
);

437 ià(
	g_my_š¡ªû
->
is_u£r_»que¡_fšished
(
Œª§ùiÚ
->
U£rIOReque¡
)) {

438 
	g_my_š¡ªû
->
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(
Œª§ùiÚ
->
U£rIOReque¡
);

444 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
ÿchšg_mode_³r_šput_¡»am
[
Œª§ùiÚ
->
SŒ—m_id
])

446 
Cachšg_Mode
::
TURNED_OFF
:

447 
Cachšg_Mode
::
READ_CACHE
:

448 
Œª§ùiÚ
->
U£rIOReque¡
->
T¿n§ùiÚ_li¡
.
»move
(transaction);

449 ià(
	g_my_š¡ªû
->
is_u£r_»que¡_fšished
(
Œª§ùiÚ
->
U£rIOReque¡
)) {

450 
	g_my_š¡ªû
->
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(
Œª§ùiÚ
->
U£rIOReque¡
);

453 
	gCachšg_Mode
::
WRITE_CACHE
:

454 
Cachšg_Mode
::
WRITE_READ_CACHE
:

456 
sh¬šg_id
 = 
Œª§ùiÚ
->
SŒ—m_id
;

457 ià(((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	gsh¬ed_d¿m_»que¡_queue
) {

458 
	gsh¬šg_id
 = 0;

460 ((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	gback_´essu»_bufãr_d•th
[
sh¬šg_id
] -ğ
Œª§ùiÚ
->
D©a_ªd_m‘ad©a_size_š_by‹
 / 
SECTOR_SIZE_IN_BYTE
 + (transaction->Data_and_metadata_size_in_byte % SECTOR_SIZE_IN_BYTE == 0 ? 0 : 1);

462 ià(((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	g³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
Exi¡s
Ñ¿n§ùiÚ->SŒ—m_id, ((
NVM_T¿n§ùiÚ_FÏsh_WR
*é¿n§ùiÚ)->
LPA
)) {

463 
D©a_Cache_SlÙ_Ty³
 
	g¦Ù
 = ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
G‘_¦Ù
Ñ¿n§ùiÚ->SŒ—m_id, ((
NVM_T¿n§ùiÚ_FÏsh_WR
*é¿n§ùiÚ)->
LPA
);

464 
sim_time_ty³
 
	gtime¡amp
 = 
¦Ù
.
Time¡amp
;

465 
	gNVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
 = 
¦Ù
.
CÚ‹Á
;

466 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_WR
*)
	gŒª§ùiÚ
)->
	gD©aTimeSmp
 >ğ
time¡amp
) {

467 ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
³r_¡»am_ÿche
[
Œª§ùiÚ
->
SŒ—m_id
]->
Remove_¦Ù
Ñ¿n§ùiÚ->SŒ—m_id, ((
NVM_T¿n§ùiÚ_FÏsh_WR
*é¿n§ùiÚ)->
LPA
);

471 autØ
	gu£r_»que¡
 = ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[
sh¬šg_id
].
begš
();

472 
	gu£r_»que¡
 !ğ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[
sh¬šg_id
].
’d
())

474 ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
wr™e_to_de¡age_bufãr
(*
u£r_»que¡
);

475 ià((*
	gu£r_»que¡
)->
	gT¿n§ùiÚ_li¡
.
size
() == 0) {

476 ((
D©a_Cache_Mªag”_FÏsh_Advªûd
*)
_my_š¡ªû
)->
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[
sh¬šg_id
].
”a£
(
u£r_»que¡
++);

478 
	gu£r_»que¡
++;

481 ià(((
	gD©a_Cache_Mªag”_FÏsh_Advªûd
*)
	g_my_š¡ªû
)->
	gback_´essu»_bufãr_d•th
[
sh¬šg_id
] > ((D©a_Cache_Mªag”_FÏsh_Advªûd*)_my_š¡ªû)->
	gback_´essu»_bufãr_max_d•th
) {

522 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
£rviû_d¿m_acûss_»que¡
(
MemÜy_T¿nsãr_Info
* 
»que¡_šfo
)

524 ià(
memÜy_chªÃl_is_busy
) {

525 if(
sh¬ed_d¿m_»que¡_queue
) {

526 
d¿m_executiÚ_queue
[0].
push
(
»que¡_šfo
);

528 
	gd¿m_executiÚ_queue
[
»que¡_šfo
->
SŒ—m_id
].
push
(request_info);

531 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_d¿m_acûss_time
(
»que¡_šfo
->
Size_š_by‹s
, 
d¿m_row_size
,

532 
d¿m_bu¤t_size
, 
d¿m_bur¡_Œªsãr_time_ddr
, 
d¿m_tRCD
, 
d¿m_tCL
, 
d¿m_tRP
),

533 
this
, 
»que¡_šfo
, 
¡©ic_ÿ¡
<>Ôeque¡_šfo->
Ãxt_ev’t_ty³
));

534 
	gmemÜy_chªÃl_is_busy
 = 
Œue
;

535 
	gd¿m_executiÚ_li¡_tuº
 = 
»que¡_šfo
->
SŒ—m_id
;

539 
	gD©a_Cache_Mªag”_FÏsh_Advªûd
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev
)

541 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
 
ev’tTy³
 = (D©a_Cache_SimuÏtiÚ_Ev’t_Ty³)
ev
->
Ty³
;

542 
MemÜy_T¿nsãr_Info
* 
	gŒªsãr_šfo
 = (MemÜy_T¿nsãr_Info*)
ev
->
P¬am‘”s
;

544 
	gev’tTy³
)

546 
	gD©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_USERIO_FINISHED
:

547 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_USERIO_FINISHED
:

548 ((
U£r_Reque¡
*)(
Œªsãr_šfo
)->
R–©ed_»que¡
)->
SeùÜs_£rviûd_äom_ÿche
 -ğŒªsãr_šfo->
Size_š_by‹s
 / 
SECTOR_SIZE_IN_BYTE
;

549 ià(
is_u£r_»que¡_fšished
((
U£r_Reque¡
*)(
Œªsãr_šfo
)->
R–©ed_»que¡
))

550 
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(((
U£r_Reque¡
*)(
Œªsãr_šfo
)->
R–©ed_»que¡
));

552 
	gD©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_CACHE_EVICTION_FINISHED
:

553 
¡©ic_ÿ¡
<
FTL
*>(
nvm_fœmw¬e
)->
Add»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(*((
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>*)(
Œªsãr_šfo
->
R–©ed_»que¡
)));

554 
d–‘e
 (
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>*)
Œªsãr_šfo
->
R–©ed_»que¡
;

556 
	gD©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_CACHE_FINISHED
:

559 
d–‘e
 
	gŒªsãr_šfo
;

561 
	gmemÜy_chªÃl_is_busy
 = 
çl£
;

562 ià(
	gsh¬ed_d¿m_»que¡_queue
) {

563 ià(
	gd¿m_executiÚ_queue
[0].
size
() > 0) {

564 
MemÜy_T¿nsãr_Info
* 
	gŒªsãr_šfo
 = 
d¿m_executiÚ_queue
[0].
äÚt
();

565 
	gd¿m_executiÚ_queue
[0].
pİ
();

566 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_d¿m_acûss_time
(
Œªsãr_šfo
->
Size_š_by‹s
, 
d¿m_row_size
, 
d¿m_bu¤t_size
,

567 
d¿m_bur¡_Œªsãr_time_ddr
, 
d¿m_tRCD
, 
d¿m_tCL
, 
d¿m_tRP
),

568 
this
, 
Œªsãr_šfo
, 
¡©ic_ÿ¡
<>Ñ¿nsãr_šfo->
Ãxt_ev’t_ty³
));

569 
	gmemÜy_chªÃl_is_busy
 = 
Œue
;

572 
	gi
 = 0; i < 
	g¡»am_couÁ
; i++) {

573 
	gd¿m_executiÚ_li¡_tuº
++;

574 
	gd¿m_executiÚ_li¡_tuº
 %ğ
¡»am_couÁ
;

575 ià(
	gd¿m_executiÚ_queue
[
d¿m_executiÚ_li¡_tuº
].
size
() > 0) {

576 
MemÜy_T¿nsãr_Info
* 
	gŒªsãr_šfo
 = 
d¿m_executiÚ_queue
[
d¿m_executiÚ_li¡_tuº
].
äÚt
();

577 
	gd¿m_executiÚ_queue
[
d¿m_executiÚ_li¡_tuº
].
pİ
();

578 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_d¿m_acûss_time
(
Œªsãr_šfo
->
Size_š_by‹s
, 
d¿m_row_size
, 
d¿m_bu¤t_size
,

579 
d¿m_bur¡_Œªsãr_time_ddr
, 
d¿m_tRCD
, 
d¿m_tCL
, 
d¿m_tRP
),

580 
this
, 
Œªsãr_šfo
, 
¡©ic_ÿ¡
<>Ñ¿nsãr_šfo->
Ãxt_ev’t_ty³
));

581 
	gmemÜy_chªÃl_is_busy
 = 
Œue
;

	@src/ssd/Data_Cache_Manager_Flash_Advanced.h

1 #iâdeà
DATA_CACHE_MANAGER_FLASH_ADVANCED_H


2 
	#DATA_CACHE_MANAGER_FLASH_ADVANCED_H


	)

4 
	~<li¡
>

5 
	~<queue
>

6 
	~<unÜd”ed_m­
>

7 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

8 
	~"SSD_Defs.h
"

9 
	~"D©a_Cache_Mªag”_Ba£.h
"

10 
	~"D©a_Cache_FÏsh.h
"

11 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

13 
Çme¥aû
 
	gSSD_CompÚ’ts


29 şas 
	cD©a_Cache_Mªag”_FÏsh_Advªûd
 : 
public
 
D©a_Cache_Mªag”_Ba£


31 
public
:

32 
D©a_Cache_Mªag”_FÏsh_Advªûd
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
NVM_Fœmw¬e
* 
fœmw¬e
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

33 
tÙ®_ÿ·c™y_š_by‹s
,

34 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
sim_time_ty³
 
d¿m_tRCD
, sim_time_ty³ 
d¿m_tCL
, sim_time_ty³ 
d¿m_tRP
,

35 
Cachšg_Mode
* 
ÿchšg_mode_³r_šput_¡»am
, 
Cache_Sh¬šg_Mode
 
sh¬šg_mode
,

36 
¡»am_couÁ
, 
£ùÜ_no_³r_·ge
, 
back_´essu»_bufãr_max_d•th
);

37 ~
D©a_Cache_Mªag”_FÏsh_Advªûd
();

38 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev
);

39 
S‘up_Œigg”s
();

40 
Do_w¬mup
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
);

41 
	g´iv©e
:

42 
NVM_PHY_ONFI
 * 
æash_cÚŒŞËr
;

43 
	gÿ·c™y_š_by‹s
, 
	gÿ·c™y_š_·ges
;

44 
	g£ùÜ_no_³r_·ge
;

45 
D©a_Cache_FÏsh
** 
	g³r_¡»am_ÿche
;

46 
boŞ
 
	gmemÜy_chªÃl_is_busy
;

48 
´oûss_Ãw_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
);

49 
wr™e_to_de¡age_bufãr
(
U£r_Reque¡
* 
u£r_»que¡
);

50 
	g¡d
::
queue
<
MemÜy_T¿nsãr_Info
*>* 
d¿m_executiÚ_queue
;

51 
	g¡d
::
li¡
<
U£r_Reque¡
*>* 
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
;

52 
boŞ
 
	gsh¬ed_d¿m_»que¡_queue
;

53 
	gd¿m_executiÚ_li¡_tuº
;

54 
	gback_´essu»_bufãr_max_d•th
;

55 *
	gback_´essu»_bufãr_d•th
;

56 
	g¡d
::
£t
<
LPA_ty³
>* 
bloom_f‹r
;

57 
sim_time_ty³
 
	gbloom_f‹r_»£t_¡•
 = 1000000000;

58 
sim_time_ty³
 
	gÃxt_bloom_f‹r_»£t_me¡Úe
 = 0;

60 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

61 
£rviû_d¿m_acûss_»que¡
(
MemÜy_T¿nsãr_Info
* 
»que¡_šfo
);

	@src/ssd/Data_Cache_Manager_Flash_Simple.cpp

1 
	~<¡dexû±
>

2 
	~"../nvm_ch/NVM_Ty³s.h
"

3 
	~"D©a_Cache_Mªag”_FÏsh_Sim¶e.h
"

4 
	~"NVM_T¿n§ùiÚ_FÏsh_RD.h
"

5 
	~"NVM_T¿n§ùiÚ_FÏsh_WR.h
"

6 
	~"FTL.h
"

8 
Çme¥aû
 
	gSSD_CompÚ’ts


10 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
::
D©a_Cache_Mªag”_FÏsh_Sim¶e
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
NVM_Fœmw¬e
* 
fœmw¬e
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

11 
tÙ®_ÿ·c™y_š_by‹s
,

12 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
sim_time_ty³
 
d¿m_tRCD
, sim_time_ty³ 
d¿m_tCL
, sim_time_ty³ 
d¿m_tRP
,

13 
Cachšg_Mode
* 
ÿchšg_mode_³r_šput_¡»am
, 
¡»am_couÁ
, 
£ùÜ_no_³r_·ge
, 
back_´essu»_bufãr_max_d•th
)

14 : 
D©a_Cache_Mªag”_Ba£
(
id
, 
ho¡_š‹rçû
, 
fœmw¬e
, 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
d¿m_tRCD
, 
d¿m_tCL
, 
d¿m_tRP
, 
ÿchšg_mode_³r_šput_¡»am
, 
Cache_Sh¬šg_Mode
::
SHARED
, 
¡»am_couÁ
),

15 
æash_cÚŒŞËr
(æash_cÚŒŞËr), 
ÿ·c™y_š_by‹s
(
tÙ®_ÿ·c™y_š_by‹s
), 
£ùÜ_no_³r_·ge
(£ùÜ_no_³r_·ge), 
»que¡_queue_tuº
(0), 
back_´essu»_bufãr_max_d•th
(back_pressure_buffer_max_depth)

17 
	gÿ·c™y_š_·ges
 = 
ÿ·c™y_š_by‹s
 / (
SECTOR_SIZE_IN_BYTE
 * 
£ùÜ_no_³r_·ge
);

18 
	gÿ·c™y_š_·ges
=
ÿ·c™y_š_·ges
;

19 
	gd©a_ÿche
 = 
Ãw
 
D©a_Cache_FÏsh
(
ÿ·c™y_š_·ges
);

20 
	gd¿m_executiÚ_queue
 = 
Ãw
 
¡d
::
queue
<
MemÜy_T¿nsãr_Info
*>[
¡»am_couÁ
];

21 
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
 = 
Ãw
 
¡d
::
li¡
<
U£r_Reque¡
*>[
¡»am_couÁ
];

22 
	gthis
->
	gback_´essu»_bufãr_d•th
 = 0;

23 
	gbloom_f‹r
 = 
Ãw
 
¡d
::
£t
<
LPA_ty³
>[
¡»am_couÁ
];

26 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
::~
D©a_Cache_Mªag”_FÏsh_Sim¶e
()

28 
i
 = 0; 
	gi
 < 
	g¡»am_couÁ
; i++) {

29 
	gd¿m_executiÚ_queue
[
i
].
size
()) {

30 
d–‘e
 
	gd¿m_executiÚ_queue
[
i
].
äÚt
();

31 
	gd¿m_executiÚ_queue
[
i
].
pİ
();

33 autØ&
	g»q
 : 
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[
i
]) {

34 
d–‘e
 
»q
;

38 
d–‘e
 
	gd©a_ÿche
;

39 
	gd–‘e
[] 
	gd¿m_executiÚ_queue
;

40 
	gd–‘e
[] 
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
;

41 
	gd–‘e
[] 
	gbloom_f‹r
;

44 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
::
S‘up_Œigg”s
()

46 
D©a_Cache_Mªag”_Ba£
::
S‘up_Œigg”s
();

47 
	gæash_cÚŒŞËr
->
CÚÃùToT¿n§ùiÚS”viûdSigÇl
(
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
);

50 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
::
Do_w¬mup
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
)

54 
D©a_Cache_Mªag”_FÏsh_Sim¶e
::
´oûss_Ãw_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
)

57 ià(
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
size
() == 0) {

61 ià(
	gu£r_»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

62 
ÿchšg_mode_³r_šput_¡»am
[
u£r_»que¡
->
SŒ—m_id
])

64 
Cachšg_Mode
::
TURNED_OFF
:

65 
¡©ic_ÿ¡
<
FTL
*>(
nvm_fœmw¬e
)->
Add»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
u£r_»que¡
->
T¿n§ùiÚ_li¡
);

67 
	gCachšg_Mode
::
WRITE_CACHE
:

69 
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>::
™”©Ü
 
™
 = 
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
begš
();

70 
	g™
 !ğ
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
’d
()) {

71 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
Œ
 = (NVM_T¿n§ùiÚ_FÏsh_RD*)(*
™
);

72 ià(
	gd©a_ÿche
->
Exi¡s
(
Œ
->
SŒ—m_id
,r->
LPA
)) {

73 
·ge_¡©us_ty³
 
	gavaabË_£ùÜs_b™m­
 = 
d©a_ÿche
->
G‘_¦Ù
(
Œ
->
SŒ—m_id
,r->
LPA
).
	gS‹_b™m­_of_exi¡šg_£ùÜs
 & 
	gŒ
->
	g»ad_£ùÜs_b™m­
;

74 ià(
	gavaabË_£ùÜs_b™m­
 =ğ
Œ
->
»ad_£ùÜs_b™m­
) {

75 
u£r_»que¡
->
SeùÜs_£rviûd_äom_ÿche
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
Œ
->
»ad_£ùÜs_b™m­
);

76 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
”a£
(
™
++);

77 } ià(
	gavaabË_£ùÜs_b™m­
 != 0) {

78 
u£r_»que¡
->
SeùÜs_£rviûd_äom_ÿche
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
avaabË_£ùÜs_b™m­
);

79 
	gŒ
->
	g»ad_£ùÜs_b™m­
 = (
Œ
->
»ad_£ùÜs_b™m­
 & ~
avaabË_£ùÜs_b™m­
);

80 
	gŒ
->
	gD©a_ªd_m‘ad©a_size_š_by‹
 -ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
avaabË_£ùÜs_b™m­
è* 
SECTOR_SIZE_IN_BYTE
;

81 
	g™
++;

83 
	g™
++;

86 
	g™
++;

89 ià(
	gu£r_»que¡
->
	gSeùÜs_£rviûd_äom_ÿche
 > 0) {

90 
MemÜy_T¿nsãr_Info
* 
	gŒªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

91 
	gŒªsãr_šfo
->
	gSize_š_by‹s
 = 
u£r_»que¡
->
SeùÜs_£rviûd_äom_ÿche
 * 
SECTOR_SIZE_IN_BYTE
;

92 
	gŒªsãr_šfo
->
	gR–©ed_»que¡
 = 
u£r_»que¡
;

93 
	gŒªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_USERIO_FINISHED
;

94 
	gŒªsãr_šfo
->
	gSŒ—m_id
 = 
u£r_»que¡
->
SŒ—m_id
;

95 
£rviû_d¿m_acûss_»que¡
(
Œªsãr_šfo
);

97 ià(
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
size
() > 0) {

98 
	g¡©ic_ÿ¡
<
	gFTL
*>(
	gnvm_fœmw¬e
)->
	gAdd»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
u£r_»que¡
->
T¿n§ùiÚ_li¡
);

102 
PRINT_ERROR
("The specified caching mode is‚ot‚ot support in simple cache manager!")

105 
ÿchšg_mode_³r_šput_¡»am
[
u£r_»que¡
->
SŒ—m_id
])

107 
Cachšg_Mode
::
TURNED_OFF
:

108 
¡©ic_ÿ¡
<
FTL
*>(
nvm_fœmw¬e
)->
Add»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
u£r_»que¡
->
T¿n§ùiÚ_li¡
);

110 
	gCachšg_Mode
::
WRITE_CACHE
:

112 
wr™e_to_de¡age_bufãr
(
u£r_»que¡
);

114 ià(
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
size
() > 0) {

115 
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[
u£r_»que¡
->
SŒ—m_id
].
push_back
(user_request);

119 
PRINT_ERROR
("The specified caching mode is‚ot‚ot support in simple cache manager!")

124 
D©a_Cache_Mªag”_FÏsh_Sim¶e
::
wr™e_to_de¡age_bufãr
(
U£r_Reque¡
* 
u£r_»que¡
)

127 
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 = 0;

128 
	gæash_wr™‹n_back_wr™e_size_š_£ùÜs
 = 0;

129 
	gd¿m_wr™e_size_š_£ùÜs
 = 0;

130 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>* 
eviùed_ÿche_¦Ùs
 = 
Ãw
 
¡d
::list<NVM_Transaction*>;

131 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ
*> 
wr™eback_Œª§ùiÚs
;

132 autØ
	g™
 = 
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
begš
();

134 
	g™
 !ğ
u£r_»que¡
->
T¿n§ùiÚ_li¡
.
’d
()

135 && (
back_´essu»_bufãr_d•th
 + 
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 + 
æash_wr™‹n_back_wr™e_size_š_£ùÜs
è< 
back_´essu»_bufãr_max_d•th
) {

136 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
Œ
 = (NVM_T¿n§ùiÚ_FÏsh_WR*)(*
™
);

137 ià(
	gd©a_ÿche
->
Exi¡s
(
Œ
->
SŒ—m_id
,r->
LPA
))

141 
D©a_Cache_SlÙ_Ty³
 
	g¦Ù
 = 
d©a_ÿche
->
G‘_¦Ù
(
Œ
->
SŒ—m_id
,r->
LPA
);

142 
sim_time_ty³
 
	gtime¡amp
 = 
¦Ù
.
Time¡amp
;

143 
	gNVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
 = 
¦Ù
.
CÚ‹Á
;

144 ià(
	gŒ
->
	gD©aTimeSmp
 > 
	gtime¡amp
) {

145 
	gtime¡amp
 = 
Œ
->
D©aTimeSmp
;

146 
	gcÚ‹Á
 = 
Œ
->
CÚ‹Á
;

148 
	gd©a_ÿche
->
Upd©e_d©a
(
Œ
->
SŒ—m_id
,r->
LPA
, 
cÚ‹Á
, 
time¡amp
,r->
wr™e_£ùÜs_b™m­
 | 
¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
);

150 ià(!
	gd©a_ÿche
->
Check_ä“_¦Ù_avaab™y
()) {

151 
D©a_Cache_SlÙ_Ty³
 
	geviùed_¦Ù
 = 
d©a_ÿche
->
Eviù_Úe_¦Ù_Ìu
();

152 ià(
	geviùed_¦Ù
.
	gStus
 =ğ
Cache_SlÙ_Stus
::
DIRTY_NO_FLASH_WRITEBACK
) {

153 
eviùed_ÿche_¦Ùs
->
push_back
(
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
CACHE
,

154 
Œ
->
SŒ—m_id
, 
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
eviùed_¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
è* 
SECTOR_SIZE_IN_BYTE
,

155 
eviùed_¦Ù
.
LPA
, 
NULL
,ƒviùed_¦Ù.
CÚ‹Á
,ƒviùed_¦Ù.
S‹_b™m­_of_exi¡šg_£ùÜs
,ƒviùed_¦Ù.
Time¡amp
));

156 
	gÿche_eviùiÚ_»ad_size_š_£ùÜs
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
eviùed_¦Ù
.
S‹_b™m­_of_exi¡šg_£ùÜs
);

160 
	gd©a_ÿche
->
In£¹_wr™e_d©a
(
Œ
->
SŒ—m_id
,r->
LPA
,r->
CÚ‹Á
,r->
D©aTimeSmp
,r->
wr™e_£ùÜs_b™m­
);

162 
	gd¿m_wr™e_size_š_£ùÜs
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
Œ
->
wr™e_£ùÜs_b™m­
);

165 ià(
	gbloom_f‹r
[0].
fšd
(
Œ
->
LPA
è=ğ
bloom_f‹r
[0].
’d
()) {

166 
d©a_ÿche
->
Chªge_¦Ù_¡©us_to_wr™eback
(
Œ
->
SŒ—m_id
,r->
LPA
);

167 
	gæash_wr™‹n_back_wr™e_size_š_£ùÜs
 +ğ
couÁ_£ùÜ_no_äom_¡©us_b™m­
(
Œ
->
wr™e_£ùÜs_b™m­
);

168 
	gbloom_f‹r
[0].
š£¹
(
Œ
->
LPA
);

169 
	gwr™eback_Œª§ùiÚs
.
push_back
(
Œ
);

171 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
”a£
(
™
++);

174 
	gu£r_»que¡
->
	gSeùÜs_£rviûd_äom_ÿche
 +ğ
d¿m_wr™e_size_š_£ùÜs
;

175 
	gback_´essu»_bufãr_d•th
 +ğ
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 + 
æash_wr™‹n_back_wr™e_size_š_£ùÜs
;

178 ià(
	geviùed_ÿche_¦Ùs
->
size
() > 0) {

179 
MemÜy_T¿nsãr_Info
* 
	g»ad_Œªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

180 
	g»ad_Œªsãr_šfo
->
	gSize_š_by‹s
 = 
ÿche_eviùiÚ_»ad_size_š_£ùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

181 
	g»ad_Œªsãr_šfo
->
	gR–©ed_»que¡
 = 
eviùed_ÿche_¦Ùs
;

182 
	g»ad_Œªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_CACHE_EVICTION_FINISHED
;

183 
	g»ad_Œªsãr_šfo
->
	gSŒ—m_id
 = 
u£r_»que¡
->
SŒ—m_id
;

184 
£rviû_d¿m_acûss_»que¡
(
»ad_Œªsãr_šfo
);

188 ià(
	gd¿m_wr™e_size_š_£ùÜs
) {

189 
MemÜy_T¿nsãr_Info
* 
	gwr™e_Œªsãr_šfo
 = 
Ãw
 Memory_Transfer_Info;

190 
	gwr™e_Œªsãr_šfo
->
	gSize_š_by‹s
 = 
d¿m_wr™e_size_š_£ùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

191 
	gwr™e_Œªsãr_šfo
->
	gR–©ed_»que¡
 = 
u£r_»que¡
;

192 
	gwr™e_Œªsãr_šfo
->
	gÃxt_ev’t_ty³
 = 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_USERIO_FINISHED
;

193 
	gwr™e_Œªsãr_šfo
->
	gSŒ—m_id
 = 
u£r_»que¡
->
SŒ—m_id
;

194 
£rviû_d¿m_acûss_»que¡
(
wr™e_Œªsãr_šfo
);

198 ià(
	gwr™eback_Œª§ùiÚs
.
size
() > 0) {

199 
	g¡©ic_ÿ¡
<
	gFTL
*>(
	gnvm_fœmw¬e
)->
	gAdd»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(
wr™eback_Œª§ùiÚs
);

203 ià(
	gSimuÏtÜ
->
Time
(è> 
	gÃxt_bloom_f‹r_»£t_me¡Úe
) {

204 
	gbloom_f‹r
[0].
ş—r
();

205 
	gÃxt_bloom_f‹r_»£t_me¡Úe
 = 
SimuÏtÜ
->
Time
(è+ 
bloom_f‹r_»£t_¡•
;

209 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
::
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

212 ià(
Œª§ùiÚ
->
Sourû
 !ğ
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
 &&¿n§ùiÚ->Sourû !ğT¿n§ùiÚ_Sourû_Ty³::
CACHE
) {

216 ià(
	gŒª§ùiÚ
->
	gSourû
 =ğ
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
)

217 
_my_š¡ªû
->
brßdÿ¡_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl
(
Œª§ùiÚ
);

220 ià(
	gŒª§ùiÚ
->
	gTy³
 =ğ
T¿n§ùiÚ_Ty³
::
READ
) {

221 ià(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
 !ğ
NULL
) {

222 ((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
->
R–©edR—d
 = 
NULL
;

225 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
::
ÿchšg_mode_³r_šput_¡»am
[
Œª§ùiÚ
->
SŒ—m_id
])

227 
Cachšg_Mode
::
TURNED_OFF
:

228 
Cachšg_Mode
::
WRITE_CACHE
:

229 
Œª§ùiÚ
->
U£rIOReque¡
->
T¿n§ùiÚ_li¡
.
»move
(transaction);

230 ià(
	g_my_š¡ªû
->
is_u£r_»que¡_fšished
(
Œª§ùiÚ
->
U£rIOReque¡
)) {

231 
	g_my_š¡ªû
->
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(
Œª§ùiÚ
->
U£rIOReque¡
);

235 
PRINT_ERROR
("The specified caching mode is‚ot‚ot support in simple cache manager!")

238 
D©a_Cache_Mªag”_FÏsh_Sim¶e
::
ÿchšg_mode_³r_šput_¡»am
[
Œª§ùiÚ
->
SŒ—m_id
])

240 
Cachšg_Mode
::
TURNED_OFF
:

241 
Œª§ùiÚ
->
U£rIOReque¡
->
T¿n§ùiÚ_li¡
.
»move
(transaction);

242 ià(
	g_my_š¡ªû
->
is_u£r_»que¡_fšished
(
Œª§ùiÚ
->
U£rIOReque¡
)) {

243 
	g_my_š¡ªû
->
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(
Œª§ùiÚ
->
U£rIOReque¡
);

246 
	gCachšg_Mode
::
WRITE_CACHE
:

248 ((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
back_´essu»_bufãr_d•th
 -ğ
Œª§ùiÚ
->
D©a_ªd_m‘ad©a_size_š_by‹
 / 
SECTOR_SIZE_IN_BYTE
 + (transaction->Data_and_metadata_size_in_byte % SECTOR_SIZE_IN_BYTE == 0 ? 0 : 1);

250 ià(((
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
*)
	g_my_š¡ªû
)->
	gd©a_ÿche
->
Exi¡s
(
Œª§ùiÚ
->
SŒ—m_id
, ((
NVM_T¿n§ùiÚ_FÏsh_WR
*é¿n§ùiÚ)->
LPA
)) {

251 
D©a_Cache_SlÙ_Ty³
 
	g¦Ù
 = ((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
d©a_ÿche
->
G‘_¦Ù
(
Œª§ùiÚ
->
SŒ—m_id
, ((
NVM_T¿n§ùiÚ_FÏsh_WR
*é¿n§ùiÚ)->
LPA
);

252 
sim_time_ty³
 
	gtime¡amp
 = 
¦Ù
.
Time¡amp
;

253 
	gNVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
 = 
¦Ù
.
CÚ‹Á
;

254 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_WR
*)
	gŒª§ùiÚ
)->
	gD©aTimeSmp
 >ğ
time¡amp
) {

255 ((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
d©a_ÿche
->
Remove_¦Ù
(
Œª§ùiÚ
->
SŒ—m_id
, ((
NVM_T¿n§ùiÚ_FÏsh_WR
*é¿n§ùiÚ)->
LPA
);

259 
	gi
 = 0; i < 
	g_my_š¡ªû
->
	g¡»am_couÁ
; i++) {

260 ((
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
*)
	g_my_š¡ªû
)->
	g»que¡_queue_tuº
++;

261 ((
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
*)
	g_my_š¡ªû
)->
	g»que¡_queue_tuº
 %ğ((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
¡»am_couÁ
;

262 ià(((
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
*)
	g_my_š¡ªû
)->
	gwa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
»que¡_queue_tuº
].
size
() > 0) {

263 autØ
	gu£r_»que¡
 = ((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[((D©a_Cache_Mªag”_FÏsh_Sim¶e*)_my_š¡ªû)->
»que¡_queue_tuº
].
begš
();

264 ((
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
*)
	g_my_š¡ªû
)->
wr™e_to_de¡age_bufãr
(*
u£r_»que¡
);

265 ià((*
	gu£r_»que¡
)->
	gT¿n§ùiÚ_li¡
.
size
() == 0) {

266 ((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
[((D©a_Cache_Mªag”_FÏsh_Sim¶e*)_my_š¡ªû)->
»que¡_queue_tuº
].
»move
(*
u£r_»que¡
);

269 ià(((
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
*)
	g_my_š¡ªû
)->
	gback_´essu»_bufãr_d•th
 >ğ((
D©a_Cache_Mªag”_FÏsh_Sim¶e
*)
_my_š¡ªû
)->
back_´essu»_bufãr_max_d•th
) {

277 
PRINT_ERROR
("The specified caching mode is‚ot‚ot support in simple cache manager!")

282 
D©a_Cache_Mªag”_FÏsh_Sim¶e
::
£rviû_d¿m_acûss_»que¡
(
MemÜy_T¿nsãr_Info
* 
»que¡_šfo
)

284 
d¿m_executiÚ_queue
[
»que¡_šfo
->
SŒ—m_id
].
push
(request_info);

285 if(
	gd¿m_executiÚ_queue
[
»que¡_šfo
->
SŒ—m_id
].
size
() == 1) {

286 
SimuÏtÜ
->
Regi¡”_sim_ev’t
(SimuÏtÜ->
Time
(è+ 
e¡im©e_d¿m_acûss_time
(
»que¡_šfo
->
Size_š_by‹s
, 
d¿m_row_size
,

287 
d¿m_bu¤t_size
, 
d¿m_bur¡_Œªsãr_time_ddr
, 
d¿m_tRCD
, 
d¿m_tCL
, 
d¿m_tRP
),

288 
this
, 
»que¡_šfo
, 
¡©ic_ÿ¡
<>Ôeque¡_šfo->
Ãxt_ev’t_ty³
));

292 
	gD©a_Cache_Mªag”_FÏsh_Sim¶e
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev
)

294 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
 
ev’tTy³
 = (D©a_Cache_SimuÏtiÚ_Ev’t_Ty³)
ev
->
Ty³
;

295 
MemÜy_T¿nsãr_Info
* 
	gŒªsãr_šf
 = (MemÜy_T¿nsãr_Info*)
ev
->
P¬am‘”s
;

297 
	gev’tTy³
)

299 
	gD©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_USERIO_FINISHED
:

300 
D©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_USERIO_FINISHED
:

301 ((
U£r_Reque¡
*)(
Œªsãr_šf
)->
R–©ed_»que¡
)->
SeùÜs_£rviûd_äom_ÿche
 -ğŒªsãr_šf->
Size_š_by‹s
 / 
SECTOR_SIZE_IN_BYTE
;

302 ià(
is_u£r_»que¡_fšished
((
U£r_Reque¡
*)(
Œªsãr_šf
)->
R–©ed_»que¡
)) {

303 
brßdÿ¡_u£r_»que¡_£rviûd_sigÇl
(((
U£r_Reque¡
*)(
Œªsãr_šf
)->
R–©ed_»que¡
));

306 
	gD©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_READ_FOR_CACHE_EVICTION_FINISHED
:

307 
¡©ic_ÿ¡
<
FTL
*>(
nvm_fœmw¬e
)->
Add»ss_M­pšg_Un™
->
T¿n¦©e_Ía_to_µa_ªd_di¥©ch
(*((
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>*)(
Œªsãr_šf
->
R–©ed_»que¡
)));

308 
d–‘e
 (
¡d
::
li¡
<
NVM_T¿n§ùiÚ
*>*)
Œªsãr_šf
->
R–©ed_»que¡
;

310 
	gD©a_Cache_SimuÏtiÚ_Ev’t_Ty³
::
MEMORY_WRITE_FOR_CACHE_FINISHED
:

314 
	gd¿m_executiÚ_queue
[
Œªsãr_šf
->
SŒ—m_id
].
pİ
();

315 ià(
	gd¿m_executiÚ_queue
[
Œªsãr_šf
->
SŒ—m_id
].
size
() > 0) {

316 
MemÜy_T¿nsãr_Info
* 
	gÃw_Œªsãr_šfo
 = 
d¿m_executiÚ_queue
[
Œªsãr_šf
->
SŒ—m_id
].
äÚt
();

317 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
e¡im©e_d¿m_acûss_time
(
Ãw_Œªsãr_šfo
->
Size_š_by‹s
, 
d¿m_row_size
, 
d¿m_bu¤t_size
,

318 
d¿m_bur¡_Œªsãr_time_ddr
, 
d¿m_tRCD
, 
d¿m_tCL
, 
d¿m_tRP
),

319 
this
, 
Ãw_Œªsãr_šfo
, 
¡©ic_ÿ¡
<>Òew_Œªsãr_šfo->
Ãxt_ev’t_ty³
));

322 
d–‘e
 
	gŒªsãr_šf
;

	@src/ssd/Data_Cache_Manager_Flash_Simple.h

1 #iâdeà
DATA_CACHE_MANAGER_FLASH_SIMPLE_H


2 
	#DATA_CACHE_MANAGER_FLASH_SIMPLE_H


	)

4 
	~<li¡
>

5 
	~<queue
>

6 
	~<unÜd”ed_m­
>

7 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

8 
	~"SSD_Defs.h
"

9 
	~"D©a_Cache_Mªag”_Ba£.h
"

10 
	~"D©a_Cache_FÏsh.h
"

11 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

13 
Çme¥aû
 
	gSSD_CompÚ’ts


15 şas 
	cD©a_Cache_Mªag”_FÏsh_Sim¶e
 : 
public
 
D©a_Cache_Mªag”_Ba£


17 
public
:

18 
D©a_Cache_Mªag”_FÏsh_Sim¶e
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
NVM_Fœmw¬e
* 
fœmw¬e
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

19 
tÙ®_ÿ·c™y_š_by‹s
,

20 
d¿m_row_size
, 
d¿m_d©a_¿‹
, 
d¿m_bu¤t_size
, 
sim_time_ty³
 
d¿m_tRCD
, sim_time_ty³ 
d¿m_tCL
, sim_time_ty³ 
d¿m_tRP
,

21 
Cachšg_Mode
* 
ÿchšg_mode_³r_šput_¡»am
, 
¡»am_couÁ
, 
£ùÜ_no_³r_·ge
, 
back_´essu»_bufãr_max_d•th
);

22 ~
D©a_Cache_Mªag”_FÏsh_Sim¶e
();

23 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev
);

24 
S‘up_Œigg”s
();

25 
Do_w¬mup
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
);

26 
	g´iv©e
:

27 
NVM_PHY_ONFI
 * 
æash_cÚŒŞËr
;

28 
	gÿ·c™y_š_by‹s
, 
	gÿ·c™y_š_·ges
;

29 
	g£ùÜ_no_³r_·ge
;

30 
D©a_Cache_FÏsh
* 
	gd©a_ÿche
;

32 
´oûss_Ãw_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
);

33 
wr™e_to_de¡age_bufãr
(
U£r_Reque¡
* 
u£r_»que¡
);

34 
	g¡d
::
queue
<
MemÜy_T¿nsãr_Info
*>* 
d¿m_executiÚ_queue
;

35 
	g¡d
::
li¡
<
U£r_Reque¡
*>* 
wa™šg_u£r_»que¡s_queue_fÜ_d¿m_ä“_¦Ù
;

36 
	g»que¡_queue_tuº
;

37 
	gback_´essu»_bufãr_max_d•th
;

38 
	gback_´essu»_bufãr_d•th
;

39 
	g¡d
::
£t
<
LPA_ty³
>* 
bloom_f‹r
;

40 
sim_time_ty³
 
	gbloom_f‹r_»£t_¡•
 = 1000000000;

41 
sim_time_ty³
 
	gÃxt_bloom_f‹r_»£t_me¡Úe
 = 0;

43 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

44 
£rviû_d¿m_acûss_»que¡
(
MemÜy_T¿nsãr_Info
* 
»que¡_šfo
);

	@src/ssd/FTL.cpp

1 
	~<¡dexû±
>

2 
	~<cm©h
>

3 
	~<veùÜ
>

4 
	~<¿ndom
>

5 
	~<m­
>

6 
	~<funùiÚ®
>

7 
	~<™”©Ü
>

8 
	~"../sim/Sim_Defs.h
"

9 
	~"../uts/Di¡ributiÚTy³s.h
"

10 
	~"../uts/H–³r_FunùiÚs.h
"

11 
	~"FTL.h
"

12 
	~"Sts.h
"

13 
	~"Add»ss_M­pšg_Un™_Page_Lev–.h
"

14 
Çme¥aû
 
	gSSD_CompÚ’ts


16 
	gFTL
::
FTL
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
D©a_Cache_Mªag”_Ba£
* 
d©a_ÿche_mªag”
,

17 
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

18 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
·ge_size_š_£ùÜs
,

19 
sim_time_ty³
 
avg_æash_»ad_Ï‹ncy
, sim_time_ty³ 
avg_æash_´og¿m_Ï‹ncy
,

20 
ov”_´ovisiÚšg_¿tio
, 
max_®lowed_block_”a£_couÁ
, 
£ed
) :

21 
NVM_Fœmw¬e
(
id
, 
d©a_ÿche_mªag”
), 
¿ndom_g’”©Ü
(
£ed
),

22 
chªÃl_no
(chªÃl_no), 
ch_no_³r_chªÃl
(ch_no_³r_chªÃl), 
d›_no_³r_ch
(d›_no_³r_ch), 
¶ªe_no_³r_d›
(plane_no_per_die),

23 
block_no_³r_¶ªe
(block_no_³r_¶ªe), 
·ge_no_³r_block
Õage_no_³r_block), 
·ge_size_š_£ùÜs
(page_size_in_sectors),

24 
avg_æash_»ad_Ï‹ncy
×vg_æash_»ad_Ï‹ncy), 
avg_æash_´og¿m_Ï‹ncy
(avg_flash_program_latency),

25 
ov”_´ovisiÚšg_¿tio
(ov”_´ovisiÚšg_¿tio), 
max_®lowed_block_”a£_couÁ
(max_allowed_block_erase_count)

29 
	gSts
::
In™_¡©s
(
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
, 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
max_®lowed_block_”a£_couÁ
);

33 
	gFTL
::~
FTL
()

35 
Sts
::
CË¬_¡©s
(
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
, 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
max_®lowed_block_”a£_couÁ
);

39 
	gFTL
::
V®id©e_simuÏtiÚ_cÚfig
()

41 
NVM_Fœmw¬e
::
V®id©e_simuÏtiÚ_cÚfig
();

42 ià(
	gthis
->
	gD©a_ÿche_mªag”
 =ğ
NULL
)

43 
throw
 
¡d
::
logic_”rÜ
("The cache manager is‚ot set for FTL!");

44 ià(
	gthis
->
	gAdd»ss_M­pšg_Un™
 =ğ
NULL
)

45 
throw
 
¡d
::
logic_”rÜ
("The mapping module is‚ot set for FTL!");

46 ià(
	gthis
->
	gBlockMªag”
 =ğ
NULL
)

47 
throw
 
¡d
::
logic_”rÜ
("The block manager is‚ot set for FTL!");

48 ià(
	gthis
->
	gGC_ªd_WL_Un™
 =ğ
NULL
)

49 
throw
 
¡d
::
logic_”rÜ
("The garbage collector is‚ot set for FTL!");

52 
	gFTL
::
P”fÜm_´ecÚd™iÚ
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
)

54 
Add»ss_M­pšg_Un™
->
StÜe_m­pšg_bË_Ú_æash_©_¡¬t
();

56 
	gov”®l_¿‹
 = 0;

57 autØcÚ¡ &
	g¡©
 : 
wÜklßd_¡©s
)

59 ià(
¡©
->
Ty³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
)

61 
¡©
->
g’”©Ü_ty³
)

63 
Uts
::
Reque¡_G’”©Ü_Ty³
::
BANDWIDTH
:

64 
ov”®l_¿‹
 +ğ1.0 / (
¡©
->
Av”age_š‹r_¬riv®_time_Çno_£c
è* 
SIM_TIME_TO_SECONDS_COEFF
 * st->
Av”age_»que¡_size_£ùÜ
;

66 
	gUts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
:

68 
sim_time_ty³
 
max_¬riv®_time
 = sim_time_ty³(
¡©
->
R—d_¿tio
 * (
avg_æash_»ad_Ï‹ncy
è+ (1 - st->R—d_¿tioè* (
avg_æash_´og¿m_Ï‹ncy
));

69 
	gavg_¬riv®_time
 = (
max_¬riv®_time
è/ (
¡©
->
Reque¡_queue_d•th
);

70 
	gov”®l_¿‹
 +ğ1.0 / 
avg_¬riv®_time
 * 
SIM_TIME_TO_SECONDS_COEFF
 * 
¡©
->
Av”age_»que¡_size_£ùÜ
;

74 
PRINT_ERROR
("Unknown„equestype generator inhe FTL…reconditioning function.")

79 
ov”®l_¿‹
 +ğ1.0 / (
¡©
->
Av”age_š‹r_¬riv®_time_Çno_£c
è* 
SIM_TIME_TO_SECONDS_COEFF
 * st->
Av”age_»que¡_size_£ùÜ
;

83 
	gtÙ®_acûs£d_cmt_’Œ›s
 = 0;

85 autØ&
	g¡©
 : 
wÜklßd_¡©s
)

87 
LPA_ty³
 
no_of_logiÿl_·ges_š_¡—dy¡©e
 = (LPA_ty³)(
¡©
->
In™Ÿl_occu·ncy_¿tio
 * 
Add»ss_M­pšg_Un™
->
G‘_logiÿl_·ges_couÁ
(¡©->
SŒ—m_id
));

90 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
 
decisiÚ_di¡_ty³
 = 
¡©
->
Add»ss_di¡ributiÚ_ty³
;

91 
	g¡d
::
m­
<
LPA_ty³
, 
	g·ge_¡©us_ty³
> 
	gÍa_£t_fÜ_´ecÚd™iÚšg
;

92 
	g¡d
::
muÉim­
<, 
	gLPA_ty³
, std::
g»©”
<>> 
Œaû_Ías_sÜ‹d_hi¡og¿m
;

93 
	ghÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
 = 0;

94 
LHA_ty³
 
	gmš_lha
 = 
¡©
->
Mš_LHA
;

95 
LHA_ty³
 
	gmax_lha
 = 
¡©
->
Max_LHA
 - 1;

96 
LPA_ty³
 
	gmš_Ía
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
mš_lha
);

97 ià(
	g¡©
->
	gg’”©e_®igÃd_add»s£s
)

99 ià(
	gmš_lha
 % 
	g¡©
->
	g®ignm’t_v®ue
 != 0)

100 
mš_lha
 +ğ
¡©
->
®ignm’t_v®ue
 - (min_lha % stat->alignment_value);

101 ià(
	gmax_lha
 % 
	g¡©
->
	g®ignm’t_v®ue
 != 0)

102 
max_lha
 -ğ
mš_lha
 % 
¡©
->
®ignm’t_v®ue
;

105 
LPA_ty³
 
	gmax_Ía
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
max_lha
) - 1;

106 
	gtÙ®_acûs£d_cmt_’Œ›s
 +ğ()(
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
max_lha
è/ 
·ge_size_š_£ùÜs
 - CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss(
mš_lha
) /…age_size_in_sectors) + 1;

107 
boŞ
 
	ghÙ_¿nge_fšished
 = 
çl£
;

108 
LHA_ty³
 
	ghÙ_»giÚ_’d_l§
 = 0, 
	ghÙ_lha_u£d_fÜ_g’”©iÚ
 = 0;

109 
LPA_ty³
 
	gÏ¡_hÙ_Ía
 = 0;

112 ià(
	g¡©
->
	gTy³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
)

114 
boŞ
 
is_»ad
 = 
çl£
;

115 
	gsize
 = 0;

116 
LHA_ty³
 
	g¡¬t_LBA
 = 0, 
	g¡»amšg_Ãxt_add»ss
 = 0;

117 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_»que¡_ty³_g’”©Ü
 = 
Ãw
 
Uts
::RªdomG’”©Ü(
¡©
->
¿ndom_»que¡_ty³_g’”©Ü_£ed
);

118 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_add»ss_g’”©Ü
 = 
Ãw
 
Uts
::RªdomG’”©Ü(
¡©
->
¿ndom_add»ss_g’”©Ü_£ed
);

119 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_hÙ_add»ss_g’”©Ü
 = 
NULL
;

120 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_hÙ_cŞd_g’”©Ü
 = 
NULL
;

121 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_»que¡_size_g’”©Ü
 = 
NULL
;

122 
boŞ
 
	gfuÎy_šşude_hÙ_add»s£s
 = 
çl£
;

124 ià(
	g¡©
->
	gAdd»ss_di¡ributiÚ_ty³
 =ğ
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
)

125 ià(
¡©
->
R©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
 > 0.3)

126 
decisiÚ_di¡_ty³
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
;

130 
	gdecisiÚ_di¡_ty³
)

132 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

134 
¿ndom_hÙ_add»ss_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¡©
->
¿ndom_hÙ_add»ss_g’”©Ü_£ed
);

135 
	g¿ndom_hÙ_cŞd_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¡©
->
¿ndom_hÙ_cŞd_g’”©Ü_£ed
);

136 
	ghÙ_»giÚ_’d_l§
 = 
mš_lha
 + (
LHA_ty³
)(()(
max_lha
 - mš_lhaè* 
¡©
->
R©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
);

137 
	gÏ¡_hÙ_Ía
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
hÙ_»giÚ_’d_l§
) - 1;

138 
	ghÙ_lha_u£d_fÜ_g’”©iÚ
 = 
mš_lha
;

140 ià((
	gÏ¡_hÙ_Ía
 - 
	gmš_Ía
è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
)

141 
	gfuÎy_šşude_hÙ_add»s£s
 = 
Œue
;

142 ià((
	gmax_Ía
 - 
	gÏ¡_hÙ_Ía
è< 1.1 * (
	gno_of_logiÿl_·ges_š_¡—dy¡©e
 - (Ï¡_hÙ_Í¨- 
	gmš_Ía
)))

144 
PRINT_MESSAGE
("Th¥ecif›d in™ŸÈoccu·ncy v®ucould‚Ù b§tisf›d‡ thwÜkšg s‘ oàwÜklßd #" << 
¡©
->
SŒ—m_id
 << " is small. MQSim made some‡djustments!");

145 
	gmax_lha
 = 
mš_lha
 + 
LHA_ty³
((
max_lha
 - mš_lhaè/ 
¡©
->
WÜkšg_£t_¿tio
);

146 ià(
	g¡©
->
	gg’”©e_®igÃd_add»s£s
)

147 ià(
	gmax_lha
 % 
	g¡©
->
	g®ignm’t_v®ue
 != 0)

148 
max_lha
 -ğ
mš_lha
 % 
¡©
->
®ignm’t_v®ue
;

150 
	gmax_Ía
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
max_lha
);

154 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

156 
¡»amšg_Ãxt_add»ss
 = 
¿ndom_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
mš_lha
, 
max_lha
);

157 
	g¡©
->
	gFœ¡_Acûs£d_Add»ss
 = 
¡»amšg_Ãxt_add»ss
;

159 ià((
	gmax_Ía
 - 
	gmš_Ía
è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
)

161 
PRINT_MESSAGE
("Th¥ecif›d in™ŸÈoccu·ncy v®ucould‚Ù b§tisf›d‡ thwÜkšg s‘ oàwÜklßd #" << 
¡©
->
SŒ—m_id
 << " is small. MQSim made some‡djustments!");

162 
	gmax_lha
 = 
mš_lha
 + 
LHA_ty³
((
max_lha
 - mš_lhaè/ 
¡©
->
WÜkšg_£t_¿tio
);

163 ià(
	g¡©
->
	gg’”©e_®igÃd_add»s£s
)

164 ià(
	gmax_lha
 % 
	g¡©
->
	g®ignm’t_v®ue
 != 0)

165 
max_lha
 -ğ
mš_lha
 % 
¡©
->
®ignm’t_v®ue
;

166 
	gmax_Ía
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
max_lha
);

168 ià((
	gmax_Ía
 - 
	gmš_Ía
è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
)

169 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
 = 
max_Ía
 - 
mš_Ía
 + 1;

173 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

176 ià((
max_Ía
 - 
mš_Ía
è< 1.1 * 
no_of_logiÿl_·ges_š_¡—dy¡©e
)

178 
PRINT_MESSAGE
("Th¥ecif›d in™ŸÈoccu·ncy v®ucould‚Ù b§tisf›d‡ thwÜkšg s‘ oàwÜklßd #" << 
¡©
->
SŒ—m_id
 << " is small. MQSim made some‡djustments!");

179 
	gmax_lha
 = 
mš_lha
 + 
LHA_ty³
((
max_lha
 - mš_lhaè/ 
¡©
->
WÜkšg_£t_¿tio
);

180 ià(
	g¡©
->
	gg’”©e_®igÃd_add»s£s
)

181 ià(
	gmax_lha
 % 
	g¡©
->
	g®ignm’t_v®ue
 != 0)

182 
max_lha
 -ğ
mš_lha
 % 
¡©
->
®ignm’t_v®ue
;

183 
	gmax_Ía
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
max_lha
);

185 ià((
	gmax_Ía
 - 
	gmš_Ía
è< 1.1 * 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
)

187 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
 = ()((
max_Ía
 - 
mš_Ía
) * 0.9);

194 ià(
	g¡©
->
	gReque¡_size_di¡ributiÚ_ty³
 =ğ
Uts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
NORMAL
)

196 
¿ndom_»que¡_size_g’”©Ü
 = 
Ãw
 
Uts
::
RªdomG’”©Ü
(
¡©
->
¿ndom_»que¡_size_g’”©Ü_£ed
);

199 
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
size
(è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
)

201 ià(
	g¿ndom_»que¡_ty³_g’”©Ü
->
UnifÜm
(0, 1è<ğ
¡©
->
R—d_¿tio
)

202 
is_»ad
 = 
Œue
;

204 
	g¡©
->
	gReque¡_size_di¡ributiÚ_ty³
)

206 
	gUts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
FIXED
:

207 
size
 = 
¡©
->
Av”age_»que¡_size_£ùÜ
;

209 
	gUts
::
Reque¡_Size_Di¡ributiÚ_Ty³
::
NORMAL
:

211 
‹mp_»que¡_size
 = 
¿ndom_»que¡_size_g’”©Ü
->
NÜm®
(
¡©
->
Av”age_»que¡_size_£ùÜ
, st->
STDEV_»uqe¡_size
);

212 
	gsize
 = ()(
¡d
::
û
(
‹mp_»que¡_size
));

213 ià(
	gsize
 <= 0)

214 
size
 = 1;

219 
boŞ
 
	gis_hÙ_add»ss
 = 
çl£
;

221 
	gdecisiÚ_di¡_ty³
)

223 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

224 
¡¬t_LBA
 = 
¡»amšg_Ãxt_add»ss
;

225 ià(
	g¡¬t_LBA
 + 
	gsize
 > 
	gmax_lha
)

226 
	g¡¬t_LBA
 = 
mš_lha
;

227 
	g¡»amšg_Ãxt_add»ss
 +ğ
size
;

228 ià(
	g¡»amšg_Ãxt_add»ss
 > 
	gmax_lha
)

229 
	g¡»amšg_Ãxt_add»ss
 = 
mš_lha
;

230 ià(
	g¡©
->
	gg’”©e_®igÃd_add»s£s
)

231 ià(
	g¡»amšg_Ãxt_add»ss
 % 
	g¡©
->
	g®ignm’t_v®ue
 != 0)

232 
¡»amšg_Ãxt_add»ss
 +ğ
¡©
->
®ignm’t_v®ue
 - (streaming_next_address % stat->alignment_value);

234 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

236 ià(
fuÎy_šşude_hÙ_add»s£s
)

238 ià(!
hÙ_¿nge_fšished
)

240 
¡¬t_LBA
 = 
hÙ_lha_u£d_fÜ_g’”©iÚ
;

241 
	ghÙ_lha_u£d_fÜ_g’”©iÚ
 +ğ
size
;

242 ià(
	g¡¬t_LBA
 > 
	ghÙ_»giÚ_’d_l§
)

243 
	ghÙ_¿nge_fšished
 = 
Œue
;

244 
	gis_hÙ_add»ss
 = 
Œue
;

248 
	g¡¬t_LBA
 = 
¿ndom_hÙ_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
hÙ_»giÚ_’d_l§
 + 1, 
max_lha
);

249 ià(
	g¡¬t_LBA
 < 
	ghÙ_»giÚ_’d_l§
 + 1 || s¹_LBA > 
	gmax_lha
)

250 
PRINT_ERROR
("Out of„ange‡ddress is generated in IO_Flow_Synthetic!\n")

251 ià(
	g¡¬t_LBA
 + 
	gsize
 > 
	gmax_lha
)

252 
	g¡¬t_LBA
 = 
hÙ_»giÚ_’d_l§
 + 1;

253 
	gis_hÙ_add»ss
 = 
çl£
;

258 ià(
	g¿ndom_hÙ_cŞd_g’”©Ü
->
UnifÜm
(0, 1è< 
	g¡©
->
	gR©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
)

260 
	g¡¬t_LBA
 = 
¿ndom_hÙ_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
hÙ_»giÚ_’d_l§
 + 1, 
max_lha
);

261 ià(
	g¡¬t_LBA
 < 
	ghÙ_»giÚ_’d_l§
 + 1 || s¹_LBA > 
	gmax_lha
)

262 
PRINT_ERROR
("Out of„ange‡ddress is generated in IO_Flow_Synthetic!\n")

263 ià(
	g¡¬t_LBA
 + 
	gsize
 > 
	gmax_lha
)

264 
	g¡¬t_LBA
 = 
hÙ_»giÚ_’d_l§
 + 1;

265 
	gis_hÙ_add»ss
 = 
çl£
;

269 
	g¡¬t_LBA
 = 
¿ndom_hÙ_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
mš_lha
, 
hÙ_»giÚ_’d_l§
);

270 ià(
	g¡¬t_LBA
 < 
	gmš_lha
 || s¹_LBA > 
	ghÙ_»giÚ_’d_l§
)

271 
PRINT_ERROR
("Out of„ange‡ddress is generated in IO_Flow_Synthetic!\n")

272 
	gis_hÙ_add»ss
 = 
Œue
;

277 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

278 
¡¬t_LBA
 = 
¿ndom_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
mš_lha
, 
max_lha
);

279 ià(
	g¡¬t_LBA
 < 
	gmš_lha
 || 
	gmax_lha
 < start_LBA)

280 
PRINT_ERROR
("Out of„ange‡ddress is generated in IO_Flow_Synthetic!\n")

281 ià(
	g¡¬t_LBA
 + 
	gsize
 > 
	gmax_lha
)

282 
	g¡¬t_LBA
 = 
mš_lha
;

286 ià(
	g¡©
->
	gg’”©e_®igÃd_add»s£s
)

287 
	g¡¬t_LBA
 -ğ
¡¬t_LBA
 % 
¡©
->
®ignm’t_v®ue
;

290 
	ghªdËd_£ùÜs_couÁ
 = 0;

291 
LHA_ty³
 
	gl§
 = 
¡¬t_LBA
 - 
mš_lha
;

292 
	gŒª§ùiÚ_size
 = 0;

293 
·ge_¡©us_ty³
 
	gacûss_¡©us_b™m­
 = 0;

294 
LPA_ty³
 
	gmax_Ía_w™hš_deviû
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
¡©
->
Max_LHA
è- CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss(¡©->
Mš_LHA
);

295 
	ghªdËd_£ùÜs_couÁ
 < 
	gsize
)

297 
	gŒª§ùiÚ_size
 = 
·ge_size_š_£ùÜs
 - ()(
l§
 %…age_size_in_sectors);

298 ià(
	ghªdËd_£ùÜs_couÁ
 + 
	gŒª§ùiÚ_size
 >ğ
size
)

300 
Œª§ùiÚ_size
 = 
size
 - 
hªdËd_£ùÜs_couÁ
;

302 
LPA_ty³
 
	gÍa
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
l§
);

303 
·ge_¡©us_ty³
 
	gacûss_¡©us_b™m­
 = 
Fšd_NVM_subun™_acûss_b™m­
(
l§
);

305 
	gl§
 = 
l§
 + 
Œª§ùiÚ_size
;

306 
	ghªdËd_£ùÜs_couÁ
 +ğ
Œª§ùiÚ_size
;

308 ià(
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
fšd
(
Ía
è=ğ
Ía_£t_fÜ_´ecÚd™iÚšg
.
’d
()) {

309 
Ía_£t_fÜ_´ecÚd™iÚšg
[
Ía
] = 
acûss_¡©us_b™m­
;

311 ià(
	gÍa
 <ğ
max_Ía_w™hš_deviû
) {

312 ià(!
is_hÙ_add»ss
 && 
hÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
 == 0) {

313 
hÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
 = ()(
Œaû_Ías_sÜ‹d_hi¡og¿m
.
size
());

315 
	g¡d
::
·œ
<, 
	gLPA_ty³
> 
’Œy
((
is_hÙ_add»ss
 ? 1000 : 1), 
Ía
);

316 
	gŒaû_Ías_sÜ‹d_hi¡og¿m
.
š£¹
(
’Œy
);

319 
	gÍa_£t_fÜ_´ecÚd™iÚšg
[
Ía
] = 
acûss_¡©us_b™m­
 | 
Ía_£t_fÜ_´ecÚd™iÚšg
[lpa];

325 autØ
	g™r
 = 
¡©
->
Wr™e_»ad_sh¬ed_add»s£s
.
begš
(); iŒ !ğ¡©->Wr™e_»ad_sh¬ed_add»s£s.
’d
(); itr++) {

326 
LPA_ty³
 
	gÍa
 = (*
™r
);

327 ià(
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
size
(è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
) {

328 
	gÍa_£t_fÜ_´ecÚd™iÚšg
[
Ía
] = 
¡©
->
Wr™e_add»ss_acûss_·‰”n
[Ía].
Acûs£d_sub_un™s
 | st->
R—d_add»ss_acûss_·‰”n
[lpa].Accessed_sub_units;

334 autØ
	g™r
 = 
¡©
->
R—d_add»ss_acûss_·‰”n
.
begš
(); iŒ !ğ¡©->R—d_add»ss_acûss_·‰”n.
’d
(); itr++) {

335 
LPA_ty³
 
	gÍa
 = (*
™r
).
fœ¡
;

336 ià(
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
size
(è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
) {

337 ià(
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
fšd
(
Ía
è=ğ
Ía_£t_fÜ_´ecÚd™iÚšg
.
’d
()) {

338 
Ía_£t_fÜ_´ecÚd™iÚšg
[
Ía
] = 
¡©
->
R—d_add»ss_acûss_·‰”n
[Ía].
Acûs£d_sub_un™s
;

347 autØ
	g™r
 = 
¡©
->
Wr™e_add»ss_acûss_·‰”n
.
begš
(); iŒ !ğ¡©->Wr™e_add»ss_acûss_·‰”n.
’d
(); itr++) {

348 
LPA_ty³
 
	gÍa
 = (*
™r
).
fœ¡
;

349 ià(
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
size
(è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
) {

350 ià(
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
fšd
(
Ía
è=ğ
Ía_£t_fÜ_´ecÚd™iÚšg
.
’d
()) {

351 
Ía_£t_fÜ_´ecÚd™iÚšg
[
Ía
] = 
¡©
->
Wr™e_add»ss_acûss_·‰”n
[Ía].
Acûs£d_sub_un™s
;

354 
	g¡d
::
·œ
<, 
	gLPA_ty³
> 
’Œy
((*
™r
).
£cÚd
.
Acûss_couÁ
, 
Ía
);

355 
	gŒaû_Ías_sÜ‹d_hi¡og¿m
.
š£¹
(
’Œy
);

359 
	g¡©
->
	gAdd»ss_di¡ributiÚ_ty³
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
;

362 ià(
	g¡©
->
	gWr™e_add»ss_acûss_·‰”n
.
size
(è> 
	gSTATISTICALLY_SUFFICIENT_WRITES_FOR_PRECONDITIONING
) {

363 
	ghÙ_»giÚ_wr™e_couÁ
 = 0;

364 
	g´ev_v®ue
 = (*
Œaû_Ías_sÜ‹d_hi¡og¿m
.
begš
()).
fœ¡
;

365 
	gf_‹mp
 = 0;

366 
	gr_‹mp
 = 0;

367 
	g¡•
 = 0.01;

368 
	gÃxt_me¡Úe
 = 0.01;

369 
	g´ev_r
 = 0.0;

370 autØ
	g™r
 = 
Œaû_Ías_sÜ‹d_hi¡og¿m
.
begš
(); iŒ !ğŒaû_Ías_sÜ‹d_hi¡og¿m.
’d
(); itr++) {

371 
	ghÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
++;

372 
	ghÙ_»giÚ_wr™e_couÁ
 +ğ(*
™r
).
fœ¡
;

374 
	gf_‹mp
 = (
hÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
è/ (
Œaû_Ías_sÜ‹d_hi¡og¿m
.
size
());

375 
	gr_‹mp
 = (
hÙ_»giÚ_wr™e_couÁ
è/ (
¡©
->
TÙ®_acûs£d_lbas
);

377 ià(
	gf_‹mp
 >ğ
Ãxt_me¡Úe
) {

378 ià((
r_‹mp
 - 
´ev_r
è< 
¡•
) {

379 
r_‹mp
 = 
´ev_r
;

380 
	gf_‹mp
 = 
Ãxt_me¡Úe
 - 
¡•
;

383 
	g´ev_r
 = 
r_‹mp
;

384 
	gÃxt_me¡Úe
 +ğ
¡•
;

387 
	g´ev_v®ue
 = (*
™r
).
fœ¡
;

390 ià((
	gr_‹mp
 > 
	gMIN_HOT_REGION_TRAFFIC_RATIO
è&& (Ô_‹m°/ 
	gf_‹mp
è> 
	gHOT_REGION_METRIC
)) {

391 
	g¡©
->
	gR©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
 = 
f_‹mp
;

392 
	g¡©
->
	gR©io_of_Œaffic_acûssšg_hÙ_»giÚ
 = 
r_‹mp
;

394 
	g¡©
->
	gAdd»ss_di¡ributiÚ_ty³
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
;

397 
	g¡©
->
	gAdd»ss_di¡ributiÚ_ty³
 = 
Uts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
;

400 
	gUts
::
RªdomG’”©Ü
* 
¿ndom_add»ss_g’”©Ü
 = 
Ãw
 
Uts
::RªdomG’”©Ü(
´ecÚd™iÚšg_£ed
++);

401 
	gsize
 = 
¡©
->
Av”age_»que¡_size_£ùÜ
;

402 
LHA_ty³
 
	g¡¬t_LHA
 = 0;

405 
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
size
(è< 
	gno_of_logiÿl_·ges_š_¡—dy¡©e
) {

406 
	g¡¬t_LHA
 = 
¿ndom_add»ss_g’”©Ü
->
UnifÜm_ulÚg
(
mš_lha
, 
max_lha
);

407 
	ghªdËd_£ùÜs_couÁ
 = 0;

408 
LHA_ty³
 
	gl§
 = 
¡¬t_LHA
;

409 
	gŒª§ùiÚ_size
 = 0;

410 
	ghªdËd_£ùÜs_couÁ
 < 
	gsize
) {

411 ià(
	gl§
 < 
	gmš_lha
 ||†§ > 
	gmax_lha
) {

412 
	gl§
 = 
mš_lha
 + (
l§
 % (
max_lha
 - min_lha + 1));

414 
LHA_ty³
 
	gš‹º®_l§
 = 
l§
 - 
mš_lha
;

416 
	gŒª§ùiÚ_size
 = 
·ge_size_š_£ùÜs
 - ()(
š‹º®_l§
 %…age_size_in_sectors);

417 ià(
	ghªdËd_£ùÜs_couÁ
 + 
	gŒª§ùiÚ_size
 >ğ
size
) {

418 
Œª§ùiÚ_size
 = 
size
 - 
hªdËd_£ùÜs_couÁ
;

421 
LPA_ty³
 
	gÍa
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
š‹º®_l§
);

422 
·ge_¡©us_ty³
 
	gacûss_¡©us_b™m­
 = 
Fšd_NVM_subun™_acûss_b™m­
(
š‹º®_l§
);

424 ià(
	gÍa_£t_fÜ_´ecÚd™iÚšg
.
fšd
(
Ía
è!ğ
Ía_£t_fÜ_´ecÚd™iÚšg
.
’d
()) {

425 
Ía_£t_fÜ_´ecÚd™iÚšg
[
Ía
] = 
acûss_¡©us_b™m­
;

427 
	gÍa_£t_fÜ_´ecÚd™iÚšg
[
Ía
] = 
acûss_¡©us_b™m­
 | 
Ía_£t_fÜ_´ecÚd™iÚšg
[lpa];

430 
	gl§
 = 
l§
 + 
Œª§ùiÚ_size
;

431 
	ghªdËd_£ùÜs_couÁ
 +ğ
Œª§ùiÚ_size
;

438 
	g¡d
::
veùÜ
<> 
¡—dy¡©e_block_¡©us_´obab™y
;

439 
	grho
 = 
¡©
->
In™Ÿl_occu·ncy_¿tio
 * (1 - 
ov”_´ovisiÚšg_¿tio
è/ (1 - (
GC_ªd_WL_Un™
->
G‘_mšimum_numb”_of_ä“_·ges_befÜe_GC
()è/ 
block_no_³r_¶ªe
);

440 
	gdecisiÚ_di¡_ty³
) {

441 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

443 
r_to_f_¿tio
 = 
¡d
::
sq¹
((
¡©
->
R©io_of_Œaffic_acûssšg_hÙ_»giÚ
è/ (¡©->
R©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
));

444 
	gGC_ªd_WL_Un™
->
G‘_gc_pŞicy
()) {

445 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
GREEDY
:

446 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
FIFO
:

448 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

449 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(
Uts
::
Combš©iÚ_couÁ
(
·ge_no_³r_block
, 
i
è* 
¡d
::
pow
(
rho
, i) * std::pow(1 -„ho,…age_no_per_block - i));

451 
	gUts
::
EuËr_e¡im©iÚ
(
¡—dy¡©e_block_¡©us_´obab™y
, 
·ge_no_³r_block
, 
rho
, 30, 0.001, 0.0000000001, 10000);

454 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
RGA
:

456 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

457 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(
Uts
::
Combš©iÚ_couÁ
(
·ge_no_³r_block
, 
i
è* 
¡d
::
pow
(
rho
, i) * std::pow(1 -„ho,…age_no_per_block - i));

459 
	gUts
::
EuËr_e¡im©iÚ
(
¡—dy¡©e_block_¡©us_´obab™y
, 
·ge_no_³r_block
, 
rho
, 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
(), 0.001, 0.0000000001, 10000);

462 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM
:

463 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_P
:

465 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

466 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(
rho
 / (rhØ+ 
¡d
::
pow
(1 -„ho, 
i
)));

467 
	gj
 = 
i
 + 1; j <ğ
·ge_no_³r_block
; j++) {

468 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] *ğ((1 - 
rho
è* 
j
) / (rho + (1 -„ho) * j);

471 
	gi
 = 
·ge_no_³r_block
; i > 0; i--) {

472 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] = 
¡—dy¡©e_block_¡©us_´obab™y
[i] - steadystate_block_status_probability[i - 1];

476 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_PP
:

479 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

480 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(0);

483 
	grho
 = 
¡©
->
In™Ÿl_occu·ncy_¿tio
 * (1 - 
ov”_´ovisiÚšg_¿tio
);

484 
	gS_rho_b
 = 0;

485 
	gj
 = 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
(è+ 1; j <ğ
·ge_no_³r_block
; j++) {

486 
	gS_rho_b
 +ğ1.0 / (
j
);

488 
	ga_r
 = 
·ge_no_³r_block
 - 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
(è-…age_no_³r_block * 
S_rho_b
;

489 
	gb_r
 = 
rho
 * 
S_rho_b
 + 1 -„ho;

490 
	gc_r
 = -1 * 
rho
 / 
·ge_no_³r_block
;

491 
	gmu_b
 = (-1 * 
b_r
 + 
¡d
::
sq¹
(b_¸* b_¸- 4 * 
a_r
 * 
c_r
)) / (2 *‡_r);

492 
	gi
 = 
·ge_no_³r_block
; i >= 0; i--) {

493 ià(
	gi
 <ğ(
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
())) {

494 
¡—dy¡©e_block_¡©us_´obab™y
[
i
] = ((i + 1) * steadystate_block_status_probability[i + 1])

495 / (
i
 + (
rho
 / (1 -„hØ- 
mu_b
 * (
·ge_no_³r_block
 * 
S_rho_b
 -…age_no_³r_block + 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
()))));

497 ià(
	gi
 < (
	g·ge_no_³r_block
)) {

498 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] = (
·ge_no_³r_block
 * 
mu_b
) / (i);

500 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] = 
mu_b
;

507 
	gav”age_·ge_no_³r_block
 = 0;

509 
	g¡d
::
veùÜ
<> 
¡—dy¡©e_block_¡©us_´obab™y_‹mp
;

510 
	gi
 = 0; i < (
	g·ge_no_³r_block
) + 1; i++) {

511 
	g¡—dy¡©e_block_¡©us_´obab™y_‹mp
.
push_back
(
¡—dy¡©e_block_¡©us_´obab™y
[
i
]);

512 
	gav”age_·ge_no_³r_block
 +ğ
¡—dy¡©e_block_¡©us_´obab™y
[
i
] * i;

515 
	gi
 = 0; i < (
	g·ge_no_³r_block
) + 1; i++) {

516 
	gphi_šdex
 = (((
i
è- 
av”age_·ge_no_³r_block
è* 
r_to_f_¿tio
);

517 ià(
	gphi_šdex
 < 0 ||…hi_šdex >ğ(
·ge_no_³r_block
)) {

518 
¡—dy¡©e_block_¡©us_´obab™y
[
i
] = 0;

521 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] = 
r_to_f_¿tio
 * 
¡—dy¡©e_block_¡©us_´obab™y_‹mp
[
phi_šdex
];

524 
	gsum
 = 0;

525 
	gi
 = 0; i <ğ
·ge_no_³r_block
; i++) {

526 
	gsum
 +ğ
¡—dy¡©e_block_¡©us_´obab™y
[
i
];

528 
	gi
 = 0; i <ğ
·ge_no_³r_block
; i++) {

529 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] /ğ
sum
;

534 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

535 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

536 ifĞ
	gi
 == 0) {

537 
¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(1 - 
rho
);

538 } if(
	gi
 =ğ
·ge_no_³r_block
) {

539 
¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(
rho
);

541 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(0);

546 
	gGC_ªd_WL_Un™
->
G‘_gc_pŞicy
()) {

547 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
GREEDY
:

548 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_PP
:

549 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RGA
:

550 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
FIFO
:

551 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM
:

552 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_P
:

556 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

558 
GC_ªd_WL_Un™
->
G‘_gc_pŞicy
()) {

559 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
GREEDY
:

560 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
FIFO
:

562 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

563 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(
Uts
::
Combš©iÚ_couÁ
(
·ge_no_³r_block
, 
i
è* 
¡d
::
pow
(
rho
, i) * std::pow(1 -„ho,…age_no_per_block - i));

565 
	gUts
::
EuËr_e¡im©iÚ
(
¡—dy¡©e_block_¡©us_´obab™y
, 
·ge_no_³r_block
, 
rho
, 30, 0.001, 0.0000000001, 10000);

568 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
RGA
:

570 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

571 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(
Uts
::
Combš©iÚ_couÁ
(
·ge_no_³r_block
, 
i
è* 
¡d
::
pow
(
rho
, i) * std::pow(1 -„ho,…age_no_per_block - i));

573 
	gUts
::
EuËr_e¡im©iÚ
(
¡—dy¡©e_block_¡©us_´obab™y
, 
·ge_no_³r_block
, 
rho
, 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
(), 0.001, 0.0000000001, 10000);

576 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM
:

577 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_P
:

579 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

580 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(
rho
 / (rhØ+ 
¡d
::
pow
(1 -„ho, 
i
)));

581 
	gj
 = 
i
 + 1; j <ğ
·ge_no_³r_block
; j++) {

582 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] *ğ((1 - 
rho
è* 
j
) / (rho + (1 -„ho) * j);

585 
	gi
 = 
·ge_no_³r_block
; i > 0; i--) {

586 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] = 
¡—dy¡©e_block_¡©us_´obab™y
[i] - steadystate_block_status_probability[i - 1];

590 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_PP
:

593 
i
 = 0; 
	gi
 <ğ
·ge_no_³r_block
; i++) {

594 
	g¡—dy¡©e_block_¡©us_´obab™y
.
push_back
(0);

597 
	grho
 = 
¡©
->
In™Ÿl_occu·ncy_¿tio
 * (1 - 
ov”_´ovisiÚšg_¿tio
);

598 
	gS_rho_b
 = 0;

599 
	gj
 = 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
(è+ 1; j <ğ
·ge_no_³r_block
; j++) {

600 
	gS_rho_b
 +ğ1.0 / (
j
);

602 
	ga_r
 = 
·ge_no_³r_block
 - 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
(è-…age_no_³r_block * 
S_rho_b
;

603 
	gb_r
 = 
rho
 * 
S_rho_b
 + 1 -„ho;

604 
	gc_r
 = -1 * 
rho
 / 
·ge_no_³r_block
;

605 
	gmu_b
 = (-1 * 
b_r
 + 
¡d
::
sq¹
(b_¸* b_¸- 4 * 
a_r
 * 
c_r
)) / (2 *‡_r);

606 
	gi
 = 
·ge_no_³r_block
; i >= 0 ; i--) {

607 ià(
	gi
 <ğ(
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
())) {

608 
¡—dy¡©e_block_¡©us_´obab™y
[
i
] = ((i + 1) * steadystate_block_status_probability[i + 1])

609 / (
i
 + (
rho
 / (1 -„hØ- 
mu_b
 * (
·ge_no_³r_block
 * 
S_rho_b
 -…age_no_³r_block + 
GC_ªd_WL_Un™
->
G‘_GC_pŞicy_¥ecific_·¿m‘”
()))));

611 ià(
	gi
 < (
	g·ge_no_³r_block
)) {

612 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] = (
·ge_no_³r_block
 * 
mu_b
) / (i);

614 
	g¡—dy¡©e_block_¡©us_´obab™y
[
i
] = 
mu_b
;

623 
PRINT_ERROR
("Unhandled‡ddress distributionype in FTL's…reconditioning function.")

628 
sum
 = 0;

631 
	gi
 = 0; i <ğ
·ge_no_³r_block
; i++) {

632 
	gsum
 +ğ
¡—dy¡©e_block_¡©us_´obab™y
[
i
];

636 ià(
	gsum
 > 1.001 || sum < 0.99) {

637 
PRINT_ERROR
("Wrong…robability distribution function forhe‚umber of valid…ages in flash blocks inhe steady-state! It is‚ot safeo continue…reconditioning!")

639 
	gAdd»ss_M­pšg_Un™
->
AÎoÿ‹_add»ss_fÜ_´ecÚd™iÚšg
(
¡©
->
SŒ—m_id
, 
Ía_£t_fÜ_´ecÚd™iÚšg
, 
¡—dy¡©e_block_¡©us_´obab™y
);

642 ià(!
	gAdd»ss_M­pšg_Un™
->
Is_id—l_m­pšg_bË
()) {

644 
	gno_of_’Œ›s_š_cmt
 = 0;

645 
LPA_ty³
 
	gmš_LPA
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
¡©
->
Mš_LHA
);

646 
LPA_ty³
 
	gmax_LPA
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
¡©
->
Max_LHA
);

648 
	gAdd»ss_M­pšg_Un™
->
G‘_CMT_sh¬šg_mode
()) {

649 
	gCMT_Sh¬šg_Mode
::
SHARED
: {

650 
æow_¿‹
 = 0;

651 ià(
	g¡©
->
	gTy³
 =ğ
Uts
::
WÜklßd_Ty³
::
SYNTHETIC
) {

652 
¡©
->
g’”©Ü_ty³
) {

653 
Uts
::
Reque¡_G’”©Ü_Ty³
::
BANDWIDTH
:

654 
æow_¿‹
 = 1.0 / (
¡©
->
Av”age_š‹r_¬riv®_time_Çno_£c
è* 
SIM_TIME_TO_SECONDS_COEFF
 * st->
Av”age_»que¡_size_£ùÜ
;

656 
	gUts
::
Reque¡_G’”©Ü_Ty³
::
QUEUE_DEPTH
:

658 
sim_time_ty³
 
max_¬riv®_time
 = sim_time_ty³(
¡©
->
R—d_¿tio
 * (
avg_æash_»ad_Ï‹ncy
è+ (1 - st->R—d_¿tioè* (
avg_æash_´og¿m_Ï‹ncy
));

659 
	gavg_¬riv®_time
 = (
max_¬riv®_time
è/ (
¡©
->
Reque¡_queue_d•th
);

660 
	gæow_¿‹
 = 1.0 / 
avg_¬riv®_time
 * 
SIM_TIME_TO_SECONDS_COEFF
 * 
¡©
->
Av”age_»que¡_size_£ùÜ
;

664 
PRINT_ERROR
("Unknown„equestype generator inhe FTL…reconditioning function.")

667 
æow_¿‹
 = 1.0 / (
¡©
->
Av”age_š‹r_¬riv®_time_Çno_£c
è* 
SIM_TIME_TO_SECONDS_COEFF
 * st->
Av”age_»que¡_size_£ùÜ
;

670 
	gno_of_’Œ›s_š_cmt
 = ()((
æow_¿‹
è/ (
ov”®l_¿‹
è* 
Add»ss_M­pšg_Un™
->
G‘_cmt_ÿ·c™y
());

673 
	gCMT_Sh¬šg_Mode
::
EQUAL_SIZE_PARTITIONING
:

674 
no_of_’Œ›s_š_cmt
 = ()(1.0 / (
wÜklßd_¡©s
.
size
()è* 
Add»ss_M­pšg_Un™
->
G‘_cmt_ÿ·c™y
());

675 ià(
	gmax_LPA
 - 
	gmš_LPA
 + 1 < 
LPA_ty³
(
no_of_’Œ›s_š_cmt
)) {

676 
	gno_of_’Œ›s_š_cmt
 = ()(
max_LPA
 - 
mš_LPA
 + 1);

680 
PRINT_ERROR
("Unknown mappingable sharing mode inhe FTL…reconditioning function.")

683 ià(
max_LPA
 - 
mš_LPA
 + 1 < 
LPA_ty³
(
Œaû_Ías_sÜ‹d_hi¡og¿m
.
size
())) {

684 
no_of_’Œ›s_š_cmt
 = ()(
Œaû_Ías_sÜ‹d_hi¡og¿m
.
size
());

688 
	gdecisiÚ_di¡_ty³
) {

689 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_HOTCOLD
:

692 
»quœed_no_of_hÙ_cmt_’Œ›s
 = ()(
¡©
->
R©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
 * 
no_of_’Œ›s_š_cmt
);

693 
	g’Œ›s_to_bršg_što_cmt
 = 
»quœed_no_of_hÙ_cmt_’Œ›s
;

694 ià(
	g»quœed_no_of_hÙ_cmt_’Œ›s
 > 
	ghÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
) {

695 
	g’Œ›s_to_bršg_što_cmt
 = 
hÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
;

697 autØ
	g™r
 = 
Œaû_Ías_sÜ‹d_hi¡og¿m
.
begš
();

698 
	gAdd»ss_M­pšg_Un™
->
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡©
->
SŒ—m_id
è< 
	g’Œ›s_to_bršg_što_cmt
) {

699 
	gAdd»ss_M­pšg_Un™
->
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡©
->
SŒ—m_id
, (*
™r
).
£cÚd
);

700 
	gŒaû_Ías_sÜ‹d_hi¡og¿m
.
”a£
(
™r
++);

704 
	gno_of_’Œ›s_š_cmt
 -ğ
’Œ›s_to_bršg_što_cmt
;

705 autØ
	g™r2
 = 
Œaû_Ías_sÜ‹d_hi¡og¿m
.
begš
();

706 
	g¡d
::
advªû
(
™r2
, 
hÙ_»giÚ_Ï¡_šdex_š_hi¡og¿m
);

707 
	gAdd»ss_M­pšg_Un™
->
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡©
->
SŒ—m_id
è< 
	gno_of_’Œ›s_š_cmt
) {

708 
	gAdd»ss_M­pšg_Un™
->
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡©
->
SŒ—m_id
, (*
™r2
++).
£cÚd
);

709 ià(
	g™r2
 =ğ
Œaû_Ías_sÜ‹d_hi¡og¿m
.
’d
()) {

715 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
STREAMING
:

717 
LPA_ty³
 
Ía
;

718 
LPA_ty³
 
	gfœ¡_Ía_¡»amšg
 = 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
¡©
->
Fœ¡_Acûs£d_Add»ss
);

719 autØ
	g™r
 = 
Ía_£t_fÜ_´ecÚd™iÚšg
.
fšd
(
Ía
);

720 ià(
	g™r
 !ğ
Ía_£t_fÜ_´ecÚd™iÚšg
.
begš
()) {

721 
™r
--;

723 
	gAdd»ss_M­pšg_Un™
->
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡©
->
SŒ—m_id
è< 
	gno_of_’Œ›s_š_cmt
) {

724 
	gAdd»ss_M­pšg_Un™
->
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡©
->
SŒ—m_id
, (*
™r
).
fœ¡
);

725 ià(
	g™r
 =ğ
Ía_£t_fÜ_´ecÚd™iÚšg
.
begš
()) {

726 
™r
 = 
Ía_£t_fÜ_´ecÚd™iÚšg
.
’d
();

727 
	g™r
--;

729 
	g™r
--;

734 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
::
RANDOM_UNIFORM
:

736 
¿ndom_w®k”
 = (
¿ndom_g’”©Ü
.
UnifÜm
(0, 
ušt32_t
(
Œaû_Ías_sÜ‹d_hi¡og¿m
.
size
()) - 2));

737 
	g¿ndom_¡•
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, (
ušt32_t
)(
Œaû_Ías_sÜ‹d_hi¡og¿m
.
size
()è/ 
no_of_’Œ›s_š_cmt
);

738 autØ
	g™r
 = 
Œaû_Ías_sÜ‹d_hi¡og¿m
.
begš
();

739 
	gAdd»ss_M­pšg_Un™
->
G‘_cu¼’t_cmt_occu·ncy_fÜ_¡»am
(
¡©
->
SŒ—m_id
è< 
	gno_of_’Œ›s_š_cmt
) {

740 
	g¡d
::
advªû
(
™r
, 
¿ndom_¡•
);

741 
	gAdd»ss_M­pšg_Un™
->
Bršg_to_CMT_fÜ_´ecÚd™iÚšg
(
¡©
->
SŒ—m_id
, (*
™r
).
£cÚd
);

742 ià(
	gŒaû_Ías_sÜ‹d_hi¡og¿m
.
size
() > 1) {

743 
	gŒaû_Ías_sÜ‹d_hi¡og¿m
.
”a£
(
™r
++);

744 ià(
	g¿ndom_w®k”
 + 
	g¿ndom_¡•
 >ğ(
Œaû_Ías_sÜ‹d_hi¡og¿m
.
size
(è- 1è|| 
¿ndom_w®k”
 + 
¿ndom_¡•
 < 0) {

745 
¿ndom_¡•
 *= -1;

747 
	g¿ndom_w®k”
 +ğ
¿ndom_¡•
;

749 
	gŒaû_Ías_sÜ‹d_hi¡og¿m
.
”a£
(
™r
);

759 
	gFTL
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

761 
¡d
::
¡ršg
 
tmp
 = 
Çme_´efix
 + ".FTL";

762 
	gxmlwr™”
.
Wr™e_¡¬t_–em’t_g
(
tmp
);

764 
	g¡d
::
¡ršg
 
©Œ
 = "Issued_Flash_Read_CMD";

765 
	g¡d
::
¡ršg
 
v®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedR—dCMD
);

766 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

768 
	g©Œ
 = "Issued_Flash_Interleaved_Read_CMD";

769 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedIÁ”ËaveR—dCMD
);

770 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

772 
	g©Œ
 = "Issued_Flash_Multiplane_Read_CMD";

773 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedMuÉÏÃR—dCMD
);

774 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

776 
	g©Œ
 = "Issued_Flash_Copyback_Read_CMD";

777 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedCİybackR—dCMD
);

778 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

780 
	g©Œ
 = "Issued_Flash_Multiplane_Copyback_Read_CMD";

781 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedMuÉÏÃCİybackR—dCMD
);

782 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

784 
	g©Œ
 = "Issued_Flash_Program_CMD";

785 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedProg¿mCMD
);

786 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

788 
	g©Œ
 = "Issued_Flash_Interleaved_Program_CMD";

789 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedIÁ”ËaveProg¿mCMD
);

790 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

792 
	g©Œ
 = "Issued_Flash_Multiplane_Program_CMD";

793 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedMuÉÏÃProg¿mCMD
);

794 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

796 
	g©Œ
 = "Issued_Flash_Interleaved_Multiplane_Program_CMD";

797 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedIÁ”ËaveMuÉÏÃProg¿mCMD
);

798 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

800 
	g©Œ
 = "Issued_Flash_Copyback_Program_CMD";

801 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedCİybackProg¿mCMD
);

802 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

804 
	g©Œ
 = "Issued_Flash_Multiplane_Copyback_Program_CMD";

805 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedMuÉÏÃCİybackProg¿mCMD
);

806 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

808 
	g©Œ
 = "Issued_Flash_Erase_CMD";

809 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedE¿£CMD
);

810 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

812 
	g©Œ
 = "Issued_Flash_Interleaved_Erase_CMD";

813 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedIÁ”ËaveE¿£CMD
);

814 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

816 
	g©Œ
 = "Issued_Flash_Multiplane_Erase_CMD";

817 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedMuÉÏÃE¿£CMD
);

818 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

820 
	g©Œ
 = "Issued_Flash_Interleaved_Multiplane_Erase_CMD";

821 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedIÁ”ËaveMuÉÏÃE¿£CMD
);

822 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

824 
	g©Œ
 = "Issued_Flash_Suspend_Program_CMD";

825 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedSu¥’dProg¿mCMD
);

826 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

828 
	g©Œ
 = "Issued_Flash_Suspend_Erase_CMD";

829 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
IssuedSu¥’dE¿£CMD
);

830 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

832 
	g©Œ
 = "Issued_Flash_Read_CMD_For_Mapping";

833 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
TÙ®_æash_»ads_fÜ_m­pšg
);

834 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

836 
	g©Œ
 = "Issued_Flash_Program_CMD_For_Mapping";

837 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
TÙ®_æash_wr™es_fÜ_m­pšg
);

838 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

840 
	g©Œ
 = "CMT_Hits";

841 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
CMT_h™s
);

842 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

844 
	g©Œ
 = "CMT_Hits_For_Read";

845 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
»adTR_CMT_h™s
);

846 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

848 
	g©Œ
 = "CMT_Hits_For_Write";

849 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
wr™eTR_CMT_h™s
);

850 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

852 
	g©Œ
 = "CMT_Misses";

853 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
CMT_miss
);

854 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

856 
	g©Œ
 = "CMT_Misses_For_Read";

857 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
»adTR_CMT_miss
);

858 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

860 
	g©Œ
 = "CMT_Misses_For_Write";

861 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
wr™eTR_CMT_miss
);

862 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

864 
	g©Œ
 = "Total_CMT_Queries";

865 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
tÙ®_CMT_qu”›s
);

866 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

868 
	g©Œ
 = "Total_CMT_Queries_For_Reads";

869 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
tÙ®_»adTR_CMT_qu”›s
);

870 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

872 
	g©Œ
 = "Total_CMT_Queries_For_Writes";

873 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
tÙ®_wr™eTR_CMT_qu”›s
);

874 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

876 
	g©Œ
 = "Total_GC_Executions";

877 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
TÙ®_gc_executiÚs
);

878 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

880 
	g©Œ
 = "Average_Page_Movement_For_GC";

881 
	gv®
 = 
¡d
::
to_¡ršg
((
Sts
::
TÙ®_·ge_movem’ts_fÜ_gc
è/ (Sts::
TÙ®_gc_executiÚs
));

882 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

884 
	g©Œ
 = "Total_WL_Executions";

885 
	gv®
 = 
¡d
::
to_¡ršg
(
Sts
::
TÙ®_wl_executiÚs
);

886 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

888 
	g©Œ
 = "Average_Page_Movement_For_WL";

889 
	gv®
 = 
¡d
::
to_¡ršg
((
Sts
::
TÙ®_·ge_movem’ts_fÜ_wl
è/ (Sts::
TÙ®_wl_executiÚs
));

890 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

892 
	gxmlwr™”
.
Wr™e_’d_–em’t_g
();

894 
	gFTL
::
g‘_amu
()

896 ((
Add»ss_M­pšg_Un™_Page_Lev–
*è(
this
->
Add»ss_M­pšg_Un™
))->
´št_pv_aw¬e_d©a
("preconditioning done .…v‡ware data:");

900 
	gFTL
::
S¹_simuÏtiÚ
()

904 
FTL
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*)

908 
LPA_ty³
 
FTL
::
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
LHA_ty³
 
lha
)

910  
lha
 / 
·ge_size_š_£ùÜs
;

913 
·ge_¡©us_ty³
 
	gFTL
::
Fšd_NVM_subun™_acûss_b™m­
(
LHA_ty³
 
lha
)

915  ((
·ge_¡©us_ty³
)~(0xfffffffffffffffà<< ()1)è<< ()(
lha
 % 
·ge_size_š_£ùÜs
);

	@src/ssd/FTL.h

1 #iâdeà
FTL_H


2 
	#FTL_H


	)

4 
	~"../sim/Sim_R•Ü‹r.h
"

5 
	~"../uts/RªdomG’”©Ü.h
"

6 
	~"NVM_Fœmw¬e.h
"

7 
	~"TSU_Ba£.h
"

8 
	~"Add»ss_M­pšg_Un™_Ba£.h
"

9 
	~"FÏsh_Block_Mªag”_Ba£.h
"

10 
	~"GC_ªd_WL_Un™_Ba£.h
"

11 
	~"NVM_PHY_ONFI.h
"

12 
	~"Sts.h
"

14 
Çme¥aû
 
	gSSD_CompÚ’ts


16 şas 
	cSimuÏtiÚMode
 { 
	gSTANDALONE
, 
	gFULL_SYSTEM
 };

18 
şass
 
	gFÏsh_Block_Mªag”_Ba£
;

19 
şass
 
	gAdd»ss_M­pšg_Un™_Ba£
;

20 
şass
 
	gGC_ªd_WL_Un™_Ba£
;

21 
şass
 
	gTSU_Ba£
;

23 şas 
	cFTL
 : 
public
 
NVM_Fœmw¬e


25 
public
:

26 
FTL
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
D©a_Cache_Mªag”_Ba£
* 
d©a_ÿche
,

27 
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

28 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
·ge_size_š_£ùÜs
,

29 
sim_time_ty³
 
avg_æash_»ad_Ï‹ncy
, sim_time_ty³ 
avg_æash_´og¿m_Ï‹ncy
, 
ov”_´ovisiÚšg_¿tio
, 
max_®lowed_block_”a£_couÁ
, 
£ed
);

30 ~
FTL
();

31 
P”fÜm_´ecÚd™iÚ
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
);

32 
V®id©e_simuÏtiÚ_cÚfig
();

33 
S¹_simuÏtiÚ
();

34 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

35 
LPA_ty³
 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
LHA_ty³
 
lha
);

36 
·ge_¡©us_ty³
 
Fšd_NVM_subun™_acûss_b™m­
(
LHA_ty³
 
lha
);

37 
Add»ss_M­pšg_Un™_Ba£
* 
	gAdd»ss_M­pšg_Un™
;

38 
FÏsh_Block_Mªag”_Ba£
* 
	gBlockMªag”
;

39 
GC_ªd_WL_Un™_Ba£
* 
	gGC_ªd_WL_Un™
;

40 
TSU_Ba£
 * 
	gTSU
;

41 
NVM_PHY_ONFI
* 
	gPHY
;

43 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

44 
g‘_amu
();

45 
	g´iv©e
:

46 
chªÃl_no
, 
	gch_no_³r_chªÃl
, 
	gd›_no_³r_ch
, 
	g¶ªe_no_³r_d›
;

47 
	gblock_no_³r_¶ªe
, 
	g·ge_no_³r_block
, 
	g·ge_size_š_£ùÜs
;

48 
	gmax_®lowed_block_”a£_couÁ
;

49 
	g´ecÚd™iÚšg_£ed
;

50 
	gUts
::
RªdomG’”©Ü
 
¿ndom_g’”©Ü
;

51 
	gov”_´ovisiÚšg_¿tio
;

52 
sim_time_ty³
 
	gavg_æash_»ad_Ï‹ncy
;

53 
sim_time_ty³
 
	gavg_æash_´og¿m_Ï‹ncy
;

	@src/ssd/Flash_Block_Manager.cpp

2 
	~"../nvm_ch/æash_memÜy/Physiÿl_Page_Add»ss.h
"

3 
	~"FÏsh_Block_Mªag”.h
"

4 
	~"Sts.h
"

6 
Çme¥aû
 
	gSSD_CompÚ’ts


8 
	gFÏsh_Block_Mªag”
::
FÏsh_Block_Mªag”
(
GC_ªd_WL_Un™_Ba£
* 
gc_ªd_wl_un™
, 
max_®lowed_block_”a£_couÁ
, 
tÙ®_cÚcu¼’t_¡»ams_no
,

9 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

10 
block_no_³r_¶ªe
, 
·ge_no_³r_block
)

11 : 
FÏsh_Block_Mªag”_Ba£
(
gc_ªd_wl_un™
, 
max_®lowed_block_”a£_couÁ
, 
tÙ®_cÚcu¼’t_¡»ams_no
, 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
,

12 
¶ªe_no_³r_d›
, 
block_no_³r_¶ªe
, 
·ge_no_³r_block
)

16 
	gFÏsh_Block_Mªag”
::~
FÏsh_Block_Mªag”
()

20 
FÏsh_Block_Mªag”
::
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_RPG_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

22 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

23 
	g¶ªe_»cÜd
->
	gV®id_·ges_couÁ
++;

24 
	g¶ªe_»cÜd
->
	gF»e_·ges_couÁ
--;

27 
	g·ge_add»ss
.
	gPageID
 = 
¶ªe_»cÜd
->
Blocks
[
·ge_add»ss
.
BlockID
].
Cu¼’t_·ge_wr™e_šdex
++;

28 
´og¿m_Œª§ùiÚ_issued
(
·ge_add»ss
);

29 
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gSŒ—m_id
=
¡»amID
;

31 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gCu¼’t_·ge_wr™e_šdex
 =ğ
·ges_no_³r_block
) {

33 
¶ªe_»cÜd
->
Blocks
[
·ge_add»ss
.
BlockID
] = *ÕÏÃ_»cÜd->
G‘_a_ä“_block
(
¡»amID
, 
Œue
));

35 
	ggc_ªd_wl_un™
->
Check_gc_»quœed
(
¶ªe_»cÜd
->
G‘_ä“_block_poŞ_size
(), 
·ge_add»ss
);

38 
	g¶ªe_»cÜd
->
Check_bookk“pšg_cÜ»ùÃss
(
·ge_add»ss
);

40 
	gFÏsh_Block_Mªag”
::
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_u£r_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

42 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

43 
	g¶ªe_»cÜd
->
	gV®id_·ges_couÁ
++;

44 
	g¶ªe_»cÜd
->
	gF»e_·ges_couÁ
--;

45 
	g·ge_add»ss
.
	gBlockID
 = 
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
]->
BlockID
;

46 
	g·ge_add»ss
.
	gPageID
 = 
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
]->
Cu¼’t_·ge_wr™e_šdex
++;

47 
´og¿m_Œª§ùiÚ_issued
(
·ge_add»ss
);

50 if(
	g¶ªe_»cÜd
->
	gD©a_wf
[
¡»am_id
]->
	gCu¼’t_·ge_wr™e_šdex
 =ğ
·ges_no_³r_block
) {

52 
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
] =…ÏÃ_»cÜd->
G‘_a_ä“_block
(¡»am_id, 
çl£
);

53 
	ggc_ªd_wl_un™
->
Check_gc_»quœed
(
¶ªe_»cÜd
->
G‘_ä“_block_poŞ_size
(), 
·ge_add»ss
);

56 
	g¶ªe_»cÜd
->
Check_bookk“pšg_cÜ»ùÃss
(
·ge_add»ss
);

59 
	gFÏsh_Block_Mªag”
::
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_gc_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

61 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

62 
	g¶ªe_»cÜd
->
	gV®id_·ges_couÁ
++;

63 
	g¶ªe_»cÜd
->
	gF»e_·ges_couÁ
--;

64 
	g·ge_add»ss
.
	gBlockID
 = 
¶ªe_»cÜd
->
GC_wf
[
¡»am_id
]->
BlockID
;

65 
	g·ge_add»ss
.
	gPageID
 = 
¶ªe_»cÜd
->
GC_wf
[
¡»am_id
]->
Cu¼’t_·ge_wr™e_šdex
++;

69 ià(
	g¶ªe_»cÜd
->
	gGC_wf
[
¡»am_id
]->
	gCu¼’t_·ge_wr™e_šdex
 =ğ
·ges_no_³r_block
) {

71 
¶ªe_»cÜd
->
GC_wf
[
¡»am_id
] =…ÏÃ_»cÜd->
G‘_a_ä“_block
(¡»am_id, 
çl£
);

72 
	ggc_ªd_wl_un™
->
Check_gc_»quœed
(
¶ªe_»cÜd
->
G‘_ä“_block_poŞ_size
(), 
·ge_add»ss
);

74 
	g¶ªe_»cÜd
->
Check_bookk“pšg_cÜ»ùÃss
(
·ge_add»ss
);

77 
	gFÏsh_Block_Mªag”
::
AÎoÿ‹_Pages_š_block_ªd_šv®id©e_»maššg_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
, 
¡d
::
veùÜ
<NVM::FÏshMemÜy::Physiÿl_Page_Add»ss>& 
·ge_add»s£s
)

79 if(
·ge_add»s£s
.
size
(è> 
·ges_no_³r_block
) {

80 
PRINT_ERROR
("Error while…recondition‡…hysical block:he size ofhe‡ddress†ist is†argerhanhe…ages_no_per_block!")

83 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
];

84 ià(
	g¶ªe_»cÜd
->
	gD©a_wf
[
¡»am_id
]->
	gCu¼’t_·ge_wr™e_šdex
 > 0) {

85 
PRINT_ERROR
("Illegal operation:he Allocate_Pages_in_block_and_invalidate_remaining_for_preconditioning function should beƒxecuted for‡nƒrased block!")

89 
	gi
 = 0; i < 
	g·ge_add»s£s
.
size
(); i++) {

90 
	g¶ªe_»cÜd
->
	gV®id_·ges_couÁ
++;

91 
	g¶ªe_»cÜd
->
	gF»e_·ges_couÁ
--;

92 
	g·ge_add»s£s
[
i
].
	gBlockID
 = 
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
]->
BlockID
;

93 
	g·ge_add»s£s
[
i
].
	gPageID
 = 
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
]->
Cu¼’t_·ge_wr™e_šdex
++;

94 
	g¶ªe_»cÜd
->
Check_bookk“pšg_cÜ»ùÃss
(
·ge_add»s£s
[
i
]);

98 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
rg‘_add»ss
(
¶ªe_add»ss
);

99 
	g¶ªe_»cÜd
->
	gD©a_wf
[
¡»am_id
]->
	gCu¼’t_·ge_wr™e_šdex
 < 
	g·ges_no_³r_block
) {

100 
	g¶ªe_»cÜd
->
	gF»e_·ges_couÁ
--;

101 
	grg‘_add»ss
.
	gBlockID
 = 
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
]->
BlockID
;

102 
	grg‘_add»ss
.
	gPageID
 = 
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
]->
Cu¼’t_·ge_wr™e_šdex
++;

103 
Inv®id©e_·ge_š_block_fÜ_´ecÚd™iÚšg
(
¡»am_id
, 
rg‘_add»ss
);

104 
	g¶ªe_»cÜd
->
Check_bookk“pšg_cÜ»ùÃss
(
¶ªe_add»ss
);

108 
	g¶ªe_»cÜd
->
	gD©a_wf
[
¡»am_id
] = 
¶ªe_»cÜd
->
G‘_a_ä“_block
(¡»am_id, 
çl£
);

111 
	gFÏsh_Block_Mªag”
::
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
, 
boŞ
 
is_fÜ_gc
)

113 
PÏÃBookK“pšgTy³
 *
	g¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

114 
	g¶ªe_»cÜd
->
	gV®id_·ges_couÁ
++;

115 
	g¶ªe_»cÜd
->
	gF»e_·ges_couÁ
--;

116 
	g·ge_add»ss
.
	gBlockID
 = 
¶ªe_»cÜd
->
T¿n¦©iÚ_wf
[
¡»amID
]->
BlockID
;

117 
	g·ge_add»ss
.
	gPageID
 = 
¶ªe_»cÜd
->
T¿n¦©iÚ_wf
[
¡»amID
]->
Cu¼’t_·ge_wr™e_šdex
++;

118 
´og¿m_Œª§ùiÚ_issued
(
·ge_add»ss
);

121 ià(
	g¶ªe_»cÜd
->
	gT¿n¦©iÚ_wf
[
¡»amID
]->
	gCu¼’t_·ge_wr™e_šdex
 =ğ
·ges_no_³r_block
) {

123 
¶ªe_»cÜd
->
T¿n¦©iÚ_wf
[
¡»amID
] =…ÏÃ_»cÜd->
G‘_a_ä“_block
(¡»amID, 
Œue
);

124 ià(!
	gis_fÜ_gc
) {

125 
	ggc_ªd_wl_un™
->
Check_gc_»quœed
(
¶ªe_»cÜd
->
G‘_ä“_block_poŞ_size
(), 
·ge_add»ss
);

128 
	g¶ªe_»cÜd
->
Check_bookk“pšg_cÜ»ùÃss
(
·ge_add»ss
);

131 
šlše
 
	gFÏsh_Block_Mªag”
::
Inv®id©e_·ge_š_block
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

133 
PÏÃBookK“pšgTy³
* 
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

134 
	g¶ªe_»cÜd
->
	gInv®id_·ges_couÁ
++;

135 
	g¶ªe_»cÜd
->
	gV®id_·ges_couÁ
--;

136 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gSŒ—m_id
 !ğ
¡»am_id
) {

137 
PRINT_ERROR
("IncÚsi¡’ˆ¡©u šhInv®id©e_·ge_š_block funùiÚ! Thacûs£d block i nÙ‡Îoÿ‹dØ¡»am " << 
¡»am_id
)

139 
¶ªe_»cÜd
->
Blocks
[
·ge_add»ss
.
BlockID
].
Inv®id_·ge_couÁ
++;

140 
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gInv®id_·ge_b™m­
[·ge_add»ss.
PageID
 / 64] |ğ((
ušt64_t
)0x1) << (page_address.PageID % 64);

143 
šlše
 
	gFÏsh_Block_Mªag”
::
Inv®id©e_·ge_š_block_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

145 
PÏÃBookK“pšgTy³
* 
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

146 
	g¶ªe_»cÜd
->
	gInv®id_·ges_couÁ
++;

147 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gSŒ—m_id
 !ğ
¡»am_id
) {

148 
PRINT_ERROR
("IncÚsi¡’ˆ¡©u šhInv®id©e_·ge_š_block funùiÚ! Thacûs£d block i nÙ‡Îoÿ‹dØ¡»am " << 
¡»am_id
)

150 
¶ªe_»cÜd
->
Blocks
[
·ge_add»ss
.
BlockID
].
Inv®id_·ge_couÁ
++;

151 
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gInv®id_·ge_b™m­
[·ge_add»ss.
PageID
 / 64] |ğ((
ušt64_t
)0x1) << (page_address.PageID % 64);

154 
	gFÏsh_Block_Mªag”
::
Add_”a£d_block_to_poŞ
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
)

156 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
];

157 
Block_PoŞ_SlÙ_Ty³
* 
	gblock
 = &(
¶ªe_»cÜd
->
Blocks
[
block_add»ss
.
BlockID
]);

158 
	g¶ªe_»cÜd
->
	gF»e_·ges_couÁ
 +ğ
block
->
Inv®id_·ge_couÁ
;

159 
	g¶ªe_»cÜd
->
	gInv®id_·ges_couÁ
 -ğ
block
->
Inv®id_·ge_couÁ
;

161 
	gSts
::
Block_”a£_hi¡og¿m
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
][
block
->
E¿£_couÁ
]--;

162 
	gblock
->
E¿£
();

163 
	gSts
::
Block_”a£_hi¡og¿m
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
][
block
->
E¿£_couÁ
]++;

164 
	g¶ªe_»cÜd
->
Add_to_ä“_block_poŞ
(
block
, 
gc_ªd_wl_un™
->
U£_dyÇmic_w—¾ev–šg
());

165 
	g¶ªe_»cÜd
->
Check_bookk“pšg_cÜ»ùÃss
(
block_add»ss
);

168 
šlše
 
	gFÏsh_Block_Mªag”
::
G‘_poŞ_size
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
)

170  (è
¶ªe_mªag”
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
].
F»e_block_poŞ
.
size
();

	@src/ssd/Flash_Block_Manager.h

1 #iâdeà
FLASH_BLOCK_MANAGER_H


2 
	#FLASH_BLOCK_MANAGER_H


	)

4 
	~<li¡
>

5 
	~"FÏsh_Block_Mªag”_Ba£.h
"

6 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

7 
	~"../nvm_ch/æash_memÜy/Physiÿl_Page_Add»ss.h
"

9 
Çme¥aû
 
	gSSD_CompÚ’ts


11 şas 
	cFÏsh_Block_Mªag”
 : 
public
 
FÏsh_Block_Mªag”_Ba£


13 
public
:

14 
FÏsh_Block_Mªag”
(
GC_ªd_WL_Un™_Ba£
* 
gc_ªd_wl_un™
, 
max_®lowed_block_”a£_couÁ
, 
tÙ®_cÚcu¼’t_¡»ams_no
,

15 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

16 
block_no_³r_¶ªe
, 
·ge_no_³r_block
);

17 ~
FÏsh_Block_Mªag”
();

18 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_u£r_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

19 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_gc_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

20 
AÎoÿ‹_Pages_š_block_ªd_šv®id©e_»maššg_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
, 
¡d
::
veùÜ
<NVM::FÏshMemÜy::Physiÿl_Page_Add»ss>& 
·ge_add»s£s
);

21 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
, 
boŞ
 
is_fÜ_gc
);

22 
Inv®id©e_·ge_š_block
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

23 
Inv®id©e_·ge_š_block_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

24 
Add_”a£d_block_to_poŞ
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

25 
G‘_poŞ_size
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
);

26 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_RPG_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
);

27 
	g´iv©e
:

	@src/ssd/Flash_Block_Manager_Base.cpp

1 
	~"FÏsh_Block_Mªag”.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gBlock_PoŞ_SlÙ_Ty³
::
Page_veùÜ_size
 = 0;

7 
	gFÏsh_Block_Mªag”_Ba£
::
FÏsh_Block_Mªag”_Ba£
(
GC_ªd_WL_Un™_Ba£
* 
gc_ªd_wl_un™
, 
max_®lowed_block_”a£_couÁ
, 
tÙ®_cÚcu¼’t_¡»ams_no
,

8 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

9 
block_no_³r_¶ªe
, 
·ge_no_³r_block
)

10 : 
gc_ªd_wl_un™
(gc_ªd_wl_un™), 
max_®lowed_block_”a£_couÁ
(max_®lowed_block_”a£_couÁ), 
tÙ®_cÚcu¼’t_¡»ams_no
(total_concurrent_streams_no),

11 
chªÃl_couÁ
(chªÃl_couÁ), 
ch_no_³r_chªÃl
(ch_no_³r_chªÃl), 
d›_no_³r_ch
(d›_no_³r_ch), 
¶ªe_no_³r_d›
(plane_no_per_die),

12 
block_no_³r_¶ªe
(block_no_³r_¶ªe), 
·ges_no_³r_block
(
·ge_no_³r_block
)

14 
	g¶ªe_mªag”
 = 
Ãw
 
PÏÃBookK“pšgTy³
***[
chªÃl_couÁ
];

15 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

16 
	g¶ªe_mªag”
[
chªÃlID
] = 
Ãw
 
PÏÃBookK“pšgTy³
**[
ch_no_³r_chªÃl
];

17 
	gchID
 = 0; chID < 
	gch_no_³r_chªÃl
; chipID++) {

18 
	g¶ªe_mªag”
[
chªÃlID
][
chID
] = 
Ãw
 
PÏÃBookK“pšgTy³
*[
d›_no_³r_ch
];

19 
	gd›ID
 = 0; d›ID < 
	gd›_no_³r_ch
; dieID++) {

20 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
] = 
Ãw
 
PÏÃBookK“pšgTy³
[
¶ªe_no_³r_d›
];

23 
	g¶ªeID
 = 0;…ÏÃID < 
	g¶ªe_no_³r_d›
;…laneID++) {

24 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gTÙ®_·ges_couÁ
 = 
block_no_³r_¶ªe
 * 
·ges_no_³r_block
;

25 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gF»e_·ges_couÁ
 = 
block_no_³r_¶ªe
 * 
·ges_no_³r_block
;

26 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gV®id_·ges_couÁ
 = 0;

27 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gInv®id_·ges_couÁ
 = 0;

28 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gOngošg_”a£_İ”©iÚs
.
ş—r
();

29 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
 = 
Ãw
 
Block_PoŞ_SlÙ_Ty³
[
block_no_³r_¶ªe
];

32 
	gblockID
 = 0; blockID < 
	gblock_no_³r_¶ªe
; blockID++) {

33 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gBlockID
 = blockID;

34 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gCu¼’t_·ge_wr™e_šdex
 = 0;

35 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gCu¼’t_¡©us
 = 
Block_S”viû_Stus
::
IDLE
;

36 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gInv®id_·ge_couÁ
 = 0;

37 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gE¿£_couÁ
 = 0;

38 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gHŞds_m­pšg_d©a
 = 
çl£
;

39 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gHas_Úgošg_gc_wl
 = 
çl£
;

40 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gE¿£_Œª§ùiÚ
 = 
NULL
;

41 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gOngošg_u£r_´og¿m_couÁ
 = 0;

42 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gOngošg_u£r_»ad_couÁ
 = 0;

43 
	gBlock_PoŞ_SlÙ_Ty³
::
Page_veùÜ_size
 = 
·ges_no_³r_block
 / ((
ušt64_t
) * 8) + (pages_no_per_block % ((uint64_t) * 8) == 0 ? 0 : 1);

44 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gInv®id_·ge_b™m­
 = 
Ãw
 
ušt64_t
[
Block_PoŞ_SlÙ_Ty³
::
Page_veùÜ_size
];

45 
	gi
 = 0; i < 
	gBlock_PoŞ_SlÙ_Ty³
::
Page_veùÜ_size
; i++) {

46 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gBlocks
[
blockID
].
	gInv®id_·ge_b™m­
[
i
] = 
AÎ_VALID_PAGE
;

49 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
Add_to_ä“_block_poŞ
(&
¶ªe_mªag”
[chªÃlID][chID][d›ID][¶ªeID].
Blocks
[
blockID
], 
çl£
);

51 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gD©a_wf
 = 
Ãw
 
Block_PoŞ_SlÙ_Ty³
*[
tÙ®_cÚcu¼’t_¡»ams_no
];

52 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gT¿n¦©iÚ_wf
 = 
Ãw
 
Block_PoŞ_SlÙ_Ty³
*[
tÙ®_cÚcu¼’t_¡»ams_no
];

53 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gGC_wf
 = 
Ãw
 
Block_PoŞ_SlÙ_Ty³
*[
tÙ®_cÚcu¼’t_¡»ams_no
];

55 
	g¡»am_úŒ
 = 0; sŒ—m_úŒ < 
	gtÙ®_cÚcu¼’t_¡»ams_no
; stream_cntr++) {

56 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gD©a_wf
[
¡»am_úŒ
] = 
¶ªe_mªag”
[chªÃlID][chID][d›ID][¶ªeID].
G‘_a_ä“_block
(¡»am_úŒ, 
çl£
);

57 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gT¿n¦©iÚ_wf
[
¡»am_úŒ
] = 
¶ªe_mªag”
[chªÃlID][chID][d›ID][¶ªeID].
G‘_a_ä“_block
(¡»am_úŒ, 
Œue
);

58 
	g¶ªe_mªag”
[
chªÃlID
][
chID
][
d›ID
][
¶ªeID
].
	gGC_wf
[
¡»am_úŒ
] = 
¶ªe_mªag”
[chªÃlID][chID][d›ID][¶ªeID].
G‘_a_ä“_block
(¡»am_úŒ, 
çl£
);

66 
	gFÏsh_Block_Mªag”_Ba£
::~
FÏsh_Block_Mªag”_Ba£
()

68 
chªÃl_id
 = 0; 
	gchªÃl_id
 < 
	gchªÃl_couÁ
; channel_id++) {

69 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

70 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

71 
	g¶ªe_id
 = 0;…ÏÃ_id < 
	g¶ªe_no_³r_d›
;…lane_id++) {

72 
	gblockID
 = 0; blockID < 
	gblock_no_³r_¶ªe
; blockID++) {

73 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
].
	gBlocks
[
blockID
].
	gInv®id_·ge_b™m­
;

75 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
].
	gBlocks
;

76 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
].
	gGC_wf
;

77 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
].
	gD©a_wf
;

78 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
].
	gT¿n¦©iÚ_wf
;

80 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
][
ch_id
][
d›_id
];

82 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
][
ch_id
];

84 
	gd–‘e
[] 
	g¶ªe_mªag”
[
chªÃl_id
];

86 
	gd–‘e
[] 
	g¶ªe_mªag”
;

89 
	gFÏsh_Block_Mªag”_Ba£
::
S‘_GC_ªd_WL_Un™
(
GC_ªd_WL_Un™_Ba£
* 
gcwl
)

91 
this
->
gc_ªd_wl_un™
 = 
gcwl
;

94 
	gBlock_PoŞ_SlÙ_Ty³
::
E¿£
()

96 
Cu¼’t_·ge_wr™e_šdex
 = 0;

97 
	gInv®id_·ge_couÁ
 = 0;

98 
	gE¿£_couÁ
++;

99 
	gi
 = 0; i < 
	gBlock_PoŞ_SlÙ_Ty³
::
Page_veùÜ_size
; i++) {

100 
	gInv®id_·ge_b™m­
[
i
] = 
AÎ_VALID_PAGE
;

102 
	gSŒ—m_id
 = 
NO_STREAM
;

103 
	gHŞds_m­pšg_d©a
 = 
çl£
;

104 
	gE¿£_Œª§ùiÚ
 = 
NULL
;

106 
boŞ
 
	gPÏÃBookK“pšgTy³
::
¤ch
(
Block_PoŞ_SlÙ_Ty³
* 
Ãw_block
){

107 autØ
i
: 
RPG_Blocks
){

108 if(
Ãw_block
->
BlockID
==
i
->BlockID){

109  
Œue
;

112  
	gçl£
;

115 
Block_PoŞ_SlÙ_Ty³
* 
	gPÏÃBookK“pšgTy³
::
G‘_a_ä“_block
(
¡»am_id_ty³
 
¡»am_id
, 
boŞ
 
fÜ_m­pšg_d©a
)

118 
Block_PoŞ_SlÙ_Ty³
* 
	gÃw_block
 = 
NULL
;

121 
	gÃw_block
 = (*
F»e_block_poŞ
.
begš
()).
£cÚd
;

123 
	gF»e_block_poŞ
.
”a£
(
F»e_block_poŞ
.
begš
());

124 }
¤ch
(
Ãw_block
));

125 ià(
	gF»e_block_poŞ
.
size
() == 0) {

126 
PRINT_ERROR
("Requesting‡ free block from‡nƒmpty…ool!");

129 
	gÃw_block
->
	gSŒ—m_id
 = 
¡»am_id
;

130 
	gÃw_block
->
	gHŞds_m­pšg_d©a
 = 
fÜ_m­pšg_d©a
;

131 
	gBlock_u§ge_hi¡Üy
.
push
(
Ãw_block
->
BlockID
);

133  
	gÃw_block
;

136 
	gPÏÃBookK“pšgTy³
::
Check_bookk“pšg_cÜ»ùÃss
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
)

138 ià(
TÙ®_·ges_couÁ
 !ğ
F»e_·ges_couÁ
 + 
V®id_·ges_couÁ
 + 
Inv®id_·ges_couÁ
) {

139 
PRINT_ERROR
("Inconsistent status inhe…lane bookkeeping„ecord!")

141 ià(
F»e_·ges_couÁ
 == 0) {

142 
PRINT_ERROR
("PÏÃ " << "@" << 
¶ªe_add»ss
.
ChªÃlID
 << "@" <<…ÏÃ_add»ss.
ChID
 << "@" <<…ÏÃ_add»ss.
D›ID
 << "@" <<…ÏÃ_add»ss.
PÏÃID
 << "…oŞ size: " << 
G‘_ä“_block_poŞ_size
() << "„an out of free…ages! Bad„esource management! It is‚ot safeo continue simulation!");

146 
	gPÏÃBookK“pšgTy³
::
G‘_ä“_block_poŞ_size
()

148  ()
F»e_block_poŞ
.
size
();

151 
	gPÏÃBookK“pšgTy³
::
Add_to_ä“_block_poŞ
(
Block_PoŞ_SlÙ_Ty³
* 
block
, 
boŞ
 
cÚsid”_dyÇmic_wl
)

154 ià(
	gcÚsid”_dyÇmic_wl
) {

155 
	g¡d
::
·œ
<, 
	gBlock_PoŞ_SlÙ_Ty³
*> 
’Œy
(
block
->
E¿£_couÁ
, block);

156 if(!
¤ch
(
block
))

157 
	gF»e_block_poŞ
.
š£¹
(
’Œy
);

159 
	g¡d
::
·œ
<, 
	gBlock_PoŞ_SlÙ_Ty³
*> 
’Œy
(0, 
block
);

160 if(!
¤ch
(
block
))

161 
	gF»e_block_poŞ
.
š£¹
(
’Œy
);

166 
	gFÏsh_Block_Mªag”_Ba£
::
G‘_mš_max_”a£_difã»nû
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
)

168 
mš_”a£d_block
 = 0;

169 
	gmax_”a£d_block
 = 0;

170 
PÏÃBookK“pšgTy³
 *
	g¶ªe_»cÜd
 = &
¶ªe_mªag”
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
];

172 
	gi
 = 1; i < 
	gblock_no_³r_¶ªe
; i++) {

173 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
i
].
	gE¿£_couÁ
 >…ÏÃ_»cÜd->Blocks[
max_”a£d_block
].Erase_count) {

174 
	gmax_”a£d_block
 = 
i
;

176 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
i
].
	gE¿£_couÁ
 <…ÏÃ_»cÜd->Blocks[
mš_”a£d_block
].Erase_count) {

177 
	gmš_”a£d_block
 = 
i
;

181  
	gmax_”a£d_block
 - 
	gmš_”a£d_block
;

184 
æash_block_ID_ty³
 
	gFÏsh_Block_Mªag”_Ba£
::
G‘_cŞde¡_block_id
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
)

186 
mš_”a£d_block
 = 0;

187 
PÏÃBookK“pšgTy³
 *
	g¶ªe_»cÜd
 = &
¶ªe_mªag”
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
];

189 
	gi
 = 1; i < 
	gblock_no_³r_¶ªe
; i++) {

190 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
i
].
	gE¿£_couÁ
 <…ÏÃ_»cÜd->Blocks[
mš_”a£d_block
].Erase_count) {

191 
	gmš_”a£d_block
 = 
i
;

195  
	gmš_”a£d_block
;

198 
PÏÃBookK“pšgTy³
* 
	gFÏsh_Block_Mªag”_Ba£
::
G‘_¶ªe_bookk“pšg_’Œy
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
)

200  &(
¶ªe_mªag”
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
]);

203 
boŞ
 
	gFÏsh_Block_Mªag”_Ba£
::
Block_has_Úgošg_gc_wl
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
)

205 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
];

206  
	g¶ªe_»cÜd
->
	gBlocks
[
block_add»ss
.
BlockID
].
	gHas_Úgošg_gc_wl
;

209 
boŞ
 
	gFÏsh_Block_Mªag”_Ba£
::
Cª_execu‹_gc_wl
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
)

211 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
];

212  (
	g¶ªe_»cÜd
->
	gBlocks
[
block_add»ss
.
BlockID
].
	gOngošg_u£r_´og¿m_couÁ
 +…ÏÃ_»cÜd->Blocks[block_add»ss.BlockID].
	gOngošg_u£r_»ad_couÁ
 == 0);

215 
	gFÏsh_Block_Mªag”_Ba£
::
GC_WL_¡¬‹d
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
)

217 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
];

218 
	g¶ªe_»cÜd
->
	gBlocks
[
block_add»ss
.
BlockID
].
	gHas_Úgošg_gc_wl
 = 
Œue
;

221 
	gFÏsh_Block_Mªag”_Ba£
::
´og¿m_Œª§ùiÚ_issued
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

223 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

224 
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gOngošg_u£r_´og¿m_couÁ
++;

227 
	gFÏsh_Block_Mªag”_Ba£
::
R—d_Œª§ùiÚ_issued
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

229 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

230 
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gOngošg_u£r_»ad_couÁ
++;

233 
	gFÏsh_Block_Mªag”_Ba£
::
Prog¿m_Œª§ùiÚ_£rviûd
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

235 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

236 
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gOngošg_u£r_´og¿m_couÁ
--;

239 
	gFÏsh_Block_Mªag”_Ba£
::
R—d_Œª§ùiÚ_£rviûd
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
)

241 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
·ge_add»ss
.
ChªÃlID
][·ge_add»ss.
ChID
][·ge_add»ss.
D›ID
][·ge_add»ss.
PÏÃID
];

242 
	g¶ªe_»cÜd
->
	gBlocks
[
·ge_add»ss
.
BlockID
].
	gOngošg_u£r_»ad_couÁ
--;

245 
boŞ
 
	gFÏsh_Block_Mªag”_Ba£
::
Is_havšg_Úgošg_´og¿m
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
)

247 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
];

248  
	g¶ªe_»cÜd
->
	gBlocks
[
block_add»ss
.
BlockID
].
	gOngošg_u£r_´og¿m_couÁ
 > 0;

251 
	gFÏsh_Block_Mªag”_Ba£
::
GC_WL_fšished
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
)

253 
PÏÃBookK“pšgTy³
 *
¶ªe_»cÜd
 = &
¶ªe_mªag”
[
block_add»ss
.
ChªÃlID
][block_add»ss.
ChID
][block_add»ss.
D›ID
][block_add»ss.
PÏÃID
];

254 
	g¶ªe_»cÜd
->
	gBlocks
[
block_add»ss
.
BlockID
].
	gHas_Úgošg_gc_wl
 = 
çl£
;

257 
boŞ
 
	gFÏsh_Block_Mªag”_Ba£
::
Is_·ge_v®id
(
Block_PoŞ_SlÙ_Ty³
* 
block
, 
æash_·ge_ID_ty³
 
·ge_id
)

259 ià((
	gblock
->
	gInv®id_·ge_b™m­
[
·ge_id
 / 64] & (((
	gušt64_t
)1è<< 
	g·ge_id
)) == 0) {

260  
Œue
;

262  
	gçl£
;

	@src/ssd/Flash_Block_Manager_Base.h

1 #iâdeà
BLOCK_POOL_MANAGER_BASE_H


2 
	#BLOCK_POOL_MANAGER_BASE_H


	)

4 
	~<li¡
>

5 
	~<c¡dšt
>

6 
	~<queue
>

7 
	~<£t
>

8 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

9 
	~"../nvm_ch/æash_memÜy/Physiÿl_Page_Add»ss.h
"

10 
	~"GC_ªd_WL_Un™_Ba£.h
"

11 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

12 
	~<®gÜ™hm
>

13 
Çme¥aû
 
	gSSD_CompÚ’ts


15 
	#AÎ_VALID_PAGE
 0x0000000000000000ULL

	)

16 
şass
 
	gGC_ªd_WL_Un™_Ba£
;

27 şas 
	cBlock_S”viû_Stus
 {
	gIDLE
, 
	gGC_WL
, 
	gUSER
, 
	gGC_USER
, 
	gGC_UWAIT
, 
	gGC_USER_UWAIT
};

29 şas 
	cBlock_PoŞ_SlÙ_Ty³


31 
	gpublic
:

33 
æash_block_ID_ty³
 
BlockID
;

34 
æash_·ge_ID_ty³
 
	gCu¼’t_·ge_wr™e_šdex
;

35 
Block_S”viû_Stus
 
	gCu¼’t_¡©us
;

36 
	gInv®id_·ge_couÁ
;

37 
	gE¿£_couÁ
;

38 
	gPage_veùÜ_size
;

40 
ušt64_t
* 
	gInv®id_·ge_b™m­
;

41 
¡»am_id_ty³
 
	gSŒ—m_id
 = 
NO_STREAM
;

42 
boŞ
 
	gHŞds_m­pšg_d©a
 = 
çl£
;

43 
boŞ
 
	gHas_Úgošg_gc_wl
 = 
çl£
;

44 
NVM_T¿n§ùiÚ_FÏsh_ER
* 
	gE¿£_Œª§ùiÚ
;

45 
boŞ
 
	gHÙ_block
 = 
çl£
;

46 
	gOngošg_u£r_»ad_couÁ
;

47 
	gOngošg_u£r_´og¿m_couÁ
;

48 
E¿£
();

51 şas 
	cPÏÃBookK“pšgTy³


70 
	gpublic
:

71 
TÙ®_·ges_couÁ
;

72 
	gF»e_·ges_couÁ
;

73 
	gV®id_·ges_couÁ
;

74 
	gInv®id_·ges_couÁ
;

75 
Block_PoŞ_SlÙ_Ty³
* 
	gBlocks
;

77 
boŞ
 
¤ch
(
Block_PoŞ_SlÙ_Ty³
* 
Ãw_block
);

78 
	g¡d
::
muÉim­
<, 
	gBlock_PoŞ_SlÙ_Ty³
*> 
	gF»e_block_poŞ
;

79 
Block_PoŞ_SlÙ_Ty³
** 
	gD©a_wf
, ** 
	gGC_wf
;

80 
	g¡d
::
li¡
<
Block_PoŞ_SlÙ_Ty³
*> 
RPG_Blocks
;

81 
Block_PoŞ_SlÙ_Ty³
** 
	gT¿n¦©iÚ_wf
;

83 
	g¡d
::
queue
<
æash_block_ID_ty³
> 
Block_u§ge_hi¡Üy
;

84 
	g¡d
::
£t
<
æash_block_ID_ty³
> 
Ongošg_”a£_İ”©iÚs
;

85 
Block_PoŞ_SlÙ_Ty³
* 
G‘_a_ä“_block
(
¡»am_id_ty³
 
¡»am_id
, 
boŞ
 
fÜ_m­pšg_d©a
);

86 
G‘_ä“_block_poŞ_size
();

87 
Check_bookk“pšg_cÜ»ùÃss
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
);

88 
Add_to_ä“_block_poŞ
(
Block_PoŞ_SlÙ_Ty³
* 
block
, 
boŞ
 
cÚsid”_dyÇmic_wl
);

91 şas 
	cFÏsh_Block_Mªag”_Ba£


93 
ä›nd
 
şass
 
	gAdd»ss_M­pšg_Un™_Page_Lev–
;

94 
ä›nd
 
şass
 
	gGC_ªd_WL_Un™_Page_Lev–
;

95 
ä›nd
 
şass
 
	gGC_ªd_WL_Un™_Ba£
;

96 
	gpublic
:

97 
FÏsh_Block_Mªag”_Ba£
(
GC_ªd_WL_Un™_Ba£
* 
gc_ªd_wl_un™
, 
max_®lowed_block_”a£_couÁ
, 
tÙ®_cÚcu¼’t_¡»ams_no
,

98 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

99 
block_no_³r_¶ªe
, 
·ge_no_³r_block
);

100 
	gvœtu®
 ~
FÏsh_Block_Mªag”_Ba£
();

101 
vœtu®
 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_u£r_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) = 0;

102 
vœtu®
 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_gc_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) = 0;

103 
vœtu®
 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_Œª¦©iÚ_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
, 
boŞ
 
is_fÜ_gc
) = 0;

104 
vœtu®
 
AÎoÿ‹_Pages_š_block_ªd_šv®id©e_»maššg_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»am_id
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
, 
¡d
::
veùÜ
<NVM::FÏshMemÜy::Physiÿl_Page_Add»ss>& 
·ge_add»s£s
) = 0;

105 
vœtu®
 
Inv®id©e_·ge_š_block
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) = 0;

106 
vœtu®
 
Inv®id©e_·ge_š_block_fÜ_´ecÚd™iÚšg
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) = 0;

107 
vœtu®
 
Add_”a£d_block_to_poŞ
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) = 0;

108 
vœtu®
 
G‘_poŞ_size
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
) = 0;

109 
æash_block_ID_ty³
 
G‘_cŞde¡_block_id
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
);

110 
G‘_mš_max_”a£_difã»nû
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
);

111 
S‘_GC_ªd_WL_Un™
(
GC_ªd_WL_Un™_Ba£
* );

112 
vœtu®
 
AÎoÿ‹_block_ªd_·ge_š_¶ªe_fÜ_RPG_wr™e
(cÚ¡ 
¡»am_id_ty³
 
¡»amID
, 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
) = 0;

113 
PÏÃBookK“pšgTy³
* 
G‘_¶ªe_bookk“pšg_’Œy
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
);

114 
boŞ
 
Block_has_Úgošg_gc_wl
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
);

115 
boŞ
 
Cª_execu‹_gc_wl
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
);

116 
GC_WL_¡¬‹d
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
);

117 
GC_WL_fšished
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
);

118 
R—d_Œª§ùiÚ_issued
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
);

119 
R—d_Œª§ùiÚ_£rviûd
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
);

120 
Prog¿m_Œª§ùiÚ_£rviûd
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
);

121 
boŞ
 
Is_havšg_Úgošg_´og¿m
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
block_add»ss
);

122 
boŞ
 
Is_·ge_v®id
(
Block_PoŞ_SlÙ_Ty³
* 
block
, 
æash_·ge_ID_ty³
 
·ge_id
);

123 
	g´Ùeùed
:

124 
PÏÃBookK“pšgTy³
 ****
¶ªe_mªag”
;

126 
GC_ªd_WL_Un™_Ba£
 *
	ggc_ªd_wl_un™
;

127 
	gmax_®lowed_block_”a£_couÁ
;

128 
	gtÙ®_cÚcu¼’t_¡»ams_no
;

129 
	gchªÃl_couÁ
;

130 
	gch_no_³r_chªÃl
;

131 
	gd›_no_³r_ch
;

132 
	g¶ªe_no_³r_d›
;

133 
	gblock_no_³r_¶ªe
;

134 
	g·ges_no_³r_block
;

135 
´og¿m_Œª§ùiÚ_issued
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
);

	@src/ssd/Flash_Transaction_Queue.cpp

1 
	~"FÏsh_T¿n§ùiÚ_Queue.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
	gFÏsh_T¿n§ùiÚ_Queue
::
FÏsh_T¿n§ùiÚ_Queue
() {}

7 
FÏsh_T¿n§ùiÚ_Queue
::FÏsh_T¿n§ùiÚ_Queue(
¡d
::
¡ršg
 
id
) : id(id)

11 
FÏsh_T¿n§ùiÚ_Queue
::
S‘_id
(
¡d
::
¡ršg
 
id
)

13 
this
->
id
 = id;

16 
	gFÏsh_T¿n§ùiÚ_Queue
::
push_back
(
NVM_T¿n§ùiÚ_FÏsh
* cÚ¡& 
Œª§ùiÚ
)

18 
Reque¡QueueProbe
.
EnqueueReque¡
(
Œª§ùiÚ
);

19  
	gli¡
<
	gNVM_T¿n§ùiÚ_FÏsh
*>::
push_back
(
Œª§ùiÚ
);

22 
	gFÏsh_T¿n§ùiÚ_Queue
::
push_äÚt
(
NVM_T¿n§ùiÚ_FÏsh
* cÚ¡& 
Œª§ùiÚ
)

24 
Reque¡QueueProbe
.
EnqueueReque¡
(
Œª§ùiÚ
);

25  
	gli¡
<
	gNVM_T¿n§ùiÚ_FÏsh
*>::
push_äÚt
(
Œª§ùiÚ
);

28 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
FÏsh_T¿n§ùiÚ_Queue
::
š£¹
Öi¡<NVM_T¿n§ùiÚ_FÏsh*>::™”©Ü 
pos™iÚ
, NVM_T¿n§ùiÚ_FÏsh* cÚ¡& 
Œª§ùiÚ
)

30 
	gReque¡QueueProbe
.
EnqueueReque¡
(
Œª§ùiÚ
);

31  
	gli¡
<
	gNVM_T¿n§ùiÚ_FÏsh
*>::
š£¹
(
pos™iÚ
, 
Œª§ùiÚ
);

34 
	gFÏsh_T¿n§ùiÚ_Queue
::
»move
(
NVM_T¿n§ùiÚ_FÏsh
* cÚ¡& 
Œª§ùiÚ
)

36 
Reque¡QueueProbe
.
DequeueReque¡
(
Œª§ùiÚ
);

37  
	gli¡
<
	gNVM_T¿n§ùiÚ_FÏsh
*>::
»move
(
Œª§ùiÚ
);

40 
	gFÏsh_T¿n§ùiÚ_Queue
::
»move
(
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 cÚ¡& 
™r_pos
)

42 
Reque¡QueueProbe
.
DequeueReque¡
(*
™r_pos
);

43 
	gli¡
<
	gNVM_T¿n§ùiÚ_FÏsh
*>::
”a£
(
™r_pos
);

46 
	gFÏsh_T¿n§ùiÚ_Queue
::
pİ_äÚt
()

48 
Reque¡QueueProbe
.
DequeueReque¡
(
this
->
äÚt
());

49 
	gli¡
<
	gNVM_T¿n§ùiÚ_FÏsh
*>::
pİ_äÚt
();

52 
	gFÏsh_T¿n§ùiÚ_Queue
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

54 
¡d
::
¡ršg
 
tmp
 = 
Çme_´efix
;

55 
	gxmlwr™”
.
Wr™e_¡¬t_–em’t_g
(
tmp
);

57 
	g¡d
::
¡ršg
 
©Œ
 = "Name";

58 
	g¡d
::
¡ršg
 
v®
 = 
id
;

59 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

61 
	g©Œ
 = "No_Of_Transactions_Enqueued";

62 
	gv®
 = 
¡d
::
to_¡ršg
(
Reque¡QueueProbe
.
NReque¡s
());

63 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

65 
	g©Œ
 = "No_Of_Transactions_Dequeued";

66 
	gv®
 = 
¡d
::
to_¡ršg
(
Reque¡QueueProbe
.
ND•¬tu»s
());

67 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

69 
	g©Œ
 = "Avg_Queue_Length";

70 
	gv®
 = 
¡d
::
to_¡ršg
(
Reque¡QueueProbe
.
AvgQueueL’gth
());

71 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

73 
	g©Œ
 = "Max_Queue_Length";

74 
	gv®
 = 
¡d
::
to_¡ršg
(
Reque¡QueueProbe
.
MaxQueueL’gth
());

75 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

77 
	g©Œ
 = "STDev_Queue_Length";

78 
	gv®
 = 
¡d
::
to_¡ršg
(
Reque¡QueueProbe
.
STDevQueueL’gth
());

79 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

81 
	g©Œ
 = "Avg_Transaction_Waiting_Time";

82 
	gv®
 = 
¡d
::
to_¡ršg
(
Reque¡QueueProbe
.
AvgWa™šgTime
());

83 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

85 
	g©Œ
 = "Max_Transaction_Waiting_Time";

86 
	gv®
 = 
¡d
::
to_¡ršg
(
Reque¡QueueProbe
.
MaxWa™šgTime
());

87 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg_šlše
(
©Œ
, 
v®
);

89 
	gxmlwr™”
.
Wr™e_’d_–em’t_g
();

	@src/ssd/Flash_Transaction_Queue.h

1 #iâdeà
FLASH_TRANSACTION_QUEUE_H


2 
	#FLASH_TRANSACTION_QUEUE_H


	)

4 
	~<li¡
>

5 
	~<¡ršg
>

6 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

7 
	~"Queue_Probe.h
"

8 
	~"../sim/Sim_R•Ü‹r.h
"

10 
Çme¥aû
 
	gSSD_CompÚ’ts


12 
şass
 
	gFÏsh_T¿n§ùiÚ_Queue
 : 
public
 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>,…ubliø
	gMQSimEngše
::
Sim_R•Ü‹r


14 
public
:

15 
FÏsh_T¿n§ùiÚ_Queue
();

16 
FÏsh_T¿n§ùiÚ_Queue
(
¡d
::
¡ršg
 
id
);

17 
S‘_id
(
¡d
::
¡ršg
 
id
);

18 
push_back
(
NVM_T¿n§ùiÚ_FÏsh
* const&);

19 
push_äÚt
(
NVM_T¿n§ùiÚ_FÏsh
* const&);

20 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
š£¹
Öi¡<NVM_T¿n§ùiÚ_FÏsh*>::™”©Ü 
pos™iÚ
, NVM_T¿n§ùiÚ_FÏsh* cÚ¡& 
Œª§ùiÚ
);

21 
»move
(
NVM_T¿n§ùiÚ_FÏsh
* cÚ¡& 
Œª§ùiÚ
);

22 
»move
(
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 cÚ¡& 
™r_pos
);

23 
pİ_äÚt
();

24 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

25 
	g´iv©e
:

26 
¡d
::
¡ršg
 
id
;

27 
Queue_Probe
 
	gReque¡QueueProbe
;

	@src/ssd/GC_and_WL_Unit_Base.cpp

1 
	~"GC_ªd_WL_Un™_Ba£.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
GC_ªd_WL_Un™_Ba£
* 
	gGC_ªd_WL_Un™_Ba£
::
_my_š¡ªû
;

7 
	gGC_ªd_WL_Un™_Ba£
::
GC_ªd_WL_Un™_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
,

8 
Add»ss_M­pšg_Un™_Ba£
* 
add»ss_m­pšg_un™
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
, 
TSU_Ba£
* 
tsu
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

9 
GC_Block_S–eùiÚ_PŞicy_Ty³
 
block_£ËùiÚ_pŞicy
, 
gc_th»shŞd
, 
boŞ
 
´“m±ibË_gc_’abËd
, 
gc_h¬d_th»shŞd
,

10 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

11 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
£ùÜ_no_³r_·ge
,

12 
boŞ
 
u£_cİyback
, 
rho
, 
max_Úgošg_gc_»qs_³r_¶ªe
, boŞ 
dyÇmic_w—¾ev–šg_’abËd
, boŞ 
¡©ic_w—¾ev–šg_’abËd
, 
¡©ic_w—¾ev–šg_th»shŞd
, 
£ed
) :

13 
Sim_Objeù
(
id
), 
add»ss_m­pšg_un™
×dd»ss_m­pšg_un™), 
block_mªag”
(block_mªag”), 
tsu
Ñsu), 
æash_cÚŒŞËr
(æash_cÚŒŞËr), 
fÜû_gc
(
çl£
),

14 
block_£ËùiÚ_pŞicy
(block_£ËùiÚ_pŞicy), 
gc_th»shŞd
(gc_th»shŞd), 
u£_cİyback
(use_copyback),

15 
´“m±ibË_gc_’abËd
Õ»em±ibË_gc_’abËd), 
gc_h¬d_th»shŞd
(gc_hard_threshold),

16 
¿ndom_g’”©Ü
(
£ed
), 
max_Úgošg_gc_»qs_³r_¶ªe
(max_ongoing_gc_reqs_per_plane),

17 
chªÃl_couÁ
(chªÃl_couÁ), 
ch_no_³r_chªÃl
(ch_no_³r_chªÃl), 
d›_no_³r_ch
(d›_no_³r_ch), 
¶ªe_no_³r_d›
(plane_no_per_die),

18 
block_no_³r_¶ªe
(block_no_³r_¶ªe), 
·ges_no_³r_block
(
·ge_no_³r_block
), 
£ùÜ_no_³r_·ge
(sector_no_per_page),

19 
dyÇmic_w—¾ev–šg_’abËd
(dyÇmic_w—¾ev–šg_’abËd), 
¡©ic_w—¾ev–šg_’abËd
(¡©ic_w—¾ev–šg_’abËd), 
¡©ic_w—¾ev–šg_th»shŞd
(static_wearleveling_threshold)

21 
	g_my_š¡ªû
 = 
this
;

22 
	gblock_poŞ_gc_th»shŞd
 = ()(
gc_th»shŞd
 * ()
block_no_³r_¶ªe
);

23 ià(
	gblock_poŞ_gc_th»shŞd
 < 1) {

24 
	gblock_poŞ_gc_th»shŞd
 = 1;

26 
	gblock_poŞ_gc_h¬d_th»shŞd
 = ()(
gc_h¬d_th»shŞd
 * ()
block_no_³r_¶ªe
);

27 ià(
	gblock_poŞ_gc_h¬d_th»shŞd
 < 1) {

28 
	gblock_poŞ_gc_h¬d_th»shŞd
 = 1;

30 
	g¿ndom_µ_th»shŞd
 = ()(
rho
 * 
·ges_no_³r_block
);

31 ià(
	gblock_poŞ_gc_th»shŞd
 < 
	gmax_Úgošg_gc_»qs_³r_¶ªe
) {

32 
	gblock_poŞ_gc_th»shŞd
 = 
max_Úgošg_gc_»qs_³r_¶ªe
;

36 
	gGC_ªd_WL_Un™_Ba£
::
S‘up_Œigg”s
()

38 
Sim_Objeù
::
S‘up_Œigg”s
();

39 
	gæash_cÚŒŞËr
->
CÚÃùToT¿n§ùiÚS”viûdSigÇl
(
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
);

42 
	gGC_ªd_WL_Un™_Ba£
::
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

44 
PÏÃBookK“pšgTy³
* 
pbke
 = &(
_my_š¡ªû
->
block_mªag”
->
¶ªe_mªag”
[
Œª§ùiÚ
->
Add»ss
.
ChªÃlID
][Œª§ùiÚ->Add»ss.
ChID
][Œª§ùiÚ->Add»ss.
D›ID
][Œª§ùiÚ->Add»ss.
PÏÃID
]);

46 
	gŒª§ùiÚ
->
	gSourû
) {

47 
	gT¿n§ùiÚ_Sourû_Ty³
::
USERIO
:

48 
T¿n§ùiÚ_Sourû_Ty³
::
MAPPING
:

49 
T¿n§ùiÚ_Sourû_Ty³
::
CACHE
:

50 
Œª§ùiÚ
->
Ty³
)

52 
T¿n§ùiÚ_Ty³
::
READ
:

53 
_my_š¡ªû
->
block_mªag”
->
R—d_Œª§ùiÚ_£rviûd
(
Œª§ùiÚ
->
Add»ss
);

55 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

56 
_my_š¡ªû
->
block_mªag”
->
Prog¿m_Œª§ùiÚ_£rviûd
(
Œª§ùiÚ
->
Add»ss
);

59 
PRINT_ERROR
("Unexpected situation inhe GC_and_WL_Unit_Base function!")

61 ià(
_my_š¡ªû
->
block_mªag”
->
Block_has_Úgošg_gc_wl
(
Œª§ùiÚ
->
Add»ss
)) {

62 ià(
_my_š¡ªû
->
block_mªag”
->
Cª_execu‹_gc_wl
(
Œª§ùiÚ
->
Add»ss
)) {

63 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
gc_wl_ÿndid©e_add»ss
(
Œª§ùiÚ
->
Add»ss
);

64 
Block_PoŞ_SlÙ_Ty³
* 
	gblock
 = &
pbke
->
Blocks
[
Œª§ùiÚ
->
Add»ss
.
BlockID
];

65 
	gSts
::
TÙ®_gc_executiÚs
++;

66 
	g_my_š¡ªû
->
	gtsu
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

67 
NVM_T¿n§ùiÚ_FÏsh_ER
* 
	ggc_wl_”a£_Œ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_ER(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
gc_wl_ÿndid©e_add»ss
);

70 ià(
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
 - block->
	gInv®id_·ge_couÁ
 > 0) {

72 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	ggc_wl_»ad
 = 
NULL
;

73 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	ggc_wl_wr™e
 = 
NULL
;

74 
æash_·ge_ID_ty³
 
	g·geID
 = 0;…ageID < 
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
;…ageID++) {

75 ià(
	g_my_š¡ªû
->
	gblock_mªag”
->
Is_·ge_v®id
(
block
, 
·geID
)) {

76 
	gSts
::
TÙ®_·ge_movem’ts_fÜ_gc
++;

77 
	ggc_wl_ÿndid©e_add»ss
.
	gPageID
 = 
·geID
;

78 ià(
	g_my_š¡ªû
->
	gu£_cİyback
) {

79 
	ggc_wl_wr™e
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
_my_š¡ªû
->
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

80 
NO_LPA
, 
_my_š¡ªû
->
add»ss_m­pšg_un™
->
CÚv”t_add»ss_to_µa
(
gc_wl_ÿndid©e_add»ss
), 
NULL
, 0, NULL, 0, 
INVALID_TIME_STAMP
);

81 
	ggc_wl_wr™e
->
	gExecutiÚMode
 = 
Wr™eExecutiÚModeTy³
::
COPYBACK
;

82 
	g_my_š¡ªû
->
	gtsu
->
Subm™_Œª§ùiÚ
(
gc_wl_wr™e
);

84 
	ggc_wl_»ad
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
_my_š¡ªû
->
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

85 
NO_LPA
, 
_my_š¡ªû
->
add»ss_m­pšg_un™
->
CÚv”t_add»ss_to_µa
(
gc_wl_ÿndid©e_add»ss
), gc_wl_ÿndid©e_add»ss, 
NULL
, 0, NULL, 0, 
INVALID_TIME_STAMP
);

86 
	ggc_wl_wr™e
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
_my_š¡ªû
->
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

87 
NO_LPA
, 
NO_PPA
, 
gc_wl_ÿndid©e_add»ss
, 
NULL
, 0, 
gc_wl_»ad
, 0, 
INVALID_TIME_STAMP
);

88 
	ggc_wl_wr™e
->
	gExecutiÚMode
 = 
Wr™eExecutiÚModeTy³
::
SIMPLE
;

89 
	ggc_wl_wr™e
->
	gR–©edE¿£
 = 
gc_wl_”a£_Œ
;

90 
	ggc_wl_»ad
->
	gR–©edWr™e
 = 
gc_wl_wr™e
;

91 
	g_my_š¡ªû
->
	gtsu
->
Subm™_Œª§ùiÚ
(
gc_wl_»ad
);

93 
	ggc_wl_”a£_Œ
->
	gPage_movem’t_aùiv™›s
.
push_back
(
gc_wl_wr™e
);

97 
	gblock
->
	gE¿£_Œª§ùiÚ
 = 
gc_wl_”a£_Œ
;

98 
	g_my_š¡ªû
->
	gtsu
->
ScheduË
();

105 
	gŒª§ùiÚ
->
	gTy³
) {

106 
	gT¿n§ùiÚ_Ty³
::
READ
:

108 
PPA_ty³
 
µa
;

109 
MPPN_ty³
 
	gmµa
;

110 
·ge_¡©us_ty³
 
	g·ge_¡©us_b™m­
;

111 ià(
	gpbke
->
	gBlocks
[
Œª§ùiÚ
->
Add»ss
.
BlockID
].
	gHŞds_m­pšg_d©a
) {

112 
	g_my_š¡ªû
->
	gadd»ss_m­pšg_un™
->
G‘_Œª¦©iÚ_m­pšg_šfo_fÜ_gc
(
Œª§ùiÚ
->
SŒ—m_id
, (
MVPN_ty³
é¿n§ùiÚ->
LPA
, 
mµa
, 
·ge_¡©us_b™m­
);

114 ià(
	gmµa
 =ğ
Œª§ùiÚ
->
PPA
) {

115 
_my_š¡ªû
->
tsu
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

116 ((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gR–©edWr™e
->
	gwr™e_£ùÜs_b™m­
 = 
FULL_PROGRAMMED_PAGE
;

117 ((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gR–©edWr™e
->
	gLPA
 = 
Œª§ùiÚ
->
LPA
;

118 ((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gR–©edWr™e
->
	gR–©edR—d
 = 
NULL
;

119 
	g_my_š¡ªû
->
	gadd»ss_m­pšg_un™
->
AÎoÿ‹_Ãw_·ge_fÜ_gc
(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
, 
pbke
->
Blocks
[Œª§ùiÚ->
Add»ss
.
BlockID
].
HŞds_m­pšg_d©a
);

120 
	g_my_š¡ªû
->
	gtsu
->
Subm™_Œª§ùiÚ
(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
);

121 
	g_my_š¡ªû
->
	gtsu
->
ScheduË
();

123 
PRINT_ERROR
("Inconsistency found when moving‡…age for GC/WL!")

126 
	g_my_š¡ªû
->
	gadd»ss_m­pšg_un™
->
G‘_d©a_m­pšg_šfo_fÜ_gc
(
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
LPA
, 
µa
, 
·ge_¡©us_b™m­
);

129 ià(
	gµa
 =ğ
Œª§ùiÚ
->
PPA
) {

130 
_my_š¡ªû
->
tsu
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

131 ((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gR–©edWr™e
->
	gwr™e_£ùÜs_b™m­
 = 
·ge_¡©us_b™m­
;

132 ((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gR–©edWr™e
->
	gLPA
 = 
Œª§ùiÚ
->
LPA
;

133 ((
	gNVM_T¿n§ùiÚ_FÏsh_RD
*)
	gŒª§ùiÚ
)->
	gR–©edWr™e
->
	gR–©edR—d
 = 
NULL
;

134 
	g_my_š¡ªû
->
	gadd»ss_m­pšg_un™
->
AÎoÿ‹_Ãw_·ge_fÜ_gc
(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
, 
pbke
->
Blocks
[Œª§ùiÚ->
Add»ss
.
BlockID
].
HŞds_m­pšg_d©a
);

135 
	g_my_š¡ªû
->
	gtsu
->
Subm™_Œª§ùiÚ
(((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
Œª§ùiÚ
)->
R–©edWr™e
);

136 
	g_my_š¡ªû
->
	gtsu
->
ScheduË
();

138 
PRINT_ERROR
("Inconsistency found when moving‡…age for GC/WL!")

143 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

144 ià(
pbke
->
Blocks
[((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
Œª§ùiÚ
)->
R–©edE¿£
->
Add»ss
.
BlockID
].
HŞds_m­pšg_d©a
) {

145 
_my_š¡ªû
->
add»ss_m­pšg_un™
->
Remove_b¬r›r_fÜ_acûssšg_mv²
(
Œª§ùiÚ
->
SŒ—m_id
, (
MVPN_ty³
é¿n§ùiÚ->
LPA
);

146 
DEBUG
(
SimuÏtÜ
->
Time
(è<< ": MVPN=" << (
MVPN_ty³
)
Œª§ùiÚ
->
LPA
 << " unlocked!!");

148 
	g_my_š¡ªû
->
	gadd»ss_m­pšg_un™
->
Remove_b¬r›r_fÜ_acûssšg_Ía
(
Œª§ùiÚ
->
SŒ—m_id
,¿n§ùiÚ->
LPA
);

149 
DEBUG
(
SimuÏtÜ
->
Time
(è<< ": LPA=" << (
MVPN_ty³
)
Œª§ùiÚ
->
LPA
 << " unlocked!!");

151 
	gpbke
->
	gBlocks
[((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
Œª§ùiÚ
)->
R–©edE¿£
->
Add»ss
.
BlockID
].
	gE¿£_Œª§ùiÚ
->
	gPage_movem’t_aùiv™›s
.
»move
((NVM_Transaction_Flash_WR*)transaction);

153 
	gT¿n§ùiÚ_Ty³
::
ERASE
:

154 
pbke
->
Ongošg_”a£_İ”©iÚs
.
”a£
Õbke->Ongošg_”a£_İ”©iÚs.
fšd
(
Œª§ùiÚ
->
Add»ss
.
BlockID
));

155 
	g_my_š¡ªû
->
	gblock_mªag”
->
Add_”a£d_block_to_poŞ
(
Œª§ùiÚ
->
Add»ss
);

156 
	g_my_š¡ªû
->
	gblock_mªag”
->
GC_WL_fšished
(
Œª§ùiÚ
->
Add»ss
);

157 ià(
	g_my_š¡ªû
->
check_¡©ic_wl_»quœed
(
Œª§ùiÚ
->
Add»ss
)) {

158 
	g_my_š¡ªû
->
run_¡©ic_w—¾ev–šg
(
Œª§ùiÚ
->
Add»ss
);

160 
	g_my_š¡ªû
->
	gadd»ss_m­pšg_un™
->
S¹_£rvicšg_wr™es_fÜ_ov”fuÎ_¶ªe
(
Œª§ùiÚ
->
Add»ss
);

162 ià(
	g_my_š¡ªû
->
Stİ_£rvicšg_wr™es
(
Œª§ùiÚ
->
Add»ss
)) {

163 
	g_my_š¡ªû
->
Check_gc_»quœed
(
pbke
->
G‘_ä“_block_poŞ_size
(), 
Œª§ùiÚ
->
Add»ss
);

169 
	gGC_ªd_WL_Un™_Ba£
::
S¹_simuÏtiÚ
()

173 
GC_ªd_WL_Un™_Ba£
::
V®id©e_simuÏtiÚ_cÚfig
()

177 
GC_ªd_WL_Un™_Ba£
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev
)

181 
GC_Block_S–eùiÚ_PŞicy_Ty³
 
GC_ªd_WL_Un™_Ba£
::
G‘_gc_pŞicy
()

183  
block_£ËùiÚ_pŞicy
;

186 
	gGC_ªd_WL_Un™_Ba£
::
G‘_GC_pŞicy_¥ecific_·¿m‘”
()

188 
block_£ËùiÚ_pŞicy
) {

189 
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RGA
:

190  
rga_£t_size
;

191 
	gGC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_PP
:

192  
¿ndom_µ_th»shŞd
;

198 
	gGC_ªd_WL_Un™_Ba£
::
G‘_mšimum_numb”_of_ä“_·ges_befÜe_GC
()

200  
block_poŞ_gc_th»shŞd
;

206 
boŞ
 
	gGC_ªd_WL_Un™_Ba£
::
U£_dyÇmic_w—¾ev–šg
()

208  
dyÇmic_w—¾ev–šg_’abËd
;

211 
šlše
 
boŞ
 
	gGC_ªd_WL_Un™_Ba£
::
U£_¡©ic_w—¾ev–šg
()

213  
¡©ic_w—¾ev–šg_’abËd
;

216 
boŞ
 
	gGC_ªd_WL_Un™_Ba£
::
Stİ_£rvicšg_wr™es
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
)

218 
PÏÃBookK“pšgTy³
* 
pbke
 = &(
_my_š¡ªû
->
block_mªag”
->
¶ªe_mªag”
[
¶ªe_add»ss
.
ChªÃlID
][¶ªe_add»ss.
ChID
][¶ªe_add»ss.
D›ID
][¶ªe_add»ss.
PÏÃID
]);

219  
	gblock_mªag”
->
G‘_poŞ_size
(
¶ªe_add»ss
è< 
	gmax_Úgošg_gc_»qs_³r_¶ªe
;

222 
boŞ
 
	gGC_ªd_WL_Un™_Ba£
::
is_§ã_gc_wl_ÿndid©e
(cÚ¡ 
PÏÃBookK“pšgTy³
* 
¶ªe_»cÜd
, cÚ¡ 
æash_block_ID_ty³
 
gc_wl_ÿndid©e_block_id
)

225 
	g¡»am_id
 = 0; sŒ—m_id < 
	gadd»ss_m­pšg_un™
->
G‘_no_of_šput_¡»ams
(); stream_id++) {

226 ià((&
	g¶ªe_»cÜd
->
	gBlocks
[
gc_wl_ÿndid©e_block_id
]è=ğ
¶ªe_»cÜd
->
D©a_wf
[
¡»am_id
]

227 || (&
¶ªe_»cÜd
->
Blocks
[
gc_wl_ÿndid©e_block_id
]è=ğ¶ªe_»cÜd->
T¿n¦©iÚ_wf
[
¡»am_id
]

228 || (&
¶ªe_»cÜd
->
Blocks
[
gc_wl_ÿndid©e_block_id
]è=ğ¶ªe_»cÜd->
GC_wf
[
¡»am_id
]) {

229  
çl£
;

234 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
gc_wl_ÿndid©e_block_id
].
	gOngošg_u£r_´og¿m_couÁ
 > 0) {

235  
	gçl£
;

238 ià(
	g¶ªe_»cÜd
->
	gBlocks
[
gc_wl_ÿndid©e_block_id
].
	gHas_Úgošg_gc_wl
) {

239  
	gçl£
;

242  
	gŒue
;

245 
šlše
 
boŞ
 
	gGC_ªd_WL_Un™_Ba£
::
check_¡©ic_wl_»quœed
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
)

247  
¡©ic_w—¾ev–šg_’abËd
 && (
block_mªag”
->
G‘_mš_max_”a£_difã»nû
(
¶ªe_add»ss
è>ğ
¡©ic_w—¾ev–šg_th»shŞd
);

250 
	gGC_ªd_WL_Un™_Ba£
::
run_¡©ic_w—¾ev–šg
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
)

252 
PÏÃBookK“pšgTy³
* 
pbke
 = 
block_mªag”
->
G‘_¶ªe_bookk“pšg_’Œy
(
¶ªe_add»ss
);

253 
æash_block_ID_ty³
 
	gwl_ÿndid©e_block_id
 = 
block_mªag”
->
G‘_cŞde¡_block_id
(
¶ªe_add»ss
);

254 ià(!
is_§ã_gc_wl_ÿndid©e
(
pbke
, 
wl_ÿndid©e_block_id
)) {

258 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
wl_ÿndid©e_add»ss
(
¶ªe_add»ss
);

259 
	gwl_ÿndid©e_add»ss
.
	gBlockID
 = 
wl_ÿndid©e_block_id
;

260 
Block_PoŞ_SlÙ_Ty³
* 
	gblock
 = &
pbke
->
Blocks
[
wl_ÿndid©e_block_id
];

263 
	gblock_mªag”
->
GC_WL_¡¬‹d
(
wl_ÿndid©e_block_id
);

264 
	gpbke
->
	gOngošg_”a£_İ”©iÚs
.
š£¹
(
wl_ÿndid©e_block_id
);

265 
	gadd»ss_m­pšg_un™
->
S‘_b¬r›r_fÜ_acûssšg_physiÿl_block
(
wl_ÿndid©e_add»ss
);

266 ià(
	gblock_mªag”
->
Cª_execu‹_gc_wl
(
wl_ÿndid©e_add»ss
)) {

267 
	gSts
::
TÙ®_wl_executiÚs
++;

268 
	gtsu
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

270 
NVM_T¿n§ùiÚ_FÏsh_ER
* 
	gwl_”a£_Œ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_ER(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
pbke
->
Blocks
[
wl_ÿndid©e_block_id
].
SŒ—m_id
, 
wl_ÿndid©e_add»ss
);

271 ià(
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
 - block->
	gInv®id_·ge_couÁ
 > 0) {

272 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	gwl_»ad
 = 
NULL
;

273 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	gwl_wr™e
 = 
NULL
;

274 
æash_·ge_ID_ty³
 
	g·geID
 = 0;…ageID < 
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
;…ageID++) {

275 ià(
	gblock_mªag”
->
Is_·ge_v®id
(
block
, 
·geID
)) {

276 
	gSts
::
TÙ®_·ge_movem’ts_fÜ_gc
;

277 
	gwl_ÿndid©e_add»ss
.
	gPageID
 = 
·geID
;

278 ià(
	gu£_cİyback
) {

279 
	gwl_wr™e
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

280 
NO_LPA
, 
add»ss_m­pšg_un™
->
CÚv”t_add»ss_to_µa
(
wl_ÿndid©e_add»ss
), 
NULL
, 0, NULL, 0, 
INVALID_TIME_STAMP
);

281 
	gwl_wr™e
->
	gExecutiÚMode
 = 
Wr™eExecutiÚModeTy³
::
COPYBACK
;

282 
	gtsu
->
Subm™_Œª§ùiÚ
(
wl_wr™e
);

284 
	gwl_»ad
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

285 
NO_LPA
, 
add»ss_m­pšg_un™
->
CÚv”t_add»ss_to_µa
(
wl_ÿndid©e_add»ss
), wl_ÿndid©e_add»ss, 
NULL
, 0, NULL, 0, 
INVALID_TIME_STAMP
);

286 
	gwl_wr™e
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

287 
NO_LPA
, 
NO_PPA
, 
wl_ÿndid©e_add»ss
, 
NULL
, 0, 
wl_»ad
, 0, 
INVALID_TIME_STAMP
);

288 
	gwl_wr™e
->
	gExecutiÚMode
 = 
Wr™eExecutiÚModeTy³
::
SIMPLE
;

289 
	gwl_wr™e
->
	gR–©edE¿£
 = 
wl_”a£_Œ
;

290 
	gwl_»ad
->
	gR–©edWr™e
 = 
wl_wr™e
;

291 
	gtsu
->
Subm™_Œª§ùiÚ
(
wl_»ad
);

293 
	gwl_”a£_Œ
->
	gPage_movem’t_aùiv™›s
.
push_back
(
wl_wr™e
);

297 
	gblock
->
	gE¿£_Œª§ùiÚ
 = 
wl_”a£_Œ
;

298 
	gtsu
->
Subm™_Œª§ùiÚ
(
wl_”a£_Œ
);

300 
	gtsu
->
ScheduË
();

	@src/ssd/GC_and_WL_Unit_Base.h

1 #iâdeà
GC_AND_WL_UNIT_BASE_H


2 
	#GC_AND_WL_UNIT_BASE_H


	)

4 
	~"../sim/Sim_Objeù.h
"

5 
	~"../nvm_ch/æash_memÜy/FÏsh_Ch.h
"

6 
	~"../nvm_ch/æash_memÜy/Physiÿl_Page_Add»ss.h
"

7 
	~"Add»ss_M­pšg_Un™_Ba£.h
"

8 
	~"FÏsh_Block_Mªag”_Ba£.h
"

9 
	~"TSU_Ba£.h
"

10 
	~"NVM_PHY_ONFI.h
"

13 
Çme¥aû
 
	gSSD_CompÚ’ts


15 şas 
	cGC_Block_S–eùiÚ_PŞicy_Ty³
 {

16 
	gGREEDY
,

17 
	gRGA
,

21 
	gRANDOM
, 
	gRANDOM_P
, 
	gRANDOM_PP
,

24 
	gFIFO


28 
şass
 
	gAdd»ss_M­pšg_Un™_Ba£
;

29 
şass
 
	gFÏsh_Block_Mªag”_Ba£
;

30 
şass
 
	gTSU_Ba£
;

31 
şass
 
	gNVM_PHY_ONFI
;

32 
şass
 
	gPÏÃBookK“pšgTy³
;

33 
şass
 
	gBlock_PoŞ_SlÙ_Ty³
;

38 şas 
	cGC_ªd_WL_Un™_Ba£
 : 
public
 
MQSimEngše
::
Sim_Objeù


40 
public
:

41 
GC_ªd_WL_Un™_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
,

42 
Add»ss_M­pšg_Un™_Ba£
* 
add»ss_m­pšg_un™
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
, 
TSU_Ba£
* 
tsu
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

43 
GC_Block_S–eùiÚ_PŞicy_Ty³
 
block_£ËùiÚ_pŞicy
, 
gc_th»shŞd
, 
boŞ
 
´“m±ibË_gc_’abËd
, 
gc_h¬d_th»shŞd
,

44 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

45 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
£ùÜ_no_³r_·ge
,

46 
boŞ
 
u£_cİyback
, 
rho
, 
max_Úgošg_gc_»qs_³r_¶ªe
,

47 
boŞ
 
dyÇmic_w—¾ev–šg_’abËd
, boŞ 
¡©ic_w—¾ev–šg_’abËd
, 
¡©ic_w—¾ev–šg_th»shŞd
, 
£ed
);

48 
S‘up_Œigg”s
();

49 
S¹_simuÏtiÚ
();

50 
V®id©e_simuÏtiÚ_cÚfig
();

51 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

53 
vœtu®
 
boŞ
 
GC_is_š_urg’t_mode
(cÚ¡ 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
*) = 0;

54 
vœtu®
 
Check_gc_»quœed
(cÚ¡ 
BlockPoŞSize
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªeAdd»ss
) = 0;

55 
GC_Block_S–eùiÚ_PŞicy_Ty³
 
G‘_gc_pŞicy
();

56 
G‘_GC_pŞicy_¥ecific_·¿m‘”
();

57 
G‘_mšimum_numb”_of_ä“_·ges_befÜe_GC
();

58 
boŞ
 
U£_dyÇmic_w—¾ev–šg
();

59 
boŞ
 
U£_¡©ic_w—¾ev–šg
();

60 
boŞ
 
Stİ_£rvicšg_wr™es
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
);

61 
	g´Ùeùed
:

62 
GC_Block_S–eùiÚ_PŞicy_Ty³
 
block_£ËùiÚ_pŞicy
ğGC_Block_S–eùiÚ_PŞicy_Ty³::
RGA
;

63 
GC_ªd_WL_Un™_Ba£
 * 
	g_my_š¡ªû
;

64 
Add»ss_M­pšg_Un™_Ba£
* 
	gadd»ss_m­pšg_un™
;

65 
FÏsh_Block_Mªag”_Ba£
* 
	gblock_mªag”
;

66 
TSU_Ba£
* 
	gtsu
;

67 
NVM_PHY_ONFI
* 
	gæash_cÚŒŞËr
;

68 
boŞ
 
	gfÜû_gc
;

69 
	ggc_th»shŞd
;

70 
	gblock_poŞ_gc_th»shŞd
;

71 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

72 
boŞ
 
is_§ã_gc_wl_ÿndid©e
(cÚ¡ 
PÏÃBookK“pšgTy³
* 
pbke
, cÚ¡ 
æash_block_ID_ty³
 
gc_wl_ÿndid©e_block_id
);

73 
boŞ
 
check_¡©ic_wl_»quœed
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
);

74 
run_¡©ic_w—¾ev–šg
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
¶ªe_add»ss
);

75 
boŞ
 
	gu£_cİyback
;

76 
boŞ
 
	gdyÇmic_w—¾ev–šg_’abËd
;

77 
boŞ
 
	g¡©ic_w—¾ev–šg_’abËd
;

78 
	g¡©ic_w—¾ev–šg_th»shŞd
;

81 
boŞ
 
	g´“m±ibË_gc_’abËd
;

82 
	ggc_h¬d_th»shŞd
;

83 
	gblock_poŞ_gc_h¬d_th»shŞd
;

84 
	gmax_Úgošg_gc_»qs_³r_¶ªe
;

87 
	grga_£t_size
;

88 
	gUts
::
RªdomG’”©Ü
 
¿ndom_g’”©Ü
;

89 
	g¡d
::
queue
<
Block_PoŞ_SlÙ_Ty³
*> 
block_u§ge_fifo
;

90 
	g¿ndom_µ_th»shŞd
;

92 
	gchªÃl_couÁ
;

93 
	gch_no_³r_chªÃl
;

94 
	gd›_no_³r_ch
;

95 
	g¶ªe_no_³r_d›
;

96 
	gblock_no_³r_¶ªe
;

97 
	g·ges_no_³r_block
;

98 
	g£ùÜ_no_³r_·ge
;

	@src/ssd/GC_and_WL_Unit_Page_Level.cpp

1 
	~<m©h.h
>

2 
	~<veùÜ
>

3 
	~<£t
>

4 
	~"GC_ªd_WL_Un™_Page_Lev–.h
"

5 
	~"FÏsh_Block_Mªag”.h
"

6 
	~"FTL.h
"

8 
Çme¥aû
 
	gSSD_CompÚ’ts


11 
	gGC_ªd_WL_Un™_Page_Lev–
::
GC_ªd_WL_Un™_Page_Lev–
(cÚ¡ 
sim_objeù_id_ty³
& 
id
,

12 
Add»ss_M­pšg_Un™_Ba£
* 
add»ss_m­pšg_un™
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
, 
TSU_Ba£
* 
tsu
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

13 
GC_Block_S–eùiÚ_PŞicy_Ty³
 
block_£ËùiÚ_pŞicy
, 
gc_th»shŞd
, 
boŞ
 
´“m±ibË_gc_’abËd
, 
gc_h¬d_th»shŞd
,

14 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

15 
block_no_³r_¶ªe
, 
Page_no_³r_block
, 
£ùÜs_³r_·ge
,

16 
boŞ
 
u£_cİyback
, 
rho
, 
max_Úgošg_gc_»qs_³r_¶ªe
, boŞ 
dyÇmic_w—¾ev–šg_’abËd
, boŞ 
¡©ic_w—¾ev–šg_’abËd
, 
¡©ic_w—¾ev–šg_th»shŞd
, 
£ed
)

17 : 
GC_ªd_WL_Un™_Ba£
(
id
, 
add»ss_m­pšg_un™
, 
block_mªag”
, 
tsu
, 
æash_cÚŒŞËr
, 
block_£ËùiÚ_pŞicy
, 
gc_th»shŞd
, 
´“m±ibË_gc_’abËd
, 
gc_h¬d_th»shŞd
,

18 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
, 
block_no_³r_¶ªe
, 
Page_no_³r_block
, 
£ùÜs_³r_·ge
, 
u£_cİyback
, 
rho
, 
max_Úgošg_gc_»qs_³r_¶ªe
,

19 
dyÇmic_w—¾ev–šg_’abËd
, 
¡©ic_w—¾ev–šg_’abËd
, 
¡©ic_w—¾ev–šg_th»shŞd
, 
£ed
)

21 
	grga_£t_size
 = ()
log2
(
block_no_³r_¶ªe
);

24 
boŞ
 
	gGC_ªd_WL_Un™_Page_Lev–
::
GC_is_š_urg’t_mode
(cÚ¡ 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

26 ià(!
´“m±ibË_gc_’abËd
) {

27  
Œue
;

30 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
addr
;

31 
	gaddr
.
	gChªÃlID
 = 
ch
->
ChªÃlID
;‡ddr.
	gChID
 = ch->
ChID
;

32 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

33 
	g¶ªe_id
 = 0;…ÏÃ_id < 
	g¶ªe_no_³r_d›
;…lane_id++) {

34 
	gaddr
.
	gD›ID
 = 
d›_id
;‡ddr.
	gPÏÃID
 = 
¶ªe_id
;

35 ià(
	gblock_mªag”
->
G‘_poŞ_size
(
addr
è< 
	gblock_poŞ_gc_h¬d_th»shŞd
)

36  
	gŒue
;

40  
	gçl£
;

43 
	gGC_ªd_WL_Un™_Page_Lev–
::
Check_gc_»quœed
(cÚ¡ 
ä“_block_poŞ_size
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
)

45 ià(
ä“_block_poŞ_size
 < 
block_poŞ_gc_th»shŞd
) {

46 
æash_block_ID_ty³
 
gc_ÿndid©e_block_id
 = 
block_mªag”
->
G‘_cŞde¡_block_id
(
¶ªe_add»ss
);

47 
PÏÃBookK“pšgTy³
* 
	gpbke
 = 
block_mªag”
->
G‘_¶ªe_bookk“pšg_’Œy
(
¶ªe_add»ss
);

49 ià(
	gpbke
->
	gOngošg_”a£_İ”©iÚs
.
size
(è>ğ
max_Úgošg_gc_»qs_³r_¶ªe
) {

53 
	gblock_£ËùiÚ_pŞicy
) {

54 
	gSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
GREEDY
:

56 
gc_ÿndid©e_block_id
 = 0;

57 ià(
	gpbke
->
	gOngošg_”a£_İ”©iÚs
.
fšd
(0è!ğ
pbke
->
Ongošg_”a£_İ”©iÚs
.
’d
()) {

58 
gc_ÿndid©e_block_id
++;

60 
æash_block_ID_ty³
 
	gblock_id
 = 1; block_id < 
	gblock_no_³r_¶ªe
; block_id++) {

61 ià(
	gpbke
->
	gBlocks
[
block_id
].
	gInv®id_·ge_couÁ
 >…bke->Blocks[
gc_ÿndid©e_block_id
].Invalid_page_count

64 && 
	gpbke
->
	gBlocks
[
block_id
].
	gCu¼’t_·ge_wr™e_šdex
 =ğ
·ges_no_³r_block


65 && 
is_§ã_gc_wl_ÿndid©e
(
pbke
, 
block_id
)) {

66 
	ggc_ÿndid©e_block_id
 = 
block_id
;

71 
	gSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RGA
:

73 
¡d
::
£t
<
æash_block_ID_ty³
> 
¿ndom_£t
;

74 
	g¿ndom_£t
.
size
(è< 
	grga_£t_size
) {

75 
æash_block_ID_ty³
 
	gblock_id
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, 
block_no_³r_¶ªe
 - 1);

76 ià(
	gpbke
->
	gOngošg_”a£_İ”©iÚs
.
fšd
(
block_id
è=ğ
pbke
->
Ongošg_”a£_İ”©iÚs
.
’d
()

77 && 
is_§ã_gc_wl_ÿndid©e
(
pbke
, 
block_id
)) {

78 
	g¿ndom_£t
.
š£¹
(
block_id
);

81 
	ggc_ÿndid©e_block_id
 = *
¿ndom_£t
.
begš
();

82 autØ&
	gblock_id
 : 
¿ndom_£t
) {

83 ià(
pbke
->
Blocks
[
block_id
].
Inv®id_·ge_couÁ
 >…bke->Blocks[
gc_ÿndid©e_block_id
].Invalid_page_count

84 && 
pbke
->
Blocks
[
block_id
].
Cu¼’t_·ge_wr™e_šdex
 =ğ
·ges_no_³r_block
) {

85 
gc_ÿndid©e_block_id
 = 
block_id
;

90 
	gSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM
:

92 
gc_ÿndid©e_block_id
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, 
block_no_³r_¶ªe
 - 1);

93 
	g»³©
 = 0;

96 !
is_§ã_gc_wl_ÿndid©e
(
pbke
, 
gc_ÿndid©e_block_id
è&& 
	g»³©
++ < 
	gblock_no_³r_¶ªe
) {

97 
	ggc_ÿndid©e_block_id
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, 
block_no_³r_¶ªe
 - 1);

101 
	gSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_P
:

103 
gc_ÿndid©e_block_id
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, 
block_no_³r_¶ªe
 - 1);

104 
	g»³©
 = 0;

107 (
	gpbke
->
	gBlocks
[
gc_ÿndid©e_block_id
].
	gCu¼’t_·ge_wr™e_šdex
 < 
	g·ges_no_³r_block
 || !
is_§ã_gc_wl_ÿndid©e
(
pbke
, gc_candidate_block_id))

108 && 
	g»³©
++ < 
	gblock_no_³r_¶ªe
) {

109 
	ggc_ÿndid©e_block_id
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, 
block_no_³r_¶ªe
 - 1);

113 
	gSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
RANDOM_PP
:

115 
gc_ÿndid©e_block_id
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, 
block_no_³r_¶ªe
 - 1);

116 
	g»³©
 = 0;

119 (
	gpbke
->
	gBlocks
[
gc_ÿndid©e_block_id
].
	gCu¼’t_·ge_wr™e_šdex
 < 
	g·ges_no_³r_block


120 || 
	gpbke
->
	gBlocks
[
gc_ÿndid©e_block_id
].
	gInv®id_·ge_couÁ
 < 
	g¿ndom_µ_th»shŞd


121 || !
is_§ã_gc_wl_ÿndid©e
(
pbke
, 
gc_ÿndid©e_block_id
))

122 && 
	g»³©
++ < 
	gblock_no_³r_¶ªe
) {

123 
	ggc_ÿndid©e_block_id
 = 
¿ndom_g’”©Ü
.
UnifÜm_ušt
(0, 
block_no_³r_¶ªe
 - 1);

127 
	gSSD_CompÚ’ts
::
GC_Block_S–eùiÚ_PŞicy_Ty³
::
FIFO
:

128 
gc_ÿndid©e_block_id
 = 
pbke
->
Block_u§ge_hi¡Üy
.
äÚt
();

129 
	gpbke
->
	gBlock_u§ge_hi¡Üy
.
pİ
();

136 ià(
	gpbke
->
	gOngošg_”a£_İ”©iÚs
.
fšd
(
gc_ÿndid©e_block_id
è!ğ
pbke
->
Ongošg_”a£_İ”©iÚs
.
’d
()) {

140 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
gc_ÿndid©e_add»ss
(
¶ªe_add»ss
);

141 
	ggc_ÿndid©e_add»ss
.
	gBlockID
 = 
gc_ÿndid©e_block_id
;

142 
Block_PoŞ_SlÙ_Ty³
* 
	gblock
 = &
pbke
->
Blocks
[
gc_ÿndid©e_block_id
];

145 ià(
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
 =ğ0 || 
block
->
Inv®id_·ge_couÁ
 == 0) {

150 
	gblock_mªag”
->
GC_WL_¡¬‹d
(
gc_ÿndid©e_add»ss
);

151 
	gpbke
->
	gOngošg_”a£_İ”©iÚs
.
š£¹
(
gc_ÿndid©e_block_id
);

152 
	gadd»ss_m­pšg_un™
->
S‘_b¬r›r_fÜ_acûssšg_physiÿl_block
(
gc_ÿndid©e_add»ss
);

155 ià(
	gblock_mªag”
->
Cª_execu‹_gc_wl
(
gc_ÿndid©e_add»ss
)) {

156 
	gSts
::
TÙ®_gc_executiÚs
++;

157 
	gtsu
->
P»·»_fÜ_Œª§ùiÚ_subm™
();

159 
NVM_T¿n§ùiÚ_FÏsh_ER
* 
	ggc_”a£_Œ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_ER(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
pbke
->
Blocks
[
gc_ÿndid©e_block_id
].
SŒ—m_id
, 
gc_ÿndid©e_add»ss
);

161 ià(
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
 - block->
	gInv®id_·ge_couÁ
 > 0) {

162 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	ggc_»ad
 = 
NULL
;

163 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	ggc_wr™e
 = 
NULL
;

164 
æash_·ge_ID_ty³
 
	g·geID
 = 0;…ageID < 
	gblock
->
	gCu¼’t_·ge_wr™e_šdex
;…ageID++) {

165 ià(
	gblock_mªag”
->
Is_·ge_v®id
(
block
, 
·geID
)) {

166 
	gSts
::
TÙ®_·ge_movem’ts_fÜ_gc
++;

167 
	ggc_ÿndid©e_add»ss
.
	gPageID
 = 
·geID
;

168 ià(
	gu£_cİyback
) {

169 
	ggc_wr™e
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

170 
NO_LPA
, 
add»ss_m­pšg_un™
->
CÚv”t_add»ss_to_µa
(
gc_ÿndid©e_add»ss
), 
NULL
, 0, NULL, 0, 
INVALID_TIME_STAMP
);

171 
	ggc_wr™e
->
	gExecutiÚMode
 = 
Wr™eExecutiÚModeTy³
::
COPYBACK
;

172 
	gtsu
->
Subm™_Œª§ùiÚ
(
gc_wr™e
);

174 
	ggc_»ad
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

175 
NO_LPA
, 
add»ss_m­pšg_un™
->
CÚv”t_add»ss_to_µa
(
gc_ÿndid©e_add»ss
), gc_ÿndid©e_add»ss, 
NULL
, 0, NULL, 0, 
INVALID_TIME_STAMP
);

176 
	ggc_wr™e
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
::
GC_WL
, 
block
->
SŒ—m_id
, 
£ùÜ_no_³r_·ge
 * 
SECTOR_SIZE_IN_BYTE
,

177 
NO_LPA
, 
NO_PPA
, 
gc_ÿndid©e_add»ss
, 
NULL
, 0, 
gc_»ad
, 0, 
INVALID_TIME_STAMP
);

178 
	ggc_wr™e
->
	gExecutiÚMode
 = 
Wr™eExecutiÚModeTy³
::
SIMPLE
;

179 
	ggc_wr™e
->
	gR–©edE¿£
 = 
gc_”a£_Œ
;

180 
	ggc_»ad
->
	gR–©edWr™e
 = 
gc_wr™e
;

181 
	gtsu
->
Subm™_Œª§ùiÚ
(
gc_»ad
);

183 
	ggc_”a£_Œ
->
	gPage_movem’t_aùiv™›s
.
push_back
(
gc_wr™e
);

187 
	gblock
->
	gE¿£_Œª§ùiÚ
 = 
gc_”a£_Œ
;

188 
	gtsu
->
Subm™_Œª§ùiÚ
(
gc_”a£_Œ
);

190 
	gtsu
->
ScheduË
();

	@src/ssd/GC_and_WL_Unit_Page_Level.h

1 #iâdeà
GC_AND_WL_UNIT_PAGE_LEVEL_H


2 
	#GC_AND_WL_UNIT_PAGE_LEVEL_H


	)

4 
	~"GC_ªd_WL_Un™_Ba£.h
"

5 
	~"NVM_PHY_ONFI.h
"

6 
	~"../uts/RªdomG’”©Ü.h
"

7 
	~<queue
>

10 
Çme¥aû
 
	gSSD_CompÚ’ts


12 şas 
	cGC_ªd_WL_Un™_Page_Lev–
 : 
public
 
GC_ªd_WL_Un™_Ba£


14 
public
:

15 
GC_ªd_WL_Un™_Page_Lev–
(cÚ¡ 
sim_objeù_id_ty³
& 
id
,

16 
Add»ss_M­pšg_Un™_Ba£
* 
add»ss_m­pšg_un™
, 
FÏsh_Block_Mªag”_Ba£
* 
block_mªag”
, 
TSU_Ba£
* 
tsu
, 
NVM_PHY_ONFI
* 
æash_cÚŒŞËr
,

17 
GC_Block_S–eùiÚ_PŞicy_Ty³
 
block_£ËùiÚ_pŞicy
, 
gc_th»shŞd
, 
boŞ
 
´“m±ibË_gc_’abËd
, 
gc_h¬d_th»shŞd
,

18 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

19 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
£ùÜs_³r_·ge
,

20 
boŞ
 
u£_cİyback
, 
rho
, 
max_Úgošg_gc_»qs_³r_¶ªe
 = 10,

21 
boŞ
 
dyÇmic_w—¾ev–šg_’abËd
 = 
Œue
, boŞ 
¡©ic_w—¾ev–šg_’abËd
 =rue, 
¡©ic_w—¾ev–šg_th»shŞd
 = 100, 
£ed
 = 432);

26 
boŞ
 
GC_is_š_urg’t_mode
(cÚ¡ 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
*);

28 
Check_gc_»quœed
(cÚ¡ 
ä“_block_poŞ_size
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
¶ªe_add»ss
);

29 
	g´iv©e
:

30 
NVM_PHY_ONFI
 * 
æash_cÚŒŞËr
;

	@src/ssd/Host_Interface_Base.cpp

1 
	~"Ho¡_IÁ”çû_Ba£.h
"

2 
	~"D©a_Cache_Mªag”_Ba£.h
"

3 
	~<io¡»am
>

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gIÅut_SŒ—m_Ba£
::
IÅut_SŒ—m_Ba£
() :

7 
STAT_numb”_of_»ad_»que¡s
(0), 
STAT_numb”_of_wr™e_»que¡s
(0),

8 
STAT_numb”_of_»ad_Œª§ùiÚs
(0), 
STAT_numb”_of_wr™e_Œª§ùiÚs
(0),

9 
STAT_sum_of_»ad_Œª§ùiÚs_executiÚ_time
(0), 
STAT_sum_of_»ad_Œª§ùiÚs_Œªsãr_time
(0), 
STAT_sum_of_»ad_Œª§ùiÚs_wa™šg_time
(0),

10 
STAT_sum_of_wr™e_Œª§ùiÚs_executiÚ_time
(0), 
STAT_sum_of_wr™e_Œª§ùiÚs_Œªsãr_time
(0), 
STAT_sum_of_wr™e_Œª§ùiÚs_wa™šg_time
(0)

13 
	gIÅut_SŒ—m_Mªag”_Ba£
::~
IÅut_SŒ—m_Mªag”_Ba£
()

15 autØ&
¡»am
 : 
šput_¡»ams
) {

16 
d–‘e
 
¡»am
;

20 
	gIÅut_SŒ—m_Ba£
::~
IÅut_SŒ—m_Ba£
()

24 
Reque¡_F‘ch_Un™_Ba£
::~Request_Fetch_Unit_Base()

26 autØ&
dma_šfo
 : 
dma_li¡
) {

27 
d–‘e
 
dma_šfo
;

31 
Ho¡_IÁ”çû_Ba£
* 
	gHo¡_IÁ”çû_Ba£
::
_my_š¡ªû
 = 
NULL
;

33 
	gHo¡_IÁ”çû_Ba£
::
Ho¡_IÁ”çû_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡IÁ”çû_Ty³s
 
ty³
, 
LHA_ty³
 
max_logiÿl_£ùÜ_add»ss
, 
£ùÜs_³r_·ge
,

34 
D©a_Cache_Mªag”_Ba£
* 
ÿche
)

35 : 
MQSimEngše
::
Sim_Objeù
(
id
), 
ty³
Ñy³), 
max_logiÿl_£ùÜ_add»ss
(max_logical_sector_address),

36 
£ùÜs_³r_·ge
(£ùÜs_³r_·ge), 
ÿche
(cache)

38 
	g_my_š¡ªû
 = 
this
;

41 
	gHo¡_IÁ”çû_Ba£
::~
Ho¡_IÁ”çû_Ba£
()

43 
d–‘e
 
šput_¡»am_mªag”
;

44 
d–‘e
 
	g»que¡_ãtch_un™
;

47 
	gHo¡_IÁ”çû_Ba£
::
S‘up_Œigg”s
()

49 
Sim_Objeù
::
S‘up_Œigg”s
();

50 
	gÿche
->
CÚÃù_to_u£r_»que¡_£rviûd_sigÇl
(
hªdË_u£r_»que¡_£rviûd_sigÇl_äom_ÿche
);

51 
	gÿche
->
CÚÃù_to_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl
(
hªdË_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl_äom_ÿche
);

54 
	gHo¡_IÁ”çû_Ba£
::
V®id©e_simuÏtiÚ_cÚfig
()

58 
Ho¡_IÁ”çû_Ba£
::
S’d_»ad_mes§ge_to_ho¡
(
ušt64_t
 
add»sss
, 
»que¡_»ad_d©a_size
)

60 
	gHo¡_CompÚ’ts
::
PCIe_Mes§ge
* 
pc›_mes§ge
 = 
Ãw
 
Ho¡_CompÚ’ts
::PCIe_Message;

61 
	gpc›_mes§ge
->
	gTy³
 = 
Ho¡_CompÚ’ts
::
PCIe_Mes§ge_Ty³
::
READ_REQ
;

62 
	gpc›_mes§ge
->
	gDe¡š©iÚ
 = 
Ho¡_CompÚ’ts
::
PCIe_De¡š©iÚ_Ty³
::
HOST
;

63 
	gpc›_mes§ge
->
	gAdd»ss
 = 
add»sss
;

64 
	gpc›_mes§ge
->
	gPaylßd
 = (*)(
šŒ_t
)
»que¡_»ad_d©a_size
;

65 
	gpc›_mes§ge
->
	gPaylßd_size
 = (
»que¡_»ad_d©a_size
);

66 
	gpc›_sw™ch
->
S’d_to_ho¡
(
pc›_mes§ge
);

69 
	gHo¡_IÁ”çû_Ba£
::
S’d_wr™e_mes§ge_to_ho¡
(
ušt64_t
 
add»sss
, * 
mes§ge
, 
mes§ge_size
)

71 
	gHo¡_CompÚ’ts
::
PCIe_Mes§ge
* 
pc›_mes§ge
 = 
Ãw
 
Ho¡_CompÚ’ts
::PCIe_Message;

72 
	gpc›_mes§ge
->
	gTy³
 = 
Ho¡_CompÚ’ts
::
PCIe_Mes§ge_Ty³
::
WRITE_REQ
;

73 
	gpc›_mes§ge
->
	gDe¡š©iÚ
 = 
Ho¡_CompÚ’ts
::
PCIe_De¡š©iÚ_Ty³
::
HOST
;

74 
	gpc›_mes§ge
->
	gAdd»ss
 = 
add»sss
;

75 
COPYDATA
(
pc›_mes§ge
->
Paylßd
, 
mes§ge
,…c›_mes§ge->
Paylßd_size
);

76 
	gpc›_mes§ge
->
	gPaylßd_size
 = 
mes§ge_size
;

77 
	gpc›_sw™ch
->
S’d_to_ho¡
(
pc›_mes§ge
);

80 
	gHo¡_IÁ”çû_Ba£
::
A‰ach_to_deviû
(
Ho¡_CompÚ’ts
::
PCIe_Sw™ch
* 
pc›_sw™ch
)

82 
this
->
pc›_sw™ch
 =…cie_switch;

85 
LHA_ty³
 
	gHo¡_IÁ”çû_Ba£
::
G‘_max_logiÿl_£ùÜ_add»ss
()

87  
max_logiÿl_£ùÜ_add»ss
;

90 
	gHo¡_IÁ”çû_Ba£
::
G‘_no_of_LHAs_š_ª_NVM_wr™e_un™
()

92  
£ùÜs_³r_·ge
;

95 
	gIÅut_SŒ—m_Mªag”_Ba£
::
IÅut_SŒ—m_Mªag”_Ba£
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
) :

96 
ho¡_š‹rçû
(host_interface)

100 
IÅut_SŒ—m_Mªag”_Ba£
::
Upd©e_Œª§ùiÚ_¡©i¡ics
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
)

103 
Œª§ùiÚ
->
Ty³
)

105 
T¿n§ùiÚ_Ty³
::
READ
:

106 
this
->
šput_¡»ams
[
Œª§ùiÚ
->
SŒ—m_id
]->
STAT_sum_of_»ad_Œª§ùiÚs_executiÚ_time
 +ğŒª§ùiÚ->
STAT_executiÚ_time
;

107 
	gthis
->
	gšput_¡»ams
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_Œªsãr_time
 +ğŒª§ùiÚ->
STAT_Œªsãr_time
;

108 
	gthis
->
	gšput_¡»ams
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_wa™šg_time
 +ğ(
SimuÏtÜ
->
Time
(è-¿n§ùiÚ->
Issue_time
è-¿n§ùiÚ->
STAT_executiÚ_time
 -¿n§ùiÚ->
STAT_Œªsãr_time
;

110 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

111 
this
->
šput_¡»ams
[
Œª§ùiÚ
->
SŒ—m_id
]->
STAT_sum_of_wr™e_Œª§ùiÚs_executiÚ_time
 +ğŒª§ùiÚ->
STAT_executiÚ_time
;

112 
	gthis
->
	gšput_¡»ams
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_Œªsãr_time
 +ğŒª§ùiÚ->
STAT_Œªsãr_time
;

113 
	gthis
->
	gšput_¡»ams
[
Œª§ùiÚ
->
SŒ—m_id
]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_wa™šg_time
 +ğ(
SimuÏtÜ
->
Time
(è-¿n§ùiÚ->
Issue_time
è-¿n§ùiÚ->
STAT_executiÚ_time
 -¿n§ùiÚ->
STAT_Œªsãr_time
;

120 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_»ad_Œª§ùiÚ_tuº¬ound_time
(
¡»am_id_ty³
 
¡»am_id
)

122 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_»ad_Œª§ùiÚs
 == 0) {

125  (
	gušt32_t
)((
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_executiÚ_time
 + iÅut_¡»ams[¡»am_id]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_Œªsãr_time
 + iÅut_¡»ams[¡»am_id]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_wa™šg_time
)

126 / 
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_numb”_of_»ad_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

129 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_»ad_Œª§ùiÚ_executiÚ_time
(
¡»am_id_ty³
 
¡»am_id
)

131 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_»ad_Œª§ùiÚs
 == 0) {

134  (
	gušt32_t
)(
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_executiÚ_time
 / iÅut_¡»ams[¡»am_id]->
	gSTAT_numb”_of_»ad_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

137 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_»ad_Œª§ùiÚ_Œªsãr_time
(
¡»am_id_ty³
 
¡»am_id
)

139 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_»ad_Œª§ùiÚs
 == 0) {

142  (
	gušt32_t
)(
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_Œªsãr_time
 / iÅut_¡»ams[¡»am_id]->
	gSTAT_numb”_of_»ad_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

145 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_»ad_Œª§ùiÚ_wa™šg_time
(
¡»am_id_ty³
 
¡»am_id
)

147 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_»ad_Œª§ùiÚs
 == 0) {

150  (
	gušt32_t
)(
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_»ad_Œª§ùiÚs_wa™šg_time
 / iÅut_¡»ams[¡»am_id]->
	gSTAT_numb”_of_»ad_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

153 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_wr™e_Œª§ùiÚ_tuº¬ound_time
(
¡»am_id_ty³
 
¡»am_id
)

155 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_wr™e_Œª§ùiÚs
 == 0) {

158  (
	gušt32_t
)((
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_executiÚ_time
 + iÅut_¡»ams[¡»am_id]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_Œªsãr_time
 + iÅut_¡»ams[¡»am_id]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_wa™šg_time
)

159 / 
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_numb”_of_wr™e_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

162 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_wr™e_Œª§ùiÚ_executiÚ_time
(
¡»am_id_ty³
 
¡»am_id
)

164 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_wr™e_Œª§ùiÚs
 == 0) {

167  (
	gušt32_t
)(
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_executiÚ_time
 / iÅut_¡»ams[¡»am_id]->
	gSTAT_numb”_of_wr™e_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

170 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_wr™e_Œª§ùiÚ_Œªsãr_time
(
¡»am_id_ty³
 
¡»am_id
)

172 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_wr™e_Œª§ùiÚs
 == 0) {

175  (
	gušt32_t
)(
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_Œªsãr_time
 / iÅut_¡»ams[¡»am_id]->
	gSTAT_numb”_of_wr™e_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

178 
ušt32_t
 
	gIÅut_SŒ—m_Mªag”_Ba£
::
G‘_av”age_wr™e_Œª§ùiÚ_wa™šg_time
(
¡»am_id_ty³
 
¡»am_id
)

180 ià(
šput_¡»ams
[
¡»am_id
]->
STAT_numb”_of_wr™e_Œª§ùiÚs
 == 0) {

183  (
	gušt32_t
)(
	gšput_¡»ams
[
¡»am_id
]->
	gSTAT_sum_of_wr™e_Œª§ùiÚs_wa™šg_time
 / iÅut_¡»ams[¡»am_id]->
	gSTAT_numb”_of_wr™e_Œª§ùiÚs
 / 
	gSIM_TIME_TO_MICROSECONDS_COEFF
);

186 
	gReque¡_F‘ch_Un™_Ba£
::
Reque¡_F‘ch_Un™_Ba£
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
) :

187 
ho¡_š‹rçû
(host_interface)

	@src/ssd/Host_Interface_Base.h

1 #iâdeà
HOST_INTERFACE_BASE_H


2 
	#HOST_INTERFACE_BASE_H


	)

4 
	~<veùÜ
>

5 
	~"../sim/Sim_Objeù.h
"

6 
	~"../sim/Sim_R•Ü‹r.h
"

7 
	~"../ho¡/PCIe_Sw™ch.h
"

8 
	~"../ho¡/PCIe_Mes§ge.h
"

9 
	~"U£r_Reque¡.h
"

10 
	~"D©a_Cache_Mªag”_Ba£.h
"

11 
	~<¡dšt.h
>

12 
	~<c¡ršg
>

14 
Çme¥aû
 
	gHo¡_CompÚ’ts


16 
şass
 
	gPCIe_Sw™ch
;

19 
Çme¥aû
 
	gSSD_CompÚ’ts


21 
	#COPYDATA
(
DEST
,
SRC
,
SIZE
èif(
SimuÏtÜ
->
	`Is_š‹g¿‹d_executiÚ_mode
()è{DEST = 
Ãw
 [SIZE]; 
	`memıy
(DEST, SRC, SIZE);} DEST = SRC;

	)

22 
	#DELETE_REQUEST_NVME
(
REQ
) \

23 
	`d–‘e
 (
SubmissiÚ_Queue_EÁry
*)
REQ
->
IO_commªd_šfo
; \

24 if(
SimuÏtÜ
->
	`Is_š‹g¿‹d_executiÚ_mode
())\

25 {if(
REQ
->
D©a
 !ğ
NULL
è
d–‘e
[] (*)REQ->Data;} \

26 if(
REQ
->
T¿n§ùiÚ_li¡
.
	`size
(è!ğ0è
	`PRINT_ERROR
("Deleting‡n unhandled user„equests inhe host interface! MQSimhinks something is going wrong!")\

27 
d–‘e
 
REQ
;

	)

29 
şass
 
	gD©a_Cache_Mªag”_Ba£
;

30 
şass
 
	gHo¡_IÁ”çû_Ba£
;

32 şas 
	cIÅut_SŒ—m_Ba£


34 
	gpublic
:

35 
IÅut_SŒ—m_Ba£
();

36 
	gvœtu®
 ~
IÅut_SŒ—m_Ba£
();

37 
	gSTAT_numb”_of_»ad_»que¡s
;

38 
	gSTAT_numb”_of_wr™e_»que¡s
;

39 
	gSTAT_numb”_of_»ad_Œª§ùiÚs
;

40 
	gSTAT_numb”_of_wr™e_Œª§ùiÚs
;

41 
sim_time_ty³
 
	gSTAT_sum_of_»ad_Œª§ùiÚs_executiÚ_time
, 
	gSTAT_sum_of_»ad_Œª§ùiÚs_Œªsãr_time
, 
	gSTAT_sum_of_»ad_Œª§ùiÚs_wa™šg_time
;

42 
sim_time_ty³
 
	gSTAT_sum_of_wr™e_Œª§ùiÚs_executiÚ_time
, 
	gSTAT_sum_of_wr™e_Œª§ùiÚs_Œªsãr_time
, 
	gSTAT_sum_of_wr™e_Œª§ùiÚs_wa™šg_time
;

45 şas 
	cIÅut_SŒ—m_Mªag”_Ba£


47 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_Ba£
;

48 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_NVMe
;

49 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_SATA
;

50 
	gpublic
:

51 
IÅut_SŒ—m_Mªag”_Ba£
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
);

52 
	gvœtu®
 ~
IÅut_SŒ—m_Mªag”_Ba£
();

53 
vœtu®
 
HªdË_Ãw_¬rived_»que¡
(
U£r_Reque¡
* 
»que¡
) = 0;

54 
vœtu®
 
HªdË_¬rived_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
) = 0;

55 
vœtu®
 
HªdË_£rviûd_»que¡
(
U£r_Reque¡
* 
»que¡
) = 0;

56 
Upd©e_Œª§ùiÚ_¡©i¡ics
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
);

57 
ušt32_t
 
G‘_av”age_»ad_Œª§ùiÚ_tuº¬ound_time
(
¡»am_id_ty³
 
¡»am_id
);

58 
ušt32_t
 
G‘_av”age_»ad_Œª§ùiÚ_executiÚ_time
(
¡»am_id_ty³
 
¡»am_id
);

59 
ušt32_t
 
G‘_av”age_»ad_Œª§ùiÚ_Œªsãr_time
(
¡»am_id_ty³
 
¡»am_id
);

60 
ušt32_t
 
G‘_av”age_»ad_Œª§ùiÚ_wa™šg_time
(
¡»am_id_ty³
 
¡»am_id
);

61 
ušt32_t
 
G‘_av”age_wr™e_Œª§ùiÚ_tuº¬ound_time
(
¡»am_id_ty³
 
¡»am_id
);

62 
ušt32_t
 
G‘_av”age_wr™e_Œª§ùiÚ_executiÚ_time
(
¡»am_id_ty³
 
¡»am_id
);

63 
ušt32_t
 
G‘_av”age_wr™e_Œª§ùiÚ_Œªsãr_time
(
¡»am_id_ty³
 
¡»am_id
);

64 
ušt32_t
 
G‘_av”age_wr™e_Œª§ùiÚ_wa™šg_time
(
¡»am_id_ty³
 
¡»am_id
);

65 
	g´Ùeùed
:

66 
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
;

67 
vœtu®
 
£gm’t_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
) = 0;

68 
	g¡d
::
veùÜ
<
IÅut_SŒ—m_Ba£
*> 
šput_¡»ams
;

71 şas 
	cReque¡_F‘ch_Un™_Ba£


73 
	gpublic
:

74 
Reque¡_F‘ch_Un™_Ba£
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
);

75 
	gvœtu®
 ~
Reque¡_F‘ch_Un™_Ba£
();

76 
vœtu®
 
F‘ch_Ãxt_»que¡
(
¡»am_id_ty³
 
¡»am_id
) = 0;

77 
vœtu®
 
F‘ch_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
) = 0;

78 
vœtu®
 
S’d_»ad_d©a
(
U£r_Reque¡
* 
»que¡
) = 0;

79 
vœtu®
 
Proûss_pc›_wr™e_mes§ge
(
ušt64_t
, *, ) = 0;

80 
vœtu®
 
Proûss_pc›_»ad_mes§ge
(
ušt64_t
, *, ) = 0;

81 
	g´Ùeùed
:

82 şas 
	cDMA_Req_Ty³
 { 
REQUEST_INFO
, 
	gWRITE_DATA
 };

83 
	sDMA_Req_I‹m


85 
DMA_Req_Ty³
 
	gTy³
;

86 * 
	gobjeù
;

88 
Ho¡_IÁ”çû_Ba£
* 
	gho¡_š‹rçû
;

89 
	g¡d
::
li¡
<
DMA_Req_I‹m
*> 
dma_li¡
;

92 
şass
 
	gHo¡_IÁ”çû_Ba£
 : 
public
 
MQSimEngše
::
Sim_Objeù
,…ubliø
	gMQSimEngše
::
Sim_R•Ü‹r


94 
ä›nd
 
şass
 
IÅut_SŒ—m_Mªag”_Ba£
;

95 
ä›nd
 
şass
 
	gIÅut_SŒ—m_Mªag”_NVMe
;

96 
ä›nd
 
şass
 
	gIÅut_SŒ—m_Mªag”_SATA
;

97 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_Ba£
;

98 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_NVMe
;

99 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_SATA
;

100 
	gpublic
:

101 
Ho¡_IÁ”çû_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
Ho¡IÁ”çû_Ty³s
 
ty³
, 
LHA_ty³
 
max_logiÿl_£ùÜ_add»ss
,

102 
£ùÜs_³r_·ge
, 
D©a_Cache_Mªag”_Ba£
* 
ÿche
);

103 
	gvœtu®
 ~
Ho¡_IÁ”çû_Ba£
();

104 
S‘up_Œigg”s
();

105 
V®id©e_simuÏtiÚ_cÚfig
();

107 (*
	gU£rReque¡A¼ivedSigÇlHªdËrTy³
è(
	tU£r_Reque¡
*);

108 
CÚÃù_to_u£r_»que¡_¬rived_sigÇl
(
U£rReque¡A¼ivedSigÇlHªdËrTy³
 
funùiÚ
)

110 
	gcÚÃùed_u£r_»que¡_¬rived_sigÇl_hªdËrs
.
push_back
(
funùiÚ
);

113 
CÚsume_pc›_mes§ge
(
Ho¡_CompÚ’ts
::
PCIe_Mes§ge
* 
mes§ge
)

115 ià(
mes§ge
->
Ty³
 =ğ
Ho¡_CompÚ’ts
::
PCIe_Mes§ge_Ty³
::
READ_COMP
) {

116 
»que¡_ãtch_un™
->
Proûss_pc›_»ad_mes§ge
(
mes§ge
->
Add»ss
, mes§ge->
Paylßd
, mes§ge->
Paylßd_size
);

118 
	g»que¡_ãtch_un™
->
Proûss_pc›_wr™e_mes§ge
(
mes§ge
->
Add»ss
, mes§ge->
Paylßd
, mes§ge->
Paylßd_size
);

120 
d–‘e
 
	gmes§ge
;

123 
S’d_»ad_mes§ge_to_ho¡
(
ušt64_t
 
add»sss
, 
»que¡_»ad_d©a_size
);

124 
S’d_wr™e_mes§ge_to_ho¡
(
ušt64_t
 
add»sss
, * 
mes§ge
, 
mes§ge_size
);

126 
Ho¡IÁ”çû_Ty³s
 
G‘Ty³
(è{  
	gty³
; }

127 
A‰ach_to_deviû
(
Ho¡_CompÚ’ts
::
PCIe_Sw™ch
* 
pc›_sw™ch
);

128 
LHA_ty³
 
G‘_max_logiÿl_£ùÜ_add»ss
();

129 
G‘_no_of_LHAs_š_ª_NVM_wr™e_un™
();

130 
	g´Ùeùed
:

131 
Ho¡IÁ”çû_Ty³s
 
ty³
;

132 
LHA_ty³
 
	gmax_logiÿl_£ùÜ_add»ss
;

133 
	g£ùÜs_³r_·ge
;

134 
Ho¡_IÁ”çû_Ba£
* 
	g_my_š¡ªû
;

135 
IÅut_SŒ—m_Mªag”_Ba£
* 
	gšput_¡»am_mªag”
;

136 
Reque¡_F‘ch_Un™_Ba£
* 
	g»que¡_ãtch_un™
;

137 
D©a_Cache_Mªag”_Ba£
* 
	gÿche
;

138 
	g¡d
::
veùÜ
<
U£rReque¡A¼ivedSigÇlHªdËrTy³
> 
cÚÃùed_u£r_»que¡_¬rived_sigÇl_hªdËrs
;

140 
brßdÿ¡_u£r_»que¡_¬riv®_sigÇl
(
U£r_Reque¡
* 
u£r_»que¡
)

142 
	g¡d
::
veùÜ
<
U£rReque¡A¼ivedSigÇlHªdËrTy³
>::
™”©Ü
 
™
 = 
cÚÃùed_u£r_»que¡_¬rived_sigÇl_hªdËrs
.
begš
();

143 
	g™
 !ğ
cÚÃùed_u£r_»que¡_¬rived_sigÇl_hªdËrs
.
’d
(); it++) {

144 (*
	g™
)(
	gu£r_»que¡
);

148 
hªdË_u£r_»que¡_£rviûd_sigÇl_äom_ÿche
(
U£r_Reque¡
* 
u£r_»que¡
)

150 
	g_my_š¡ªû
->
	gšput_¡»am_mªag”
->
HªdË_£rviûd_»que¡
(
u£r_»que¡
);

153 
hªdË_u£r_memÜy_Œª§ùiÚ_£rviûd_sigÇl_äom_ÿche
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
)

155 
	g_my_š¡ªû
->
	gšput_¡»am_mªag”
->
Upd©e_Œª§ùiÚ_¡©i¡ics
(
Œª§ùiÚ
);

157 
	g´iv©e
:

158 
Ho¡_CompÚ’ts
::
PCIe_Sw™ch
* 
pc›_sw™ch
;

	@src/ssd/Host_Interface_Defs.h

1 #iâdeà
NVME_DEFINITIONS_H


2 
	#NVME_DEFINITIONS_H


	)

4 
	~<c¡dšt
>

6 şas 
	cIO_Flow_PriÜ™y_CÏss
 { 
	mURGENT
 = 1, 
	mHIGH
 = 2, 
	mMEDIUM
 = 3, 
	mLOW
 = 4};

7 şas 
	cHo¡IÁ”çû_Ty³s
 { 
	mSATA
, 
	mNVME
 };

9 
	#NVME_FLUSH_OPCODE
 0x0000

	)

10 
	#NVME_WRITE_OPCODE
 0x0001

	)

11 
	#NVME_READ_OPCODE
 0x0002

	)

13 
	#SATA_WRITE_OPCODE
 0x0001

	)

14 
	#SATA_READ_OPCODE
 0x0002

	)

16 cÚ¡ 
ušt64_t
 
	gNCQ_SUBMISSION_REGISTER
 = 0x1000;

17 cÚ¡ 
ušt64_t
 
	gNCQ_COMPLETION_REGISTER
 = 0x1003;

18 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_0
 = 0x1000;

19 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_0
 = 0x1003;

20 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_1
 = 0x1010;

21 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_1
 = 0x1013;

22 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_2
 = 0x1020;

23 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_2
 = 0x1023;

24 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_3
 = 0x1030;

25 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_3
 = 0x1033;

26 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_4
 = 0x1040;

27 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_4
 = 0x1043;

28 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_5
 = 0x1050;

29 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_5
 = 0x1053;

30 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_6
 = 0x1060;

31 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_6
 = 0x1063;

32 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_7
 = 0x1070;

33 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_7
 = 0x1073;

34 cÚ¡ 
ušt64_t
 
	gSUBMISSION_QUEUE_REGISTER_8
 = 0x1080;

35 cÚ¡ 
ušt64_t
 
	gCOMPLETION_QUEUE_REGISTER_8
 = 0x1083;

37 
	sCom¶‘iÚ_Queue_EÁry


39 
ušt32_t
 
	mCommªd_¥ecific
;

40 
ušt32_t
 
	mRe£rved
;

41 
ušt16_t
 
	mSQ_H—d
;

42 
ušt16_t
 
	mSQ_ID
;

43 
ušt16_t
 
	mCommªd_Id’tif›r
;

44 
ušt16_t
 
	mSF_P
;

49 
	sSubmissiÚ_Queue_EÁry


51 
ušt8_t
 
	mOpcode
;

52 
ušt8_t
 
	mPRP_FUSE
;

53 
ušt16_t
 
	mCommªd_Id’tif›r
;

54 
ušt64_t
 
	mName¥aû_id’tif›r
;

55 
ušt64_t
 
	mRe£rved
;

56 
ušt64_t
 
	mM‘ad©a_poš‹r_1
;

57 
ušt64_t
 
	mPRP_’Œy_1
;

58 
ušt64_t
 
	mPRP_’Œy_2
;

59 
ušt32_t
 
	mCommªd_¥ecific
[6];

	@src/ssd/Host_Interface_NVMe.cpp

1 
	~<¡dexû±
>

2 
	~"../sim/Engše.h
"

3 
	~"Ho¡_IÁ”çû_NVMe.h
"

4 
	~"NVM_T¿n§ùiÚ_FÏsh_RD.h
"

5 
	~"NVM_T¿n§ùiÚ_FÏsh_WR.h
"

8 
Çme¥aû
 
	gSSD_CompÚ’ts


10 
	gIÅut_SŒ—m_NVMe
::~
IÅut_SŒ—m_NVMe
()

12 autØ&
u£r_»que¡
 : 
Wa™šg_u£r_»que¡s
)

13 
d–‘e
 
u£r_»que¡
;

14 autØ&
	gu£r_»que¡
 : 
Com¶‘ed_u£r_»que¡s
)

15 
d–‘e
 
u£r_»que¡
;

18 
	gIÅut_SŒ—m_Mªag”_NVMe
::
IÅut_SŒ—m_Mªag”_NVMe
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
ušt16_t
 
queue_ãtch_sz›
) :

19 
IÅut_SŒ—m_Mªag”_Ba£
(
ho¡_š‹rçû
), 
Queue_ãtch_size
(
queue_ãtch_sz›
)

23 
¡»am_id_ty³
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
C»©e_Ãw_¡»am
(
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
,

24 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, 
ušt16_t
 
submissiÚ_queue_size
, ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
, ušt16_ˆ
com¶‘iÚ_queue_size
)

26 if(
	g’d_logiÿl_£ùÜ_add»ss
 < 
	g¡¬t_logiÿl_£ùÜ_add»ss
) {

27 
PRINT_ERROR
("Error in‡llocating‡ddress„angeo‡ stream in host interface:he start‡ddress should be smallerhanheƒnd‡ddress.")

29 
IÅut_SŒ—m_NVMe
* 
	gšput_¡»am
 = 
Ãw
 IÅut_SŒ—m_NVMe(
´iÜ™y_şass
, 
¡¬t_logiÿl_£ùÜ_add»ss
, 
’d_logiÿl_£ùÜ_add»ss
,

30 
submissiÚ_queue_ba£_add»ss
, 
submissiÚ_queue_size
, 
com¶‘iÚ_queue_ba£_add»ss
, 
com¶‘iÚ_queue_size
);

31 
	gthis
->
	gšput_¡»ams
.
push_back
(
šput_¡»am
);

33  (
	g¡»am_id_ty³
)(
	gthis
->
	gšput_¡»ams
.
size
() - 1);

36 
šlše
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
SubmissiÚ_queue__poš‹r_upd©e
(
¡»am_id_ty³
 
¡»am_id
, 
ušt16_t
 
_poš‹r_v®ue
)

38 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gSubmissiÚ_
 = 
_poš‹r_v®ue
;

40 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gOn_the_æy_»que¡s
 < 
	gQueue_ãtch_size
) {

41 ((
	gHo¡_IÁ”çû_NVMe
*)
	gho¡_š‹rçû
)->
	g»que¡_ãtch_un™
->
F‘ch_Ãxt_»que¡
(
¡»am_id
);

42 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gOn_the_æy_»que¡s
++;

43 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gSubmissiÚ_h—d
++;

44 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gSubmissiÚ_h—d
 =ğ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[¡»am_id])->
SubmissiÚ_queue_size
) {

45 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
SubmissiÚ_h—d
 = 0;

50 
šlše
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(
¡»am_id_ty³
 
¡»am_id
, 
ušt16_t
 
h—d_poš‹r_v®ue
)

52 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘iÚ_h—d
 = 
h—d_poš‹r_v®ue
;

55 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘ed_u£r_»que¡s
.
size
() > 0) {

56 
U£r_Reque¡
* 
	g»que¡
 = ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
Com¶‘ed_u£r_»que¡s
.
äÚt
();

57 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘ed_u£r_»que¡s
.
pİ_äÚt
();

58 
šfÜm_ho¡_»que¡_com¶‘ed
(
¡»am_id
, 
»que¡
);

62 
šlše
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
HªdË_Ãw_¬rived_»que¡
(
U£r_Reque¡
* 
»que¡
)

64 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
»que¡
->
SŒ—m_id
])->
SubmissiÚ_h—d_šfÜmed_to_ho¡
++;

65 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
»que¡
->
SŒ—m_id
])->
	gSubmissiÚ_h—d_šfÜmed_to_ho¡
 =ğ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[»que¡->SŒ—m_id])->
SubmissiÚ_queue_size
) {

66 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
»que¡
->
SŒ—m_id
])->
SubmissiÚ_h—d_šfÜmed_to_ho¡
 = 0;

68 ià(
	g»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

69 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
»que¡
->
SŒ—m_id
])->
Wa™šg_u£r_»que¡s
.
push_back
(request);

70 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
»que¡
->
SŒ—m_id
])->
	gSTAT_numb”_of_»ad_»que¡s
++;

71 
£gm’t_u£r_»que¡
(
»que¡
);

73 ((
	gHo¡_IÁ”çû_NVMe
*)
	gho¡_š‹rçû
)->
brßdÿ¡_u£r_»que¡_¬riv®_sigÇl
(
»que¡
);

75 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
»que¡
->
SŒ—m_id
])->
	gWa™šg_u£r_»que¡s
.
push_back
(request);

76 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
»que¡
->
SŒ—m_id
])->
	gSTAT_numb”_of_wr™e_»que¡s
++;

77 ((
	gHo¡_IÁ”çû_NVMe
*)
	gho¡_š‹rçû
)->
	g»que¡_ãtch_un™
->
F‘ch_wr™e_d©a
(
»que¡
);

81 
šlše
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
HªdË_¬rived_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
)

83 
£gm’t_u£r_»que¡
(
»que¡
);

84 ((
	gHo¡_IÁ”çû_NVMe
*)
	gho¡_š‹rçû
)->
brßdÿ¡_u£r_»que¡_¬riv®_sigÇl
(
»que¡
);

87 
šlše
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
HªdË_£rviûd_»que¡
(
U£r_Reque¡
* 
»que¡
)

89 
¡»am_id_ty³
 
¡»am_id
 = 
»que¡
->
SŒ—m_id
;

90 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
»que¡
->
SŒ—m_id
])->
	gWa™šg_u£r_»que¡s
.
»move
(request);

91 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gOn_the_æy_»que¡s
--;

93 
DEBUG
("** Ho¡ IÁ”çû: Reque¡ #" << 
»que¡
->
ID
 << " from sŒ—m #" <<„eque¡->
SŒ—m_id
 << " is finished")

96 ià(
	g»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

97 ((
Ho¡_IÁ”çû_NVMe
*)
ho¡_š‹rçû
)->
»que¡_ãtch_un™
->
S’d_»ad_d©a
(
»que¡
);

101 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gSubmissiÚ_h—d
 !ğ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[¡»am_id])->
SubmissiÚ_
) {

102 ((
Ho¡_IÁ”çû_NVMe
*)
ho¡_š‹rçû
)->
»que¡_ãtch_un™
->
F‘ch_Ãxt_»que¡
(
¡»am_id
);

103 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gOn_the_æy_»que¡s
++;

104 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gSubmissiÚ_h—d
++;

105 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gSubmissiÚ_h—d
 =ğ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[¡»am_id])->
SubmissiÚ_queue_size
) {

106 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
SubmissiÚ_h—d
 = 0;

111 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘iÚ_h—d
 > ((IÅut_SŒ—m_NVMe*)šput_¡»ams[¡»am_id])->
	gCom¶‘iÚ_
) {

113 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘iÚ_
 + 1 =ğ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[¡»am_id])->
Com¶‘iÚ_h—d
) {

114 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
Com¶‘ed_u£r_»que¡s
.
push_back
(
»que¡
);

117 } if(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘iÚ_
 - ((IÅut_SŒ—m_NVMe*)šput_¡»ams[¡»am_id])->
	gCom¶‘iÚ_h—d


118 =ğ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
Com¶‘iÚ_queue_size
 -1) {

119 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
Com¶‘ed_u£r_»que¡s
.
push_back
(
»que¡
);

123 
šfÜm_ho¡_»que¡_com¶‘ed
(
¡»am_id
, 
»que¡
);

124 
DELETE_REQUEST_NVME
(
»que¡
);

127 
ušt16_t
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
G‘_submissiÚ_queue_d•th
(
¡»am_id_ty³
 
¡»am_id
)

129  ((
IÅut_SŒ—m_NVMe
*)
this
->
šput_¡»ams
[
¡»am_id
])->
SubmissiÚ_queue_size
;

132 
ušt16_t
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
G‘_com¶‘iÚ_queue_d•th
(
¡»am_id_ty³
 
¡»am_id
)

134  ((
IÅut_SŒ—m_NVMe
*)
this
->
šput_¡»ams
[
¡»am_id
])->
Com¶‘iÚ_queue_size
;

137 
IO_Flow_PriÜ™y_CÏss
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
G‘_´iÜ™y_şass
(
¡»am_id_ty³
 
¡»am_id
)

139  ((
IÅut_SŒ—m_NVMe
*)
this
->
šput_¡»ams
[
¡»am_id
])->
PriÜ™y_şass
;

142 
šlše
 
	gIÅut_SŒ—m_Mªag”_NVMe
::
šfÜm_ho¡_»que¡_com¶‘ed
(
¡»am_id_ty³
 
¡»am_id
, 
U£r_Reque¡
* 
»que¡
)

144 ((
	gReque¡_F‘ch_Un™_NVMe
*)((
	gHo¡_IÁ”çû_NVMe
*)
	gho¡_š‹rçû
)->
	g»que¡_ãtch_un™
)->
S’d_com¶‘iÚ_queue_–em’t
(
»que¡
, ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
SubmissiÚ_h—d_šfÜmed_to_ho¡
);

145 ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘iÚ_
++;

147 ià(((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
¡»am_id
])->
	gCom¶‘iÚ_
 =ğ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[¡»am_id])->
Com¶‘iÚ_queue_size
) {

148 ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
¡»am_id
])->
Com¶‘iÚ_
 = 0;

152 
	gIÅut_SŒ—m_Mªag”_NVMe
::
£gm’t_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
)

154 
LHA_ty³
 
l§
 = 
u£r_»que¡
->
S¹_LBA
;

155 
LHA_ty³
 
	gl§2
 = 
u£r_»que¡
->
S¹_LBA
;

156 
	g»q_size
 = 
u£r_»que¡
->
SizeInSeùÜs
;

158 
·ge_¡©us_ty³
 
	gacûss_¡©us_b™m­
 = 0;

159 
	ghªËd_£ùÜs_couÁ
 = 0;

160 
	gŒª§ùiÚ_size
 = 0;

161 
	ghªËd_£ùÜs_couÁ
 < 
	g»q_size
) {

163 ià(
	gl§
 < ((
	gIÅut_SŒ—m_NVMe
*)
	gšput_¡»ams
[
u£r_»que¡
->
SŒ—m_id
])->
	gS¹_logiÿl_£ùÜ_add»ss
 ||†§ >((IÅut_SŒ—m_NVMe*)šput_¡»ams[u£r_»que¡->SŒ—m_id])->
	gEnd_logiÿl_£ùÜ_add»ss
) {

164 
	gl§
 = ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
u£r_»que¡
->
SŒ—m_id
])->
S¹_logiÿl_£ùÜ_add»ss


165 + (
l§
 % (((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
u£r_»que¡
->
SŒ—m_id
])->
End_logiÿl_£ùÜ_add»ss
 - (((IÅut_SŒ—m_NVMe*)šput_¡»ams[u£r_»que¡->SŒ—m_id])->
S¹_logiÿl_£ùÜ_add»ss
)));

167 
LHA_ty³
 
	gš‹º®_l§
 = 
l§
 - ((
IÅut_SŒ—m_NVMe
*)
šput_¡»ams
[
u£r_»que¡
->
SŒ—m_id
])->
S¹_logiÿl_£ùÜ_add»ss
;

170 
	gŒª§ùiÚ_size
 = 
ho¡_š‹rçû
->
£ùÜs_³r_·ge
 - ()(
l§
 % host_interface->sectors_per_page);

171 ià(
	ghªËd_£ùÜs_couÁ
 + 
	gŒª§ùiÚ_size
 >ğ
»q_size
) {

172 
Œª§ùiÚ_size
 = 
»q_size
 - 
hªËd_£ùÜs_couÁ
;

174 
LPA_ty³
 
	gÍa
 = 
š‹º®_l§
 / 
ho¡_š‹rçû
->
£ùÜs_³r_·ge
;

176 
·ge_¡©us_ty³
 
	g‹mp
 = ~(0xfffffffffffffffà<< ()
Œª§ùiÚ_size
);

177 
	gacûss_¡©us_b™m­
 = 
‹mp
 << ()(
š‹º®_l§
 % 
ho¡_š‹rçû
->
£ùÜs_³r_·ge
);

179 ià(
	gu£r_»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

180 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
Œª§ùiÚ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_RD(
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
, 
u£r_»que¡
->
SŒ—m_id
,

181 
Œª§ùiÚ_size
 * 
SECTOR_SIZE_IN_BYTE
, 
Ía
, 
NO_PPA
, 
u£r_»que¡
, 0, 
acûss_¡©us_b™m­
, 
Cu¼’tTimeSmp
);

182 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
push_back
(
Œª§ùiÚ
);

183 
	gšput_¡»ams
[
u£r_»que¡
->
SŒ—m_id
]->
	gSTAT_numb”_of_»ad_Œª§ùiÚs
++;

185 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	gŒª§ùiÚ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_WR(
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
, 
u£r_»que¡
->
SŒ—m_id
,

186 
Œª§ùiÚ_size
 * 
SECTOR_SIZE_IN_BYTE
, 
Ía
, 
u£r_»que¡
, 0, 
acûss_¡©us_b™m­
, 
Cu¼’tTimeSmp
);

187 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
push_back
(
Œª§ùiÚ
);

188 
	gšput_¡»ams
[
u£r_»que¡
->
SŒ—m_id
]->
	gSTAT_numb”_of_wr™e_Œª§ùiÚs
++;

191 
	gl§
 = 
l§
 + 
Œª§ùiÚ_size
;

192 
	ghªËd_£ùÜs_couÁ
 +ğ
Œª§ùiÚ_size
;

196 
	gReque¡_F‘ch_Un™_NVMe
::
Reque¡_F‘ch_Un™_NVMe
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
) :

197 
Reque¡_F‘ch_Un™_Ba£
(
ho¡_š‹rçû
), 
cu¼’t_pha£
(0xffff), 
numb”_of_£Á_cqe
(0) {}

199 
	gReque¡_F‘ch_Un™_NVMe
::
Proûss_pc›_wr™e_mes§ge
(
ušt64_t
 
add»ss
, * 
·ylßd
, 
·ylßd_size
)

201 
Ho¡_IÁ”çû_NVMe
* 
	ghi
 = (Ho¡_IÁ”çû_NVMe*)
ho¡_š‹rçû
;

202 
ušt64_t
 
	gv®
 = (ušt64_t)
·ylßd
;

203 
	gadd»ss
)

205 
	gSUBMISSION_QUEUE_REGISTER_1
:

206 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(0, (
ušt16_t
)
v®
);

208 
	gCOMPLETION_QUEUE_REGISTER_1
:

209 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(0, (
ušt16_t
)
v®
);

211 
	gSUBMISSION_QUEUE_REGISTER_2
:

212 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(1, (
ušt16_t
)
v®
);

214 
	gCOMPLETION_QUEUE_REGISTER_2
:

215 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(1, (
ušt16_t
)
v®
);

217 
	gSUBMISSION_QUEUE_REGISTER_3
:

218 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(2, (
ušt16_t
)
v®
);

220 
	gCOMPLETION_QUEUE_REGISTER_3
:

221 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(2, (
ušt16_t
)
v®
);

223 
	gSUBMISSION_QUEUE_REGISTER_4
:

224 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(3, (
ušt16_t
)
v®
);

226 
	gCOMPLETION_QUEUE_REGISTER_4
:

227 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(3, (
ušt16_t
)
v®
);

229 
	gSUBMISSION_QUEUE_REGISTER_5
:

230 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(4, (
ušt16_t
)
v®
);

232 
	gCOMPLETION_QUEUE_REGISTER_5
:

233 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(4, (
ušt16_t
)
v®
);

235 
	gSUBMISSION_QUEUE_REGISTER_6
:

236 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(5, (
ušt16_t
)
v®
);

238 
	gCOMPLETION_QUEUE_REGISTER_6
:

239 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(5, (
ušt16_t
)
v®
);

241 
	gSUBMISSION_QUEUE_REGISTER_7
:

242 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(6, (
ušt16_t
)
v®
);

244 
	gCOMPLETION_QUEUE_REGISTER_7
:

245 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(6, (
ušt16_t
)
v®
);

247 
	gSUBMISSION_QUEUE_REGISTER_8
:

248 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
(7, (
ušt16_t
)
v®
);

250 
	gCOMPLETION_QUEUE_REGISTER_8
:

251 ((
IÅut_SŒ—m_Mªag”_NVMe
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(7, (
ušt16_t
)
v®
);

254 
throw
 
¡d
::
šv®id_¬gum’t
("Unknown„egister is written!");

258 
	gReque¡_F‘ch_Un™_NVMe
::
Proûss_pc›_»ad_mes§ge
(
ušt64_t
 
add»ss
, * 
·ylßd
, 
·ylßd_size
)

260 
Ho¡_IÁ”çû_NVMe
* 
	ghi
 = (Ho¡_IÁ”çû_NVMe*)
ho¡_š‹rçû
;

261 
DMA_Req_I‹m
* 
	gdma_»q_™em
 = 
dma_li¡
.
äÚt
();

262 
	gdma_li¡
.
pİ_äÚt
();

264 
	gdma_»q_™em
->
	gTy³
) {

265 
	gDMA_Req_Ty³
::
REQUEST_INFO
:

267 
U£r_Reque¡
* 
Ãw_»qeu¡
 = 
Ãw
 User_Request;

268 
	gÃw_»qeu¡
->
	gIO_commªd_šfo
 = 
·ylßd
;

269 
	gÃw_»qeu¡
->
	gSŒ—m_id
 = (
¡»am_id_ty³
)((
ušt64_t
)(
dma_»q_™em
->
objeù
));

270 
	gÃw_»qeu¡
->
	gPriÜ™y_şass
 = ((
IÅut_SŒ—m_Mªag”_NVMe
*)
ho¡_š‹rçû
->
šput_¡»am_mªag”
)->
G‘_´iÜ™y_şass
(
Ãw_»qeu¡
->
SŒ—m_id
);

271 
	gÃw_»qeu¡
->
	gSTAT_In™ŸtiÚTime
 = 
SimuÏtÜ
->
Time
();

272 
SubmissiÚ_Queue_EÁry
* 
	gsqe
 = (SubmissiÚ_Queue_EÁry*)
·ylßd
;

273 
	gsqe
->
	gOpcode
)

275 
	gNVME_READ_OPCODE
:

276 
Ãw_»qeu¡
->
Ty³
 = 
U£rReque¡Ty³
::
READ
;

277 
	gÃw_»qeu¡
->
	gS¹_LBA
 = ((
LHA_ty³
)
sqe
->
Commªd_¥ecific
[1]) << 31 | (LHA_type)sqe->Command_specific[0];

278 
	gÃw_»qeu¡
->
	gSizeInSeùÜs
 = 
sqe
->
Commªd_¥ecific
[2] & (
LHA_ty³
)(0x0000ffff);

279 
	gÃw_»qeu¡
->
	gSize_š_by‹
 = 
Ãw_»qeu¡
->
SizeInSeùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

281 
	gNVME_WRITE_OPCODE
:

282 
Ãw_»qeu¡
->
Ty³
 = 
U£rReque¡Ty³
::
WRITE
;

283 
	gÃw_»qeu¡
->
	gS¹_LBA
 = ((
LHA_ty³
)
sqe
->
Commªd_¥ecific
[1]) << 31 | (LHA_type)sqe->Command_specific[0];

284 
	gÃw_»qeu¡
->
	gSizeInSeùÜs
 = 
sqe
->
Commªd_¥ecific
[2] & (
LHA_ty³
)(0x0000ffff);

285 
	gÃw_»qeu¡
->
	gSize_š_by‹
 = 
Ãw_»qeu¡
->
SizeInSeùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

288 
throw
 
¡d
::
šv®id_¬gum’t
("NVMe command is‚ot supported!");

290 ((
	gIÅut_SŒ—m_Mªag”_NVMe
*)(
	ghi
->
	gšput_¡»am_mªag”
))->
HªdË_Ãw_¬rived_»que¡
(
Ãw_»qeu¡
);

293 
	gDMA_Req_Ty³
::
WRITE_DATA
:

294 
COPYDATA
(((
U£r_Reque¡
*)
dma_»q_™em
->
objeù
)->
D©a
, 
·ylßd
, 
·ylßd_size
);

295 ((
	gIÅut_SŒ—m_Mªag”_NVMe
*)(
	ghi
->
	gšput_¡»am_mªag”
))->
HªdË_¬rived_wr™e_d©a
((
U£r_Reque¡
*)
dma_»q_™em
->
objeù
);

300 
d–‘e
 
	gdma_»q_™em
;

303 
	gReque¡_F‘ch_Un™_NVMe
::
F‘ch_Ãxt_»que¡
(
¡»am_id_ty³
 
¡»am_id
)

305 
DMA_Req_I‹m
* 
dma_»q_™em
 = 
Ãw
 DMA_Req_Item;

306 
	gdma_»q_™em
->
	gTy³
 = 
DMA_Req_Ty³
::
REQUEST_INFO
;

307 
	gdma_»q_™em
->
	gobjeù
 = (*)(
šŒ_t
)
¡»am_id
;

308 
	gdma_li¡
.
push_back
(
dma_»q_™em
);

310 
Ho¡_IÁ”çû_NVMe
* 
	ghi
 = (Ho¡_IÁ”çû_NVMe*)
ho¡_š‹rçû
;

311 
IÅut_SŒ—m_NVMe
* 
	gim
 = ((IÅut_SŒ—m_NVMe*)
hi
->
šput_¡»am_mªag”
->
šput_¡»ams
[
¡»am_id
]);

312 
	gho¡_š‹rçû
->
S’d_»ad_mes§ge_to_ho¡
(
im
->
SubmissiÚ_queue_ba£_add»ss
 + im->
SubmissiÚ_h—d
 * (
SubmissiÚ_Queue_EÁry
), (Submission_Queue_Entry));

315 
	gReque¡_F‘ch_Un™_NVMe
::
F‘ch_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
)

317 
DMA_Req_I‹m
* 
dma_»q_™em
 = 
Ãw
 DMA_Req_Item;

318 
	gdma_»q_™em
->
	gTy³
 = 
DMA_Req_Ty³
::
WRITE_DATA
;

319 
	gdma_»q_™em
->
	gobjeù
 = (*)
»que¡
;

320 
	gdma_li¡
.
push_back
(
dma_»q_™em
);

322 
SubmissiÚ_Queue_EÁry
* 
	gsqe
 = (SubmissiÚ_Queue_EÁry*è
»que¡
->
IO_commªd_šfo
;

323 
	gho¡_š‹rçû
->
S’d_»ad_mes§ge_to_ho¡
((
sqe
->
PRP_’Œy_2
<<31è| sqe->
PRP_’Œy_1
, 
»que¡
->
Size_š_by‹
);

326 
	gReque¡_F‘ch_Un™_NVMe
::
S’d_com¶‘iÚ_queue_–em’t
(
U£r_Reque¡
* 
»que¡
, 
ušt16_t
 
sq_h—d_v®ue
)

328 
Ho¡_IÁ”çû_NVMe
* 
	ghi
 = (Ho¡_IÁ”çû_NVMe*)
ho¡_š‹rçû
;

329 
Com¶‘iÚ_Queue_EÁry
* 
	gcqe
 = 
Ãw
 Completion_Queue_Entry;

330 
	gcqe
->
	gSQ_H—d
 = 
sq_h—d_v®ue
;

331 
	gcqe
->
	gSQ_ID
 = 
FLOW_ID_TO_Q_ID
(
»que¡
->
SŒ—m_id
);

332 
	gcqe
->
	gSF_P
 = 0x0001 & 
cu¼’t_pha£
;

333 
	gcqe
->
	gCommªd_Id’tif›r
 = ((
SubmissiÚ_Queue_EÁry
*)
»que¡
->
IO_commªd_šfo
)->
Commªd_Id’tif›r
;

334 
IÅut_SŒ—m_NVMe
* 
	gim
 = ((IÅut_SŒ—m_NVMe*)
hi
->
šput_¡»am_mªag”
->
šput_¡»ams
[
»que¡
->
SŒ—m_id
]);

335 
	gho¡_š‹rçû
->
S’d_wr™e_mes§ge_to_ho¡
(
im
->
Com¶‘iÚ_queue_ba£_add»ss
 + im->
Com¶‘iÚ_
 * (
Com¶‘iÚ_Queue_EÁry
), 
cqe
, (Completion_Queue_Entry));

336 
	gnumb”_of_£Á_cqe
++;

337 ià(
	gnumb”_of_£Á_cqe
 % 
	gim
->
	gCom¶‘iÚ_queue_size
 == 0)

340 ià(
cu¼’t_pha£
 == 0xffff) {

341 
cu¼’t_pha£
 = 0xfffe;

343 
	gcu¼’t_pha£
 = 0xffff;

348 
	gReque¡_F‘ch_Un™_NVMe
::
S’d_»ad_d©a
(
U£r_Reque¡
* 
»que¡
)

350 
SubmissiÚ_Queue_EÁry
* 
sqe
 = (SubmissiÚ_Queue_EÁry*)
»que¡
->
IO_commªd_šfo
;

351 
	gho¡_š‹rçû
->
S’d_wr™e_mes§ge_to_ho¡
(
sqe
->
PRP_’Œy_1
, 
»que¡
->
D©a
,„eque¡->
Size_š_by‹
);

354 
	gHo¡_IÁ”çû_NVMe
::
Ho¡_IÁ”çû_NVMe
(cÚ¡ 
sim_objeù_id_ty³
& 
id
,

355 
LHA_ty³
 
max_logiÿl_£ùÜ_add»ss
, 
ušt16_t
 
submissiÚ_queue_d•th
, ušt16_ˆ
com¶‘iÚ_queue_d•th
,

356 
no_of_šput_¡»ams
, 
ušt16_t
 
queue_ãtch_size
, 
£ùÜs_³r_·ge
, 
D©a_Cache_Mªag”_Ba£
* 
ÿche
) :

357 
Ho¡_IÁ”çû_Ba£
(
id
, 
Ho¡IÁ”çû_Ty³s
::
NVME
, 
max_logiÿl_£ùÜ_add»ss
, 
£ùÜs_³r_·ge
, 
ÿche
),

358 
submissiÚ_queue_d•th
(submissiÚ_queue_d•th), 
com¶‘iÚ_queue_d•th
(com¶‘iÚ_queue_d•th), 
no_of_šput_¡»ams
(no_of_input_streams)

360 
	gthis
->
	gšput_¡»am_mªag”
 = 
Ãw
 
IÅut_SŒ—m_Mªag”_NVMe
(
this
, 
queue_ãtch_size
);

361 
	gthis
->
	g»que¡_ãtch_un™
 = 
Ãw
 
Reque¡_F‘ch_Un™_NVMe
(
this
);

364 
¡»am_id_ty³
 
	gHo¡_IÁ”çû_NVMe
::
C»©e_Ãw_¡»am
(
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
,

365 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
)

367  ((
	gIÅut_SŒ—m_Mªag”_NVMe
*)
	gšput_¡»am_mªag”
)->
C»©e_Ãw_¡»am
(
´iÜ™y_şass
, 
¡¬t_logiÿl_£ùÜ_add»ss
, 
’d_logiÿl_£ùÜ_add»ss
,

368 
submissiÚ_queue_ba£_add»ss
, 
submissiÚ_queue_d•th
, 
com¶‘iÚ_queue_ba£_add»ss
, 
com¶‘iÚ_queue_d•th
);

371 
	gHo¡_IÁ”çû_NVMe
::
V®id©e_simuÏtiÚ_cÚfig
()

373 
Ho¡_IÁ”çû_Ba£
::
V®id©e_simuÏtiÚ_cÚfig
();

374 ià(
	gthis
->
	gšput_¡»am_mªag”
 =ğ
NULL
) {

375 
throw
 
¡d
::
logic_”rÜ
("Input stream manager is‚ot set for Host Interface");

377 ià(
	gthis
->
	g»que¡_ãtch_un™
 =ğ
NULL
) {

378 
throw
 
¡d
::
logic_”rÜ
("Request fetch unit is‚ot set for Host Interface");

382 
	gHo¡_IÁ”çû_NVMe
::
S¹_simuÏtiÚ
()

386 
Ho¡_IÁ”çû_NVMe
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
) {}

388 
ušt16_t
 
Ho¡_IÁ”çû_NVMe
::
G‘_submissiÚ_queue_d•th
()

390  
submissiÚ_queue_d•th
;

393 
ušt16_t
 
	gHo¡_IÁ”çû_NVMe
::
G‘_com¶‘iÚ_queue_d•th
()

395  
com¶‘iÚ_queue_d•th
;

398 
	gHo¡_IÁ”çû_NVMe
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

400 
¡d
::
¡ršg
 
tmp
 = 
Çme_´efix
 + ".HostInterface";

401 
	gxmlwr™”
.
Wr™e_İ’_g
(
tmp
);

403 
	g¡d
::
¡ršg
 
©Œ
 = "Name";

404 
	g¡d
::
¡ršg
 
v®
 = 
ID
();

405 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

407 
	g¡»am_id
 = 0; sŒ—m_id < 
	gno_of_šput_¡»ams
; stream_id++) {

408 
	g¡d
::
¡ršg
 
tmp
 = 
Çme_´efix
 + ".IO_Stream";

409 
	gxmlwr™”
.
Wr™e_İ’_g
(
tmp
);

411 
	g©Œ
 = "Stream_ID";

412 
	gv®
 = 
¡d
::
to_¡ršg
(
¡»am_id
);

413 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

415 
	g©Œ
 = "Average_Read_Transaction_Turnaround_Time";

416 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_tuº¬ound_time
(
¡»am_id
));

417 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

419 
	g©Œ
 = "Average_Read_Transaction_Execution_Time";

420 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_executiÚ_time
(
¡»am_id
));

421 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

423 
	g©Œ
 = "Average_Read_Transaction_Transfer_Time";

424 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_Œªsãr_time
(
¡»am_id
));

425 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

427 
	g©Œ
 = "Average_Read_Transaction_Waiting_Time";

428 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_wa™šg_time
(
¡»am_id
));

429 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

431 
	g©Œ
 = "Average_Write_Transaction_Turnaround_Time";

432 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_tuº¬ound_time
(
¡»am_id
));

433 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

435 
	g©Œ
 = "Average_Write_Transaction_Execution_Time";

436 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_executiÚ_time
(
¡»am_id
));

437 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

439 
	g©Œ
 = "Average_Write_Transaction_Transfer_Time";

440 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_Œªsãr_time
(
¡»am_id
));

441 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

443 
	g©Œ
 = "Average_Write_Transaction_Waiting_Time";

444 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_wa™šg_time
(
¡»am_id
));

445 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

447 
	gxmlwr™”
.
Wr™e_şo£_g
();

450 
	gxmlwr™”
.
Wr™e_şo£_g
();

	@src/ssd/Host_Interface_NVMe.h

1 #iâdeà
HOST_INTERFACE_NVME_H


2 
	#HOST_INTERFACE_NVME_H


	)

4 
	~<veùÜ
>

5 
	~<li¡
>

6 
	~<m­
>

7 
	~"../sim/Sim_Ev’t.h
"

8 
	~"Ho¡_IÁ”çû_Ba£.h
"

9 
	~"U£r_Reque¡.h
"

10 
	~"Ho¡_IÁ”çû_Defs.h
"

12 
Çme¥aû
 
	gSSD_CompÚ’ts


14 şas 
	cIÅut_SŒ—m_NVMe
 : 
public
 
IÅut_SŒ—m_Ba£


16 
public
:

17 
IÅut_SŒ—m_NVMe
(
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
,

18 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, 
ušt16_t
 
submissiÚ_queue_size
,

19 
ušt64_t
 
com¶‘iÚ_queue_ba£_add»ss
, 
ušt16_t
 
com¶‘iÚ_queue_size
è: 
IÅut_SŒ—m_Ba£
(),

20 
PriÜ™y_şass
(
´iÜ™y_şass
),

21 
S¹_logiÿl_£ùÜ_add»ss
(
¡¬t_logiÿl_£ùÜ_add»ss
), 
End_logiÿl_£ùÜ_add»ss
(
’d_logiÿl_£ùÜ_add»ss
),

22 
SubmissiÚ_queue_ba£_add»ss
(
submissiÚ_queue_ba£_add»ss
), 
SubmissiÚ_queue_size
(
submissiÚ_queue_size
),

23 
Com¶‘iÚ_queue_ba£_add»ss
(
com¶‘iÚ_queue_ba£_add»ss
), 
Com¶‘iÚ_queue_size
(
com¶‘iÚ_queue_size
),

24 
SubmissiÚ_h—d
(0), 
SubmissiÚ_h—d_šfÜmed_to_ho¡
(0), 
SubmissiÚ_
(0), 
Com¶‘iÚ_h—d
(0), 
Com¶‘iÚ_
(0), 
On_the_æy_»que¡s
(0){}

25 ~
IÅut_SŒ—m_NVMe
();

26 
IO_Flow_PriÜ™y_CÏss
 
	gPriÜ™y_şass
;

27 
LHA_ty³
 
	gS¹_logiÿl_£ùÜ_add»ss
;

28 
LHA_ty³
 
	gEnd_logiÿl_£ùÜ_add»ss
;

29 
ušt64_t
 
	gSubmissiÚ_queue_ba£_add»ss
;

30 
ušt16_t
 
	gSubmissiÚ_queue_size
;

31 
ušt64_t
 
	gCom¶‘iÚ_queue_ba£_add»ss
;

32 
ušt16_t
 
	gCom¶‘iÚ_queue_size
;

33 
ušt16_t
 
	gSubmissiÚ_h—d
;

34 
ušt16_t
 
	gSubmissiÚ_h—d_šfÜmed_to_ho¡
;

35 
ušt16_t
 
	gSubmissiÚ_
;

36 
ušt16_t
 
	gCom¶‘iÚ_h—d
;

37 
ušt16_t
 
	gCom¶‘iÚ_
;

38 
	g¡d
::
li¡
<
U£r_Reque¡
*> 
Wa™šg_u£r_»que¡s
;

39 
	g¡d
::
li¡
<
U£r_Reque¡
*> 
Com¶‘ed_u£r_»que¡s
;

40 
	g¡d
::
li¡
<
U£r_Reque¡
*> 
Wa™šg_wr™e_d©a_Œªsãrs
;

41 
ušt16_t
 
	gOn_the_æy_»que¡s
;

44 şas 
	cIÅut_SŒ—m_Mªag”_NVMe
 : 
public
 
IÅut_SŒ—m_Mªag”_Ba£


46 
public
:

47 
IÅut_SŒ—m_Mªag”_NVMe
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
ušt16_t
 
queue_ãtch_sz›
);

48 
	gQueue_ãtch_size
;

49 
¡»am_id_ty³
 
C»©e_Ãw_¡»am
(
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
,

50 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, 
ušt16_t
 
submissiÚ_queue_size
,

51 
ušt64_t
 
com¶‘iÚ_queue_ba£_add»ss
, 
ušt16_t
 
com¶‘iÚ_queue_size
);

52 
SubmissiÚ_queue__poš‹r_upd©e
(
¡»am_id_ty³
 
¡»am_id
, 
ušt16_t
 
_poš‹r_v®ue
);

53 
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(
¡»am_id_ty³
 
¡»am_id
, 
ušt16_t
 
h—d_poš‹r_v®ue
);

54 
HªdË_Ãw_¬rived_»que¡
(
U£r_Reque¡
* 
»que¡
);

55 
HªdË_¬rived_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
);

56 
HªdË_£rviûd_»que¡
(
U£r_Reque¡
* 
»que¡
);

57 
ušt16_t
 
G‘_submissiÚ_queue_d•th
(
¡»am_id_ty³
 
¡»am_id
);

58 
ušt16_t
 
G‘_com¶‘iÚ_queue_d•th
(
¡»am_id_ty³
 
¡»am_id
);

59 
IO_Flow_PriÜ™y_CÏss
 
G‘_´iÜ™y_şass
(
¡»am_id_ty³
 
¡»am_id
);

60 
	g´iv©e
:

61 
£gm’t_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
);

62 
šfÜm_ho¡_»que¡_com¶‘ed
(
¡»am_id_ty³
 
¡»am_id
, 
U£r_Reque¡
* 
»que¡
);

65 şas 
	cReque¡_F‘ch_Un™_NVMe
 : 
public
 
Reque¡_F‘ch_Un™_Ba£


67 
public
:

68 
Reque¡_F‘ch_Un™_NVMe
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
);

69 
F‘ch_Ãxt_»que¡
(
¡»am_id_ty³
 
¡»am_id
);

70 
F‘ch_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
);

71 
S’d_»ad_d©a
(
U£r_Reque¡
* 
»que¡
);

72 
S’d_com¶‘iÚ_queue_–em’t
(
U£r_Reque¡
* 
»que¡
, 
ušt16_t
 
sq_h—d_v®ue
);

73 
Proûss_pc›_wr™e_mes§ge
(
ušt64_t
, *, );

74 
Proûss_pc›_»ad_mes§ge
(
ušt64_t
, *, );

75 
	g´iv©e
:

76 
ušt16_t
 
cu¼’t_pha£
;

77 
ušt32_t
 
	gnumb”_of_£Á_cqe
;

80 şas 
	cHo¡_IÁ”çû_NVMe
 : 
public
 
Ho¡_IÁ”çû_Ba£


82 
ä›nd
 
şass
 
IÅut_SŒ—m_Mªag”_NVMe
;

83 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_NVMe
;

84 
	gpublic
:

85 
Ho¡_IÁ”çû_NVMe
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
LHA_ty³
 
max_logiÿl_£ùÜ_add»ss
,

86 
ušt16_t
 
submissiÚ_queue_d•th
, ušt16_ˆ
com¶‘iÚ_queue_d•th
,

87 
no_of_šput_¡»ams
, 
ušt16_t
 
queue_ãtch_size
, 
£ùÜs_³r_·ge
, 
D©a_Cache_Mªag”_Ba£
* 
ÿche
);

88 
¡»am_id_ty³
 
C»©e_Ãw_¡»am
(
IO_Flow_PriÜ™y_CÏss
 
´iÜ™y_şass
, 
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
,

89 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
);

90 
S¹_simuÏtiÚ
();

91 
V®id©e_simuÏtiÚ_cÚfig
();

92 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

93 
ušt16_t
 
G‘_submissiÚ_queue_d•th
();

94 
ušt16_t
 
G‘_com¶‘iÚ_queue_d•th
();

95 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

96 
	g´iv©e
:

97 
ušt16_t
 
submissiÚ_queue_d•th
, 
	gcom¶‘iÚ_queue_d•th
;

98 
	gno_of_šput_¡»ams
;

	@src/ssd/Host_Interface_SATA.cpp

1 
	~"Ho¡_IÁ”çû_SATA.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
	gIÅut_SŒ—m_SATA
::~
IÅut_SŒ—m_SATA
()

7 autØ&
u£r_»que¡
 : 
Wa™šg_u£r_»que¡s
) {

8 
d–‘e
 
u£r_»que¡
;

10 autØ&
	gu£r_»que¡
 : 
Com¶‘ed_u£r_»que¡s
) {

11 
d–‘e
 
u£r_»que¡
;

15 
	gIÅut_SŒ—m_Mªag”_SATA
::
IÅut_SŒ—m_Mªag”_SATA
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
ušt16_t
 
ncq_d•th
,

16 
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
) :

17 
ncq_d•th
Òcq_d•th), 
IÅut_SŒ—m_Mªag”_Ba£
(
ho¡_š‹rçû
)

19 ià(
	g’d_logiÿl_£ùÜ_add»ss
 < 
	g¡¬t_logiÿl_£ùÜ_add»ss
) {

20 
PRINT_ERROR
("Error in‡llocating‡ddress„angeo‡ stream in host interface:he start‡ddress should be smallerhanheƒnd‡ddress.")

22 
IÅut_SŒ—m_SATA
* 
	gšput_¡»am
 = 
Ãw
 IÅut_SŒ—m_SATA(
¡¬t_logiÿl_£ùÜ_add»ss
, 
’d_logiÿl_£ùÜ_add»ss
, 0, 0);

23 
	gthis
->
	gšput_¡»ams
.
push_back
(
šput_¡»am
);

26 
	gIÅut_SŒ—m_Mªag”_SATA
::
S‘_ncq_add»ss
(
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
)

28 ((
	gIÅut_SŒ—m_SATA
*)
	gthis
->
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSubmissiÚ_queue_ba£_add»ss
 = 
submissiÚ_queue_ba£_add»ss
;

29 ((
	gIÅut_SŒ—m_SATA
*)
	gthis
->
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘iÚ_queue_ba£_add»ss
 = 
com¶‘iÚ_queue_ba£_add»ss
;

32 
šlše
 
	gIÅut_SŒ—m_Mªag”_SATA
::
SubmissiÚ_queue__poš‹r_upd©e
(
ušt16_t
 
_poš‹r_v®ue
)

34 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
SubmissiÚ_
 = 
_poš‹r_v®ue
;

35 ((
	gHo¡_IÁ”çû_SATA
*)
	gho¡_š‹rçû
)->
	g»que¡_ãtch_un™
->
F‘ch_Ãxt_»que¡
(
SATA_STREAM_ID
);

36 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gOn_the_æy_»que¡s
++;

37 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSubmissiÚ_h—d
++;

38 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSubmissiÚ_h—d
 =ğ
ncq_d•th
) {

39 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
SubmissiÚ_h—d
 = 0;

43 
šlše
 
	gIÅut_SŒ—m_Mªag”_SATA
::
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(
ušt16_t
 
h—d_poš‹r_v®ue
)

45 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
Com¶‘iÚ_h—d
 = 
h—d_poš‹r_v®ue
;

47 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘ed_u£r_»que¡s
.
size
() > 0) {

48 
U£r_Reque¡
* 
	g»que¡
 = ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
Com¶‘ed_u£r_»que¡s
.
äÚt
();

49 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘ed_u£r_»que¡s
.
pİ_äÚt
();

50 
šfÜm_ho¡_»que¡_com¶‘ed
(
»que¡
);

54 
šlše
 
	gIÅut_SŒ—m_Mªag”_SATA
::
HªdË_Ãw_¬rived_»que¡
(
U£r_Reque¡
* 
»que¡
)

56 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
SubmissiÚ_h—d_šfÜmed_to_ho¡
++;

57 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSubmissiÚ_h—d_šfÜmed_to_ho¡
 =ğ
ncq_d•th
) {

58 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
SubmissiÚ_h—d_šfÜmed_to_ho¡
 = 0;

60 ià(
	g»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

61 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
Wa™šg_u£r_»que¡s
.
push_back
(
»que¡
);

62 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSTAT_numb”_of_»ad_»que¡s
++;

63 
£gm’t_u£r_»que¡
(
»que¡
);

65 ((
	gHo¡_IÁ”çû_SATA
*)
	gho¡_š‹rçû
)->
brßdÿ¡_u£r_»que¡_¬riv®_sigÇl
(
»que¡
);

67 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gWa™šg_u£r_»que¡s
.
push_back
(
»que¡
);

68 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSTAT_numb”_of_wr™e_»que¡s
++;

69 ((
	gHo¡_IÁ”çû_SATA
*)
	gho¡_š‹rçû
)->
	g»que¡_ãtch_un™
->
F‘ch_wr™e_d©a
(
»que¡
);

73 
šlše
 
	gIÅut_SŒ—m_Mªag”_SATA
::
HªdË_¬rived_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
)

75 
£gm’t_u£r_»que¡
(
»que¡
);

76 ((
	gHo¡_IÁ”çû_SATA
*)
	gho¡_š‹rçû
)->
brßdÿ¡_u£r_»que¡_¬riv®_sigÇl
(
»que¡
);

79 
šlše
 
	gIÅut_SŒ—m_Mªag”_SATA
::
HªdË_£rviûd_»que¡
(
U£r_Reque¡
* 
»que¡
)

81 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
Wa™šg_u£r_»que¡s
.
»move
(
»que¡
);

82 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gOn_the_æy_»que¡s
--;

84 
DEBUG
("** Ho¡ IÁ”çû: Reque¡ #" << 
»que¡
->
ID
 << " is finished")

87 ià(
	g»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

88 ((
Ho¡_IÁ”çû_SATA
*)
ho¡_š‹rçû
)->
»que¡_ãtch_un™
->
S’d_»ad_d©a
(
»que¡
);

91 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSubmissiÚ_h—d
 !ğ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[SATA_STREAM_ID])->
SubmissiÚ_
) {

92 ((
Ho¡_IÁ”çû_SATA
*)
ho¡_š‹rçû
)->
»que¡_ãtch_un™
->
F‘ch_Ãxt_»que¡
(
SATA_STREAM_ID
);

93 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gOn_the_æy_»que¡s
++;

94 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSubmissiÚ_h—d
++;

95 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gSubmissiÚ_h—d
 =ğ
ncq_d•th
) {

96 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
SubmissiÚ_h—d
 = 0;

101 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘iÚ_h—d
 > ((IÅut_SŒ—m_SATA*)šput_¡»ams[SATA_STREAM_ID])->
	gCom¶‘iÚ_
) {

103 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘iÚ_
 + 1 =ğ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[SATA_STREAM_ID])->
Com¶‘iÚ_h—d
) {

104 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
Com¶‘ed_u£r_»que¡s
.
push_back
(
»que¡
);

107 } ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘iÚ_
 - ((IÅut_SŒ—m_SATA*)šput_¡»ams[SATA_STREAM_ID])->
	gCom¶‘iÚ_h—d


108 =ğ
ncq_d•th
 - 1) {

109 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
Com¶‘ed_u£r_»que¡s
.
push_back
(
»que¡
);

113 
šfÜm_ho¡_»que¡_com¶‘ed
(
»que¡
);

114 
DELETE_REQUEST_NVME
(
»que¡
);

117 
šlše
 
	gIÅut_SŒ—m_Mªag”_SATA
::
šfÜm_ho¡_»que¡_com¶‘ed
(
U£r_Reque¡
* 
»que¡
)

119 ((
Reque¡_F‘ch_Un™_SATA
*)((
Ho¡_IÁ”çû_SATA
*)
ho¡_š‹rçû
)->
»que¡_ãtch_un™
)->
S’d_com¶‘iÚ_queue_–em’t
(
»que¡
, ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
SubmissiÚ_h—d_šfÜmed_to_ho¡
);

120 ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘iÚ_
++;

123 ià(((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gCom¶‘iÚ_
 =ğ
ncq_d•th
) {

124 ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
Com¶‘iÚ_
 = 0;

128 
	gIÅut_SŒ—m_Mªag”_SATA
::
£gm’t_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
)

130 
LHA_ty³
 
l§
 = 
u£r_»que¡
->
S¹_LBA
;

131 
LHA_ty³
 
	gl§2
 = 
u£r_»que¡
->
S¹_LBA
;

132 
	g»q_size
 = 
u£r_»que¡
->
SizeInSeùÜs
;

134 
·ge_¡©us_ty³
 
	gacûss_¡©us_b™m­
 = 0;

135 
	ghªËd_£ùÜs_couÁ
 = 0;

136 
	gŒª§ùiÚ_size
 = 0;

137 
	ghªËd_£ùÜs_couÁ
 < 
	g»q_size
) {

139 ià(
	gl§
 < ((
	gIÅut_SŒ—m_SATA
*)
	gšput_¡»ams
[
SATA_STREAM_ID
])->
	gS¹_logiÿl_£ùÜ_add»ss
 ||†§ >((IÅut_SŒ—m_SATA*)šput_¡»ams[SATA_STREAM_ID])->
	gEnd_logiÿl_£ùÜ_add»ss
) {

140 
	gl§
 = ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
S¹_logiÿl_£ùÜ_add»ss


141 + (
l§
 % (((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
End_logiÿl_£ùÜ_add»ss
 - (((IÅut_SŒ—m_SATA*)šput_¡»ams[SATA_STREAM_ID])->
S¹_logiÿl_£ùÜ_add»ss
)));

143 
LHA_ty³
 
	gš‹º®_l§
 = 
l§
 - ((
IÅut_SŒ—m_SATA
*)
šput_¡»ams
[
SATA_STREAM_ID
])->
S¹_logiÿl_£ùÜ_add»ss
;

145 
	gŒª§ùiÚ_size
 = 
ho¡_š‹rçû
->
£ùÜs_³r_·ge
 - ()(
l§
 % host_interface->sectors_per_page);

146 ià(
	ghªËd_£ùÜs_couÁ
 + 
	gŒª§ùiÚ_size
 >ğ
»q_size
) {

147 
Œª§ùiÚ_size
 = 
»q_size
 - 
hªËd_£ùÜs_couÁ
;

149 
LPA_ty³
 
	gÍa
 = 
š‹º®_l§
 / 
ho¡_š‹rçû
->
£ùÜs_³r_·ge
;

151 
·ge_¡©us_ty³
 
	g‹mp
 = ~(0xfffffffffffffffà<< ()
Œª§ùiÚ_size
);

152 
	gacûss_¡©us_b™m­
 = 
‹mp
 << ()(
š‹º®_l§
 % 
ho¡_š‹rçû
->
£ùÜs_³r_·ge
);

154 ià(
	gu£r_»que¡
->
	gTy³
 =ğ
U£rReque¡Ty³
::
READ
) {

155 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
Œª§ùiÚ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_RD(
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
, 
SATA_STREAM_ID
,

156 
Œª§ùiÚ_size
 * 
SECTOR_SIZE_IN_BYTE
, 
Ía
, 
NO_PPA
, 
u£r_»que¡
, 0, 
acûss_¡©us_b™m­
, 
Cu¼’tTimeSmp
);

157 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
push_back
(
Œª§ùiÚ
);

158 
	gšput_¡»ams
[
SATA_STREAM_ID
]->
	gSTAT_numb”_of_»ad_Œª§ùiÚs
++;

160 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	gŒª§ùiÚ
 = 
Ãw
 NVM_T¿n§ùiÚ_FÏsh_WR(
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
, 
SATA_STREAM_ID
,

161 
Œª§ùiÚ_size
 * 
SECTOR_SIZE_IN_BYTE
, 
Ía
, 
u£r_»que¡
, 0, 
acûss_¡©us_b™m­
, 
Cu¼’tTimeSmp
);

162 
	gu£r_»que¡
->
	gT¿n§ùiÚ_li¡
.
push_back
(
Œª§ùiÚ
);

163 
	gšput_¡»ams
[
SATA_STREAM_ID
]->
	gSTAT_numb”_of_wr™e_Œª§ùiÚs
++;

166 
	gl§
 = 
l§
 + 
Œª§ùiÚ_size
;

167 
	ghªËd_£ùÜs_couÁ
 +ğ
Œª§ùiÚ_size
;

171 
	gReque¡_F‘ch_Un™_SATA
::
Reque¡_F‘ch_Un™_SATA
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
ušt16_t
 
ncq_d•th
) :

172 
Reque¡_F‘ch_Un™_Ba£
(
ho¡_š‹rçû
), 
cu¼’t_pha£
(0xffff), 
numb”_of_£Á_cqe
(0), 
ncq_d•th
(ncq_depth) {}

174 
	gReque¡_F‘ch_Un™_SATA
::
Proûss_pc›_wr™e_mes§ge
(
ušt64_t
 
add»ss
, * 
·ylßd
, 
·ylßd_size
)

176 
Ho¡_IÁ”çû_SATA
* 
	ghi
 = (Ho¡_IÁ”çû_SATA*)
ho¡_š‹rçû
;

177 
ušt64_t
 
	gv®
 = (ušt64_t)
·ylßd
;

178 
	gadd»ss
)

180 
	gNCQ_SUBMISSION_REGISTER
:

181 ((
IÅut_SŒ—m_Mªag”_SATA
*)(
hi
->
šput_¡»am_mªag”
))->
SubmissiÚ_queue__poš‹r_upd©e
((
ušt16_t
)
v®
);

183 
	gNCQ_COMPLETION_REGISTER
:

184 ((
IÅut_SŒ—m_Mªag”_SATA
*)(
hi
->
šput_¡»am_mªag”
))->
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
((
ušt16_t
)
v®
);

187 
throw
 
¡d
::
šv®id_¬gum’t
("Unknown„egister is written in Request_Fetch_Unit_SATA!");

191 
	gReque¡_F‘ch_Un™_SATA
::
Proûss_pc›_»ad_mes§ge
(
ušt64_t
 
add»ss
, * 
·ylßd
, 
·ylßd_size
)

193 
Ho¡_IÁ”çû_SATA
* 
	ghi
 = (Ho¡_IÁ”çû_SATA*)
ho¡_š‹rçû
;

194 
DMA_Req_I‹m
* 
	gdma_»q_™em
 = 
dma_li¡
.
äÚt
();

195 
	gdma_li¡
.
pİ_äÚt
();

197 
	gdma_»q_™em
->
	gTy³
)

199 
	gDMA_Req_Ty³
::
REQUEST_INFO
:

201 
U£r_Reque¡
* 
Ãw_»qeu¡
 = 
Ãw
 User_Request;

202 
	gÃw_»qeu¡
->
	gIO_commªd_šfo
 = 
·ylßd
;

203 
	gÃw_»qeu¡
->
	gSŒ—m_id
 = (
¡»am_id_ty³
)((
ušt64_t
)(
dma_»q_™em
->
objeù
));

204 
	gÃw_»qeu¡
->
	gSTAT_In™ŸtiÚTime
 = 
SimuÏtÜ
->
Time
();

205 
SubmissiÚ_Queue_EÁry
* 
	gsqe
 = (SubmissiÚ_Queue_EÁry*)
·ylßd
;

206 
	gsqe
->
	gOpcode
)

208 
	gSATA_READ_OPCODE
:

209 
Ãw_»qeu¡
->
Ty³
 = 
U£rReque¡Ty³
::
READ
;

210 
	gÃw_»qeu¡
->
	gS¹_LBA
 = ((
LHA_ty³
)
sqe
->
Commªd_¥ecific
[1]) << 31 | (LHA_type)sqe->Command_specific[0];

211 
	gÃw_»qeu¡
->
	gSizeInSeùÜs
 = 
sqe
->
Commªd_¥ecific
[2] & (
LHA_ty³
)(0x0000ffff);

212 
	gÃw_»qeu¡
->
	gSize_š_by‹
 = 
Ãw_»qeu¡
->
SizeInSeùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

214 
	gSATA_WRITE_OPCODE
:

215 
Ãw_»qeu¡
->
Ty³
 = 
U£rReque¡Ty³
::
WRITE
;

216 
	gÃw_»qeu¡
->
	gS¹_LBA
 = ((
LHA_ty³
)
sqe
->
Commªd_¥ecific
[1]) << 31 | (LHA_type)sqe->Command_specific[0];

217 
	gÃw_»qeu¡
->
	gSizeInSeùÜs
 = 
sqe
->
Commªd_¥ecific
[2] & (
LHA_ty³
)(0x0000ffff);

218 
	gÃw_»qeu¡
->
	gSize_š_by‹
 = 
Ãw_»qeu¡
->
SizeInSeùÜs
 * 
SECTOR_SIZE_IN_BYTE
;

221 
throw
 
¡d
::
šv®id_¬gum’t
("SATA command is‚ot supported!");

223 ((
	gIÅut_SŒ—m_Mªag”_SATA
*)(
	ghi
->
	gšput_¡»am_mªag”
))->
HªdË_Ãw_¬rived_»que¡
(
Ãw_»qeu¡
);

226 
	gDMA_Req_Ty³
::
WRITE_DATA
:

227 
COPYDATA
(((
U£r_Reque¡
*)
dma_»q_™em
->
objeù
)->
D©a
, 
·ylßd
, 
·ylßd_size
);

228 ((
	gIÅut_SŒ—m_Mªag”_SATA
*)(
	ghi
->
	gšput_¡»am_mªag”
))->
HªdË_¬rived_wr™e_d©a
((
U£r_Reque¡
*)
dma_»q_™em
->
objeù
);

234 
d–‘e
 
	gdma_»q_™em
;

237 
	gReque¡_F‘ch_Un™_SATA
::
F‘ch_Ãxt_»que¡
(
¡»am_id_ty³
 
¡»am_id
)

239 
DMA_Req_I‹m
* 
dma_»q_™em
 = 
Ãw
 DMA_Req_Item;

240 
	gdma_»q_™em
->
	gTy³
 = 
DMA_Req_Ty³
::
REQUEST_INFO
;

241 
	gdma_»q_™em
->
	gobjeù
 = (*)
SATA_STREAM_ID
;

242 
	gdma_li¡
.
push_back
(
dma_»q_™em
);

244 
Ho¡_IÁ”çû_SATA
* 
	ghi
 = (Ho¡_IÁ”çû_SATA*)
ho¡_š‹rçû
;

245 
IÅut_SŒ—m_SATA
* 
	gim
 = ((IÅut_SŒ—m_SATA*)
hi
->
šput_¡»am_mªag”
->
šput_¡»ams
[
SATA_STREAM_ID
]);

246 
	gho¡_š‹rçû
->
S’d_»ad_mes§ge_to_ho¡
(
im
->
SubmissiÚ_queue_ba£_add»ss
 + im->
SubmissiÚ_h—d
 * (
SubmissiÚ_Queue_EÁry
), (Submission_Queue_Entry));

249 
	gReque¡_F‘ch_Un™_SATA
::
F‘ch_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
)

251 
DMA_Req_I‹m
* 
dma_»q_™em
 = 
Ãw
 DMA_Req_Item;

252 
	gdma_»q_™em
->
	gTy³
 = 
DMA_Req_Ty³
::
WRITE_DATA
;

253 
	gdma_»q_™em
->
	gobjeù
 = (*)
»que¡
;

254 
	gdma_li¡
.
push_back
(
dma_»q_™em
);

256 
SubmissiÚ_Queue_EÁry
* 
	gsqe
 = (SubmissiÚ_Queue_EÁry*)
»que¡
->
IO_commªd_šfo
;

257 
	gho¡_š‹rçû
->
S’d_»ad_mes§ge_to_ho¡
((
sqe
->
PRP_’Œy_2
 << 31è| sqe->
PRP_’Œy_1
, 
»que¡
->
Size_š_by‹
);

260 
	gReque¡_F‘ch_Un™_SATA
::
S’d_com¶‘iÚ_queue_–em’t
(
U£r_Reque¡
* 
»que¡
, 
ušt16_t
 
sq_h—d_v®ue
)

262 
Ho¡_IÁ”çû_SATA
* 
	ghi
 = (Ho¡_IÁ”çû_SATA*)
ho¡_š‹rçû
;

263 
Com¶‘iÚ_Queue_EÁry
* 
	gcqe
 = 
Ãw
 Completion_Queue_Entry;

264 
	gcqe
->
	gSQ_H—d
 = 
sq_h—d_v®ue
;

265 
	gcqe
->
	gSQ_ID
 = 
FLOW_ID_TO_Q_ID
(
SATA_STREAM_ID
);

266 
	gcqe
->
	gSF_P
 = 0x0001 & 
cu¼’t_pha£
;

267 
	gcqe
->
	gCommªd_Id’tif›r
 = ((
SubmissiÚ_Queue_EÁry
*)
»que¡
->
IO_commªd_šfo
)->
Commªd_Id’tif›r
;

268 
IÅut_SŒ—m_SATA
* 
	gim
 = ((IÅut_SŒ—m_SATA*)
hi
->
šput_¡»am_mªag”
->
šput_¡»ams
[
SATA_STREAM_ID
]);

269 
	gho¡_š‹rçû
->
S’d_wr™e_mes§ge_to_ho¡
(
im
->
Com¶‘iÚ_queue_ba£_add»ss
 + im->
Com¶‘iÚ_
 * (
Com¶‘iÚ_Queue_EÁry
), 
cqe
, (Completion_Queue_Entry));

270 
	gnumb”_of_£Á_cqe
++;

271 ià(
	gnumb”_of_£Á_cqe
 % 
	gncq_d•th
 == 0) {

272 ià(
cu¼’t_pha£
 == 0xffff) {

273 
cu¼’t_pha£
 = 0xfffe;

275 
	gcu¼’t_pha£
 = 0xffff;

280 
	gReque¡_F‘ch_Un™_SATA
::
S’d_»ad_d©a
(
U£r_Reque¡
* 
»que¡
)

282 
SubmissiÚ_Queue_EÁry
* 
sqe
 = (SubmissiÚ_Queue_EÁry*)
»que¡
->
IO_commªd_šfo
;

283 
	gho¡_š‹rçû
->
S’d_wr™e_mes§ge_to_ho¡
(
sqe
->
PRP_’Œy_1
, 
»que¡
->
D©a
,„eque¡->
Size_š_by‹
);

286 
	gHo¡_IÁ”çû_SATA
::
Ho¡_IÁ”çû_SATA
(cÚ¡ 
sim_objeù_id_ty³
& 
id
,

287 cÚ¡ 
ušt16_t
 
ncq_d•th
, cÚ¡ 
LHA_ty³
 
max_logiÿl_£ùÜ_add»ss
, cÚ¡ 
£ùÜs_³r_·ge
, 
D©a_Cache_Mªag”_Ba£
* 
ÿche
) :

288 
Ho¡_IÁ”çû_Ba£
(
id
, 
Ho¡IÁ”çû_Ty³s
::
SATA
, 
max_logiÿl_£ùÜ_add»ss
, 
£ùÜs_³r_·ge
, 
ÿche
), 
ncq_d•th
(ncq_depth)

290 
	gthis
->
	gšput_¡»am_mªag”
 = 
Ãw
 
IÅut_SŒ—m_Mªag”_SATA
(
this
, 
ncq_d•th
, 0, 
max_logiÿl_£ùÜ_add»ss
);

291 
	gthis
->
	g»que¡_ãtch_un™
 = 
Ãw
 
Reque¡_F‘ch_Un™_SATA
(
this
, 
ncq_d•th
);

294 
	gHo¡_IÁ”çû_SATA
::
S‘_ncq_add»ss
(cÚ¡ 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, cÚ¡ ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
)

296 ((
	gIÅut_SŒ—m_Mªag”_SATA
*)
	gthis
->
	gšput_¡»am_mªag”
)->
S‘_ncq_add»ss
(
submissiÚ_queue_ba£_add»ss
, 
com¶‘iÚ_queue_ba£_add»ss
);

299 
	gHo¡_IÁ”çû_SATA
::
V®id©e_simuÏtiÚ_cÚfig
()

301 
Ho¡_IÁ”çû_Ba£
::
V®id©e_simuÏtiÚ_cÚfig
();

302 ià(
	gthis
->
	gšput_¡»am_mªag”
 =ğ
NULL
) {

303 
throw
 
¡d
::
logic_”rÜ
("Input stream manager is‚ot set for Host Interface");

305 ià(
	gthis
->
	g»que¡_ãtch_un™
 =ğ
NULL
) {

306 
throw
 
¡d
::
logic_”rÜ
("Request fetch unit is‚ot set for Host Interface");

310 
	gHo¡_IÁ”çû_SATA
::
S¹_simuÏtiÚ
() {}

312 
Ho¡_IÁ”çû_SATA
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
) {}

314 
Ho¡_IÁ”çû_SATA
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

316 
¡d
::
¡ršg
 
tmp
 = 
Çme_´efix
 + ".HostInterface";

317 
	gxmlwr™”
.
Wr™e_İ’_g
(
tmp
);

319 
	g¡d
::
¡ršg
 
©Œ
 = "Name";

320 
	g¡d
::
¡ršg
 
v®
 = 
ID
();

321 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

323 
	g©Œ
 = "Average_Read_Transaction_Turnaround_Time";

324 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_tuº¬ound_time
(
SATA_STREAM_ID
));

325 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

327 
	g©Œ
 = "Average_Read_Transaction_Execution_Time";

328 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_executiÚ_time
(
SATA_STREAM_ID
));

329 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

331 
	g©Œ
 = "Average_Read_Transaction_Transfer_Time";

332 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_Œªsãr_time
(
SATA_STREAM_ID
));

333 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

335 
	g©Œ
 = "Average_Read_Transaction_Waiting_Time";

336 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_»ad_Œª§ùiÚ_wa™šg_time
(
SATA_STREAM_ID
));

337 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

339 
	g©Œ
 = "Average_Write_Transaction_Turnaround_Time";

340 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_tuº¬ound_time
(
SATA_STREAM_ID
));

341 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

343 
	g©Œ
 = "Average_Write_Transaction_Execution_Time";

344 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_executiÚ_time
(
SATA_STREAM_ID
));

345 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

347 
	g©Œ
 = "Average_Write_Transaction_Transfer_Time";

348 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_Œªsãr_time
(
SATA_STREAM_ID
));

349 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

351 
	g©Œ
 = "Average_Write_Transaction_Waiting_Time";

352 
	gv®
 = 
¡d
::
to_¡ršg
(
šput_¡»am_mªag”
->
G‘_av”age_wr™e_Œª§ùiÚ_wa™šg_time
(
SATA_STREAM_ID
));

353 
	gxmlwr™”
.
Wr™e_©Œibu‹_¡ršg
(
©Œ
, 
v®
);

355 
	gxmlwr™”
.
Wr™e_şo£_g
();

358 
ušt16_t
 
	gHo¡_IÁ”çû_SATA
::
G‘_ncq_d•th
()

360  
ncq_d•th
;

	@src/ssd/Host_Interface_SATA.h

1 #iâdeà
HOST_INTERFACE_SATA_H


2 
	#HOST_INTERFACE_SATA_H


	)

4 
	~"Ho¡_IÁ”çû_Ba£.h
"

5 
	~"Ho¡_IÁ”çû_Defs.h
"

6 
	~"U£r_Reque¡.h
"

8 
Çme¥aû
 
	gSSD_CompÚ’ts


10 
	#SATA_STREAM_ID
 ((
¡»am_id_ty³
)(0))

	)

11 şas 
	cIÅut_SŒ—m_SATA
 : 
public
 
IÅut_SŒ—m_Ba£


13 
public
:

14 
IÅut_SŒ—m_SATA
(
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
,

15 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
è: 
IÅut_SŒ—m_Ba£
(),

16 
S¹_logiÿl_£ùÜ_add»ss
(
¡¬t_logiÿl_£ùÜ_add»ss
), 
End_logiÿl_£ùÜ_add»ss
(
’d_logiÿl_£ùÜ_add»ss
),

17 
SubmissiÚ_queue_ba£_add»ss
(
submissiÚ_queue_ba£_add»ss
), 
Com¶‘iÚ_queue_ba£_add»ss
(
com¶‘iÚ_queue_ba£_add»ss
),

18 
SubmissiÚ_h—d
(0), 
SubmissiÚ_h—d_šfÜmed_to_ho¡
(0), 
SubmissiÚ_
(0), 
Com¶‘iÚ_h—d
(0), 
Com¶‘iÚ_
(0), 
On_the_æy_»que¡s
(0) {}

19 ~
IÅut_SŒ—m_SATA
();

20 
LHA_ty³
 
	gS¹_logiÿl_£ùÜ_add»ss
;

21 
LHA_ty³
 
	gEnd_logiÿl_£ùÜ_add»ss
;

22 
ušt64_t
 
	gSubmissiÚ_queue_ba£_add»ss
;

23 
ušt64_t
 
	gCom¶‘iÚ_queue_ba£_add»ss
;

24 
ušt16_t
 
	gSubmissiÚ_h—d
;

25 
ušt16_t
 
	gSubmissiÚ_h—d_šfÜmed_to_ho¡
;

26 
ušt16_t
 
	gSubmissiÚ_
;

27 
ušt16_t
 
	gCom¶‘iÚ_h—d
;

28 
ušt16_t
 
	gCom¶‘iÚ_
;

29 
	g¡d
::
li¡
<
U£r_Reque¡
*> 
Wa™šg_u£r_»que¡s
;

30 
	g¡d
::
li¡
<
U£r_Reque¡
*> 
Com¶‘ed_u£r_»que¡s
;

31 
	g¡d
::
li¡
<
U£r_Reque¡
*> 
Wa™šg_wr™e_d©a_Œªsãrs
;

32 
ušt16_t
 
	gOn_the_æy_»que¡s
;

35 şas 
	cIÅut_SŒ—m_Mªag”_SATA
 : 
public
 
IÅut_SŒ—m_Mªag”_Ba£


37 
public
:

38 
IÅut_SŒ—m_Mªag”_SATA
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
ušt16_t
 
ncq_d•th
, 
LHA_ty³
 
¡¬t_logiÿl_£ùÜ_add»ss
, LHA_ty³ 
’d_logiÿl_£ùÜ_add»ss
);

39 
S‘_ncq_add»ss
(
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
);

40 
SubmissiÚ_queue__poš‹r_upd©e
(
ušt16_t
 
_poš‹r_v®ue
);

41 
Com¶‘iÚ_queue_h—d_poš‹r_upd©e
(
ušt16_t
 
h—d_poš‹r_v®ue
);

42 
HªdË_Ãw_¬rived_»que¡
(
U£r_Reque¡
* 
»que¡
);

43 
HªdË_¬rived_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
);

44 
HªdË_£rviûd_»que¡
(
U£r_Reque¡
* 
»que¡
);

45 
	g´iv©e
:

46 
£gm’t_u£r_»que¡
(
U£r_Reque¡
* 
u£r_»que¡
);

47 
šfÜm_ho¡_»que¡_com¶‘ed
(
U£r_Reque¡
* 
»que¡
);

48 
ušt16_t
 
	gncq_d•th
;

51 şas 
	cReque¡_F‘ch_Un™_SATA
 : 
public
 
Reque¡_F‘ch_Un™_Ba£


53 
public
:

54 
Reque¡_F‘ch_Un™_SATA
(
Ho¡_IÁ”çû_Ba£
* 
ho¡_š‹rçû
, 
ušt16_t
 
ncq_d•th
);

55 
F‘ch_Ãxt_»que¡
(
¡»am_id_ty³
 
¡»am_id
);

56 
F‘ch_wr™e_d©a
(
U£r_Reque¡
* 
»que¡
);

57 
S’d_»ad_d©a
(
U£r_Reque¡
* 
»que¡
);

58 
S’d_com¶‘iÚ_queue_–em’t
(
U£r_Reque¡
* 
»que¡
, 
ušt16_t
 
ncq_h—d_v®ue
);

59 
Proûss_pc›_wr™e_mes§ge
(
ušt64_t
, *, );

60 
Proûss_pc›_»ad_mes§ge
(
ušt64_t
, *, );

61 
	g´iv©e
:

62 
ušt16_t
 
cu¼’t_pha£
;

63 
ušt32_t
 
	gnumb”_of_£Á_cqe
;

64 
ušt16_t
 
	gncq_d•th
;

67 şas 
	cHo¡_IÁ”çû_SATA
 : 
public
 
Ho¡_IÁ”çû_Ba£


69 
ä›nd
 
şass
 
IÅut_SŒ—m_Mªag”_SATA
;

70 
ä›nd
 
şass
 
	gReque¡_F‘ch_Un™_SATA
;

71 
	gpublic
:

72 
Ho¡_IÁ”çû_SATA
(cÚ¡ 
sim_objeù_id_ty³
& 
id
,

73 cÚ¡ 
ušt16_t
 
ncq_d•th
, cÚ¡ 
LHA_ty³
 
max_logiÿl_£ùÜ_add»ss
, cÚ¡ 
£ùÜs_³r_·ge
, 
D©a_Cache_Mªag”_Ba£
* 
ÿche
);

74 
S‘_ncq_add»ss
(cÚ¡ 
ušt64_t
 
submissiÚ_queue_ba£_add»ss
, cÚ¡ ušt64_ˆ
com¶‘iÚ_queue_ba£_add»ss
);

75 
ušt16_t
 
G‘_ncq_d•th
();

76 
S¹_simuÏtiÚ
();

77 
V®id©e_simuÏtiÚ_cÚfig
();

78 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

79 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

80 
	g´iv©e
:

81 
ušt16_t
 
ncq_d•th
;

	@src/ssd/NVM_Channel_Base.h

1 #iâdeà
NVM_CHANNEL_BASE_H


2 
	#NVM_CHANNEL_BASE_H


	)

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 şas 
	cBusChªÃlStus
 { 
	gBUSY
, 
	gIDLE
 };

7 şas 
	cNVM_ChªÃl_Ba£
 {};

	@src/ssd/NVM_Firmware.cpp

1 
	~"NVM_Fœmw¬e.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
	gNVM_Fœmw¬e
::
NVM_Fœmw¬e
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
D©a_Cache_Mªag”_Ba£
* 
d©a_ÿche_mªag”
)

6 : 
MQSimEngše
::
Sim_Objeù
(
id
), 
D©a_ÿche_mªag”
(
d©a_ÿche_mªag”
)

10 
	gNVM_Fœmw¬e
::
V®id©e_simuÏtiÚ_cÚfig
()

	@src/ssd/NVM_Firmware.h

1 #iâdeà
NVM_FIRMWARE_H


2 
	#NVM_FIRMWARE_H


	)

4 
	~<veùÜ
>

5 
	~"../sim/Sim_Objeù.h
"

6 
	~"../uts/WÜklßd_Sti¡ics.h
"

7 
	~"NVM_T¿n§ùiÚ.h
"

8 
	~"D©a_Cache_Mªag”_Ba£.h
"

10 
Çme¥aû
 
	gSSD_CompÚ’ts


12 
şass
 
	gD©a_Cache_Mªag”_Ba£
;

13 şas 
	cNVM_Fœmw¬e
 : 
public
 
MQSimEngše
::
Sim_Objeù


15 
public
:

16 
NVM_Fœmw¬e
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
D©a_Cache_Mªag”_Ba£
* 
d©a_ÿche_mªag”
);

17 
V®id©e_simuÏtiÚ_cÚfig
();

18 
D©a_Cache_Mªag”_Ba£
* 
	gD©a_ÿche_mªag”
;

19 
vœtu®
 
LPA_ty³
 
CÚv”t_ho¡_logiÿl_add»ss_to_deviû_add»ss
(
LHA_ty³
 
lha
) = 0;

20 
vœtu®
 
·ge_¡©us_ty³
 
Fšd_NVM_subun™_acûss_b™m­
(
LHA_ty³
 
lha
) = 0;

21 
vœtu®
 
P”fÜm_´ecÚd™iÚ
(
¡d
::
veùÜ
<
Uts
::
WÜklßd_Sti¡ics
*> 
wÜklßd_¡©s
) = 0;

22 
vœtu®
 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
) = 0;

	@src/ssd/NVM_PHY_Base.cpp

1 
	~"NVM_PHY_Ba£.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
	gNVM_PHY_Ba£
::
NVM_PHY_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
)

6 : 
MQSimEngše
::
Sim_Objeù
(
id
)

10 
NVM_PHY_Ba£
::~NVM_PHY_Base()

	@src/ssd/NVM_PHY_Base.h

1 #iâdeà
NVM_PHY_BASE


2 
	#NVM_PHY_BASE


	)

4 
	~"../sim/Sim_Objeù.h
"

5 
	~"../nvm_ch/NVM_Ch.h
"

7 
Çme¥aû
 
	gSSD_CompÚ’ts


9 şas 
	cNVM_PHY_Ba£
 : 
public
 
MQSimEngše
::
Sim_Objeù


11 
public
:

12 
NVM_PHY_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
);

13 ~
NVM_PHY_Ba£
();

14 
vœtu®
 
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(cÚ¡ 
NVM
::
NVM_MemÜy_Add»ss
* 
add»ss
, cÚ¡ * 
¡©us_šfo
) = 0;

	@src/ssd/NVM_PHY_ONFI.cpp

1 
	~"NVM_PHY_ONFI.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts
 {

4 
	gNVM_PHY_ONFI
::
CÚÃùToT¿n§ùiÚS”viûdSigÇl
(
T¿n§ùiÚS”viûdHªdËrTy³
 
funùiÚ
)

6 
cÚÃùedT¿n§ùiÚS”viûdHªdËrs
.
push_back
(
funùiÚ
);

16 
	gNVM_PHY_ONFI
::
brßdÿ¡T¿n§ùiÚS”viûdSigÇl
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

18 
¡d
::
veùÜ
<
T¿n§ùiÚS”viûdHªdËrTy³
>::
™”©Ü
 
™
 = 
cÚÃùedT¿n§ùiÚS”viûdHªdËrs
.
begš
();

19 
	g™
 !ğ
cÚÃùedT¿n§ùiÚS”viûdHªdËrs
.
’d
(); it++) {

20 (*
	g™
)(
	gŒª§ùiÚ
);

22 
d–‘e
 
	gŒª§ùiÚ
;

25 
	gNVM_PHY_ONFI
::
CÚÃùToChªÃlIdËSigÇl
(
ChªÃlIdËHªdËrTy³
 
funùiÚ
)

27 
cÚÃùedChªÃlIdËHªdËrs
.
push_back
(
funùiÚ
);

30 
	gNVM_PHY_ONFI
::
brßdÿ¡ChªÃlIdËSigÇl
(
æash_chªÃl_ID_ty³
 
chªÃlID
)

32 
¡d
::
veùÜ
<
ChªÃlIdËHªdËrTy³
>::
™”©Ü
 
™
 = 
cÚÃùedChªÃlIdËHªdËrs
.
begš
();

33 
	g™
 !ğ
cÚÃùedChªÃlIdËHªdËrs
.
’d
(); it++) {

34 (*
	g™
)(
	gchªÃlID
);

38 
	gNVM_PHY_ONFI
::
CÚÃùToChIdËSigÇl
(
ChIdËHªdËrTy³
 
funùiÚ
)

40 
cÚÃùedChIdËHªdËrs
.
push_back
(
funùiÚ
);

43 
	gNVM_PHY_ONFI
::
brßdÿ¡ChIdËSigÇl
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

45 
¡d
::
veùÜ
<
ChIdËHªdËrTy³
>::
™”©Ü
 
™
 = 
cÚÃùedChIdËHªdËrs
.
begš
();

46 
	g™
 !ğ
cÚÃùedChIdËHªdËrs
.
’d
(); it++) {

47 (*
	g™
)(
	gch
);

	@src/ssd/NVM_PHY_ONFI.h

1 #iâdeà
NVM_PHY_ONFI_ONFI_H


2 
	#NVM_PHY_ONFI_ONFI_H


	)

4 
	~<veùÜ
>

5 
	~"../nvm_ch/æash_memÜy/FÏsh_Commªd.h
"

6 
	~"../nvm_ch/æash_memÜy/FÏsh_Ch.h
"

7 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

8 
	~"NVM_T¿n§ùiÚ_FÏsh_RD.h
"

9 
	~"NVM_T¿n§ùiÚ_FÏsh_WR.h
"

10 
	~"NVM_T¿n§ùiÚ_FÏsh_ER.h
"

11 
	~"NVM_PHY_Ba£.h
"

12 
	~"ONFI_ChªÃl_Ba£.h
"

15 
Çme¥aû
 
	gSSD_CompÚ’ts


17 şas 
	cChStus
 { 
	gIDLE
, 
	gCMD_IN
, 
	gCMD_DATA_IN
, 
	gDATA_OUT
, 
	gREADING
, 
	gWRITING
, 
	gERASING
, 
	gWAIT_FOR_DATA_OUT
, 
	gWAIT_FOR_COPYBACK_CMD
 };

19 şas 
	cNVM_PHY_ONFI
 : 
public
 
NVM_PHY_Ba£


21 
public
:

22 
NVM_PHY_ONFI
(
sim_objeù_id_ty³
 
id
,

23 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
)

24 : 
NVM_PHY_Ba£
(
id
),

25 
chªÃl_couÁ
(
ChªÃlCouÁ
), 
ch_no_³r_chªÃl
(ch_no_³r_chªÃl), 
d›_no_³r_ch
(
D›NoP”Ch
), 
¶ªe_no_³r_d›
(
PÏÃNoP”D›
){}

26 ~
NVM_PHY_ONFI
() {};

28 
vœtu®
 
BusChªÃlStus
 
G‘_chªÃl_¡©us
(
æash_chªÃl_ID_ty³
) = 0;

29 
vœtu®
 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
G‘_ch
(
æash_chªÃl_ID_ty³
 
chªÃl_id
, 
æash_ch_ID_ty³
 
ch_id
) = 0;

30 
vœtu®
 
LPA_ty³
 
G‘_m‘ad©a
(
æash_chªÃl_ID_ty³
 
chªÃ_id
, 
æash_ch_ID_ty³
 
ch_id
, 
æash_d›_ID_ty³
 
d›_id
, 
æash_¶ªe_ID_ty³
 
¶ªe_id
, 
æash_block_ID_ty³
 
block_id
, 
æash_·ge_ID_ty³
 
·ge_id
) = 0;

31 
vœtu®
 
boŞ
 
HasSu¥’dedCommªd
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
) = 0;

32 
vœtu®
 
ChStus
 
G‘ChStus
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
) = 0;

33 
vœtu®
 
sim_time_ty³
 
Ex³ùed_fšish_time
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
) = 0;

35 
vœtu®
 
S’d_commªd_to_ch
(
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>& 
Œª§ùiÚLi¡
) = 0;

36 
vœtu®
 
Chªge_æash_·ge_¡©us_fÜ_´ecÚd™iÚšg
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
, cÚ¡ 
LPA_ty³
 
Ía
) = 0;

38 (*
	gT¿n§ùiÚS”viûdHªdËrTy³
è(
	tNVM_T¿n§ùiÚ_FÏsh
*);

39 
CÚÃùToT¿n§ùiÚS”viûdSigÇl
(
T¿n§ùiÚS”viûdHªdËrTy³
);

40 (*
	gChªÃlIdËHªdËrTy³
è(
	tæash_chªÃl_ID_ty³
);

41 
CÚÃùToChªÃlIdËSigÇl
(
ChªÃlIdËHªdËrTy³
);

42 (*
	gChIdËHªdËrTy³
è(
	tNVM
::
	tFÏshMemÜy
::
	tFÏsh_Ch
*);

43 
CÚÃùToChIdËSigÇl
(
ChIdËHªdËrTy³
);

44 
	g´Ùeùed
:

45 
chªÃl_couÁ
;

46 
	gch_no_³r_chªÃl
;

47 
	gd›_no_³r_ch
;

48 
	g¶ªe_no_³r_d›
;

49 
	g¡d
::
veùÜ
<
T¿n§ùiÚS”viûdHªdËrTy³
> 
cÚÃùedT¿n§ùiÚS”viûdHªdËrs
;

50 
brßdÿ¡T¿n§ùiÚS”viûdSigÇl
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

51 
	g¡d
::
veùÜ
<
ChªÃlIdËHªdËrTy³
> 
cÚÃùedChªÃlIdËHªdËrs
;

52 
brßdÿ¡ChªÃlIdËSigÇl
(
æash_chªÃl_ID_ty³
);

53 
	g¡d
::
veùÜ
<
ChIdËHªdËrTy³
> 
cÚÃùedChIdËHªdËrs
;

54 
brßdÿ¡ChIdËSigÇl
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

	@src/ssd/NVM_PHY_ONFI_NVDDR2.cpp

1 
	~<¡dexû±
>

2 
	~"../sim/Engše.h
"

3 
	~"NVM_PHY_ONFI_NVDDR2.h
"

4 
	~"Sts.h
"

5 
	~"Add»ss_M­pšg_Un™_Page_Lev–.h
"

6 
	~"Add»ss_M­pšg_Un™_Ba£.h
"

7 
Çme¥aû
 
	gSSD_CompÚ’ts
 {

9 
NVM_PHY_ONFI_NVDDR2
* 
	gNVM_PHY_ONFI_NVDDR2
::
_my_š¡ªû
;

11 
	gNVM_PHY_ONFI_NVDDR2
::
NVM_PHY_ONFI_NVDDR2
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
ONFI_ChªÃl_NVDDR2
** 
chªÃls
,

12 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
)

13 : 
NVM_PHY_ONFI
(
id
, 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
), 
chªÃls
(channels)

15 
	gWa™šgR—dTX
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
chªÃl_couÁ
];

16 
	gWa™šgGCR—d_TX
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
chªÃl_couÁ
];

17 
	gWa™šgM­pšgR—d_TX
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
chªÃl_couÁ
];

18 
	gWa™šgCİybackWr™es
 = 
Ãw
 
¡d
::
li¡
<
D›BookK“pšgEÁry
*>[
chªÃl_couÁ
];

19 
	gbookK“pšgTabË
 = 
Ãw
 
ChBookK“pšgEÁry
*[
chªÃl_couÁ
];

20 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

21 
	gbookK“pšgTabË
[
chªÃlID
] = 
Ãw
 
ChBookK“pšgEÁry
[
ch_no_³r_chªÃl
];

22 
	gchID
 = 0; chID < 
	gch_no_³r_chªÃl
; chipID++) {

23 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gEx³ùed_commªd_exec_fšish_time
 = 
PTRT1
;

24 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gLa¡_Œªsãr_fšish_time
 = 
PTRT1
;

25 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
 = 
Ãw
 
D›BookK“pšgEÁry
[
D›NoP”Ch
];

26 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gStus
 = 
ChStus
::
IDLE
;

27 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gHasSu¥’d
 = 
çl£
;

28 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gWa™šgR—dTXCouÁ
 = 0;

29 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gNo_of_aùive_d›s
 = 0;

30 
	gd›ID
 = 0; d›ID < 
	gD›NoP”Ch
; dieID++) {

31 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gAùiveCommªd
 = 
NULL
;

32 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gAùiveT¿n§ùiÚs
.
ş—r
();

33 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gSu¥’dedCommªd
 = 
NULL
;

34 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gSu¥’dedT¿n§ùiÚs
.
ş—r
();

35 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gF»e
 = 
Œue
;

36 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gSu¥’ded
 = 
çl£
;

37 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gD›IÁ”ËavedTime
 = 
INVALID_TIME
;

38 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gEx³ùed_fšish_time
 = 
INVALID_TIME
;

39 
	gbookK“pšgTabË
[
chªÃlID
][
chID
].
	gD›_book_k“pšg_»cÜds
[
d›ID
].
	gRemaššgExecTime
 = 
INVALID_TIME
;

43 
	g_my_š¡ªû
 = 
this
;

46 
	gNVM_PHY_ONFI_NVDDR2
::
S‘up_Œigg”s
()

48 
Sim_Objeù
::
S‘up_Œigg”s
();

49 
	gi
 = 0; i < 
	gchªÃl_couÁ
; i++) {

50 
	gj
 = 0; j < 
	gch_no_³r_chªÃl
; j++) {

51 
	gchªÃls
[
i
]->
	gChs
[
j
]->
CÚÃù_to_ch_»ady_sigÇl
(
hªdË_»ady_sigÇl_äom_ch
);

57 
	gNVM_PHY_ONFI_NVDDR2
::
V®id©e_simuÏtiÚ_cÚfig
()

61 
NVM_PHY_ONFI_NVDDR2
::
S¹_simuÏtiÚ
()

65 
šlše
 
BusChªÃlStus
 
NVM_PHY_ONFI_NVDDR2
::
G‘_chªÃl_¡©us
(
æash_chªÃl_ID_ty³
 
chªÃlID
)

67  
chªÃls
[
chªÃlID
]->
G‘Stus
();

70 
šlše
 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
NVM_PHY_ONFI_NVDDR2
::
G‘_ch
(
æash_chªÃl_ID_ty³
 
chªÃlID
, 
æash_ch_ID_ty³
 
chID
)

72  
	gchªÃls
[
chªÃlID
]->
	gChs
[
chID
];

75 
LPA_ty³
 
	gNVM_PHY_ONFI_NVDDR2
::
G‘_m‘ad©a
(
æash_chªÃl_ID_ty³
 
chªÃ_id
, 
æash_ch_ID_ty³
 
ch_id
, 
æash_d›_ID_ty³
 
d›_id
, 
æash_¶ªe_ID_ty³
 
¶ªe_id
, 
æash_block_ID_ty³
 
block_id
, 
æash_·ge_ID_ty³
 
·ge_id
)

77  
	gchªÃls
[
chªÃ_id
]->
	gChs
[
ch_id
]->
G‘_m‘ad©a
(
d›_id
, 
¶ªe_id
, 
block_id
, 
·ge_id
);

80 
šlše
 
boŞ
 
	gNVM_PHY_ONFI_NVDDR2
::
HasSu¥’dedCommªd
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

82  
bookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
].
HasSu¥’d
;

85 
šlše
 
ChStus
 
	gNVM_PHY_ONFI_NVDDR2
::
G‘ChStus
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

87  
bookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
].
Stus
;

90 
šlše
 
sim_time_ty³
 
	gNVM_PHY_ONFI_NVDDR2
::
Ex³ùed_fšish_time
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

92  
bookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
].
Ex³ùed_commªd_exec_fšish_time
;

95 
sim_time_ty³
 
	gNVM_PHY_ONFI_NVDDR2
::
Ex³ùed_fšish_time
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

97  
Ex³ùed_fšish_time
(
chªÃls
[
Œª§ùiÚ
->
Add»ss
.
ChªÃlID
]->
Chs
[Œª§ùiÚ->Add»ss.
ChID
]);

101 
sim_time_ty³
 
	gNVM_PHY_ONFI_NVDDR2
::
Ex³ùed_Œªsãr_time
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

103  
NVDDR2D©aInT¿nsãrTime
(
Œª§ùiÚ
->
D©a_ªd_m‘ad©a_size_š_by‹
, 
chªÃls
[Œª§ùiÚ->
Add»ss
.
ChªÃlID
]);

106 
NVM_T¿n§ùiÚ_FÏsh
* 
	gNVM_PHY_ONFI_NVDDR2
::
Is_ch_busy_w™h_¡»am
(NVM_T¿n§ùiÚ_FÏsh* 
Œª§ùiÚ
)

108 
ChBookK“pšgEÁry
* 
chBKE
 = &
bookK“pšgTabË
[
Œª§ùiÚ
->
Add»ss
.
ChªÃlID
][Œª§ùiÚ->Add»ss.
ChID
];

109 
¡»am_id_ty³
 
	g¡»am_id
 = 
Œª§ùiÚ
->
SŒ—m_id
;

111 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

112 autØ&
	gŒ
 : 
chBKE
->
D›_book_k“pšg_»cÜds
[
d›_id
].
AùiveT¿n§ùiÚs
) {

113 ià(
Œ
->
SŒ—m_id
 =ğ
¡»am_id
) {

114  
Œ
;

119  
	gNULL
;

122 
boŞ
 
	gNVM_PHY_ONFI_NVDDR2
::
Is_ch_busy
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

124 
ChBookK“pšgEÁry
* 
chBKE
 = &
bookK“pšgTabË
[
Œª§ùiÚ
->
Add»ss
.
ChªÃlID
][Œª§ùiÚ->Add»ss.
ChID
];

125  (
	gchBKE
->
	gStus
 !ğ
ChStus
::
IDLE
);

128 
	gNVM_PHY_ONFI_NVDDR2
::
Chªge_æash_·ge_¡©us_fÜ_´ecÚd™iÚšg
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
, cÚ¡ 
LPA_ty³
 
Ía
)

130 
	gchªÃls
[
·ge_add»ss
.
ChªÃlID
]->
	gChs
[·ge_add»ss.
ChID
]->
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(&·ge_add»ss, &
Ía
);

133 
	gNVM_PHY_ONFI_NVDDR2
::
S’d_commªd_to_ch
(
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>& 
Œª§ùiÚ_li¡
)

135 
sim_time_ty³
 
Œx_time
;

136 
ONFI_ChªÃl_NVDDR2
* 
	grg‘_chªÃl
 = 
chªÃls
[
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
ChªÃlID
];

138 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
rg‘Ch
 = 
rg‘_chªÃl
->
Chs
[
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
ChID
];

139 
ChBookK“pšgEÁry
* 
	gchBKE
 = &
bookK“pšgTabË
[
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
ChªÃlID
][Œª§ùiÚ_li¡.äÚt()->Add»ss.
ChID
];

140 
D›BookK“pšgEÁry
* 
	gd›BKE
 = &
chBKE
->
D›_book_k“pšg_»cÜds
[
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
D›ID
];

144 ià(
	grg‘_chªÃl
->
G‘Stus
(è=ğ
BusChªÃlStus
::
BUSY
 && 
chBKE
->
OngošgD›CMDT¿nsãrs
.
size
() == 0) {

145 
PRINT_ERROR
("Bu " << 
rg‘_chªÃl
->
ChªÃlID
 << ": starting communication on‡ busy flash channel!");

148 
sim_time_ty³
 
	gsu¥’dTime
 = 0;

149 ià(!
	gd›BKE
->
	gF»e
) {

150 ià(
	gŒª§ùiÚ_li¡
.
äÚt
()->
	gSu¥’dRequœed
) {

151 
	gd›BKE
->
	gAùiveT¿n§ùiÚs
.
äÚt
()->
	gTy³
) {

152 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

153 
Sts
::
IssuedSu¥’dProg¿mCMD
++;

154 
	gsu¥’dTime
 = 
rg‘_chªÃl
->
Prog¿mSu¥’dCommªdTime
 + 
rg‘Ch
->
G‘Su¥’dProg¿mTime
();

156 
	gT¿n§ùiÚ_Ty³
::
ERASE
:

157 
Sts
::
IssuedSu¥’dE¿£CMD
++;

158 
	gsu¥’dTime
 = 
rg‘_chªÃl
->
E¿£Su¥’dCommªdTime
 + 
rg‘Ch
->
G‘Su¥’dE¿£Time
();

161 
PRINT_ERROR
("Read suspension is‚ot supported!")

163 
rg‘Ch
->
Su¥’d
(
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
D›ID
);

164 
	gd›BKE
->
P»·»Su¥’d
();

165 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
()) {

166 
	gchBKE
->
P»·»Su¥’d
();

169 
PRINT_ERROR
("Read suspension is‚ot supported!")

173 
	gd›BKE
->
	gF»e
 = 
çl£
;

174 
	gd›BKE
->
	gAùiveCommªd
 = 
Ãw
 
NVM
::
FÏshMemÜy
::
FÏsh_Commªd
();

175 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
Œª§ùiÚ_li¡
.
begš
();

176 
	g™
 !ğ
Œª§ùiÚ_li¡
.
’d
(); it++) {

177 
	gd›BKE
->
	gAùiveT¿n§ùiÚs
.
push_back
(*
™
);

178 
	gd›BKE
->
	gAùiveCommªd
->
	gAdd»ss
.
push_back
((*
™
)->
Add»ss
);

179 
	gNVM
::
FÏshMemÜy
::
PageM‘ad©a
 
m‘ad©a
;

180 
	gm‘ad©a
.
	gLPA
 = (*
™
)->
LPA
;

181 
	gd›BKE
->
	gAùiveCommªd
->
	gM‘a_d©a
.
push_back
(
m‘ad©a
);

184 
	gŒª§ùiÚ_li¡
.
äÚt
()->
	gTy³
) {

185 
	gT¿n§ùiÚ_Ty³
::
READ
:

186 ià(
Œª§ùiÚ_li¡
.
size
() == 1) {

187 
Sts
::
IssuedR—dCMD
++;

188 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_READ_PAGE
;

189 
DEBUG
("Ch " << 
rg‘Ch
->
ChªÃlID
 << ", " <<¬g‘Ch->
ChID
 << ", " << 
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
D›ID
 << ": S’dšg„—d commªdØch fÜ LPA: " <<¿n§ùiÚ_li¡.äÚt()->
LPA
)

191 
	gSts
::
IssuedMuÉÏÃR—dCMD
++;

192 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_READ_PAGE_MULTIPLANE
;

193 
DEBUG
("Ch " << 
rg‘Ch
->
ChªÃlID
 << ", " <<¬g‘Ch->
ChID
 << ", " << 
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
D›ID
 << ": S’dšg muÉi-¶ª»ad commªdØch fÜ LPA: " <<¿n§ùiÚ_li¡.äÚt()->
LPA
)

196 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
Œª§ùiÚ_li¡
.
begš
();

197 
	g™
 !ğ
Œª§ùiÚ_li¡
.
’d
(); it++) {

198 (*
	g™
)->
	gSTAT_Œªsãr_time
 +ğ
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

200 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
() == 0) {

201 
rg‘Ch
->
S¹CMDXãr
();

202 
	gchBKE
->
	gStus
 = 
ChStus
::
CMD_IN
;

204 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

206 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()], 
this
,

207 
d›BKE
, ()
NVDDR2_SimEv’tTy³
::
READ_CMD_ADDR_TRANSFERRED
);

209 
	gd›BKE
->
	gD›IÁ”ËavedTime
 = 
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

210 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 +ğ
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

212 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
push
(
d›BKE
);

213 
	gŒx_time
=
rg‘Ch
->
G‘_commªd_executiÚ_Ï‹ncy
(
d›BKE
->
AùiveCommªd
->
CommªdCode
, d›BKE->AùiveCommªd->
Add»ss
[0].
PageID
, dieBKE->ActiveCommand->Address[0]);

215 
	gd›BKE
->
	gEx³ùed_fšish_time
 = 
chBKE
->
La¡_Œªsãr_fšish_time
 + 
Œx_time
;

216 ià(
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 < 
	gd›BKE
->
	gEx³ùed_fšish_time
) {

217 
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 = 
d›BKE
->
Ex³ùed_fšish_time
;

223 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

226 ià(((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
Œª§ùiÚ_li¡
.
äÚt
())->
ExecutiÚMode
 =ğ
Wr™eExecutiÚModeTy³
::
SIMPLE
) {

227 ià(
Œª§ùiÚ_li¡
.
size
() == 1) {

228 
Sts
::
IssuedProg¿mCMD
++;

229 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_PROGRAM_PAGE
;

230 
DEBUG
("Ch " << 
rg‘Ch
->
ChªÃlID
 << ", " <<¬g‘Ch->
ChID
 << ", " << 
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
D›ID
 << ": S’dšg…rog¿m commªdØch fÜ LPA: " <<¿n§ùiÚ_li¡.äÚt()->
LPA
)

232 
	gSts
::
IssuedMuÉÏÃProg¿mCMD
++;

233 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_PROGRAM_PAGE_MULTIPLANE
;

234 
DEBUG
("Ch " << 
rg‘Ch
->
ChªÃlID
 << ", " <<¬g‘Ch->
ChID
 << ", " << 
Œª§ùiÚ_li¡
.
äÚt
()->
Add»ss
.
D›ID
 << ": S’dšg muÉi-¶ª´og¿m commªdØch fÜ LPA: " <<¿n§ùiÚ_li¡.äÚt()->
LPA
)

237 
sim_time_ty³
 
	gd©a_Œªsãr_time
 = 0;

239 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
Œª§ùiÚ_li¡
.
begš
();

240 
	g™
 !ğ
Œª§ùiÚ_li¡
.
’d
(); it++) {

241 (*
	g™
)->
	gSTAT_Œªsãr_time
 +ğ
rg‘_chªÃl
->
Prog¿mCommªdTime
[
Œª§ùiÚ_li¡
.
size
()] + 
NVDDR2D©aInT¿nsãrTime
((*
™
)->
D©a_ªd_m‘ad©a_size_š_by‹
,arget_channel);

242 
	gd©a_Œªsãr_time
 +ğ
NVDDR2D©aInT¿nsãrTime
((*
™
)->
D©a_ªd_m‘ad©a_size_š_by‹
, 
rg‘_chªÃl
);

244 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
() == 0) {

245 
rg‘Ch
->
S¹CMDD©aInXãr
();

246 
	gchBKE
->
	gStus
 = 
ChStus
::
CMD_DATA_IN
;

247 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
Prog¿mCommªdTime
[
Œª§ùiÚ_li¡
.
size
()] + 
d©a_Œªsãr_time
;

250 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
Prog¿mCommªdTime
[
Œª§ùiÚ_li¡
.
size
()] + 
d©a_Œªsãr_time
,

251 
this
, 
d›BKE
, ()
NVDDR2_SimEv’tTy³
::
PROGRAM_CMD_ADDR_DATA_TRANSFERRED
);

253 
	gd›BKE
->
	gD›IÁ”ËavedTime
 = 
su¥’dTime
 + 
rg‘_chªÃl
->
Prog¿mCommªdTime
[
Œª§ùiÚ_li¡
.
size
()] + 
d©a_Œªsãr_time
;

254 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 +ğ
su¥’dTime
 + 
rg‘_chªÃl
->
Prog¿mCommªdTime
[
Œª§ùiÚ_li¡
.
size
()] + 
d©a_Œªsãr_time
;

256 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
push
(
d›BKE
);

258 
	gŒx_time
=
rg‘Ch
->
G‘_commªd_executiÚ_Ï‹ncy
(
d›BKE
->
AùiveCommªd
->
CommªdCode
, d›BKE->AùiveCommªd->
Add»ss
[0].
PageID
,dieBKE->ActiveCommand->Address[0]);

259 
	gd›BKE
->
	gEx³ùed_fšish_time
 = 
chBKE
->
La¡_Œªsãr_fšish_time
 + 
Œx_time
;

260 ((
	gAdd»ss_M­pšg_Un™_Page_Lev–
*)
	gál
->
	gAdd»ss_M­pšg_Un™
)->
£nd_to_amu
(
Œx_time
,
d›BKE
->
AùiveCommªd
->
Add»ss
[0],d›BKE->
AùiveT¿n§ùiÚs
.
äÚt
()->
SŒ—m_id
);

261 ià(
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 < 
	gd›BKE
->
	gEx³ùed_fšish_time
) {

262 
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 = 
d›BKE
->
Ex³ùed_fšish_time
;

267 ià(
	gŒª§ùiÚ_li¡
.
size
() == 1) {

268 
Sts
::
IssuedCİybackR—dCMD
++;

269 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_READ_PAGE_COPYBACK
;

271 
	gSts
::
IssuedMuÉÏÃCİybackProg¿mCMD
++;

272 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_READ_PAGE_COPYBACK_MULTIPLANE
;

275 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
Œª§ùiÚ_li¡
.
begš
();

276 
	g™
 !ğ
Œª§ùiÚ_li¡
.
’d
(); it++) {

277 (*
	g™
)->
	gSTAT_Œªsãr_time
 +ğ
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

279 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
() == 0) {

280 
rg‘Ch
->
S¹CMDXãr
();

281 
	gchBKE
->
	gStus
 = 
ChStus
::
CMD_IN
;

282 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

283 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()], 
this
,

284 
d›BKE
, ()
NVDDR2_SimEv’tTy³
::
READ_CMD_ADDR_TRANSFERRED
);

286 
	gd›BKE
->
	gD›IÁ”ËavedTime
 = 
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

287 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 +ğ
su¥’dTime
 + 
rg‘_chªÃl
->
R—dCommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

289 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
push
(
d›BKE
);

290 
	gŒx_time
=
rg‘Ch
->
G‘_commªd_executiÚ_Ï‹ncy
(
d›BKE
->
AùiveCommªd
->
CommªdCode
, d›BKE->AùiveCommªd->
Add»ss
[0].
PageID
,dieBKE->ActiveCommand->Address[0]);

291 
	gd›BKE
->
	gEx³ùed_fšish_time
 = 
chBKE
->
La¡_Œªsãr_fšish_time
+
Œx_time
;

292 ((
	gAdd»ss_M­pšg_Un™_Page_Lev–
*)
	gál
->
	gAdd»ss_M­pšg_Un™
)->
£nd_to_amu
(
Œx_time
,
d›BKE
->
AùiveCommªd
->
Add»ss
[0],d›BKE->
AùiveT¿n§ùiÚs
.
äÚt
()->
SŒ—m_id
);

293 ià(
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 < 
	gd›BKE
->
	gEx³ùed_fšish_time
) {

294 
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 = 
d›BKE
->
Ex³ùed_fšish_time
;

301 
	gT¿n§ùiÚ_Ty³
::
ERASE
:

303 ià(
Œª§ùiÚ_li¡
.
size
() == 1) {

304 
Sts
::
IssuedE¿£CMD
++;

305 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_ERASE_BLOCK
;

307 
	gSts
::
IssuedMuÉÏÃE¿£CMD
++;

308 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_ERASE_BLOCK_MULTIPLANE
;

311 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
Œª§ùiÚ_li¡
.
begš
();

312 
	g™
 !ğ
Œª§ùiÚ_li¡
.
’d
(); it++) {

313 (*
	g™
)->
	gSTAT_Œªsãr_time
 +ğ
rg‘_chªÃl
->
E¿£CommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

315 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
() == 0) {

316 
rg‘Ch
->
S¹CMDXãr
();

317 
	gchBKE
->
	gStus
 = 
ChStus
::
CMD_IN
;

318 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
E¿£CommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

319 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
su¥’dTime
 + 
rg‘_chªÃl
->
E¿£CommªdTime
[
Œª§ùiÚ_li¡
.
size
()],

320 
this
, 
d›BKE
, ()
NVDDR2_SimEv’tTy³
::
ERASE_SETUP_COMPLETED
);

322 
	gd›BKE
->
	gD›IÁ”ËavedTime
 = 
su¥’dTime
 + 
rg‘_chªÃl
->
E¿£CommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

323 
	gchBKE
->
	gLa¡_Œªsãr_fšish_time
 +ğ
su¥’dTime
 + 
rg‘_chªÃl
->
E¿£CommªdTime
[
Œª§ùiÚ_li¡
.
size
()];

325 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
push
(
d›BKE
);

327 
	gd›BKE
->
	gEx³ùed_fšish_time
 = 
chBKE
->
La¡_Œªsãr_fšish_time
 +
rg‘Ch
->
G‘_commªd_executiÚ_Ï‹ncy
(
d›BKE
->
AùiveCommªd
->
CommªdCode
, d›BKE->AùiveCommªd->
Add»ss
[0].
PageID
,dieBKE->ActiveCommand->Address[0]);

328 ià(
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 < 
	gd›BKE
->
	gEx³ùed_fšish_time
) {

329 
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 = 
d›BKE
->
Ex³ùed_fšish_time
;

333 
throw
 
¡d
::
šv®id_¬gum’t
("NVM_PHY_ONFI_NVDDR2: Unhandledƒvent specified!");

336 
	grg‘_chªÃl
->
S‘Stus
(
BusChªÃlStus
::
BUSY
, 
rg‘Ch
);

339 
	gNVM_PHY_ONFI_NVDDR2
::
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(cÚ¡ 
NVM
::
NVM_MemÜy_Add»ss
* 
add»ss
, cÚ¡ * 
¡©us_šfo
)

341 
	gchªÃls
[((
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
*)
add»ss
)->
ChªÃlID
]->
Chs
[((NVM::FÏshMemÜy::Physiÿl_Page_Add»ss*ïdd»ss)->
ChID
]->
Chªge_memÜy_¡©us_´ecÚd™iÚšg
×dd»ss, 
¡©us_šfo
);

344 
cİy_»ad_d©a_to_Œª§ùiÚ
(
NVM_T¿n§ùiÚ_FÏsh_RD
* 
»ad_Œª§ùiÚ
, 
NVM
::
FÏshMemÜy
::
FÏsh_Commªd
* 
commªd
)

346 
i
 = 0;

347 autØ&
	gadd»ss
 : 
commªd
->
Add»ss
) {

348 ià(
add»ss
.
PÏÃID
 =ğ
»ad_Œª§ùiÚ
->
Add»ss
.PlaneID) {

349 
»ad_Œª§ùiÚ
->
LPA
 = 
commªd
->
M‘a_d©a
[
i
].LPA;

351 
	gi
++;

355 
	gNVM_PHY_ONFI_NVDDR2
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev
)

357 
D›BookK“pšgEÁry
* 
d›BKE
 = (D›BookK“pšgEÁry*)
ev
->
P¬am‘”s
;

358 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = 
d›BKE
->
AùiveT¿n§ùiÚs
.
äÚt
()->
Add»ss
.
ChªÃlID
;

359 
ONFI_ChªÃl_NVDDR2
* 
	grg‘ChªÃl
 = 
chªÃls
[
chªÃl_id
];

360 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
rg‘Ch
 = 
rg‘ChªÃl
->
Chs
[
d›BKE
->
AùiveT¿n§ùiÚs
.
äÚt
()->
Add»ss
.
ChID
];

361 
ChBookK“pšgEÁry
 *
	gchBKE
 = &
bookK“pšgTabË
[
chªÃl_id
][
rg‘Ch
->
ChID
];

363 (
	gNVDDR2_SimEv’tTy³
)
	gev
->
	gTy³
) {

364 
	gNVDDR2_SimEv’tTy³
::
READ_CMD_ADDR_TRANSFERRED
:

366 
rg‘Ch
->
EndCMDXãr
(
d›BKE
->
AùiveCommªd
);

367 autØ
	gŒ
 : 
d›BKE
->
AùiveT¿n§ùiÚs
) {

368 
Œ
->
STAT_executiÚ_time
 = 
d›BKE
->
Ex³ùed_fšish_time
 - 
SimuÏtÜ
->
Time
();

370 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
pİ
();

371 
	gchBKE
->
	gNo_of_aùive_d›s
++;

372 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
() > 0) {

373 
³rfÜm_š‹¾—ved_cmd_d©a_Œªsãr
(
rg‘Ch
, 
chBKE
->
OngošgD›CMDT¿nsãrs
.
äÚt
());

376 
	gchBKE
->
	gStus
 = 
ChStus
::
READING
;

377 
	grg‘ChªÃl
->
S‘Stus
(
BusChªÃlStus
::
IDLE
, 
rg‘Ch
);

380 
	gNVDDR2_SimEv’tTy³
::
ERASE_SETUP_COMPLETED
:

382 
rg‘Ch
->
EndCMDXãr
(
d›BKE
->
AùiveCommªd
);

383 autØ&
	gŒ
 : 
d›BKE
->
AùiveT¿n§ùiÚs
) {

384 
Œ
->
STAT_executiÚ_time
 = 
d›BKE
->
Ex³ùed_fšish_time
 - 
SimuÏtÜ
->
Time
();

386 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
pİ
();

387 
	gchBKE
->
	gNo_of_aùive_d›s
++;

388 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
() > 0) {

389 
³rfÜm_š‹¾—ved_cmd_d©a_Œªsãr
(
rg‘Ch
, 
chBKE
->
OngošgD›CMDT¿nsãrs
.
äÚt
());

392 
	gchBKE
->
	gStus
 = 
ChStus
::
ERASING
;

393 
	grg‘ChªÃl
->
S‘Stus
(
BusChªÃlStus
::
IDLE
, 
rg‘Ch
);

396 
	gNVDDR2_SimEv’tTy³
::
PROGRAM_CMD_ADDR_DATA_TRANSFERRED
:

397 
NVDDR2_SimEv’tTy³
::
PROGRAM_COPYBACK_CMD_ADDR_TRANSFERRED
:

399 
rg‘Ch
->
EndCMDD©aInXãr
(
d›BKE
->
AùiveCommªd
);

400 autØ&
	gŒ
 : 
d›BKE
->
AùiveT¿n§ùiÚs
) {

401 
Œ
->
STAT_executiÚ_time
 = 
d›BKE
->
Ex³ùed_fšish_time
 - 
SimuÏtÜ
->
Time
();

403 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
pİ
();

404 
	gchBKE
->
	gNo_of_aùive_d›s
++;

405 ià(
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
size
() > 0)

407 
³rfÜm_š‹¾—ved_cmd_d©a_Œªsãr
(
rg‘Ch
, 
chBKE
->
OngošgD›CMDT¿nsãrs
.
äÚt
());

410 
	gchBKE
->
	gStus
 = 
ChStus
::
WRITING
;

411 
	grg‘ChªÃl
->
S‘Stus
(
BusChªÃlStus
::
IDLE
, 
rg‘Ch
);

414 
	gNVDDR2_SimEv’tTy³
::
READ_DATA_TRANSFERRED
:

416 
rg‘Ch
->
EndD©aOutXãr
(
d›BKE
->
AùiveCommªd
);

417 
cİy_»ad_d©a_to_Œª§ùiÚ
((
NVM_T¿n§ùiÚ_FÏsh_RD
*)
d›BKE
->
AùiveT¿nsãr
, d›BKE->
AùiveCommªd
);

419 ià(
	gŒ
->
	gExecutiÚMode
 !ğ
ExecutiÚModeTy³
::
COPYBACK
)

421 
brßdÿ¡T¿n§ùiÚS”viûdSigÇl
(
d›BKE
->
AùiveT¿nsãr
);

423 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
d›BKE
->
AùiveT¿n§ùiÚs
.
begš
();

424 
	g™
 !ğ
d›BKE
->
AùiveT¿n§ùiÚs
.
’d
(); it++) {

425 ià((*
	g™
è=ğ
d›BKE
->
AùiveT¿nsãr
) {

426 
d›BKE
->
AùiveT¿n§ùiÚs
.
”a£
(
™
);

430 
	gd›BKE
->
	gAùiveT¿nsãr
 = 
NULL
;

431 ià(
	gd›BKE
->
	gAùiveT¿n§ùiÚs
.
size
() == 0) {

432 
d›BKE
->
CË¬Commªd
();

435 
	gchBKE
->
	gWa™šgR—dTXCouÁ
--;

436 ià(
	gchBKE
->
	gNo_of_aùive_d›s
 == 0) {

437 ià(
chBKE
->
Wa™šgR—dTXCouÁ
 == 0) {

438 
chBKE
->
Stus
 = 
ChStus
::
IDLE
;

440 
	gchBKE
->
	gStus
 = 
ChStus
::
WAIT_FOR_DATA_OUT
;

443 ià(
	gchBKE
->
	gStus
 =ğ
ChStus
::
IDLE
) {

444 ià(
d›BKE
->
Su¥’ded
) {

445 
£nd_»sume_commªd_to_ch
(
rg‘Ch
, 
chBKE
);

448 
	grg‘ChªÃl
->
S‘Stus
(
BusChªÃlStus
::
IDLE
, 
rg‘Ch
);

451 
PRINT_ERROR
("Unknown simulationƒvent specified for NVM_PHY_ONFI_NVDDR2!")

456 ià(
Wa™šgCİybackWr™es
[
chªÃl_id
].
size
() > 0) {

457 
D›BookK“pšgEÁry
* 
wa™šgBKE
 = 
Wa™šgCİybackWr™es
[
chªÃl_id
].
äÚt
();

458 
	grg‘Ch
 = 
chªÃls
[
chªÃl_id
]->
Chs
[
wa™šgBKE
->
AùiveT¿n§ùiÚs
.
äÚt
()->
Add»ss
.
ChID
];

459 
ChBookK“pšgEÁry
* 
	gwa™šgChBKE
 = &
bookK“pšgTabË
[
chªÃl_id
][
rg‘Ch
->
ChID
];

460 ià(
	gwa™šgBKE
->
	gAùiveT¿n§ùiÚs
.
size
() > 1) {

461 
	gSts
::
IssuedMuÉÏÃCİybackProg¿mCMD
++;

462 
	gwa™šgBKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_PROGRAM_PAGE_COPYBACK_MULTIPLANE
;

464 
	gSts
::
IssuedCİybackProg¿mCMD
++;

465 
	gwa™šgBKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_PROGRAM_PAGE_COPYBACK
;

467 
	grg‘Ch
->
S¹CMDXãr
();

468 
	gwa™šgChBKE
->
	gStus
 = 
ChStus
::
CMD_IN
;

469 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
this
->
chªÃls
[
chªÃl_id
]->
Prog¿mCommªdTime
[
wa™šgBKE
->
AùiveT¿n§ùiÚs
.
size
()],

470 
this
, 
wa™šgBKE
, ()
NVDDR2_SimEv’tTy³
::
PROGRAM_COPYBACK_CMD_ADDR_TRANSFERRED
);

471 
	gwa™šgChBKE
->
	gOngošgD›CMDT¿nsãrs
.
push
(
wa™šgBKE
);

472 
sim_time_ty³
 
	gŒx_time
=
rg‘Ch
->
G‘_commªd_executiÚ_Ï‹ncy
(
wa™šgBKE
->
AùiveCommªd
->
CommªdCode
, wa™šgBKE->AùiveCommªd->
Add»ss
[0].
PageID
, waitingBKE->ActiveCommand->Address[0]);

473 
	gwa™šgBKE
->
	gEx³ùed_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
this
->
chªÃls
[
chªÃl_id
]->
Prog¿mCommªdTime
[
wa™šgBKE
->
AùiveT¿n§ùiÚs
.
size
()]

474 + 
Œx_time
;

475 ((
	gAdd»ss_M­pšg_Un™_Page_Lev–
*)
	gál
->
	gAdd»ss_M­pšg_Un™
)->
£nd_to_amu
(
Œx_time
,
d›BKE
->
AùiveCommªd
->
Add»ss
[0],d›BKE->
AùiveT¿n§ùiÚs
.
äÚt
()->
SŒ—m_id
);

476 ià(
	gwa™šgChBKE
->
	gEx³ùed_commªd_exec_fšish_time
 < 
	gwa™šgBKE
->
	gEx³ùed_fšish_time
) {

477 
	gwa™šgChBKE
->
	gEx³ùed_commªd_exec_fšish_time
 = 
wa™šgBKE
->
Ex³ùed_fšish_time
;

480 
	gWa™šgCİybackWr™es
[
chªÃl_id
].
pİ_äÚt
();

481 
	gchªÃls
[
chªÃl_id
]->
S‘Stus
(
BusChªÃlStus
::
BUSY
, 
rg‘Ch
);

484 } ià(
	gWa™šgM­pšgR—d_TX
[
chªÃl_id
].
size
() > 0) {

485 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	gwa™šgTR
 = (NVM_T¿n§ùiÚ_FÏsh_RD*)
Wa™šgM­pšgR—d_TX
[
chªÃl_id
].
äÚt
();

486 
	gWa™šgM­pšgR—d_TX
[
chªÃl_id
].
pİ_äÚt
();

487 
Œªsãr_»ad_d©a_äom_ch
(&
bookK“pšgTabË
[
chªÃl_id
][
wa™šgTR
->
Add»ss
.
ChID
],

488 &(
bookK“pšgTabË
[
chªÃl_id
][
wa™šgTR
->
Add»ss
.
ChID
].
D›_book_k“pšg_»cÜds
[wa™šgTR->Add»ss.
D›ID
]), waitingTR);

491 } ià(
	gWa™šgR—dTX
[
chªÃl_id
].
size
() > 0) {

492 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	gwa™šgTR
 = (NVM_T¿n§ùiÚ_FÏsh_RD*)
Wa™šgR—dTX
[
chªÃl_id
].
äÚt
();

493 
	gWa™šgR—dTX
[
chªÃl_id
].
pİ_äÚt
();

494 
Œªsãr_»ad_d©a_äom_ch
(&
bookK“pšgTabË
[
chªÃl_id
][
wa™šgTR
->
Add»ss
.
ChID
],

495 &(
bookK“pšgTabË
[
chªÃl_id
][
wa™šgTR
->
Add»ss
.
ChID
].
D›_book_k“pšg_»cÜds
[wa™šgTR->Add»ss.
D›ID
]), waitingTR);

498 } ià(
	gWa™šgGCR—d_TX
[
chªÃl_id
].
size
() > 0) {

499 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	gwa™šgTR
 = (NVM_T¿n§ùiÚ_FÏsh_RD*)
Wa™šgGCR—d_TX
[
chªÃl_id
].
äÚt
();

500 
	gWa™šgGCR—d_TX
[
chªÃl_id
].
pİ_äÚt
();

501 
Œªsãr_»ad_d©a_äom_ch
(&
bookK“pšgTabË
[
chªÃl_id
][
wa™šgTR
->
Add»ss
.
ChID
],

502 &(
bookK“pšgTabË
[
chªÃl_id
][
wa™šgTR
->
Add»ss
.
ChID
].
D›_book_k“pšg_»cÜds
[wa™šgTR->Add»ss.
D›ID
]), waitingTR);

507 
brßdÿ¡ChªÃlIdËSigÇl
(
chªÃl_id
);

510 
šlše
 
	gNVM_PHY_ONFI_NVDDR2
::
hªdË_»ady_sigÇl_äom_ch
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
, NVM::FÏshMemÜy::
FÏsh_Commªd
* 
commªd
)

512 
ChBookK“pšgEÁry
 *
chBKE
 = &
_my_š¡ªû
->
bookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
];

513 
D›BookK“pšgEÁry
 *
	gd›BKE
 = &(
chBKE
->
D›_book_k“pšg_»cÜds
[
commªd
->
Add»ss
[0].
D›ID
]);

515 
	gcommªd
->
	gCommªdCode
)

517 
	gCMD_READ_PAGE
:

518 
CMD_READ_PAGE_MULTIPLANE
:

519 
DEBUG
("Ch " << 
ch
->
ChªÃlID
 << ", " << ch->
ChID
 << ": finished„ead command")

520 
chBKE
->
No_of_aùive_d›s
--;

521 ià(
	gchBKE
->
	gNo_of_aùive_d›s
 == 0)

522 
chBKE
->
Stus
 = 
ChStus
::
WAIT_FOR_DATA_OUT
;

524 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
d›BKE
->
AùiveT¿n§ùiÚs
.
begš
();

525 
	g™
 !ğ
d›BKE
->
AùiveT¿n§ùiÚs
.
’d
(); it++)

527 
	gchBKE
->
	gWa™šgR—dTXCouÁ
++;

528 ià(
	g_my_š¡ªû
->
	gchªÃls
[
ch
->
ChªÃlID
]->
G‘Stus
(è=ğ
BusChªÃlStus
::
IDLE
)

529 
_my_š¡ªû
->
Œªsãr_»ad_d©a_äom_ch
(
chBKE
, 
d›BKE
, (*
™
));

532 
	gd›BKE
->
	gAùiveT¿n§ùiÚs
.
äÚt
()->
	gSourû
)

534 
	gT¿n§ùiÚ_Sourû_Ty³
::
CACHE
:

535 
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
:

536 
_my_š¡ªû
->
Wa™šgR—dTX
[
ch
->
ChªÃlID
].
push_back
((*
™
));

538 
	gT¿n§ùiÚ_Sourû_Ty³
::
GC_WL
:

539 
_my_š¡ªû
->
Wa™šgGCR—d_TX
[
ch
->
ChªÃlID
].
push_back
((*
™
));

541 
	gT¿n§ùiÚ_Sourû_Ty³
::
MAPPING
:

542 
_my_š¡ªû
->
Wa™šgM­pšgR—d_TX
[
ch
->
ChªÃlID
].
push_back
((*
™
));

548 
	gCMD_READ_PAGE_COPYBACK
:

549 
CMD_READ_PAGE_COPYBACK_MULTIPLANE
:

550 
chBKE
->
No_of_aùive_d›s
--;

551 ià(
	gchBKE
->
	gNo_of_aùive_d›s
 == 0)

552 
chBKE
->
Stus
 = 
ChStus
::
WAIT_FOR_COPYBACK_CMD
;

553 ià(
	g_my_š¡ªû
->
	gchªÃls
[
ch
->
ChªÃlID
]->
G‘Stus
(è=ğ
BusChªÃlStus
::
IDLE
)

555 ià(
d›BKE
->
AùiveT¿n§ùiÚs
.
size
() > 1)

557 
Sts
::
IssuedMuÉÏÃCİybackProg¿mCMD
++;

558 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_PROGRAM_PAGE_COPYBACK_MULTIPLANE
;

562 
	gSts
::
IssuedCİybackProg¿mCMD
++;

563 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
 = 
CMD_PROGRAM_PAGE_COPYBACK
;

566 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
d›BKE
->
AùiveT¿n§ùiÚs
.
begš
();

567 
	g™
 !ğ
d›BKE
->
AùiveT¿n§ùiÚs
.
’d
(); it++)

569 (*
	g™
)->
	gSTAT_Œªsãr_time
 +ğ
_my_š¡ªû
->
chªÃls
[
ch
->
ChªÃlID
]->
Prog¿mCommªdTime
[
d›BKE
->
AùiveT¿n§ùiÚs
.
size
()];

571 
	gch
->
S¹CMDXãr
();

572 
	gchBKE
->
	gStus
 = 
ChStus
::
CMD_IN
;

573 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
_my_š¡ªû
->
chªÃls
[
ch
->
ChªÃlID
]->
Prog¿mCommªdTime
[
d›BKE
->
AùiveT¿n§ùiÚs
.
size
()],

574 
_my_š¡ªû
, 
d›BKE
, ()
NVDDR2_SimEv’tTy³
::
PROGRAM_COPYBACK_CMD_ADDR_TRANSFERRED
);

575 
	gchBKE
->
	gOngošgD›CMDT¿nsãrs
.
push
(
d›BKE
);

576 
	g_my_š¡ªû
->
	gchªÃls
[
ch
->
ChªÃlID
]->
S‘Stus
(
BusChªÃlStus
::
BUSY
, chip);

578 
	gd›BKE
->
	gEx³ùed_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
_my_š¡ªû
->
chªÃls
[
ch
->
ChªÃlID
]->
Prog¿mCommªdTime
[
d›BKE
->
AùiveT¿n§ùiÚs
.
size
()]

579 + 
ch
->
G‘_commªd_executiÚ_Ï‹ncy
(
d›BKE
->
AùiveCommªd
->
CommªdCode
, d›BKE->AùiveCommªd->
Add»ss
[0].
PageID
, dieBKE->ActiveCommand->Address[0]);

580 ià(
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 < 
	gd›BKE
->
	gEx³ùed_fšish_time
)

581 
	gchBKE
->
	gEx³ùed_commªd_exec_fšish_time
 = 
d›BKE
->
Ex³ùed_fšish_time
;

584 
	gSimuÏtÜ
->
Regi¡”Ev’t
(
SimuÏtÜ
->
Time
(è+ 
chªÃls
[
rg‘Ch
->
ChªÃlID
]->
Prog¿mCommªdTime
 + 
NVDDR2D©aOutT¿nsãrTime
(
rg‘T¿n§ùiÚ
->
SizeInBy‹
, channels[targetChip->ChannelID]),

585 
this
, 
rg‘T¿n§ùiÚ
, ()
NVDDR2_SimEv’tTy³
::
READ_DATA_TRANSFERRED
);

586 
	grg‘T¿n§ùiÚ
->
	gSTAT_T¿nsãrTime
 +ğ
NVDDR2D©aOutT¿nsãrTime
(
rg‘T¿n§ùiÚ
->
SizeInBy‹
, 
chªÃls
[
rg‘Ch
->
ChªÃlID
]);

589 
	g_my_š¡ªû
->
	gWa™šgCİybackWr™es
->
push_back
(
d›BKE
);

591 
	gCMD_PROGRAM_PAGE
:

592 
CMD_PROGRAM_PAGE_MULTIPLANE
:

593 
CMD_PROGRAM_PAGE_COPYBACK
:

594 
CMD_PROGRAM_PAGE_COPYBACK_MULTIPLANE
:

596 
DEBUG
("2.Ch " << 
ch
->
ChªÃlID
 << ", " << ch->
ChID
 << ": finished…rogram command")

597 
i
 = 0;

598 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
d›BKE
->
AùiveT¿n§ùiÚs
.
begš
();

599 
	g™
 !ğ
d›BKE
->
AùiveT¿n§ùiÚs
.
’d
(); it++, 
	gi
++)

601 ((
	gNVM_T¿n§ùiÚ_FÏsh_WR
*)(*
	g™
))->
	gCÚ‹Á
 = 
commªd
->
M‘a_d©a
[
i
].
LPA
;

602 
	g_my_š¡ªû
->
brßdÿ¡T¿n§ùiÚS”viûdSigÇl
(*
™
);

604 
	gd›BKE
->
	gAùiveT¿n§ùiÚs
.
ş—r
();

605 
	gd›BKE
->
CË¬Commªd
();

607 
	gchBKE
->
	gNo_of_aùive_d›s
--;

608 ià(
	gchBKE
->
	gNo_of_aùive_d›s
 =ğ0 && 
chBKE
->
Wa™šgR—dTXCouÁ
 == 0)

609 
chBKE
->
Stus
 = 
ChStus
::
IDLE
;

611 ià(
	gchBKE
->
	gStus
 =ğ
ChStus
::
IDLE
)

612 ià(
chBKE
->
HasSu¥’d
)

613 
_my_š¡ªû
->
£nd_»sume_commªd_to_ch
(
ch
, 
chBKE
);

616 
	gCMD_ERASE_BLOCK
:

617 
CMD_ERASE_BLOCK_MULTIPLANE
:

618 
DEBUG
("Ch " << 
ch
->
ChªÃlID
 << ", " << ch->
ChID
 << ": finishedƒrase command")

619 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
d›BKE
->
AùiveT¿n§ùiÚs
.
begš
();

620 
	g™
 !ğ
d›BKE
->
AùiveT¿n§ùiÚs
.
’d
(); it++)

621 
	g_my_š¡ªû
->
brßdÿ¡T¿n§ùiÚS”viûdSigÇl
(*
™
);

622 
	gd›BKE
->
	gAùiveT¿n§ùiÚs
.
ş—r
();

623 
	gd›BKE
->
CË¬Commªd
();

625 
	gchBKE
->
	gNo_of_aùive_d›s
--;

626 ià(
	gchBKE
->
	gNo_of_aùive_d›s
 =ğ0 && 
chBKE
->
Wa™šgR—dTXCouÁ
 == 0)

627 
chBKE
->
Stus
 = 
ChStus
::
IDLE
;

629 ià(
	gchBKE
->
	gStus
 =ğ
ChStus
::
IDLE
)

630 ià(
chBKE
->
HasSu¥’d
)

631 
_my_š¡ªû
->
£nd_»sume_commªd_to_ch
(
ch
, 
chBKE
);

637 ià(
	g_my_š¡ªû
->
	gchªÃls
[
ch
->
ChªÃlID
]->
G‘Stus
(è=ğ
BusChªÃlStus
::
IDLE
)

638 
_my_š¡ªû
->
brßdÿ¡ChªÃlIdËSigÇl
(
ch
->
ChªÃlID
);

639 ià(
	gchBKE
->
	gStus
 =ğ
ChStus
::
IDLE
)

640 
_my_š¡ªû
->
brßdÿ¡ChIdËSigÇl
(
ch
);

643 
šlše
 
	gNVM_PHY_ONFI_NVDDR2
::
Œªsãr_»ad_d©a_äom_ch
(
ChBookK“pšgEÁry
* 
chBKE
, 
D›BookK“pšgEÁry
* 
d›BKE
, 
NVM_T¿n§ùiÚ_FÏsh
* 
Œ
)

645 
DEBUG
("2.Ch " << 
Œ
->
Add»ss
.
ChªÃlID
 << ", " <<r->Add»ss.
ChID
 << ":¿nsã¸»ad d©¨¡¬‹d fÜ LPA: " <<r->
LPA
)

646 
	gd›BKE
->
	gAùiveT¿nsãr
 = 
Œ
;

647 
	gchªÃls
[
Œ
->
Add»ss
.
ChªÃlID
]->
	gChs
[Œ->Add»ss.
ChID
]->
S¹D©aOutXãr
();

648 
	gchBKE
->
	gStus
 = 
ChStus
::
DATA_OUT
;

649 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
NVDDR2D©aOutT¿nsãrTime
(
Œ
->
D©a_ªd_m‘ad©a_size_š_by‹
, 
chªÃls
[Œ->
Add»ss
.
ChªÃlID
]),

650 
this
, 
d›BKE
, ()
NVDDR2_SimEv’tTy³
::
READ_DATA_TRANSFERRED
);

652 
	gŒ
->
	gSTAT_Œªsãr_time
 +ğ
NVDDR2D©aOutT¿nsãrTime
(
Œ
->
D©a_ªd_m‘ad©a_size_š_by‹
, 
chªÃls
[Œ->
Add»ss
.
ChªÃlID
]);

653 
	gchªÃls
[
Œ
->
Add»ss
.
ChªÃlID
]->
S‘Stus
(
BusChªÃlStus
::
BUSY
, 
chªÃls
[Œ->Add»ss.ChªÃlID]->
Chs
[Œ->Add»ss.
ChID
]);

656 
	gNVM_PHY_ONFI_NVDDR2
::
³rfÜm_š‹¾—ved_cmd_d©a_Œªsãr
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
, 
D›BookK“pšgEÁry
* 
bookK“pšgEÁry
)

658 
ONFI_ChªÃl_NVDDR2
* 
	grg‘_chªÃl
 = 
chªÃls
[
bookK“pšgEÁry
->
AùiveT¿n§ùiÚs
.
äÚt
()->
Add»ss
.
ChªÃlID
];

662 
	gbookK“pšgEÁry
->
	gAùiveT¿n§ùiÚs
.
äÚt
()->
	gTy³
)

664 
	gT¿n§ùiÚ_Ty³
::
READ
:

665 
ch
->
S¹CMDXãr
();

666 
	gbookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
].
	gStus
 = 
ChStus
::
CMD_IN
;

667 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
bookK“pšgEÁry
->
D›IÁ”ËavedTime
 ,

668 
this
 , 
bookK“pšgEÁry
 , ()
NVDDR2_SimEv’tTy³
::
READ_CMD_ADDR_TRANSFERRED
 );

670 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

671 ià(((
NVM_T¿n§ùiÚ_FÏsh_WR
*)
bookK“pšgEÁry
->
AùiveT¿n§ùiÚs
.
äÚt
())->
R–©edR—d
 =ğ
NULL
) {

672 
ch
->
S¹CMDD©aInXãr
();

673 
	gbookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
].
	gStus
 = 
ChStus
::
CMD_DATA_IN
;

674 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
bookK“pšgEÁry
->
D›IÁ”ËavedTime
,

675 
this
, 
bookK“pšgEÁry
, ()
NVDDR2_SimEv’tTy³
::
PROGRAM_CMD_ADDR_DATA_TRANSFERRED
);

677 
	gch
->
S¹CMDXãr
();

678 
	gbookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
].
	gStus
 = 
ChStus
::
CMD_IN
;

679 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
bookK“pšgEÁry
->
D›IÁ”ËavedTime
, 
this
,

680 
bookK“pšgEÁry
, ()
NVDDR2_SimEv’tTy³
::
READ_CMD_ADDR_TRANSFERRED
);

683 
	gT¿n§ùiÚ_Ty³
::
ERASE
:

684 
ch
->
S¹CMDXãr
();

685 
	gbookK“pšgTabË
[
ch
->
ChªÃlID
][ch->
ChID
].
	gStus
 = 
ChStus
::
CMD_IN
;

686 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
bookK“pšgEÁry
->
D›IÁ”ËavedTime
,

687 
this
, 
bookK“pšgEÁry
, ()
NVDDR2_SimEv’tTy³
::
ERASE_SETUP_COMPLETED
);

690 
PRINT_ERROR
("NVMController_NVDDR2: Uknown flashransactionype!")

692 
rg‘_chªÃl
->
S‘Stus
(
BusChªÃlStus
::
BUSY
, 
ch
);

695 
šlše
 
	gNVM_PHY_ONFI_NVDDR2
::
£nd_»sume_commªd_to_ch
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
, 
ChBookK“pšgEÁry
* 
chBKE
)

698 
	gi
 = 0; i < 
	gd›_no_³r_ch
; i++) {

699 
D›BookK“pšgEÁry
 *
	gd›BKE
 = &
chBKE
->
D›_book_k“pšg_»cÜds
[
i
];

701 
	gd›BKE
->
P»·»Resume
();

702 
	gchBKE
->
P»·»Resume
();

703 
	gch
->
Resume
(
d›BKE
->
AùiveCommªd
->
Add»ss
[0].
D›ID
);

704 
	gd›BKE
->
	gAùiveCommªd
->
	gCommªdCode
) {

705 
	gCMD_READ_PAGE
:

706 
CMD_READ_PAGE_MULTIPLANE
:

707 
CMD_READ_PAGE_COPYBACK
:

708 
CMD_READ_PAGE_COPYBACK_MULTIPLANE
:

709 
chBKE
->
Stus
 = 
ChStus
::
READING
;

711 
	gCMD_PROGRAM_PAGE
:

712 
CMD_PROGRAM_PAGE_MULTIPLANE
:

713 
CMD_PROGRAM_PAGE_COPYBACK
:

714 
CMD_PROGRAM_PAGE_COPYBACK_MULTIPLANE
:

715 
chBKE
->
Stus
 = 
ChStus
::
WRITING
;

717 
	gCMD_ERASE_BLOCK
:

718 
CMD_ERASE_BLOCK_MULTIPLANE
:

719 
chBKE
->
Stus
 = 
ChStus
::
ERASING
;

	@src/ssd/NVM_PHY_ONFI_NVDDR2.h

1 #iâdeà
NVM_PHY_ONFI_NVDDR2_H


2 
	#NVM_PHY_ONFI_NVDDR2_H


	)

4 
	~<queue
>

5 
	~<li¡
>

6 
	~"../sim/Sim_Defs.h
"

7 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

8 
	~"../nvm_ch/æash_memÜy/FÏsh_Commªd.h
"

9 
	~"NVM_PHY_ONFI.h
"

10 
	~"ONFI_ChªÃl_NVDDR2.h
"

11 
	~"FÏsh_T¿n§ùiÚ_Queue.h
"

12 
	~"FTL.h
"

14 
Çme¥aû
 
	gSSD_CompÚ’ts


16 
şass
 
	gFTL
;

17 şas 
	cNVDDR2_SimEv’tTy³


19 
	gREAD_DATA_TRANSFERRED
, 
	gREAD_CMD_ADDR_TRANSFERRED
,

20 
	gPROGRAM_CMD_ADDR_DATA_TRANSFERRED
,

21 
	gPROGRAM_COPYBACK_CMD_ADDR_TRANSFERRED
,

22 
	gERASE_SETUP_COMPLETED


25 şas 
	cD›BookK“pšgEÁry


27 
	gpublic
:

28 
NVM
::
FÏshMemÜy
::
FÏsh_Commªd
* 
AùiveCommªd
;

33 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*> 
AùiveT¿n§ùiÚs
;

34 
	gNVM
::
FÏshMemÜy
::
FÏsh_Commªd
* 
Su¥’dedCommªd
;

35 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*> 
Su¥’dedT¿n§ùiÚs
;

36 
NVM_T¿n§ùiÚ_FÏsh
* 
	gAùiveT¿nsãr
;

37 
boŞ
 
	gF»e
;

38 
boŞ
 
	gSu¥’ded
;

39 
sim_time_ty³
 
	gEx³ùed_fšish_time
;

40 
sim_time_ty³
 
	gRemaššgExecTime
;

41 
sim_time_ty³
 
	gD›IÁ”ËavedTime
;

43 
P»·»Su¥’d
()

45 
	gSu¥’dedCommªd
 = 
AùiveCommªd
;

46 
	gRemaššgExecTime
 = 
Ex³ùed_fšish_time
 - 
SimuÏtÜ
->
Time
();

47 
	gSu¥’dedT¿n§ùiÚs
.
š£¹
(
Su¥’dedT¿n§ùiÚs
.
begš
(), 
AùiveT¿n§ùiÚs
.begš(), AùiveT¿n§ùiÚs.
’d
());

48 
	gSu¥’ded
 = 
Œue
;

49 
	gAùiveCommªd
 = 
NULL
;

50 
	gAùiveT¿n§ùiÚs
.
ş—r
();

51 
	gF»e
 = 
Œue
;

54 
P»·»Resume
()

56 
	gAùiveCommªd
 = 
Su¥’dedCommªd
;

57 
	gEx³ùed_fšish_time
 = 
SimuÏtÜ
->
Time
(è+ 
RemaššgExecTime
;

58 
	gAùiveT¿n§ùiÚs
.
š£¹
(
AùiveT¿n§ùiÚs
.
begš
(), 
Su¥’dedT¿n§ùiÚs
.begš(), Su¥’dedT¿n§ùiÚs.
’d
());

59 
	gSu¥’ded
 = 
çl£
;

60 
	gSu¥’dedCommªd
 = 
NULL
;

61 
	gSu¥’dedT¿n§ùiÚs
.
ş—r
();

62 
	gF»e
 = 
çl£
;

65 
CË¬Commªd
()

67 
d–‘e
 
	gAùiveCommªd
;

68 
	gAùiveCommªd
 = 
NULL
;

69 
	gAùiveT¿n§ùiÚs
.
ş—r
();

70 
	gF»e
 = 
Œue
;

74 şas 
	cChBookK“pšgEÁry


76 
	gpublic
:

77 
ChStus
 
Stus
;

78 
D›BookK“pšgEÁry
* 
	gD›_book_k“pšg_»cÜds
;

79 
sim_time_ty³
 
	gEx³ùed_commªd_exec_fšish_time
;

80 
sim_time_ty³
 
	gLa¡_Œªsãr_fšish_time
;

81 
boŞ
 
	gHasSu¥’d
;

82 
	g¡d
::
queue
<
D›BookK“pšgEÁry
*> 
OngošgD›CMDT¿nsãrs
;

83 
	gWa™šgR—dTXCouÁ
;

84 
	gNo_of_aùive_d›s
;

86 
P»·»Su¥’d
(è{ 
	gHasSu¥’d
 = 
Œue
; 
	gNo_of_aùive_d›s
 = 0; }

87 
P»·»Resume
(è{ 
	gHasSu¥’d
 = 
çl£
; }

90 şas 
	cNVM_PHY_ONFI_NVDDR2
 : 
public
 
NVM_PHY_ONFI


92 
public
:

93 
NVM_PHY_ONFI_NVDDR2
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
ONFI_ChªÃl_NVDDR2
** 
chªÃls
,

94 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
);

95 
S‘up_Œigg”s
();

96 
V®id©e_simuÏtiÚ_cÚfig
();

97 
S¹_simuÏtiÚ
();

99 
S’d_commªd_to_ch
(
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>& 
Œª§ùiÚLi¡
);

100 
Chªge_æash_·ge_¡©us_fÜ_´ecÚd™iÚšg
(cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
·ge_add»ss
, cÚ¡ 
LPA_ty³
 
Ía
);

101 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

102 
BusChªÃlStus
 
G‘_chªÃl_¡©us
(
æash_chªÃl_ID_ty³
 
chªÃlID
);

103 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
G‘_ch
(
æash_chªÃl_ID_ty³
 
chªÃl_id
, 
æash_ch_ID_ty³
 
ch_id
);

104 
LPA_ty³
 
G‘_m‘ad©a
(
æash_chªÃl_ID_ty³
 
chªÃ_id
, 
æash_ch_ID_ty³
 
ch_id
, 
æash_d›_ID_ty³
 
d›_id
, 
æash_¶ªe_ID_ty³
 
¶ªe_id
, 
æash_block_ID_ty³
 
block_id
, 
æash_·ge_ID_ty³
 
·ge_id
);

105 
boŞ
 
HasSu¥’dedCommªd
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

106 
ChStus
 
G‘ChStus
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

107 
sim_time_ty³
 
Ex³ùed_fšish_time
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

108 
sim_time_ty³
 
Ex³ùed_fšish_time
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

109 
sim_time_ty³
 
Ex³ùed_Œªsãr_time
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

110 
NVM_T¿n§ùiÚ_FÏsh
* 
Is_ch_busy_w™h_¡»am
(NVM_T¿n§ùiÚ_FÏsh* 
Œª§ùiÚ
);

111 
boŞ
 
Is_ch_busy
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

112 
Chªge_memÜy_¡©us_´ecÚd™iÚšg
(cÚ¡ 
NVM
::
NVM_MemÜy_Add»ss
* 
add»ss
, cÚ¡ * 
¡©us_šfo
);

113 
FTL
* 
	gál
;

117 
	g´iv©e
:

118 
Œªsãr_»ad_d©a_äom_ch
(
ChBookK“pšgEÁry
* 
chBKE
, 
D›BookK“pšgEÁry
* 
d›BKE
, 
NVM_T¿n§ùiÚ_FÏsh
* 
Œ
);

119 
³rfÜm_š‹¾—ved_cmd_d©a_Œªsãr
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
, 
D›BookK“pšgEÁry
* 
bookK“pšgEÁry
);

120 
£nd_»sume_commªd_to_ch
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
, 
ChBookK“pšgEÁry
* 
chBKE
);

121 
hªdË_»ady_sigÇl_äom_ch
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
, NVM::FÏshMemÜy::
FÏsh_Commªd
* 
commªd
);

123 
NVM_PHY_ONFI_NVDDR2
* 
	g_my_š¡ªû
;

124 
ONFI_ChªÃl_NVDDR2
** 
	gchªÃls
;

125 
ChBookK“pšgEÁry
** 
	gbookK“pšgTabË
;

126 
FÏsh_T¿n§ùiÚ_Queue
 *
	gWa™šgR—dTX
, *
	gWa™šgGCR—d_TX
, *
	gWa™šgM­pšgR—d_TX
;

127 
	g¡d
::
li¡
<
D›BookK“pšgEÁry
*> *
Wa™šgCİybackWr™es
;

	@src/ssd/NVM_Transaction.h

1 #iâdeà
NVM_TRANSACTION_H


2 
	#NVM_TRANSACTION_H


	)

4 
	~<io¡»am
>

5 
	~<li¡
>

6 
	~"../sim/Sim_Defs.h
"

7 
	~"../sim/Engše.h
"

8 
	~"U£r_Reque¡.h
"

10 
Çme¥aû
 
	gSSD_CompÚ’ts


12 
şass
 
	gU£r_Reque¡
;

14 şas 
	cT¿n§ùiÚ_Ty³
 { 
	gREAD
, 
	gWRITE
, 
	gERASE
, 
	gUNKOWN
 };

15 şas 
	cT¿n§ùiÚ_Sourû_Ty³
 { 
	gUSERIO
, 
	gCACHE
, 
	gGC_WL
, 
	gMAPPING
 };

17 şas 
	cNVM_T¿n§ùiÚ


19 
	gpublic
:

20 
NVM_T¿n§ùiÚ
(
¡»am_id_ty³
 
¡»am_id
, 
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
T¿n§ùiÚ_Ty³
 
ty³
, 
U£r_Reque¡
* 
u£r_»que¡
) :

21 
SŒ—m_id
(
¡»am_id
), 
Sourû
(
sourû
), 
Ty³
(
ty³
), 
U£rIOReque¡
(
u£r_»que¡
), 
Issue_time
(
SimuÏtÜ
->
Time
()), 
STAT_Œªsãr_time
(
TRANSFER_TIME
) {

22 
	gSŒ—m_id
=0;

23 if(
	gty³
==
T¿n§ùiÚ_Ty³
::
READ
)

25 
STAT_executiÚ_time
=
READ_TIME
;

27 if(
	gty³
==
T¿n§ùiÚ_Ty³
::
WRITE
)

29 
STAT_executiÚ_time
=
WRITE_TIME
;

34 
	gSTAT_executiÚ_time
=
INVALID_TIME
/5;

37 
	gRPG_WR
=
çl£
;

40 
boŞ
 
	gRPG_WR
;

41 
¡»am_id_ty³
 
	gSŒ—m_id
;

42 
T¿n§ùiÚ_Sourû_Ty³
 
	gSourû
;

43 
T¿n§ùiÚ_Ty³
 
	gTy³
;

44 
U£r_Reque¡
* 
	gU£rIOReque¡
;

47 
sim_time_ty³
 
	gIssue_time
;

50 
sim_time_ty³
 
	gSTAT_executiÚ_time
, 
	gSTAT_Œªsãr_time
;

	@src/ssd/NVM_Transaction_Flash.cpp

1 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gNVM_T¿n§ùiÚ_FÏsh
::
NVM_T¿n§ùiÚ_FÏsh
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
T¿n§ùiÚ_Ty³
 
ty³
, 
¡»am_id_ty³
 
¡»am_id
,

7 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, 
U£r_Reque¡
* 
u£r_»que¡
) :

8 
NVM_T¿n§ùiÚ
(
¡»am_id
, 
sourû
, 
ty³
, 
u£r_»que¡
),

9 
D©a_ªd_m‘ad©a_size_š_by‹
(
d©a_size_š_by‹
), 
LPA
(
Ía
), 
PPA
(
µa
), 
Physiÿl_add»ss_d‘”mšed
(
çl£
), 
FLIN_B¬r›r
(
Œue
)

13 
	gNVM_T¿n§ùiÚ_FÏsh
::
NVM_T¿n§ùiÚ_FÏsh
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
T¿n§ùiÚ_Ty³
 
ty³
, 
¡»am_id_ty³
 
¡»am_id
,

14 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
, 
U£r_Reque¡
* 
u£r_»que¡
) :

15 
NVM_T¿n§ùiÚ
(
¡»am_id
, 
sourû
, 
ty³
, 
u£r_»que¡
), 
D©a_ªd_m‘ad©a_size_š_by‹
(
d©a_size_š_by‹
), 
LPA
(
Ía
), 
PPA
(
µa
), 
Add»ss
(
add»ss
), 
Physiÿl_add»ss_d‘”mšed
(
çl£
)

	@src/ssd/NVM_Transaction_Flash.h

1 #iâdeà
NVM_TRANSACTION_FLASH_H


2 
	#NVM_TRANSACTION_FLASH_H


	)

4 
	~<¡ršg
>

5 
	~<li¡
>

6 
	~<c¡dšt
>

7 
	~"../sim/Sim_Defs.h
"

8 
	~"../sim/Sim_Ev’t.h
"

9 
	~"../sim/Engše.h
"

10 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

11 
	~"../nvm_ch/æash_memÜy/FÏsh_Ch.h
"

12 
	~"../nvm_ch/æash_memÜy/Physiÿl_Page_Add»ss.h
"

13 
	~"NVM_T¿n§ùiÚ.h
"

14 
	~"U£r_Reque¡.h
"

16 
Çme¥aû
 
	gSSD_CompÚ’ts


18 
şass
 
	gU£r_Reque¡
;

20 şas 
	cNVM_T¿n§ùiÚ_FÏsh
 : 
public
 
NVM_T¿n§ùiÚ


22 
public
:

23 
NVM_T¿n§ùiÚ_FÏsh
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
T¿n§ùiÚ_Ty³
 
ty³
, 
¡»am_id_ty³
 
¡»am_id
,

24 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, 
U£r_Reque¡
* 
u£r_»que¡
);

25 
NVM_T¿n§ùiÚ_FÏsh
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
T¿n§ùiÚ_Ty³
 
ty³
, 
¡»am_id_ty³
 
¡»am_id
,

26 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
, 
U£r_Reque¡
* 
u£r_»que¡
);

27 
	gNVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
 
Add»ss
;

28 
	gD©a_ªd_m‘ad©a_size_š_by‹
;

30 
LPA_ty³
 
	gLPA
;

31 
PPA_ty³
 
	gPPA
;

33 
boŞ
 
	gSu¥’dRequœed
;

34 
boŞ
 
	gPhysiÿl_add»ss_d‘”mšed
;

35 
sim_time_ty³
 
	gE¡im©ed_®Úe_wa™šg_time
;

36 
boŞ
 
	gFLIN_B¬r›r
;

37 
	g´iv©e
:

	@src/ssd/NVM_Transaction_Flash_ER.cpp

1 
	~"NVM_T¿n§ùiÚ_FÏsh_ER.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gNVM_T¿n§ùiÚ_FÏsh_ER
::
NVM_T¿n§ùiÚ_FÏsh_ER
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»amID
,

7 cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
) :

8 
NVM_T¿n§ùiÚ_FÏsh
(
sourû
, 
T¿n§ùiÚ_Ty³
::
ERASE
, 
¡»amID
, 0, 
NO_LPA
, 
NO_PPA
, 
add»ss
, 
NULL
)

	@src/ssd/NVM_Transaction_Flash_ER.h

1 #iâdeà
NVM_TRANSACTION_FLASH_ER_H


2 
	#NVM_TRANSACTION_FLASH_ER_H


	)

4 
	~<li¡
>

5 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

6 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

7 
	~"NVM_T¿n§ùiÚ_FÏsh_WR.h
"

9 
Çme¥aû
 
	gSSD_CompÚ’ts


11 şas 
	cNVM_T¿n§ùiÚ_FÏsh_ER
 : 
public
 
NVM_T¿n§ùiÚ_FÏsh


13 
public
:

14 
NVM_T¿n§ùiÚ_FÏsh_ER
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»amID
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
);

15 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh_WR
 *> 
Page_movem’t_aùiv™›s
;

	@src/ssd/NVM_Transaction_Flash_RD.cpp

1 
	~"NVM_T¿n§ùiÚ_FÏsh_RD.h
"

2 
	~"../nvm_ch/NVM_Ty³s.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gNVM_T¿n§ùiÚ_FÏsh_RD
::
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

7 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
»Ï‹d_u£r_IO_»que¡
,

8 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
, 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
»Ï‹d_wr™e
, 
·ge_¡©us_ty³
 
»ad_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
) :

9 
NVM_T¿n§ùiÚ_FÏsh
(
sourû
, 
T¿n§ùiÚ_Ty³
::
READ
, 
¡»am_id
, 
d©a_size_š_by‹
, 
Ía
, 
µa
, 
»Ï‹d_u£r_IO_»que¡
),

10 
CÚ‹Á
(
cÚ‹Á
), 
R–©edWr™e
(
»Ï‹d_wr™e
), 
»ad_£ùÜs_b™m­
Ô—d_£ùÜs_b™m­), 
D©aTimeSmp
(
d©a_time¡amp
)

14 
	gNVM_T¿n§ùiÚ_FÏsh_RD
::
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

15 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
,

16 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
»Ï‹d_u£r_IO_»que¡
,

17 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
, 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
»Ï‹d_wr™e
, 
·ge_¡©us_ty³
 
»ad_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
) :

18 
NVM_T¿n§ùiÚ_FÏsh
(
sourû
, 
T¿n§ùiÚ_Ty³
::
READ
, 
¡»am_id
, 
d©a_size_š_by‹
, 
Ía
, 
µa
, 
add»ss
, 
»Ï‹d_u£r_IO_»que¡
),

19 
CÚ‹Á
(
cÚ‹Á
), 
R–©edWr™e
(
»Ï‹d_wr™e
), 
»ad_£ùÜs_b™m­
Ô—d_£ùÜs_b™m­), 
D©aTimeSmp
(
d©a_time¡amp
)

23 
	gNVM_T¿n§ùiÚ_FÏsh_RD
::
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

24 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
»Ï‹d_u£r_IO_»que¡
,

25 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
, 
·ge_¡©us_ty³
 
»ad_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
) :

26 
NVM_T¿n§ùiÚ_FÏsh
(
sourû
, 
T¿n§ùiÚ_Ty³
::
READ
, 
¡»am_id
, 
d©a_size_š_by‹
, 
Ía
, 
µa
, 
»Ï‹d_u£r_IO_»que¡
),

27 
CÚ‹Á
(
cÚ‹Á
), 
R–©edWr™e
(
NULL
), 
»ad_£ùÜs_b™m­
Ô—d_£ùÜs_b™m­), 
D©aTimeSmp
(
d©a_time¡amp
)

	@src/ssd/NVM_Transaction_Flash_RD.h

1 #iâdeà
NVM_TRANSACTION_FLASH_RD_H


2 
	#NVM_TRANSACTION_FLASH_RD_H


	)

4 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

5 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

8 
Çme¥aû
 
	gSSD_CompÚ’ts


10 
şass
 
	gNVM_T¿n§ùiÚ_FÏsh_WR
;

11 şas 
	cNVM_T¿n§ùiÚ_FÏsh_RD
 : 
public
 
NVM_T¿n§ùiÚ_FÏsh


13 
public
:

14 
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

15 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
,

16 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
»Ï‹d_u£r_IO_»que¡
, 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
, 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
»Ï‹d_wr™e
,

17 
·ge_¡©us_ty³
 
»ad_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
);

18 
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

19 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
,

20 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
»Ï‹d_u£r_IO_»que¡
, 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
, 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
»Ï‹d_wr™e
,

21 
·ge_¡©us_ty³
 
»ad_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
);

22 
NVM_T¿n§ùiÚ_FÏsh_RD
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

23 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
,

24 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
»Ï‹d_u£r_IO_»que¡
, 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
,

25 
·ge_¡©us_ty³
 
»ad_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
);

26 
	gNVM
::
memÜy_cÚ‹Á_ty³
 
CÚ‹Á
;

27 
NVM_T¿n§ùiÚ_FÏsh_WR
* 
	gR–©edWr™e
;

28 
·ge_¡©us_ty³
 
	g»ad_£ùÜs_b™m­
;

29 
d©a_time¡amp_ty³
 
	gD©aTimeSmp
;

	@src/ssd/NVM_Transaction_Flash_WR.cpp

1 
	~"NVM_T¿n§ùiÚ_FÏsh_WR.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gNVM_T¿n§ùiÚ_FÏsh_WR
::
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

7 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
u£r_io_»que¡
, NVM::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
,

8 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
»Ï‹d_»ad
, 
·ge_¡©us_ty³
 
wr™‹n_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
) :

9 
NVM_T¿n§ùiÚ_FÏsh
(
sourû
, 
T¿n§ùiÚ_Ty³
::
WRITE
, 
¡»am_id
, 
d©a_size_š_by‹
, 
Ía
, 
µa
, 
add»ss
, 
u£r_io_»que¡
),

10 
CÚ‹Á
(
cÚ‹Á
), 
R–©edR—d
(
»Ï‹d_»ad
), 
wr™e_£ùÜs_b™m­
(
wr™‹n_£ùÜs_b™m­
), 
D©aTimeSmp
(
d©a_time¡amp
),

11 
ExecutiÚMode
(
Wr™eExecutiÚModeTy³
::
SIMPLE
)

15 
NVM_T¿n§ùiÚ_FÏsh_WR
::NVM_T¿n§ùiÚ_FÏsh_WR(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

16 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
u£r_io_»que¡
, 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
,

17 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
»Ï‹d_»ad
, 
·ge_¡©us_ty³
 
wr™‹n_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
) :

18 
NVM_T¿n§ùiÚ_FÏsh
(
sourû
, 
T¿n§ùiÚ_Ty³
::
WRITE
, 
¡»am_id
, 
d©a_size_š_by‹
, 
Ía
, 
µa
, 
u£r_io_»que¡
),

19 
CÚ‹Á
(
cÚ‹Á
), 
R–©edR—d
(
»Ï‹d_»ad
), 
wr™e_£ùÜs_b™m­
(
wr™‹n_£ùÜs_b™m­
), 
D©aTimeSmp
(
d©a_time¡amp
),

20 
ExecutiÚMode
(
Wr™eExecutiÚModeTy³
::
SIMPLE
)

24 
NVM_T¿n§ùiÚ_FÏsh_WR
::NVM_T¿n§ùiÚ_FÏsh_WR(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

25 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
u£r_io_»que¡
, 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
,

26 
·ge_¡©us_ty³
 
wr™‹n_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
) :

27 
NVM_T¿n§ùiÚ_FÏsh
(
sourû
, 
T¿n§ùiÚ_Ty³
::
WRITE
, 
¡»am_id
, 
d©a_size_š_by‹
, 
Ía
, 
NO_PPA
, 
u£r_io_»que¡
),

28 
CÚ‹Á
(
cÚ‹Á
), 
R–©edR—d
(
NULL
), 
wr™e_£ùÜs_b™m­
(
wr™‹n_£ùÜs_b™m­
), 
D©aTimeSmp
(
d©a_time¡amp
),

29 
ExecutiÚMode
(
Wr™eExecutiÚModeTy³
::
SIMPLE
)

	@src/ssd/NVM_Transaction_Flash_WR.h

1 #iâdeà
NVM_TRANSACTION_FLASH_WR


2 
	#NVM_TRANSACTION_FLASH_WR


	)

4 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

5 
	~"../nvm_ch/NVM_Ty³s.h
"

6 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

7 
	~"NVM_T¿n§ùiÚ_FÏsh_RD.h
"

8 
	~"NVM_T¿n§ùiÚ_FÏsh_ER.h
"

10 
Çme¥aû
 
	gSSD_CompÚ’ts


12 
şass
 
	gNVM_T¿n§ùiÚ_FÏsh_ER
;

13 şas 
	cWr™eExecutiÚModeTy³
 { 
	gSIMPLE
, 
	gCOPYBACK
 };

15 şas 
	cNVM_T¿n§ùiÚ_FÏsh_WR
 : 
public
 
NVM_T¿n§ùiÚ_FÏsh


17 
public
:

18 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

19 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
u£r_io_»que¡
, 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
,

20 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
»Ï‹d_»ad
, 
·ge_¡©us_ty³
 
wr™e_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
);

21 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

22 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
PPA_ty³
 
µa
, cÚ¡ 
NVM
::
FÏshMemÜy
::
Physiÿl_Page_Add»ss
& 
add»ss
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
u£r_io_»que¡
, NVM::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
,

23 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
»Ï‹d_»ad
, 
·ge_¡©us_ty³
 
wr™e_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
);

24 
NVM_T¿n§ùiÚ_FÏsh_WR
(
T¿n§ùiÚ_Sourû_Ty³
 
sourû
, 
¡»am_id_ty³
 
¡»am_id
,

25 
d©a_size_š_by‹
, 
LPA_ty³
 
Ía
, 
SSD_CompÚ’ts
::
U£r_Reque¡
* 
u£r_io_»que¡
, 
NVM
::
memÜy_cÚ‹Á_ty³
 
cÚ‹Á
,

26 
·ge_¡©us_ty³
 
wr™e_£ùÜs_b™m­
, 
d©a_time¡amp_ty³
 
d©a_time¡amp
);

27 
	gNVM
::
memÜy_cÚ‹Á_ty³
 
CÚ‹Á
;

28 
NVM_T¿n§ùiÚ_FÏsh_RD
* 
	gR–©edR—d
;

29 
NVM_T¿n§ùiÚ_FÏsh_ER
* 
	gR–©edE¿£
;

30 
·ge_¡©us_ty³
 
	gwr™e_£ùÜs_b™m­
;

31 
d©a_time¡amp_ty³
 
	gD©aTimeSmp
;

32 
Wr™eExecutiÚModeTy³
 
	gExecutiÚMode
;

	@src/ssd/ONFI_Channel_Base.cpp

1 
	~"ONFI_ChªÃl_Ba£.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gONFI_ChªÃl_Ba£
::
ONFI_ChªÃl_Ba£
(
æash_chªÃl_ID_ty³
 
chªÃlID
, 
chCouÁ
, 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
** 
æashChs
, 
ONFI_PrÙocŞ
 
ty³
)

7 : 
ChªÃlID
(
chªÃlID
), 
¡©us
(
BusChªÃlStus
::
IDLE
), 
Chs
(
æashChs
), 
Ty³
(
ty³
)

	@src/ssd/ONFI_Channel_Base.h

1 #iâdeà
ONFI_CHANNEL_BASE_H


2 
	#ONFI_CHANNEL_BASE_H


	)

4 
	~"../nvm_ch/æash_memÜy/FÏsh_Ch.h
"

5 
	~"NVM_ChªÃl_Ba£.h
"

7 
Çme¥aû
 
	gSSD_CompÚ’ts


9 şas 
	cONFI_PrÙocŞ
 {
	gNVDDR2
};

10 şas 
	cONFI_ChªÃl_Ba£
 : 
public
 
NVM_ChªÃl_Ba£


12 
public
:

13 
ONFI_ChªÃl_Ba£
(
æash_chªÃl_ID_ty³
 
chªÃlID
, 
chCouÁ
, 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
** 
æashChs
, 
ONFI_PrÙocŞ
 
ty³
);

14 
æash_chªÃl_ID_ty³
 
	gChªÃlID
;

15 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
** 
Chs
;

16 
ONFI_PrÙocŞ
 
	gTy³
;

18 
BusChªÃlStus
 
G‘Stus
()

20  
	g¡©us
;

23 
S‘Stus
(
BusChªÃlStus
 
Ãw_¡©us
, 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
rg‘_ch
)

25 ià(((
¡©us
 =ğ
BusChªÃlStus
::
IDLE
 && 
Ãw_¡©us
 == BusChannelStatus::IDLE)

26 || (
¡©us
 =ğ
BusChªÃlStus
::
BUSY
 && 
Ãw_¡©us
 == BusChannelStatus::BUSY))

27 && (
cu¼’t_aùive_ch
 !ğ
rg‘_ch
)) {

28 
PRINT_ERROR
("Bu " << 
ChªÃlID
 << ": illegal bus statusransition!")

31 
¡©us
 = 
Ãw_¡©us
;

32 ià(
	g¡©us
 =ğ
BusChªÃlStus
::
BUSY
) {

33 
cu¼’t_aùive_ch
 = 
rg‘_ch
;

35 
	gcu¼’t_aùive_ch
 = 
NULL
;

38 
	g´iv©e
:

39 
BusChªÃlStus
 
¡©us
;

40 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
cu¼’t_aùive_ch
;

	@src/ssd/ONFI_Channel_NVDDR2.cpp

1 
	~"ONFI_ChªÃl_NVDDR2.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
	gONFI_ChªÃl_NVDDR2
::
ONFI_ChªÃl_NVDDR2
(
æash_chªÃl_ID_ty³
 
chªÃlID
, 
chCouÁ
, 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
** 
æashChs
, 
ChªÃlWidth
,

6 
sim_time_ty³
 
t_RC
, sim_time_ty³ 
t_DSC
,

7 
sim_time_ty³
 
t_DBSY
, sim_time_ty³ 
t_CS
, sim_time_ty³ 
t_RR
,

8 
sim_time_ty³
 
t_WB
, sim_time_ty³ 
t_WC
, sim_time_ty³ 
t_ADL
, sim_time_ty³ 
t_CALS
,

9 
sim_time_ty³
 
t_DQSRE
, sim_time_ty³ 
t_RPRE
, sim_time_ty³ 
t_RHW
, sim_time_ty³ 
t_CCS
,

10 
sim_time_ty³
 
t_WPST
, sim_time_ty³ 
t_WPSTH
)

11 : 
ONFI_ChªÃl_Ba£
(
chªÃlID
, 
chCouÁ
, 
æashChs
, 
ONFI_PrÙocŞ
::
NVDDR2
),

12 
ChªÃlWidth
(ChannelWidth),

13 
t_RC
Ñ_RC), 
t_DSC
Ñ_DSC), 
t_DBSY
Ñ_DBSY), 
t_CS
Ñ_CS), 
t_RR
Ñ_RR), 
t_WB
Ñ_WB), 
t_WC
Ñ_WC), 
t_ADL
(t_ADL),

14 
t_CALS
Ñ_CALS), 
t_DQSRE
Ñ_DQSRE), 
t_RPRE
Ñ_RPRE), 
t_RHW
Ñ_RHW), 
t_CCS
Ñ_CCS), 
t_WPST
Ñ_WPST), 
t_WPSTH
(t_WPSTH)

16 
	gR—dCommªdTime
[1] = 
t_CS
 + 
t_WC
 * 6 + 
t_WB
 + 
t_RR
;

17 
	gR—dCommªdTime
[2] = 
t_CS
 + 6 * 
t_WC
 + 
t_DBSY
 + 6 *_WC + 
t_WB
 + 
t_RR
;

18 
	gR—dCommªdTime
[3] = 
t_CS
 + 6 * 
t_WC
 + 
t_DBSY
 + 6 *_WC +_DBSY + 6 *_WC + 
t_WB
 + 
t_RR
;

19 
	gR—dCommªdTime
[4] = 
t_CS
 + 6 * 
t_WC
 + 
t_DBSY
 + 6 *_WC +_DBSY + 6 *_WC +_DBSY + 6 *_WC + 
t_WB
 + 
t_RR
;

20 
	gR—dD©aOutS‘upTime
 = 
t_RPRE
 + 
t_DQSRE
;

21 
	gR—dD©aOutS‘upTime_TwoPÏÃ
 = 
t_RPRE
 + 
t_DQSRE
 + 
t_RHW
 + 6 * 
t_WC
 + 
t_CCS
 +_RPRE +_DQSRE;

22 
	gR—dD©aOutS‘upTime_Th»ePÏÃ
 = 
t_RPRE
 + 
t_DQSRE
 + 
t_RHW
 + 6 * 
t_WC
 + 
t_CCS
 +_RPRE +_DQSRE +_RHW + 6 *_WC +_CCS +_RPRE +_DQSRE;

23 
	gR—dD©aOutS‘upTime_FourPÏÃ
 = 
t_RPRE
 + 
t_DQSRE
 + 
t_RHW
 + 6 * 
t_WC
 + 
t_CCS
 +_RPRE +_DQSRE +_RHW + 6 *_WC +_CCS +_RPRE +_DQSRE +_RHW + 6 *_WC +_CCS +_RPRE +_DQSRE;

24 
	gTwoUn™D©aInTime
 = 
t_RC
;

26 
	gProg¿mCommªdTime
[1] = 
t_CS
 + 
t_WC
 * 6 + 
t_ADL
 + 
t_WPST
 + 
t_WPSTH
 + 
t_WB
;

27 
	gProg¿mCommªdTime
[2] = 
t_CS
 + (
t_WC
 * 5 + 
t_ADL
 + 
t_WPST
 + 
t_CALS
 + 
t_WB
è+ 
t_DBSY
 + (t_WC * 6 +_ADL +_WPST + 
t_WPSTH
 +_WB);

28 
	gProg¿mCommªdTime
[3] = 
t_CS
 + (
t_WC
 * 5 + 
t_ADL
 + 
t_WPST
 + 
t_CALS
 + 
t_WB
è+ 
t_DBSY
 + (t_WC * 5 +_ADL +_WPST +_CALS +_WBè+_DBSY + (t_WC * 6 +_ADL +_WPST + 
t_WPSTH
 +_WB);

29 
	gProg¿mCommªdTime
[4] = 
t_CS
 + (
t_WC
 * 5 + 
t_ADL
 + 
t_WPST
 + 
t_CALS
 + 
t_WB
è+ 
t_DBSY
 + (t_WC * 5 +_ADL +_WPST +_CALS +_WBè+_DBSY + (t_WC * 5 +_ADL +_WPST +_CALS +_WBè+_DBSY + (t_WC * 6 +_ADL +_WPST + 
t_WPSTH
 +_WB);

30 
	gTwoUn™D©aOutTime
 = 
t_DSC
;

31 
	gProg¿mSu¥’dCommªdTime
 = 
t_CS
 + 
t_WC
 * 3;

33 
	gE¿£CommªdTime
[1] = 
t_CS
 + 
t_WC
 * 4 + 
t_WB
;

34 
	gE¿£CommªdTime
[2] = 
t_CS
 + 
t_WC
 * 4 + 
t_WB
 + (
t_DBSY
 +_WC * 4 +_WB);

35 
	gE¿£CommªdTime
[3] = 
t_CS
 + 
t_WC
 * 4 + 
t_WB
 + (
t_DBSY
 +_WC * 4 +_WB) + (t_DBSY +_WC * 4 +_WB);

36 
	gE¿£CommªdTime
[4] = 
t_CS
 + 
t_WC
 * 4 + 
t_WB
 + (
t_DBSY
 +_WC * 4 +_WB) + (t_DBSY +_WC * 4 +_WB) + (t_DBSY +_WC * 4 +_WB);

37 
	gE¿£Su¥’dCommªdTime
 = 
t_CS
 + 
t_WC
 * 3;

	@src/ssd/ONFI_Channel_NVDDR2.h

1 #iâdeà
ONFI_CHANNEL_NVDDR2_H


2 
	#ONFI_CHANNEL_NVDDR2_H


	)

4 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

5 
	~"ONFI_ChªÃl_Ba£.h
"

8 
	#NVDDR2D©aInT¿nsãrTime
(
X
,
Y
è((X / Y->
ChªÃlWidth
 / 2è* Y->
TwoUn™D©aInTime
)

	)

9 
	#NVDDR2D©aOutT¿nsãrTime
(
X
,
Y
è((X / Y->
ChªÃlWidth
 / 2è* Y->
TwoUn™D©aOutTime
)

	)

12 
Çme¥aû
 
	gSSD_CompÚ’ts


14 şas 
	cONFI_ChªÃl_NVDDR2
 : 
public
 
ONFI_ChªÃl_Ba£


16 
public
:

17 
ONFI_ChªÃl_NVDDR2
(
æash_chªÃl_ID_ty³
 
chªÃlID
, 
chCouÁ
, 
NVM
::
FÏshMemÜy
::
FÏsh_Ch
** 
æashChs
, 
ChªÃlWidth
,

18 
sim_time_ty³
 
t_RC
 = 6, sim_time_ty³ 
t_DSC
 = 6,

19 
sim_time_ty³
 
t_DBSY
 = 500, sim_time_ty³ 
t_CS
 = 20, sim_time_ty³ 
t_RR
 = 20,

20 
sim_time_ty³
 
t_WB
 = 100, sim_time_ty³ 
t_WC
 = 25, sim_time_ty³ 
t_ADL
 = 70, sim_time_ty³ 
t_CALS
 = 15,

21 
sim_time_ty³
 
t_DQSRE
 = 15, sim_time_ty³ 
t_RPRE
 = 15, sim_time_ty³ 
t_RHW
 = 100, sim_time_ty³ 
t_CCS
 = 300,

22 
sim_time_ty³
 
t_WPST
 = 6, sim_time_ty³ 
t_WPSTH
 = 15);

25 
sim_time_ty³
 
	gTwoUn™D©aOutTime
;

26 
sim_time_ty³
 
	gR—dCommªdTime
[5];

27 
sim_time_ty³
 
	gR—dD©aOutS‘upTime
, 
	gR—dD©aOutS‘upTime_TwoPÏÃ
, 
	gR—dD©aOutS‘upTime_Th»ePÏÃ
, 
	gR—dD©aOutS‘upTime_FourPÏÃ
;

29 
sim_time_ty³
 
	gTwoUn™D©aInTime
;

30 
sim_time_ty³
 
	gProg¿mCommªdTime
[5];

31 
sim_time_ty³
 
	gProg¿mSu¥’dCommªdTime
;

33 
sim_time_ty³
 
	gE¿£CommªdTime
[5];

34 
sim_time_ty³
 
	gE¿£Su¥’dCommªdTime
;

36 
	gChªÃlWidth
;

37 
	g´iv©e
:

39 
sim_time_ty³
 
t_RC
;

40 
sim_time_ty³
 
	gt_DSC
;

43 
sim_time_ty³
 
	gt_DBSY
;

46 
sim_time_ty³
 
	gt_CS
;

47 
sim_time_ty³
 
	gt_RR
;

48 
sim_time_ty³
 
	gt_WB
;

49 
sim_time_ty³
 
	gt_WC
;

50 
sim_time_ty³
 
	gt_ADL
;

51 
sim_time_ty³
 
	gt_CALS
;

54 
sim_time_ty³
 
	gt_DQSRE
;

55 
sim_time_ty³
 
	gt_RPRE
;

56 
sim_time_ty³
 
	gt_RHW
;

57 
sim_time_ty³
 
	gt_CCS
;

60 
sim_time_ty³
 
	gt_WPST
;

61 
sim_time_ty³
 
	gt_WPSTH
;

	@src/ssd/Parameters.h

1 
	#no_of_groups
 8

	)

2 
	~<deque
>

	@src/ssd/Queue_Probe.cpp

1 
	~<cm©h
>

2 
	~"Queue_Probe.h
"

3 
	~"../sim/Engše.h
"

5 
Çme¥aû
 
	gSSD_CompÚ’ts


7 
	gS‹Sti¡ics
::
S‹Sti¡ics
()

9 
this
->
nEÁ”ªûs
 = 0;

10 
	gthis
->
	gtÙ®Time
 = 0;

13 
	gQueue_Probe
::
Queue_Probe
()

15 
¡©es
.
push_back
(
S‹Sti¡ics
());

16 
	g¡©esEpoch
.
push_back
(
S‹Sti¡ics
());

19 
	gQueue_Probe
::
EnqueueReque¡
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
)

21 ià(
Œª§ùiÚ
 =ğ
NULL
)

22 
PRINT_ERROR
("Inserting‡‚ull objecto queue!")

24 
cu¼’tObjeùsInQueue
[
Œª§ùiÚ
] = 
SimuÏtÜ
->
Time
();

25 
	gnReque¡s
++;

26 
	gnReque¡sEpoch
++;

27 
£tCouÁ
(
couÁ
 + 1);

30 
	gQueue_Probe
::
DequeueReque¡
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
)

32 
nD•¬tu»s
++;

33 
	gnD•¬tu»sEpoch
++;

35 ià(
	gŒª§ùiÚ
 =ğ
NULL
)

36 
throw
 
¡d
::
logic_”rÜ
("Object can‚ot be‚ull if‡ccurateTimingEnabled=ture");

37 
sim_time_ty³
 
	g‘
 = 
cu¼’tObjeùsInQueue
[
Œª§ùiÚ
];

38 
	gcu¼’tObjeùsInQueue
.
”a£
(
Œª§ùiÚ
);

39 
sim_time_ty³
 
	gtc
 = 
SimuÏtÜ
->
Time
(è- 
‘
;

40 
	gtÙ®Wa™šgTime
 +ğ
tc
;

41 ià(
	gtc
 > 
	gmaxWa™šgTime
)

42 
	gmaxWa™šgTime
 = 
tc
;

43 
	gtÙ®Wa™šgTimeEpoch
 +ğ
tc
;

44 
£tCouÁ
(
couÁ
 - 1);

47 
	gQueue_Probe
::
£tCouÁ
(
v®
)

49 
sim_time_ty³
 
n
 = 
SimuÏtÜ
->
Time
();

50 
	g¡©es
[
couÁ
].
	gtÙ®Time
 +ğ
n
 - 
Ï¡CouÁChªge
;

51 
	g¡©esEpoch
[
couÁ
].
	gtÙ®Time
 +ğ
n
 - 
Ï¡CouÁChªge
;

53 
	gÏ¡CouÁChªge
 = 
n
;

54 
	gcouÁ
 = 
v®
;

55 ià(
	gcouÁ
 > 
	gmaxQueueL’gth
) {

56 
	gmaxQueueL’gth
 = 
couÁ
;

58 
	gcouÁ
 + 1 > 
	g¡©es
.
size
()) {

59 
	g¡©es
.
push_back
(
S‹Sti¡ics
());

61 
	g¡©es
[
couÁ
].
	gnEÁ”ªûs
++;

62 
	gcouÁ
 + 1 > 
	g¡©esEpoch
.
size
()) {

63 
	g¡©esEpoch
.
push_back
(
S‹Sti¡ics
());

65 
	g¡©esEpoch
[
couÁ
].
	gnEÁ”ªûs
++;

68 
	gQueue_Probe
::
Re£tEpochSti¡ics
()

70 
nReque¡sEpoch
 = 0;

71 
	gnD•¬tu»sEpoch
 = 0;

72 
	gtÙ®Wa™šgTimeEpoch
 = 0;

73 
	g•ochS¹Time
 = 
SimuÏtÜ
->
Time
();

75 
	gi
 = 0; i < 
	g¡©esEpoch
.
size
(); i++) {

76 
	g¡©esEpoch
[
i
].
	gtÙ®Time
 = 0;

77 
	g¡©esEpoch
[
i
].
	gnEÁ”ªûs
 = 0;

81 
	gQueue_Probe
::
SÇpshÙ
(
¡d
::
¡ršg
 
id
, 
Uts
::
XmlWr™”
& 
wr™”
)

83 
wr™”
.
Wr™e_¡¬t_–em’t_g
(
id
 + "_QueueProbe");

84 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("MaxQueueL’gth", 
¡d
::
to_¡ršg
(
MaxQueueL’gth
()));

85 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("AvgQueueL’gth", 
¡d
::
to_¡ršg
(
AvgQueueL’gth
()));

86 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("MaxWa™šgTime", 
¡d
::
to_¡ršg
(
MaxWa™šgTime
()));

87 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("AvgWa™šgTime", 
¡d
::
to_¡ršg
(
AvgWa™šgTime
()));

88 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("NReque¡s", 
¡d
::
to_¡ršg
(
NReque¡s
()));

89 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("ND•¬tu»s", 
¡d
::
to_¡ršg
(
ND•¬tu»s
()));

90 
	gi
 = 0; i < 
	g¡©es
.
size
(); i++) {

91 
	gwr™”
.
Wr™e_¡¬t_–em’t_g
(
id
 + "_Distribution");

92 
sim_time_ty³
 
	gnow
 = 
SimuÏtÜ
->
Time
();

93 
sim_time_ty³
 
	gt
 = 
¡©es
[
i
].
tÙ®Time
;

94 ià(
	gcouÁ
 =ğ
i
) {

95 
t
 +ğ
now
 - 
Ï¡CouÁChªge
;

97 
	gr
 = ()
t
 / ()(
now
 - 
Ï¡CouÁChªgeReã»nû
);

98 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("QueueL’gth", 
¡d
::
to_¡ršg
(
i
));

99 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("nEÁ”ªûs", 
¡d
::
to_¡ršg
(
¡©es
[
i
].
nEÁ”ªûs
));

100 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("tÙ®Time", 
¡d
::
to_¡ršg
(
t
));

101 
	gwr™”
.
Wr™e_©Œibu‹_¡ršg
("tÙ®TimeR©io", 
¡d
::
to_¡ršg
(
r
));

102 
	gwr™”
.
Wr™e_’d_–em’t_g
();

104 
	gwr™”
.
Wr™e_’d_–em’t_g
();

107 
	gQueue_Probe
::
NReque¡s
()

109  
nReque¡s
;

112 
	gQueue_Probe
::
ND•¬tu»s
()

114  
nD•¬tu»s
;

117 
	gQueue_Probe
::
QueueL’gth
()

119  
couÁ
;

122 
	g¡d
::
veùÜ
<
S‹Sti¡ics
> 
Queue_Probe
::
S‹s
()

124  
¡©es
;

127 
	gQueue_Probe
::
MaxQueueL’gth
()

129  
maxQueueL’gth
;

132 
	gQueue_Probe
::
AvgQueueL’gth
()

134 
sim_time_ty³
 
sum
 = 0;

135 
	gËn
 = 0;†’ < 
	g¡©es
.
size
();†en++)

136 
	gsum
 +ğ
¡©es
[
Ën
].
tÙ®Time
 *†en;

137  ()
	gsum
 / ()
	gSimuÏtÜ
->
Time
();

140 
	gQueue_Probe
::
STDevQueueL’gth
()

142 
sim_time_ty³
 
sum
 = 0;

143 
	gËn
 = 0;†’ < 
	g¡©es
.
size
();†en++) {

144 
	gsum
 +ğ
¡©es
[
Ën
].
tÙ®Time
 *†en;

146 
	gm—n
 = ()
sum
 / ()
SimuÏtÜ
->
Time
();

147 
	g¡dev
 = 0.0;

148 
	gËn
 = 0;†’ < 
	g¡©es
.
size
();†en++) {

149 
	g¡dev
 +ğ
¡d
::
pow
(()
¡©es
[
Ën
].
tÙ®Time
 *†’ / ()
SimuÏtÜ
->
Time
(è- 
m—n
, 2);

152  
	g¡d
::
sq¹
(
¡dev
);

155 
	gQueue_Probe
::
AvgQueueL’gthEpoch
()

157 
sim_time_ty³
 
sum
 = 0;

158 
sim_time_ty³
 
	gsumTime
 = 0;

159 
	gËn
 = 0;†’ < 
	g¡©es
.
size
();†en++) {

160 
	gsum
 +ğ
¡©esEpoch
[
Ën
].
tÙ®Time
 *†en;

161 
	gsumTime
 +ğ
¡©esEpoch
[
Ën
].
tÙ®Time
;

164  ()
	gsum
 / ()(
	gSimuÏtÜ
->
Time
(è- 
	g•ochS¹Time
);

167 
sim_time_ty³
 
	gQueue_Probe
::
MaxWa™šgTime
()

169  
maxWa™šgTime
 / 1000;

172 
sim_time_ty³
 
	gQueue_Probe
::
AvgWa™šgTime
()

174  (
sim_time_ty³
)(()
tÙ®Wa™šgTime
 / ()(
nD•¬tu»s
 * 1000));

177 
sim_time_ty³
 
	gQueue_Probe
::
AvgWa™šgTimeEpoch
()

179  (
sim_time_ty³
)(()
tÙ®Wa™šgTimeEpoch
 / ()(
nD•¬tu»sEpoch
 * 1000));

182 
sim_time_ty³
 
	gQueue_Probe
::
TÙ®Wa™šgTime
()

184  
tÙ®Wa™šgTime
;

	@src/ssd/Queue_Probe.h

1 #iâdeà
QUEUE_PROBE_H


2 
	#QUEUE_PROBE_H


	)

4 
	~<unÜd”ed_m­
>

5 
	~<veùÜ
>

6 
	~<¡ršg
>

7 
	~"../sim/Sim_Defs.h
"

8 
	~"NVM_T¿n§ùiÚ.h
"

9 
	~"../uts/XMLWr™”.h
"

11 
Çme¥aû
 
	gSSD_CompÚ’ts


13 şas 
	cS‹Sti¡ics


15 
	gpublic
:

16 
S‹Sti¡ics
();

17 
	gnEÁ”ªûs
;

18 
sim_time_ty³
 
	gtÙ®Time
;

21 şas 
	cQueue_Probe


23 
	gpublic
:

24 
Queue_Probe
();

25 
EnqueueReque¡
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
);

26 
DequeueReque¡
(
NVM_T¿n§ùiÚ
* 
Œª§ùiÚ
);

27 
Re£tEpochSti¡ics
();

28 
SÇpshÙ
(
¡d
::
¡ršg
 
id
, 
Uts
::
XmlWr™”
& 
wr™”
);

29 
NReque¡s
();

30 
ND•¬tu»s
();

31 
QueueL’gth
();

32 
	g¡d
::
veùÜ
<
S‹Sti¡ics
> 
S‹s
();

33 
MaxQueueL’gth
();

34 
AvgQueueL’gth
();

35 
STDevQueueL’gth
();

36 
AvgQueueL’gthEpoch
();

37 
sim_time_ty³
 
MaxWa™šgTime
();

38 
sim_time_ty³
 
AvgWa™šgTime
();

39 
sim_time_ty³
 
AvgWa™šgTimeEpoch
();

40 
sim_time_ty³
 
TÙ®Wa™šgTime
();

41 
	g´iv©e
:

42 
couÁ
 = 0;

43 
	gnReque¡s
 = 0;

44 
	gnD•¬tu»s
 = 0;

45 
sim_time_ty³
 
	gtÙ®Wa™šgTime
 = 0;

46 
sim_time_ty³
 
	gÏ¡CouÁChªge
 = 0;

47 
sim_time_ty³
 
	gÏ¡CouÁChªgeReã»nû
 = 0;

48 
	gnReque¡sEpoch
 = 0;

49 
	gnD•¬tu»sEpoch
 = 0;

50 
sim_time_ty³
 
	gtÙ®Wa™šgTimeEpoch
 = 0;

51 
sim_time_ty³
 
	g•ochS¹Time
;

52 
	g¡d
::
veùÜ
<
S‹Sti¡ics
> 
¡©es
;

53 
	g¡d
::
veùÜ
<
S‹Sti¡ics
> 
¡©esEpoch
;

54 
	g¡d
::
unÜd”ed_m­
<
NVM_T¿n§ùiÚ
*, 
	gsim_time_ty³
> 
	gcu¼’tObjeùsInQueue
;

55 
	gmaxQueueL’gth
 = 0;

56 
sim_time_ty³
 
	gmaxWa™šgTime
 = 0;

57 
£tCouÁ
(
v®
);

	@src/ssd/SSD_Defs.h

1 #iâdeà
SSD_DEFS_H


2 
	#SSD_DEFS_H


	)

4 
	~<c¡dšt
>

5 
	~<¡ršg
>

6 
	~"../sim/Sim_Defs.h
"

7 
	~"../nvm_ch/æash_memÜy/FÏshTy³s.h
"

11 
ušt32_t
 
	tho¡_poš‹r_ty³
;

12 
ušt64_t
 
	tLHA_ty³
;

13 
ušt64_t
 
	tPDA_ty³
;

14 
	g¡d
::
	t¡ršg
 
	tio_»que¡_id_ty³
;

15 
ušt64_t
 
	td©a_ÿche_cÚ‹Á_ty³
;

16 
	#SECTOR_SIZE_IN_BYTE
 512

	)

17 
	#MAX_SUPPORT_STREAMS
 256

18 

	)

27 
	#LPN_TO_UNIQUE_KEY
(
STREAM
,
LPN
è((((
LPA_ty³
)STREAM)<<56)|LPN)

	)

28 
	#UNIQUE_KEY_TO_LPN
(
STREAM
,
LPN
è((~(((
LPA_ty³
)STREAM)<<56))&LPN)

	)

31 
šlše
 
	$couÁ_£ùÜ_no_äom_¡©us_b™m­
(cÚ¡ 
·ge_¡©us_ty³
 
·ge_¡©us
)

33 
size
 = 0;

34 
i
 = 0; i < 64; i++) {

35 ià((((
·ge_¡©us_ty³
)1è<< 
i
è& 
·ge_¡©us
) {

36 
size
++;

40  
size
;

41 
	}
}

	@src/ssd/Stats.cpp

1 
	~"Sts.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gSts
::
IssuedR—dCMD
 = 0;

7 
	gSts
::
IssuedCİybackR—dCMD
 = 0;

8 
	gSts
::
IssuedIÁ”ËaveR—dCMD
 = 0;

9 
	gSts
::
IssuedMuÉÏÃR—dCMD
 = 0;

10 
	gSts
::
IssuedMuÉÏÃCİybackR—dCMD
 = 0;

11 
	gSts
::
IssuedProg¿mCMD
 = 0;

12 
	gSts
::
IssuedIÁ”ËaveProg¿mCMD
 = 0;

13 
	gSts
::
IssuedMuÉÏÃProg¿mCMD
 = 0;

14 
	gSts
::
IssuedMuÉÏÃCİybackProg¿mCMD
 = 0;

15 
	gSts
::
IssuedIÁ”ËaveMuÉÏÃProg¿mCMD
 = 0;

16 
	gSts
::
IssuedSu¥’dProg¿mCMD
 = 0;

17 
	gSts
::
IssuedCİybackProg¿mCMD
 = 0;

18 
	gSts
::
IssuedE¿£CMD
 = 0;

19 
	gSts
::
IssuedIÁ”ËaveE¿£CMD
 = 0;

20 
	gSts
::
IssuedMuÉÏÃE¿£CMD
 = 0;

21 
	gSts
::
IssuedIÁ”ËaveMuÉÏÃE¿£CMD
 = 0;

22 
	gSts
::
IssuedSu¥’dE¿£CMD
 = 0;

23 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg
 = 0;

24 
	gSts
::
TÙ®_æash_wr™es_fÜ_m­pšg
 = 0;

25 
	gSts
::
TÙ®_æash_»ads_fÜ_m­pšg_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 };

26 
	gSts
::
TÙ®_æash_wr™es_fÜ_m­pšg_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 };

27 ***** 
	gSts
::
Block_”a£_hi¡og¿m
;

28 
	gSts
::
CMT_h™s
 = 0, Sts::
»adTR_CMT_h™s
 = 0, Sts::
wr™eTR_CMT_h™s
 = 0;

29 
	gSts
::
CMT_miss
 = 0, Sts::
»adTR_CMT_miss
 = 0, Sts::
wr™eTR_CMT_miss
 = 0;

30 
	gSts
::
tÙ®_CMT_qu”›s
 = 0, Sts::
tÙ®_»adTR_CMT_qu”›s
 = 0, Sts::
tÙ®_wr™eTR_CMT_qu”›s
 = 0;

32 
	gSts
::
TÙ®_gc_executiÚs
 = 0, Sts::
TÙ®_gc_executiÚs_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 };

33 
	gSts
::
TÙ®_·ge_movem’ts_fÜ_gc
 = 0, Sts::
TÙ®_gc_·ge_movem’ts_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 };

35 
	gSts
::
TÙ®_wl_executiÚs
 = 0, Sts::
TÙ®_wl_executiÚs_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 };

36 
	gSts
::
TÙ®_·ge_movem’ts_fÜ_wl
 = 0, Sts::
TÙ®_wl_·ge_movem’ts_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 };

38 
	gSts
::
CMT_h™s_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 }, Sts::
»adTR_CMT_h™s_³r_¡»am
[MAX_SUPPORT_STREAMS] = { 0 }, Sts::
wr™eTR_CMT_h™s_³r_¡»am
[MAX_SUPPORT_STREAMS] = { 0 };

39 
	gSts
::
CMT_miss_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 }, Sts::
»adTR_CMT_miss_³r_¡»am
[MAX_SUPPORT_STREAMS] = { 0 }, Sts::
wr™eTR_CMT_miss_³r_¡»am
[MAX_SUPPORT_STREAMS] = { 0 };

40 
	gSts
::
tÙ®_CMT_qu”›s_³r_¡»am
[
MAX_SUPPORT_STREAMS
] = { 0 }, Sts::
tÙ®_»adTR_CMT_qu”›s_³r_¡»am
[MAX_SUPPORT_STREAMS] = { 0 }, Sts::
tÙ®_wr™eTR_CMT_qu”›s_³r_¡»am
[MAX_SUPPORT_STREAMS] = { 0 };

43 
	gSts
::
In™_¡©s
(
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

44 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
max_®lowed_block_”a£_couÁ
)

46 
	gBlock_”a£_hi¡og¿m
 = 
Ãw
 ****[
chªÃl_no
];

47 
	gchªÃl_úŒ
 = 0; chªÃl_úŒ < 
	gchªÃl_no
; channel_cntr++) {

48 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
] = 
Ãw
 ***[
ch_no_³r_chªÃl
];

49 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

50 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
] = 
Ãw
 **[
d›_no_³r_ch
];

51 
	gd›_úŒ
 = 0; d›_úŒ < 
	gd›_no_³r_ch
; die_cntr++) {

52 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
] = 
Ãw
 *[
¶ªe_no_³r_d›
];

53 
	g¶ªe_úŒ
 = 0;…ÏÃ_úŒ < 
	g¶ªe_no_³r_d›
;…lane_cntr++) {

54 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
][
¶ªe_úŒ
] = 
Ãw
 [
max_®lowed_block_”a£_couÁ
];

55 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
][
¶ªe_úŒ
][0] = 
block_no_³r_¶ªe
 * 
·ge_no_³r_block
;

56 
	gi
 = 1; i < 
	gmax_®lowed_block_”a£_couÁ
; ++i) {

57 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
][
¶ªe_úŒ
][
i
] = 0;

64 
	gIssuedR—dCMD
 = 0; 
	gIssuedCİybackR—dCMD
 = 0; 
	gIssuedIÁ”ËaveR—dCMD
 = 0; 
	gIssuedMuÉÏÃR—dCMD
 = 0; 
	gIssuedMuÉÏÃCİybackR—dCMD
 = 0;

65 
	gIssuedProg¿mCMD
 = 0; 
	gIssuedIÁ”ËaveProg¿mCMD
 = 0; 
	gIssuedMuÉÏÃProg¿mCMD
 = 0; 
	gIssuedMuÉÏÃCİybackProg¿mCMD
 = 0; 
	gIssuedIÁ”ËaveMuÉÏÃProg¿mCMD
 = 0; 
	gIssuedSu¥’dProg¿mCMD
 = 0; 
	gIssuedCİybackProg¿mCMD
 = 0;

66 
	gIssuedE¿£CMD
 = 0; 
	gIssuedIÁ”ËaveE¿£CMD
 = 0; 
	gIssuedMuÉÏÃE¿£CMD
 = 0; 
	gIssuedIÁ”ËaveMuÉÏÃE¿£CMD
 = 0;

67 
	gIssuedSu¥’dE¿£CMD
 = 0;

68 
	gTÙ®_æash_»ads_fÜ_m­pšg
 = 0; 
	gTÙ®_æash_wr™es_fÜ_m­pšg
 = 0;

69 
	gCMT_h™s
 = 0; 
	g»adTR_CMT_h™s
 = 0; 
	gwr™eTR_CMT_h™s
 = 0;

70 
	gCMT_miss
 = 0; 
	g»adTR_CMT_miss
 = 0; 
	gwr™eTR_CMT_miss
 = 0;

71 
	gtÙ®_CMT_qu”›s
 = 0; 
	gtÙ®_»adTR_CMT_qu”›s
 = 0; 
	gtÙ®_wr™eTR_CMT_qu”›s
 = 0;

73 
	gTÙ®_gc_executiÚs
 = 0; 
	gTÙ®_·ge_movem’ts_fÜ_gc
 = 0;

74 
	gTÙ®_wl_executiÚs
 = 0; 
	gTÙ®_·ge_movem’ts_fÜ_wl
 = 0;

76 
¡»am_id_ty³
 
	g¡»am_id
 = 0; sŒ—m_id < 
	gMAX_SUPPORT_STREAMS
; stream_id++) {

77 
	gTÙ®_æash_»ads_fÜ_m­pšg_³r_¡»am
[
¡»am_id
] = 0;

78 
	gTÙ®_æash_wr™es_fÜ_m­pšg_³r_¡»am
[
¡»am_id
] = 0;

79 
	gCMT_h™s_³r_¡»am
[
¡»am_id
] = 0; 
	g»adTR_CMT_h™s_³r_¡»am
[¡»am_id] = 0; 
	gwr™eTR_CMT_h™s_³r_¡»am
[stream_id] = 0;

80 
	gCMT_miss_³r_¡»am
[
¡»am_id
] = 0; 
	g»adTR_CMT_miss_³r_¡»am
[¡»am_id] = 0; 
	gwr™eTR_CMT_miss_³r_¡»am
[stream_id] = 0;

81 
	gtÙ®_CMT_qu”›s_³r_¡»am
[
¡»am_id
] = 0; 
	gtÙ®_»adTR_CMT_qu”›s_³r_¡»am
[¡»am_id] = 0; 
	gtÙ®_wr™eTR_CMT_qu”›s_³r_¡»am
[stream_id] = 0;

82 
	gTÙ®_gc_executiÚs_³r_¡»am
[
¡»am_id
] = 0;

83 
	gTÙ®_gc_·ge_movem’ts_³r_¡»am
[
¡»am_id
] = 0;

84 
	gTÙ®_wl_executiÚs_³r_¡»am
[
¡»am_id
] = 0;

85 
	gTÙ®_wl_·ge_movem’ts_³r_¡»am
[
¡»am_id
] = 0;

89 
	gSts
::
CË¬_¡©s
(
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

90 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
max_®lowed_block_”a£_couÁ
)

92 
	gchªÃl_úŒ
 = 0; chªÃl_úŒ < 
	gchªÃl_no
; channel_cntr++) {

93 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

94 
	gd›_úŒ
 = 0; d›_úŒ < 
	gd›_no_³r_ch
; die_cntr++) {

95 
	g¶ªe_úŒ
 = 0;…ÏÃ_úŒ < 
	g¶ªe_no_³r_d›
;…lane_cntr++) {

96 
	gd–‘e
[] 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
][
¶ªe_úŒ
];

98 
	gd–‘e
[] 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
][
d›_úŒ
];

100 
	gd–‘e
[] 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
][
ch_úŒ
];

102 
	gd–‘e
[] 
	gBlock_”a£_hi¡og¿m
[
chªÃl_úŒ
];

104 
	gd–‘e
[] 
	gBlock_”a£_hi¡og¿m
;

	@src/ssd/Stats.h

1 #iâdeà
STATS_H


2 
	#STATS_H


	)

4 
	~"SSD_Defs.h
"

6 
Çme¥aû
 
	gSSD_CompÚ’ts


8 şas 
	cSts


10 
	gpublic
:

11 
In™_¡©s
(
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
, 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
max_®lowed_block_”a£_couÁ
);

12 
CË¬_¡©s
(
chªÃl_no
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
, 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
max_®lowed_block_”a£_couÁ
);

13 
	gIssuedR—dCMD
, 
	gIssuedCİybackR—dCMD
, 
	gIssuedIÁ”ËaveR—dCMD
, 
	gIssuedMuÉÏÃR—dCMD
, 
	gIssuedMuÉÏÃCİybackR—dCMD
;

14 
	gIssuedProg¿mCMD
, 
	gIssuedIÁ”ËaveProg¿mCMD
, 
	gIssuedMuÉÏÃProg¿mCMD
, 
	gIssuedIÁ”ËaveMuÉÏÃProg¿mCMD
, 
	gIssuedCİybackProg¿mCMD
, 
	gIssuedMuÉÏÃCİybackProg¿mCMD
;

15 
	gIssuedE¿£CMD
, 
	gIssuedIÁ”ËaveE¿£CMD
, 
	gIssuedMuÉÏÃE¿£CMD
, 
	gIssuedIÁ”ËaveMuÉÏÃE¿£CMD
;

17 
	gIssuedSu¥’dProg¿mCMD
, 
	gIssuedSu¥’dE¿£CMD
;

19 
	gTÙ®_æash_»ads_fÜ_m­pšg
, 
	gTÙ®_æash_wr™es_fÜ_m­pšg
;

20 
	gTÙ®_æash_»ads_fÜ_m­pšg_³r_¡»am
[
MAX_SUPPORT_STREAMS
], 
	gTÙ®_æash_wr™es_fÜ_m­pšg_³r_¡»am
[MAX_SUPPORT_STREAMS];

22 
	gCMT_h™s
, 
	g»adTR_CMT_h™s
, 
	gwr™eTR_CMT_h™s
;

23 
	gCMT_miss
, 
	g»adTR_CMT_miss
, 
	gwr™eTR_CMT_miss
;

24 
	gtÙ®_CMT_qu”›s
, 
	gtÙ®_»adTR_CMT_qu”›s
, 
	gtÙ®_wr™eTR_CMT_qu”›s
;

26 
	gCMT_h™s_³r_¡»am
[
MAX_SUPPORT_STREAMS
], 
	g»adTR_CMT_h™s_³r_¡»am
[MAX_SUPPORT_STREAMS], 
	gwr™eTR_CMT_h™s_³r_¡»am
[MAX_SUPPORT_STREAMS];

27 
	gCMT_miss_³r_¡»am
[
MAX_SUPPORT_STREAMS
], 
	g»adTR_CMT_miss_³r_¡»am
[MAX_SUPPORT_STREAMS], 
	gwr™eTR_CMT_miss_³r_¡»am
[MAX_SUPPORT_STREAMS];

28 
	gtÙ®_CMT_qu”›s_³r_¡»am
[
MAX_SUPPORT_STREAMS
], 
	gtÙ®_»adTR_CMT_qu”›s_³r_¡»am
[MAX_SUPPORT_STREAMS], 
	gtÙ®_wr™eTR_CMT_qu”›s_³r_¡»am
[MAX_SUPPORT_STREAMS];

31 
	gTÙ®_gc_executiÚs
, 
	gTÙ®_gc_executiÚs_³r_¡»am
[
MAX_SUPPORT_STREAMS
];

32 
	gTÙ®_·ge_movem’ts_fÜ_gc
, 
	gTÙ®_gc_·ge_movem’ts_³r_¡»am
[
MAX_SUPPORT_STREAMS
];

34 
	gTÙ®_wl_executiÚs
, 
	gTÙ®_wl_executiÚs_³r_¡»am
[
MAX_SUPPORT_STREAMS
];

35 
	gTÙ®_·ge_movem’ts_fÜ_wl
, 
	gTÙ®_wl_·ge_movem’ts_³r_¡»am
[
MAX_SUPPORT_STREAMS
];

37 ***** 
	gBlock_”a£_hi¡og¿m
;

	@src/ssd/TSU_Base.cpp

1 
	~<¡ršg
>

2 
	~"TSU_Ba£.h
"

4 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
TSU_Ba£
* 
	gTSU_Ba£
::
_my_š¡ªû
 = 
NULL
;

8 
	gTSU_Ba£
::
TSU_Ba£
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI_NVDDR2
* 
NVMCÚŒŞËr
, 
FÏsh_Schedulšg_Ty³
 
Ty³
,

9 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
,

10 
boŞ
 
E¿£Su¥’siÚEÇbËd
, boŞ 
Prog¿mSu¥’siÚEÇbËd
,

11 
sim_time_ty³
 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
,

12 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
,

13 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
)

14 : 
Sim_Objeù
(
id
), 
ál
(ál), 
_NVMCÚŒŞËr
(
NVMCÚŒŞËr
), 
ty³
(
Ty³
),

15 
chªÃl_couÁ
(
ChªÃlCouÁ
), 
ch_no_³r_chªÃl
(ch_no_³r_chªÃl), 
d›_no_³r_ch
(
D›NoP”Ch
), 
¶ªe_no_³r_d›
(
PÏÃNoP”D›
),

16 
”a£Su¥’siÚEÇbËd
(
E¿£Su¥’siÚEÇbËd
), 
´og¿mSu¥’siÚEÇbËd
(
Prog¿mSu¥’siÚEÇbËd
),

17 
wr™eR—sÚabËSu¥’siÚTimeFÜR—d
(
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
), 
”a£R—sÚabËSu¥’siÚTimeFÜR—d
(
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
),

18 
”a£R—sÚabËSu¥’siÚTimeFÜWr™e
(
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
), 
İ’ed_schedulšg_»qs
(0)

20 
	g_my_š¡ªû
 = 
this
;

21 
	gRound_robš_tuº_of_chªÃl
 = 
Ãw
 
æash_ch_ID_ty³
[
chªÃl_couÁ
];

22 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

23 
	gRound_robš_tuº_of_chªÃl
[
chªÃlID
] = 0;

27 
	gTSU_Ba£
::~
TSU_Ba£
()

29 
d–‘e
[] 
Round_robš_tuº_of_chªÃl
;

32 
	gTSU_Ba£
::
S‘up_Œigg”s
()

34 
Sim_Objeù
::
S‘up_Œigg”s
();

35 
	g_NVMCÚŒŞËr
->
CÚÃùToT¿n§ùiÚS”viûdSigÇl
(
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
);

36 
	g_NVMCÚŒŞËr
->
CÚÃùToChªÃlIdËSigÇl
(
hªdË_chªÃl_idË_sigÇl
);

37 
	g_NVMCÚŒŞËr
->
CÚÃùToChIdËSigÇl
(
hªdË_ch_idË_sigÇl
);

40 
	gTSU_Ba£
::
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

45 
TSU_Ba£
::
hªdË_chªÃl_idË_sigÇl
(
æash_chªÃl_ID_ty³
 
chªÃlID
)

47 
i
 = 0; 
	gi
 < 
	g_my_š¡ªû
->
	gch_no_³r_chªÃl
; i++) {

48 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
 = 
_my_š¡ªû
->
_NVMCÚŒŞËr
->
G‘_ch
(
chªÃlID
, _my_š¡ªû->
Round_robš_tuº_of_chªÃl
[channelID]);

50 ià(!
	g_my_š¡ªû
->
£rviû_»ad_Œª§ùiÚ
(
ch
)) {

51 ià(!
	g_my_š¡ªû
->
£rviû_wr™e_Œª§ùiÚ
(
ch
)) {

52 
	g_my_š¡ªû
->
£rviû_”a£_Œª§ùiÚ
(
ch
);

55 
	g_my_š¡ªû
->
	gRound_robš_tuº_of_chªÃl
[
chªÃlID
] = (
æash_ch_ID_ty³
)(
_my_š¡ªû
->
Round_robš_tuº_of_chªÃl
[chªÃlID] + 1è% _my_š¡ªû->
ch_no_³r_chªÃl
;

58 ià(
	g_my_š¡ªû
->
	g_NVMCÚŒŞËr
->
G‘_chªÃl_¡©us
(
ch
->
ChªÃlID
è=ğ
BusChªÃlStus
::
BUSY
) {

64 
	gTSU_Ba£
::
hªdË_ch_idË_sigÇl
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

66 ià(
_my_š¡ªû
->
_NVMCÚŒŞËr
->
G‘_chªÃl_¡©us
(
ch
->
ChªÃlID
è=ğ
BusChªÃlStus
::
IDLE
) {

67 ià(!
_my_š¡ªû
->
£rviû_»ad_Œª§ùiÚ
(
ch
)) {

68 ià(!
_my_š¡ªû
->
£rviû_wr™e_Œª§ùiÚ
(
ch
)) {

69 
_my_š¡ªû
->
£rviû_”a£_Œª§ùiÚ
(
ch
);

75 
	gTSU_Ba£
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

	@src/ssd/TSU_Base.h

1 #iâdeà
TSU_H


2 
	#TSU_H


	)

3 
	~<io¡»am
>

4 
	~<li¡
>

5 
	~"../sim/Sim_Defs.h
"

6 
	~"../sim/Sim_Objeù.h
"

7 
	~"../nvm_ch/æash_memÜy/FÏsh_Ch.h
"

8 
	~"../sim/Sim_R•Ü‹r.h
"

9 
	~"FTL.h
"

10 
	~"NVM_PHY_ONFI_NVDDR2.h
"

11 
	~"FÏsh_T¿n§ùiÚ_Queue.h
"

13 
Çme¥aû
 
	gSSD_CompÚ’ts


15 şas 
	cFÏsh_Schedulšg_Ty³


17 
	gOUT_OF_ORDER
,

18 
	gPRIORITY_OUT_OF_ORDER
,

19 
	gFLIN


21 
şass
 
	gFTL
;

22 
şass
 
	gNVM_PHY_ONFI_NVDDR2
;

23 şas 
	cTSU_Ba£
 : 
public
 
MQSimEngše
::
Sim_Objeù


25 
public
:

26 
TSU_Ba£
(cÚ¡ 
sim_objeù_id_ty³
 &
id
, 
FTL
 *
ál
, 
NVM_PHY_ONFI_NVDDR2
 *
NVMCÚŒŞËr
, 
FÏsh_Schedulšg_Ty³
 
Ty³
,

27 
ChªÃl_no
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
,

28 
boŞ
 
E¿£Su¥’siÚEÇbËd
, boŞ 
Prog¿mSu¥’siÚEÇbËd
,

29 
sim_time_ty³
 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
,

30 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
,

31 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
);

32 
	gvœtu®
 ~
TSU_Ba£
();

33 
S‘up_Œigg”s
();

48 
P»·»_fÜ_Œª§ùiÚ_subm™
()

50 
	gİ’ed_schedulšg_»qs
++;

51 ià(
	gİ’ed_schedulšg_»qs
 > 1)

55 
	gŒª§ùiÚ_»ûive_¦Ùs
.
ş—r
();

58 
Subm™_Œª§ùiÚ
(
NVM_T¿n§ùiÚ_FÏsh
 *
Œª§ùiÚ
)

60 
	gŒª§ùiÚ_»ûive_¦Ùs
.
push_back
(
Œª§ùiÚ
);

66 
vœtu®
 
ScheduË
() = 0;

67 
vœtu®
 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
 &
xmlwr™”
);

69 
	g´Ùeùed
:

70 
FTL
 *
ál
;

71 
NVM_PHY_ONFI_NVDDR2
 *
	g_NVMCÚŒŞËr
;

72 
FÏsh_Schedulšg_Ty³
 
	gty³
;

73 
	gchªÃl_couÁ
;

74 
	gch_no_³r_chªÃl
;

75 
	gd›_no_³r_ch
;

76 
	g¶ªe_no_³r_d›
;

77 
boŞ
 
	g”a£Su¥’siÚEÇbËd
, 
	g´og¿mSu¥’siÚEÇbËd
;

78 
sim_time_ty³
 
	gwr™eR—sÚabËSu¥’siÚTimeFÜR—d
;

79 
sim_time_ty³
 
	g”a£R—sÚabËSu¥’siÚTimeFÜR—d
;

80 
sim_time_ty³
 
	g”a£R—sÚabËSu¥’siÚTimeFÜWr™e
;

81 
æash_ch_ID_ty³
 *
	gRound_robš_tuº_of_chªÃl
;

83 
TSU_Ba£
 *
	g_my_š¡ªû
;

84 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
 *> 
Œª§ùiÚ_»ûive_¦Ùs
;

85 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
 *> 
Œª§ùiÚ_di¥©ch_¦Ùs
;

86 
vœtu®
 
boŞ
 
£rviû_»ad_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
 *
ch
) = 0;

87 
vœtu®
 
boŞ
 
£rviû_wr™e_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
 *
ch
) = 0;

88 
vœtu®
 
boŞ
 
£rviû_”a£_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
 *
ch
) = 0;

89 
boŞ
 
issue_commªd_to_ch
(
FÏsh_T¿n§ùiÚ_Queue
 *
sourûQueue1
, FÏsh_T¿n§ùiÚ_Queu*
sourûQueue2
, 
T¿n§ùiÚ_Ty³
 
Œª§ùiÚTy³
, boŞ 
su¥’siÚRequœed
);

90 
hªdË_Œª§ùiÚ_£rviûd_sigÇl_äom_PHY
(
NVM_T¿n§ùiÚ_FÏsh
 *
Œª§ùiÚ
);

91 
hªdË_chªÃl_idË_sigÇl
(
æash_chªÃl_ID_ty³
);

92 
hªdË_ch_idË_sigÇl
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
 *
ch
);

93 
	gİ’ed_schedulšg_»qs
;

94 
´oûss_ch_»que¡s
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

96 ià(!
_my_š¡ªû
->
£rviû_»ad_Œª§ùiÚ
(
ch
)) {

97 ià(!
_my_š¡ªû
->
£rviû_wr™e_Œª§ùiÚ
(
ch
)) {

98 
_my_š¡ªû
->
£rviû_”a£_Œª§ùiÚ
(
ch
);

103 
	g´iv©e
:

104 
boŞ
 
Œª§ùiÚ_is_»ady
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

106 
Œª§ùiÚ
->
Ty³
)

108 
T¿n§ùiÚ_Ty³
::
READ
:

109  
Œue
;

110 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

111  
¡©ic_ÿ¡
<
NVM_T¿n§ùiÚ_FÏsh_WR
*>(
Œª§ùiÚ
)->
R–©edR—d
 =ğ
NULL
;

112 
	gT¿n§ùiÚ_Ty³
::
ERASE
:

113  
¡©ic_ÿ¡
<
NVM_T¿n§ùiÚ_FÏsh_ER
*>(
Œª§ùiÚ
)->
Page_movem’t_aùiv™›s
.
size
() == 0;

115  
Œue
;

	@src/ssd/TSU_FLIN.cpp

1 
	~"TSU_FLIN.h
"

2 
	~"NVM_PHY_ONFI_NVDDR2.h
"

3 
	~<¡ack
>

4 
	~<cm©h
>

5 
Çme¥aû
 
	gSSD_CompÚ’ts


8 
	gTSU_FLIN
::
TSU_FLIN
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI_NVDDR2
* 
NVMCÚŒŞËr
,

9 cÚ¡ 
chªÃl_couÁ
, cÚ¡ 
ch_no_³r_chªÃl
, cÚ¡ 
d›_no_³r_ch
, cÚ¡ 
¶ªe_no_³r_d›
, 
æash_·ge_size
,

10 cÚ¡ 
sim_time_ty³
 
æow_şassifiÿtiÚ_•och
, cÚ¡ 
®pha_»ad
, cÚ¡ 
®pha_wr™e
,

11 cÚ¡ 
no_of_´iÜ™y_şas£s
, cÚ¡ 
¡»am_id_ty³
 
max_æow_id
, cÚ¡ * 
¡»am_couÁ_³r_´iÜ™y_şass
, sŒ—m_id_ty³** 
¡»am_ids_³r_´iÜ™y_şass
, cÚ¡ 
f_thr
,

12 cÚ¡ 
sim_time_ty³
 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
,

13 cÚ¡ 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
,

14 cÚ¡ 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
,

15 cÚ¡ 
boŞ
 
E¿£Su¥’siÚEÇbËd
, cÚ¡ boŞ 
Prog¿mSu¥’siÚEÇbËd
)

16 : 
TSU_Ba£
(
id
, 
ál
, 
NVMCÚŒŞËr
, 
FÏsh_Schedulšg_Ty³
::
OUT_OF_ORDER
, 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

17 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
, 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
, 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
,

18 
E¿£Su¥’siÚEÇbËd
, 
Prog¿mSu¥’siÚEÇbËd
),

19 
æow_şassifiÿtiÚ_•och
(flow_classification_epoch),

20 
no_of_´iÜ™y_şas£s
Òo_of_´iÜ™y_şas£s), 
F_thr
(
f_thr
)

22 
	g®pha_»ad_fÜ_•och
 = 
®pha_»ad
 / (
chªÃl_couÁ
 * 
ch_no_³r_chªÃl
è/ 
æash_·ge_size
;

23 
	g®pha_wr™e_fÜ_•och
 = 
®pha_wr™e
 / (
chªÃl_couÁ
 * 
ch_no_³r_chªÃl
è/ 
æash_·ge_size
,

24 
	gthis
->
	g¡»am_couÁ_³r_´iÜ™y_şass
 = 
Ãw
 [
no_of_´iÜ™y_şas£s
];

25 
	gthis
->
	g¡»am_ids_³r_´iÜ™y_şass
 = 
Ãw
 
¡»am_id_ty³
*[
no_of_´iÜ™y_şas£s
];

26 
	gi
 = 0; i < 
	gno_of_´iÜ™y_şas£s
; i++)

28 
	gthis
->
	g¡»am_couÁ_³r_´iÜ™y_şass
[
i
] = 
¡»am_couÁ_³r_´iÜ™y_şass
[i];

29 
	gthis
->
	g¡»am_ids_³r_´iÜ™y_şass
[
i
] = 
Ãw
 
¡»am_id_ty³
[
¡»am_couÁ_³r_´iÜ™y_şass
[i]];

30 
¡»am_id_ty³
 
	g¡»am_úŒ
 = 0; sŒ—m_úŒ < 
	g¡»am_couÁ_³r_´iÜ™y_şass
[
i
]; stream_cntr++)

31 
	gthis
->
	g¡»am_ids_³r_´iÜ™y_şass
[
i
][
¡»am_úŒ
] = 
¡»am_ids_³r_´iÜ™y_şass
[i][stream_cntr];

33 
	gU£rR—dTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
**[
chªÃl_couÁ
];

34 
	gR—d_¦Ù
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_RD
***[
chªÃl_couÁ
];

35 
	gU£rWr™eTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
**[
chªÃl_couÁ
];

36 
	gWr™e_¦Ù
 = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
***[
chªÃl_couÁ
];

37 
	gGCR—dTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

38 
	gGCWr™eTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

39 
	gGCE¿£TRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

40 
	gM­pšgR—dTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

41 
	gM­pšgWr™eTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

42 
	gæow_aùiv™y_šfo
 = 
Ãw
 
FLIN_Flow_MÚ™Üšg_Un™
***[
chªÃl_couÁ
];

43 
	glow_š‹ns™y_şass_»ad
 = 
Ãw
 
¡d
::
£t
<
¡»am_id_ty³
>**[
chªÃl_couÁ
];

44 
	glow_š‹ns™y_şass_wr™e
 = 
Ãw
 
¡d
::
£t
<
¡»am_id_ty³
>**[
chªÃl_couÁ
];

45 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++)

47 
	gU£rR—dTRQueue
[
chªÃl_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
ch_no_³r_chªÃl
];

48 
	gR—d_¦Ù
[
chªÃl_id
] = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_RD
**[
ch_no_³r_chªÃl
];

49 
	gU£rWr™eTRQueue
[
chªÃl_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
ch_no_³r_chªÃl
];

50 
	gWr™e_¦Ù
[
chªÃl_id
] = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
**[
ch_no_³r_chªÃl
];

51 
	gGCR—dTRQueue
[
chªÃl_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

52 
	gGCWr™eTRQueue
[
chªÃl_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

53 
	gGCE¿£TRQueue
[
chªÃl_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

54 
	gM­pšgR—dTRQueue
[
chªÃl_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

55 
	gM­pšgWr™eTRQueue
[
chªÃl_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

56 
	gæow_aùiv™y_šfo
[
chªÃl_id
] = 
Ãw
 
FLIN_Flow_MÚ™Üšg_Un™
**[
ch_no_³r_chªÃl
];

57 
	glow_š‹ns™y_şass_»ad
[
chªÃl_id
] = 
Ãw
 
¡d
::
£t
<
¡»am_id_ty³
>*[
ch_no_³r_chªÃl
];

58 
	glow_š‹ns™y_şass_wr™e
[
chªÃl_id
] = 
Ãw
 
¡d
::
£t
<
¡»am_id_ty³
>*[
ch_no_³r_chªÃl
];

60 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++)

62 
	gU£rR—dTRQueue
[
chªÃl_id
][
ch_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
no_of_´iÜ™y_şas£s
];

63 
	gR—d_¦Ù
[
chªÃl_id
][
ch_id
] = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_RD
*[
no_of_´iÜ™y_şas£s
];

64 
	gU£rWr™eTRQueue
[
chªÃl_id
][
ch_id
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
no_of_´iÜ™y_şas£s
];

65 
	gWr™e_¦Ù
[
chªÃl_id
][
ch_id
] = 
Ãw
 
NVM_T¿n§ùiÚ_FÏsh_WR
*[
no_of_´iÜ™y_şas£s
];

66 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
] = 
Ãw
 
FLIN_Flow_MÚ™Üšg_Un™
*[
no_of_´iÜ™y_şas£s
];

67 
	glow_š‹ns™y_şass_»ad
[
chªÃl_id
][
ch_id
] = 
Ãw
 
¡d
::
£t
<
¡»am_id_ty³
>[
no_of_´iÜ™y_şas£s
];

68 
	glow_š‹ns™y_şass_wr™e
[
chªÃl_id
][
ch_id
] = 
Ãw
 
¡d
::
£t
<
¡»am_id_ty³
>[
no_of_´iÜ™y_şas£s
];

70 
	gGCR—dTRQueue
[
chªÃl_id
][
ch_id
].
S‘_id
("GC_R—d_TR_Queue@" + 
¡d
::
to_¡ršg
(channel_id) + "@" + std::to_string(chip_id) + "@");

71 
	gM­pšgR—dTRQueue
[
chªÃl_id
][
ch_id
].
S‘_id
("M­pšg_R—d_TR_Queue@" + 
¡d
::
to_¡ršg
(channel_id) + "@" + std::to_string(chip_id));

72 
	gM­pšgWr™eTRQueue
[
chªÃl_id
][
ch_id
].
S‘_id
("M­pšg_Wr™e_TR_Queue@" + 
¡d
::
to_¡ršg
(channel_id) + "@" + std::to_string(chip_id));

73 
	gGCWr™eTRQueue
[
chªÃl_id
][
ch_id
].
S‘_id
("GC_Wr™e_TR_Queue@" + 
¡d
::
to_¡ršg
(channel_id) + "@" + std::to_string(chip_id));

74 
	gGCE¿£TRQueue
[
chªÃl_id
][
ch_id
].
S‘_id
("GC_E¿£_TR_Queue@" + 
¡d
::
to_¡ršg
(channel_id) + "@" + std::to_string(chip_id));

75 
	gpşass_id
 = 0;…şass_id < 
	gno_of_´iÜ™y_şas£s
;…class_id++)

77 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
] = 
Ãw
 
FLIN_Flow_MÚ™Üšg_Un™
[
max_æow_id
];

78 
	g¡»am_úŒ
 = 0; sŒ—m_úŒ < 
	gmax_æow_id
; stream_cntr++)

80 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gS”viûd_»ad_»que¡s_hi¡Üy
 = 0;

81 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gS”viûd_»ad_»que¡s_»ûÁ
 = 0;

82 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gS”viûd_wr™e_»que¡s_hi¡Üy
 = 0;

83 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gS”viûd_wr™e_»que¡s_»ûÁ
 = 0;

85 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gS”viûd_»ad_»que¡s_tÙ®
 = 0;

86 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gS”viûd_wr™e_»que¡s_tÙ®
 = 0;

87 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gSum_»ad_¦owdown
 = 0;

88 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_úŒ
].
	gSum_wr™e_¦owdown
 = 0;

90 
	gU£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
pşass_id
].
S‘_id
("U£r_R—d_TR_Queue@" + 
¡d
::
to_¡ršg
(channel_id) + "@" + std::to_string(chip_id) + "@" + std::to_string(pclass_id));

91 
	gU£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
pşass_id
].
S‘_id
("U£r_Wr™e_TR_Queue@" + 
¡d
::
to_¡ršg
(channel_id) + "@" + std::to_string(chip_id) + "@" + std::to_string(pclass_id));

96 
š™Ÿlize_schedulšg_tuºs
();

99 
	gTSU_FLIN
::~
TSU_FLIN
()

101 
d–‘e
[] 
this
->
¡»am_couÁ_³r_´iÜ™y_şass
;

102 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++)

104 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++)

106 
	gd–‘e
[] 
	gU£rR—dTRQueue
[
chªÃl_id
][
ch_id
];

107 
	gd–‘e
[] 
	gR—d_¦Ù
[
chªÃl_id
][
ch_id
];

108 
	gd–‘e
[] 
	gU£rWr™eTRQueue
[
chªÃl_id
][
ch_id
];

109 
	gd–‘e
[] 
	gWr™e_¦Ù
[
chªÃl_id
][
ch_id
];

110 
	gd–‘e
[] 
	glow_š‹ns™y_şass_»ad
[
chªÃl_id
][
ch_id
];

111 
	gd–‘e
[] 
	glow_š‹ns™y_şass_wr™e
[
chªÃl_id
][
ch_id
];

113 
	gd–‘e
[] 
	gU£rR—dTRQueue
[
chªÃl_id
];

114 
	gd–‘e
[] 
	gR—d_¦Ù
[
chªÃl_id
];

115 
	gd–‘e
[] 
	gU£rWr™eTRQueue
[
chªÃl_id
];

116 
	gd–‘e
[] 
	gWr™e_¦Ù
[
chªÃl_id
];

117 
	gd–‘e
[] 
	gGCR—dTRQueue
[
chªÃl_id
];

118 
	gd–‘e
[] 
	gGCWr™eTRQueue
[
chªÃl_id
];

119 
	gd–‘e
[] 
	gGCE¿£TRQueue
[
chªÃl_id
];

120 
	gd–‘e
[] 
	gM­pšgR—dTRQueue
[
chªÃl_id
];

121 
	gd–‘e
[] 
	gM­pšgWr™eTRQueue
[
chªÃl_id
];

122 
	gd–‘e
[] 
	glow_š‹ns™y_şass_»ad
[
chªÃl_id
];

123 
	gd–‘e
[] 
	glow_š‹ns™y_şass_wr™e
[
chªÃl_id
];

125 
	gd–‘e
[] 
	gU£rR—dTRQueue
;

126 
	gd–‘e
[] 
	gR—d_¦Ù
;

127 
	gd–‘e
[] 
	gU£rWr™eTRQueue
;

128 
	gd–‘e
[] 
	gWr™e_¦Ù
;

129 
	gd–‘e
[] 
	gGCR—dTRQueue
;

130 
	gd–‘e
[] 
	gGCWr™eTRQueue
;

131 
	gd–‘e
[] 
	gGCE¿£TRQueue
;

132 
	gd–‘e
[] 
	gM­pšgR—dTRQueue
;

133 
	gd–‘e
[] 
	gM­pšgWr™eTRQueue
;

134 
	gd–‘e
[] 
	glow_š‹ns™y_şass_»ad
;

135 
	gd–‘e
[] 
	glow_š‹ns™y_şass_wr™e
;

138 
	gTSU_FLIN
::
S¹_simuÏtiÚ
()

140 
SimuÏtÜ
->
Regi¡”_sim_ev’t
(
æow_şassifiÿtiÚ_•och
, 
this
, 0, 0);

143 
	gTSU_FLIN
::
V®id©e_simuÏtiÚ_cÚfig
() {}

145 
TSU_FLIN
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

148 
chªÃl_id
 = 0; 
	gchªÃl_id
 < 
	gchªÃl_couÁ
; channel_id++)

150 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++)

152 
	gpşass_id
 = 0;…şass_id < 
	gno_of_´iÜ™y_şas£s
;…class_id++)

154 ià(
	g¡»am_couÁ_³r_´iÜ™y_şass
[
pşass_id
] < 2)

157 
	glow_š‹ns™y_şass_»ad
[
chªÃl_id
][
ch_id
][
pşass_id
].
ş—r
();

158 
	glow_š‹ns™y_şass_wr™e
[
chªÃl_id
][
ch_id
][
pşass_id
].
ş—r
();

159 
	g¡»am_úŒ
 = 0; sŒ—m_úŒ < 
	g¡»am_couÁ_³r_´iÜ™y_şass
[
pşass_id
]; stream_cntr++)

161 ià(
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]].
	gS”viûd_»ad_»que¡s_»ûÁ
 < 
	g®pha_»ad_fÜ_•och
)

162 
	glow_š‹ns™y_şass_»ad
[
chªÃl_id
][
ch_id
][
pşass_id
].
š£¹
(
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]);

163 ià(
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]].
	gS”viûd_wr™e_»que¡s_»ûÁ
 < 
	g®pha_wr™e_fÜ_•och
)

164 
	glow_š‹ns™y_şass_wr™e
[
chªÃl_id
][
ch_id
][
pşass_id
].
š£¹
(
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]);

165 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]].
	gS”viûd_»ad_»que¡s_hi¡Üy
 +ğ
æow_aùiv™y_šfo
[chªÃl_id][ch_id][pşass_id][¡»am_úŒ].
S”viûd_»ad_»que¡s_»ûÁ
;

166 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]].
	gS”viûd_»ad_»que¡s_»ûÁ
 = 0;

167 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]].
	gS”viûd_wr™e_»que¡s_hi¡Üy
 +ğ
æow_aùiv™y_šfo
[chªÃl_id][ch_id][pşass_id][¡»am_úŒ].
S”viûd_wr™e_»que¡s_»ûÁ
;

168 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
pşass_id
][
¡»am_ids_³r_´iÜ™y_şass
[pşass_id][
¡»am_úŒ
]].
	gS”viûd_wr™e_»que¡s_»ûÁ
 = 0;

173 
	gSimuÏtÜ
->
Regi¡”_sim_ev’t
(
SimuÏtÜ
->
Time
(è+ 
æow_şassifiÿtiÚ_•och
, 
this
, 0, 0);

176 
šlše
 
	gTSU_FLIN
::
P»·»_fÜ_Œª§ùiÚ_subm™
()

178 
İ’ed_schedulšg_»qs
++;

179 ià(
	gİ’ed_schedulšg_»qs
 > 1)

181 
	gŒª§ùiÚ_»ûive_¦Ùs
.
ş—r
();

184 
šlše
 
	gTSU_FLIN
::
Subm™_Œª§ùiÚ
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

186 
Œª§ùiÚ_»ûive_¦Ùs
.
push_back
(
Œª§ùiÚ
);

189 
	gTSU_FLIN
::
ScheduË
()

191 
İ’ed_schedulšg_»qs
--;

192 ià(
	gİ’ed_schedulšg_»qs
 > 0)

194 ià(
	gİ’ed_schedulšg_»qs
 < 0)

195 
PRINT_ERROR
("TSU Schedule function is invoked in‡n incorrect way!");

197 ià(
	gŒª§ùiÚ_»ûive_¦Ùs
.
size
() == 0)

201 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
Œª§ùiÚ_»ûive_¦Ùs
.
begš
();

202 
	g™
 !ğ
Œª§ùiÚ_»ûive_¦Ùs
.
’d
(); it++)

204 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = (*
™
)->
Add»ss
.
ChªÃlID
;

205 
æash_ch_ID_ty³
 
	gch_id
 = (*
™
)->
Add»ss
.
ChID
;

206 
	g´iÜ™y_şass
 = (()(*
™
)->
U£rIOReque¡
->
PriÜ™y_şass
) - 1;

207 
¡»am_id_ty³
 
	g¡»am_id
 = (*
™
)->
SŒ—m_id
;

208 (*
	g™
)->
	gTy³
)

210 
	gT¿n§ùiÚ_Ty³
::
READ
:

211 (*
™
)->
Sourû
)

213 
T¿n§ùiÚ_Sourû_Ty³
::
CACHE
:

214 
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
:

215 ià(
¡»am_couÁ_³r_´iÜ™y_şass
[
´iÜ™y_şass
] < 2)

217 
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
push_back
(*
™
);

220 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
][
¡»am_id
].
	gS”viûd_»ad_»que¡s_»ûÁ
++;

221 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
][
¡»am_id
].
	gS”viûd_»ad_»que¡s_tÙ®
++;

222 ià(
	glow_š‹ns™y_şass_»ad
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
fšd
(
¡»am_id
è=ğ
low_š‹ns™y_şass_»ad
[chªÃl_id][ch_id][´iÜ™y_şass].
’d
())

224 
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
push_back
(*
™
);

225 autØ
	g
 = 
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
’d
();

226 
	g
--;

227 
e¡im©e_®Úe_wa™šg_time
(&
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
], 

);

228 
¡»am_id_ty³
 
	gæow_w™h_max_av”age_¦owdown
;

229 
	gf
 = 
çœÃss_ba£d_Ú_av”age_¦owdown
(
chªÃl_id
, 
ch_id
, 
´iÜ™y_şass
, 
Œue
, 
æow_w™h_max_av”age_¦owdown
);

230 ià(
	gf
 < 
	gF_thr
 && 
	g¡»am_id
 =ğ
æow_w™h_max_av”age_¦owdown
)

231 
move_fÜw¬d
(&
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
],

232 

,

233 
h—d_high_»ad
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
]);

234 
»Üd”_fÜ_çœÃss
(&
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
],

235 
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
begš
(),

236 
h—d_high_»ad
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
]);

240 
	gU£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
š£¹
(
h—d_high_»ad
[chªÃl_id][ch_id][´iÜ™y_şass], *
™
);

241 autØ
	g_low
 = 
h—d_high_»ad
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
];

242 
	g_low
--;

243 
e¡im©e_®Úe_wa™šg_time
(&
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
], 
_low
);

244 
»Üd”_fÜ_çœÃss
(&
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
],

245 
U£rR—dTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
begš
(), 
_low
);

248 
	gT¿n§ùiÚ_Sourû_Ty³
::
MAPPING
:

249 
M­pšgR—dTRQueue
[
chªÃl_id
][
ch_id
].
push_back
(*
™
);

251 
	gT¿n§ùiÚ_Sourû_Ty³
::
GC_WL
:

252 
GCR—dTRQueue
[
chªÃl_id
][
ch_id
].
push_back
(*
™
);

255 
PRINT_ERROR
("TSU_OutOfOrder: Unhandled sourceype four„eadransaction!")

258 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

259 (*
™
)->
Sourû
)

261 
T¿n§ùiÚ_Sourû_Ty³
::
CACHE
:

262 
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
:

263 ià(
¡»am_couÁ_³r_´iÜ™y_şass
[
´iÜ™y_şass
] < 2)

265 
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
push_back
(*
™
);

268 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
][
¡»am_id
].
	gS”viûd_wr™e_»que¡s_»ûÁ
++;

269 
	gæow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
][
¡»am_id
].
	gS”viûd_wr™e_»que¡s_tÙ®
++;

270 ià(
	glow_š‹ns™y_şass_wr™e
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
fšd
(
¡»am_id
è=ğ
low_š‹ns™y_şass_wr™e
[chªÃl_id][ch_id][´iÜ™y_şass].
’d
())

272 
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
push_back
(*
™
);

273 autØ
	g
 = 
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
’d
();

274 
	g
--;

275 
e¡im©e_®Úe_wa™šg_time
(&
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
], 

);

276 
¡»am_id_ty³
 
	gæow_w™h_max_av”age_¦owdown
;

277 
	gf
 = 
çœÃss_ba£d_Ú_av”age_¦owdown
(
chªÃl_id
, 
ch_id
, 
´iÜ™y_şass
, 
çl£
, 
æow_w™h_max_av”age_¦owdown
);

278 ià(
	gf
 < 
	gF_thr
 && 
	g¡»am_id
 =ğ
æow_w™h_max_av”age_¦owdown
)

279 
move_fÜw¬d
(&
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
],

280 

,

281 
h—d_high_wr™e
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
]);

282 
»Üd”_fÜ_çœÃss
(&
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
],

283 
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
begš
(),

284 
h—d_high_wr™e
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
]);

288 
	gU£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
š£¹
(
h—d_high_wr™e
[chªÃl_id][ch_id][´iÜ™y_şass], *
™
);

289 autØ
	g_low
 = 
h—d_high_wr™e
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
];

290 
	g_low
--;

291 
e¡im©e_®Úe_wa™šg_time
(&
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
], 
_low
);

292 
»Üd”_fÜ_çœÃss
(&
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
],

293 
U£rWr™eTRQueue
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
].
begš
(), 
_low
);

296 
	gT¿n§ùiÚ_Sourû_Ty³
::
MAPPING
:

297 
M­pšgWr™eTRQueue
[
chªÃl_id
][
ch_id
].
push_back
(*
™
);

299 
	gT¿n§ùiÚ_Sourû_Ty³
::
GC_WL
:

300 
GCWr™eTRQueue
[
chªÃl_id
][
ch_id
].
push_back
(*
™
);

303 
PRINT_ERROR
("TSU_OutOfOrder: Unhandled sourceype four writeransaction!")

306 
	gT¿n§ùiÚ_Ty³
::
ERASE
:

307 
GCE¿£TRQueue
[
chªÃl_id
][
ch_id
].
push_back
(*
™
);

315 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++)

317 ià(
	g_NVMCÚŒŞËr
->
G‘_chªÃl_¡©us
(
chªÃl_id
è=ğ
BusChªÃlStus
::
IDLE
)

319 
i
 = 0; 
	gi
 < 
	gch_no_³r_chªÃl
; i++) {

320 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
 = 
_NVMCÚŒŞËr
->
G‘_ch
(
chªÃl_id
, 
Round_robš_tuº_of_chªÃl
[channel_id]);

322 ià(!
£rviû_»ad_Œª§ùiÚ
(
ch
))

323 ià(!
£rviû_wr™e_Œª§ùiÚ
(
ch
))

324 
£rviû_”a£_Œª§ùiÚ
(
ch
);

325 
	gRound_robš_tuº_of_chªÃl
[
chªÃl_id
] = (
æash_ch_ID_ty³
)(
Round_robš_tuº_of_chªÃl
[chªÃl_id] + 1è% 
ch_no_³r_chªÃl
;

326 ià(
	g_NVMCÚŒŞËr
->
G‘_chªÃl_¡©us
(
ch
->
ChªÃlID
è!ğ
BusChªÃlStus
::
IDLE
)

333 
	gTSU_FLIN
::
»Üd”_fÜ_çœÃss
(
FÏsh_T¿n§ùiÚ_Queue
* 
queue
, 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
¡¬t
, std::li¡<NVM_T¿n§ùiÚ_FÏsh*>::™”©Ü 
’d
)

335 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™r
 = 
queue
->
begš
();

336 
sim_time_ty³
 
	gtime_to_fšish
 = 0;

337 if(
	g_NVMCÚŒŞËr
->
Is_ch_busy
(*
™r
))

338 ià(
	g_NVMCÚŒŞËr
->
Ex³ùed_fšish_time
(*
™r
è> 
	gSimuÏtÜ
->
Time
())

339 
	gtime_to_fšish
 = 
_NVMCÚŒŞËr
->
Ex³ùed_fšish_time
(*
™r
è- 
SimuÏtÜ
->
Time
();

341 
	g¡d
::
veùÜ
<
sim_time_ty³
> 
T_wa™_sh¬ed_li¡
;

342 
	g™r
 !ğ
¡¬t
)

344 
time_to_fšish
 +ğ
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
™r
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*itr);

345 
	g™r
++;

349 
	g¡d
::
¡ack
<> 
mš_¦owdown_li¡
, 
	gmax_¦owdown_li¡
;

350 
	g¦owdown_mš
 = 10000000000000000000, 
	g¦owdown_max
 = 0;

351 
	g™r
 !ğ
¡d
::
Ãxt
(
’d
))

353 
mš_¦owdown_li¡
.
push
(
¦owdown_mš
);

354 
	gmax_¦owdown_li¡
.
push
(
¦owdown_max
);

356 
	gtime_to_fšish
 +ğ
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
™r
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*itr);

357 
sim_time_ty³
 
	gT_TR_sh¬ed
 = 
time_to_fšish
 + (
SimuÏtÜ
->
Time
(è- (*
™r
)->
Issue_time
);

358 
	gT_wa™_sh¬ed_li¡
.
push_back
(
T_TR_sh¬ed
);

359 
	g¦owdown
 = ()
T_TR_sh¬ed
 / ()(*
™r
)->
E¡im©ed_®Úe_wa™šg_time
;

360 ià(
	g¦owdown
 < 
	g¦owdown_mš
)

361 
	g¦owdown_mš
 = 
¦owdown
;

362 ià(
	g¦owdown
 > 
	g¦owdown_max
)

363 
	g¦owdown_max
 = 
¦owdown
;

364 
	g™r
++;

366 
	gçœÃss_max
 = 
¦owdown_mš
 / 
¦owdown_max
;

371 
sim_time_ty³
 
	gT_Ãw_®Úe
 = (*
’d
)->
E¡im©ed_®Úe_wa™šg_time
;

372 
sim_time_ty³
 
	gT_Ãw_sh¬ed_befÜe
 = 
time_to_fšish
;

374 autØ
	gfš®_pos™iÚ
 = 
’d
;

375 autØ
	gŒav”£r
 = 
’d
;

376 
	gtime_to_fšish
 -ğ
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
’d
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*end);

377 
	g¦owdown_mš_»v”£
 = 10000000000000000000, 
	g¦owdown_max_»v”£
 = 0;

379 
	gŒav”£r
 !ğ
¡d
::
´ev
(
¡¬t
è&& (*
Œav”£r
)->
SŒ—m_id
 =ğ(*
’d
)->Stream_id)

381 
sim_time_ty³
 
T_pos_®Úe
 = (*
Œav”£r
)->
E¡im©ed_®Úe_wa™šg_time
;

382 
sim_time_ty³
 
	gT_pos_sh¬ed_befÜe
 = 
time_to_fšish
;

383 
	g¦owdown_pos_befÜe
 = ()
T_pos_sh¬ed_befÜe
 / 
T_pos_®Úe
;

385 
sim_time_ty³
 
	gT_pos_sh¬ed_aá”
 = 
time_to_fšish
 + 
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
’d
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*end);

386 
	g¦owdown_pos_aá”
 = ()
T_pos_sh¬ed_aá”
 / 
T_pos_®Úe
;

388 
sim_time_ty³
 
	gT_Ãw_sh¬ed_aá”
 = 
time_to_fšish
 - 
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
Œav”£r
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*traverser);

389 
	g¦owdown_Ãw_aá”
 = ()
T_Ãw_sh¬ed_aá”
 / 
T_Ãw_®Úe
;

391 
	g¦owdown_mš
 = 
mš_¦owdown_li¡
.
tİ
();

392 
	gmš_¦owdown_li¡
.
pİ
();

393 
	g¦owdown_max
 = 
max_¦owdown_li¡
.
tİ
();

394 
	gmax_¦owdown_li¡
.
tİ
();

395 ià(
	g¦owdown_pos_aá”
 > 
	g¦owdown_max
)

396 
	g¦owdown_max
 = 
¦owdown_pos_aá”
;

397 ià(
	g¦owdown_pos_aá”
 < 
	g¦owdown_mš
)

398 
	g¦owdown_mš
 = 
¦owdown_pos_aá”
;

400 ià(
	g¦owdown_pos_aá”
 > 
	g¦owdown_max_»v”£
)

401 
	g¦owdown_max_»v”£
 = 
¦owdown_pos_aá”
;

402 ià(
	g¦owdown_pos_aá”
 < 
	g¦owdown_mš_»v”£
)

403 
	g¦owdown_mš_»v”£
 = 
¦owdown_pos_aá”
;

405 ià(
	g¦owdown_Ãw_aá”
 > 
	g¦owdown_max_»v”£
)

406 
	g¦owdown_max_»v”£
 = 
¦owdown_Ãw_aá”
;

407 ià(
	g¦owdown_Ãw_aá”
 < 
	g¦owdown_mš_»v”£
)

408 
	g¦owdown_mš_»v”£
 = 
¦owdown_Ãw_aá”
;

410 
	gçœÃss_aá”
 = ()
¦owdown_mš
 / 
¦owdown_max
;

411 ià(
	gçœÃss_aá”
 > 
	gçœÃss_max
)

413 
	gçœÃss_max
 = 
çœÃss_aá”
;

414 
	gfš®_pos™iÚ
 = 
Œav”£r
;

417 ià(
	g¦owdown_pos_aá”
 > 
	g¦owdown_max_»v”£
)

418 
	g¦owdown_max_»v”£
 = 
¦owdown_pos_aá”
;

419 ià(
	g¦owdown_pos_aá”
 < 
	g¦owdown_mš_»v”£
)

420 
	g¦owdown_mš_»v”£
 = 
¦owdown_pos_aá”
;

422 
	gtime_to_fšish
 -ğ
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
Œav”£r
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*traverser);

423 
	gŒav”£r
--;

425 
	g¡d
::
cout
<<"Slowdown:"<<
¦owdown_max
<<
¡d
::
’dl
;

426 
	g¡d
::
cout
<<"FaœÃss:"<<
çœÃss_max
<<
¡d
::
’dl
;

428 ià(
	gfš®_pos™iÚ
 !ğ
’d
)

430 
NVM_T¿n§ùiÚ_FÏsh
* 
Œ
 = *
’d
;

431 
	gqueue
->
»move
(
’d
);

432 
	gqueue
->
š£¹
(
fš®_pos™iÚ
, 
Œ
);

436 
	gTSU_FLIN
::
e¡im©e_®Úe_wa™šg_time
(
FÏsh_T¿n§ùiÚ_Queue
* 
queue
, 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
pos™iÚ
)

438 autØ
™r
 = 
pos™iÚ
;

439 
	g™r
++;

440 
	g™r
 !ğ
queue
->
begš
())

442 ià((*
™r
)->
SŒ—m_id
 =ğ(*
pos™iÚ
)->Stream_id)

444 
	g™r
++;

447 ià(
	g™r
 =ğ
queue
->
begš
(è&& (*
™r
)->
SŒ—m_id
 !ğ(*
pos™iÚ
)->Stream_id)

449 
NVM_T¿n§ùiÚ_FÏsh
* 
ch_Œ
 = 
_NVMCÚŒŞËr
->
Is_ch_busy_w™h_¡»am
(*
pos™iÚ
);

450 ià(
	gch_Œ
 =ğ
NULL
)

451 (*
pos™iÚ
)->
E¡im©ed_®Úe_wa™šg_time
 = 0;

454 
sim_time_ty³
 
	gex³ùed_Ï¡_time
 = 
ch_Œ
->
Issue_time
 + ch_Œ->
E¡im©ed_®Úe_wa™šg_time


455 + 
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
pos™iÚ
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*position);

457 ià(
	gex³ùed_Ï¡_time
 > 
	gSimuÏtÜ
->
Time
())

458 (*
	gpos™iÚ
)->
	gE¡im©ed_®Úe_wa™šg_time
 = 
ex³ùed_Ï¡_time
 - 
SimuÏtÜ
->
Time
();

464 
sim_time_ty³
 
	gex³ùed_Ï¡_time
 = (*
™r
)->
Issue_time
 + (*™r)->
E¡im©ed_®Úe_wa™šg_time


465 + 
_NVMCÚŒŞËr
->
Ex³ùed_Œªsãr_time
(*
pos™iÚ
è+ _NVMCÚŒŞËr->
Ex³ùed_fšish_time
(*position);

467 ià(
	gex³ùed_Ï¡_time
 > 
	gSimuÏtÜ
->
Time
())

468 (*
	gpos™iÚ
)->
	gE¡im©ed_®Úe_wa™šg_time
 = 
ex³ùed_Ï¡_time
 - 
SimuÏtÜ
->
Time
();

471 
	gTSU_FLIN
::
çœÃss_ba£d_Ú_av”age_¦owdown
(
chªÃl_id
, 
ch_id
, 
´iÜ™y_şass
, 
boŞ
 
is_»ad
, 
¡»am_id_ty³
& 
æow_w™h_max_av”age_¦owdown
)

473 
	g¦owdown_max
 = 0, 
	g¦owdown_mš
 = 10000000000000000000.0;

475 ià(
	gis_»ad
)

477 
	gi
 = 0; i < 
	g¡»am_couÁ_³r_´iÜ™y_şass
[
´iÜ™y_şass
]; i++)

479 
	gav”age_¦owdown
 = 
æow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
][
¡»am_ids_³r_´iÜ™y_şass
[´iÜ™y_şass][
i
]].
Sum_»ad_¦owdown
++;

480 ià(
	gav”age_¦owdown
 > 
	g¦owdown_max
)

481 
	g¦owdown_max
 = 
av”age_¦owdown
;

482 ià(
	gav”age_¦owdown
 < 
	g¦owdown_mš
)

483 
	g¦owdown_mš
 = 
av”age_¦owdown
;

488 
	gi
 = 0; i < 
	g¡»am_couÁ_³r_´iÜ™y_şass
[
´iÜ™y_şass
]; i++)

490 
	gav”age_¦owdown
 = 
æow_aùiv™y_šfo
[
chªÃl_id
][
ch_id
][
´iÜ™y_şass
][
¡»am_ids_³r_´iÜ™y_şass
[´iÜ™y_şass][
i
]].
Sum_wr™e_¦owdown
++;

491 ià(
	gav”age_¦owdown
 > 
	g¦owdown_max
)

492 
	g¦owdown_max
 = 
av”age_¦owdown
;

493 ià(
	gav”age_¦owdown
 < 
	g¦owdown_mš
)

494 
	g¦owdown_mš
 = 
av”age_¦owdown
;

498  ()
	g¦owdown_mš
 / 
	g¦owdown_max
;

501 
	gTSU_FLIN
::
move_fÜw¬d
(
FÏsh_T¿n§ùiÚ_Queue
* 
queue
, 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
TRÃw_pos
, std::li¡<NVM_T¿n§ùiÚ_FÏsh*>::™”©Ü 
uÉim©e_posi¡iÚ
)

503 autØ
TÃw_fš®_pos
 = 
TRÃw_pos
;

504 
	gTÃw_fš®_pos
--;

505 (*
	gTÃw_fš®_pos
)->
	gSŒ—m_id
 !ğ(*
TRÃw_pos
)->
SŒ—m_id
 && !(*
TÃw_fš®_pos
)->
FLIN_B¬r›r
 && TÃw_fš®_po !ğ
uÉim©e_posi¡iÚ
)

506 
TÃw_fš®_pos
--;

508 ià(
	gTÃw_fš®_pos
 =ğ
uÉim©e_posi¡iÚ


509 && (*
TÃw_fš®_pos
)->
SŒ—m_id
 !ğ(*
uÉim©e_posi¡iÚ
)->Stream_id

510 && !(*
TRÃw_pos
)->
FLIN_B¬r›r
)

512 
NVM_T¿n§ùiÚ_FÏsh
* 
Œ
 = *
TRÃw_pos
;

513 
	gqueue
->
»move
(
TRÃw_pos
);

514 
	gqueue
->
š£¹
(
TÃw_fš®_pos
, 
Œ
);

515 
	gŒ
->
	gFLIN_B¬r›r
 = 
Œue
;

519 
NVM_T¿n§ùiÚ_FÏsh
* 
	gŒ
 = *
TRÃw_pos
;

520 
	gqueue
->
»move
(
TRÃw_pos
);

521 
	gTÃw_fš®_pos
--;

522 
	gqueue
->
š£¹
(
TÃw_fš®_pos
, 
Œ
);

523 
	gŒ
->
	gFLIN_B¬r›r
 = 
Œue
;

527 
	gTSU_FLIN
::
š™Ÿlize_schedulšg_tuºs
()

529 
tÙ®_tuºs
 = ()
¡d
::
pow
(2, 
no_of_´iÜ™y_şas£s
) - 1;

530 
	gi
 = 0; i < 
	gtÙ®_tuºs
; i++)

532 
	gschedulšg_tuº_assignm’ts_»ad
.
push_back
(
i
);

533 
	gschedulšg_tuº_assignm’ts_wr™e
.
push_back
(
i
);

536 
	gk
 = 0;

537 
	g´iÜ™y_şass
 = 1;

539 
	g´iÜ™y_şass
 <ğ(
no_of_´iÜ™y_şas£s
))

541 
¡•
 = ()
¡d
::
pow
(2, 
no_of_´iÜ™y_şas£s
);

542 
	gi
 = ()
¡d
::
pow
(2, 
no_of_´iÜ™y_şas£s
 - 1); i < 
	gtÙ®_tuºs
; i +ğ
¡•
)

544 
schedulšg_tuº_assignm’ts_»ad
[
i
] = 
´iÜ™y_şass
;

545 
	gschedulšg_tuº_assignm’ts_wr™e
[
i
] = 
´iÜ™y_şass
;

547 
	g´iÜ™y_şass
++;

549 
	gcu¼’t_tuº_»ad
 = 0;

550 
	gcu¼’t_tuº_wr™e
 = 0;

553 
boŞ
 
	gTSU_FLIN
::
£rviû_»ad_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

555 
FÏsh_T¿n§ùiÚ_Queue
 *
sourûQueue1
 = 
NULL
, *
	gsourûQueue2
 = NULL;

557 
	g‹mp_tuº
 = 
cu¼’t_tuº_»ad
;

559 ià(
	gM­pšgR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0)

561 
	gsourûQueue1
 = &
M­pšgR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

562 ià(
	gál
->
	gGC_ªd_WL_Un™
->
GC_is_š_urg’t_mode
(
ch
è&& 
	gGCR—dTRQueue
[ch->
ChªÃlID
][ch->
ChID
].
size
() > 0)

563 
	gsourûQueue2
 = &
GCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

566 
	gúŒ
 = 0;

567 
	gúŒ
 < 
	gschedulšg_tuº_assignm’ts_»ad
.
size
())

569 ià(
	gU£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
][
schedulšg_tuº_assignm’ts_»ad
[
‹mp_tuº
]].
size
() > 0)

570 
	gsourûQueue2
 = &
U£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
][
schedulšg_tuº_assignm’ts_»ad
[
‹mp_tuº
]];

571 
	g‹mp_tuº
++;

572 
	g‹mp_tuº
 %ğ
schedulšg_tuº_assignm’ts_»ad
.
size
();

577  
	gŒue
;

580 
boŞ
 
	gTSU_FLIN
::
£rviû_wr™e_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

582  
Œue
;

585 
boŞ
 
	gTSU_FLIN
::
£rviû_”a£_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

587  
Œue
;

590 
	gTSU_FLIN
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
) {}

	@src/ssd/TSU_FLIN.h

1 #iâdeà
TSU_FLIN_H


2 
	#TSU_FLIN_H


	)

4 
	~<li¡
>

5 
	~<£t
>

6 
	~"TSU_Ba£.h
"

7 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

8 
	~"NVM_PHY_ONFI_NVDDR2.h
"

9 
	~"FTL.h
"

12 
Çme¥aû
 
	gSSD_CompÚ’ts


14 
şass
 
	gFTL
;

16 
	sFLIN_Flow_MÚ™Üšg_Un™


18 
	gS”viûd_»ad_»que¡s_hi¡Üy
;

19 
	gS”viûd_»ad_»que¡s_»ûÁ
;

20 
	gS”viûd_»ad_»que¡s_tÙ®
;

21 
	gS”viûd_wr™e_»que¡s_hi¡Üy
;

22 
	gS”viûd_wr™e_»que¡s_»ûÁ
;

23 
	gS”viûd_wr™e_»que¡s_tÙ®
;

24 
	gSum_»ad_¦owdown
;

25 
	gSum_wr™e_¦owdown
;

36 şas 
	cTSU_FLIN
 : 
public
 
TSU_Ba£


38 
public
:

39 
TSU_FLIN
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI_NVDDR2
* 
NVMCÚŒŞËr
,

40 cÚ¡ 
ChªÃl_no
, cÚ¡ 
ch_no_³r_chªÃl
, cÚ¡ 
d›_no_³r_ch
, cÚ¡ 
¶ªe_no_³r_d›
, 
æash_·ge_size
,

41 cÚ¡ 
sim_time_ty³
 
æow_şassifiÿtiÚ_•och
, cÚ¡ 
®pha_»ad
, cÚ¡ 
®pha_wr™e
,

42 cÚ¡ 
no_of_´iÜ™y_şas£s
, cÚ¡ 
¡»am_id_ty³
 
max_æow_id
, cÚ¡ * 
¡»am_couÁ_³r_´iÜ™y_şass
, sŒ—m_id_ty³** 
¡»am_ids_³r_´iÜ™y_şass
,

43 cÚ¡ 
f_thr
,

44 cÚ¡ 
sim_time_ty³
 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
,

45 cÚ¡ 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
,

46 cÚ¡ 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
,

47 cÚ¡ 
boŞ
 
E¿£Su¥’siÚEÇbËd
, cÚ¡ boŞ 
Prog¿mSu¥’siÚEÇbËd
);

48 ~
TSU_FLIN
();

49 
P»·»_fÜ_Œª§ùiÚ_subm™
();

50 
Subm™_Œª§ùiÚ
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

51 
ScheduË
();

53 
S¹_simuÏtiÚ
();

54 
V®id©e_simuÏtiÚ_cÚfig
();

55 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

56 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

57 
	g´iv©e
:

58 * 
¡»am_couÁ_³r_´iÜ™y_şass
;

59 
¡»am_id_ty³
** 
	g¡»am_ids_³r_´iÜ™y_şass
;

60 
FLIN_Flow_MÚ™Üšg_Un™
**** 
	gæow_aùiv™y_šfo
;

61 
sim_time_ty³
 
	gæow_şassifiÿtiÚ_•och
;

62 
	g®pha_»ad_fÜ_•och
, 
	g®pha_wr™e_fÜ_•och
;

63 
	gno_of_´iÜ™y_şas£s
;

64 
	gF_thr
;

65 
	g¡d
::
£t
<
¡»am_id_ty³
> ***
low_š‹ns™y_şass_»ad
, *** 
	glow_š‹ns™y_şass_wr™e
;

66 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
*** 
h—d_high_»ad
;

67 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
*** 
h—d_high_wr™e
;

68 
FÏsh_T¿n§ùiÚ_Queue
*** 
	gU£rR—dTRQueue
;

69 
NVM_T¿n§ùiÚ_FÏsh_RD
**** 
	gR—d_¦Ù
;

70 
FÏsh_T¿n§ùiÚ_Queue
*** 
	gU£rWr™eTRQueue
;

71 
NVM_T¿n§ùiÚ_FÏsh_WR
**** 
	gWr™e_¦Ù
;

72 
FÏsh_T¿n§ùiÚ_Queue
** 
	gGCR—dTRQueue
;

73 
FÏsh_T¿n§ùiÚ_Queue
** 
	gGCWr™eTRQueue
;

74 
FÏsh_T¿n§ùiÚ_Queue
** 
	gGCE¿£TRQueue
;

75 
FÏsh_T¿n§ùiÚ_Queue
** 
	gM­pšgR—dTRQueue
;

76 
FÏsh_T¿n§ùiÚ_Queue
** 
	gM­pšgWr™eTRQueue
;

78 
»Üd”_fÜ_çœÃss
(
FÏsh_T¿n§ùiÚ_Queue
* 
queue
, 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
¡¬t
, std::li¡<NVM_T¿n§ùiÚ_FÏsh*>::™”©Ü 
’d
);

79 
e¡im©e_®Úe_wa™šg_time
(
FÏsh_T¿n§ùiÚ_Queue
* 
queue
, 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
pos™iÚ
);

80 
çœÃss_ba£d_Ú_av”age_¦owdown
(
chªÃl_id
, 
ch_id
, 
´iÜ™y_şass
, 
boŞ
 
is_»ad
, 
¡»am_id_ty³
& 
æow_w™h_max_av”age_¦owdown
);

81 
move_fÜw¬d
(
FÏsh_T¿n§ùiÚ_Queue
* 
queue
, 
¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
TRÃw_pos
, std::li¡<NVM_T¿n§ùiÚ_FÏsh*>::™”©Ü 
uÉim©e_posi¡iÚ
);

82 
boŞ
 
£rviû_»ad_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

83 
boŞ
 
£rviû_wr™e_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

84 
boŞ
 
£rviû_”a£_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

87 
š™Ÿlize_schedulšg_tuºs
();

88 
	g¡d
::
veùÜ
<> 
schedulšg_tuº_assignm’ts_»ad
, 
	gschedulšg_tuº_assignm’ts_wr™e
;

89 
	gcu¼’t_tuº_»ad
, 
	gcu¼’t_tuº_wr™e
;

	@src/ssd/TSU_OutofOrder.cpp

1 
	~"TSU_OutofOrd”.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


6 
	gTSU_OutOfOrd”
::
TSU_OutOfOrd”
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI_NVDDR2
* 
NVMCÚŒŞËr
, 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
,

7 
D›NoP”Ch
, 
PÏÃNoP”D›
,

8 
sim_time_ty³
 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
,

9 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
,

10 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
,

11 
boŞ
 
E¿£Su¥’siÚEÇbËd
, boŞ 
Prog¿mSu¥’siÚEÇbËd
)

12 : 
TSU_Ba£
(
id
, 
ál
, 
NVMCÚŒŞËr
, 
FÏsh_Schedulšg_Ty³
::
OUT_OF_ORDER
, 
ChªÃlCouÁ
, 
ch_no_³r_chªÃl
, 
D›NoP”Ch
, 
PÏÃNoP”D›
,

13 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
, 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
, 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
,

14 
E¿£Su¥’siÚEÇbËd
, 
Prog¿mSu¥’siÚEÇbËd
)

16 
	gU£rR—dTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

17 
	gU£rWr™eTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

18 
	gGCR—dTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

19 
	gGCWr™eTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

20 
	gGCE¿£TRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

21 
	gM­pšgR—dTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

22 
	gM­pšgWr™eTRQueue
 = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
*[
chªÃl_couÁ
];

23 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

24 
	gU£rR—dTRQueue
[
chªÃlID
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

25 
	gU£rWr™eTRQueue
[
chªÃlID
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

26 
	gGCR—dTRQueue
[
chªÃlID
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

27 
	gGCWr™eTRQueue
[
chªÃlID
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

28 
	gGCE¿£TRQueue
[
chªÃlID
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

29 
	gM­pšgR—dTRQueue
[
chªÃlID
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

30 
	gM­pšgWr™eTRQueue
[
chªÃlID
] = 
Ãw
 
FÏsh_T¿n§ùiÚ_Queue
[
ch_no_³r_chªÃl
];

31 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

32 
	gU£rR—dTRQueue
[
chªÃlID
][
ch_úŒ
].
S‘_id
("U£r_R—d_TR_Queue@" + 
¡d
::
to_¡ršg
(channelID) + "@" + std::to_string(chip_cntr));

33 
	gU£rWr™eTRQueue
[
chªÃlID
][
ch_úŒ
].
S‘_id
("U£r_Wr™e_TR_Queue@" + 
¡d
::
to_¡ršg
(channelID) + "@" + std::to_string(chip_cntr));

34 
	gGCR—dTRQueue
[
chªÃlID
][
ch_úŒ
].
S‘_id
("GC_R—d_TR_Queue@" + 
¡d
::
to_¡ršg
(channelID) + "@" + std::to_string(chip_cntr));

35 
	gM­pšgR—dTRQueue
[
chªÃlID
][
ch_úŒ
].
S‘_id
("M­pšg_R—d_TR_Queue@" + 
¡d
::
to_¡ršg
(channelID) + "@" + std::to_string(chip_cntr));

36 
	gM­pšgWr™eTRQueue
[
chªÃlID
][
ch_úŒ
].
S‘_id
("M­pšg_Wr™e_TR_Queue@" + 
¡d
::
to_¡ršg
(channelID) + "@" + std::to_string(chip_cntr));

37 
	gGCWr™eTRQueue
[
chªÃlID
][
ch_úŒ
].
S‘_id
("GC_Wr™e_TR_Queue@" + 
¡d
::
to_¡ršg
(channelID) + "@" + std::to_string(chip_cntr));

38 
	gGCE¿£TRQueue
[
chªÃlID
][
ch_úŒ
].
S‘_id
("GC_E¿£_TR_Queue@" + 
¡d
::
to_¡ršg
(channelID) + "@" + std::to_string(chip_cntr));

43 
	gTSU_OutOfOrd”
::~
TSU_OutOfOrd”
()

45 
chªÃlID
 = 0; 
	gchªÃlID
 < 
	gchªÃl_couÁ
; channelID++) {

46 
	gd–‘e
[] 
	gU£rR—dTRQueue
[
chªÃlID
];

47 
	gd–‘e
[] 
	gU£rWr™eTRQueue
[
chªÃlID
];

48 
	gd–‘e
[] 
	gGCR—dTRQueue
[
chªÃlID
];

49 
	gd–‘e
[] 
	gGCWr™eTRQueue
[
chªÃlID
];

50 
	gd–‘e
[] 
	gGCE¿£TRQueue
[
chªÃlID
];

51 
	gd–‘e
[] 
	gM­pšgR—dTRQueue
[
chªÃlID
];

52 
	gd–‘e
[] 
	gM­pšgWr™eTRQueue
[
chªÃlID
];

54 
	gd–‘e
[] 
	gU£rR—dTRQueue
;

55 
	gd–‘e
[] 
	gU£rWr™eTRQueue
;

56 
	gd–‘e
[] 
	gGCR—dTRQueue
;

57 
	gd–‘e
[] 
	gGCWr™eTRQueue
;

58 
	gd–‘e
[] 
	gGCE¿£TRQueue
;

59 
	gd–‘e
[] 
	gM­pšgR—dTRQueue
;

60 
	gd–‘e
[] 
	gM­pšgWr™eTRQueue
;

63 
	gTSU_OutOfOrd”
::
S¹_simuÏtiÚ
()

67 
TSU_OutOfOrd”
::
V®id©e_simuÏtiÚ_cÚfig
()

71 
TSU_OutOfOrd”
::
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
* 
ev’t
)

75 
TSU_OutOfOrd”
::
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
)

77 
Çme_´efix
 =‚ame_prefix + +".TSU";

78 
	gxmlwr™”
.
Wr™e_İ’_g
(
Çme_´efix
);

80 
	gTSU_Ba£
::
R•Üt_»suÉs_š_XML
(
Çme_´efix
, 
xmlwr™”
);

82 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

83 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

84 
	gU£rR—dTRQueue
[
chªÃlID
][
ch_úŒ
].
R•Üt_»suÉs_š_XML
(
Çme_´efix
 + ".U£r_R—d_TR_Queue", 
xmlwr™”
);

88 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

89 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

90 
	gU£rWr™eTRQueue
[
chªÃlID
][
ch_úŒ
].
R•Üt_»suÉs_š_XML
(
Çme_´efix
 + ".U£r_Wr™e_TR_Queue", 
xmlwr™”
);

94 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

95 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

96 
	gM­pšgR—dTRQueue
[
chªÃlID
][
ch_úŒ
].
R•Üt_»suÉs_š_XML
(
Çme_´efix
 + ".M­pšg_R—d_TR_Queue", 
xmlwr™”
);

100 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

101 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

102 
	gM­pšgWr™eTRQueue
[
chªÃlID
][
ch_úŒ
].
R•Üt_»suÉs_š_XML
(
Çme_´efix
 + ".M­pšg_Wr™e_TR_Queue", 
xmlwr™”
);

106 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

107 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

108 
	gGCR—dTRQueue
[
chªÃlID
][
ch_úŒ
].
R•Üt_»suÉs_š_XML
(
Çme_´efix
 + ".GC_R—d_TR_Queue", 
xmlwr™”
);

112 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

113 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

114 
	gGCWr™eTRQueue
[
chªÃlID
][
ch_úŒ
].
R•Üt_»suÉs_š_XML
(
Çme_´efix
 + ".GC_Wr™e_TR_Queue", 
xmlwr™”
);

118 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

119 
	gch_úŒ
 = 0; ch_úŒ < 
	gch_no_³r_chªÃl
; chip_cntr++) {

120 
	gGCE¿£TRQueue
[
chªÃlID
][
ch_úŒ
].
R•Üt_»suÉs_š_XML
(
Çme_´efix
 + ".GC_E¿£_TR_Queue", 
xmlwr™”
);

124 
	gxmlwr™”
.
Wr™e_şo£_g
();

127 
šlše
 
	gTSU_OutOfOrd”
::
P»·»_fÜ_Œª§ùiÚ_subm™
()

129 
İ’ed_schedulšg_»qs
++;

130 ià(
	gİ’ed_schedulšg_»qs
 > 1) {

133 
	gŒª§ùiÚ_»ûive_¦Ùs
.
ş—r
();

136 
šlše
 
	gTSU_OutOfOrd”
::
Subm™_Œª§ùiÚ
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
)

138 
Œª§ùiÚ_»ûive_¦Ùs
.
push_back
(
Œª§ùiÚ
);

141 
	gTSU_OutOfOrd”
::
ScheduË
()

143 
İ’ed_schedulšg_»qs
--;

144 ià(
	gİ’ed_schedulšg_»qs
 > 0) {

148 ià(
	gİ’ed_schedulšg_»qs
 < 0) {

149 
PRINT_ERROR
("TSU_OutOfOrder: Illegal status!");

152 ià(
	gŒª§ùiÚ_»ûive_¦Ùs
.
size
() == 0) {

156 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ_FÏsh
*>::
™”©Ü
 
™
 = 
Œª§ùiÚ_»ûive_¦Ùs
.
begš
();

157 
	g™
 !ğ
Œª§ùiÚ_»ûive_¦Ùs
.
’d
(); it++)

159 (*
	g™
)->
	gTy³
) {

160 
	gT¿n§ùiÚ_Ty³
::
READ
:

161 (*
™
)->
Sourû
) {

162 
T¿n§ùiÚ_Sourû_Ty³
::
CACHE
:

163 
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
:

164 
U£rR—dTRQueue
[(*
™
)->
Add»ss
.
ChªÃlID
][(*™)->Add»ss.
ChID
].
push_back
((*it));

166 
	gT¿n§ùiÚ_Sourû_Ty³
::
MAPPING
:

167 
M­pšgR—dTRQueue
[(*
™
)->
Add»ss
.
ChªÃlID
][(*™)->Add»ss.
ChID
].
push_back
((*it));

169 
	gT¿n§ùiÚ_Sourû_Ty³
::
GC_WL
:

170 
GCR—dTRQueue
[(*
™
)->
Add»ss
.
ChªÃlID
][(*™)->Add»ss.
ChID
].
push_back
((*it));

173 
PRINT_ERROR
("TSU_OutOfOrder: unknown sourceype for‡„eadransaction!")

176 
	gT¿n§ùiÚ_Ty³
::
WRITE
:

177 (*
™
)->
Sourû
) {

178 
T¿n§ùiÚ_Sourû_Ty³
::
CACHE
:

179 
T¿n§ùiÚ_Sourû_Ty³
::
USERIO
:

180 
U£rWr™eTRQueue
[(*
™
)->
Add»ss
.
ChªÃlID
][(*™)->Add»ss.
ChID
].
push_back
((*it));

182 
	gT¿n§ùiÚ_Sourû_Ty³
::
MAPPING
:

183 
M­pšgWr™eTRQueue
[(*
™
)->
Add»ss
.
ChªÃlID
][(*™)->Add»ss.
ChID
].
push_back
((*it));

185 
	gT¿n§ùiÚ_Sourû_Ty³
::
GC_WL
:

186 
GCWr™eTRQueue
[(*
™
)->
Add»ss
.
ChªÃlID
][(*™)->Add»ss.
ChID
].
push_back
((*it));

189 
PRINT_ERROR
("TSU_OutOfOrder: unknown sourceype for‡ writeransaction!")

192 
	gT¿n§ùiÚ_Ty³
::
ERASE
:

193 
GCE¿£TRQueue
[(*
™
)->
Add»ss
.
ChªÃlID
][(*™)->Add»ss.
ChID
].
push_back
((*it));

200 
æash_chªÃl_ID_ty³
 
	gchªÃlID
 = 0; chªÃlID < 
	gchªÃl_couÁ
; channelID++) {

201 ià(
	g_NVMCÚŒŞËr
->
G‘_chªÃl_¡©us
(
chªÃlID
è=ğ
BusChªÃlStus
::
IDLE
) {

202 
i
 = 0; 
	gi
 < 
	gch_no_³r_chªÃl
; i++) {

203 
	gNVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
 = 
_NVMCÚŒŞËr
->
G‘_ch
(
chªÃlID
, 
Round_robš_tuº_of_chªÃl
[channelID]);

205 ià(!
£rviû_»ad_Œª§ùiÚ
(
ch
)) {

206 ià(!
£rviû_wr™e_Œª§ùiÚ
(
ch
)) {

207 
£rviû_”a£_Œª§ùiÚ
(
ch
);

210 
	gRound_robš_tuº_of_chªÃl
[
chªÃlID
] = (
æash_ch_ID_ty³
)(
Round_robš_tuº_of_chªÃl
[chªÃlID] + 1è% 
ch_no_³r_chªÃl
;

211 ià(
	g_NVMCÚŒŞËr
->
G‘_chªÃl_¡©us
(
ch
->
ChªÃlID
è!ğ
BusChªÃlStus
::
IDLE
) {

219 
boŞ
 
	gTSU_OutOfOrd”
::
£rviû_»ad_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

221 
FÏsh_T¿n§ùiÚ_Queue
 *
sourûQueue1
 = 
NULL
, *
	gsourûQueue2
 = NULL;

224 ià(
	gM­pšgR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

225 
	gsourûQueue1
 = &
M­pšgR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

226 ià(
	gál
->
	gGC_ªd_WL_Un™
->
GC_is_š_urg’t_mode
(
ch
è&& 
	gGCR—dTRQueue
[ch->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

227 
	gsourûQueue2
 = &
GCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

228 } ià(
	gU£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

229 
	gsourûQueue2
 = &
U£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

231 } ià(
	gál
->
	gGC_ªd_WL_Un™
->
GC_is_š_urg’t_mode
(
ch
)) {

234 ià(
	gGCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

235 
	gsourûQueue1
 = &
GCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

236 ià(
	gU£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

237 
	gsourûQueue2
 = &
U£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

239 } ià(
	gGCWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

240  
	gçl£
;

241 } ià(
	gGCE¿£TRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

242  
	gçl£
;

243 } ià(
	gU£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

244 
	gsourûQueue1
 = &
U£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

246  
	gçl£
;

251 ià(
	gU£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

252 
	gsourûQueue1
 = &
U£rR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

253 ià(
	gGCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

254 
	gsourûQueue2
 = &
GCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

256 } ià(
	gU£rWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

257  
	gçl£
;

258 } ià(
	gGCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

259 
	gsourûQueue1
 = &
GCR—dTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

261  
	gçl£
;

265 
boŞ
 
	gsu¥’siÚRequœed
 = 
çl£
;

266 
ChStus
 
	gcs
 = 
_NVMCÚŒŞËr
->
G‘ChStus
(
ch
);

267 
	gcs
) {

268 
	gChStus
::
IDLE
:

270 
	gChStus
::
WRITING
:

271 ià(!
´og¿mSu¥’siÚEÇbËd
 || 
_NVMCÚŒŞËr
->
HasSu¥’dedCommªd
(
ch
)) {

272  
çl£
;

274 ià(
	g_NVMCÚŒŞËr
->
Ex³ùed_fšish_time
(
ch
è- 
	gSimuÏtÜ
->
Time
(è< 
	gwr™eR—sÚabËSu¥’siÚTimeFÜR—d
) {

275  
	gçl£
;

277 
	gsu¥’siÚRequœed
 = 
Œue
;

278 
	gChStus
::
ERASING
:

279 ià(!
”a£Su¥’siÚEÇbËd
 || 
_NVMCÚŒŞËr
->
HasSu¥’dedCommªd
(
ch
)) {

280  
çl£
;

282 ià(
	g_NVMCÚŒŞËr
->
Ex³ùed_fšish_time
(
ch
è- 
	gSimuÏtÜ
->
Time
(è< 
	g”a£R—sÚabËSu¥’siÚTimeFÜR—d
) {

283  
	gçl£
;

285 
	gsu¥’siÚRequœed
 = 
Œue
;

287  
çl£
;

290 
æash_d›_ID_ty³
 
	gd›ID
 = 
sourûQueue1
->
äÚt
()->
Add»ss
.
D›ID
;

291 
æash_·ge_ID_ty³
 
	g·geID
 = 
sourûQueue1
->
äÚt
()->
Add»ss
.
PageID
;

292 
	g¶ªeVeùÜ
 = 0;

293 
	gi
 = 0; i < 
	gd›_no_³r_ch
; i++) {

294 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
ş—r
();

295 
	g¶ªeVeùÜ
 = 0;

297 
	gFÏsh_T¿n§ùiÚ_Queue
::
™”©Ü
 
™
 = 
sourûQueue1
->
begš
(); 
	g™
 !ğsourûQueue1->
’d
();) {

298 ià((*
	g™
)->
	gAdd»ss
.
	gD›ID
 =ğ
d›ID
 && !(
¶ªeVeùÜ
 & 1 << (*
™
)->
Add»ss
.
PÏÃID
)) {

301 ià(
¶ªeVeùÜ
 =ğ0 || (*
™
)->
Add»ss
.
PageID
 =ğ
·geID
) {

302 (*
™
)->
Su¥’dRequœed
 = 
su¥’siÚRequœed
;

303 
	g¶ªeVeùÜ
 |ğ1 << (*
™
)->
Add»ss
.
PÏÃID
;

304 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
push_back
(*
™
);

305 
	gsourûQueue1
->
»move
(
™
++);

309 
	g™
++;

312 ià(
	gsourûQueue2
 !ğ
NULL
 && 
Œª§ùiÚ_di¥©ch_¦Ùs
.
size
(è< 
¶ªe_no_³r_d›
) {

313 
FÏsh_T¿n§ùiÚ_Queue
::
™”©Ü
 
™
 = 
sourûQueue2
->
begš
(); 
	g™
 !ğsourûQueue2->
’d
();) {

314 ià((*
	g™
)->
	gAdd»ss
.
	gD›ID
 =ğ
d›ID
 && !(
¶ªeVeùÜ
 & 1 << (*
™
)->
Add»ss
.
PÏÃID
)) {

316 ià(
¶ªeVeùÜ
 =ğ0 || (*
™
)->
Add»ss
.
PageID
 =ğ
·geID
) {

317 (*
™
)->
Su¥’dRequœed
 = 
su¥’siÚRequœed
;

318 
	g¶ªeVeùÜ
 |ğ1 << (*
™
)->
Add»ss
.
PÏÃID
;

319 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
push_back
(*
™
);

320 
	gsourûQueue2
->
»move
(
™
++);

324 
	g™
++;

328 ià(
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
size
() > 0) {

329 
	g_NVMCÚŒŞËr
->
S’d_commªd_to_ch
(
Œª§ùiÚ_di¥©ch_¦Ùs
);

331 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
ş—r
();

332 
	gd›ID
 = (
d›ID
 + 1è% 
d›_no_³r_ch
;

335  
	gŒue
;

338 
boŞ
 
	gTSU_OutOfOrd”
::
£rviû_wr™e_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

340 
FÏsh_T¿n§ùiÚ_Queue
 *
sourûQueue1
 = 
NULL
, *
	gsourûQueue2
 = NULL;

343 ià(
	gál
->
	gGC_ªd_WL_Un™
->
GC_is_š_urg’t_mode
(
ch
)) {

344 ià(
	gGCWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

345 
	gsourûQueue1
 = &
GCWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

346 ià(
	gU£rWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

347 
	gsourûQueue2
 = &
U£rWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

349 } ià(
	gGCE¿£TRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

350  
	gçl£
;

351 } ià(
	gU£rWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

352 
	gsourûQueue1
 = &
U£rWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

354  
	gçl£
;

359 ià(
	gU£rWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

360 
	gsourûQueue1
 = &
U£rWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

361 ià(
	gGCWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

362 
	gsourûQueue2
 = &
GCWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

364 } ià(
	gGCWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
].
size
() > 0) {

365 
	gsourûQueue1
 = &
GCWr™eTRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

367  
	gçl£
;

372 
boŞ
 
	gsu¥’siÚRequœed
 = 
çl£
;

373 
ChStus
 
	gcs
 = 
_NVMCÚŒŞËr
->
G‘ChStus
(
ch
);

374 
	gcs
) {

375 
	gChStus
::
IDLE
:

377 
	gChStus
::
ERASING
:

378 ià(!
”a£Su¥’siÚEÇbËd
 || 
_NVMCÚŒŞËr
->
HasSu¥’dedCommªd
(
ch
))

379  
çl£
;

380 ià(
	g_NVMCÚŒŞËr
->
Ex³ùed_fšish_time
(
ch
è- 
	gSimuÏtÜ
->
Time
(è< 
	g”a£R—sÚabËSu¥’siÚTimeFÜWr™e
)

381  
	gçl£
;

382 
	gsu¥’siÚRequœed
 = 
Œue
;

384  
çl£
;

387 
æash_d›_ID_ty³
 
	gd›ID
 = 
sourûQueue1
->
äÚt
()->
Add»ss
.
D›ID
;

388 
æash_·ge_ID_ty³
 
	g·geID
 = 
sourûQueue1
->
äÚt
()->
Add»ss
.
PageID
;

389 
	g¶ªeVeùÜ
 = 0;

390 
	gi
 = 0; i < 
	gd›_no_³r_ch
; i++) {

391 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
ş—r
();

392 
	g¶ªeVeùÜ
 = 0;

394 
	gFÏsh_T¿n§ùiÚ_Queue
::
™”©Ü
 
™
 = 
sourûQueue1
->
begš
(); 
	g™
 !ğsourûQueue1->
’d
(); ) {

395 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_WR
*)*
	g™
)->
	gR–©edR—d
 =ğ
NULL
 && (*
™
)->
Add»ss
.
D›ID
 =ğ
d›ID
 && !(
¶ªeVeùÜ
 & 1 << (*™)->Add»ss.
PÏÃID
)) {

397 ià(
¶ªeVeùÜ
 =ğ0 || (*
™
)->
Add»ss
.
PageID
 =ğ
·geID
) {

398 (*
™
)->
Su¥’dRequœed
 = 
su¥’siÚRequœed
;

399 
	g¶ªeVeùÜ
 |ğ1 << (*
™
)->
Add»ss
.
PÏÃID
;

400 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
push_back
(*
™
);

401 
	gsourûQueue1
->
»move
(
™
++);

405 
	g™
++;

408 ià(
	gsourûQueue2
 !ğ
NULL
) {

409 
FÏsh_T¿n§ùiÚ_Queue
::
™”©Ü
 
™
 = 
sourûQueue2
->
begš
(); 
	g™
 !ğsourûQueue2->
’d
(); ) {

410 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_WR
*)*
	g™
)->
	gR–©edR—d
 =ğ
NULL
 && (*
™
)->
Add»ss
.
D›ID
 =ğ
d›ID
 && !(
¶ªeVeùÜ
 & 1 << (*™)->Add»ss.
PÏÃID
)) {

412 ià(
¶ªeVeùÜ
 =ğ0 || (*
™
)->
Add»ss
.
PageID
 =ğ
·geID
)

414 (*
™
)->
Su¥’dRequœed
 = 
su¥’siÚRequœed
;

415 
	g¶ªeVeùÜ
 |ğ1 << (*
™
)->
Add»ss
.
PÏÃID
;

416 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
push_back
(*
™
);

417 
	gsourûQueue2
->
»move
(
™
++);

421 
	g™
++;

425 ià(
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
size
() > 0) {

426 
	g_NVMCÚŒŞËr
->
S’d_commªd_to_ch
(
Œª§ùiÚ_di¥©ch_¦Ùs
);

428 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
ş—r
();

429 
	gd›ID
 = (
d›ID
 + 1è% 
d›_no_³r_ch
;

432  
	gŒue
;

435 
boŞ
 
	gTSU_OutOfOrd”
::
£rviû_”a£_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
)

437 ià(
_NVMCÚŒŞËr
->
G‘ChStus
(
ch
è!ğ
ChStus
::
IDLE
) {

438  
çl£
;

441 
FÏsh_T¿n§ùiÚ_Queue
* 
	gsourû_queue
 = &
GCE¿£TRQueue
[
ch
->
ChªÃlID
][ch->
ChID
];

442 ià(
	gsourû_queue
->
size
() == 0) {

443  
çl£
;

446 
æash_d›_ID_ty³
 
	gd›ID
 = 
sourû_queue
->
äÚt
()->
Add»ss
.
D›ID
;

447 
	g¶ªeVeùÜ
 = 0;

448 
	gi
 = 0; i < 
	gd›_no_³r_ch
; i++) {

449 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
ş—r
();

450 
	g¶ªeVeùÜ
 = 0;

452 
	gFÏsh_T¿n§ùiÚ_Queue
::
™”©Ü
 
™
 = 
sourû_queue
->
begš
(); 
	g™
 !ğsourû_queue->
’d
(); ) {

453 ià(((
	gNVM_T¿n§ùiÚ_FÏsh_ER
*)*
	g™
)->
	gPage_movem’t_aùiv™›s
.
size
(è=ğ0 && (*
™
)->
Add»ss
.
D›ID
 =ğ
d›ID
 && !(
¶ªeVeùÜ
 & 1 << (*™)->Add»ss.
PÏÃID
)) {

454 
¶ªeVeùÜ
 |ğ1 << (*
™
)->
Add»ss
.
PÏÃID
;

455 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
push_back
(*
™
);

456 
	gsourû_queue
->
»move
(
™
++);

458 
	g™
++;

460 ià(
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
size
() > 0) {

461 
	g_NVMCÚŒŞËr
->
S’d_commªd_to_ch
(
Œª§ùiÚ_di¥©ch_¦Ùs
);

463 
	gŒª§ùiÚ_di¥©ch_¦Ùs
.
ş—r
();

464 
	gd›ID
 = (
d›ID
 + 1è% 
d›_no_³r_ch
;

467  
	gŒue
;

	@src/ssd/TSU_OutofOrder.h

1 #iâdeà
TSU_OUTOFORDER_H


2 
	#TSU_OUTOFORDER_H


	)

4 
	~<li¡
>

5 
	~"TSU_Ba£.h
"

6 
	~"NVM_T¿n§ùiÚ_FÏsh.h
"

7 
	~"NVM_PHY_ONFI_NVDDR2.h
"

8 
	~"FTL.h
"

10 
Çme¥aû
 
	gSSD_CompÚ’ts


12 
şass
 
	gFTL
;

22 şas 
	cTSU_OutOfOrd”
 : 
public
 
TSU_Ba£


24 
public
:

25 
TSU_OutOfOrd”
(cÚ¡ 
sim_objeù_id_ty³
& 
id
, 
FTL
* 
ál
, 
NVM_PHY_ONFI_NVDDR2
* 
NVMCÚŒŞËr
, 
ChªÃl_no
, 
ch_no_³r_chªÃl
,

26 
D›NoP”Ch
, 
PÏÃNoP”D›
,

27 
sim_time_ty³
 
Wr™eR—sÚabËSu¥’siÚTimeFÜR—d
,

28 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜR—d
,

29 
sim_time_ty³
 
E¿£R—sÚabËSu¥’siÚTimeFÜWr™e
,

30 
boŞ
 
E¿£Su¥’siÚEÇbËd
, boŞ 
Prog¿mSu¥’siÚEÇbËd
);

31 ~
TSU_OutOfOrd”
();

32 
P»·»_fÜ_Œª§ùiÚ_subm™
();

33 
Subm™_Œª§ùiÚ
(
NVM_T¿n§ùiÚ_FÏsh
* 
Œª§ùiÚ
);

34 
ScheduË
();

36 
S¹_simuÏtiÚ
();

37 
V®id©e_simuÏtiÚ_cÚfig
();

38 
Execu‹_simuÏtÜ_ev’t
(
MQSimEngše
::
Sim_Ev’t
*);

39 
R•Üt_»suÉs_š_XML
(
¡d
::
¡ršg
 
Çme_´efix
, 
Uts
::
XmlWr™”
& 
xmlwr™”
);

40 
	g´iv©e
:

41 
FÏsh_T¿n§ùiÚ_Queue
** 
U£rR—dTRQueue
;

42 
FÏsh_T¿n§ùiÚ_Queue
** 
	gU£rWr™eTRQueue
;

43 
FÏsh_T¿n§ùiÚ_Queue
** 
	gGCR—dTRQueue
;

44 
FÏsh_T¿n§ùiÚ_Queue
** 
	gGCWr™eTRQueue
;

45 
FÏsh_T¿n§ùiÚ_Queue
** 
	gGCE¿£TRQueue
;

46 
FÏsh_T¿n§ùiÚ_Queue
** 
	gM­pšgR—dTRQueue
;

47 
FÏsh_T¿n§ùiÚ_Queue
** 
	gM­pšgWr™eTRQueue
;

49 
boŞ
 
£rviû_»ad_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

50 
boŞ
 
£rviû_wr™e_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

51 
boŞ
 
£rviû_”a£_Œª§ùiÚ
(
NVM
::
FÏshMemÜy
::
FÏsh_Ch
* 
ch
);

	@src/ssd/User_Request.cpp

1 
	~"U£r_Reque¡.h
"

3 
Çme¥aû
 
	gSSD_CompÚ’ts


5 
	gU£r_Reque¡
::
Ï¡Id
 = 0;

7 
	gU£r_Reque¡
::
U£r_Reque¡
(è: 
SeùÜs_£rviûd_äom_ÿche
(0)

9 
ID
 = "" + 
¡d
::
to_¡ršg
(
Ï¡Id
++);

10 
	gToBeIgnÜed
 = 
çl£
;

	@src/ssd/User_Request.h

1 #iâdeà
USER_REQUEST_H


2 
	#USER_REQUEST_H


	)

4 
	~<¡ršg
>

5 
	~<li¡
>

6 
	~"SSD_Defs.h
"

7 
	~"../sim/Sim_Defs.h
"

8 
	~"Ho¡_IÁ”çû_Defs.h
"

9 
	~"NVM_T¿n§ùiÚ.h
"

11 
Çme¥aû
 
	gSSD_CompÚ’ts


13 şas 
	cU£rReque¡Ty³
 { 
	gREAD
, 
	gWRITE
 };

14 
şass
 
	gNVM_T¿n§ùiÚ
;

15 şas 
	cU£r_Reque¡


17 
	gpublic
:

18 
U£r_Reque¡
();

19 
IO_Flow_PriÜ™y_CÏss
 
	gPriÜ™y_şass
;

20 
io_»que¡_id_ty³
 
	gID
;

21 
LHA_ty³
 
	gS¹_LBA
;

23 
sim_time_ty³
 
	gSTAT_In™ŸtiÚTime
;

24 
sim_time_ty³
 
	gSTAT_Re¥Ú£Time
;

25 
	g¡d
::
li¡
<
NVM_T¿n§ùiÚ
*> 
T¿n§ùiÚ_li¡
;

26 
	gSeùÜs_£rviûd_äom_ÿche
;

28 
	gSize_š_by‹
;

29 
	gSizeInSeùÜs
;

30 
U£rReque¡Ty³
 
	gTy³
;

31 
¡»am_id_ty³
 
	gSŒ—m_id
;

32 
boŞ
 
	gToBeIgnÜed
;

33 * 
	gIO_commªd_šfo
;

34 * 
	gD©a
;

35 
	g´iv©e
:

36 
Ï¡Id
;

	@src/utils/CMRRandomGenerator.cpp

1 
	~"CMRRªdomG’”©Ü.h
"

3 
Çme¥aû
 
	gUts


5 
	gCMRRªdomG’”©Ü
::
nÜm
 = 2.328306549295728e-10;

6 
	gCMRRªdomG’”©Ü
::
m1
 = 4294967087.0;

7 
	gCMRRªdomG’”©Ü
::
m2
 = 4294944443.0;

8 
	gCMRRªdomG’”©Ü
::
a12
 = 1403580.0;

9 
	gCMRRªdomG’”©Ü
::
a13
 = -810728.0;

10 
	gCMRRªdomG’”©Ü
::
a21
 = 527612.0;

11 
	gCMRRªdomG’”©Ü
::
a23
 = -1370589.0;

13 
	gCMRRªdomG’”©Ü
::
a
[2][3][3] = { {{0.0, 1.0, 0.0}, {0.0, 0.0, 1.0}, {
a13
, 
a12
, 0.0}},

14 {{0.0, 1.0, 0.0}, {0.0, 0.0, 1.0}, {
a23
, 0.0, 
a21
}} };

16 
	gCMRRªdomG’”©Ü
::
m
[2] = { 
m1
, 
m2
 };

17 
	gCMRRªdomG’”©Ü
::
š™_s
[2][3] = { {1.0, 1.0, 1.0}, {1.0, 1.0, 1.0} };

19 
	gCMRRªdomG’”©Ü
::
CMRRªdomG’”©Ü
(
št64_t
 
n
, 
št32_t
 
e
)

21 
	gi
 = 0; i <= 1; i++) {

22 
	gj
 = 0; j <= 2; j++) {

23 
	gs
[
i
][
j
] = 
š™_s
[i][j];

26 
Advªû
(
n
, 
e
);

29 
	gCMRRªdomG’”©Ü
::
Advªû
(
št64_t
 
n
, 
št32_t
 
e
)

31 
št64_t
 
	gB
[2][3][3];

33 
št64_t
 
	gS
[2][3];

34 
št64_t
 
	gM
[2];

36 
	gi
 = 0; i <= 1; i++) {

37 
m_áoi
(
a
[
i
], 
B
[i], 
m
[i]);

38 
v_áoi
(
s
[
i
], 
S
[i], 
m
[i]);

39 
	gM
[
i
] = (
št64_t
)(
m
[i]);

42 
	ge
-- != 0) {

43 
i
 = 0; 
	gi
 <= 1; i++) {

44 
mm_mul
(
B
[
i
], B[i], B[i], 
M
[i]);

48 
	gn
 != 0) {

49 ià((
n
 & 1) != 0) {

50 
i
 = 0; 
	gi
 <= 1; i++) {

51 
mv_mul
(
B
[
i
], 
S
[i], S[i], 
M
[i]);

54 
	gn
 >>= 1;

55 ià(
	gn
 != 0) {

56 
i
 = 0; 
	gi
 <= 1; i++) {

57 
mm_mul
(
B
[
i
], B[i], B[i], 
M
[i]);

62 
	gi
 = 0; i <= 1; i++) {

63 
v_™of
(
S
[
i
], 
s
[i], 
M
[i]);

67 
	gCMRRªdomG’”©Ü
::
NextDoubË
()

69 
p1
 = 
mod
(
a12
 * 
s
[0][1] + 
a13
 * s[0][0], 
m1
);

70 
	gs
[0][0] = 
s
[0][1];

71 
	gs
[0][1] = 
s
[0][2];

72 
	gs
[0][2] = 
p1
;

73 
	gp2
 = 
mod
(
a21
 * 
s
[1][2] + 
a23
 * s[1][0], 
m2
);

74 
	gs
[1][0] = 
s
[1][1];

75 
	gs
[1][1] = 
s
[1][2];

76 
	gs
[1][2] = 
p2
;

77 
	gp
 = 
p1
 - 
p2
;

78 ià(
	gp
 < 0.0) {

79 
	gp
 +ğ
m1
;

82  (
	gp
 + 1è* 
	gnÜm
;

	@src/utils/CMRRandomGenerator.h

1 #iâdeà
CMR_RANDOM_GENERATOR_H


2 
	#CMR_RANDOM_GENERATOR_H


	)

4 
	~<c¡dšt
>

6 
Çme¥aû
 
	gUts


8 şas 
	cCMRRªdomG’”©Ü


10 
	gpublic
:

11 
CMRRªdomG’”©Ü
(
št64_t
 
n
, 
e
);

12 
Advªû
(
št64_t
 
n
, 
e
);

13 
NextDoubË
();

14 
	g´iv©e
:

15 
s
[2][3];

16 
	gnÜm
, 
	gm1
, 
	gm2
, 
	ga12
, 
	ga13
, 
	ga21
, 
	ga23
;

17 
	ga
[2][3][3];

18 
	gm
[2];

19 
	gš™_s
[2][3];

22 
mod
(
x
, 
m
)

24 
št64_t
 
	gk
 = (št64_t)(
x
 / 
m
);

25 
	gx
 -ğ()
k
 * 
m
;

26 ià(
	gx
 < 0.0) {

27 
	gx
 +ğ
m
;

29  
	gx
;

35 
št64_t
 
áoi
(
x
, 
m
)

37 ià(
	gx
 >= 0.0) {

38  (
št64_t
)(
x
);

41  (
	gšt64_t
)(()
	gx
 + ()
	gm
);

45 
™of
(
št64_t
 
i
, iÁ64_ˆ
m
)

47  ()
	gi
;

50 
v_áoi
(* 
u
, 
št64_t
* 
v
, 
m
)

52 
	gi
 = 0; i <= 2; i++) {

53 
	gv
[
i
] = 
áoi
(
u
[i], 
m
);

57 
v_™of
(
št64_t
* 
u
, * 
v
, iÁ64_ˆ
m
)

59 
	gi
 = 0; i <= 2; i++) {

60 
	gv
[
i
] = 
™of
((
št64_t
)
u
[i], 
m
);

64 
v_cİy
(
št64_t
* 
u
, iÁ64_t* 
v
)

66 
	gi
 = 0; i <= 2; i++) {

67 
	gv
[
i
] = 
u
[i];

71 
m_áoi
(
a
[][3], 
št64_t
 
b
[][3], 
m
)

73 
	gi
 = 0; i <= 2; i++) {

74 
	gj
 = 0; j <= 2; j++) {

75 
	gb
[
i
][
j
] = 
áoi
(
a
[i][j], 
m
);

80 
m_cİy
(
št64_t
 
a
[][3], iÁ64_ˆ
b
[][3])

82 
	gi
 = 0; i <= 2; i++) {

83 
	gj
 = 0; j <= 2; j++) {

84 
	gb
[
i
][
j
] = 
a
[i][j];

89 
mv_mul
(
št64_t
 
a
[][3], iÁ64_t* 
u
, iÁ64_t* 
v
, iÁ64_ˆ
m
)

91 
št64_t
 
	gw
[3];

92 
	gi
 = 0; i <= 2; i++) {

93 
	gw
[
i
] = 0;

94 
	gj
 = 0; j <= 2; j++) {

95 
	gw
[
i
] = (
a
[i][
j
] * 
u
[j] + 
w
[i]è% 
m
;

98 
v_cİy
(
w
, 
v
);

101 
mm_mul
(
št64_t
 
a
[][3], iÁ64_ˆ
b
[][3], iÁ64_ˆ
c
[][3], iÁ64_ˆ
m
)

103 
št64_t
 
	gd
 [3][3];

105 
	gi
 = 0; i <= 2; i++) {

106 
	gj
 = 0; j <= 2; j++) {

107 
	gd
[
i
][
j
] = 0;

108 
	gk
 = 0; k <= 2; k++) {

109 
	gd
[
i
][
j
] = (
a
[i][
k
] * 
b
[k][j] + 
d
[i][j]è% 
m
;

113 
m_cİy
(
d
, 
c
);

	@src/utils/DistributionTypes.h

1 #iâdeà
DISTRIBUTION_TYPES


2 
	#DISTRIBUTION_TYPES


	)

4 
Çme¥aû
 
	gUts


6 şas 
	cAdd»ss_Di¡ributiÚ_Ty³
 { 
	gMIXED_STREAMING_RANDOM
, 
	gSTREAMING
, 
	gRANDOM_UNIFORM
, 
	gRANDOM_HOTCOLD
 };

7 şas 
	cReque¡_Size_Di¡ributiÚ_Ty³
 { 
	gFIXED
, 
	gNORMAL
 };

8 şas 
	cWÜklßd_Ty³
 { 
	gSYNTHETIC
, 
	gTRACE_BASED
 };

9 şas 
	cReque¡_G’”©Ü_Ty³
 { 
	gBANDWIDTH
, 
	gQUEUE_DEPTH
 };

	@src/utils/Helper_Functions.cpp

1 
	~"H–³r_FunùiÚs.h
"

2 
	~<cm©h
>

4 
Çme¥aû
 
	gUts


6 
Combš©iÚ_couÁ
(
n
, 
k
)

8 ià(
	gk
 > 
	gn
) {

12 ià(
	gk
 * 2 > 
	gn
) {

13 
	gk
 = 
n
 - 
k
;

16 ià(
	gk
 == 0) {

20 
	g»suÉ
 = 
n
;

21 
	gi
 = 2; i <ğ
k
; ++i) {

22 
	g»suÉ
 *ğ(
n
 - 
i
 + 1);

23 
	g»suÉ
 /ğ
i
;

26  
	g»suÉ
;

29 
Combš©iÚ_couÁ
(
n
, 
k
)

31  
Combš©iÚ_couÁ
((
n
), (
k
));

35 
EuËr_e¡im©iÚ
(
¡d
::
veùÜ
<>& 
mu
, 
b
, 
rho
, 
d
, 
h
, 
max_diff
, 
™r_max
)

37 
	g¡d
::
veùÜ
<> 
w_0
, 
	gw
;

38 
	gi
 = 0; i <ğ
mu
.
size
(); i++) {

39 ià(
	gi
 == 0) {

40 
w_0
.
push_back
(1);

41 
	gw
.
push_back
(1);

43 
	gw_0
.
push_back
(0);

44 
	gw
.
push_back
(0);

45 
	gj
 = 
i
; j < 
	gmu
.
size
(); j++)

46 
	gw_0
[
i
] +ğ
mu
[
j
];

50 
	gt
 = 
h
;

51 
	g™r
 = 0;

52 
	gdiff
 = 100000000000000;

53 
	g™r
 < 
	g™r_max
 && 
	gdiff
 > 
	gmax_diff
) {

54 
	gsigma
 = 0;

55 
	gj
 = 1; j <ğ
b
; j++) {

56 
	gsigma
 +ğ
¡d
::
pow
(
w_0
[
j
], 
d
);

59 
	gi
 = 1; i < 
	gb
; i++) {

60 
	gw
[
i
] = 
w_0
[i] + 
h
 * (1 - 
¡d
::
pow
(w_0[i], 
d
è- (
	gb
 - 
	gsigma
è* ((
	gi
 * (
	gw_0
[i] - w_0[˜+ 1])è/ (
b
 * 
	grho
)));

63 
	gdiff
 = 
¡d
::
abs
(
w
[0] - 
w_0
[0]);

64 
	gi
 = 1; i <ğ
b
; i++) {

65 ià(
	g¡d
::
abs
(
w
[
i
] - 
w_0
[i]è> 
diff
) {

66 
diff
 = 
¡d
::
abs
(
w
[
i
] - 
w_0
[i]);

70 
	gi
 = 1; i < 
	gw_0
.
size
(); i++) {

71 
	gw_0
[
i
] = 
w
[i];

74 
	gt
 +ğ
h
;

75 
	g™r
++;

78 
	gi
 = 0; i <ğ
b
; i++) {

79 
	gmu
[
i
] = 
w_0
[i] - w_0[i + 1];

	@src/utils/Helper_Functions.h

1 #iâdeà
HELPER_FUNCTIONS_H


2 
	#HELPER_FUNCTIONS_H


	)

3 
	~<veùÜ
>

5 
Çme¥aû
 
	gUts


7 
Combš©iÚ_couÁ
(
n
, 
k
);

8 
Combš©iÚ_couÁ
(
n
, 
k
);

9 
EuËr_e¡im©iÚ
(
¡d
::
veùÜ
<>& 
mu
, 
b
, 
rho
, 
d
, 
h
, 
max_diff
, 
™r_max
);

11 şas 
	cH–³r_FunùiÚs


13 
	gpublic
:

	@src/utils/Logical_Address_Partitioning_Unit.cpp

1 
	~"Logiÿl_Add»ss_P¬t™iÚšg_Un™.h
"

4 
Çme¥aû
 
	gUts


6 **** 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
»sourû_li¡
;

7 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_chªÃl_ID_ty³
>> 
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_chªÃl_ids
;

8 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_ch_ID_ty³
>> 
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_ch_ids
;

9 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_d›_ID_ty³
>> 
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_d›_ids
;

10 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_¶ªe_ID_ty³
>> 
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_¶ªe_ids
;

11 
Ho¡IÁ”çû_Ty³s
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
ho¡š‹rçû_ty³
;

12 
boŞ
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
š™Ÿlized
 = 
çl£
;

13 
	g¡d
::
veùÜ
<
LHA_ty³
> 
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
pdas_³r_æow
;

14 
	g¡d
::
veùÜ
<
LHA_ty³
> 
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡¬t_lhas_³r_æow
;

15 
	g¡d
::
veùÜ
<
LHA_ty³
> 
Logiÿl_Add»ss_P¬t™iÚšg_Un™
::
’d_lhas_³r_æow
;

16 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
chªÃl_couÁ
;

17 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
ch_no_³r_chªÃl
;

18 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
d›_no_³r_ch
;

19 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¶ªe_no_³r_d›
;

20 
LHA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
tÙ®_pda_no
 = 0;

21 
LHA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
tÙ®_lha_no
 = 0;

23 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
Re£t
()

25 
š™Ÿlized
 = 
çl£
;

26 
	gpdas_³r_æow
.
ş—r
();

27 
	g¡¬t_lhas_³r_æow
.
ş—r
();

28 
	g’d_lhas_³r_æow
.
ş—r
();

29 
	g¡»am_chªÃl_ids
.
ş—r
();

30 
	g¡»am_ch_ids
.
ş—r
();

31 
	g¡»am_d›_ids
.
ş—r
();

32 
	g¡»am_¶ªe_ids
.
ş—r
();

34 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

35 
æash_ch_ID_ty³
 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

36 
æash_d›_ID_ty³
 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

37 
	gd–‘e
[] 
	g»sourû_li¡
[
chªÃl_id
][
ch_id
][
d›_id
];

39 
	gd–‘e
[] 
	g»sourû_li¡
[
chªÃl_id
][
ch_id
];

41 
	gd–‘e
[] 
	g»sourû_li¡
[
chªÃl_id
];

44 
	gd–‘e
[] 
	g»sourû_li¡
;

47 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
AÎoÿ‹_logiÿl_add»ss_fÜ_æows
(
Ho¡IÁ”çû_Ty³s
 
ho¡š‹rçû_ty³
, 
cÚcu¼’t_¡»am_no
,

48 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

49 
¡d
::
veùÜ
<¡d::veùÜ<
æash_chªÃl_ID_ty³
>> 
¡»am_chªÃl_ids
, std::veùÜ<¡d::veùÜ<
æash_ch_ID_ty³
>> 
¡»am_ch_ids
,

50 
¡d
::
veùÜ
<¡d::veùÜ<
æash_d›_ID_ty³
>> 
¡»am_d›_ids
, std::veùÜ<¡d::veùÜ<
æash_¶ªe_ID_ty³
>> 
¡»am_¶ªe_ids
,

51 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
£ùÜ_no_³r_·ge
, 
ov”´ovisiÚšg_¿tio
)

53 ià(
	gš™Ÿlized
) {

57 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
ho¡š‹rçû_ty³
 = hostinterface_type;

59 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
chªÃl_couÁ
 = channel_count;;

60 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
ch_no_³r_chªÃl
 = chip_no_per_channel;

61 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
d›_no_³r_ch
 = die_no_per_chip;

62 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¶ªe_no_³r_d›
 =…lane_no_per_die;

64 
	g»sourû_li¡
 = 
Ãw
 ***[
chªÃl_couÁ
];

65 
boŞ
 
	g»sourû_sh¬šg
 = 
çl£
;

66 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = 0; chªÃl_id < 
	gchªÃl_couÁ
; channel_id++) {

67 
	g»sourû_li¡
[
chªÃl_id
] = 
Ãw
 **[
ch_no_³r_chªÃl
];

68 
æash_ch_ID_ty³
 
	gch_id
 = 0; ch_id < 
	gch_no_³r_chªÃl
; chip_id++) {

69 
	g»sourû_li¡
[
chªÃl_id
][
ch_id
] = 
Ãw
 *[
d›_no_³r_ch
];

70 
æash_d›_ID_ty³
 
	gd›_id
 = 0; d›_id < 
	gd›_no_³r_ch
; die_id++) {

71 
	g»sourû_li¡
[
chªÃl_id
][
ch_id
][
d›_id
] = 
Ãw
 [
¶ªe_no_³r_d›
];

72 
æash_¶ªe_ID_ty³
 
	g¶ªe_id
 = 0;…ÏÃ_id < 
	g¶ªe_no_³r_d›
;…lane_id++) {

73 
	g»sourû_li¡
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
] = 0;

79 
	g¡»am_id
 = 0; sŒ—m_id < 
	gcÚcu¼’t_¡»am_no
; stream_id++)

81 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = 0; chªÃl_id < 
	g¡»am_chªÃl_ids
[
¡»am_id
].
size
(); channel_id++) {

82 
æash_ch_ID_ty³
 
	gch_id
 = 0; ch_id < 
	g¡»am_ch_ids
[
¡»am_id
].
size
(); chip_id++) {

83 
æash_d›_ID_ty³
 
	gd›_id
 = 0; d›_id < 
	g¡»am_d›_ids
[
¡»am_id
].
size
(); die_id++) {

84 
æash_¶ªe_ID_ty³
 
	g¶ªe_id
 = 0;…ÏÃ_id < 
	g¡»am_¶ªe_ids
[
¡»am_id
].
size
();…lane_id++) {

85 ià(!(
	g¡»am_chªÃl_ids
[
¡»am_id
][
chªÃl_id
] < 
	gchªÃl_couÁ
)) {

86 
PRINT_ERROR
("Inv®id chªÃÈID s³cif›d fÜ I/O flow " << 
¡»am_id
);

89 ià(!(
	g¡»am_ch_ids
[
¡»am_id
][
ch_id
] < 
	gch_no_³r_chªÃl
)) {

90 
PRINT_ERROR
("Inv®id ch ID s³cif›d fÜ I/O flow " << 
¡»am_id
);

93 ià(!(
	g¡»am_d›_ids
[
¡»am_id
][
d›_id
] < 
	gd›_no_³r_ch
)) {

94 
PRINT_ERROR
("Inv®id d› ID s³cif›d fÜ I/O flow " << 
¡»am_id
);

97 ià(!(
	g¡»am_¶ªe_ids
[
¡»am_id
][
¶ªe_id
] < 
	g¶ªe_no_³r_d›
)) {

98 
PRINT_ERROR
("Inv®id…ÏÃ ID s³cif›d fÜ I/O flow " << 
¡»am_id
);

100 ++
	g»sourû_li¡
[
¡»am_chªÃl_ids
[
¡»am_id
][
chªÃl_id
]][
¡»am_ch_ids
[¡»am_id][
ch_id
]][
¡»am_d›_ids
[¡»am_id][
d›_id
]][
¡»am_¶ªe_ids
[¡»am_id][
¶ªe_id
]];

111 
	g¡»am_id
 = 0; sŒ—m_id < 
	gcÚcu¼’t_¡»am_no
; stream_id++)

113 
	g¡d
::
veùÜ
<
æash_chªÃl_ID_ty³
> 
chªÃl_ids
;

114 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_chªÃl_ids
.
push_back
(
chªÃl_ids
);

116 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = 0; chªÃl_id < 
	g¡»am_chªÃl_ids
[
¡»am_id
].
size
(); channel_id++) {

118 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_chªÃl_ids
[
¡»am_id
].
push_back
(¡»am_chªÃl_ids[¡»am_id][
chªÃl_id
]);

122 
	g¡d
::
veùÜ
<
æash_ch_ID_ty³
> 
ch_ids
;

123 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_ch_ids
.
push_back
(
ch_ids
);

124 
æash_ch_ID_ty³
 
	gch_id
 = 0; ch_id < 
	g¡»am_ch_ids
[
¡»am_id
].
size
(); chip_id++) {

126 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_ch_ids
[
¡»am_id
].
push_back
(¡»am_ch_ids[¡»am_id][
ch_id
]);

130 
	g¡d
::
veùÜ
<
æash_d›_ID_ty³
> 
d›_ids
;

131 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_d›_ids
.
push_back
(
d›_ids
);

132 
æash_d›_ID_ty³
 
	gd›_id
 = 0; d›_id < 
	g¡»am_d›_ids
[
¡»am_id
].
size
(); die_id++) {

133 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_d›_ids
[
¡»am_id
].
push_back
(¡»am_d›_ids[¡»am_id][
d›_id
]);

136 
	g¡d
::
cout
<<
¡d
::
’dl
;

137 
	g¡d
::
veùÜ
<
æash_¶ªe_ID_ty³
> 
¶ªe_ids
;

138 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_¶ªe_ids
.
push_back
(
¶ªe_ids
);

139 
æash_¶ªe_ID_ty³
 
	g¶ªe_id
 = 0;…ÏÃ_id < 
	g¡»am_¶ªe_ids
[
¡»am_id
].
size
();…lane_id++) {

140 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
¡»am_¶ªe_ids
[
¡»am_id
].
push_back
(¡»am_¶ªe_ids[¡»am_id][
¶ªe_id
]);

146 
	g¡d
::
veùÜ
<
LHA_ty³
> 
l§_couÁ_³r_¡»am
;

147 
	g¡»am_id
 = 0; sŒ—m_id < 
	gcÚcu¼’t_¡»am_no
; stream_id++) {

148 
LHA_ty³
 
	gl§_couÁ
 = 0;

149 
æash_chªÃl_ID_ty³
 
	gchªÃl_id
 = 0; chªÃl_id < 
	g¡»am_chªÃl_ids
[
¡»am_id
].
size
(); channel_id++) {

150 
æash_ch_ID_ty³
 
	gch_id
 = 0; ch_id < 
	g¡»am_ch_ids
[
¡»am_id
].
size
(); chip_id++) {

151 
æash_d›_ID_ty³
 
	gd›_id
 = 0; d›_id < 
	g¡»am_d›_ids
[
¡»am_id
].
size
(); die_id++) {

152 
æash_¶ªe_ID_ty³
 
	g¶ªe_id
 = 0;…ÏÃ_id < 
	g¡»am_¶ªe_ids
[
¡»am_id
].
size
();…lane_id++) {

153 
	gl§_couÁ
 +ğ(
LHA_ty³
)((
block_no_³r_¶ªe
 * 
·ge_no_³r_block
 * 
£ùÜ_no_³r_·ge
 * (1.0 - 
ov”´ovisiÚšg_¿tio
) *

154 1.0 / (
»sourû_li¡
[
¡»am_chªÃl_ids
[
¡»am_id
][
chªÃl_id
]][
¡»am_ch_ids
[¡»am_id][
ch_id
]][
¡»am_d›_ids
[¡»am_id][
d›_id
]][
¡»am_¶ªe_ids
[¡»am_id][
¶ªe_id
]])));

160 
	gpdas_³r_æow
.
push_back
(
LHA_ty³
((
l§_couÁ
è/ (1.0 - 
ov”´ovisiÚšg_¿tio
)));

161 
	gtÙ®_pda_no
 +ğ
pdas_³r_æow
[
¡»am_id
];

162 
	gl§_couÁ_³r_¡»am
.
push_back
(
l§_couÁ
);

165 
	gtÙ®_lha_no
 = 0;

166 
	g¡»am_id
 = 0; sŒ—m_id < 
	gcÚcu¼’t_¡»am_no
; stream_id++) {

167 
	g¡¬t_lhas_³r_æow
.
push_back
(
tÙ®_lha_no
);

168 
	g’d_lhas_³r_æow
.
push_back
(
tÙ®_lha_no
 + 
l§_couÁ_³r_¡»am
[
¡»am_id
] - 1);

169 
	gtÙ®_lha_no
 +ğ
l§_couÁ_³r_¡»am
[
¡»am_id
];

172 
	gš™Ÿlized
 = 
Œue
;

175 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
G‘_sh¬e_of_physcŸl_·ges_š_¶ªe
(
æash_chªÃl_ID_ty³
 
chªÃl_id
, 
æash_ch_ID_ty³
 
ch_id
, 
æash_d›_ID_ty³
 
d›_id
, 
æash_¶ªe_ID_ty³
 
¶ªe_id
)

177 
	gho¡š‹rçû_ty³
) {

178 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

179  1.0 / (
»sourû_li¡
[
chªÃl_id
][
ch_id
][
d›_id
][
¶ªe_id
]);

180 
	gHo¡IÁ”çû_Ty³s
::
SATA
:

188 
LHA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
S¹_lha_avaabË_to_æow
(
¡»am_id_ty³
 
¡»am_id
)

190 ià(
š™Ÿlized
) {

191 
ho¡š‹rçû_ty³
) {

192 
Ho¡IÁ”çû_Ty³s
::
SATA
:

193  
¡¬t_lhas_³r_æow
[
¡»am_id
];

195 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

196  
¡¬t_lhas_³r_æow
[
¡»am_id
];

203 
PRINT_ERROR
("The‡ddress…artitioning unit is‚ot initialized!")

206 
LHA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
End_lha_avaabË_to_æow
(
¡»am_id_ty³
 
¡»am_id
)

208 ià(
š™Ÿlized
) {

209 
ho¡š‹rçû_ty³
) {

210 
Ho¡IÁ”çû_Ty³s
::
SATA
:

211  
’d_lhas_³r_æow
[
¡»am_id
];

213 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

214  
’d_lhas_³r_æow
[
¡»am_id
];

220 
PRINT_ERROR
("The‡ddress…artitioning unit is‚ot initialized!")

223 
LHA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
LHA_couÁ_®loÿ‹_to_æow_äom_ho¡_v›w
(
¡»am_id_ty³
 
¡»am_id
)

225 ià(
š™Ÿlized
) {

226 
ho¡š‹rçû_ty³
) {

227 
Ho¡IÁ”çû_Ty³s
::
SATA
:

228  (
’d_lhas_³r_æow
[
¡»am_id
] - 
¡¬t_lhas_³r_æow
[stream_id] + 1);

230 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

231  (
’d_lhas_³r_æow
[
¡»am_id
] - 
¡¬t_lhas_³r_æow
[stream_id] + 1);

237 
PRINT_ERROR
("The‡ddress…artitioning unit is‚ot initialized!")

240 
LHA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
LHA_couÁ_®loÿ‹_to_æow_äom_deviû_v›w
(
¡»am_id_ty³
 
¡»am_id
)

242 ià(
š™Ÿlized
) {

243 
ho¡š‹rçû_ty³
) {

244 
Ho¡IÁ”çû_Ty³s
::
SATA
:

245  
tÙ®_lha_no
;

247 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

248  (
’d_lhas_³r_æow
[
¡»am_id
] - 
¡¬t_lhas_³r_æow
[stream_id] + 1);

254 
PRINT_ERROR
("The‡ddress…artitioning unit is‚ot initialized!")

257 
PDA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
PDA_couÁ_®loÿ‹_to_æow
(
¡»am_id_ty³
 
¡»am_id
)

259 ià(
š™Ÿlized
) {

260 
ho¡š‹rçû_ty³
) {

261 
Ho¡IÁ”çû_Ty³s
::
SATA
:

262  
tÙ®_pda_no
;

263 
	gHo¡IÁ”çû_Ty³s
::
NVME
:

264  
pdas_³r_æow
[
¡»am_id
];

270 
PRINT_ERROR
("The‡ddress…artitioning unit is‚ot initialized!")

273 
LHA_ty³
 
	gLogiÿl_Add»ss_P¬t™iÚšg_Un™
::
G‘_tÙ®_deviû_lha_couÁ
()

275  
tÙ®_lha_no
;

	@src/utils/Logical_Address_Partitioning_Unit.h

1 #iâdeà
LOGICAL_ADDRESS_PARTITIONING_UNIT_H


2 
	#LOGICAL_ADDRESS_PARTITIONING_UNIT_H


	)

4 
	~<veùÜ
>

5 
	~"../ssd/SSD_Defs.h
"

6 
	~"../ssd/Ho¡_IÁ”çû_Defs.h
"

13 
Çme¥aû
 
	gUts


15 şas 
	cLogiÿl_Add»ss_P¬t™iÚšg_Un™


17 
	gpublic
:

18 
Re£t
();

20 
AÎoÿ‹_logiÿl_add»ss_fÜ_æows
(
Ho¡IÁ”çû_Ty³s
 
ho¡š‹rçû_ty³
, 
cÚcu¼’t_¡»am_no
,

21 
chªÃl_couÁ
, 
ch_no_³r_chªÃl
, 
d›_no_³r_ch
, 
¶ªe_no_³r_d›
,

22 
¡d
::
veùÜ
<¡d::veùÜ<
æash_chªÃl_ID_ty³
>> 
¡»am_chªÃl_ids
, std::veùÜ<¡d::veùÜ<
æash_ch_ID_ty³
>> 
¡»am_ch_ids
,

23 
¡d
::
veùÜ
<¡d::veùÜ<
æash_d›_ID_ty³
>> 
¡»am_d›_ids
, std::veùÜ<¡d::veùÜ<
æash_¶ªe_ID_ty³
>> 
¡»am_¶ªe_ids
,

24 
block_no_³r_¶ªe
, 
·ge_no_³r_block
, 
£ùÜ_no_³r_·ge
, 
ov”´ovisiÚšg_¿tio
);

26 
LHA_ty³
 
S¹_lha_avaabË_to_æow
(
¡»am_id_ty³
 
¡»am_id
);

27 
LHA_ty³
 
End_lha_avaabË_to_æow
(
¡»am_id_ty³
 
¡»am_id
);

28 
LHA_ty³
 
LHA_couÁ_®loÿ‹_to_æow_äom_ho¡_v›w
(
¡»am_id_ty³
 
¡»am_id
);

29 
LHA_ty³
 
LHA_couÁ_®loÿ‹_to_æow_äom_deviû_v›w
(
¡»am_id_ty³
 
¡»am_id
);

30 
PDA_ty³
 
PDA_couÁ_®loÿ‹_to_æow
(
¡»am_id_ty³
 
¡»am_id
);

32 
G‘_sh¬e_of_physcŸl_·ges_š_¶ªe
(
æash_chªÃl_ID_ty³
 
chªÃl_id
, 
æash_ch_ID_ty³
 
ch_id
, 
æash_d›_ID_ty³
 
d›_id
, 
æash_¶ªe_ID_ty³
 
¶ªe_id
);

34 
LHA_ty³
 
G‘_tÙ®_deviû_lha_couÁ
();

35 
	g´iv©e
:

36 
Ho¡IÁ”çû_Ty³s
 
ho¡š‹rçû_ty³
;

37 ****
	g»sourû_li¡
;

38 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_chªÃl_ID_ty³
>> 
¡»am_chªÃl_ids
;

39 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_ch_ID_ty³
>> 
¡»am_ch_ids
;

40 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_d›_ID_ty³
>> 
¡»am_d›_ids
;

41 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
æash_¶ªe_ID_ty³
>> 
¡»am_¶ªe_ids
;

42 
boŞ
 
	gš™Ÿlized
;

43 
	g¡d
::
veùÜ
<
LHA_ty³
> 
pdas_³r_æow
;

44 
	g¡d
::
veùÜ
<
LHA_ty³
> 
¡¬t_lhas_³r_æow
;

45 
	g¡d
::
veùÜ
<
LHA_ty³
> 
’d_lhas_³r_æow
;

46 
LHA_ty³
 
	gtÙ®_pda_no
;

47 
LHA_ty³
 
	gtÙ®_lha_no
;

48 
	gchªÃl_couÁ
;

49 
	gch_no_³r_chªÃl
;

50 
	gd›_no_³r_ch
;

51 
	g¶ªe_no_³r_d›
;

	@src/utils/RandomGenerator.cpp

1 
	~"RªdomG’”©Ü.h
"

2 
	~<m©h.h
>

3 
	~<¡dexû±
>

5 
Çme¥aû
 
	gUts


7 
	gRªdomG’”©Ü
::
RªdomG’”©Ü
(
£ed
)

9 
¿nd
 = 
Ãw
 
CMRRªdomG’”©Ü
(
£ed
 / 200 + 1, seed % 200);

12 
ušt32_t
 
	gRªdomG’”©Ü
::
G‘_ušt
(ušt32_ˆ
maxV®ue
)

14 
ušt32_t
 
v
 = (ušt32_t)(
FlßtRªdom
(è* (
maxV®ue
 + 1));

15  
	gv
;

18 
št32_t
 
	gRªdomG’”©Ü
::
G‘_št
(št32_ˆ
maxV®ue
)

20 
št32_t
 
v
 = (št32_t)(
FlßtRªdom
(è* (
maxV®ue
 + 1));

21  
	gv
;

24 
	gRªdomG’”©Ü
::
FlßtRªdom
()

26  
¿nd
->
NextDoubË
();

29 
	gRªdomG’”©Ü
::
UnifÜm
(
a
, 
b
)

31  
	ga
 + (
	gb
 -‡è* 
FlßtRªdom
();

38 
ušt32_t
 
	gRªdomG’”©Ü
::
UnifÜm_ušt
(ušt32_ˆ
m
, ušt32_ˆ
n
)

40  
	gm
 + (
	gušt32_t
)((
	gn
 - m + 1.0è* 
FlßtRªdom
());

43 
št64_t
 
	gRªdomG’”©Ü
::
UnifÜm_lÚg
(št64_ˆ
m
, iÁ64_ˆ
n
)

45  
	gm
 + (
	gšt64_t
)(()(
	gn
 - m + 1è* 
FlßtRªdom
());

48 
ušt64_t
 
	gRªdomG’”©Ü
::
UnifÜm_ulÚg
(ušt64_ˆ
m
, ušt64_ˆ
n
)

50  
	gm
 + (
	gušt64_t
)(()(
	gn
 - m + 1è* 
FlßtRªdom
());

57 
	gRªdomG’”©Ü
::
ExpÚ’tŸl
(
m—n
)

59  0-
m—n
 * 
log
(
FlßtRªdom
());

66 
	gRªdomG’”©Ü
::
E¾ªg
(
x
, 
s
)

68 
št64_t
 
	gi
, 
	gk
;

69 
	gz
;

70 
	gz
 = 
x
 / 
s
;

71 
	gk
 = (
ušt64_t
)(
z
 * z);

72 
	gz
 = 1.0;

73 
	gi
 = 0; i < 
	gk
; i++) {

74 
	gz
 *ğ
FlßtRªdom
();

76  -(
	gx
 / (è
	gk
è* 
log
(
z
);

83 
	gRªdomG’”©Ü
::
Hy³rExpÚ’tŸl
(
x
, 
s
)

85 ià(
	gs
 < 
	gx
) {

86 
throw
 
	g¡d
::
logic_”rÜ
("RandomGenerator::HyperExponential: Mean must be greaterhan standard deviation.");

89 
	gcv
, 
	gz
, 
	gp
;

90 
	gcv
 = 
s
 / 
x
;

91 
	gz
 = 
cv
 * cv;

92 
	gp
 = 0.5 * (1.0 - 
sq¹
((
z
 - 1.0) / (z + 1.0)));

93 
	gz
 = (
FlßtRªdom
(è> 
p
è? (
x
 / (1.0 -…)) : (x /…);

94  -0.5 * 
z
 * 
log
(
FlßtRªdom
());

101 
	gRªdomG’”©Ü
::
NÜm®
(
x
, 
s
)

103 
	gv1
, 
	gv2
, 
	gw
, 
	gz1
;

104 ià(
	gNÜm®_z2
 != 0.0) {

106 
z1
 = 
NÜm®_z2
;

107 
	gNÜm®_z2
 = 0.0;

110 
	gv1
 = 2.0 * 
FlßtRªdom
() - 1.0;

111 
	gv2
 = 2.0 * 
FlßtRªdom
() - 1.0;

112 
	gw
 = 
v1
 * v1 + 
v2
 * v2;

113 } 
	gw
 >= 1.0);

115 
	gw
 = 
sq¹
((-2.0*
log
(
w
)) / w);

116 
	gz1
 = 
v1
 * 
w
;

117 
	gNÜm®_z2
 = 
v2
 * 
w
;

120  
	gx
 + 
z1
 * 
	gs
;

127 
	gRªdomG’”©Ü
::
LogNÜm®
(
x
, 
s
)

129  
exp
(
NÜm®
(
x
, 
s
));

137 
št64_t
 
	gRªdomG’”©Ü
::
Geom‘ric0
(
x
)

139 
p
 = 1 / 
x
;

140 
št64_t
 
	gi
 = 0;

141 
FlßtRªdom
(è< 
	gp
) {

142 ++
	gi
;

145  
	gi
;

148 
št64_t
 
	gRªdomG’”©Ü
::
Geom‘ric1
(
x
)

150  
Geom‘ric0
(
x
) + 1;

157 
	gRªdomG’”©Ü
::
Hy³r_geom‘ric
(
x
, 
s
)

159 
	gsq¹z
 = 
s
 / 
x
;

160 
	gz
 = 
sq¹z
 * sqrtz;

161 
	gp
 = 0.5 * (1 - 
sq¹
((
z
 - 1) / (z + 1)));

162 
	gd
 = (
FlßtRªdom
(è> 
p
) ? (1 -…) :…;

164  -
x
 * 
log
(
FlßtRªdom
()è/ (2 * 
	gd
);

172 
št64_t
 
	gRªdomG’”©Ü
::
BšomŸl
(št64_ˆ
n
, 
u
)

174 
št64_t
 
	gk
 = 0;

175 
	gi
 = 0; i < 
	gn
; i++) {

176 ià(
FlßtRªdom
(è< 
	gu
) {

177 ++
	gk
;

181  
	gk
;

188 
št64_t
 
	gRªdomG’”©Ü
::
PoissÚ
(
x
)

190 
b
 = 
exp
(-
x
);

191 
št64_t
 
	gk
 = 0;

192 
	gp
 = 1;

193 
	gp
 >ğ
b
) {

194 ++
k
;

195 
	gp
 *ğ
FlßtRªdom
();

198  
	gk
 - 1;

205 
	gRªdomG’”©Ü
::
WeibuÎ
(
®pha
, 
b‘a
)

207  
pow
(-
b‘a
 * 
log
(1 - 
FlßtRªdom
()), 1 / 
®pha
);

214 
	gRªdomG’”©Ü
::
P¬‘o
(
®pha
, 
b‘a
)

216  
b‘a
 * 
pow
(
FlßtRªdom
(), -1.0 / 
®pha
);

224 
	gRªdomG’”©Ü
::
Inv”£
(
mš
, 
max
)

226  
mš
*
exp
(
FlßtRªdom
()*
log
(
max
 / min));

234 
	gRªdomG’”©Ü
::
TrŸnguÏr
(
mš
, 
middË
, 
max
)

236 
	gy
 = 
FlßtRªdom
();

237 ià(
	gy
 <ğ(
middË
 - 
mš
è/ (
max
 - min)) {

238  
mš
 + 
sq¹
(
y
*
max
*
middË
 - y*max*min - y*min*middle + y*min*min);

240  
	gmax
 - 
sq¹
(
max
*max + 
y
*max*
middË
 - y*max*max - y*
mš
*middle + y*max*min - max*min - max*middle + min*middle);

	@src/utils/RandomGenerator.h

1 #iâdeà
RANDOM_GENERATOR


2 
	#RANDOM_GENERATOR


	)

4 
	~<c¡dšt
>

5 
	~"CMRRªdomG’”©Ü.h
"

7 
Çme¥aû
 
	gUts


9 şas 
	cRªdomG’”©Ü


11 
	gpublic
:

12 
RªdomG’”©Ü
();

13 
ušt32_t
 
G‘_ušt
(ušt32_ˆ
max_v®ue
);

14 
št32_t
 
G‘_št
(št32_ˆ
max_v®ue
);

15 
FlßtRªdom
();

16 
UnifÜm
(
a
, 
b
);

17 
ušt32_t
 
UnifÜm_ušt
(ušt32_ˆ
m
, ušt32_ˆ
n
);

18 
št64_t
 
UnifÜm_lÚg
(št64_ˆ
m
, iÁ64_ˆ
n
);

19 
ušt64_t
 
UnifÜm_ulÚg
(ušt64_ˆ
m
, ušt64_ˆ
n
);

20 
ExpÚ’tŸl
(
m—n
);

21 
E¾ªg
(
x
, 
s
);

22 
Hy³rExpÚ’tŸl
(
x
, 
s
);

23 
NÜm®
(
x
, 
s
);

24 
LogNÜm®
(
x
, 
s
);

25 
št64_t
 
Geom‘ric0
(
x
);

26 
št64_t
 
Geom‘ric1
(
x
);

27 
Hy³r_geom‘ric
(
x
, 
s
);

28 
št64_t
 
BšomŸl
(št64_ˆ
n
, 
u
);

29 
št64_t
 
PoissÚ
(
x
);

30 
WeibuÎ
(
®pha
, 
b‘a
);

31 
P¬‘o
(
®pha
, 
b‘a
);

32 
Inv”£
(
mš
, 
max
);

33 
TrŸnguÏr
(
mš
, 
middË
, 
max
);

34 
	g´iv©e
:

35 
CMRRªdomG’”©Ü
* 
¿nd
;

36 
	g£ed
;

37 
	gNÜm®_z2
;

	@src/utils/StringTools.cpp

1 
	~<io¡»am
>

2 
	~<s¡»am
>

3 
	~"SŒšgToŞs.h
"

5 
Çme¥aû
 
	gUts


	@src/utils/StringTools.h

1 #iâdeà
STRING_TOOLS_H


2 
	#STRING_TOOLS_H


	)

4 
	~<¡ršg
>

5 
	~<veùÜ
>

6 
	~<f¡»am
>

8 
Çme¥aû
 
	gUts


10 şas 
	cH–³r_FunùiÚs


12 
	gpublic
:

13 
¡d
::
¡ršg
 
P©h_£·¿tÜ
()

15 #ifdeà
_WIN32


21 
Tok’ize
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
, 
d–im™”
, std::
veùÜ
<¡d::¡ršg>& 
ouut_tok’s_li¡
)

23 
size
 = (è
¡r
.size();

24 
	g¡¬t
 = 0, 
	g’d
 = 0;

25 
	g’d
 < 
	gsize
) {

26 ià(
	g¡r
[
’d
] =ğ
d–im™”
 && 
¡¬t
 <=ƒnd) {

27 
ouut_tok’s_li¡
.
push_back
(
¡d
::
¡ršg
(
¡r
.
sub¡r
(
¡¬t
, 
’d
 - start + 1)));

28 
	g¡¬t
 = 
’d
 + 1;

30 
	g’d
++;

32 ià(
	g¡r
[
’d
 - 1] !ğ
d–im™”
) {

33 
ouut_tok’s_li¡
.
push_back
(
¡d
::
¡ršg
(
¡r
.
sub¡r
(
¡¬t
, 
’d
 - start)));

37 
Remove_ü
(
¡d
::
¡ršg
& 
¡r
)

39 ià(
¡r
[¡r.
size
() - 1] == '\r') {

40 
¡r
.
”a£
(¡r.
size
() - 1, 1);

	@src/utils/Workload_Statistics.h

1 #iâdeà
WORKLOAD_STATISTICS_H


2 
	#WORKLOAD_STATISTICS_H


	)

4 
	~<m­
>

5 
	~<veùÜ
>

6 
	~<£t
>

7 
	~<c¡dšt
>

8 
	~"../sim/Sim_Defs.h
"

9 
	~"../ssd/SSD_Defs.h
"

10 
	~"../uts/Di¡ributiÚTy³s.h
"

12 
Çme¥aû
 
	gUts


14 
	#MAX_REQSIZE_HISTOGRAM_ITEMS
 1024

	)

15 
	#MAX_ARRIVAL_TIME_HISTOGRAM
 (1000000)

	)

16 
	#MIN_HOT_REGION_TRAFFIC_RATIO
 0.5

	)

17 
	#HOT_REGION_METRIC
 2.5

	)

18 
	#STATISTICALLY_SUFFICIENT_WRITES_FOR_PRECONDITIONING
 10000

	)

20 
	sAdd»ss_Hi¡og¿m_Un™


22 
	gAcûss_couÁ
;

23 
ušt64_t
 
	gAcûs£d_sub_un™s
;

27 
	sWÜklßd_Sti¡ics


29 
	gUts
::
WÜklßd_Ty³
 
Ty³
;

30 
¡»am_id_ty³
 
	gSŒ—m_id
;

31 
	gIn™Ÿl_occu·ncy_¿tio
;

32 
	gR•Ïy_no
;

33 
	gTÙ®_g’”©ed_»qeu¡s
;

35 
	g¿ndom_»que¡_ty³_g’”©Ü_£ed
;

36 
	gR—d_¿tio
;

37 
	g¡d
::
veùÜ
<
sim_time_ty³
> 
Wr™e_¬riv®_time
, 
	gR—d_¬riv®_time
;

39 
	gUts
::
Add»ss_Di¡ributiÚ_Ty³
 
Add»ss_di¡ributiÚ_ty³
;

40 
	gWÜkšg_£t_¿tio
;

41 
	gTÙ®_acûs£d_lbas
;

46 
	gR©io_of_hÙ_add»s£s_to_whŞe_wÜkšg_£t
;

47 
	gR©io_of_Œaffic_acûssšg_hÙ_»giÚ
;

48 
	g¿ndom_add»ss_g’”©Ü_£ed
;

49 
	g¿ndom_hÙ_cŞd_g’”©Ü_£ed
;

50 
	g¿ndom_hÙ_add»ss_g’”©Ü_£ed
;

51 
	g¡d
::
m­
<
LPA_ty³
, 
	gAdd»ss_Hi¡og¿m_Un™
> 
	gWr™e_add»ss_acûss_·‰”n
, 
	gR—d_add»ss_acûss_·‰”n
;

52 
	g¡d
::
£t
<
LPA_ty³
> 
Wr™e_»ad_sh¬ed_add»s£s
;

53 
LHA_ty³
 
	gFœ¡_Acûs£d_Add»ss
, 
	gLa¡_Acûs£d_Add»ss
, 
	gMš_LHA
, 
	gMax_LHA
;

54 
LHA_ty³
 
	ghÙ_»giÚ_’d_l§
;

55 
LHA_ty³
 
	g¡»amšg_Ãxt_add»ss
;

56 
boŞ
 
	gg’”©e_®igÃd_add»s£s
;

57 
	g®ignm’t_v®ue
;;

59 
	gUts
::
Reque¡_G’”©Ü_Ty³
 
g’”©Ü_ty³
;

60 
	gReque¡_queue_d•th
;

61 
	g¿ndom_time_š‹rv®_g’”©Ü_£ed
;

62 
sim_time_ty³
 
	gAv”age_š‹r_¬riv®_time_Çno_£c
;

64 
	gUts
::
Reque¡_Size_Di¡ributiÚ_Ty³
 
Reque¡_size_di¡ributiÚ_ty³
;

65 
	g¿ndom_»que¡_size_g’”©Ü_£ed
;

66 
	gAv”age_»que¡_size_£ùÜ
;

67 
	gSTDEV_»uqe¡_size
;

68 
	g¡d
::
veùÜ
<> 
Wr™e_size_hi¡og¿m
, 
	gR—d_size_hi¡og¿m
;

	@src/utils/XMLWriter.cpp

1 
	~"XMLWr™”.h
"

2 
	~"../sim/Engše.h
"

4 
Çme¥aû
 
	gUts


6 
boŞ
 
	gXmlWr™”
::
exi¡s
(cÚ¡ 
¡d
::
¡ršg
 
feName
) {

7 
¡d
::
f¡»am
 
checkFe
(
feName
);

8  
	gcheckFe
.
is_İ’
();

11 
boŞ
 
	gXmlWr™”
::
O³n
(cÚ¡ 
¡d
::
¡ršg
 
¡rFe
) {

13 
outFe
.
İ’
(
¡rFe
);

14 ià(
	goutFe
.
is_İ’
()) {

15 
	goutFe
 << "<?xml version=\"1.0\"ƒncoding=\"us-ascii\"?>\n";

16 
	gšd’t
 = 0;

17 
	gİ’Tags
 = 0;

18 
	gİ’EËm’ts
 = 0;

20  
	gŒue
;

23  
	gçl£
;

26 
	gXmlWr™”
::
Clo£
()

28 ià(
outFe
.
is_İ’
()) {

29 
outFe
.
şo£
();

33 
	gXmlWr™”
::
Wr™e_İ’_g
(cÚ¡ 
¡d
::
¡ršg
 
İ’Tag
) {

34 ià(
outFe
.
is_İ’
()) {

35 
i
 = 0; 
	gi
 < 
	gšd’t
; i++) {

36 
	goutFe
 << "\t";

38 
	g‹mpO³nTag
.
»size
(
İ’Tags
 + 1);

39 
	goutFe
 << "<" << 
	gİ’Tag
 << ">\n";

40 
	g‹mpO³nTag
[
İ’Tags
] = 
İ’Tag
;

41 
	gšd’t
 += 1;

42 
	gİ’Tags
 += 1;

44 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

48 
	gXmlWr™”
::
Wr™e_©Œibu‹_¡ršg
(cÚ¡ 
¡d
::
¡ršg
 
©Œibu‹_Çme
, cÚ¡ std::¡ršg 
©Œibu‹_v®ue
)

50 ià(
outFe
.
is_İ’
()) {

51 
i
 = 0; 
	gi
 < 
	gšd’t
 + 1; i++) {

52 
	goutFe
 << "\t";

55 
	goutFe
 << " <" << 
	g©Œibu‹_Çme
 + ">" + 
	g©Œibu‹_v®ue
 + "</" <<‡ttribute_name + ">\n";

57 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

61 
	gXmlWr™”
::
Wr™e_şo£_g
() {

62 ià(
outFe
.
is_İ’
()) {

63 
šd’t
 -= 1;

64 
	gi
 = 0; i < 
	gšd’t
; i++) {

65 
	goutFe
 << "\t";

67 
	goutFe
 << "</" << 
	g‹mpO³nTag
[
İ’Tags
 - 1] << ">\n";

68 
	g‹mpO³nTag
.
»size
(
İ’Tags
 - 1);

69 
	gİ’Tags
 -= 1;

71 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

75 
	gXmlWr™”
::
Wr™e_¡¬t_–em’t_g
(cÚ¡ 
¡d
::
¡ršg
 
–em’tTag
) {

76 ià(
outFe
.
is_İ’
()) {

77 
i
 = 0; 
	gi
 < 
	gšd’t
; i++) {

78 
	goutFe
 << "\t";

80 
	g‹mpEËm’tTag
.
»size
(
İ’EËm’ts
 + 1);

81 
	g‹mpEËm’tTag
[
İ’EËm’ts
] = 
–em’tTag
;

82 
	gİ’EËm’ts
 += 1;

83 
	goutFe
 << "<" << 
	g–em’tTag
;

85 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

89 
	gXmlWr™”
::
Wr™e_’d_–em’t_g
()

91 ià(
outFe
.
is_İ’
()) {

92 
outFe
 << "/>\n";

93 
	g‹mpEËm’tTag
.
»size
(
İ’EËm’ts
 - 1);

94 
	gİ’EËm’ts
 -= 1;

96 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

100 
	gXmlWr™”
::
Wr™e_©Œibu‹
(cÚ¡ 
¡d
::
¡ršg
 
outA‰ribu‹
)

102 ià(
outFe
.
is_İ’
()) {

103 
outFe
 << " " << 
outA‰ribu‹
;

105 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

109 
	gXmlWr™”
::
Wr™e_©Œibu‹_¡ršg_šlše
(cÚ¡ 
¡d
::
¡ršg
 
©Œibu‹_Çme
, cÚ¡ std::¡ršg 
©Œibu‹_v®ue
)

111 ià(
outFe
.
is_İ’
()) {

112 
outFe
 << " ";

113 
	goutFe
 << 
	g©Œibu‹_Çme
 + "=\"" + 
	g©Œibu‹_v®ue
 + "\"";

115 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

119 
	gXmlWr™”
::
Wr™e_¡ršg
(cÚ¡ 
¡d
::
¡ršg
 
outSŒšg
)

121 ià(
outFe
.
is_İ’
()) {

122 
outFe
 << ">" << 
outSŒšg
;

124 
PRINT_ERROR
("The XML output file is closed. Unableo writeo file");

	@src/utils/XMLWriter.h

1 #iâdeà
XMLWRITE_H


2 
	#XMLWRITE_H


	)

4 
	~<f¡»am
>

5 
	~<io¡»am
>

6 
	~<¡ršg
>

7 
	~<veùÜ
>

9 
Çme¥aû
 
	gUts


11 şas 
	cXmlWr™”
 {

12 
	gpublic
:

13 
boŞ
 
O³n
(cÚ¡ 
¡d
::
¡ršg
);

14 
Clo£
();

15 
boŞ
 
exi¡s
(cÚ¡ 
¡d
::
¡ršg
);

16 
Wr™e_İ’_g
(cÚ¡ 
¡d
::
¡ršg
);

17 
Wr™e_şo£_g
();

18 
Wr™e_¡¬t_–em’t_g
(cÚ¡ 
¡d
::
¡ršg
);

19 
Wr™e_’d_–em’t_g
();

20 
Wr™e_©Œibu‹
(cÚ¡ 
¡d
::
¡ršg
);

21 
Wr™e_¡ršg
(cÚ¡ 
¡d
::
¡ršg
);

22 
Wr™e_©Œibu‹_¡ršg
(cÚ¡ 
¡d
::
¡ršg
 
©Œibu‹_Çme
, cÚ¡ std::¡ršg 
©Œibu‹_v®ue
);

23 
Wr™e_©Œibu‹_¡ršg_šlše
(cÚ¡ 
¡d
::
¡ršg
 
©Œibu‹_Çme
, cÚ¡ std::¡ršg 
©Œibu‹_v®ue
);

24 
	g´iv©e
:

25 
¡d
::
of¡»am
 
outFe
;

26 
	gšd’t
;

27 
	gİ’Tags
;

28 
	gİ’EËm’ts
;

29 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
‹mpO³nTag
;

30 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
‹mpEËm’tTag
;

	@src/utils/rapidxml/rapidxml.hpp

1 #iâdeà
RAPIDXML_HPP_INCLUDED


2 
	#RAPIDXML_HPP_INCLUDED


	)

10 #ià!
defšed
(
RAPIDXML_NO_STDLIB
)

11 
	~<c¡dlib
>

12 
	~<ÿs£¹
>

13 
	~<Ãw
>

18 #ifdeà
_MSC_VER


19 #´agm¨
w¬nšg
(
push
)

20 #´agm¨
w¬nšg
(
di§bË
:4127)

26 #ià
defšed
(
RAPIDXML_NO_EXCEPTIONS
)

28 
	#RAPIDXML_PARSE_ERROR
(
wh©
, 
wh”e
è{ 
	`·r£_”rÜ_hªdËr
(wh©, wh”e); 
	`as£¹
(0); }

	)

30 
Çme¥aû
 
	g¿pidxml


48 
·r£_”rÜ_hªdËr
(cÚ¡ *
wh©
, *
wh”e
);

53 
	~<exû±iÚ
>

55 
	#RAPIDXML_PARSE_ERROR
(
wh©
, 
wh”e
è
throw
 
	`·r£_”rÜ
(wh©, wh”e)

	)

57 
Çme¥aû
 
	g¿pidxml


71 şas 
	c·r£_”rÜ
: 
public
 
¡d
::
exû±iÚ


74 
public
:

77 
·r£_”rÜ
(cÚ¡ *
wh©
, *
wh”e
)

78 : 
m_wh©
(
wh©
)

79 , 
m_wh”e
(
wh”e
)

85 
vœtu®
 cÚ¡ *
wh©
(ècÚ¡ 
throw
()

87  
	gm_wh©
;

93 
	g‹m¶©e
<
şass
 
	gCh
>

94 
Ch
 *
wh”e
() const

96  
	g»š‹½»t_ÿ¡
<
	gCh
 *>(
	gm_wh”e
);

99 
	g´iv©e
:

101 cÚ¡ *
m_wh©
;

102 *
	gm_wh”e
;

112 #iâdeà
RAPIDXML_STATIC_POOL_SIZE


116 
	#RAPIDXML_STATIC_POOL_SIZE
 (64 * 1024)

	)

119 #iâdeà
RAPIDXML_DYNAMIC_POOL_SIZE


123 
	#RAPIDXML_DYNAMIC_POOL_SIZE
 (64 * 1024)

	)

126 #iâdeà
RAPIDXML_ALIGNMENT


131 
	#RAPIDXML_ALIGNMENT
 (*)

	)

134 
Çme¥aû
 
	g¿pidxml


137 
	g‹m¶©e
<
şass
 
	gCh
> cÏs 
	gxml_node
;

138 
	g‹m¶©e
<
şass
 
	gCh
> cÏs 
	gxml_©Œibu‹
;

139 
	g‹m¶©e
<
şass
 
	gCh
> cÏs 
	gxml_docum’t
;

143 
	enode_ty³


145 
	gnode_docum’t
,

146 
	gnode_–em’t
,

147 
	gnode_d©a
,

148 
	gnode_cd©a
,

149 
	gnode_comm’t
,

150 
	gnode_deş¬©iÚ
,

151 
	gnode_doùy³
,

152 
	gnode_pi


163 cÚ¡ 
	g·r£_no_d©a_nodes
 = 0x1;

172 cÚ¡ 
	g·r£_no_–em’t_v®ues
 = 0x2;

179 cÚ¡ 
	g·r£_no_¡ršg_‹rmš©Üs
 = 0x4;

186 cÚ¡ 
	g·r£_no_’t™y_Œª¦©iÚ
 = 0x8;

193 cÚ¡ 
	g·r£_no_utf8
 = 0x10;

200 cÚ¡ 
	g·r£_deş¬©iÚ_node
 = 0x20;

207 cÚ¡ 
	g·r£_comm’t_nodes
 = 0x40;

215 cÚ¡ 
	g·r£_doùy³_node
 = 0x80;

222 cÚ¡ 
	g·r£_pi_nodes
 = 0x100;

230 cÚ¡ 
	g·r£_v®id©e_şosšg_gs
 = 0x200;

238 cÚ¡ 
	g·r£_Œim_wh™e¥aû
 = 0x400;

247 cÚ¡ 
	g·r£_nÜm®ize_wh™e¥aû
 = 0x800;

259 cÚ¡ 
	g·r£_deçuÉ
 = 0;

269 cÚ¡ 
	g·r£_nÚ_de¡ruùive
 = 
·r£_no_¡ršg_‹rmš©Üs
 | 
·r£_no_’t™y_Œª¦©iÚ
;

274 cÚ¡ 
	g·r£_ç¡e¡
 = 
·r£_nÚ_de¡ruùive
 | 
·r£_no_d©a_nodes
;

280 cÚ¡ 
	g·r£_fuÎ
 = 
·r£_deş¬©iÚ_node
 | 
·r£_comm’t_nodes
 | 
·r£_doùy³_node
 | 
·r£_pi_nodes
 | 
·r£_v®id©e_şosšg_gs
;

286 
Çme¥aû
 
	gš‹º®


291 
	g‹m¶©e
<
	gDummy
>

292 
	slookup_bËs


294 cÚ¡ 
	glookup_wh™e¥aû
[256];

295 cÚ¡ 
	glookup_node_Çme
[256];

296 cÚ¡ 
	glookup_‹xt
[256];

297 cÚ¡ 
	glookup_‹xt_pu»_no_ws
[256];

298 cÚ¡ 
	glookup_‹xt_pu»_w™h_ws
[256];

299 cÚ¡ 
	glookup_©Œibu‹_Çme
[256];

300 cÚ¡ 
	glookup_©Œibu‹_d©a_1
[256];

301 cÚ¡ 
	glookup_©Œibu‹_d©a_1_pu»
[256];

302 cÚ¡ 
	glookup_©Œibu‹_d©a_2
[256];

303 cÚ¡ 
	glookup_©Œibu‹_d©a_2_pu»
[256];

304 cÚ¡ 
	glookup_dig™s
[256];

305 cÚ¡ 
	glookup_upÿ£
[256];

309 
	g‹m¶©e
<
şass
 
	gCh
>

310 
šlše
 
	g¡d
::
size_t
 
m—su»
(cÚ¡ 
Ch
 *
p
)

312 cÚ¡ 
Ch
 *
tmp
 = 
p
;

313 *
	gtmp
)

314 ++
	gtmp
;

315  
	gtmp
 - 
	gp
;

319 
	g‹m¶©e
<
şass
 
	gCh
>

320 
šlše
 
boŞ
 
com·»
(cÚ¡ 
Ch
 *
p1
, 
¡d
::
size_t
 
size1
, cÚ¡ Ch *
p2
, std::size_ˆ
size2
, boŞ 
ÿ£_£ns™ive
)

322 ià(
	gsize1
 !ğ
size2
)

323  
çl£
;

324 ià(
	gÿ£_£ns™ive
)

326 cÚ¡ 
Ch
 *
	g’d
 = 
p1
 + 
size1
; 
	gp1
 <ƒnd; ++p1, ++
	gp2
)

327 ià(*
	gp1
 !ğ*
p2
)

328  
çl£
;

332 cÚ¡ 
Ch
 *
	g’d
 = 
p1
 + 
size1
; 
	gp1
 <ƒnd; ++p1, ++
	gp2
)

333 ià(
	glookup_bËs
<0>::
lookup_upÿ£
[
¡©ic_ÿ¡
<>(*
p1
)] !ğ
lookup_bËs
<0>::lookup_upÿ£[¡©ic_ÿ¡<>(*
p2
)])

334  
çl£
;

336  
	gŒue
;

378 
	g‹m¶©e
<
şass
 
	gCh
 = >

379 şas 
	cmemÜy_poŞ


382 
public
:

385 *(
	t®loc_func
)(
	t¡d
::
	tsize_t
);

386 (
	gä“_func
)(*);

390 
memÜy_poŞ
()

391 : 
m_®loc_func
(0)

392 , 
m_ä“_func
(0)

394 
š™
();

400 ~
memÜy_poŞ
()

402 
ş—r
();

415 
	gxml_node
<
	gCh
> *
®loÿ‹_node
(
node_ty³
 
ty³
,

416 cÚ¡ 
Ch
 *
Çme
 = 0, cÚ¡ Ch *
v®ue
 = 0,

417 
¡d
::
size_t
 
Çme_size
 = 0, std::size_ˆ
v®ue_size
 = 0)

419 *
memÜy
 = 
®loÿ‹_®igÃd
((
xml_node
<
Ch
>));

420 
	gxml_node
<
	gCh
> *
	gnode
 = 
Ãw
(
memÜy
è
xml_node
<
Ch
>(
ty³
);

421 ià(
	gÇme
)

423 ià(
	gÇme_size
 > 0)

424 
	gnode
->
Çme
Òame, 
Çme_size
);

426 
	gnode
->
Çme
(name);

428 ià(
	gv®ue
)

430 ià(
	gv®ue_size
 > 0)

431 
	gnode
->
v®ue
(v®ue, 
v®ue_size
);

433 
	gnode
->
v®ue
(value);

435  
	gnode
;

447 
	gxml_©Œibu‹
<
	gCh
> *
®loÿ‹_©Œibu‹
(cÚ¡ 
Ch
 *
Çme
 = 0, cÚ¡ Ch *
v®ue
 = 0,

448 
¡d
::
size_t
 
Çme_size
 = 0, std::size_ˆ
v®ue_size
 = 0)

450 *
memÜy
 = 
®loÿ‹_®igÃd
((
xml_©Œibu‹
<
Ch
>));

451 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
Ãw
(
memÜy
è
xml_©Œibu‹
<
Ch
>;

452 ià(
	gÇme
)

454 ià(
	gÇme_size
 > 0)

455 
	g©Œibu‹
->
Çme
Òame, 
Çme_size
);

457 
	g©Œibu‹
->
Çme
(name);

459 ià(
	gv®ue
)

461 ià(
	gv®ue_size
 > 0)

462 
	g©Œibu‹
->
v®ue
(v®ue, 
v®ue_size
);

464 
	g©Œibu‹
->
v®ue
(value);

466  
	g©Œibu‹
;

476 
Ch
 *
®loÿ‹_¡ršg
(cÚ¡ Ch *
sourû
 = 0, 
¡d
::
size_t
 
size
 = 0)

478 
as£¹
(
sourû
 || 
size
);

479 ià(
	gsize
 == 0)

480 
size
 = 
š‹º®
::
m—su»
(
sourû
) + 1;

481 
Ch
 *
	g»suÉ
 = 
¡©ic_ÿ¡
<Ch *>(
®loÿ‹_®igÃd
(
size
 * (Ch)));

482 ià(
	gsourû
)

483 
	g¡d
::
size_t
 
i
 = 0; 
	gi
 < 
	gsize
; ++i)

484 
	g»suÉ
[
i
] = 
sourû
[i];

485  
	g»suÉ
;

497 
	gxml_node
<
	gCh
> *
şÚe_node
(cÚ¡ 
xml_node
<
Ch
> *
sourû
, xml_node<Ch> *
»suÉ
 = 0)

500 ià(
»suÉ
)

502 
»suÉ
->
»move_®l_©Œibu‹s
();

503 
	g»suÉ
->
»move_®l_nodes
();

504 
	g»suÉ
->
ty³
(
sourû
->type());

507 
	g»suÉ
 = 
®loÿ‹_node
(
sourû
->
ty³
());

510 
	g»suÉ
->
Çme
(
sourû
->Çme(), sourû->
Çme_size
());

511 
	g»suÉ
->
v®ue
(
sourû
->v®ue(), sourû->
v®ue_size
());

514 
	gxml_node
<
	gCh
> *
	gchd
 = 
sourû
->
fœ¡_node
(); chd; chd = 
chd
->
Ãxt_siblšg
())

515 
»suÉ
->
­³nd_node
(
şÚe_node
(
chd
));

516 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œ
 = 
sourû
->
fœ¡_©Œibu‹
();‡‰r;‡‰¸ğ
©Œ
->
Ãxt_©Œibu‹
())

517 
»suÉ
->
­³nd_©Œibu‹
(
®loÿ‹_©Œibu‹
(
©Œ
->
Çme
(),‡‰r->
v®ue
(),‡‰r->
Çme_size
(),‡‰r->
v®ue_size
()));

519  
	g»suÉ
;

525 
ş—r
()

527 
	gm_begš
 !ğ
m_¡©ic_memÜy
)

529 *
´evious_begš
 = 
»š‹½»t_ÿ¡
<
h—d”
 *>(
®ign
(
m_begš
))->previous_begin;

530 ià(
	gm_ä“_func
)

531 
m_ä“_func
(
m_begš
);

533 
	gd–‘e
[] 
	gm_begš
;

534 
	gm_begš
 = 
´evious_begš
;

536 
š™
();

552 
£t_®loÿtÜ
(
®loc_func
 *
af
, 
ä“_func
 *
ff
)

554 
as£¹
(
m_begš
 =ğ
m_¡©ic_memÜy
 && 
m_±r
 =ğ
®ign
(m_begin));

555 
	gm_®loc_func
 = 
af
;

556 
	gm_ä“_func
 = 
ff
;

559 
	g´iv©e
:

561 
	sh—d”


563 *
´evious_begš
;

566 
š™
()

568 
	gm_begš
 = 
m_¡©ic_memÜy
;

569 
	gm_±r
 = 
®ign
(
m_begš
);

570 
	gm_’d
 = 
m_¡©ic_memÜy
 + (m_static_memory);

573 *
®ign
(*
±r
)

575 
	g¡d
::
size_t
 
®ignm’t
 = ((
RAPIDXML_ALIGNMENT
 - (
¡d
::size_t(
±r
) & (RAPIDXML_ALIGNMENT - 1))) & (RAPIDXML_ALIGNMENT - 1));

576  
	g±r
 + 
	g®ignm’t
;

579 *
®loÿ‹_¿w
(
¡d
::
size_t
 
size
)

582 *
memÜy
;

583 ià(
	gm_®loc_func
)

585 
	gmemÜy
 = 
m_®loc_func
(
size
);

586 
as£¹
(
memÜy
);

590 
	gmemÜy
 = 
Ãw
 [
size
];

591 #ifdeà
RAPIDXML_NO_EXCEPTIONS


592 ià(!
	gmemÜy
)

593 
RAPIDXML_PARSE_ERROR
("out of memory", 0);

596  
	g¡©ic_ÿ¡
<*>(
	gmemÜy
);

599 *
®loÿ‹_®igÃd
(
¡d
::
size_t
 
size
)

602 *
»suÉ
 = 
®ign
(
m_±r
);

605 ià(
	g»suÉ
 + 
	gsize
 > 
	gm_’d
)

608 
	g¡d
::
size_t
 
poŞ_size
 = 
RAPIDXML_DYNAMIC_POOL_SIZE
;

609 ià(
	gpoŞ_size
 < 
	gsize
)

610 
	gpoŞ_size
 = 
size
;

613 
	g¡d
::
size_t
 
®loc_size
 = (
h—d”
è+ (2 * 
RAPIDXML_ALIGNMENT
 - 2è+ 
poŞ_size
;

614 *
	g¿w_memÜy
 = 
®loÿ‹_¿w
(
®loc_size
);

617 *
	gpoŞ
 = 
®ign
(
¿w_memÜy
);

618 
h—d”
 *
	gÃw_h—d”
 = 
»š‹½»t_ÿ¡
<h—d” *>(
poŞ
);

619 
	gÃw_h—d”
->
	g´evious_begš
 = 
m_begš
;

620 
	gm_begš
 = 
¿w_memÜy
;

621 
	gm_±r
 = 
poŞ
 + (
h—d”
);

622 
	gm_’d
 = 
¿w_memÜy
 + 
®loc_size
;

625 
	g»suÉ
 = 
®ign
(
m_±r
);

629 
	gm_±r
 = 
»suÉ
 + 
size
;

630  
	g»suÉ
;

633 *
	gm_begš
;

634 *
	gm_±r
;

635 *
	gm_’d
;

636 
	gm_¡©ic_memÜy
[
RAPIDXML_STATIC_POOL_SIZE
];

637 
®loc_func
 *
	gm_®loc_func
;

638 
ä“_func
 *
	gm_ä“_func
;

647 
	g‹m¶©e
<
şass
 
	gCh
 = >

648 şas 
	cxml_ba£


651 
public
:

657 
xml_ba£
()

658 : 
m_Çme
(0)

659 , 
m_v®ue
(0)

660 , 
m_·»Á
(0)

673 
Ch
 *
Çme
() const

675  
m_Çme
 ? m_Çm: 
nuÎ¡r
();

681 
	g¡d
::
size_t
 
Çme_size
() const

683  
m_Çme
 ? 
m_Çme_size
 : 0;

692 
Ch
 *
v®ue
() const

694  
	gm_v®ue
 ? m_v®u: 
nuÎ¡r
();

700 
	g¡d
::
size_t
 
v®ue_size
() const

702  
m_v®ue
 ? 
m_v®ue_size
 : 0;

721 
Çme
(cÚ¡ 
Ch
 *Çme, 
¡d
::
size_t
 
size
)

723 
m_Çme
 = 
cÚ¡_ÿ¡
<
Ch
 *>(
Çme
);

724 
	gm_Çme_size
 = 
size
;

730 
Çme
(cÚ¡ 
Ch
 *name)

732 
	gthis
->
Çme
Òame, 
š‹º®
::
m—su»
(name));

751 
v®ue
(cÚ¡ 
Ch
 *v®ue, 
¡d
::
size_t
 
size
)

753 
m_v®ue
 = 
cÚ¡_ÿ¡
<
Ch
 *>(
v®ue
);

754 
	gm_v®ue_size
 = 
size
;

760 
v®ue
(cÚ¡ 
Ch
 *value)

762 
	gthis
->
v®ue
(v®ue, 
š‹º®
::
m—su»
(value));

770 
	gxml_node
<
	gCh
> *
·»Á
() const

772  
	gm_·»Á
;

775 
	g´Ùeùed
:

778 
Ch
 *
nuÎ¡r
()

780 
Ch
 
z”o
 = Ch('\0');

781  &
	gz”o
;

784 
Ch
 *
	gm_Çme
;

785 
Ch
 *
	gm_v®ue
;

786 
	g¡d
::
size_t
 
m_Çme_size
;

787 
	g¡d
::
size_t
 
m_v®ue_size
;

788 
	gxml_node
<
	gCh
> *
	gm_·»Á
;

797 
	g‹m¶©e
<
şass
 
	gCh
 = >

798 
şass
 
xml_©Œibu‹
: 
public
 
xml_ba£
<
Ch
>

801 
ä›nd
 
şass
 
xml_node
<
Ch
>;

803 
	gpublic
:

810 
xml_©Œibu‹
()

819 
xml_docum’t
<
Ch
> *
docum’t
() const

821 ià(
xml_node
<
Ch
> *
node
 = 
this
->
·»Á
())

823 
node
->
·»Á
())

824 
node
 =‚ode->
·»Á
();

825  
	gnode
->
ty³
(è=ğ
node_docum’t
 ? 
¡©ic_ÿ¡
<
xml_docum’t
<
Ch
> *>(
node
) : 0;

836 
	gxml_©Œibu‹
<
	gCh
> *
´evious_©Œibu‹
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

838 ià(
Çme
)

840 ià(
Çme_size
 == 0)

841 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

842 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
m_´ev_©Œibu‹
;‡‰ribu‹;‡‰ribu‹ = 
©Œibu‹
->m_prev_attribute)

843 ià(
š‹º®
::
com·»
(
©Œibu‹
->
Çme
(),‡‰ribu‹->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

844  
	g©Œibu‹
;

848  
	gthis
->
	gm_·»Á
 ? 
	gm_´ev_©Œibu‹
 : 0;

856 
	gxml_©Œibu‹
<
	gCh
> *
Ãxt_©Œibu‹
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

858 ià(
Çme
)

860 ià(
Çme_size
 == 0)

861 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

862 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
m_Ãxt_©Œibu‹
;‡‰ribu‹;‡‰ribu‹ = 
©Œibu‹
->m_next_attribute)

863 ià(
š‹º®
::
com·»
(
©Œibu‹
->
Çme
(),‡‰ribu‹->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

864  
	g©Œibu‹
;

868  
	gthis
->
	gm_·»Á
 ? 
	gm_Ãxt_©Œibu‹
 : 0;

871 
	g´iv©e
:

873 
xml_©Œibu‹
<
Ch
> *
m_´ev_©Œibu‹
;

874 
	gxml_©Œibu‹
<
	gCh
> *
	gm_Ãxt_©Œibu‹
;

889 
	g‹m¶©e
<
şass
 
	gCh
 = >

890 
şass
 
xml_node
: 
public
 
xml_ba£
<
Ch
>

893 
public
:

901 
xml_node
(
node_ty³
 
ty³
)

902 : 
m_ty³
(
ty³
)

903 , 
m_fœ¡_node
(0)

904 , 
m_fœ¡_©Œibu‹
(0)

913 
node_ty³
 
ty³
() const

915  
m_ty³
;

923 
	gxml_docum’t
<
	gCh
> *
docum’t
() const

925 
	gxml_node
<
	gCh
> *
	gnode
 = 
cÚ¡_ÿ¡
<
xml_node
<
Ch
> *>(
this
);

926 
	gnode
->
·»Á
())

927 
	gnode
 = 
node
->
·»Á
();

928  
	gnode
->
ty³
(è=ğ
node_docum’t
 ? 
¡©ic_ÿ¡
<
xml_docum’t
<
Ch
> *>(
node
) : 0;

936 
	gxml_node
<
	gCh
> *
fœ¡_node
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

938 ià(
Çme
)

940 ià(
Çme_size
 == 0)

941 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

942 
	gxml_node
<
	gCh
> *
	gchd
 = 
m_fœ¡_node
; chd; chd = 
chd
->
Ãxt_siblšg
())

943 ià(
š‹º®
::
com·»
(
chd
->
Çme
(), chd->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

944  
	gchd
;

948  
	gm_fœ¡_node
;

958 
	gxml_node
<
	gCh
> *
Ï¡_node
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

960 
as£¹
(
m_fœ¡_node
);

961 ià(
	gÇme
)

963 ià(
	gÇme_size
 == 0)

964 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

965 
	gxml_node
<
	gCh
> *
	gchd
 = 
m_Ï¡_node
; chd; chd = 
chd
->
´evious_siblšg
())

966 ià(
š‹º®
::
com·»
(
chd
->
Çme
(), chd->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

967  
	gchd
;

971  
	gm_Ï¡_node
;

981 
	gxml_node
<
	gCh
> *
´evious_siblšg
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

983 
as£¹
(
this
->
m_·»Á
);

984 ià(
	gÇme
)

986 ià(
	gÇme_size
 == 0)

987 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

988 
	gxml_node
<
	gCh
> *
	gsiblšg
 = 
m_´ev_siblšg
; siblšg; siblšg = 
siblšg
->m_prev_sibling)

989 ià(
š‹º®
::
com·»
(
siblšg
->
Çme
(), siblšg->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

990  
	gsiblšg
;

994  
	gm_´ev_siblšg
;

1004 
	gxml_node
<
	gCh
> *
Ãxt_siblšg
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

1006 
as£¹
(
this
->
m_·»Á
);

1007 ià(
	gÇme
)

1009 ià(
	gÇme_size
 == 0)

1010 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

1011 
	gxml_node
<
	gCh
> *
	gsiblšg
 = 
m_Ãxt_siblšg
; siblšg; siblšg = 
siblšg
->m_next_sibling)

1012 ià(
š‹º®
::
com·»
(
siblšg
->
Çme
(), siblšg->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

1013  
	gsiblšg
;

1017  
	gm_Ãxt_siblšg
;

1025 
	gxml_©Œibu‹
<
	gCh
> *
fœ¡_©Œibu‹
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

1027 ià(
Çme
)

1029 ià(
Çme_size
 == 0)

1030 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

1031 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
m_fœ¡_©Œibu‹
;‡‰ribu‹;‡‰ribu‹ = 
©Œibu‹
->
m_Ãxt_©Œibu‹
)

1032 ià(
š‹º®
::
com·»
(
©Œibu‹
->
Çme
(),‡‰ribu‹->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

1033  
	g©Œibu‹
;

1037  
	gm_fœ¡_©Œibu‹
;

1045 
	gxml_©Œibu‹
<
	gCh
> *
Ï¡_©Œibu‹
(cÚ¡ 
Ch
 *
Çme
 = 0, 
¡d
::
size_t
 
Çme_size
 = 0, 
boŞ
 
ÿ£_£ns™ive
 = 
Œue
) const

1047 ià(
Çme
)

1049 ià(
Çme_size
 == 0)

1050 
Çme_size
 = 
š‹º®
::
m—su»
(
Çme
);

1051 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
m_Ï¡_©Œibu‹
;‡‰ribu‹;‡‰ribu‹ = 
©Œibu‹
->
m_´ev_©Œibu‹
)

1052 ià(
š‹º®
::
com·»
(
©Œibu‹
->
Çme
(),‡‰ribu‹->
Çme_size
(),‚ame,‚ame_size, 
ÿ£_£ns™ive
))

1053  
	g©Œibu‹
;

1057  
	gm_fœ¡_©Œibu‹
 ? 
	gm_Ï¡_©Œibu‹
 : 0;

1065 
ty³
(
node_ty³
ype)

1067 
	gm_ty³
 = 
ty³
;

1076 
´•’d_node
(
xml_node
<
Ch
> *
chd
)

1078 
as£¹
(
chd
 && !chd->
·»Á
(è&& chd->
ty³
(è!ğ
node_docum’t
);

1079 ià(
fœ¡_node
())

1081 
	gchd
->
	gm_Ãxt_siblšg
 = 
m_fœ¡_node
;

1082 
	gm_fœ¡_node
->
	gm_´ev_siblšg
 = 
chd
;

1086 
	gchd
->
	gm_Ãxt_siblšg
 = 0;

1087 
	gm_Ï¡_node
 = 
chd
;

1089 
	gm_fœ¡_node
 = 
chd
;

1090 
	gchd
->
	gm_·»Á
 = 
this
;

1091 
	gchd
->
	gm_´ev_siblšg
 = 0;

1097 
­³nd_node
(
xml_node
<
Ch
> *
chd
)

1099 
as£¹
(
chd
 && !chd->
·»Á
(è&& chd->
ty³
(è!ğ
node_docum’t
);

1100 ià(
fœ¡_node
())

1102 
	gchd
->
	gm_´ev_siblšg
 = 
m_Ï¡_node
;

1103 
	gm_Ï¡_node
->
	gm_Ãxt_siblšg
 = 
chd
;

1107 
	gchd
->
	gm_´ev_siblšg
 = 0;

1108 
	gm_fœ¡_node
 = 
chd
;

1110 
	gm_Ï¡_node
 = 
chd
;

1111 
	gchd
->
	gm_·»Á
 = 
this
;

1112 
	gchd
->
	gm_Ãxt_siblšg
 = 0;

1119 
š£¹_node
(
xml_node
<
Ch
> *
wh”e
, xml_node<Ch> *
chd
)

1121 
as£¹
(!
wh”e
 || wh”e->
·»Á
(è=ğ
this
);

1122 
as£¹
(
chd
 && !chd->
·»Á
(è&& chd->
ty³
(è!ğ
node_docum’t
);

1123 ià(
	gwh”e
 =ğ
m_fœ¡_node
)

1124 
´•’d_node
(
chd
);

1125 ià(
	gwh”e
 == 0)

1126 
­³nd_node
(
chd
);

1129 
	gchd
->
	gm_´ev_siblšg
 = 
wh”e
->
m_´ev_siblšg
;

1130 
	gchd
->
	gm_Ãxt_siblšg
 = 
wh”e
;

1131 
	gwh”e
->
	gm_´ev_siblšg
->
	gm_Ãxt_siblšg
 = 
chd
;

1132 
	gwh”e
->
	gm_´ev_siblšg
 = 
chd
;

1133 
	gchd
->
	gm_·»Á
 = 
this
;

1140 
»move_fœ¡_node
()

1142 
as£¹
(
fœ¡_node
());

1143 
	gxml_node
<
	gCh
> *
	gchd
 = 
m_fœ¡_node
;

1144 
	gm_fœ¡_node
 = 
chd
->
m_Ãxt_siblšg
;

1145 ià(
	gchd
->
	gm_Ãxt_siblšg
)

1146 
	gchd
->
	gm_Ãxt_siblšg
->
	gm_´ev_siblšg
 = 0;

1148 
	gm_Ï¡_node
 = 0;

1149 
	gchd
->
	gm_·»Á
 = 0;

1155 
»move_Ï¡_node
()

1157 
as£¹
(
fœ¡_node
());

1158 
	gxml_node
<
	gCh
> *
	gchd
 = 
m_Ï¡_node
;

1159 ià(
	gchd
->
	gm_´ev_siblšg
)

1161 
	gm_Ï¡_node
 = 
chd
->
m_´ev_siblšg
;

1162 
	gchd
->
	gm_´ev_siblšg
->
	gm_Ãxt_siblšg
 = 0;

1165 
	gm_fœ¡_node
 = 0;

1166 
	gchd
->
	gm_·»Á
 = 0;

1171 
»move_node
(
xml_node
<
Ch
> *
wh”e
)

1173 
as£¹
(
wh”e
 && wh”e->
·»Á
(è=ğ
this
);

1174 
as£¹
(
fœ¡_node
());

1175 ià(
	gwh”e
 =ğ
m_fœ¡_node
)

1176 
»move_fœ¡_node
();

1177 ià(
	gwh”e
 =ğ
m_Ï¡_node
)

1178 
»move_Ï¡_node
();

1181 
	gwh”e
->
	gm_´ev_siblšg
->
	gm_Ãxt_siblšg
 = 
wh”e
->
m_Ãxt_siblšg
;

1182 
	gwh”e
->
	gm_Ãxt_siblšg
->
	gm_´ev_siblšg
 = 
wh”e
->
m_´ev_siblšg
;

1183 
	gwh”e
->
	gm_·»Á
 = 0;

1188 
»move_®l_nodes
()

1190 
	gxml_node
<
	gCh
> *
	gnode
 = 
fœ¡_node
();‚ode;‚odğ
node
->
m_Ãxt_siblšg
)

1191 
node
->
m_·»Á
 = 0;

1192 
	gm_fœ¡_node
 = 0;

1197 
´•’d_©Œibu‹
(
xml_©Œibu‹
<
Ch
> *
©Œibu‹
)

1199 
as£¹
(
©Œibu‹
 && !©Œibu‹->
·»Á
());

1200 ià(
fœ¡_©Œibu‹
())

1202 
	g©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 
m_fœ¡_©Œibu‹
;

1203 
	gm_fœ¡_©Œibu‹
->
	gm_´ev_©Œibu‹
 = 
©Œibu‹
;

1207 
	g©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 0;

1208 
	gm_Ï¡_©Œibu‹
 = 
©Œibu‹
;

1210 
	gm_fœ¡_©Œibu‹
 = 
©Œibu‹
;

1211 
	g©Œibu‹
->
	gm_·»Á
 = 
this
;

1212 
	g©Œibu‹
->
	gm_´ev_©Œibu‹
 = 0;

1217 
­³nd_©Œibu‹
(
xml_©Œibu‹
<
Ch
> *
©Œibu‹
)

1219 
as£¹
(
©Œibu‹
 && !©Œibu‹->
·»Á
());

1220 ià(
fœ¡_©Œibu‹
())

1222 
	g©Œibu‹
->
	gm_´ev_©Œibu‹
 = 
m_Ï¡_©Œibu‹
;

1223 
	gm_Ï¡_©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 
©Œibu‹
;

1227 
	g©Œibu‹
->
	gm_´ev_©Œibu‹
 = 0;

1228 
	gm_fœ¡_©Œibu‹
 = 
©Œibu‹
;

1230 
	gm_Ï¡_©Œibu‹
 = 
©Œibu‹
;

1231 
	g©Œibu‹
->
	gm_·»Á
 = 
this
;

1232 
	g©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 0;

1239 
š£¹_©Œibu‹
(
xml_©Œibu‹
<
Ch
> *
wh”e
, xml_©Œibu‹<Ch> *
©Œibu‹
)

1241 
as£¹
(!
wh”e
 || wh”e->
·»Á
(è=ğ
this
);

1242 
as£¹
(
©Œibu‹
 && !©Œibu‹->
·»Á
());

1243 ià(
	gwh”e
 =ğ
m_fœ¡_©Œibu‹
)

1244 
´•’d_©Œibu‹
(
©Œibu‹
);

1245 ià(
	gwh”e
 == 0)

1246 
­³nd_©Œibu‹
(
©Œibu‹
);

1249 
	g©Œibu‹
->
	gm_´ev_©Œibu‹
 = 
wh”e
->
m_´ev_©Œibu‹
;

1250 
	g©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 
wh”e
;

1251 
	gwh”e
->
	gm_´ev_©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 
©Œibu‹
;

1252 
	gwh”e
->
	gm_´ev_©Œibu‹
 = 
©Œibu‹
;

1253 
	g©Œibu‹
->
	gm_·»Á
 = 
this
;

1260 
»move_fœ¡_©Œibu‹
()

1262 
as£¹
(
fœ¡_©Œibu‹
());

1263 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
m_fœ¡_©Œibu‹
;

1264 ià(
	g©Œibu‹
->
	gm_Ãxt_©Œibu‹
)

1266 
	g©Œibu‹
->
	gm_Ãxt_©Œibu‹
->
	gm_´ev_©Œibu‹
 = 0;

1269 
	gm_Ï¡_©Œibu‹
 = 0;

1270 
	g©Œibu‹
->
	gm_·»Á
 = 0;

1271 
	gm_fœ¡_©Œibu‹
 = 
©Œibu‹
->
m_Ãxt_©Œibu‹
;

1277 
»move_Ï¡_©Œibu‹
()

1279 
as£¹
(
fœ¡_©Œibu‹
());

1280 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
m_Ï¡_©Œibu‹
;

1281 ià(
	g©Œibu‹
->
	gm_´ev_©Œibu‹
)

1283 
	g©Œibu‹
->
	gm_´ev_©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 0;

1284 
	gm_Ï¡_©Œibu‹
 = 
©Œibu‹
->
m_´ev_©Œibu‹
;

1287 
	gm_fœ¡_©Œibu‹
 = 0;

1288 
	g©Œibu‹
->
	gm_·»Á
 = 0;

1293 
»move_©Œibu‹
(
xml_©Œibu‹
<
Ch
> *
wh”e
)

1295 
as£¹
(
fœ¡_©Œibu‹
(è&& 
wh”e
->
·»Á
(è=ğ
this
);

1296 ià(
	gwh”e
 =ğ
m_fœ¡_©Œibu‹
)

1297 
»move_fœ¡_©Œibu‹
();

1298 ià(
	gwh”e
 =ğ
m_Ï¡_©Œibu‹
)

1299 
»move_Ï¡_©Œibu‹
();

1302 
	gwh”e
->
	gm_´ev_©Œibu‹
->
	gm_Ãxt_©Œibu‹
 = 
wh”e
->
m_Ãxt_©Œibu‹
;

1303 
	gwh”e
->
	gm_Ãxt_©Œibu‹
->
	gm_´ev_©Œibu‹
 = 
wh”e
->
m_´ev_©Œibu‹
;

1304 
	gwh”e
->
	gm_·»Á
 = 0;

1309 
»move_®l_©Œibu‹s
()

1311 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
fœ¡_©Œibu‹
();‡‰ribu‹;‡‰ribu‹ = 
©Œibu‹
->
m_Ãxt_©Œibu‹
)

1312 
©Œibu‹
->
m_·»Á
 = 0;

1313 
	gm_fœ¡_©Œibu‹
 = 0;

1316 
	g´iv©e
:

1322 
xml_node
(const xml_node &);

1323 
	gİ”©Ü
 =(cÚ¡ 
xml_node
 &);

1337 
node_ty³
 
	gm_ty³
;

1338 
	gxml_node
<
	gCh
> *
	gm_fœ¡_node
;

1339 
	gxml_node
<
	gCh
> *
	gm_Ï¡_node
;

1340 
	gxml_©Œibu‹
<
	gCh
> *
	gm_fœ¡_©Œibu‹
;

1341 
	gxml_©Œibu‹
<
	gCh
> *
	gm_Ï¡_©Œibu‹
;

1342 
	gxml_node
<
	gCh
> *
	gm_´ev_siblšg
;

1343 
	gxml_node
<
	gCh
> *
	gm_Ãxt_siblšg
;

1357 
	g‹m¶©e
<
şass
 
	gCh
 = >

1358 
şass
 
xml_docum’t
: 
public
 
xml_node
<
Ch
>,…ubliø
	gmemÜy_poŞ
<
	gCh
>

1361 
	gpublic
:

1364 
xml_docum’t
()

1365 : 
xml_node
<
Ch
>(
node_docum’t
)

1380 
‹m¶©e
<
FÏgs
>

1381 
·r£
(
Ch
 *
‹xt
)

1383 
as£¹
(
‹xt
);

1386 
	gthis
->
»move_®l_nodes
();

1387 
	gthis
->
»move_®l_©Œibu‹s
();

1390 
	g·r£_bom
<
	gFÏgs
>(
	g‹xt
);

1396 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

1397 ià(*
	g‹xt
 == 0)

1401 ià(*
	g‹xt
 =ğ
Ch
('<'))

1403 ++
‹xt
;

1404 ià(
	gxml_node
<
	gCh
> *
	gnode
 = 
·r£_node
<
FÏgs
>(
‹xt
))

1405 
this
->
­³nd_node
(
node
);

1408 
RAPIDXML_PARSE_ERROR
("ex³ùed <", 
‹xt
);

1415 
ş—r
()

1417 
	gthis
->
»move_®l_nodes
();

1418 
	gthis
->
»move_®l_©Œibu‹s
();

1419 
	gmemÜy_poŞ
<
	gCh
>::
ş—r
();

1422 
	g´iv©e
:

1428 
	swh™e¥aû_´ed


1430 
‹¡
(
Ch
 
ch
)

1432  
š‹º®
::
lookup_bËs
<0>::
lookup_wh™e¥aû
[
¡©ic_ÿ¡
<>(
ch
)];

1437 
	snode_Çme_´ed


1439 
‹¡
(
Ch
 
ch
)

1441  
	gš‹º®
::
lookup_bËs
<0>::
lookup_node_Çme
[
¡©ic_ÿ¡
<>(
ch
)];

1446 
	s©Œibu‹_Çme_´ed


1448 
‹¡
(
Ch
 
ch
)

1450  
	gš‹º®
::
lookup_bËs
<0>::
lookup_©Œibu‹_Çme
[
¡©ic_ÿ¡
<>(
ch
)];

1455 
	s‹xt_´ed


1457 
‹¡
(
Ch
 
ch
)

1459  
	gš‹º®
::
lookup_bËs
<0>::
lookup_‹xt
[
¡©ic_ÿ¡
<>(
ch
)];

1464 
	s‹xt_pu»_no_ws_´ed


1466 
‹¡
(
Ch
 
ch
)

1468  
	gš‹º®
::
lookup_bËs
<0>::
lookup_‹xt_pu»_no_ws
[
¡©ic_ÿ¡
<>(
ch
)];

1473 
	s‹xt_pu»_w™h_ws_´ed


1475 
‹¡
(
Ch
 
ch
)

1477  
	gš‹º®
::
lookup_bËs
<0>::
lookup_‹xt_pu»_w™h_ws
[
¡©ic_ÿ¡
<>(
ch
)];

1482 
	g‹m¶©e
<
Ch
 
	gQuÙe
>

1483 
	s©Œibu‹_v®ue_´ed


1485 
‹¡
(
Ch
 
ch
)

1487 ià(
	gQuÙe
 =ğ
Ch
('\''))

1488  
š‹º®
::
lookup_bËs
<0>::
lookup_©Œibu‹_d©a_1
[
¡©ic_ÿ¡
<>(
ch
)];

1489 ià(
	gQuÙe
 =ğ
Ch
('\"'))

1490  
š‹º®
::
lookup_bËs
<0>::
lookup_©Œibu‹_d©a_2
[
¡©ic_ÿ¡
<>(
ch
)];

1496 
	g‹m¶©e
<
Ch
 
	gQuÙe
>

1497 
	s©Œibu‹_v®ue_pu»_´ed


1499 
‹¡
(
Ch
 
ch
)

1501 ià(
	gQuÙe
 =ğ
Ch
('\''))

1502  
š‹º®
::
lookup_bËs
<0>::
lookup_©Œibu‹_d©a_1_pu»
[
¡©ic_ÿ¡
<>(
ch
)];

1503 ià(
	gQuÙe
 =ğ
Ch
('\"'))

1504  
š‹º®
::
lookup_bËs
<0>::
lookup_©Œibu‹_d©a_2_pu»
[
¡©ic_ÿ¡
<>(
ch
)];

1510 
	g‹m¶©e
<
	gFÏgs
>

1511 
š£¹_coded_ch¬aù”
(
Ch
 *&
‹xt
, 
code
)

1513 ià(
	gFÏgs
 & 
	g·r£_no_utf8
)

1517 
	g‹xt
[0] = 
¡©ic_ÿ¡
<>(
code
);

1518 
	g‹xt
 += 1;

1523 ià(
	gcode
 < 0x80)

1525 
	g‹xt
[0] = 
¡©ic_ÿ¡
<>(
code
);

1526 
	g‹xt
 += 1;

1528 ià(
	gcode
 < 0x800)

1530 
	g‹xt
[1] = 
¡©ic_ÿ¡
<>((
code
 | 0x80è& 0xBF); 
	gcode
 >>= 6;

1531 
	g‹xt
[0] = 
¡©ic_ÿ¡
<>(
code
 | 0xC0);

1532 
	g‹xt
 += 2;

1534 ià(
	gcode
 < 0x10000)

1536 
	g‹xt
[2] = 
¡©ic_ÿ¡
<>((
code
 | 0x80è& 0xBF); 
	gcode
 >>= 6;

1537 
	g‹xt
[1] = 
¡©ic_ÿ¡
<>((
code
 | 0x80è& 0xBF); 
	gcode
 >>= 6;

1538 
	g‹xt
[0] = 
¡©ic_ÿ¡
<>(
code
 | 0xE0);

1539 
	g‹xt
 += 3;

1541 ià(
	gcode
 < 0x110000)

1543 
	g‹xt
[3] = 
¡©ic_ÿ¡
<>((
code
 | 0x80è& 0xBF); 
	gcode
 >>= 6;

1544 
	g‹xt
[2] = 
¡©ic_ÿ¡
<>((
code
 | 0x80è& 0xBF); 
	gcode
 >>= 6;

1545 
	g‹xt
[1] = 
¡©ic_ÿ¡
<>((
code
 | 0x80è& 0xBF); 
	gcode
 >>= 6;

1546 
	g‹xt
[0] = 
¡©ic_ÿ¡
<>(
code
 | 0xF0);

1547 
	g‹xt
 += 4;

1551 
RAPIDXML_PARSE_ERROR
("šv®id‚um”iøch¬aù”ƒÁ™y", 
‹xt
);

1557 
	g‹m¶©e
<
şass
 
	gStİP»d
, 
	gFÏgs
>

1558 
sk
(
Ch
 *&
‹xt
)

1560 
Ch
 *
	gtmp
 = 
‹xt
;

1561 
	gStİP»d
::
‹¡
(*
tmp
))

1562 ++
tmp
;

1563 
	g‹xt
 = 
tmp
;

1569 
	g‹m¶©e
<
şass
 
	gStİP»d
, cÏs 
	gStİP»dPu»
, 
	gFÏgs
>

1570 
Ch
 *
sk_ªd_ex·nd_ch¬aù”_»fs
(Ch *&
‹xt
)

1573 ià(
	gFÏgs
 & 
	g·r£_no_’t™y_Œª¦©iÚ
 &&

1574 !(
	gFÏgs
 & 
	g·r£_nÜm®ize_wh™e¥aû
) &&

1575 !(
	gFÏgs
 & 
	g·r£_Œim_wh™e¥aû
))

1577 
	gsk
<
	gStİP»d
, 
	gFÏgs
>(
	g‹xt
);

1578  
	g‹xt
;

1582 
	gsk
<
	gStİP»dPu»
, 
	gFÏgs
>(
	g‹xt
);

1585 
Ch
 *
	g¤c
 = 
‹xt
;

1586 
Ch
 *
	gde¡
 = 
¤c
;

1587 
	gStİP»d
::
‹¡
(*
¤c
))

1590 ià(!(
FÏgs
 & 
·r£_no_’t™y_Œª¦©iÚ
))

1593 ià(
¤c
[0] =ğ
Ch
('&'))

1595 
¤c
[1])

1599 
Ch
('a'):

1600 ià(
¤c
[2] =ğ
Ch
('m') && src[3] == Ch('p') && src[4] == Ch(';'))

1602 *
de¡
 = 
Ch
('&');

1603 ++
	gde¡
;

1604 
	g¤c
 += 5;

1607 ià(
	g¤c
[2] =ğ
Ch
('p'è&& 
¤c
[3] == Ch('o') && src[4] == Ch('s') && src[5] == Ch(';'))

1609 *
de¡
 = 
Ch
('\'');

1610 ++
	gde¡
;

1611 
	g¤c
 += 6;

1617 
Ch
('q'):

1618 ià(
¤c
[2] =ğ
Ch
('u') && src[3] == Ch('o') && src[4] == Ch('t') && src[5] == Ch(';'))

1620 *
de¡
 = 
Ch
('"');

1621 ++
	gde¡
;

1622 
	g¤c
 += 6;

1628 
Ch
('g'):

1629 ià(
¤c
[2] =ğ
Ch
('t') && src[3] == Ch(';'))

1631 *
de¡
 = 
Ch
('>');

1632 ++
	gde¡
;

1633 
	g¤c
 += 4;

1639 
Ch
('l'):

1640 ià(
¤c
[2] =ğ
Ch
('t') && src[3] == Ch(';'))

1642 *
de¡
 = 
Ch
('<');

1643 ++
	gde¡
;

1644 
	g¤c
 += 4;

1650 
Ch
('#'):

1651 ià(
¤c
[2] =ğ
Ch
('x'))

1653 
code
 = 0;

1654 
	g¤c
 += 3;

1657 
	gdig™
 = 
š‹º®
::
lookup_bËs
<0>::
lookup_dig™s
[
¡©ic_ÿ¡
<>(*
¤c
)];

1658 ià(
	gdig™
 == 0xFF)

1660 
	gcode
 = 
code
 * 16 + 
dig™
;

1661 ++
	g¤c
;

1663 
	gš£¹_coded_ch¬aù”
<
	gFÏgs
>(
	gde¡
, 
	gcode
);

1667 
	gcode
 = 0;

1668 
	g¤c
 += 2;

1671 
	gdig™
 = 
š‹º®
::
lookup_bËs
<0>::
lookup_dig™s
[
¡©ic_ÿ¡
<>(*
¤c
)];

1672 ià(
	gdig™
 == 0xFF)

1674 
	gcode
 = 
code
 * 10 + 
dig™
;

1675 ++
	g¤c
;

1677 
	gš£¹_coded_ch¬aù”
<
	gFÏgs
>(
	gde¡
, 
	gcode
);

1679 ià(*
	g¤c
 =ğ
Ch
(';'))

1680 ++
¤c
;

1682 
RAPIDXML_PARSE_ERROR
("ex³ùed ;", 
¤c
);

1695 ià(
	gFÏgs
 & 
	g·r£_nÜm®ize_wh™e¥aû
)

1698 ià(
	gwh™e¥aû_´ed
::
‹¡
(*
¤c
))

1700 *
de¡
 = 
Ch
(' '); ++
	gde¡
;

1701 ++
	g¤c
;

1703 
	gwh™e¥aû_´ed
::
‹¡
(*
¤c
))

1704 ++
¤c
;

1710 *
	gde¡
++ = *
¤c
++;

1715 
	g‹xt
 = 
¤c
;

1716  
	gde¡
;

1724 
	g‹m¶©e
<
	gFÏgs
>

1725 
·r£_bom
(
Ch
 *&
‹xt
)

1728 ià(
	g¡©ic_ÿ¡
<>(
	g‹xt
[0]) == 0xEF &&

1729 
¡©ic_ÿ¡
<>(
‹xt
[1]) == 0xBB &&

1730 
¡©ic_ÿ¡
<>(
‹xt
[2]) == 0xBF)

1732 
‹xt
 += 3;

1737 
	g‹m¶©e
<
	gFÏgs
>

1738 
	gxml_node
<
	gCh
> *
·r£_xml_deş¬©iÚ
(
Ch
 *&
‹xt
)

1741 ià(!(
	gFÏgs
 & 
	g·r£_deş¬©iÚ_node
))

1744 
	g‹xt
[0] !ğ
Ch
('?'è|| 
‹xt
[1] != Ch('>'))

1746 ià(!
‹xt
[0])

1747 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

1748 ++
	g‹xt
;

1750 
	g‹xt
 += 2;

1755 
	gxml_node
<
	gCh
> *
	gdeş¬©iÚ
 = 
this
->
®loÿ‹_node
(
node_deş¬©iÚ
);

1758 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

1761 
	g·r£_node_©Œibu‹s
<
	gFÏgs
>(
	g‹xt
, 
	gdeş¬©iÚ
);

1764 ià(
	g‹xt
[0] !ğ
Ch
('?'è|| 
‹xt
[1] != Ch('>'))

1765 
RAPIDXML_PARSE_ERROR
("ex³ùed ?>", 
‹xt
);

1766 
	g‹xt
 += 2;

1768  
	gdeş¬©iÚ
;

1772 
	g‹m¶©e
<
	gFÏgs
>

1773 
	gxml_node
<
	gCh
> *
·r£_comm’t
(
Ch
 *&
‹xt
)

1776 ià(!(
	gFÏgs
 & 
	g·r£_comm’t_nodes
))

1779 
	g‹xt
[0] !ğ
Ch
('-'è|| 
‹xt
[1] != Ch('-') ||ext[2] != Ch('>'))

1781 ià(!
‹xt
[0])

1782 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

1783 ++
	g‹xt
;

1785 
	g‹xt
 += 3;

1790 
Ch
 *
	gv®ue
 = 
‹xt
;

1793 
	g‹xt
[0] !ğ
Ch
('-'è|| 
‹xt
[1] != Ch('-') ||ext[2] != Ch('>'))

1795 ià(!
‹xt
[0])

1796 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

1797 ++
	g‹xt
;

1801 
	gxml_node
<
	gCh
> *
	gcomm’t
 = 
this
->
®loÿ‹_node
(
node_comm’t
);

1802 
	gcomm’t
->
v®ue
(v®ue, 
‹xt
 - value);

1805 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

1806 *
	g‹xt
 = 
Ch
('\0');

1808 
	g‹xt
 += 3;

1809  
	gcomm’t
;

1813 
	g‹m¶©e
<
	gFÏgs
>

1814 
	gxml_node
<
	gCh
> *
·r£_doùy³
(
Ch
 *&
‹xt
)

1817 
Ch
 *
	gv®ue
 = 
‹xt
;

1820 *
	g‹xt
 !ğ
Ch
('>'))

1823 *
‹xt
)

1828 
Ch
('['):

1830 ++
‹xt
;

1831 
	gd•th
 = 1;

1832 
	gd•th
 > 0)

1834 *
	g‹xt
)

1836 
Ch
('['): ++
d•th
; ;

1837 
Ch
(']'): --
d•th
; ;

1838 0: 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

1840 ++
	g‹xt
;

1846 
Ch
('\0'):

1847 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

1851 ++
‹xt
;

1857 ià(
	gFÏgs
 & 
	g·r£_doùy³_node
)

1860 
	gxml_node
<
	gCh
> *
	gdoùy³
 = 
this
->
®loÿ‹_node
(
node_doùy³
);

1861 
	gdoùy³
->
v®ue
(v®ue, 
‹xt
 - value);

1864 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

1865 *
	g‹xt
 = 
Ch
('\0');

1867 
	g‹xt
 += 1;

1868  
	gdoùy³
;

1872 
	g‹xt
 += 1;

1879 
	g‹m¶©e
<
	gFÏgs
>

1880 
	gxml_node
<
	gCh
> *
·r£_pi
(
Ch
 *&
‹xt
)

1883 ià(
	gFÏgs
 & 
	g·r£_pi_nodes
)

1886 
	gxml_node
<
	gCh
> *
	gpi
 = 
this
->
®loÿ‹_node
(
node_pi
);

1889 
Ch
 *
	gÇme
 = 
‹xt
;

1890 
	gsk
<
	gnode_Çme_´ed
, 
	gFÏgs
>(
	g‹xt
);

1891 ià(
	g‹xt
 =ğ
Çme
)

1892 
RAPIDXML_PARSE_ERROR
("ex³ùed PI¬g‘", 
‹xt
);

1893 
	gpi
->
Çme
Òame, 
‹xt
 -‚ame);

1896 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

1899 
Ch
 *
	gv®ue
 = 
‹xt
;

1902 
	g‹xt
[0] !ğ
Ch
('?'è|| 
‹xt
[1] != Ch('>'))

1904 ià(*
‹xt
 =ğ
Ch
('\0'))

1905 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

1906 ++
	g‹xt
;

1910 
	gpi
->
v®ue
(v®ue, 
‹xt
 - value);

1913 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

1915 
	gpi
->
Çme
()[
pi
->
Çme_size
()] = 
Ch
('\0');

1916 
	gpi
->
v®ue
()[
pi
->
v®ue_size
()] = 
Ch
('\0');

1919 
	g‹xt
 += 2;

1920  
	gpi
;

1925 
	g‹xt
[0] !ğ
Ch
('?'è|| 
‹xt
[1] != Ch('>'))

1927 ià(*
‹xt
 =ğ
Ch
('\0'))

1928 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

1929 ++
	g‹xt
;

1931 
	g‹xt
 += 2;

1939 
	g‹m¶©e
<
	gFÏgs
>

1940 
Ch
 
·r£_ªd_­³nd_d©a
(
xml_node
<Ch> *
node
, Ch *&
‹xt
, Ch *
cÚ‹Ás_¡¬t
)

1943 ià(!(
	gFÏgs
 & 
	g·r£_Œim_wh™e¥aû
))

1944 
	g‹xt
 = 
cÚ‹Ás_¡¬t
;

1947 
Ch
 *
	gv®ue
 = 
‹xt
, *
	g’d
;

1948 ià(
	gFÏgs
 & 
	g·r£_nÜm®ize_wh™e¥aû
)

1949 
	g’d
 = 
sk_ªd_ex·nd_ch¬aù”_»fs
<
‹xt_´ed
, 
	g‹xt_pu»_w™h_ws_´ed
, 
	gFÏgs
>(
	g‹xt
);

1951 
	g’d
 = 
sk_ªd_ex·nd_ch¬aù”_»fs
<
‹xt_´ed
, 
	g‹xt_pu»_no_ws_´ed
, 
	gFÏgs
>(
	g‹xt
);

1954 ià(
	gFÏgs
 & 
	g·r£_Œim_wh™e¥aû
)

1956 ià(
	gFÏgs
 & 
	g·r£_nÜm®ize_wh™e¥aû
)

1959 ià(*(
	g’d
 - 1è=ğ
Ch
(' '))

1960 --
’d
;

1965 
	gwh™e¥aû_´ed
::
‹¡
(*(
’d
 - 1)))

1966 --
’d
;

1972 ià(!(
	gFÏgs
 & 
	g·r£_no_d©a_nodes
))

1974 
	gxml_node
<
	gCh
> *
	gd©a
 = 
this
->
®loÿ‹_node
(
node_d©a
);

1975 
	gd©a
->
v®ue
(v®ue, 
’d
 - value);

1976 
	gnode
->
­³nd_node
(
d©a
);

1980 ià(!(
	gFÏgs
 & 
	g·r£_no_–em’t_v®ues
))

1981 ià(*
	gnode
->
v®ue
(è=ğ
Ch
('\0'))

1982 
node
->
v®ue
(v®ue, 
’d
 - value);

1985 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

1987 
Ch
 
	gch
 = *
‹xt
;

1988 *
	g’d
 = 
Ch
('\0');

1989  
	gch
;

1993  *
	g‹xt
;

1997 
	g‹m¶©e
<
	gFÏgs
>

1998 
	gxml_node
<
	gCh
> *
·r£_cd©a
(
Ch
 *&
‹xt
)

2001 ià(
	gFÏgs
 & 
	g·r£_no_d©a_nodes
)

2004 
	g‹xt
[0] !ğ
Ch
(']'è|| 
‹xt
[1] != Ch(']') ||ext[2] != Ch('>'))

2006 ià(!
‹xt
[0])

2007 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

2008 ++
	g‹xt
;

2010 
	g‹xt
 += 3;

2015 
Ch
 *
	gv®ue
 = 
‹xt
;

2016 
	g‹xt
[0] !ğ
Ch
(']'è|| 
‹xt
[1] != Ch(']') ||ext[2] != Ch('>'))

2018 ià(!
‹xt
[0])

2019 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

2020 ++
	g‹xt
;

2024 
	gxml_node
<
	gCh
> *
	gcd©a
 = 
this
->
®loÿ‹_node
(
node_cd©a
);

2025 
	gcd©a
->
v®ue
(v®ue, 
‹xt
 - value);

2028 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

2029 *
	g‹xt
 = 
Ch
('\0');

2031 
	g‹xt
 += 3;

2032  
	gcd©a
;

2036 
	g‹m¶©e
<
	gFÏgs
>

2037 
	gxml_node
<
	gCh
> *
·r£_–em’t
(
Ch
 *&
‹xt
)

2040 
	gxml_node
<
	gCh
> *
	g–em’t
 = 
this
->
®loÿ‹_node
(
node_–em’t
);

2043 
Ch
 *
	gÇme
 = 
‹xt
;

2044 
	gsk
<
	gnode_Çme_´ed
, 
	gFÏgs
>(
	g‹xt
);

2045 ià(
	g‹xt
 =ğ
Çme
)

2046 
RAPIDXML_PARSE_ERROR
("ex³ùedƒËm’ˆÇme", 
‹xt
);

2047 
	g–em’t
->
Çme
Òame, 
‹xt
 -‚ame);

2050 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

2053 
	g·r£_node_©Œibu‹s
<
	gFÏgs
>(
	g‹xt
, 
	g–em’t
);

2056 ià(*
	g‹xt
 =ğ
Ch
('>'))

2058 ++
‹xt
;

2059 
	g·r£_node_cÚ‹Ás
<
	gFÏgs
>(
	g‹xt
, 
	g–em’t
);

2061 ià(*
	g‹xt
 =ğ
Ch
('/'))

2063 ++
‹xt
;

2064 ià(*
	g‹xt
 !ğ
Ch
('>'))

2065 
RAPIDXML_PARSE_ERROR
("ex³ùed >", 
‹xt
);

2066 ++
	g‹xt
;

2069 
RAPIDXML_PARSE_ERROR
("ex³ùed >", 
‹xt
);

2072 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

2073 
	g–em’t
->
Çme
()[
–em’t
->
Çme_size
()] = 
Ch
('\0');

2076  
	g–em’t
;

2080 
	g‹m¶©e
<
	gFÏgs
>

2081 
	gxml_node
<
	gCh
> *
·r£_node
(
Ch
 *&
‹xt
)

2084 
	g‹xt
[0])

2090  
·r£_–em’t
<
FÏgs
>(
‹xt
);

2093 
Ch
('?'):

2094 ++
‹xt
;

2095 ià((
	g‹xt
[0] =ğ
Ch
('x'è|| 
‹xt
[0] == Ch('X')) &&

2096 (
‹xt
[1] =ğ
Ch
('m') ||ext[1] == Ch('M')) &&

2097 (
‹xt
[2] =ğ
Ch
('l') ||ext[2] == Ch('L')) &&

2098 
wh™e¥aû_´ed
::
‹¡
(
‹xt
[3]))

2101 
‹xt
 += 4;

2102  
	g·r£_xml_deş¬©iÚ
<
	gFÏgs
>(
	g‹xt
);

2107  
	g·r£_pi
<
	gFÏgs
>(
	g‹xt
);

2111 
Ch
('!'):

2114 
‹xt
[1])

2118 
Ch
('-'):

2119 ià(
‹xt
[2] =ğ
Ch
('-'))

2122 
‹xt
 += 3;

2123  
	g·r£_comm’t
<
	gFÏgs
>(
	g‹xt
);

2128 
Ch
('['):

2129 ià(
‹xt
[2] =ğ
Ch
('C') &&ext[3] == Ch('D') &&ext[4] == Ch('A') &&

2130 
‹xt
[5] =ğ
Ch
('T') &&ext[6] == Ch('A') &&ext[7] == Ch('['))

2133 
‹xt
 += 8;

2134  
	g·r£_cd©a
<
	gFÏgs
>(
	g‹xt
);

2139 
Ch
('D'):

2140 ià(
‹xt
[2] =ğ
Ch
('O') &&ext[3] == Ch('C') &&ext[4] == Ch('T') &&

2141 
‹xt
[5] =ğ
Ch
('Y') &&ext[6] == Ch('P') &&ext[7] == Ch('E') &&

2142 
wh™e¥aû_´ed
::
‹¡
(
‹xt
[8]))

2145 
‹xt
 += 9;

2146  
	g·r£_doùy³
<
	gFÏgs
>(
	g‹xt
);

2152 ++
	g‹xt
;

2153 *
	g‹xt
 !ğ
Ch
('>'))

2155 ià(*
‹xt
 == 0)

2156 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

2157 ++
	g‹xt
;

2159 ++
	g‹xt
;

2166 
	g‹m¶©e
<
	gFÏgs
>

2167 
·r£_node_cÚ‹Ás
(
Ch
 *&
‹xt
, 
xml_node
<Ch> *
node
)

2173 
Ch
 *
	gcÚ‹Ás_¡¬t
 = 
‹xt
;

2174 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

2175 
Ch
 
	gÃxt_ch¬
 = *
‹xt
;

2181 
	gaá”_d©a_node
:

2184 
Ãxt_ch¬
)

2188 
Ch
('<'):

2189 ià(
‹xt
[1] =ğ
Ch
('/'))

2192 
‹xt
 += 2;

2193 ià(
	gFÏgs
 & 
	g·r£_v®id©e_şosšg_gs
)

2196 
Ch
 *
	gşosšg_Çme
 = 
‹xt
;

2197 
	gsk
<
	gnode_Çme_´ed
, 
	gFÏgs
>(
	g‹xt
);

2198 ià(!
	gš‹º®
::
com·»
(
node
->
Çme
(),‚ode->
Çme_size
(), 
şosšg_Çme
, 
‹xt
 - closšg_Çme, 
Œue
))

2199 
RAPIDXML_PARSE_ERROR
("šv®id closšgag‚ame", 
‹xt
);

2204 
	gsk
<
	gnode_Çme_´ed
, 
	gFÏgs
>(
	g‹xt
);

2207 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

2208 ià(*
	g‹xt
 !ğ
Ch
('>'))

2209 
RAPIDXML_PARSE_ERROR
("ex³ùed >", 
‹xt
);

2210 ++
	g‹xt
;

2216 ++
	g‹xt
;

2217 ià(
	gxml_node
<
	gCh
> *
	gchd
 = 
·r£_node
<
FÏgs
>(
‹xt
))

2218 
node
->
­³nd_node
(
chd
);

2223 
Ch
('\0'):

2224 
RAPIDXML_PARSE_ERROR
("uÃx³ùedƒnd oàd©a", 
‹xt
);

2228 
Ãxt_ch¬
 = 
·r£_ªd_­³nd_d©a
<
FÏgs
>(
node
, 
	g‹xt
, 
	gcÚ‹Ás_¡¬t
);

2229 
	gaá”_d©a_node
;

2236 
	g‹m¶©e
<
	gFÏgs
>

2237 
·r£_node_©Œibu‹s
(
Ch
 *&
‹xt
, 
xml_node
<Ch> *
node
)

2240 
	g©Œibu‹_Çme_´ed
::
‹¡
(*
‹xt
))

2243 
Ch
 *
Çme
 = 
‹xt
;

2244 ++
	g‹xt
;

2245 
	gsk
<
	g©Œibu‹_Çme_´ed
, 
	gFÏgs
>(
	g‹xt
);

2246 ià(
	g‹xt
 =ğ
Çme
)

2247 
RAPIDXML_PARSE_ERROR
("ex³ùed‡‰ribu‹‚ame", 
Çme
);

2250 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
this
->
®loÿ‹_©Œibu‹
();

2251 
	g©Œibu‹
->
Çme
Òame, 
‹xt
 -‚ame);

2252 
	gnode
->
­³nd_©Œibu‹
(
©Œibu‹
);

2255 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

2258 ià(*
	g‹xt
 !ğ
Ch
('='))

2259 
RAPIDXML_PARSE_ERROR
("ex³ùed =", 
‹xt
);

2260 ++
	g‹xt
;

2263 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

2264 
	g©Œibu‹
->
Çme
()[
©Œibu‹
->
Çme_size
()] = 0;

2267 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

2270 
Ch
 
	gquÙe
 = *
‹xt
;

2271 ià(
	gquÙe
 !ğ
Ch
('\''è&& 
quÙe
 != Ch('"'))

2272 
RAPIDXML_PARSE_ERROR
("ex³ùed ' o¸\"", 
‹xt
);

2273 ++
	g‹xt
;

2276 
Ch
 *
	gv®ue
 = 
‹xt
, *
	g’d
;

2277 cÚ¡ 
	gA‰FÏgs
 = 
FÏgs
 & ~
·r£_nÜm®ize_wh™e¥aû
;

2278 ià(
	gquÙe
 =ğ
Ch
('\''))

2279 
’d
 = 
sk_ªd_ex·nd_ch¬aù”_»fs
<
©Œibu‹_v®ue_´ed
<
Ch
('\'')>, 
	g©Œibu‹_v®ue_pu»_´ed
<Ch('\'')>, 
	gA‰FÏgs
>(
	g‹xt
);

2281 
	g’d
 = 
sk_ªd_ex·nd_ch¬aù”_»fs
<
©Œibu‹_v®ue_´ed
<
Ch
('"')>, 
	g©Œibu‹_v®ue_pu»_´ed
<Ch('"')>, 
	gA‰FÏgs
>(
	g‹xt
);

2284 
	g©Œibu‹
->
v®ue
(v®ue, 
’d
 - value);

2287 ià(*
	g‹xt
 !ğ
quÙe
)

2288 
RAPIDXML_PARSE_ERROR
("ex³ùed ' o¸\"", 
‹xt
);

2289 ++
	g‹xt
;

2292 ià(!(
	gFÏgs
 & 
	g·r£_no_¡ršg_‹rmš©Üs
))

2293 
	g©Œibu‹
->
v®ue
()[
©Œibu‹
->
v®ue_size
()] = 0;

2296 
	gsk
<
	gwh™e¥aû_´ed
, 
	gFÏgs
>(
	g‹xt
);

2303 
Çme¥aû
 
	gš‹º®


2307 
	g‹m¶©e
<
	gDummy
>

2308 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_wh™e¥aû
[256] =

2330 
	g‹m¶©e
<
	gDummy
>

2331 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_node_Çme
[256] =

2353 
	g‹m¶©e
<
	gDummy
>

2354 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_‹xt
[256] =

2377 
	g‹m¶©e
<
	gDummy
>

2378 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_‹xt_pu»_no_ws
[256] =

2401 
	g‹m¶©e
<
	gDummy
>

2402 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_‹xt_pu»_w™h_ws
[256] =

2424 
	g‹m¶©e
<
	gDummy
>

2425 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_©Œibu‹_Çme
[256] =

2447 
	g‹m¶©e
<
	gDummy
>

2448 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_©Œibu‹_d©a_1
[256] =

2470 
	g‹m¶©e
<
	gDummy
>

2471 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_©Œibu‹_d©a_1_pu»
[256] =

2493 
	g‹m¶©e
<
	gDummy
>

2494 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_©Œibu‹_d©a_2
[256] =

2516 
	g‹m¶©e
<
	gDummy
>

2517 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_©Œibu‹_d©a_2_pu»
[256] =

2539 
	g‹m¶©e
<
	gDummy
>

2540 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_dig™s
[256] =

2562 
	g‹m¶©e
<
	gDummy
>

2563 cÚ¡ 
	glookup_bËs
<
	gDummy
>::
lookup_upÿ£
[256] =

2589 #undeà
RAPIDXML_PARSE_ERROR


2592 #ifdeà
_MSC_VER


2593 #´agm¨
w¬nšg
(
pİ
)

	@src/utils/rapidxml/rapidxml_iterators.hpp

1 #iâdeà
RAPIDXML_ITERATORS_HPP_INCLUDED


2 
	#RAPIDXML_ITERATORS_HPP_INCLUDED


	)

9 
	~"¿pidxml.hµ
"

11 
Çme¥aû
 
	g¿pidxml


15 
	g‹m¶©e
<
şass
 
	gCh
>

16 şas 
	cnode_™”©Ü


19 
	gpublic
:

21 
ty³Çme
 
	txml_node
<
	tCh
> 
	tv®ue_ty³
;

22 
ty³Çme
 
	txml_node
<
	tCh
> &
	t»ã»nû
;

23 
ty³Çme
 
	txml_node
<
	tCh
> *
	tpoš‹r
;

24 
	g¡d
::
	t±rdiff_t
 
	tdifã»nû_ty³
;

25 
	g¡d
::
	tbidœeùiÚ®_™”©Ü_g
 
	t™”©Ü_ÿ‹gÜy
;

27 
node_™”©Ü
()

28 : 
m_node
(0)

32 
node_™”©Ü
(
xml_node
<
Ch
> *
node
)

33 : 
m_node
(
node
->
fœ¡_node
())

37 
»ã»nû
 
İ”©Ü
 *() const

39 
as£¹
(
m_node
);

40  *
	gm_node
;

43 
poš‹r
 
	gİ”©Ü
->() const

45 
as£¹
(
m_node
);

46  
	gm_node
;

49 
	gnode_™”©Ü
& 
	gİ”©Ü
++()

51 
as£¹
(
m_node
);

52 
	gm_node
 = 
m_node
->
Ãxt_siblšg
();

53  *
	gthis
;

56 
node_™”©Ü
 
	gİ”©Ü
++()

58 
node_™”©Ü
 
	gtmp
 = *
this
;

59 ++
	gthis
;

60  
	gtmp
;

63 
	gnode_™”©Ü
& 
	gİ”©Ü
--()

65 
as£¹
(
m_node
 && m_node->
´evious_siblšg
());

66 
	gm_node
 = 
m_node
->
´evious_siblšg
();

67  *
	gthis
;

70 
node_™”©Ü
 
	gİ”©Ü
--()

72 
node_™”©Ü
 
	gtmp
 = *
this
;

73 ++
	gthis
;

74  
	gtmp
;

77 
boŞ
 
	gİ”©Ü
 ==(cÚ¡ 
node_™”©Ü
<
Ch
> &
rhs
)

79  
m_node
 =ğ
rhs
.m_node;

82 
boŞ
 
	gİ”©Ü
 !=(cÚ¡ 
node_™”©Ü
<
Ch
> &
rhs
)

84  
m_node
 !ğ
rhs
.m_node;

87 
	g´iv©e
:

89 
xml_node
<
Ch
> *
m_node
;

94 
	g‹m¶©e
<
şass
 
	gCh
>

95 şas 
	c©Œibu‹_™”©Ü


98 
	gpublic
:

100 
ty³Çme
 
	txml_©Œibu‹
<
	tCh
> 
	tv®ue_ty³
;

101 
ty³Çme
 
	txml_©Œibu‹
<
	tCh
> &
	t»ã»nû
;

102 
ty³Çme
 
	txml_©Œibu‹
<
	tCh
> *
	tpoš‹r
;

103 
	g¡d
::
	t±rdiff_t
 
	tdifã»nû_ty³
;

104 
	g¡d
::
	tbidœeùiÚ®_™”©Ü_g
 
	t™”©Ü_ÿ‹gÜy
;

106 
©Œibu‹_™”©Ü
()

107 : 
m_©Œibu‹
(0)

111 
©Œibu‹_™”©Ü
(
xml_node
<
Ch
> *
node
)

112 : 
m_©Œibu‹
(
node
->
fœ¡_©Œibu‹
())

116 
»ã»nû
 
İ”©Ü
 *() const

118 
as£¹
(
m_©Œibu‹
);

119  *
	gm_©Œibu‹
;

122 
poš‹r
 
	gİ”©Ü
->() const

124 
as£¹
(
m_©Œibu‹
);

125  
	gm_©Œibu‹
;

128 
	g©Œibu‹_™”©Ü
& 
	gİ”©Ü
++()

130 
as£¹
(
m_©Œibu‹
);

131 
	gm_©Œibu‹
 = 
m_©Œibu‹
->
Ãxt_©Œibu‹
();

132  *
	gthis
;

135 
©Œibu‹_™”©Ü
 
	gİ”©Ü
++()

137 
©Œibu‹_™”©Ü
 
	gtmp
 = *
this
;

138 ++
	gthis
;

139  
	gtmp
;

142 
	g©Œibu‹_™”©Ü
& 
	gİ”©Ü
--()

144 
as£¹
(
m_©Œibu‹
 && m_©Œibu‹->
´evious_©Œibu‹
());

145 
	gm_©Œibu‹
 = 
m_©Œibu‹
->
´evious_©Œibu‹
();

146  *
	gthis
;

149 
©Œibu‹_™”©Ü
 
	gİ”©Ü
--()

151 
©Œibu‹_™”©Ü
 
	gtmp
 = *
this
;

152 ++
	gthis
;

153  
	gtmp
;

156 
boŞ
 
	gİ”©Ü
 ==(cÚ¡ 
©Œibu‹_™”©Ü
<
Ch
> &
rhs
)

158  
m_©Œibu‹
 =ğ
rhs
.m_attribute;

161 
boŞ
 
	gİ”©Ü
 !=(cÚ¡ 
©Œibu‹_™”©Ü
<
Ch
> &
rhs
)

163  
m_©Œibu‹
 !ğ
rhs
.m_attribute;

166 
	g´iv©e
:

168 
xml_©Œibu‹
<
Ch
> *
m_©Œibu‹
;

	@src/utils/rapidxml/rapidxml_print.hpp

1 #iâdeà
RAPIDXML_PRINT_HPP_INCLUDED


2 
	#RAPIDXML_PRINT_HPP_INCLUDED


	)

9 
	~"¿pidxml.hµ
"

12 #iâdeà
RAPIDXML_NO_STREAMS


13 
	~<o¡»am
>

14 
	~<™”©Ü
>

17 
Çme¥aû
 
	g¿pidxml


23 cÚ¡ 
	g´št_no_šd’tšg
 = 0x1;

29 
Çme¥aû
 
	gš‹º®


36 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

37 
šlše
 
OutIt
 
cİy_ch¬s
(cÚ¡ 
Ch
 *
begš
, cÚ¡ Ch *
’d
, OutIˆ
out
)

39 
	gbegš
 !ğ
’d
)

40 *
out
++ = *
begš
++;

41  
	gout
;

46 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

47 
šlše
 
OutIt
 
cİy_ªd_ex·nd_ch¬s
(cÚ¡ 
Ch
 *
begš
, cÚ¡ Ch *
’d
, Ch 
nÛx·nd
, OutIˆ
out
)

49 
	gbegš
 !ğ
’d
)

51 ià(*
begš
 =ğ
nÛx·nd
)

53 *
out
++ = *
begš
;

57 *
	gbegš
)

59 
Ch
('<'):

60 *
out
++ = 
Ch
('&'); *
	gout
++ = Ch('l'); *out++ = Ch('t'); *out++ = Ch(';');

62 
Ch
('>'):

63 *
out
++ = 
Ch
('&'); *
	gout
++ = Ch('g'); *out++ = Ch('t'); *out++ = Ch(';');

65 
Ch
('\''):

66 *
out
++ = 
Ch
('&'); *
	gout
++ = Ch('a'); *out++ = Ch('p'); *out++ = Ch('o'); *out++ = Ch('s'); *out++ = Ch(';');

68 
Ch
('"'):

69 *
out
++ = 
Ch
('&'); *
	gout
++ = Ch('q'); *out++ = Ch('u'); *out++ = Ch('o'); *out++ = Ch('t'); *out++ = Ch(';');

71 
Ch
('&'):

72 *
out
++ = 
Ch
('&'); *
	gout
++ = Ch('a'); *out++ = Ch('m'); *out++ = Ch('p'); *out++ = Ch(';');

75 *
out
++ = *
begš
;

78 ++
	gbegš
;

80  
	gout
;

84 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

85 
šlše
 
OutIt
 
fl_ch¬s
(OutIˆ
out
, 
n
, 
Ch
 
ch
)

87 
	gi
 = 0; i < 
	gn
; ++i)

88 *
	gout
++ = 
ch
;

89  
	gout
;

93 
	g‹m¶©e
<
şass
 
	gCh
, 
Ch
 
	gch
>

94 
šlše
 
boŞ
 
fšd_ch¬
(cÚ¡ 
Ch
 *
begš
, cÚ¡ Ch *
’d
)

96 
	gbegš
 !ğ
’d
)

97 ià(*
begš
++ =ğ
ch
)

98  
Œue
;

99  
	gçl£
;

106 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

107 
šlše
 
OutIt
 
´št_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

110 
	gnode
->
ty³
())

114 
	gnode_docum’t
:

115 
out
 = 
´št_chd»n
(out, 
node
, 
æags
, 
šd’t
);

119 
	gnode_–em’t
:

120 
out
 = 
´št_–em’t_node
(out, 
node
, 
æags
, 
šd’t
);

124 
	gnode_d©a
:

125 
out
 = 
´št_d©a_node
(out, 
node
, 
æags
, 
šd’t
);

129 
	gnode_cd©a
:

130 
out
 = 
´št_cd©a_node
(out, 
node
, 
æags
, 
šd’t
);

134 
	gnode_deş¬©iÚ
:

135 
out
 = 
´št_deş¬©iÚ_node
(out, 
node
, 
æags
, 
šd’t
);

139 
	gnode_comm’t
:

140 
out
 = 
´št_comm’t_node
(out, 
node
, 
æags
, 
šd’t
);

144 
	gnode_doùy³
:

145 
out
 = 
´št_doùy³_node
(out, 
node
, 
æags
, 
šd’t
);

149 
	gnode_pi
:

150 
out
 = 
´št_pi_node
(out, 
node
, 
æags
, 
šd’t
);

155 
as£¹
(0);

160 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

161 *
	gout
 = 
Ch
('\n'), ++out;

164  
	gout
;

168 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

169 
šlše
 
OutIt
 
´št_chd»n
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

171 
	gxml_node
<
	gCh
> *
	gchd
 = 
node
->
fœ¡_node
(); chd; chd = 
chd
->
Ãxt_siblšg
())

172 
out
 = 
´št_node
(out, 
chd
, 
æags
, 
šd’t
);

173  
	gout
;

177 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

178 
šlše
 
OutIt
 
´št_©Œibu‹s
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
)

180 
	gxml_©Œibu‹
<
	gCh
> *
	g©Œibu‹
 = 
node
->
fœ¡_©Œibu‹
();‡‰ribu‹;‡‰ribu‹ = 
©Œibu‹
->
Ãxt_©Œibu‹
())

182 ià(
©Œibu‹
->
Çme
(è&&‡‰ribu‹->
v®ue
())

185 *
out
 = 
Ch
(' '), ++
	gout
;

186 
	gout
 = 
cİy_ch¬s
(
©Œibu‹
->
Çme
(),‡‰ribu‹->Çme(è+‡‰ribu‹->
Çme_size
(), 
out
);

187 *
	gout
 = 
Ch
('='), ++out;

189 ià(
	gfšd_ch¬
<
	gCh
, 
Ch
('"')>(
	g©Œibu‹
->
v®ue
(),‡‰ribu‹->v®ue(è+‡‰ribu‹->
v®ue_size
()))

191 *
	gout
 = 
Ch
('\''), ++out;

192 
	gout
 = 
cİy_ªd_ex·nd_ch¬s
(
©Œibu‹
->
v®ue
(),‡‰ribu‹->v®ue(è+‡‰ribu‹->
v®ue_size
(), 
Ch
('"'), 
out
);

193 *
	gout
 = 
Ch
('\''), ++out;

197 *
	gout
 = 
Ch
('"'), ++out;

198 
	gout
 = 
cİy_ªd_ex·nd_ch¬s
(
©Œibu‹
->
v®ue
(),‡‰ribu‹->v®ue(è+‡‰ribu‹->
v®ue_size
(), 
Ch
('\''), 
out
);

199 *
	gout
 = 
Ch
('"'), ++out;

203  
	gout
;

207 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

208 
šlše
 
OutIt
 
´št_d©a_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

210 
as£¹
(
node
->
ty³
(è=ğ
node_d©a
);

211 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

212 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

213 
	gout
 = 
cİy_ªd_ex·nd_ch¬s
(
node
->
v®ue
(),‚ode->v®ue(è+‚ode->
v®ue_size
(), 
Ch
(0), 
out
);

214  
	gout
;

218 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

219 
šlše
 
OutIt
 
´št_cd©a_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

221 
as£¹
(
node
->
ty³
(è=ğ
node_cd©a
);

222 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

223 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

224 *
	gout
 = 
Ch
('<'); ++out;

225 *
	gout
 = 
Ch
('!'); ++out;

226 *
	gout
 = 
Ch
('['); ++out;

227 *
	gout
 = 
Ch
('C'); ++out;

228 *
	gout
 = 
Ch
('D'); ++out;

229 *
	gout
 = 
Ch
('A'); ++out;

230 *
	gout
 = 
Ch
('T'); ++out;

231 *
	gout
 = 
Ch
('A'); ++out;

232 *
	gout
 = 
Ch
('['); ++out;

233 
	gout
 = 
cİy_ch¬s
(
node
->
v®ue
(),‚ode->v®ue(è+‚ode->
v®ue_size
(), 
out
);

234 *
	gout
 = 
Ch
(']'); ++out;

235 *
	gout
 = 
Ch
(']'); ++out;

236 *
	gout
 = 
Ch
('>'); ++out;

237  
	gout
;

241 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

242 
šlše
 
OutIt
 
´št_–em’t_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

244 
as£¹
(
node
->
ty³
(è=ğ
node_–em’t
);

247 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

248 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

249 *
	gout
 = 
Ch
('<'), ++out;

250 
	gout
 = 
cİy_ch¬s
(
node
->
Çme
(),‚ode->Çme(è+‚ode->
Çme_size
(), 
out
);

251 
	gout
 = 
´št_©Œibu‹s
(
out
, 
node
, 
æags
);

254 ià(
	gnode
->
v®ue_size
(è=ğ0 && !
node
->
fœ¡_node
())

257 *
out
 = 
Ch
('/'), ++
	gout
;

258 *
	gout
 = 
Ch
('>'), ++out;

263 *
	gout
 = 
Ch
('>'), ++out;

266 
	gxml_node
<
	gCh
> *
	gchd
 = 
node
->
fœ¡_node
();

267 ià(!
	gchd
)

270 
	gout
 = 
cİy_ªd_ex·nd_ch¬s
(
node
->
v®ue
(),‚ode->v®ue(è+‚ode->
v®ue_size
(), 
Ch
(0), 
out
);

272 ià(
	gchd
->
Ãxt_siblšg
(è=ğ0 && 
chd
->
ty³
(è=ğ
node_d©a
)

275 
out
 = 
cİy_ªd_ex·nd_ch¬s
(
chd
->
v®ue
(), chd->v®ue(è+ chd->
v®ue_size
(), 
Ch
(0), out);

280 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

281 *
	gout
 = 
Ch
('\n'), ++out;

282 
	gout
 = 
´št_chd»n
(
out
, 
node
, 
æags
, 
šd’t
 + 1);

283 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

284 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

288 *
	gout
 = 
Ch
('<'), ++out;

289 *
	gout
 = 
Ch
('/'), ++out;

290 
	gout
 = 
cİy_ch¬s
(
node
->
Çme
(),‚ode->Çme(è+‚ode->
Çme_size
(), 
out
);

291 *
	gout
 = 
Ch
('>'), ++out;

293  
	gout
;

297 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

298 
šlše
 
OutIt
 
´št_deş¬©iÚ_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

301 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

302 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

303 *
	gout
 = 
Ch
('<'), ++out;

304 *
	gout
 = 
Ch
('?'), ++out;

305 *
	gout
 = 
Ch
('x'), ++out;

306 *
	gout
 = 
Ch
('m'), ++out;

307 *
	gout
 = 
Ch
('l'), ++out;

310 
	gout
 = 
´št_©Œibu‹s
(
out
, 
node
, 
æags
);

313 *
	gout
 = 
Ch
('?'), ++out;

314 *
	gout
 = 
Ch
('>'), ++out;

316  
	gout
;

320 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

321 
šlše
 
OutIt
 
´št_comm’t_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

323 
as£¹
(
node
->
ty³
(è=ğ
node_comm’t
);

324 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

325 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

326 *
	gout
 = 
Ch
('<'), ++out;

327 *
	gout
 = 
Ch
('!'), ++out;

328 *
	gout
 = 
Ch
('-'), ++out;

329 *
	gout
 = 
Ch
('-'), ++out;

330 
	gout
 = 
cİy_ch¬s
(
node
->
v®ue
(),‚ode->v®ue(è+‚ode->
v®ue_size
(), 
out
);

331 *
	gout
 = 
Ch
('-'), ++out;

332 *
	gout
 = 
Ch
('-'), ++out;

333 *
	gout
 = 
Ch
('>'), ++out;

334  
	gout
;

338 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

339 
šlše
 
OutIt
 
´št_doùy³_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

341 
as£¹
(
node
->
ty³
(è=ğ
node_doùy³
);

342 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

343 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

344 *
	gout
 = 
Ch
('<'), ++out;

345 *
	gout
 = 
Ch
('!'), ++out;

346 *
	gout
 = 
Ch
('D'), ++out;

347 *
	gout
 = 
Ch
('O'), ++out;

348 *
	gout
 = 
Ch
('C'), ++out;

349 *
	gout
 = 
Ch
('T'), ++out;

350 *
	gout
 = 
Ch
('Y'), ++out;

351 *
	gout
 = 
Ch
('P'), ++out;

352 *
	gout
 = 
Ch
('E'), ++out;

353 *
	gout
 = 
Ch
(' '), ++out;

354 
	gout
 = 
cİy_ch¬s
(
node
->
v®ue
(),‚ode->v®ue(è+‚ode->
v®ue_size
(), 
out
);

355 *
	gout
 = 
Ch
('>'), ++out;

356  
	gout
;

360 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

361 
šlše
 
OutIt
 
´št_pi_node
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> *
node
, 
æags
, 
šd’t
)

363 
as£¹
(
node
->
ty³
(è=ğ
node_pi
);

364 ià(!(
	gæags
 & 
	g´št_no_šd’tšg
))

365 
	gout
 = 
fl_ch¬s
(
out
, 
šd’t
, 
Ch
('\t'));

366 *
	gout
 = 
Ch
('<'), ++out;

367 *
	gout
 = 
Ch
('?'), ++out;

368 
	gout
 = 
cİy_ch¬s
(
node
->
Çme
(),‚ode->Çme(è+‚ode->
Çme_size
(), 
out
);

369 *
	gout
 = 
Ch
(' '), ++out;

370 
	gout
 = 
cİy_ch¬s
(
node
->
v®ue
(),‚ode->v®ue(è+‚ode->
v®ue_size
(), 
out
);

371 *
	gout
 = 
Ch
('?'), ++out;

372 *
	gout
 = 
Ch
('>'), ++out;

373  
	gout
;

387 
	g‹m¶©e
<
şass
 
	gOutIt
, cÏs 
	gCh
>

388 
šlše
 
OutIt
 
´št
(OutIˆ
out
, cÚ¡ 
xml_node
<
Ch
> &
node
, 
æags
 = 0)

390  
š‹º®
::
´št_node
(
out
, &
node
, 
æags
, 0);

393 #iâdeà
RAPIDXML_NO_STREAMS


400 
	g‹m¶©e
<
şass
 
	gCh
>

401 
šlše
 
	g¡d
::
basic_o¡»am
<
Ch
> &
´št
(
¡d
::basic_o¡»am<Ch> &
out
, cÚ¡ 
xml_node
<Ch> &
node
, 
æags
 = 0)

403 
´št
(
¡d
::
o¡»am_™”©Ü
<
Ch
>(
out
), 
node
, 
æags
);

404  
	gout
;

411 
	g‹m¶©e
<
şass
 
	gCh
>

412 
šlše
 
	g¡d
::
basic_o¡»am
<
Ch
> &
İ”©Ü
 <<(
¡d
::basic_o¡»am<Ch> &
out
, cÚ¡ 
	gxml_node
<
	gCh
> &
	gnode
)

414  
´št
(
out
, 
node
);

	@src/utils/rapidxml/rapidxml_utils.hpp

1 #iâdeà
RAPIDXML_UTILS_HPP_INCLUDED


2 
	#RAPIDXML_UTILS_HPP_INCLUDED


	)

10 
	~"¿pidxml.hµ
"

11 
	~<veùÜ
>

12 
	~<¡ršg
>

13 
	~<f¡»am
>

14 
	~<¡dexû±
>

16 
Çme¥aû
 
	g¿pidxml


20 
	g‹m¶©e
<
şass
 
	gCh
 = >

21 şas 
	cfe


24 
public
:

28 
fe
(cÚ¡ *
f’ame
)

30 
usšg
 
Çme¥aû
 
¡d
;

33 
	gbasic_if¡»am
<
	gCh
> 
¡»am
(
f’ame
, 
ios
::
bš¬y
);

34 ià(!
	g¡»am
)

35 
throw
 
ruÁime_”rÜ
(
¡ršg
("ÿÂÙ o³Àf"è+ 
f’ame
);

36 
	g¡»am
.
un£tf
(
ios
::
skws
);

39 
	g¡»am
.
£ekg
(0, 
ios
::
’d
);

40 
size_t
 
	gsize
 = 
¡»am
.
‹Îg
();

41 
	g¡»am
.
£ekg
(0);

44 
	gm_d©a
.
»size
(
size
 + 1);

45 
	g¡»am
.
»ad
(&
m_d©a
.
äÚt
(), 
¡©ic_ÿ¡
<
¡»amsize
>(
size
));

46 
	gm_d©a
[
size
] = 0;

51 
fe
(
¡d
::
basic_i¡»am
<
Ch
> &
¡»am
)

53 
usšg
 
Çme¥aû
 
¡d
;

56 
	g¡»am
.
un£tf
(
ios
::
skws
);

57 
	gm_d©a
.
assign
(
i¡»ambuf_™”©Ü
<
Ch
>(
¡»am
), istreambuf_iterator<Ch>());

58 ià(
	g¡»am
.
ç
(è|| sŒ—m.
bad
())

59 
throw
 
ruÁime_”rÜ
("error„eading stream");

60 
	gm_d©a
.
push_back
(0);

65 
Ch
 *
d©a
()

67  &
	gm_d©a
.
äÚt
();

72 cÚ¡ 
Ch
 *
d©a
() const

74  &
	gm_d©a
.
äÚt
();

79 
	g¡d
::
size_t
 
size
() const

81  
m_d©a
.
size
();

84 
	g´iv©e
:

86 
¡d
::
veùÜ
<
Ch
> 
m_d©a
;

92 
	g‹m¶©e
<
şass
 
	gCh
>

93 
šlše
 
	g¡d
::
size_t
 
couÁ_chd»n
(
xml_node
<
Ch
> *
node
)

95 
xml_node
<
Ch
> *
chd
 = 
node
->
fœ¡_node
();

96 
	g¡d
::
size_t
 
couÁ
 = 0;

97 
	gchd
)

99 ++
	gcouÁ
;

100 
	gchd
 = 
chd
->
Ãxt_siblšg
();

102  
	gcouÁ
;

107 
	g‹m¶©e
<
şass
 
	gCh
>

108 
šlše
 
	g¡d
::
size_t
 
couÁ_©Œibu‹s
(
xml_node
<
Ch
> *
node
)

110 
xml_©Œibu‹
<
Ch
> *
©Œ
 = 
node
->
fœ¡_©Œibu‹
();

111 
	g¡d
::
size_t
 
couÁ
 = 0;

112 
	g©Œ
)

114 ++
	gcouÁ
;

115 
	g©Œ
 = 
©Œ
->
Ãxt_©Œibu‹
();

117  
	gcouÁ
;

	@
1
.
0
145
4360
src/exec/Device_Parameter_Set.cpp
src/exec/Device_Parameter_Set.h
src/exec/Execution_Parameter_Set.cpp
src/exec/Execution_Parameter_Set.h
src/exec/Flash_Parameter_Set.cpp
src/exec/Flash_Parameter_Set.h
src/exec/Host_Parameter_Set.cpp
src/exec/Host_Parameter_Set.h
src/exec/Host_System.cpp
src/exec/Host_System.h
src/exec/IO_Flow_Parameter_Set.cpp
src/exec/IO_Flow_Parameter_Set.h
src/exec/Parameter_Set_Base.h
src/exec/SSD_Device.cpp
src/exec/SSD_Device.h
src/host/ASCII_Trace_Definition.h
src/host/Host_Defs.h
src/host/Host_IO_Request.h
src/host/IO_Flow_Base.cpp
src/host/IO_Flow_Base.h
src/host/IO_Flow_Synthetic.cpp
src/host/IO_Flow_Synthetic.h
src/host/IO_Flow_Trace_Based.cpp
src/host/IO_Flow_Trace_Based.h
src/host/PCIe_Link.cpp
src/host/PCIe_Link.h
src/host/PCIe_Message.h
src/host/PCIe_Root_Complex.cpp
src/host/PCIe_Root_Complex.h
src/host/PCIe_Switch.cpp
src/host/PCIe_Switch.h
src/host/SATA_HBA.cpp
src/host/SATA_HBA.h
src/main.cpp
src/nvm_chip/NVM_Chip.h
src/nvm_chip/NVM_Memory_Address.h
src/nvm_chip/NVM_Types.h
src/nvm_chip/flash_memory/Block.cpp
src/nvm_chip/flash_memory/Block.h
src/nvm_chip/flash_memory/Die.cpp
src/nvm_chip/flash_memory/Die.h
src/nvm_chip/flash_memory/FlashTypes.h
src/nvm_chip/flash_memory/Flash_Chip.cpp
src/nvm_chip/flash_memory/Flash_Chip.h
src/nvm_chip/flash_memory/Flash_Command.h
src/nvm_chip/flash_memory/Page.h
src/nvm_chip/flash_memory/Physical_Page_Address.cpp
src/nvm_chip/flash_memory/Physical_Page_Address.h
src/nvm_chip/flash_memory/Plane.cpp
src/nvm_chip/flash_memory/Plane.h
src/sim/Engine.cpp
src/sim/Engine.h
src/sim/EventTree.cpp
src/sim/EventTree.h
src/sim/Sim_Defs.h
src/sim/Sim_Event.h
src/sim/Sim_Object.h
src/sim/Sim_Reporter.h
src/ssd/Address_Mapping_Unit_Base.cpp
src/ssd/Address_Mapping_Unit_Base.h
src/ssd/Address_Mapping_Unit_Hybrid.cpp
src/ssd/Address_Mapping_Unit_Hybrid.h
src/ssd/Address_Mapping_Unit_Page_Level.cpp
src/ssd/Address_Mapping_Unit_Page_Level.h
src/ssd/Data_Cache_Flash.cpp
src/ssd/Data_Cache_Flash.h
src/ssd/Data_Cache_Manager_Base.cpp
src/ssd/Data_Cache_Manager_Base.h
src/ssd/Data_Cache_Manager_Flash_Advanced.cpp
src/ssd/Data_Cache_Manager_Flash_Advanced.h
src/ssd/Data_Cache_Manager_Flash_Simple.cpp
src/ssd/Data_Cache_Manager_Flash_Simple.h
src/ssd/FTL.cpp
src/ssd/FTL.h
src/ssd/Flash_Block_Manager.cpp
src/ssd/Flash_Block_Manager.h
src/ssd/Flash_Block_Manager_Base.cpp
src/ssd/Flash_Block_Manager_Base.h
src/ssd/Flash_Transaction_Queue.cpp
src/ssd/Flash_Transaction_Queue.h
src/ssd/GC_and_WL_Unit_Base.cpp
src/ssd/GC_and_WL_Unit_Base.h
src/ssd/GC_and_WL_Unit_Page_Level.cpp
src/ssd/GC_and_WL_Unit_Page_Level.h
src/ssd/Host_Interface_Base.cpp
src/ssd/Host_Interface_Base.h
src/ssd/Host_Interface_Defs.h
src/ssd/Host_Interface_NVMe.cpp
src/ssd/Host_Interface_NVMe.h
src/ssd/Host_Interface_SATA.cpp
src/ssd/Host_Interface_SATA.h
src/ssd/NVM_Channel_Base.h
src/ssd/NVM_Firmware.cpp
src/ssd/NVM_Firmware.h
src/ssd/NVM_PHY_Base.cpp
src/ssd/NVM_PHY_Base.h
src/ssd/NVM_PHY_ONFI.cpp
src/ssd/NVM_PHY_ONFI.h
src/ssd/NVM_PHY_ONFI_NVDDR2.cpp
src/ssd/NVM_PHY_ONFI_NVDDR2.h
src/ssd/NVM_Transaction.h
src/ssd/NVM_Transaction_Flash.cpp
src/ssd/NVM_Transaction_Flash.h
src/ssd/NVM_Transaction_Flash_ER.cpp
src/ssd/NVM_Transaction_Flash_ER.h
src/ssd/NVM_Transaction_Flash_RD.cpp
src/ssd/NVM_Transaction_Flash_RD.h
src/ssd/NVM_Transaction_Flash_WR.cpp
src/ssd/NVM_Transaction_Flash_WR.h
src/ssd/ONFI_Channel_Base.cpp
src/ssd/ONFI_Channel_Base.h
src/ssd/ONFI_Channel_NVDDR2.cpp
src/ssd/ONFI_Channel_NVDDR2.h
src/ssd/Parameters.h
src/ssd/Queue_Probe.cpp
src/ssd/Queue_Probe.h
src/ssd/SSD_Defs.h
src/ssd/Stats.cpp
src/ssd/Stats.h
src/ssd/TSU_Base.cpp
src/ssd/TSU_Base.h
src/ssd/TSU_FLIN.cpp
src/ssd/TSU_FLIN.h
src/ssd/TSU_OutofOrder.cpp
src/ssd/TSU_OutofOrder.h
src/ssd/User_Request.cpp
src/ssd/User_Request.h
src/utils/CMRRandomGenerator.cpp
src/utils/CMRRandomGenerator.h
src/utils/DistributionTypes.h
src/utils/Helper_Functions.cpp
src/utils/Helper_Functions.h
src/utils/Logical_Address_Partitioning_Unit.cpp
src/utils/Logical_Address_Partitioning_Unit.h
src/utils/RandomGenerator.cpp
src/utils/RandomGenerator.h
src/utils/StringTools.cpp
src/utils/StringTools.h
src/utils/Workload_Statistics.h
src/utils/XMLWriter.cpp
src/utils/XMLWriter.h
src/utils/rapidxml/rapidxml.hpp
src/utils/rapidxml/rapidxml_iterators.hpp
src/utils/rapidxml/rapidxml_print.hpp
src/utils/rapidxml/rapidxml_utils.hpp
